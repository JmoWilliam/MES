
@using Business_Manager.Helpers
@{
    string itemName = "LotBarcoderPrintLabel";
    string itemNameText = "批量條碼列印管理";
    string authority = ViewBag.authority;
}

<style>
    .BarcodeList {
        display: flex;
        justify-content: end;
    }
</style>

<div class="row">
    <div class="col-12 title-block">
        <h1 class="pt-2 pb-3">@(itemNameText)</h1>
        <div class="unit-block">
            <div class="button-block mb-1">
                <button type="button" class="btn btn-secondary" onclick="Return@(itemName)()"><i class="fas fa-undo"></i>返回</button>
            </div>
        </div>
    </div>
</div>

<div class="row" id="editData@(itemName)">
    <input type="hidden" id="QcNoticeId" name="QcNoticeId" value="-1" />
    <div class="col-12">
        <div class="card card-shadow mb-4">
            <div class="card-body">
                <div class="row mb-3"></div>
                <form class="container custom-form-container" autocomplete="off" id="editForm@(itemName)">
                    <div class="form-group row">
                        <label class="col-2 col-md-3 col-lg-3 col-form-label" for="cboLabelPrintMachine@(itemName)">標籤機<span class="text-danger">*</span></label>
                        <div class="col-6 col-md-6 col-lg-6">
                            <select class="form-control" id="cboLabelPrintMachine@(itemName)" name="cboLabelPrintMachine@(itemName)"
                                    data-msg-required="選擇標籤機" data-rule-required="true"></select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-2 col-md-3 col-lg-3 col-form-label" for="cboLabelFormat@(itemName)">標籤樣式<span class="text-danger">*</span></label>
                        <div class="col-6 col-md-6 col-lg-6">
                            <select class="form-control" id="cboLabelFormat@(itemName)" name="cboLabelFormat@(itemName)"
                                    data-msg-required="標籤樣式" data-rule-required="true">
                                <option value="default">預設</option>
                                <option value="A">晶彩-上蓋標籤</option>
                                <option value="B">晶彩-流程卡標籤</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-2 col-md-3 col-lg-3 col-form-label" for="txtBarcodeNo@(itemName)">條碼模式</label>
                        <div class="col-6 col-md-6 col-lg-6">
                            <input type="text" class="form-control" id="txtBarcodeNo@(itemName)"
                                   placeholder="請輸入條碼" daat-rule-required="true" />
                        </div>
                        <div class="col-4 col-md-3 col-lg-3" style="display:flex;justify-content:flex-end;">
                            <button type="button" class="btn btn-info" onclick="BarcodePrint@(itemName)()"><i class="fal fa-print"></i>列印</button>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-2 col-md-3 col-lg-3 col-form-label" for="txtMoNo@(itemName)">製令模式</label>
                        <div class="col-6 col-md-6 col-lg-6">
                            <input type="text" class="form-control" id="txtMoNo@(itemName)"
                                   placeholder="請輸入製令" daat-rule-required="true" />
                        </div>
                        <div class="col-4 col-md-3 col-lg-3" style="display:flex;justify-content:space-between;">
                            <button type="button" class="btn btn-primary" onclick="GetLotBarcode@(itemName)()"><i class="fal fa-search"></i>查詢</button>
                            <button type="button" class="btn btn-info" onclick="MoNoBarcodePrint@(itemName)()"><i class="fal fa-print"></i>列印</button>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-2 col-md-3 col-lg-3 col-form-label" for="chkPrintCnt@(itemName)">列表顯示</label>
                        <div class="col-8 col-md-7 col-lg-8" style="display: flex; align-items: center;">
                            <div class="col-lg-3 col-md-4 col-4">
                                <label class="control control-solid control-solid-info control--radio col-12">
                                    全部
                                    <input type="radio" id="chkPrintCnt@(itemName)All" name="chkPrintCnt@(itemName)" value="" checked />
                                    <span class="control__indicator"></span>
                                </label>
                            </div>
                            <div class="col-lg-3 col-md-4 col-4">
                                <label class="control control-solid control-solid-info control--radio col-12">
                                    有列印
                                    <input type="radio" id="chkPrintCnt@(itemName)Y" name="chkPrintCnt@(itemName)" value="Y" />
                                    <span class="control__indicator"></span>
                                </label>
                            </div>
                            <div class="col-lg-3 col-md-4 col-4">
                                <label class="control control-solid control-solid-info control--radio col-12">
                                    無列印
                                    <input type="radio" id="chkPrintCnt@(itemName)N" name="chkPrintCnt@(itemName)" value="N" />
                                    <span class="control__indicator"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-2 col-md-3 col-lg-3 col-form-label" for="chkPrintCnt@(itemName)"></label>
                        <div class="col-10 col-md-9 col-lg-8">
                            <label class="control control-solid control-solid-info control--radio col-md-3 col-4" style="display: inline;margin-left: 15px;">
                                區間模式
                                <input type="radio" id="chkPrintCnt@(itemName)No" name="chkPrintCnt@(itemName)" value="Interval" />
                                <span class="control__indicator"></span>
                            </label>
                            <input type="number" class="form-control col-lg-4 col-md-3 col-3" style="display: inline-block; margin:0px 5px;height: 27px;" id="txtIntervalFirst@(itemName)" name="txtIntervalFirst@(itemName)" value="" placeholder="開始位置" />
                            <input type="number" class="form-control col-lg-4 col-md-3 col-3" style="display: inline-block; margin:0px 5px;height: 27px;" id="txtIntervalLast@(itemName)" name="txtIntervalLast@(itemName)" value="" placeholder="結束位置" />
                        </div>
                    </div>
                    <div class="form-group row BarcodeList">
                        <label class="col-12 col-md-3 col-lg-3 col-form-label" for="cboTemporaryBarcodeList@(itemName)">暫存列表 -- 數量：<span id="TemporaryBarcodeListNum" name="ToolListNum">0</span></label>
                        <div class="col-5 col-md-4 col-lg-4">
                            <select class="form-control" id="cboTemporaryBarcodeList@(itemName)" name="cboTemporaryBarcodeList@(itemName)"
                                    data-msg-required="選擇暫存列表" data-rule-required="true"></select>
                        </div>
                        <div class="col-7 col-md-5 col-lg-5" style="display:inline;">
                            <button type="button" class="btn btn-danger" onclick="DeleteOption@(itemName)(cboTemporaryBarcodeList@(itemName))"><i class="fal fa-trash-alt"></i>移除</button>
                            <button type="button" class="btn btn-danger" onclick="ClearBarcodeList@(itemName)()"><i class="fal fa-trash-alt"></i>清空</button>
                            <button type="button" class="btn btn-success" onclick="Save@(itemName)()"><i class="fal fa-save"></i>暫存</button>
                            <button type="button" class="btn btn-info" onclick="PrintTemporaryBarcodeList@(itemName)()"><i class="fal fa-print"></i>列印</button>
                        </div>
                    </div>
                    <div class="form-group row BarcodeList">
                        <button type="button" style="margin-right: 20px; margin-bottom: 15px;" class="btn btn-success" onclick="PopViewAddBarcodePrint()"><i class="fas fa-plus"></i>產生新條碼</button>
                        <div class="col-12">
                            <div class="table-custom">
                                <table class="table table-bordered table-striped table-sticky" id="tblMoIdBarcodeData@(itemName)">
                                    <thead>
                                        <tr>
                                            <th class="text-center" scope="col" style="min-width: 50px;">
                                                <label>
                                                    全選 <input type="checkbox" id="cbxSelectAll@(itemName)" />
                                                </label>
                                            </th>
                                            <th scope="col" style="min-width: 50px;">#</th>
                                            <th scope="col" style="min-width: 180px;">條碼</th>
                                            <th scope="col" style="min-width: 50px;">穴號</th>
                                            <th scope="col" style="min-width: 100px;">數量</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

@Html.Partial("ViewAddBarcodePrint");

@Html.Resource("js",
@<script>
    let userId@(itemName);
    let companyId@(itemName);

    $(document).ready(function () {
        GetUserInfo@(itemName)()
        $(".BarcodeList").hide()
        
        ComboBoxs.Default("#cboLabelPrintMachine@(itemName)", "@Url.Action("GetLabelPrintMachine02", "PrintLabel")", {"CompanyId":companyId@(itemName)}, "", "CHOOSE", "請選擇標籤機", "LabelPrintName", "LabelPrintNo"); 

        $("#txtMoNo@(itemName)").on("keydown", function (e) {
            if (e.which == 13) {
                event.preventDefault(); 
                if ($("#txtMoNo@(itemName)").val() != "") {
                    GetLotBarcode@(itemName)()
                }
                else {
                    alert("製令不可為空")
                    $(".BarcodeList").hide()
                    return
                }
            }
        });
       
        $("#txtBarcodeNo@(itemName)").on("keydown", function (e) {
            if (e.which == 13) {
                event.preventDefault(); 
                BarcodePrint@(itemName)()
            }
        });

        $("#cbxSelectAll@(itemName)").on("click", function () {
            if ($("#cbxSelectAll@(itemName)").prop("checked")) {
                $("input[type='checkbox'][name='cbxBarcode@(itemName)']").prop("checked", true);
            } else {
                $("input[type='checkbox'][name='cbxBarcode@(itemName)']").prop("checked", false);
            }
        });
        $("input[type='radio'][name='chkPrintCnt@(itemName)']").change(function () {
            if ($("#txtMoNo@(itemName)").val() != "") {
                if ($("input[name='chkPrintCnt@(itemName)']:checked").val() == "Interval") {
                    if ($("#txtIntervalFirst@(itemName)").val() == "") {
                        alert("區間模式下的開始位置尚未設置", "warning")
                        return
                    }
                    if ($("#txtIntervalLast@(itemName)").val() == "") {
                        alert("區間模式下的結束位置尚未設置", "warning")
                        return
                    }
                    GetLotBarcode@(itemName)()
                }
                else {
                    GetLotBarcode@(itemName)()
                }
            }
            else {
                alert("製令不可為空")
                $(".BarcodeList").hide()
                return
            }
        })
        $("#txtIntervalFirst@(itemName)").change(function () {
            if ($("input[name='chkPrintCnt@(itemName)']:checked").val() == "Interval") {
                console.log("A88")
                if ($("#txtIntervalFirst@(itemName)").val() > 0 && $("#txtIntervalLast@(itemName)").val() > 0) {
                    GetLotBarcode@(itemName)()
                }
            }
        })
        $("#txtIntervalLast@(itemName)").change(function () {
            if ($("input[name='chkPrintCnt@(itemName)']:checked").val() == "Interval") {
                console.log("CT88")
                if ($("#txtIntervalFirst@(itemName)").val() > 0 && $("#txtIntervalLast@(itemName)").val() > 0) {
                    GetLotBarcode@(itemName)()
                }
            }
        })


        if (!isMobile) {
            $("#cboLabelPrintMachine@(itemName), #cboTemporaryBarcodeList@(itemName)").select2({
                width: "100%"
            });
        }
    });


    function GetLotBarcode@(itemName)() {

        var MoId = $("#txtMoNo@(itemName)").val()
        if (MoId == "") {
            alert("製令不能為空")
            return
        }

        let innerHtml = '';

        let targetUrl = "@Url.Action("GetLotBarcodeForLabel", "Production")";
        let postData = {
            "MoId": MoId,
            "BarcodeType": "0",
            "PrintCnt": $("input[name='chkPrintCnt@(itemName)']:checked").val(),
            "IntervalFirst": $("#txtIntervalFirst@(itemName)").val(),
            "IntervalLast": $("#txtIntervalLast@(itemName)").val(),
        };
        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {
            $(".BarcodeList").show()
            pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {
                    innerHtml += `<tr>
                                    <td class="text-center active-content">
                                        <input type="checkbox" id="cbxBarcode@(itemName)${item.LabBarcodeId}" name="cbxBarcode@(itemName)" value="${item.BarcodeNo}""/>
                                    </td>
                                    <td>${i + 1}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.BarcodeNo}" style="max-width: 200px;">${item.BarcodeNo}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.ItemValue}" style="max-width: 50px;">${item.ItemValue}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.BarcodeQty}" style="max-width: 1000px;">${item.BarcodeQty}</td>
                                </tr>`;
                });
            }
            else {
                innerHtml += `<tr>
                                <td class="text-center" colspan="5" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料
                                </td>
                               </tr>`;
            }
        } else {
            alert(data.msg, "alert", 0);
        }

        $("#tblMoIdBarcodeData@(itemName) tbody").html(innerHtml);
        TableComponentInit();
        $("#modalMoIdBarcode@(itemName)").modal("hide");
    }

    function BarcodePrint@(itemName)() {
        var LabelPrintMachine = $("#cboLabelPrintMachine@(itemName)").val()
        if (LabelPrintMachine == "") {
            alert("請選擇標籤機才能列印");
            return
        }
        if ($("#txtBarcodeNo@(itemName)").val() == "") {
            alert("條碼欄位不能為空");
            return
        }
        else {
            let targetUrl = "@Url.Action("MoNoBarcodePrint", "PrintLabel")";
            let postData = {
                "BarcodeNo": $("#txtBarcodeNo@(itemName)").val(),
                "PrintMachine": LabelPrintMachine,
                "ViewCompanyId": companyId@(itemName)
            };
            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                alert("列印成功!!!!", "success", 5)
                GetLotBarcode@(itemName)()

            }
            else {
                alert(data.msg, "alert", 0);
            }
        }
    }
    function MoNoBarcodePrint@(itemName)() {
        var LabelPrintMachine = $("#cboLabelPrintMachine@(itemName)").val()
        
        if (LabelPrintMachine == "") {
            alert("請選擇標籤機才能列印");
            return
        }
        
        if ($("#txtMoNo@(itemName)").val() != "") {
            swal.fire({
                titleText: "確認要列印製令的全部批量條碼嗎?",
                text: "此動作會大量列印標籤，請確認是否要執行!",
                icon: "warning",
                allowOutsideClick: false,
                allowEscapeKey: false,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    let targetUrl = "@Url.Action("MoNoBarcodePrint", "PrintLabel")";
                    let postData = {
                        "MoId": $("#txtMoNo@(itemName)").val(),
                        "PrintMachine": LabelPrintMachine,
                        "PrintCnt": $("input[name='chkPrintCnt@(itemName)']:checked").val(),
                        "ViewCompanyId": companyId@(itemName)
                    };
                    let data = DataAccess.EditContinued(targetUrl, postData, false);
                    if (data.status == "success") {
                        alert("列印成功!!!!", "success", 5)
                        GetLotBarcode@(itemName)()

                    }
                    else {
                        alert(data.msg, "alert", 0);
                    }
                }
            });
        }
        else {
            alert("製令欄位不能為空");
            return
        }
    }
    let TemporaryBarcodeList = []

    function Save@(itemName)() {
        $.each($("input[name='cbxBarcode@(itemName)']"), function () {
            if ($(this).is(":checked")) {
                if (TemporaryBarcodeList.indexOf($(this).val()) == -1) {
                    TemporaryBarcodeList.push($(this).val())
                    AddOption(cboTemporaryBarcodeList@(itemName), $(this).val())
                }
            }
        })
        $("#TemporaryBarcodeListNum").text(TemporaryBarcodeList.length)
        console.log(TemporaryBarcodeList)
    }

    function AddOption(list, text) {
        var index = list.options.length;
        list.options[index] = new Option(text);
        list.selectedIndex = index;
    }
    function ClearBarcodeList@(itemName)() {
        $("#cboTemporaryBarcodeList@(itemName)").empty();
        TemporaryBarcodeList = [];
        $("#TemporaryBarcodeListNum").text(TemporaryBarcodeList.length)
    }
    function DeleteOption@(itemName)(list) {
        var index = list.selectedIndex;
        if (index >= 0) {
            list.options[index] = null;
            TemporaryBarcodeList.splice(index, 1);
            $("#TemporaryBarcodeListNum").text(TemporaryBarcodeList.length)

        }
        else {
            alert("無反白選項！");
        }
    }

    function PrintTemporaryBarcodeList@(itemName)() {
        var LabelPrintMachine = $("#cboLabelPrintMachine@(itemName)").val()
        if (LabelPrintMachine == "") {
            alert("請選擇標籤機才能列印");
            return
        }
        
        if (TemporaryBarcodeList.length > 0) {
            swal.fire({
                titleText: "確認要列印暫存條碼列表嗎?",
                text: "此動作會大量列印標籤，請確認是否要執行!",
                icon: "warning",
                allowOutsideClick: false,
                allowEscapeKey: false,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    let targetUrl = "@Url.Action("MoNoBarcodePrint", "PrintLabel")";
                    let postData = {
                        "TemporaryBarcodeList": TemporaryBarcodeList.join(","),
                        "PrintMachine": LabelPrintMachine,
                        "ViewCompanyId": companyId@(itemName),
                        "LabelFormat": $("#cboLabelFormat@(itemName)").val()
                    };

                    let data = DataAccess.EditContinued(targetUrl, postData, false);

                    if (data.status == "success") {
                        alert("列印成功!!!!", "success", 5)
                        GetLotBarcode@(itemName)()

                    }
                    else {
                        alert(data.msg, "alert", 0);
                    }
                }
            });
        }
        else {
            alert("條碼暫存列表為空，不能列印");
            return
        }
    }

    function GetUserInfo@(itemName)() {
        let targetUrl = "@Url.Action("GetLoginByKey", "User")";
        let postData = {
            "UserNo": $.cookie("Login"),
            "KeyText": $.cookie("LoginKey")
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {
            userId@(itemName) = data.returnData.UserId;
            companyId@(itemName) = data.returnData.CompanyId;
        } else {
            alert(data.msg, "alert", 0);
        }
    }
</script>
        )

