
@using Business_Manager.Helpers
@{
    string itemName = "Quotation";
    string itemNameText = "報價單";
    string authority = ViewBag.authority;

}

@Html.Resource("css",
    @<style>
         .form-group .select2-selection__rendered {
             line-height: 29px !important;
         }

         .form-group .select2-container .select2-selection--single {
             height: 39px !important;
         }

         .form-group .select2-selection__arrow {
             height: 34px !important;
         }

         .table-log {
             margin: 0;
             padding: 0;
             max-height: 30vh;
             margin-bottom: .75rem;
         }

             .table-log th {
                 background-color: #d7ecfa !important;
             }

             .table-log th, .table-log td {
                 padding: 5px 0;
                 text-align: center;
             }

         .active-icon {
             background-color: #d7ecfa;
             color: black;
         }

         .active-icon-detail {
             background-color: white;
             color: black;
         }

         .card-footer1 {
             padding: 0.75rem 0
         }

         .ConfirmUserName {
             margin-left: auto;
             margin-right: 10px;
         }

         .historySetting {
             display: flex;
         }

         .half {
             width: 50%;
         }

         .hidden {
             visibility: hidden;
         }

         .amountWarn {
             color: #ff7373 !important;
         }
    </style>
                        )

<div class="modal fade" id="modalQuery@(itemName)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">搜尋</h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <form class="container" autocomplete="off" id="queryForm@(itemName)">
                    <fieldset>
                        <div class="form-group row">
                            <label class="form-label col-12" for="cboQuotationTagQ@(itemName)">報價單屬性標籤</label>
                            <div class="col-12">
                                <select class="form-control" id="cboQuotationTagQ@(itemName)" name="cboQuotationTagQ@(itemName)" multiple></select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="form-label col-12" for="cboPreciseModeQ@(itemName)">精準模式</label>
                            <div class="col-12">
                                <select class="form-control" id="cboPreciseModeQ@(itemName)" name="cboPreciseModeQ@(itemName)"></select>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="HistoryInitData@(itemName)()" style="margin: auto;"><i class="fal fa-wrench"></i>套用</button>
            </div>
        </div>
    </div>
</div>

<!--清單-->


<!--新增修改-->
<div class="row" id="editData@(itemName)" style="display: none;">
    <div class="col-12">
        <div class="card card-shadow mb-4">
            <div class="card-body ">
                <form class="container custom-form-container" autocomplete="off" id="editForm@(itemName)">
                    <fieldset>
                        <div id="basicList@(itemName)">
                            <div class="row mb-3">
                                <div class="col-6 col-sm-6 col-md-6" style="display: flex; justify-content: flex-start;">
                                    <a style="margin-right: 5px;" class="btn btn-primary FileDown"  ><i class="fal fa-print"></i>圖紙下載</a>
                                    <a style="margin-right: 5px;" class="btn btn-primary auth-quote-print" href="javascript:OpenPrintQuotation@(itemName)();"><i class="fal fa-print"></i>PDF下載</a>
                                </div>
                                <div class="col-6 col-sm-6 col-md-6 text-right" style="display: flex; justify-content: flex-end;">
                                    <a style="margin-right: 5px;" class="btn btn-warning auth-quote-income" id="OpenIncomeStatement@(itemName)" href="javascript:OpenIncomeStatement@(itemName)();"><i class="far fa-calculator"></i>損益分析</a>
                                    <a style="margin-right: 5px;" class="btn btn-info" id="OpenHistory@(itemName)" href="javascript:OpenHistory@(itemName)();"><i class="far fa-file-chart-pie"></i>歷史資料比較</a>
                                </div>
                            </div>
                            <a class="btn btn-collapse" data-toggle="collapse" href="#RfqDetail@(itemName)">
                                <span><i class="fas fa-clipboard"></i> RFQ資訊</span>
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <div class="collapse mb-3" id="RfqDetail@(itemName)" style="display:block;">
                                <div class="card card-body">
                                    <table>
                                        <tr>
                                            <td>
                                                RFQ單號(單號+流水號+版次)
                                            </td>
                                            <td>
                                                客戶
                                            </td>
                                            <td>
                                                機種名稱
                                            </td>
                                        </tr>
                                        <tr>
                                            <td >
                                                <input type="text" class="form-control" id="txtRfqFullNo@(itemName)" name="txtRfqFullNo@(itemName)" placeholder="請輸入需求單號" readonly>
                                            </td>
                                            <td >
                                                <input type="text" class="form-control" id="txtCustomerName@(itemName)" name="txtCustomerName@(itemName)" placeholder="請輸入客戶" readonly>
                                            </td>
                                            <td >
                                                <input type="text" class="form-control" id="txtAssemblyName@(itemName)" name="txtAssemblyName@(itemName)" placeholder="請輸入機種名稱" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                產品類別
                                            </td>
                                            <td colspan="2">
                                                品名
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" id="txtRfqProductTypeName@(itemName)" name="txtRfqProductTypeName@(itemName)" placeholder="請輸入產品類別" readonly>
                                            </td>
                                            <td colspan="2">
                                                <input type="text" class="form-control" id="txtMtlName@(itemName)" name="txtMtlName@(itemName)" placeholder="請輸入品名" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                塑料品名
                                            </td>
                                            <td>
                                                外徑大小
                                            </td>
                                            <td>
                                                芯厚
                                            </td>
                                        </tr>
                                        <tr>
                                            <td >
                                                <input type="text" class="form-control" id="txtPlasticName@(itemName)" name="txtPlasticName@(itemName)" placeholder="請輸入塑料品名" readonly>
                                            </td>
                                            <td >
                                                <input type="text" class="form-control" id="txtOutsideDiameter@(itemName)" name="txtOutsideDiameter@(itemName)" placeholder="請輸入部品外徑大小" readonly>
                                            </td>
                                            <td >
                                                <input type="text" class="form-control" id="txtCoreThickness@(itemName)" name="txtCoreThickness@(itemName)" placeholder="請輸入芯厚" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                模架穴数
                                            </td>
                                            <td colspan="2">
                                                模仁穴数
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" id="txtBaseCavities@(itemName)" name="txtBaseCavities@(itemName)" placeholder="請輸入模架穴数" readonly>
                                            </td>
                                            <td colspan="2">
                                                <input type="text" class="form-control" id="txtInsertCavities@(itemName)" name="txtInsertCavities@(itemName)" placeholder="請輸入模仁穴数" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                量產需求
                                            </td>
                                            <td>
                                                是否鍍膜
                                            </td>
                                            <td>
                                                是否共模
                                            </td>
                                        </tr>
                                        <tr>
                                            <td >
                                                <input type="text" class="form-control" id="txtMassProductionDemand@(itemName)" name="txtMassProductionDemand@(itemName)" placeholder="請選擇量產需求" readonly>
                                            </td>
                                            <td >
                                                <input type="text" class="form-control" id="txtCoatingFlag@(itemName)" name="txtCoatingFlag@(itemName)" placeholder="請選擇是否鍍膜" readonly>
                                            </td>
                                            <td >
                                                <input type="text" class="form-control" id="txtCommonMode@(itemName)" name="txtCommonMode@(itemName)" placeholder="請選擇是否共模" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                月需求量
                                            </td>
                                            <td>
                                                單位
                                            </td>
                                            <td>
                                                幣別
                                            </td>
                                        </tr>
                                        <tr>
                                            <td >
                                                <input type="text" class="form-control" id="txtMonthlyQty@(itemName)" name="txtMonthlyQty@(itemName)" placeholder="請輸入月需求量" readonly>

                                            </td>
                                            <td >
                                                <input type="text" class="form-control" id="txtUomNo@(itemName)" name="txtUomNo@(itemName)" placeholder="請輸入單位" readonly>
                                            </td>
                                            <td >
                                                <input type="text" class="form-control" id="txtCurrency@(itemName)" name="txtCurrency@(itemName)" placeholder="請輸入幣別" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3">
                                                備註
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3">
                                                <input type="text" class="form-control" id="txtDescription@(itemName)" name="txtDescription@(itemName)" placeholder="請輸入備註" readonly>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <a class="btn btn-collapse" data-toggle="collapse" href="javascript:void(0);">
                                <span><i class="fas fa-clipboard"></i> 報價單標籤屬性</span>
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <div class="collapse mb-3" id="basic@(itemName)" style="display:block">
                                <div class="card card-body">
                                    <table>
                                        <tr>
                                            <td style="width:100%;">
                                                <select class="form-control" id="cboQuotationTag@(itemName)" name="cboQuotationTag@(itemName)" multiple></select>
                                            </td>
                                        </tr>
                                    </table>
                                    <div class="card-footer1 text-center text-lg-right">
                                        <button type="button" class="btn btn-success auth-quote-tag" onclick="SaveQuotationTag@(itemName)()"><i class="fas fa-save"></i>儲存</button>
                                    </div>
                                </div>
                            </div>
                            <a class="btn btn-collapse" data-toggle="collapse" href="#QuotationRemark@(itemName)">
                                <span><i class="fas fa-clipboard"></i> 報價單備註</span>
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <div class="collapse mb-3" id="QuotationRemark@(itemName)">
                                <div class="card card-body">
                                    <table>
                                        <tr>
                                            <td style="width:100%;">
                                                <textarea class="form-control" id="txtQuotationRemark@(itemName)" name="txtQuotationRemark@(itemName)" rows="2"
                                                          placeholder="請輸入報價單備註"
                                                          data-msg-required="請輸入報價單備註"
                                                          data-msg-maxlength="必須少於 255 個字元" maxlength="255" required></textarea>
                                            </td>
                                        </tr>
                                    </table>
                                    <div class="card-footer1 text-center text-lg-right">
                                        <button type="button" class="btn btn-success auth-quote-tag" onclick="SaveQuotationRemark@(itemName)()"><i class="fas fa-save"></i>儲存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="list@(itemName)"></div>
                        <div id="bargainList@(itemName)" style="display:none;">
                            <a class="btn btn-collapse" data-toggle="collapse" href="javascript:void(0);">
                                <span><i class="fas fa-clipboard"></i> 報價單議價</span>
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <div class="collapse mb-3" id="bargain@(itemName)" style="display:block">
                                <div class="card card-body">
                                    <table>
                                        <tr>
                                            <td style="width:100%;">
                                                <div>毛利率% <input class="auth-add" type="radio" name="bargain" value="G" checked /> </div>
                                                <input type="number" class="form-control" id="txtGrossMargin@(itemName)" name="txtGrossMargin@(itemName)" placeholder="請輸入費用"
                                                       data-msg-required="請輸入毛利率" data-rule-required="true" value="0" />
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width:100%;">
                                                <div>總費用 <input class="auth-add" type="radio" name="bargain" value="T" /> </div>
                                                <input type="number" class="form-control" id="txtFinalPrice@(itemName)" name="txtFinalPrice@(itemName)" placeholder="請輸入費用"
                                                       data-msg-required="請輸入費用" data-rule-required="true" value="0" disabled />
                                            </td>
                                        </tr>
                                    </table>
                                    <div class="card-footer1 text-center text-lg-right">
                                        <div id="BargainReview" style="display:inline-block;">
                                            <button type="button" class="btn btn-info auth-quote-review" onclick="ActionBargain@(itemName)('Review')"><i class="fas fa-check-circle"></i>經管中心確認</button>
                                        </div>
                                        <button type="button" class="btn btn-info auth-confirm" onclick="ActionBargain@(itemName)('Confirm')"><i class="fas fa-check-circle"></i>確認</button>
                                        <button type="button" class="btn btn-success auth-add" onclick="ActionBargain@(itemName)('Save')"><i class="fas fa-save"></i>儲存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>
                <form class="container custom-form-container half" id="historyForm@(itemName)" style="display:none;">
                    <fieldset>
                        <div id="basicList@(itemName)">
                            <div class="row mb-3">
                                <div class="col-4 col-sm-4 col-md-4">
                                    <a class="btn btn-primary" data-backdrop="static" data-keyboard="false" data-toggle="modal" data-target="#modalQuery@(itemName)"><i class="fal fa-search"></i>搜尋</a>

                                </div>
                                <div class="col-4 col-sm-4 col-md-4">
                                    <select class="form-control" id="cboHistoryQuotation@(itemName)" name="cboHistoryQuotation@(itemName)"
                                            data-msg-required="請選擇歷史報價單" data-rule-required="true"></select>
                                </div>
                                <div class="col-4 col-sm-4 col-md-4 text-right" style="">
                                    <a style="margin-right: 5px;" class="btn btn-secondary" href="javascript:CloseHistory@(itemName)();"><i class="fas fa-undo"></i>關閉</a>
                                </div>
                            </div>
                            @*<div class="pagination" id="page@(itemName)"></div>*@
                            <a class="btn btn-collapse" data-toggle="collapse" href="#RfqDetail@(itemName)">
                                <span><i class="fas fa-clipboard"></i> RFQ資訊</span>
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <div class="collapse mb-3" id="RfqDetailH@(itemName)" style="display:block;">
                                <div class="card card-body">
                                    <table>
                                        <tr>
                                            <td>
                                                RFQ單號(單號+流水號+版次)
                                            </td>
                                            <td>
                                                客戶
                                            </td>
                                            <td>
                                                機種名稱
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" id="txtRfqFullNoH@(itemName)" name="txtRfqFullNoH@(itemName)" placeholder="請輸入需求單號" readonly>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" id="txtCustomerNameH@(itemName)" name="txtCustomerNameH@(itemName)" placeholder="請輸入客戶" readonly>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" id="txtAssemblyNameH@(itemName)" name="txtAssemblyNameH@(itemName)" placeholder="請輸入機種名稱" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                產品類別
                                            </td>
                                            <td colspan="2">
                                                品名
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" id="txtRfqProductTypeNameH@(itemName)" name="txtRfqProductTypeNameH@(itemName)" placeholder="請輸入產品類別" readonly>
                                            </td>
                                            <td colspan="2">
                                                <input type="text" class="form-control" id="txtMtlNameH@(itemName)" name="txtMtlNameH@(itemName)" placeholder="請輸入品名" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                塑料品名
                                            </td>
                                            <td>
                                                外徑大小
                                            </td>
                                            <td>
                                                芯厚
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" id="txtPlasticNameH@(itemName)" name="txtPlasticNameH@(itemName)" placeholder="請輸入塑料品名" readonly>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" id="txtOutsideDiameterH@(itemName)" name="txtOutsideDiameterH@(itemName)" placeholder="請輸入部品外徑大小" readonly>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" id="txtCoreThicknessH@(itemName)" name="txtCoreThicknessH@(itemName)" placeholder="請輸入芯厚" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                模架穴数
                                            </td>
                                            <td colspan="2">
                                                模仁穴数
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" id="txtBaseCavitiesH@(itemName)" name="txtBaseCavitiesH@(itemName)" placeholder="請輸入模架穴数" readonly>
                                            </td>
                                            <td colspan="2">
                                                <input type="text" class="form-control" id="txtInsertCavitiesH@(itemName)" name="txtInsertCavitiesH@(itemName)" placeholder="請輸入模仁穴数" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                量產需求
                                            </td>
                                            <td>
                                                是否鍍膜
                                            </td>
                                            <td>
                                                是否共模
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" id="txtMassProductionDemandH@(itemName)" name="txtMassProductionDemandH@(itemName)" placeholder="請選擇量產需求" readonly>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" id="txtCoatingFlagH@(itemName)" name="txtCoatingFlagH@(itemName)" placeholder="請選擇是否鍍膜" readonly>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" id="txtCommonModeH@(itemName)" name="txtCommonModeH@(itemName)" placeholder="請選擇是否共模" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                月需求量
                                            </td>
                                            <td>
                                                單位
                                            </td>
                                            <td>
                                                幣別
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <input type="text" class="form-control" id="txtMonthlyQtyH@(itemName)" name="txtMonthlyQtyH@(itemName)" placeholder="請輸入月需求量" readonly>

                                            </td>
                                            <td>
                                                <input type="text" class="form-control" id="txtUomNoH@(itemName)" name="txtUomNoH@(itemName)" placeholder="請輸入單位" readonly>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control" id="txtCurrencyH@(itemName)" name="txtCurrencyH@(itemName)" placeholder="請輸入幣別" readonly>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3">
                                                備註
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3">
                                                <input type="text" class="form-control" id="txtDescriptionH@(itemName)" name="txtDescriptionH@(itemName)" placeholder="請輸入備註" readonly>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <a class="btn btn-collapse" data-toggle="collapse" href="javascript:void(0);">
                                <span><i class="fas fa-clipboard"></i> 報價單標籤屬性</span>
                                <i class="fas fa-chevron-down"></i>
                            </a>
                            <div class="collapse mb-3" id="basic@(itemName)" style="display:block">
                                <div class="card card-body">
                                    <table>
                                        <tr>
                                            <td style="width:100%;">
                                                <select class="form-control" id="cboHistoryQuotationTag@(itemName)" name="cboHistoryQuotationTag@(itemName)" multiple disabled style="background-color:unset!important;"></select>
                                                @*<input type="text" class="form-control" id="txtQuotationTag@(itemName)" name="txtQuotationTag@(itemName)" placeholder="請輸入報價單屬性標籤" disabled />*@

                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="historylList@(itemName)"></div>
                    </fieldset>
                </form>
            </div>
            <div class="card-footer text-center text-lg-right">
            </div>
        </div>
    </div>
</div>

<!--備註-->
<div class="modal fade" id="modalRemark@(itemName)">
    <div class="modal-dialog modal-lg" style="padding-top:7%;">
        <div class="modal-content working-content" style="min-width:350px;">
            <div class="modal-header" style="align-items: center;">
                <h5 class="modal-title">
                    異議說明
                    <span class="sub-title" id="ClassTitle" style="color:#f83f37;"></span>
                </h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row" id=" ">
                    <div class="col-12">
                        <form autocomplete="off" id="editForm@(itemName)">
                            <div class="row">
                                <div class="col-lg-12 col-md-12 ">
                                    <div class="form-group row">
                                        @*<label class="form-label col-12" for="txtRemark@(itemName)">異議說明<span class="text-danger">*</span></label>*@
                                        <div class="col-12">
                                            <textarea class="form-control" id="txtRemark@(itemName)" name="txtRemark@(itemName)" rows="2"
                                                      placeholder="請輸入異議說明"
                                                      data-msg-required="請輸入異議說明"
                                                      data-msg-maxlength="必須少於 255 個字元" maxlength="255" required></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            <div class="card-footer text-right text-lg-right">
                <button id="SendNotification@(itemName)" type="button" class="btn btn-success checkbox-mode"><i class="fas fa-paper-plane"></i>確定</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalMaterial@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    採料選單
                    <span class="sub-title">目前採料 <span class="sub-text" id="desMaterial@(itemName)"></span></span>
                </h5>
            </div>
            <div class="modal-body">
                <div class="row" id="listData@(itemName)">
                    <div class="col-lg-12">
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="tblMaterialData@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col" style="min-width: 75px;">#</th>
                                        <th scope="col" style="min-width: 200px;">採購日</th>
                                        <th scope="col" style="min-width: 125px;">金額</th>
                                        <th scope="col" class="col-sticky" style="min-width: 200px;text-align:center;">操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pageMaterial@(itemName)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary list-mode" onclick="CloseMaterial@(itemName)()"><i class="fas fa-times"></i>關閉</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalIncomeStatement@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    損益表
                    <span class="sub-title">目前客戶 <span class="sub-text" id="desIncomeStatement@(itemName)"></span></span>
                </h5>
            </div>
            <div class="modal-body">
                <div class="row" id="listData@(itemName)">
                    <div class="col-lg-12">
                        <form autocomplete="off" id="listDataPopOrder@(itemName)">
                            <fieldset>
                                <div class="form-row align-items-center mb-2">
                                    <div class="col-auto">
                                        <label>品號</label>
                                        <input type="text" class="form-control" id="txtMtlItemNo@(itemName)" name="txtMtlItemNo@(itemName)" placeholder="請輸入品號" />
                                    </div>
                                    <div class="col-auto">
                                        <label>品名</label>
                                        <input type="text" class="form-control" id="txtMtlItemName@(itemName)" name="txtMtlItemName@(itemName)" placeholder="請輸入品名" />
                                    </div>
                                    <div class="col-auto">
                                        <label>請選擇標籤 </label>
                                        <select class="form-control" id="cboIncomeStatementTagListQ@(itemName)" name="cboIncomeStatementTagListQ@(itemName)" multiple></select>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="tblIncomeStatement@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col" style="min-width: 75px;">#</th>
                                        <th scope="col" style="min-width: 200px;">品號</th>
                                        <th scope="col" style="min-width: 200px;">品名</th>
                                        <th scope="col" style="min-width: 200px;">規格</th>
                                        <th scope="col" style="min-width: 125px;">銷貨淨額</th>
                                        <th scope="col" style="min-width: 125px;">平均單價</th>
                                        <th scope="col" style="min-width: 125px;">銷貨成本</th>
                                        <th scope="col" style="min-width: 125px;">毛利</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pageIncomeStatement@(itemName)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary list-mode" onclick="CloseIncomeStatement@(itemName)()"><i class="fas fa-times"></i>關閉</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPrintQuotation@(itemName)">
    <div class="modal-dialog modal-lg" style="padding-top:7%;">
        <div class="modal-content working-content" style="min-width:350px;">
            <div class="modal-header" style="align-items: center;">
                <h5 class="modal-title">
                    報價單輸出
                </h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row" id=" ">
                    <div class="col-12">
                        <form autocomplete="off" id="editForm@(itemName)">
                            <div class="form-grou row">
                                <label class="col-12 col-md-3 col-lg-3 col-form-label">是否換算成單據幣別金額 <span class="text-danger">*</span></label>
                                <div class="col-12 col-md-9 col-lg-9">
                                    <div class="input-group">
                                        <select class="form-control" id="cboExchangeStatus@(itemName)" name="cboExchangeStatus@(itemName)" placeholder="請選擇是否換算成單據幣別金額 "  value="Y">
                                            <option value="Y">是</option>
                                            <option value="N" selected>否</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            <div class="card-footer text-right text-lg-right">
                <button  type="button" class="btn btn-success checkbox-mode" onclick="PrintQuotation@(itemName)()"><i class="fas fa-paper-plane"></i>確定</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFile@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    檔案管理
                </h5>
            </div>
            <div class="modal-body">
                <div class="row" id="FilelistData@(itemName)">
                    <div class="col-lg-12">
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="tblFileData@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col" style="min-width: 75px;">#</th>
                                        <th scope="col" style="min-width: 200px;">檔案</th>
                                        <th scope="col" style="min-width: 75px;">檔案格式</th>
                                        <th class="text-center" scope="col" style="min-width: 125px;">操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pageFile@(itemName)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary list-mode" onclick="CloseFile@(itemName)()"><i class="fas fa-times"></i>關閉</button>
            </div>
        </div>
    </div>
</div>


@Html.Resource("js",
    @<script>
        let objForm@(itemName) = "#editForm@(itemName)";

        let RfqProTypeId@(itemName)
        let saveObj = {}
        let AuthorityObj = {}
        let objPageIncomeStatement@(itemName) = {
            "pageIndex": 0,
            "pageSize": 30
        };
        let objFile@(itemName) = {
            "pageIndex": 0,
            "pageSize": 30
        };
        let NowGrossMargin =0
        let NowFinalPrice =0
        let RfqId@(itemName) =0
        let RfqDetailId@(itemName) = 0
        let CustomerNo = ""

        let userId@(itemName);
        let userNo@(itemName);

        let DIYobj = {}
        $(document).ready(function () {

            ComboBoxs.Default("#cboQuotationTagQ@(itemName)", "@Url.Action("GetQuotationTag", "ScmBasicInformation")", { "Status": "A" }, "", "CHOOSE", "", "TagName", "QtId");
            ComboBoxs.Default("#cboPreciseModeQ@(itemName)", "@Url.Action("GetStatus", "BasicInformation")", { "StatusSchema": "Boolean" }, "N", "CHOOSE", "", "StatusName", "StatusNo");

            $("#cboHistoryQuotation@(itemName)").on("change", function () {
                HistoryData@(itemName)()
            })

            $("#txtMtlItemNo@(itemName), #txtMtlItemName@(itemName)").on("change", function () {
                objPageIncomeStatement@(itemName).pageIndex = 0
                GetIncomeStatement@(itemName)(objPageIncomeStatement@(itemName))
            })

            $('input[name="bargain"]').change(function () {
                switch ($(this).val()) {
                    case "G":
                        //毛利率
                        $("#txtFinalPrice@(itemName)").attr("disabled", true);
                        $("#txtFinalPrice@(itemName)").val(0)
                        $("#txtGrossMargin@(itemName)").attr("disabled", false);
                        $("#txtGrossMargin@(itemName)").val(0)
                        break;
                    case "T":
                        //總費用
                        $("#txtFinalPrice@(itemName)").attr("disabled", false);
                        $("#txtFinalPrice@(itemName)").val(0)
                        $("#txtGrossMargin@(itemName)").attr("disabled", true);
                        $("#txtGrossMargin@(itemName)").val(0)
                        break;
                }
            });

            $("#txtGrossMargin@(itemName)").change(function () {
                let newGrossMargin = $("#txtGrossMargin@(itemName)").val()
                let newFinalPrice = (NowFinalPrice * ((100 - NowGrossMargin) / 100) / ((100 - newGrossMargin) / 100)).toFixed(4)
                $("#txtFinalPrice@(itemName)").val(newFinalPrice)
            })

            $("#txtFinalPrice@(itemName)").change(function () {
                let newFinalPrice = $("#txtFinalPrice@(itemName)").val()
                let nowPrice = (NowFinalPrice / 100 / 1.13 * (100 - NowGrossMargin)).toFixed(4)
                let newGrossMargin = ((nowPrice * 100 * 1.13 - (newFinalPrice * 100)) / (-1 * newFinalPrice)).toFixed(4)
                //let newGrossMargin = (newFinalPrice * ((100 - NowGrossMargin) / 100)).toFixed(4)
                $("#txtGrossMargin@(itemName)").val(newGrossMargin)
            })

            

            $("#cboQuotationTagQ@(itemName), #cboPreciseModeQ@(itemName)").select2({
                dropdownAutoWidth: true,
                width: "100%"
            });
        });

        function GetUserInfo@(itemName)() {
            let targetUrl = "@Url.Action("GetLoginByKey", "User")";
            let postData = {
                "UserNo": $.cookie("Login"),
                "KeyText": $.cookie("LoginKey")
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                userId@(itemName) = data.returnData.UserId;
                userNo@(itemName) = $.cookie("Login")
            } else {
                alert(data.msg, "alert", 0);
            }
        }

        function GetUserAuthority@(itemName)() {
            let targetUrl = "@Url.Action("GetQuotationAuthority", "RequestForQuotation")";
            let postData = {
                "UserNo": $.cookie("Login"),
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                $.each(data.result, function (i, item) {
                    let DetailCode = item.DetailCode
                    let Authority = item.Authority
                    AuthorityObj[DetailCode] = Authority
                })
            } else {
                alert(data.msg, "alert", 0);
            }
        }

        function UpdateAuthorityShow() {
            for (var key in AuthorityObj) {
                if (AuthorityObj[key] == "N") {
                    $(`.auth-${key}`).hide()
                }
            }
        }

        function Expand@(itemName)(RfqDetailId, RfqId) {
            //"RfqDetailId": WebRfqDetailId,
            if (!!RfqDetailId) {
                WebRfqDetailId = RfqDetailId
                RfqDetailId@(itemName) = RfqDetailId
                RfqId@(itemName) = RfqId
            }
            if (WebRfqDetailId > 0) {
                $(".advanced-block").slideDown("slow");

                GetUserInfo@(itemName)()
                GetUserAuthority@(itemName)()
                Return@(itemName)();


            } else {
                $("#editData@(itemName)").hide()
                alert("請採用單身點選進入", "alert");
                return
            }
        }

        function Query@(itemName)() {
            InitData@(itemName)();

            $("#modalQuery@(itemName)").modal("hide");
        }

        //報價單資料產出
        function InitData@(itemName)() {
            let innerHtml = ""
            let changeObj = {}
            KeyParameterObj = {}
            let selectObj = []
            let OEE
            Switch("#editData@(itemName)", "#listData@(itemName)");

            let targetUrl = "@Url.Action("GetQuotationDetail", "RequestForQuotation")";

            let postData = {
                "RfqDetailId": WebRfqDetailId
            };

            ComboBoxs.Default("#cboQuotationTag@(itemName)", "@Url.Action("GetQuotationTag", "ScmBasicInformation")", { "Status": "A" }, "", "CHOOSE", "", "TagName", "QtId");

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                let DataLength = data.result.length-1
                let CheckFinalPriceLog = GetQuotationBargainPrice@(itemName)()

                if (CheckFinalPriceLog) {
                    $("#bargainList@(itemName)").show()
                }
                else {
                    $("#bargainList@(itemName)").hide()
                }
                $.each(data.result, function (i, item) {

                    let QiId = item.QiId
                    RfqProTypeId@(itemName) = item.RfqProTypeId
                    let ConfirmStatus = item.ConfirmStatus
                    let QuotationStatus = item.QuotationStatus
                    let Columns = item.Columns
                    let HtmlColumns = item.HtmlColumns
                    let Currency = item.Currency
                    let CustProdDigram = item.CustProdDigram
                    let ChargeStatus = (item.Charge).split(",").includes(userNo@(itemName))
                    let Detail = JSON.parse(item.Detail);
                    CustomerNo = item.CustomerNo
                    let detilHtml1 = ""
                    let detilHtml2 = ""
                    let detilHtml3 = ""
                    let ButtonBar = ""
                    let showStatus = `${QuotationStatus == `Y` || QuotationStatus == `F` ? i != DataLength ? `style="display:none"` : CheckFinalPriceLog == true ? `style="display:none"` : `` : ``}`
                    if (!saveObj[HtmlColumns]) {
                        saveObj[HtmlColumns] = {};
                    }
                    let Material = item.PlasticName
                    let Fi = item.OutsideDiameter
                    let Thick = item.CoreThickness
                    let AICycleTime = item.AICycleTime
                    $(".FileDown").attr("href", `/Web/GetFile?fileId=${CustProdDigram}`)

                    //RFQ單頭資訊(工作平台)
                    $("#txtRfqFullNo@(itemName)").val(item.RfqFullNo);
                    $("#txtCustomerName@(itemName)").val(item.CustomerName);
                    $("#txtAssemblyName@(itemName)").val(item.AssemblyName);

                    //RFQ單身資訊
                    $("#txtMtlName@(itemName)").val(item.MtlName);
                    $("#txtPlasticName@(itemName)").val(item.PlasticName);
                    $("#txtOutsideDiameter@(itemName)").val(item.OutsideDiameter);
                    $("#txtCoreThickness@(itemName)").val(item.CoreThickness);
                    $("#txtRfqProductTypeName@(itemName)").val(item.RfqProductTypeName);
                    $("#txtBaseCavities@(itemName)").val(item.BaseCavities);
                    $("#txtInsertCavities@(itemName)").val(item.InsertCavities);
                    $("#txtMassProductionDemand@(itemName)").val(item.MassProductionDemand);
                    $("#txtCoatingFlag@(itemName)").val(item.CoatingFlag);
                    $("#txtCommonMode@(itemName)").val(item.CommonMode);
                    $("#txtMonthlyQty@(itemName)").val(item.MonthlyQty);
                    $("#txtUomNo@(itemName)").val(item.UomNo);
                    $("#txtCurrency@(itemName)").val(item.Currency);
                    $("#txtDescription@(itemName)").val(item.Description);
                    KeyParameterObj.MonthlyQty = item.MonthlyQty
                    if (ChargeStatus) {
                        if (ConfirmStatus == "Y") {
                            ButtonBar = `
                             <button type="button" class="btn btn-danger" onclick="Action@(itemName)('ReConfirm','${HtmlColumns}','${QiId}',${i == DataLength ? true : false})"><i class="fas fa-undo-alt"></i>反確認</button>
                            `
                        }
                        else if (ConfirmStatus == "N") {
                            ButtonBar = `${ConfirmStatus == `N` ?
                                    `<button type="button" class="btn btn-info" onclick="Action@(itemName)('Confirm','${HtmlColumns}','${QiId}',${i == DataLength ? true:false})"><i class="fas fa-check-circle"></i>確認</button>
                                     <button type="button" class="btn btn-success" onclick="Action@(itemName)('Save','${HtmlColumns}','${QiId}')"><i class="fas fa-save"></i>儲存</button>
                                     <button type="button" class="btn btn-warning" onclick="Action@(itemName)('Clear','${HtmlColumns}','${QiId}')"><i class="fas fa-broom"></i>清空</button>
                                     <button type="button" class="btn btn-primary " onclick="Calculate@(itemName)('${HtmlColumns}','${QiId}')"><i class="fas fa-calculator-alt"></i>計算</button>
                                       ` : ``}`
                        }
                        else{

                        }
                    }
                    else{
                        ButtonBar = "";
                    }


                    let ClassLast = false
                    if (item.TagList != null) {
                        $("#cboQuotationTag@(itemName)").val((item.TagList).split(',')).trigger("change.select2");
                    }
                    //報價單備註
                    $("#txtQuotationRemark@(itemName)").val(item.QuotationRemark);

                    //報價單欄位資訊
                    
                    let TdWidth = (100 / (Detail.length >= 3 ? 3 : Detail.length)).toFixed(4)
                    $.each(Detail, function (j, item1) {
                        let QieId = item1.QieId
                        let labelNo = item1.ItemElementNo
                        let labelName = item1.ItemElementName
                        let value = item1.QuoteValue
                        let ColumnSetting = item1.ColumnSetting
                        let Flag = item1.Flag
                        let Formula = item1.Formula
                        let InputFuction = ""
                        let InputDisabled = ""
                        let MoldingCycleMsg = ""


                        if (Flag == "MoldingCycle") {
                            CycleTimeAdoption = item.CycleTimeAdoption
                            if (AICycleTime != 0) {
                                //資料已維護採用這邊資料
                                MoldingCycleMsg = `AI預測值:${AICycleTime}`
                                MoldingCycle = AICycleTime
                            }
                            if (RfqProTypeId@(itemName) == 2 && ConfirmStatus == "N" && ChargeStatus == true) {
                                if (value == "" || value == "0") {
                                    if (!!Thick && Thick>0) {
                                        let MoldingCycle = GetAICycleTime(Material, Fi, Thick, ChargeStatus)
                                        if (!!MoldingCycle) {
                                            value = MoldingCycle
                                            //InputDisabled = "disabled"
                                            MoldingCycleMsg = `AI預測值:${MoldingCycle}`
                                        }
                                    }
                                }
                            }
                        }

                        //正式-先不關
                        if (ColumnSetting == "S") {
                            InputDisabled = "disabled"
                        }

                        if ((Flag == "OEE" && CustomerNo != "RG001") || ConfirmStatus == "Y") {
                            InputDisabled = "disabled"
                        }
                        if (CustomerNo != "RG001") {
                            InputFuction = `onchange="KeyParameter(this,'${Flag}')"`
                            switch (Flag) {
                                case "Cavity":
                                    KeyParameterObj[Flag] = parseFloat(value)
                                    break
                                case "MoldingCycle":
                                    KeyParameterObj[Flag] = parseFloat(value)
                                    let dayQty = 24 * 3600 / parseFloat(value) * KeyParameterObj.Cavity
                                    let dayUse = KeyParameterObj.MonthlyQty / dayQty
                                    OEE = ((dayUse / (dayUse + 4)).toFixed(2)) * 100
                                    break
                            }
                        }
                        
                        switch (ColumnSetting) {
                            case "F":
                                detilHtml2 += `
                                <tr><td colspan="3">
                                    <div>${labelName}</div>
                                    <div style="display:flex;">
                                        <input type="number" class="form-control" id="txtHtmlColumns@(itemName)${labelNo}" name="txtHtmlColumns@(itemName)" placeholder="請輸入${labelName}"
                                          value="${value}" data-formula="${Formula}"  disabled />
                                    </div>
                                </td></tr>
                                `
                                break
                            default:
                                 detilHtml1 += `
                                <td style="width:${TdWidth}%;">
                                    <div>${labelName}<span class="text-danger"> * ${Flag == `MoldingCycle` && MoldingCycleMsg.length > 0 ? `${MoldingCycleMsg}` : ``}</span> </div>
                                        ${ColumnSetting != `S` ?
                                     `
                                      <div style="display:flex;position: relative;">
                                         <input type="number" min="0"  class="form-control ${Flag == `OEE` ? `oee` : ``}" id="txtHtmlColumns@(itemName)${labelNo}" name="txtHtmlColumns@(itemName)" placeholder="請輸入${labelName}" value="${value}" ${InputFuction} ${InputDisabled} />
                                      </div >`
                                     :
                                     `
                                      <div style="display:flex;position: relative;width:100%;">
                                        <select class="form-control" id="txtHtmlColumns@(itemName)${labelNo}" name="txtHtmlColumns@(itemName))${labelNo}" style="width: calc(100% - 45px);" ${InputDisabled}></select>
                                        @*<button type="button" class="btn btn-success" onclick="OpenMaterial@(itemName)()" style="width:50px;height: 39px;position: absolute;right: 0;"><i class="fas fa-search"></i></button>*@
                                      </div>
                                    `}
                                </td>
                                `
                                if (ColumnSetting == "C") {
                                    changeObj[QieId] = Formula
                                }
                                if (ColumnSetting == "S") {
                                    selectObj[labelNo] = {}
                                    selectObj[labelNo].formula = Formula
                                    selectObj[labelNo].value = value != "" && value != "0" ? value : Material
                                }
                                break
                        }

                        saveObj[HtmlColumns][labelNo] = { "QieId": QieId, "labelNo": labelNo, "labelName": labelName, "value": value, "ColumnSetting": ColumnSetting, "Formula": Formula, "FormulaSetting": ColumnSetting == `L%` ? `*` : ``, "Flag": Flag };
                    })


                    innerHtml += `
                        <a class="btn btn-collapse" data-toggle="collapse" href="javascript:void(0);" >
                            <span><i class="fas fa-clipboard"></i>${Columns}</span>
                            <span class="ConfirmUserName" style="${item.ConfirmUserName != null ? ``:`color:red;`}"><i class="fas fa-user"></i>確認者:${item.ConfirmUserName != null ? item.ConfirmUserName:`尚未確認` }</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="collapse mb-3" id="basic@(itemName)" style="display:block;max-height: unset;">
                            <div class="card card-body">
                                <table table-layout: fixed;>
                                    <tr style="display: flex;flex-wrap: wrap;">
                                        ${detilHtml1}
                                    </tr>
                                        ${detilHtml2}
                                    <tr>
                                        <td>
                                            <div>備註</div>
                                            <div>
                                                <div>
                                                    <input type="text" class="form-control" id="txtColRemark@(itemName)${HtmlColumns}" name="txtColRemark@(itemName)${HtmlColumns}" placeholder="請輸入描述" value="${item.ColRemark}" ${ConfirmStatus == `Y` ? `disabled` : ``}>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                                <div class="card-footer1 text-center text-lg-right" ${showStatus}>
                                    ${QuotationStatus == `Y` && i == DataLength ? `<button type="button" class="btn btn-info auth-quote-review" onclick="Action@(itemName)('FinalConfirm','${HtmlColumns}','${QiId}',${i == DataLength ? true : false})"><i class="fas fa-check-circle"></i>經管中心確認</button>`: ``}
                                    ${ButtonBar}
                                    ${ConfirmStatus == `Y` ? `<button type="button" class="btn btn-warning auth-quote-notify" onclick="PopModalRemark@(itemName)('${Columns}','${QiId}')"><i class="fas fa-gavel"></i>異議</button>`: ``}
                                </div>
                            </div>
                        </div>`
                })
                $("#list@(itemName)").html(innerHtml)
                //$(".oee").val(OEE)

                UpdateAuthorityShow()

                if (!isMobile) {
                    $("#cboQuotationTag@(itemName)").select2({
                        dropdownAutoWidth: true,
                        width: "100%"
                    });
                }

                //模具報價-自訂義公式算法
                if (RfqProTypeId@(itemName) == 6) {
                    $("#txtHtmlColumns@(itemName)A1").change(function () {
                        let CostPrice = $("#txtHtmlColumns@(itemName)A1").val()
                        let GrossMargin = $("#txtHtmlColumns@(itemName)A2").val()
                        let NoTaxPrice = (CostPrice / ((100 - GrossMargin) / 100)).toFixed(4)
                        let TaxPrice = (NoTaxPrice * 1.13).toFixed(4);
                        $("#txtHtmlColumns@(itemName)A4").val(TaxPrice)
                    })
                    $("#txtHtmlColumns@(itemName)A2").change(function () {
                        let CostPrice = $("#txtHtmlColumns@(itemName)A1").val()
                        let GrossMargin = $("#txtHtmlColumns@(itemName)A2").val()
                        let NoTaxPrice = (CostPrice / ((100 - GrossMargin) / 100)).toFixed(4)
                        $("#txtHtmlColumns@(itemName)A3").val(NoTaxPrice)
                        let TaxPrice = (NoTaxPrice * 1.13).toFixed(4);
                        $("#txtHtmlColumns@(itemName)A4").val(TaxPrice)
                    })
                    $("#txtHtmlColumns@(itemName)A3").change(function () {
                        let CostPrice = $("#txtHtmlColumns@(itemName)A1").val()
                        let NoTaxPrice = $("#txtHtmlColumns@(itemName)A3").val()
                        let GrossMargin = (100 - (100 * CostPrice / NoTaxPrice)).toFixed(4);
                        $("#txtHtmlColumns@(itemName)A2").val(GrossMargin)
                        let TaxPrice = (NoTaxPrice * 1.13).toFixed(4);
                        $("#txtHtmlColumns@(itemName)A4").val(TaxPrice)
                    })
                }
                

                //動態下拉框產生
                for (let key in selectObj) {
                    let ColumnsNo = key
                    let SaveColumnsNo = selectObj[key].formula
                    let SaveValue = selectObj[key].value
                    ComboBoxs.Default(`#txtHtmlColumns@(itemName)${ColumnsNo}`, "@Url.Action("GetMaterial", "PurchaseOrder")", { "Status": "A", "CanUse":"Y" }, "", "NA", "", "MaterialName", "MaterialName");
                    $(`#txtHtmlColumns@(itemName)${ColumnsNo}`).val(SaveValue)
                    let MaterialAmount = $(`#txtHtmlColumnsQuotation${SaveColumnsNo}`).val()
                    if (MaterialAmount == 0) {
                        $(`#txtHtmlColumnsQuotation${SaveColumnsNo}`).val(OpenMaterialQuotation(SaveValue))
                    }
                    if (!isMobile) {
                        $(`#txtHtmlColumns@(itemName)${ColumnsNo}`).select2({
                            dropdownAutoWidth: true,
                            width: "100%"
                        });
                    }
                    $(`#txtHtmlColumns@(itemName)${ColumnsNo}`).on("change", function () {
                        let MaterialName = $(`#txtHtmlColumns@(itemName)${ColumnsNo}`).val()
                        let Amount = OpenMaterial@(itemName)(MaterialName)
                        $(`#txtHtmlColumns@(itemName)${SaveColumnsNo}`).val(Amount)

                    })
                }

                for (let key in changeObj) {
                    $(`#txtHtmlColumns@(itemName)${key}`).on("change", function () {
                        let value =$(`#txtHtmlColumns@(itemName)${key}`).val()
                        if (value >1) {
                            let Formula = changeObj[key]
                            let replacedExpression = Formula.replace(/\[(\d+)\]/g, function (match, p1) {
                                return $(`#txtHtmlColumns@(itemName)${p1}`).val()
                            });
                            value = eval(replacedExpression).toFixed(4);
                            $(`#txtHtmlColumns@(itemName)${key}`).val(value)
                        }
                    })
                }

                for (let key in saveObj) {
                    Calculate@(itemName)(key)
                }
            } else {
                alert(data.msg, "alert", 0);
            }
        }

        //功能操作
        async function Action@(itemName)(Action, Class, QiId, ClassLast) {
            let targetUrl = ""
            let postData = {}
            let alertStr = ""
            let data
            let Data = {}
            let actionStop =false
            let ValueNoPass = true

            switch (Action) {
                case "Save":
                    Data = {}
                    let AiData = {}
                    
                    //Calculate@(itemName)(Class)
                    if (Class == "B") {
                        let AICycleTime = MoldingCycle
                        let MPCycleTime = KeyParameterObj.MoldingCycle 


                        if (CustomerNo != "RG001") {
                            let dayQty = 24 * 3600 / parseFloat(KeyParameterObj.MoldingCycle) * KeyParameterObj.Cavity
                            let dayUse = KeyParameterObj.MonthlyQty / dayQty
                            OEE = ((dayUse / (dayUse + 4)).toFixed(2)) * 100
                            $(".oee").val(OEE)
                        }
                        if (CycleTimeAdoption == "AI" || CycleTimeAdoption == "MP") {
                            if (KeyParameterObj.MoldingCycle == MoldingCycle) {
                                CycleTimeAdoption = "AI"
                            }
                            else {
                                CycleTimeAdoption = "MP"
                            }
                        }
                        else if (CycleTimeAdoption == "AN" || CycleTimeAdoption == "NP") {
                            if (KeyParameterObj.MoldingCycle == MoldingCycle) {
                                CycleTimeAdoption = "AN"
                            }
                            else {
                                CycleTimeAdoption = "NP"
                            }

                        }
                        else if (CycleTimeAdoption == "S") {
                            AICycleTime = 0
                            MPCycleTime = 0
                        }
                        else {
                            AICycleTime = 0
                            MPCycleTime = 0
                            //alert("成形週期採用流程資料異常,請重新確認")
                            //return
                        }
                        AiData = {
                            "CycleTimeAdoption": CycleTimeAdoption,
                            "AICycleTime": AICycleTime,
                            "MPCycleTime": MPCycleTime
                        }
                    }
                    
                    if (Calculate@(itemName)(Class)) {
                        return
                    }
                    for (let key in saveObj[Class]) {
                        let QieId = saveObj[Class][key].QieId
                        let Value = saveObj[Class][key].value
                        Data[QieId] = Value
                    }
                    Data.Remark = $(`#txtColRemark@(itemName)${Class}`).val()

                    targetUrl = "@Url.Action("UpdateQuotationDetail", "RequestForQuotation")";
                    postData = {
                        "QiId": QiId,
                        "Data": JSON.stringify(Data),
                        "AiData": JSON.stringify(AiData)
                    }
                    alertStr = "儲存成功"
                    break
                case "Clear":
                    for (let key in saveObj[Class]) {
                        saveObj[Class][key].value = 0
                        $(`#txtHtmlColumns@(itemName)${key}`).val(0)
                    }
                    alertStr = "清除成功"
                    break
                case "ReConfirm":
                case "Confirm":
                    
                    let Confirm
                    if (ClassLast) {
                        for (let key in saveObj) {
                            if (Calculate@(itemName)(key, ClassLast)) {
                                actionStop = true
                                break
                            }
                        }
                        Data = {}
                        for (let obj in saveObj) {
                            for (let key in saveObj[obj]) {
                                if (saveObj[obj][key].ColumnSetting == "F") {
                                    let Id = saveObj[obj][key].QieId
                                    let Value = saveObj[obj][key].value
                                    Data[Id] = Value
                                }
                            }
                        }
                    }
                    else {
                        for (let key in saveObj[Class]) {
                            if ((saveObj[Class][key].value <= 0 || saveObj[Class][key].value == "") && saveObj[Class][key].ColumnSetting != "F") {
                                ValueNoPass = false
                                Return@(itemName)();
                                break
                            }
                        }
                    }
                    if (actionStop) {
                        return
                    }

                    if (Action == "Confirm") {
                        Confirm = "Y"
                        alertStr = "確認成功"
                    }
                    else {
                        Confirm = "N"
                        alertStr = "反確認成功"
                    }
                    if (Action == "Confirm" && ValueNoPass == false) {
                        const result = await swal.fire({
                            titleText: "請問是否確認項目?",
                            text: "目前項目尚有資料未維護完整或是有資料小於等於0的狀況!!!",
                            icon: "warning",
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            reverseButtons: true
                        });
                        if (result.isConfirmed) {
                            targetUrl = "@Url.Action("UpdateQuotationDetailConfirm", "RequestForQuotation")";
                            postData = {
                                "QiId": QiId,
                                "Confirm": Confirm,
                                "ClassLast": ClassLast,
                                "Data": JSON.stringify(Data)
                            }
                            alertStr = "確認成功"
                        } else {
                            return;
                        }
                    }
                    else {
                        targetUrl = "@Url.Action("UpdateQuotationDetailConfirm", "RequestForQuotation")";
                        postData = {
                            "QiId": QiId,
                            "Confirm": Confirm,
                            "ClassLast": ClassLast,
                            "Data": JSON.stringify(Data)
                        }
                    }
                    break
                case "FinalConfirm":
                    const result = await swal.fire({
                        titleText: "確認是否要核准議價嗎?",
                        text: "此動作無法復原，請確認是否要執行!",
                        icon: "warning",
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        reverseButtons: true
                    });
                    if (result.isConfirmed) {
                        targetUrl = "@Url.Action("UpdateQuotationFinalConfirm", "RequestForQuotation")";
                        postData = {
                            "QiId": QiId,
                        }
                        alertStr = "核准成功"
                        @*data = DataAccess.EditContinued(targetUrl, postData, false);
                        if (data.status == "success") {
                            alert(alertStr, "success", 0);
                            Return@(itemName)();
                        }*@
                    } else {
                        return;
                    }
                    break

            }
            if (Action == "Clear") {
                if (alertStr != "") {
                    alert(alertStr, "success", 0);
                }
            }
            else {
                data = DataAccess.EditContinued(targetUrl, postData, false);
                if (data.status == "success") {
                    alert(alertStr, "success", 0);
                    Return@(itemName)();
                }
            }
        }

        //費用項目計算
        function Calculate@(itemName)(Class, ClassLast) {
            let QieId
            let Formula
            let stop = false
            let err =""
            for (let key in saveObj[Class]) {
                if (stop == true) {
                    break
                }
                if (saveObj[Class][key].ColumnSetting == "F") {
                    let FormulaStatus = true
                    QieId = key
                    Formula = saveObj[Class][key].Formula
                    let replacedExpression = Formula.replace(/\[(\w+)\]/g, function (match, p1) {
                        let FormulaSetting = saveObj[p1[0]][p1].FormulaSetting
                        
                        let value = $(`#txtHtmlColumns@(itemName)${p1}`).val()
                        if (FormulaSetting == "*") {
                            if (value < 0 || value >= 100) {
                                alert("管銷比或毛利率不能為負數或是大於100")
                                stop = true
                            }
                        }
                        if (value == "") {
                            FormulaStatus = false
                        }
                        return value
                    });
                    let isValidFormula = /^[\d\+\-\*\/\.\(\) ]+$/.test(replacedExpression);

                    if (FormulaStatus && isValidFormula) {
                        let result = parseFloat(eval(replacedExpression).toFixed(4));
                        if (!Number.isFinite(result)) {
                            result = 0
                        }
                        $(`#txtHtmlColumns@(itemName)${QieId}`).val(result)
                        if (!ClassLast) {
                            saveObj[Class][QieId].value = 0
                        }
                        else {

                            
                            if (result === "") {
                                alert(`【${Class}】項目資料異常,不可以確認報價`, "alert", 0);
                                stop = true
                            }
                            saveObj[Class][QieId].value = result
                        }
                    }
                }
                else {
                    let KeyValue = $(`#txtHtmlColumns@(itemName)${key}`).val()
                    // 如果不是以 0. 開頭，就移除前導零
                    if (KeyValue != 0 && KeyValue != null && KeyValue != "" ) {
                        if (!KeyValue.startsWith('0.')) {
                            KeyValue = KeyValue.replace(/^0+/, '');
                        }
                    }
                    saveObj[Class][key].value = KeyValue
                }
            }
            if (stop) {

            }
            return stop
        }

        //報價單標籤
        function SaveQuotationTag@(itemName)() {
            let TagList = $("#cboQuotationTag@(itemName)").val().join(",")
            if (TagList.length <= 0) {
                alert(`標籤尚未選擇,不能執行儲存!!`)
                return
            }
            let targetUrl = "@Url.Action("UpdateRfqQuotationTag", "RequestForQuotation")";
            let postData = {
                "RfqDetailId": WebRfqDetailId,
                "TagList": TagList
            }

            let data = DataAccess.Update(targetUrl, postData, false, true);
            if (data.status == "success") {

            }
            else {
                alert(data.msg, "alert", 0);
            }
        }

        //報價單備註
        function SaveQuotationRemark@(itemName)() {
            if ($("#txtQuotationRemark@(itemName)").val() == "") {
                alert("備註不可以為空", "alert", 0);
                return
            }
            let targetUrl = "@Url.Action("UpdateQuotationRemark", "RequestForQuotation")";
            let postData = {
                "RfqDetailId": WebRfqDetailId,
                "QuotationRemark": $("#txtQuotationRemark@(itemName)").val(),
            }

            let data = DataAccess.Update(targetUrl, postData, false, true);
            if (data.status == "success") {

            }
            else {
                alert(data.msg, "alert", 0);
            }
        }

        //項目異議功能
        function PopModalRemark@(itemName)(Class, QiId) {
            $("#modalRemark@(itemName)").modal("show");
            $("#ClassTitle").text(Class)
            $("#txtRemark@(itemName)").val("")
            $('#SendNotification@(itemName)').off('click');
            $("#SendNotification@(itemName)").on('click', function () {
                SendNotification@(itemName)(QiId)
            });
        }

        function Close@(itemName)() {
            ResetForm(objForm@(itemName));
            $("#modal@(itemName)").modal('hide');
            $("#modalRemark@(itemName)").modal('hide');
        }

        function SendNotification@(itemName)(QiId) {
            let Remark = $("#txtRemark@(itemName)").val()
            if (Remark == "") {
                alert(`請填寫好異議說明,才能夠發送通知`)
                return
            }

            let targetUrl = "@Url.Action("NotifyQuotationQuestion", "RequestForQuotation")";

            let postData = {
                "QiId": QiId,
                "Remark": Remark
            };
            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                alert(`異議成功`, "success", 0)
                Close@(itemName)()
            }
            else {
                alert(data.msg, "alert", 0);
            }
        }

        //採料金額
        function OpenMaterial@(itemName)(MaterialName) {
            let AmountErp = 0
            let AmountMes = 0
            let targetUrl = "@Url.Action("GetMtAmountERP", "PurchaseOrder")";

            let postData = {
                "MaterialName": MaterialName
            };

            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                AmountMes = data.result[0]
                AmountErp = data.result[1]
                return AmountMes
                //if (AmountErp == -1) {
                //    return AmountMes
                //}
                //else {
                //    return AmountErp
                //}
            }
            else {
                alert(data.msg, "alert", 0);
            }
        }
        function CloseMaterial@(itemName)() {
            $("#modalMaterial@(itemName)").modal("hide");
        }

        //歷史比較
        function OpenHistory@(itemName)() {
            let TagList = $("#cboQuotationTag@(itemName)").val()

            $("#cboQuotationTagQ@(itemName)").val(TagList).trigger("change.select2");
            let openStatus = HistoryInitData@(itemName)()
            if (openStatus) {
                $("#editData@(itemName) .card .card-body").addClass("historySetting")
                $("#editForm@(itemName)").addClass("half")
                $("#OpenHistory@(itemName)").addClass("hidden")
                $("#historyForm@(itemName)").show()
                HistoryData@(itemName)()

                $("#cboHistoryQuotation@(itemName)").select2({
                    dropdownAutoWidth: true,
                    width: "100%"
                });
            }
            else {
                alert("無符合條件的歷史報價單資料", "alert", 0);
            }
        }
        function CloseHistory@(itemName)() {
            $("#editData@(itemName) .card .card-body").removeClass("historySetting")
            $("#editForm@(itemName)").removeClass("half")
            $("#OpenHistory@(itemName)").removeClass("hidden")
            $("#historyForm@(itemName)").hide()
            ComboBoxs.Default("#cboQuotationTagQ@(itemName)", "@Url.Action("GetQuotationTag", "ScmBasicInformation")", { "Status": "A" }, "", "CHOOSE", "", "TagName", "QtId");
            ComboBoxs.Default("#cboPreciseModeQ@(itemName)", "@Url.Action("GetStatus", "BasicInformation")", { "StatusSchema": "Boolean" }, "N", "CHOOSE", "", "StatusName", "StatusNo");
        }

        //歷史報價單下拉列表
        function HistoryInitData@(itemName)() {
            let TagList = $("#cboQuotationTagQ@(itemName)").val().join(',')
            let PreciseMode = $("#cboPreciseModeQ@(itemName)").val()

            if (PreciseMode == "Y" && TagList == "") {
                alert("精準模式需要設定標籤條件!!", "alert", 0);
                return
            }
            let Status = false
            let pageCount = 0;
            let innerHtml = ""
            let targetUrl = "@Url.Action("GetQuotationHistory", "RequestForQuotation")";
            let postData = {
                "RfqDetailId": WebRfqDetailId,
                "RfqProTypeId": RfqProTypeId@(itemName),
                "TagList": TagList,
                "PreciseMode": PreciseMode
            };
            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                if (data.result.length > 0) {
                    Status = true
                    if (PreciseMode == "N") {
                        let AllStatus = ""
                        $.each(data.result, function (i, item) {
                            AllStatus = item.All

                        })
                        if (AllStatus == "Y") {
                            $("#cboQuotationTagQ@(itemName)").val("").trigger("change.select2");
                            TagList = "";
                            alert("無相似條件的歷史報價單資料,故撈取該類型的報價單", "alert", 0);
                        }
                    }

                    ComboBoxs.Default("#cboHistoryQuotation@(itemName)", "@Url.Action("GetQuotationHistory", "RequestForQuotation")", { "RfqDetailId": WebRfqDetailId, "RfqProTypeId": RfqProTypeId@(itemName), "TagList": TagList, "PreciseMode": PreciseMode }, "", "CHOOSE", "", "RfqFullNo", "RfqDetailId");

                    $("#modalQuery@(itemName)").modal('hide');
                }
                else {
                    CloseHistory@(itemName)()
                    alert("無符合條件的歷史報價單資料", "alert", 0);
                    $("#modalQuery@(itemName)").modal('hide');

                }
            } else {
                alert(data.msg, "alert", 0);
            }
            return Status
        }

        //歷史報價單資料表單
        function HistoryData@(itemName)() {
            let innerHtml = ""
            let targetUrl = "@Url.Action("GetQuotationDetail", "RequestForQuotation")";
            let postData = {
                "RfqDetailId": $("#cboHistoryQuotation@(itemName)").val()
            };
            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                if (data.result.length <= 0) {
                    alert("目前無歷史報價單資料", "alert", 0);
                    return
                }
                let DataLength = data.result.length - 1
                ComboBoxs.Default("#cboHistoryQuotationTag@(itemName)", "@Url.Action("GetQuotationTag", "ScmBasicInformation")", { "Status": "A" }, "", "CHOOSE", "", "TagName", "QtId");

                $.each(data.result, function (i, item) {

                    let QiId = item.QiId
                    let ConfirmStatus = item.ConfirmStatus
                    let QuotationStatus = item.QuotationStatus
                    let Columns = item.Columns
                    let HtmlColumns = item.HtmlColumns
                    let Currency = item.Currency
                    let Detail = JSON.parse(item.Detail);
                    let detilHtml1 = ""
                    let detilHtml2 = ""
                    let detilHtml3 = ""
                    if (!saveObj[HtmlColumns]) {
                        saveObj[HtmlColumns] = {};
                    }
                    let ClassLast = false
                    let TdWidth = (100 / (Detail.length >= 3 ? 3 : Detail.length)).toFixed(4)
                    if (item.TagList != null) {
                        $("#cboHistoryQuotationTag@(itemName)").val((item.TagList).split(',')).trigger("change.select2");
                    }

                    //RFQ單頭資訊(工作平台)
                    $("#txtRfqFullNoH@(itemName)").val(item.RfqFullNo);
                    $("#txtCustomerNameH@(itemName)").val(item.CustomerName);
                    $("#txtAssemblyNameH@(itemName)").val(item.AssemblyName);

                    //RFQ單身資訊
                    $("#txtMtlNameH@(itemName)").val(item.MtlName);
                    $("#txtCoreThicknessH@(itemName)").val(item.CoreThickness);
                    $("#txtPlasticNameH@(itemName)").val(item.PlasticName);
                    $("#txtOutsideDiameterH@(itemName)").val(item.OutsideDiameter);
                    $("#txtRfqProductTypeNameH@(itemName)").val(item.RfqProductTypeName);
                    $("#txtBaseCavitiesH@(itemName)").val(item.BaseCavities);
                    $("#txtInsertCavitiesH@(itemName)").val(item.InsertCavities);
                    $("#txtMassProductionDemandH@(itemName)").val(item.MassProductionDemand);
                    $("#txtCoatingFlagH@(itemName)").val(item.CoatingFlag);
                    $("#txtCommonModeH@(itemName)").val(item.CommonMode);
                    $("#txtMonthlyQtyH@(itemName)").val(item.MonthlyQty);
                    $("#txtUomNoH@(itemName)").val(item.UomNo);
                    $("#txtCurrencyH@(itemName)").val(item.Currency);
                    $("#txtDescriptionH@(itemName)").val(item.Description);

                    $.each(Detail, function (j, item1) {
                        let QieId = item1.QieId
                        let labelNo = item1.ItemElementNo
                        let labelName = item1.ItemElementName
                        let value = item1.QuoteValue
                        let ColumnSetting = item1.ColumnSetting
                        let Formula = item1.Formula

                        switch (ColumnSetting) {
                            case "F":
                                detilHtml2 += `

                                <tr><td colspan="3">
                                    <div>${labelName}</div>
                                    <div style="display:flex;">
                                        <input type="number" class="form-control" id="txtHtmlColumns@(itemName)${labelNo}" name="txtHtmlColumns@(itemName)${labelNo}" placeholder="請輸入${labelName}"
                                          value="${value}" disabled />
                                    </div>
                                </td></tr>
                                `
                                break
                            default:
                                 detilHtml1 += `
                                <td style="width:${TdWidth}%;">
                                    <div>${labelName}</div>
                                    <div style="display:flex;position: relative;">
                                         <input type="text" class="form-control" id="txtHtmlColumns@(itemName)${labelNo}" name="txtHtmlColumns@(itemName)${labelNo}" placeholder="請輸入${labelName}" value="${value}" disabled/>
                                    </div >
                                </td>
                                `
                                break
                        }
                    })


                    innerHtml += `
                        <a class="btn btn-collapse" data-toggle="collapse" href="javascript:void(0);">
                            <span><i class="fas fa-clipboard"></i>${Columns}</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="collapse mb-3" id="basic@(itemName)" style="display:block">
                            <div class="card card-body">
                                <table table-layout: fixed;>
                                    <tr style="display: flex;flex-wrap: wrap;">
                                        ${detilHtml1}
                                    </tr>
                                        ${detilHtml2}
                                    <tr>
                                        <td>
                                            <div>備註</div>
                                            <div>
                                                <div>
                                                    <input type="text" class="form-control" id="txtColRemark@(itemName)${HtmlColumns}" name="txtColRemark@(itemName)${HtmlColumns}" placeholder="請輸入描述" value="${item.ColRemark}">
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    `
                })
                $("#historylList@(itemName)").html(innerHtml)

                if (!isMobile) {
                    $("#cboHistoryQuotationTag@(itemName)").select2({
                        dropdownAutoWidth: true,
                        width: "100%"
                    });
                }
            }
            else {
                alert(data.msg, "alert", 0);

            }
        }


        function OpenIncomeStatement@(itemName)() {
            objPageIncomeStatement@(itemName).pageIndex = 0;
            $("#modalIncomeStatement@(itemName)").modal("show");
            $("#desIncomeStatement@(itemName)").val("")
            let TagList = $("#cboQuotationTag@(itemName)").val().join(',')
            ComboBoxs.Default("#cboIncomeStatementTagListQ@(itemName)", "@Url.Action("GetQuotationTag", "ScmBasicInformation")", { "Status": "A" }, "", "CHOOSE", "", "TagName", "QtId");
            $("#cboIncomeStatementTagListQ@(itemName)").val(TagList).trigger("change.select2");
            GetIncomeStatement@(itemName)(objPageIncomeStatement@(itemName) )

            $("#cboIncomeStatementTagListQ@(itemName)").select2({
                dropdownAutoWidth: true,
                width: "100%"
            });
        }

        //損益表
        function GetIncomeStatement@(itemName)(objPage) {
            let innerHtml = ""
            let pageCount = 0;

            let TagList = $("#cboIncomeStatementTagListQ@(itemName)").val().join(',')
            let targetUrl = "@Url.Action("GetIncomeStatement", "RequestForQuotation")";
            let postData = {
                "OrderBy": "",
                "PageIndex": (objPage.pageIndex + 1),
                "PageSize": objPage.pageSize,
                "RfqId": $("#RfqId").val(),
                "MtlItemNo": $("#txtMtlItemNo@(itemName)").val(),
                "MtlItemName": $("#txtMtlItemName@(itemName)").val(),
                "TagList": TagList
            };
            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {

                pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;
                if (pageCount > 0) {
                    objPage = PageCaculate(pageCount, objPage);
                    $.each(data.result, function (i, item) {
                        let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";
                        let amountWarn = false
                        if (parseFloat(item.Gross) < 0) {
                            amountWarn = true
                        }
                        innerHtml += `<tr>
                                        <td class="${amountWarn ? `amountWarn`:``}">${_row}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn`:``}" data-toggle="tooltip" title="${item.LA005}" style="max-width: 200px;">${item.LA005}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn`:``}" data-toggle="tooltip" title="${item.MB002}" style="max-width: 200px;">${item.MB002}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn`:``}" data-toggle="tooltip" title="${item.MB003}" style="max-width: 200px;">${item.MB003}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn` : ``}" data-toggle="tooltip" title="${item.NetSales}" style="max-width: 200px;">${item.NetSales}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn` : ``}" data-toggle="tooltip" title="${item.Average}" style="max-width: 200px;">${item.Average}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn` : ``}" data-toggle="tooltip" title="${item.Cost}" style="max-width: 200px;">${item.Cost}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn` : ``}" data-toggle="tooltip" title="${item.Gross}" style="max-width: 200px;">${item.Gross}</td>
                                      </tr>`;
                    })
                }
                else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="5" style="background-color: #fff3cd;">
                                      <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }
            }
            else {
                alert(data.msg, "alert", 0);
            }

            $("#tblIncomeStatement@(itemName) tbody").html(innerHtml);
            TableComponentInit();
            Pager("#pageIncomeStatement@(itemName)", pageCount, objPage, GetIncomeStatement@(itemName));
        }

        function CloseIncomeStatement@(itemName)() {
            $("#modalIncomeStatement@(itemName)").modal("hide");

        }


        //議價相關
        function GetQuotationBargainPrice@(itemName)() {
            let CheckFinalPriceLog = false

            let targetUrl = "@Url.Action("GetQuotationBargainPrice", "RequestForQuotation")";
            let postData = {
                "RfqDetailId": WebRfqDetailId,
            }

            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                if (data.result.length > 0) {
                    $.each(data.result, function (i, item) {
                        $("#txtFinalPrice@(itemName)").val(item.FinalPrice)
                        $("#txtGrossMargin@(itemName)").val(item.GrossMargin)
                        NowGrossMargin = item.NowGrossMargin
                        NowFinalPrice = item.NowFinalPrice
                        if (item.ConfirmStatus == "Y") {
                            $("#BargainReview").show()
                        }
                        else {
                            $("#BargainReview").hide()
                        }

                    })
                    CheckFinalPriceLog = true
                }
            }
            else {
                alert(data.msg, "alert", 0);
            }

            return CheckFinalPriceLog
        }
        function ActionBargain@(itemName)(Action) {
            let CheckFinalPriceLog = false
            let RfqId = $("#RfqId").val()
            let FinalPrice = $("#txtFinalPrice@(itemName)").val()
            let GrossMargin = $("#txtGrossMargin@(itemName)").val()

            if (FinalPrice <= 0 || GrossMargin <= 0) {
                alert("議價資料不可為負數或尚未維護完整,請重新確認", "alert", 0);
                return
            }
            let targetUrl
            let postData = {}
            let data
            switch (Action) {
                case "Save":
                    targetUrl = "@Url.Action("AddQuotationBargain", "RequestForQuotation")";
                    postData = {
                        "RfqDetailId": WebRfqDetailId,
                        "FinalPrice": FinalPrice,
                        "GrossMargin": GrossMargin
                    }

                    data = DataAccess.Add(targetUrl, postData, false, true);
                    if (data.status == "success") {
                        if (data.result.length > 0) {

                        }
                    }
                    else {
                        alert(data.msg, "alert", 0);
                    }
                    break;
                case "Confirm":
                    targetUrl = "@Url.Action("UpdateQuotationBargainConfirm", "RequestForQuotation")";
                    postData = {
                        "RfqDetailId": WebRfqDetailId
                    }
                    data = DataAccess.Get(targetUrl, postData, false);
                    if (data.status == "success") {
                        Return@(itemName)()
                    }
                    else {
                        alert(data.msg, "alert", 0);
                    }
                    break;
                case "Review":
                    swal.fire({
                        titleText: "確認是否要核准議價嗎?",
                        text: "此動作無法復原，請確認是否要執行!",
                        icon: "warning",
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            targetUrl = "@Url.Action("UpdateQuotationBargainReview", "RequestForQuotation")";
                            postData = {
                                "RfqDetailId": WebRfqDetailId
                            }
                            data = DataAccess.Get(targetUrl, postData, false);
                            if (data.status == "success") {
                                Return@(itemName)()
                            }
                            else {
                                alert(data.msg, "alert", 0);
                            }
                        }
                    });
                    break;
            }
        }

        function OpenPrintQuotation@(itemName)() {
            $("#modalPrintQuotation@(itemName)").modal("show");

        }

        function PrintQuotation@(itemName)() {

            let targetUrl = "@Url.Action("GetQuotationPdf", "RequestForQuotation")";
            let postData = {
                "RfqDetailId": WebRfqDetailId,
                "RfqIdList":"",
                "ExchangeStatus": $("#cboExchangeStatus@(itemName)").val()
            };
            FileAccess.AjaxDownload(targetUrl, postData, false);
            $("#modalPrintQuotation@(itemName)").modal("hide");
        }

        function OpenFileList@(itemName)() {
            

            return
            objFile@(itemName).pageIndex = 0;
            $("#modalFile@(itemName)").modal("show");
            GetFile@(itemName)(objFile@(itemName) )

            //let url =`https://bm.zy-tech.com.tw/RequestForQuotation/RfqAssignManagment?UrlRfqId=${RfqId@(itemName)}&UrlRfqDetailId=${RfqDetailId@(itemName)}`
            //alert(`開發中!!請等待!!目前請先回RFQ單據查看【Web】${url}`)
            return
        }

        function CloseFile@(itemName)() {
            $("#modalFile@(itemName)").modal("hide");
        }

        function GetFile@(itemName)(objPage) {
            let innerHtml = ""
            let pageCount = 0;
            let targetUrl = "@Url.Action("GetQuotationHistory", "RequestForQuotation")";
            let postData = {
                "RfqDetailId": WebRfqDetailId
            };
            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {

                pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;
                if (pageCount > 0) {
                    objPage = PageCaculate(pageCount, objPage);
                    $.each(data.result, function (i, item) {
                        let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";
                        let amountWarn = false
                        if (parseFloat(item.Gross) < 0) {
                            amountWarn = true
                        }
                        innerHtml += `<tr>
                                        <td class="${amountWarn ? `amountWarn`:``}">${_row}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn`:``}" data-toggle="tooltip" title="${item.LA005}" style="max-width: 200px;">${item.LA005}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn`:``}" data-toggle="tooltip" title="${item.MB002}" style="max-width: 200px;">${item.MB002}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn`:``}" data-toggle="tooltip" title="${item.MB003}" style="max-width: 200px;">${item.MB003}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn` : ``}" data-toggle="tooltip" title="${item.NetSales}" style="max-width: 200px;">${item.NetSales}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn` : ``}" data-toggle="tooltip" title="${item.Average}" style="max-width: 200px;">${item.Average}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn` : ``}" data-toggle="tooltip" title="${item.Cost}" style="max-width: 200px;">${item.Cost}</td>
                                        <td class="ellipsis ${amountWarn ? `amountWarn` : ``}" data-toggle="tooltip" title="${item.Gross}" style="max-width: 200px;">${item.Gross}</td>
                                      </tr>`;
                    })
                }
                else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="5" style="background-color: #fff3cd;">
                                      <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }
            }
            else {
                alert(data.msg, "alert", 0);
            }

            $("#tblFileData@(itemName) tbody").html(innerHtml);
            TableComponentInit();
            Pager("#pageFile@(itemName)", pageCount, objPage, GetFile@(itemName));
        }

        let KeyParameterObj = {}
        function KeyParameter(element, Flag) {

            if (CustomerNo == "RG001") {
                return
            }

            switch (Flag) {
                case "Cavity":
                    KeyParameterObj[Flag] = parseFloat(element.value)
                    break
                case "MoldingCycle":
                    KeyParameterObj[Flag] = parseFloat(element.value) 
                    let dayQty = 24 * 3600 / parseFloat(element.value) * KeyParameterObj.Cavity
                    if (dayQty <= 0) {
                        alert("稼動率計算小於等於0,請確認是否為異常")
                        $(".oee").val(0)
                    }
                    else {
                        let dayUse = KeyParameterObj.MonthlyQty / dayQty
                        let OEE = ((dayUse / (dayUse + 4)).toFixed(2)) * 100
                        $(".oee").val(OEE)
                    }
                    break

            }
        }

        let MoldingCycle
        let CycleTimeAdoption
        function GetAICycleTime(Material, Fi, Thick) {

            if (Material == "" || Fi == "" || Thick == "") {
                alert("【AI計算成形週期】:外徑,材料,芯厚參數不能為空,請回報或是先採用人工輸入方式")
                return false
            }

            let targetUrl = "@Url.Action("GetAICycleTime", "RequestForQuotation")";
            let postData = {
                "Material": Material,
                "Fi": Fi,
                "Thick": Thick
            };
            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                if (data.data.length > 0) {
                    if (parseFloat(data.data)) {
                        MoldingCycle = data.data
                        CycleTimeAdoption = "AI"

                        if (data.msg.length > 0) {
                            alert(`${data.msg}`, "alert", 0)
                            CycleTimeAdoption = "AN"
                        }


                        return MoldingCycle
                    }
                    else {
                        alert("AI自動計算成行週期回傳資料異常,請回報或是先採用人工輸入方式")
                        return false
                    }
                }
                else {
                    alert("AI自動計算成行週期回傳資料異常,請回報或是先採用人工輸入方式")
                    return false
                }
            }
            else {
                alert(data.msg, "alert", 0);
                return false
            }
        }

        function Return@(itemName)() {
            saveObj = {}
            ResetForm(objForm@(itemName));
            Switch("#listData@(itemName)", "#editData@(itemName)");
            Query@(itemName)();
            CloseHistory@(itemName)()
        }
    </script>
                                )
