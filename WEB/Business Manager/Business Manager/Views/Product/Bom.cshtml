@using Business_Manager.Helpers
@{
    string itemName = "Bom";
    string itemNameText = "產品結構";
}

@Html.Resource("css",
    @<style>
         .txt-red {
             color: #FF0000;
         }

         .txt-darkorange {
             color: #FF8C00;
         }

         .subject-content {
             font-size: 1rem;
         }

             .subject-content p {
                 margin-bottom: 0.25rem;
             }


         .card .card-header {
             background-color: rgba(0,0,0,.03);
         }

         fieldset.scheduler-border {
             padding: 0 1.4em 1.4em 1.4em !important;
             margin: 0 0 1.5em 0 !important;
             border: solid 1px #36a2f5 !important;
             border-radius: 5px;
         }

         legend.scheduler-border {
             font-size: 1.2rem !important;
             font-weight: bold !important;
             width: auto;
             padding: 0 10px;
             color: #36a2f5;
         }

         .help-block span {
             display: block;
         }

         .bomEffectiveText {
             border: 1px solid rgba(235,0,0,.7);
             border-radius: 3px;
             color: rgba(235,0,0,1);
             font-family: "Font Awesome 5 Pro";
             font-weight: bold;
             padding: 5px;
         }

         .qcbtn {
             background-color: #242eee;
             color: #fff;
         }

             .qcbtn:hover {
                 color: #fe0;
             }
    </style>
                )

<div class="row">
    <div class="col-12">
        <div class="card card-shadow mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-12" id="SubjectList@(itemName)">
                        <div class="title-row">
                            <h5 class="fw-600">主件</h5>
                            <input type="hidden" id="BomId" name="BomId" value=-1 />
                            <input type="hidden" id="txtMtlQcItemId@(itemName)" name="txtMtlQcItemId@(itemName)" value=-1 />
                            <div>
                                <a class="btn btn-primary auth-bom" href="javascript:Datas@(itemName).EditBillOfMaterials@(itemName)();"><i class="fas fa-edit"></i>修改主件</a>
                                <a class="btn qcbtn pop-view" href="javascript:void(0);"><i class="fas fa-code-branch"></i>允收標準</a>
                            </div>
                        </div>
                        <div class="subject-content" id="SubjectContent@(itemName)"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <form id="SubjectEdit@(itemName)" autocomplete="off" style="padding: 1rem 0; display: none;">
                            <fieldset class="scheduler-border">
                                <legend class="scheduler-border">主件設定</legend>
                                <div class="container">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-group row">
                                                <label class="form-label col-12" for="txtStandardLot@(itemName)">標準批量<span class="text-danger">*</span></label>
                                                <div class="col-12">
                                                    <input type="number" class="form-control" id="txtStandardLot@(itemName)" name="txtStandardLot@(itemName)" placeholder="請輸入標準批量"
                                                           data-msg-required="請輸入標準批量" data-rule-required="true" value="1" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-group row">
                                                <label class="form-label col-12" for="cboWipPrefix@(itemName)">製令單別</label>
                                                <div class="col-12">
                                                    <select class="form-control" id="cboWipPrefix@(itemName)" name="cboWipPrefix@(itemName)"></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="form-group row">
                                                <label class="form-label col-12" for="txtBomRemark@(itemName)">備註 </label>
                                                <div class="col-12">
                                                    <textarea class="form-control" id="txtBomRemark@(itemName)" name="txtBomRemark@(itemName)" placeholder="請輸入備註"
                                                              data-msg-maxlength="必須少於 255 個字元" maxlength="255" rows="2"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12 text-right">
                                        <a class="btn btn-secondary" href="javascript:ReturnSubject@(itemName)();"><i class="fas fa-undo"></i>返回</a>
                                        <a class="btn btn-success" href="javascript:Datas@(itemName).SaveBillOfMaterials@(itemName)();"><i class="fas fa-save"></i>儲存</a>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-12" id="ComponentList@(itemName)">
                        <div class="title-row">
                            <h5 class="fw-600">元件</h5>
                            <div>
                                <input type="checkbox" name="chkStatus@(itemName)" data-bomdetail-visible="1">
                                <a class="btn btn-info auth-bom" href="javascript:Datas@(itemName).EditBomDetail@(itemName)(-1);"><i class="fas fa-plus"></i>新增元件</a>
                                <a class="btn btn-primary auth-bom" href="javascript:PopBomCopyView@(itemName)();" hidden="hidden"><i class="fas fa-copy"></i>複製元件</a>
                                <a class="btn btn-success ml-1 auth-data-transfer" href="javascript:Datas@(itemName).Transfer@(itemName)();"><i class="fas fa-sign-out"></i>拋轉ERP</a>
                            </div>
                        </div>
                        <input type="hidden" id="BomDetailId" name="BomDetailId" value="-1" />
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4" id="ComponentContent@(itemName)"></div>
                    </div>
                </div>
                <div class="col-12">
                    <form id="ComponentEdit@(itemName)" autocomplete="off" style="padding:1rem 0rem;display:none;">
                        <fieldset class="scheduler-border">
                            <legend class="scheduler-border">元件設定</legend>
                            <div class="container">
                                <div class="form-group row">
                                    <label class="form-label col-12">元件品號<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <div class="input-group">
                                            <input type="hidden" id="txtMtlItemId@(itemName)" />
                                            <input type="text" class="form-control" id="txtMtlItemNo@(itemName)" name="txtMtlItemNo@(itemName)" onkeyup="trimStr(this, value)" placeholder="請輸入元件品號" />
                                            <div class="input-group-append">
                                                <a class="btn btn-success pop-view" href="javascript:void(0);"><i class="fal fa-search"></i></a>
                                                <a class="btn btn-outline-danger pop-clear" href="javascript:Clear@(itemName)();"><i class="fas fa-eraser"></i></a>
                                            </div>
                                        </div>
                                        <dl class="help-block">
                                            <dt>品名</dt>
                                            <dd id="desMtlItemName@(itemName)"></dd>
                                            <dt>規格</dt>
                                            <dd id="desMtlItemSpec@(itemName)"></dd>
                                        </dl>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtBomSequence@(itemName)">序號<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="txtBomSequence@(itemName)" name="txtBomSequence@(itemName)" placeholder="請輸入序號"
                                                   data-msg-required="請輸入序號" data-rule-required="true">
                                            <div class="input-group-append">
                                                <a class="btn btn-danger" href="javascript:void(0);" onclick="Datas@(itemName).TakeNumber@(itemName)('#txtBomSequence@(itemName)');">
                                                    <i class="fa fa-random"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtCompositionQuantity@(itemName)">單位用量<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <input type="number" class="form-control" id="txtCompositionQuantity@(itemName)" name="txtCompositionQuantity@(itemName)" placeholder="請輸入單位用量"
                                               data-msg-required="請輸入單位用量" data-rule-required="true" value="1">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtBase@(itemName)">底數<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <input type="number" class="form-control" id="txtBase@(itemName)" name="txtBase@(itemName)" placeholder="請輸入底數"
                                               data-msg-required="請輸入底數" data-rule-required="true" value="1">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtLossRate@(itemName)">損壞率<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <input type="number" class="form-control" id="txtLossRate@(itemName)" name="txtLossRate@(itemName)" placeholder="請輸入損壞率"
                                               data-msg-required="請輸入損壞率" data-rule-required="true" value="0">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtMaterialProperties@(itemName)">材料性質<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <select class="form-control" id="cboMaterialProperties@(itemName)" name="cboMaterialProperties@(itemName)"></select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtComponentType@(itemName)">上料類型<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <select class="form-control" id="cboComponentType@(itemName)" name="cboComponentType@(itemName)"></select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="chkStandardCostingType@(itemName)">標準成本計算<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <div class="row">
                                            <div class="col-lg-3 col-md-4 col-6">
                                                <label class="control control-solid control-solid-info control--radio col-12">
                                                    是
                                                    <input type="radio" id="chkStandardCostingType@(itemName)Y" name="chkStandardCostingType@(itemName)" value="Y"
                                                           data-msg-required="請選擇是否修改標準成本計算" data-rule-required="true" />
                                                    <span class="control__indicator"></span>
                                                </label>
                                            </div>
                                            <div class="col-lg-3 col-md-4 col-6">
                                                <label class="control control-solid control-solid-info control--radio col-12">
                                                    否
                                                    <input type="radio" id="chkStandardCostingType@(itemName)N" name="chkStandardCostingType@(itemName)" value="N"
                                                           data-msg-required="請選擇是否修改標準成本計算" data-rule-required="true" checked />
                                                    <span class="control__indicator"></span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtEffectiveDate@(itemName)">生效日期</label>
                                    <div class="input-group col-12">
                                        <input type="text" class="form-control datedropper" id="txtEffectiveDate@(itemName)" name="txtEffectiveDate@(itemName)"
                                               data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"
                                               placeholder="請輸入生效日期" readonly />
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-outline-danger" onclick="$('#txtEffectiveDate@(itemName)').val('')" title="清除">
                                                <i class="fas fa-eraser"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtExpirationDate@(itemName)">失效日期</label>
                                    <div class="input-group col-12">
                                        <input type="text" class="form-control datedropper" id="txtExpirationDate@(itemName)" name="txtExpirationDate@(itemName)"
                                               data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"
                                               placeholder="請輸入失效日期" readonly />
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-outline-danger" onclick="$('#txtExpirationDate@(itemName)').val('')" title="清除">
                                                <i class="fas fa-eraser"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtBomDetailRemark@(itemName)">備註</label>
                                    <div class="col-12">
                                        <textarea class="form-control" id="txtBomDetailRemark@(itemName)" name="txtBomDetailRemark@(itemName)" placeholder="請輸入備註"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 text-right">
                                    <a class="btn btn-secondary" href="javascript:ReturnComponent@(itemName)();"><i class="fas fa-undo"></i>返回</a>
                                    <a class="btn btn-success" href="javascript:Datas@(itemName).SaveBomDetail@(itemName)();"><i class="fas fa-save"></i>儲存</a>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!--複製元件-->
<div class="modal fade" id="copyBomModalQuery@(itemName)">
    <div class="modal-dialog" style="max-width: 80%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">複製元件</h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3" id="query@(itemName)">
                    <div class="col-12">
                        <form autocomplete="off" id="queryForm@(itemName)">
                            <fieldset>
                                <input type="hidden" id="txtTransferStatusQ@(itemName)" value="" />
                                <div class="form-row align-items-center mb-2">
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtMtlItemQ@(itemName)" name="txtMtlItemQ@(itemName)"
                                               placeholder="請輸入品號/品名" />
                                    </div>

                                    <div class="col-auto">
                                        <button type="button" class="btn btn-primary" onclick="GetBOMList@(itemName)()"><i class="fal fa-search"></i>搜尋</button>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
                <div class="row" id="listData@(itemName)">
                    <div class="col-12">
                        <div class="card card-shadow mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="table-custom">
                                            <table class="table table-bordered table-striped table-sticky" id="BOMListtblData@(itemName)">
                                                <thead>
                                                    <tr>
                                                        <th scope="col" style="min-width: 75px;">#</th>
                                                        <th scope="col" style="min-width: 125px;">品號</th>
                                                        <th scope="col" style="min-width: 125px;">品名</th>
                                                        <th class="text-center" scope="col" style="min-width: 150px;">操作</th>
                                                        <th class="text-center col-sticky" scope="col" style="min-width: 110px;">請選擇</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                        <div class="pagination" id="page@(itemName)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                @*<button type="button" class="btn btn-primary" onclick="Query@(itemName)()" style="margin: auto;"><i class="fal fa-wrench"></i>套用</button>*@
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let Datas@(itemName) = new DataControl@(itemName)();
        let Elements@(itemName) = new ElementControl@(itemName)();
        let objForm@(itemName) = "#ComponentEdit@(itemName)";
        let objPage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };
        let bomSequenceVal@(itemName) = -1;
        let bomDetailId@(itemName) = -1;

        function Expand@(itemName)() {
            if (parseInt($("#MtlItemId").val()) > 0) {
                $(".advanced-block").slideDown("slow");
                Switch("#SubjectList@(itemName)", "#SubjectEdit@(itemName)");

                ReturnSubject@(itemName)();
                ReturnComponent@(itemName)();
            } else {
                alert("請先儲存品號", "alert");
            }
        }

        function Query@(itemName)() {
            objPage@(itemName).pageIndex = 0;
            Datas@(itemName).GetBillOfMaterials@(itemName)();
            Elements@(itemName).InitBom@(itemName)();
            Elements@(itemName).InitBomDetail@(itemName)();
            $(`input[name='chkStatus@(itemName)']`).data('bomdetail-visible', 0).bootstrapToggle('off');
        }

        function ElementControl@(itemName)() {
            addMethod(this, "InitBom@(itemName)", function () {
                $(`input[name='chkStatus@(itemName)']`).bootstrapToggle({
                    on: "顯示無效元件",
                    off: "隱藏無效元件",
                    onstyle: "success",
                    offstyle: "danger",
                    size: "mini",
                    width: "125px",
                    height: "20px"
                });

                $(`input[name='chkStatus@(itemName)']`).off("change").on("change", function () {
                    Datas@(itemName).SwitchBomDetailVisible@(itemName)(this);
                });

                let popConfig = {
                    targetSelector: "#txtMtlQcItemId@(itemName)",
                    popFunction: "PopViewQcItemRule",
                    mtlItemId: $("#MtlItemId").val(),
                    identify: "A",
                    message: "G"
                };
                InitPopView(popConfig);
            });

            addMethod(this, "InitBomDetail@(itemName)", function () {
                $.each($(`input[name='DetailMtlItemId@(itemName)']`), function (i, e) {
                    let mtlItemId = $(e).val();
                    let popConfig = {
                        targetSelector: `#txtMtlQcItemId@(itemName)-${mtlItemId}`,
                        popFunction: "PopViewQcItemRule",
                        mtlItemId,
                        identify: "A",
                        message: "G"
                    };
                    InitPopView(popConfig);
                });
            });
        }

        function DataControl@(itemName)() {
            addMethod(this, "SwitchBomDetailVisible@(itemName)", function (e) {
                let visible = parseInt($(e).data('bomdetail-visible'));
                switch (visible) {
                    case 0:
                        $(`.effective0`).hide();
                        break;
                    case 1:
                        $(`.effective0`).show();
                        break;
                }
                $(e).data('bomdetail-visible', 1 - visible);
            });

            addMethod(this, "GetBillOfMaterials@(itemName)", function () {
                $("#BomId").val("-1");
                $("#ComponentContent@(itemName)").html("");

                let innerHtml = '';

                let targetUrl = "@Url.Action("GetBillOfMaterials", "Product")";
                let postData = {
                    "MtlItemId": $("#MtlItemId").val()
                };
                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {

                    if (data.result.length > 0) {

                        if (data.result.filter(f => f.TransferStatus == `N`).length > 0) { $(`.auth-bom, .auth-data-transfer`).show(); }
                        else $(`.auth-bom, .auth-data-transfer`).hide();

                        $.each(data.result, function (i, item) {
                            innerHtml += `<p>標準批量：<span class="txt-skyblue" id="desStandardLot@(itemName)">${item.StandardLot}<code>${item.UomNo}</code></span></p>
                                          <p>製令單別：<span class="txt-skyblue" id="desWipPrefix@(itemName)">${item.WipPrefixName}<code>(${item.WipPrefix})</code></span></p>
                                          <p>備註：<span class="txt-skyblue" id="desRemark@(itemName)">${item.Remark}</span></p>`;

                            $("#BomId").val(item.BomId);
                        });
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                $("#SubjectContent@(itemName)").html(innerHtml);

                if ($("#BomId").val() > 0) {
                    Datas@(itemName).GetBomDetail@(itemName)();
                    $(`#SubjectList@(itemName) .auth-bom`).prop(`class`, `btn btn-primary auth-bom`).html(`<i class="fas fa-edit"></i>修改主件`);
                }
                else {
                    $(`#SubjectList@(itemName) .auth-bom`).prop(`class`, `btn btn-info auth-bom`).html(`<i class="fas fa-plus"></i>新增主件`);
                }
            });

            addMethod(this, "GetBomDetail@(itemName)", function () {
                let innerHtml = '';

                let targetUrl = "@Url.Action("GetBomDetail", "Product")";
                let postData = {
                    "BomId": $("#BomId").val(),
                    "HideFlag":"N"
                };
                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    bomSequenceVal@(itemName) = data.result.length > 0 ? data.result.length * 10 : 0;
                    if (data.result.length > 0) {
                        bomDetailId@(itemName)  = data.result[data.result.length - 1].BomDetailId;

                        $.each(data.result, function (i, item) {
                            innerHtml += `<div class="col effective${item.Effective}">
                                              <div class="card border-secondary mb-3">
                                                  <header class="card-header">
                                                      <input type="hidden" name="DetailMtlItemId@(itemName)" value="${item.MtlItemId}" />
                                                      <input type="hidden" id="txtMtlQcItemId@(itemName)-${item.MtlItemId}" name="txtMtlQcItemId@(itemName)-${item.MtlItemId}" value=-1 />
                                                      ${item.TransferStatus == `N` ? `
                                                      <div class="float-right">
                                                          <a class="active-link" href="javascript:Datas@(itemName).EditBomDetail@(itemName)(${item.BomDetailId});">
                                                              <i class="fas fa-edit"></i>
                                                          </a>
                                                          <a class="active-link" href="javascript:Datas@(itemName).DeleteBomDetail@(itemName)(${item.BomDetailId});">
                                                              <i class="fas fa-trash-alt"></i>
                                                          </a>
                                                      </div>` : item.Effective == 0 ? `<div class="float-right bomEffectiveText">無效</div>` : ``}
                                                      <div class="float-right">
                                                          <a class="btn qcbtn pop-view" href="javascript:void(0);">
                                                              <i class="fas fa-code-branch"></i>允收標準
                                                          </a>
                                                    　</div>
                                                      <span class="card-title">元件</span>
                                                      <p class="card-subtitle" style="margin-top: .05rem;">
                                                          序號：<span class="text-danger">${item.BomSequence}</span>
                                                      </p>
                                                  </header>
                                                  <div class="card-body" style="padding: .75rem 1rem;">
                                                      <dl class="row mb-0">
                                                          <dt class="col-12">品號：<span class="txt-skyblue">${item.MtlItemNo}</span></dt>
                                                          <dt class="col-12">品名：<span class="txt-skyblue">${item.MtlItemName}</span></dt>
                                                          <dt class="col-12">規格：<span class="txt-skyblue">${item.MtlItemSpec}</span></dt>
                                                          <dt class="col-12">單位用量：<span class="txt-skyblue">${item.CompositionQuantity}<code>${item.UomNo}</code></span></dt>
                                                          <dt class="col-12">底數：<span class="txt-skyblue">${item.Base}</span></dt>
                                                          <dt class="col-12">損耗率：<span class="txt-skyblue">${item.LossRate}</span></dt>`;
                                                            switch (item.MaterialProperties){
                                                                case "1":
                                                                    //直接材料
                                                                    innerHtml += `<dt class="col-12">材料性質：<span class="txt-skyblue">直接材料</span></dt>`;
                                                                    break;
                                                                case "2":
                                                                    //間接材料
                                                                    innerHtml += `<dt class="col-12">材料性質：<span class="txt-darkorange">間接材料</span></dt>`;
                                                                    break;
                                                                case "3":
                                                                    //廠商供料
                                                                    innerHtml += `<dt class="col-12">材料性質：<span class="txt-darkorange">廠商供料</span></dt>`;
                                                                    break;
                                                                case "4":
                                                                    //不發料
                                                                    innerHtml += `<dt class="col-12">材料性質：<span class="txt-darkorange">不發料</span></dt>`;
                                                                    break;
                                                                case "5":
                                                                    //客戶供料
                                                                    innerHtml += `<dt class="col-12">材料性質：<span class="txt-darkorange">客戶供料</span></dt>`;
                                                                    break;
                                                                default:
                                                                    break;
                                                            }
                                                            switch (item.StandardCostingType) {
                                                                case "Y":
                                                                    innerHtml += `<dt class="col-12">標準成本計算：<span class="txt-skyblue">${item.StandardCostingType}</span></dt>`;
                                                                    break;
                                                                case "N":
                                                                    innerHtml += `<dt class="col-12">標準成本計算：<span class="txt-red">${item.StandardCostingType}</span></dt>`;
                                                                    break;
                                                                default:
                                                                    break;
                                                            }
                                                            switch (item.ComponentType) {
                                                                case "B":
                                                                    innerHtml += `<dt class="col-12">載盤上料：<span class="txt-skyblue">條碼</span></dt>`;
                                                                    break;
                                                                case "L":
                                                                    innerHtml += `<dt class="col-12">載盤上料：<span class="txt-skyblue">批號</span></dt>`;
                                                                    break;
                                                                case "N":
                                                                    innerHtml += `<dt class="col-12">載盤上料：<span class="txt-red">不上料</span></dt>`;
                                                                    break;
                                                                default:
                                                                    innerHtml += `<dt class="col-12">載盤上料： </dt>`;
                                                                    break;
                                                            }
                                                          innerHtml +=`<dt class="col-12">生效日期：<span class="txt-skyblue">${item.EffectiveDate}</span></dt>
                                                          <dt class="col-12">失效日期：<span class="txt-skyblue">${item.ExpirationDate}</span></dt>
                                                          <dt class="col-12">建立日期：<span class="txt-skyblue">${item.CreateDate}</span></dt>
                                                          <dt class="col-12">備註：<span class="txt-skyblue">${item.Remark}</span></dt>
                                                      </dl>
                                                  </div>
                                              </div>
                                          </div>`;
                        });
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }
                $("#ComponentContent@(itemName)").html(innerHtml);
            });

            addMethod(this, "EditBillOfMaterials@(itemName)", function () {
                ComboBoxs.WithText("#cboWipPrefix@(itemName)", "@Url.Action("GetErpData", "BasicInformation")", { "ColumnName": "WipErpPrefix" }, "", "NA", "", "WoErpPrefixName", "WoErpPrefix");

                let WipPrefixText = '5101 廠內製令';
                $("#cboWipPrefix@(itemName) option").filter(function () {
                    return $(this).text() == WipPrefixText;
                }).attr('selected', true);

                Switch("#SubjectEdit@(itemName)", "#SubjectList@(itemName)");

                let targetUrl = "@Url.Action("GetBillOfMaterials", "Product")";
                let postData = {
                    "MtlItemId": $("#MtlItemId").val(),
                    "BomId": $("#BomId").val()
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    $.each(data.result, function (i, item) {
                        $("#txtStandardLot@(itemName)").val(item.StandardLot);
                        $("#cboWipPrefix@(itemName)").val(item.WipPrefix);
                        $("#txtBomRemark@(itemName)").val(item.Remark);
                    });
                } else {
                    alert(data.msg, "alert", 0);
                }
                if (!isMobile) {
                    $("#cboWipPrefix@(itemName)").select2({
                        dropdownAutoWidth: true,
                        width: "100%"
                    });
                }
            });

            addMethod(this, "SaveBillOfMaterials@(itemName)", function () {
                if ($(objForm@(itemName)).valid()) {
                    let BomId = parseInt($("#BomId").val());

                    let targetUrl = "@Url.Action("UpdateBillOfMaterials", "Product")";
                    let postData = {
                        "BomId": BomId,
                        "MtlItemId": $("#MtlItemId").val(),
                        "StandardLot": $("#txtStandardLot@(itemName)").val(),
                        "WipPrefix": $("#cboWipPrefix@(itemName)").val(),
                        "Remark": $("#txtBomRemark@(itemName)").val()
                    };

                    let result = DataAccess.Update(targetUrl, postData, false, false);

                    if (result) {
                        ReturnSubject@(itemName)();
                    }
                }
            });

            addMethod(this, "EditBomDetail@(itemName)", function (BomDetailId) {
                $("#BomDetailId").val(BomDetailId != -1 ? BomDetailId : 0);
                Switch("#ComponentEdit@(itemName)", "#ComponentList@(itemName)");

                let currentDate = new Date();
                Suites.DateDropper("#txtEffectiveDate@(itemName), #txtExpirationDate@(itemName)");

                Suites.SetDateDropper("#txtEffectiveDate@(itemName)");
                Suites.SetDateDropper("#txtExpirationDate@(itemName)");

                if (BomDetailId > 0) {
                    let targetUrl = "@Url.Action("GetBomDetail", "Product")";
                    let postData = {
                        "BomDetailId": BomDetailId
                    };

                    let data = DataAccess.Get(targetUrl, postData, false);

                    if (data.status == "success") {
                        $.each(data.result, function (i, item) {
                            $("#txtMtlItemId@(itemName)").val(item.MtlItemId);
                            $("#txtMtlItemNo@(itemName)").val(item.MtlItemNo);
                            $("#desMtlItemName@(itemName)").html(item.MtlItemName);
                            $("#desMtlItemSpec@(itemName)").html(item.MtlItemSpec);
                            $("#txtMtlItemNo@(itemName)").parents().find(".help-block").css("display", "grid");

                            $("#txtBomSequence@(itemName)").val(item.BomSequence);
                            $("#txtCompositionQuantity@(itemName)").val(item.CompositionQuantity);
                            $("#txtBase@(itemName)").val(item.Base);
                            $("#txtLossRate@(itemName)").val(item.LossRate);
                            if (item.StandardCostingType == "Y") {
                                $("#chkStandardCostingType@(itemName)Y").prop("checked", true);
                                $("#chkStandardCostingType@(itemName)N").prop("checked", false);
                            } else {
                                $("#chkStandardCostingType@(itemName)Y").prop("checked", false);
                                $("#chkStandardCostingType@(itemName)N").prop("checked", true);
                            }
                            ComboBoxs.Default("#cboMaterialProperties@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MaterialProperties" }, "", "NA", "", "TypeName", "TypeNo");
                            $("#cboMaterialProperties@(itemName)").val(item.MaterialProperties);
                             ComboBoxs.Default("#cboComponentType@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "BomComponentType" }, "", "NA", "", "TypeName", "TypeNo");
                            $("#cboComponentType@(itemName)").val(item.ComponentType);//不上料
                            if (item.EffectiveDate) {
                                Suites.SetDateDropper("#txtEffectiveDate@(itemName)", new Date(item.EffectiveDate));
                            }
                            if (item.ExpirationDate) {
                                Suites.SetDateDropper("#txtExpirationDate@(itemName)", new Date(item.ExpirationDate));
                            }
                            $("#txtBomDetailRemark@(itemName)").val(item.Remark);
                        });
                    } else {
                        alert(data.msg, "alert", 0);
                    }
                } else {
                    //#region預設【材料型態】跟【標準成本計算】
                    $("#chkStandardCostingType@(itemName)Y").prop("checked", true);//【標準成本計算】:是
                    $("#chkStandardCostingType@(itemName)N").prop("checked", false);
                    ComboBoxs.Default("#cboMaterialProperties@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MaterialProperties" }, "", "NA", "", "TypeName", "TypeNo");
                    ComboBoxs.Default("#cboComponentType@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "BomComponentType" }, "", "NA", "", "TypeName", "TypeNo");
                    $("#cboComponentType@(itemName)").val("N");//不上料
                

                    $("#cboMaterialProperties@(itemName)").val("1");//直接材料
                    //#endregion

                    Clear@(itemName)();
                    Datas@(itemName).TakeNumber@(itemName)('#txtBomSequence@(itemName)');
                }

                let popConfig = {
                    targetSelector: "#txtMtlItemNo@(itemName)",
                    popFunction: "PopViewMtlItem",
                    objectMtlItemId: "#txtMtlItemId@(itemName)",
                    objectMtlItemNo: "#txtMtlItemNo@(itemName)",
                    @*objectMtlItemNo: "#desMtlItemNo@(itemName)",*@
                    objectMtlItemName: "#desMtlItemName@(itemName)",
                    objectMtlItemSpec: "#desMtlItemSpec@(itemName)",
                    objectCheckMtlDate: (new Date()).Format('yyyy-MM-dd')
                };

                InitPopView(popConfig);
            });

            addMethod(this, "SaveBomDetail@(itemName)", function () {
                if ($(objForm@(itemName)).valid()) {
                    let BomDetailId = parseInt($("#BomDetailId").val());

                    if (BomDetailId <= 0) {
                        @*//#region預設【材料型態】跟【標準成本計算】
                        $("#chkStandardCostingType@(itemName)Y").prop("checked", true);//【標準成本計算】:是
                        $("#chkStandardCostingType@(itemName)N").prop("checked", false);
                        ComboBoxs.Default("#cboMaterialProperties@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MaterialProperties" }, "", "NA", "", "TypeName", "TypeNo");
                        $("#cboMaterialProperties@(itemName)").val("1");//直接材料
                        //#endregion*@

                        let targetUrl = "@Url.Action("AddBomDetail", "Product")";
                        let postData = {
                            "BomId": $("#BomId").val(),
                            "MtlItemId": $("#txtMtlItemId@(itemName)").val(),
                            "BomSequence": $("#txtBomSequence@(itemName)").val(),
                            "CompositionQuantity": $("#txtCompositionQuantity@(itemName)").val(),
                            "Base": $("#txtBase@(itemName)").val(),
                            "LossRate": $("#txtLossRate@(itemName)").val(),
                            "StandardCostingType": $("input[name='chkStandardCostingType@(itemName)']:checked").val(),
                            "MaterialProperties": $("#cboMaterialProperties@(itemName)").val(),
                            "Remark": $("#txtBomDetailRemark@(itemName)").val(),
                            "ComponentType": $("#cboComponentType@(itemName)").val()
                        };
                        let result = DataAccess.Add(targetUrl, postData, false, false);

                        if (result) {
                            ReturnComponent@(itemName)();
                            Datas@(itemName).GetBomDetail@(itemName)();
                        }
                    } else {
                        let targetUrl = "@Url.Action("UpdateBomDetail", "Product")";
                        let postData = {
                            "BomDetailId": BomDetailId,
                            "BomId": $("#BomId").val(),
                            "MtlItemId": $("#txtMtlItemId@(itemName)").val(),
                            "BomSequence": $("#txtBomSequence@(itemName)").val(),
                            "CompositionQuantity": $("#txtCompositionQuantity@(itemName)").val(),
                            "Base": $("#txtBase@(itemName)").val(),
                            "LossRate": $("#txtLossRate@(itemName)").val(),
                            "StandardCostingType": $("input[name='chkStandardCostingType@(itemName)']:checked").val(),
                            "MaterialProperties": $("#cboMaterialProperties@(itemName)").val(),
                            "Remark": $("#txtBomDetailRemark@(itemName)").val(),
                            "ComponentType": $("#cboComponentType@(itemName)").val()

                        };
                    

                        let result = DataAccess.Update(targetUrl, postData, false, false);

                        if (result) {
                            ReturnComponent@(itemName)();
                            Datas@(itemName).GetBomDetail@(itemName)();
                        }
                    }
                }
            });

            addMethod(this, "DeleteBomDetail@(itemName)", function (BomDetailId) {
                swal.fire({
                    titleText: "確認要刪除嗎?",
                    text: "此動作無法復原，請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        let targetUrl = "@Url.Action("DeleteBomDetail", "Product")";
                        let postData = {
                            "BomDetailId": BomDetailId
                        };

                        if (DataAccess.Delete(targetUrl, postData, false, false)) {
                            alert('刪除成功', 'success', 0);
                            Query@(itemName)();
                        }
                        else {
                            alert('刪除失敗', 'error', 0);
                        }
                    }
                });
            });

            addMethod(this, "Transfer@(itemName)", function () {
                swal.fire({
                    titleText: "是否要拋轉ERP?",
                    text: "請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        let targetUrl = "@Url.Action("UpdateBomToERP", "Product")";
                        let postData = {
                            "BomId": $("#BomId").val(),
                            "MtlItemId": $("#MtlItemId").val()
                        };

                        let result = DataAccess.Other(targetUrl, postData, false, false);

                        if (result) {
                            alert('拋轉成功', 'success', 0);
                            Query@(itemName)();
                        }
                    }
                });
            });

            addMethod(this, "TakeNumber@(itemName)", function (BomSequence) {
                let targetUrl = "@Url.Action("GetBomSequence", "Product")";
                let postData = {
                    "BomId": $("#BomId").val()
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    $.each(data.result, function (i, item) {
                        var seq = parseInt(item.BomSequence);

                        if (seq == 0) {
                            seq = 10;
                        } else {
                            seq = seq + 10;
                        }
                        var serial = "0000" + seq;

                        $(BomSequence).val(serial.substr(serial.length - 4));
                    });

                    if (data.result.length <= 0) {
                        $(BomSequence).val("0010");
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }
            });
        }

        function GetBOMList@(itemName)() {
            @*objPage@(itemName).pageIndex = 0;*@
            let objPage = objPage@(itemName);
            let innerHtml = '';
            let pageCount = 0;
            let targetUrl = "@Url.Action("GetBOMList", "Product")";
            let postData = {
                    "OrderBy": "",
                    "PageIndex": (objPage.pageIndex + 1),
                    "PageSize": objPage.pageSize,
                    "CurrentMtlItemId": $("#MtlItemId").val(),
                    "MtlItem": $("#txtMtlItemQ@(itemName)").val()
                };

            let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;
                if (pageCount > 0) {
                    objPage = PageCaculate(pageCount, objPage);
                    $.each(data.result, function (i, item) {
                        let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";
                        innerHtml += `<tr>
                                        <td>${_row}</td>
                                        <td>${item.MtlItemNo}</td>
                                        <td>${item.MtlItemName}</td>
                                        <td class="text-center active-content">
                                            <a class="active-link detail-button" href="javascript:Detail@(itemName)(${item.MtlItemId});"><i class="fas fa-list"></i><span>元件</span></a>
                                        </td>
                                        <td  class="text-center col-sticky">
                                          <label class="control control-solid control-solid-info control--radio">
                                            <input type="radio" name="chkMtlItemId@(itemName)" data-mtl-item-id="${item.MtlItemId}" data-bom-id="${item.BomId}" value="${item.MtlItemId}" />
                                            <span class="control__indicator"></span>
                                          </label>
                                        </td>
                                      </tr>
                                      <tr data-mo-id="${item.MtlItemId}" style="display: none;">
                                        <td colspan="9">
                                          <table style="width: 100%; margin: auto; border: 1px solid #d7d7e1;">
                                            <thead>
                                             <tr>
                                                <th class="thead-customized" scope="col">BOM品號</th>
                                                <th class="thead-customized" scope="col">BOM品名</th>
                                                <th class="thead-customized" scope="col">規格</th>
                                                <th class="thead-customized" scope="col">單位用量</th>
                                                <th class="thead-customized" scope="col">底數</th>
                                                <th class="thead-customized" scope="col">損耗率</th>
                                                <th class="thead-customized" scope="col">生效日期</th>
                                                <th class="thead-customized" scope="col">建立日期</th>
                                                <th class="thead-customized" scope="col">備註</th>
                                              </tr>
                                           </thead>
                                            <tbody>
                                                ${BOMDetailData@(itemName)(item.BOMDetail)}

                                            </tbody>
                                          </table>
                                        </td>
                                      </tr>
                                      <tr></tr>`;
                    });
                }
                else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="9" style="background-color: #fff3cd;">
                                        <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }
                } else {
                    alert(data.msg, "alert", 0);
            }
            $("#BOMListtblData@(itemName) tbody").html(innerHtml);
            TableComponentInit();
            Pager("#page@(itemName)", pageCount, objPage, GetBOMList@(itemName));

            $("input[type='radio']").click(function () {
                if ("[data-mtl-item-id]:checked") {
                    let mtlItemId = $(this).data("mtl-item-id");
                    let bomId = $(this).data("bom-id");

                    if (mtlItemId) {

                        AddCopyBomDetail@(itemName)(bomId, mtlItemId);
                        BomSubData@(itemName)(mtlItemId);

                    }
                }
                    $("#copyBomModalQuery@(itemName)").modal('hide');
            });
        }

        function BOMDetailData@(itemName)(DetailData) {
            let html = '';

            if (DetailData) {
                let json = JSON.parse(DetailData);

                for (let x = 0; x < json.data.length; x++) {

                    html += `<tr>
                                <td class="tbody-customized">${json.data[x].MtlItemNo}</td>
                                <td class="tbody-customized">${json.data[x].MtlItemName}</td>
                                <td class="tbody-customized">${json.data[x].MtlItemSpec}</td>
                                <td class="tbody-customized">${json.data[x].UomNo}</td>
                                <td class="tbody-customized">${json.data[x].Base}</td>
                                <td class="tbody-customized">${json.data[x].LossRate}</td>
                                <td class="tbody-customized">${json.data[x].EffectiveDate}</td>
                                <td class="tbody-customized">${json.data[x].CreateDate}</td>
                                <td class="tbody-customized">${json.data[x].Remark}</td>
                             </tr>`;
                }
            } else {
                html += `<tr>
                            <td class="text-center" colspan="9" style="background-color: #fff3cd;">
                                <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                            </td>
                        </tr>`;

            }
            return html;
        }

        function BomSubData@(itemName)(mtlItemId) {
            let bomDetailId = "";
            let substituteStatus = "";
            let mtlItemId2 = "";
            let quantity = "";
            let sortNumber = "";
            let precedence = "";
            let effectiveDate = "";
            let expirationDate = "";
            let remark = "";
            let currentCount = 0;

            let targetUrl0 = "@Url.Action("GetBomSubstitution", "Product")";
            let postData0 = {
                "OrderBy": "",
                "PageIndex": 1,
                "PageSize": 10,
                "MtlItemId": $("#MtlItemId").val(),
                "BomDetailId": -1,
                @*"SubMtlItemId": $("#cboSubMtlItemIdQ@(itemName)").val(),*@
                "SubstituteStatus": "2,3"

            };
            let data0 = DataAccess.Get(targetUrl0, postData0, false);
            if (data0.status == "success") {
                    currentCount = data0.result.length > 0 ? parseInt(data0.result[0]["TotalCount"]) : 0;

            }

            let targetUrl = "@Url.Action("GetBomSubstitution", "Product")";
            let postData = {
                "OrderBy": "",
                "PageIndex": 1,
                "PageSize": 10,
                "MtlItemId": mtlItemId,
                "BomDetailId": "",
                @*"SubMtlItemId": $("#cboSubMtlItemIdQ@(itemName)").val(),*@
                "SubstituteStatus": ""

            };
            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                $.each(data.result, function (i, item) {
                    bomDetailId = bomDetailId@(itemName)
                    substituteStatus = item.SubstituteStatus
                    mtlItemId2 = item.MtlItemId
                    quantity = item.Quantity
                    sortNumber = currentCount + i + 1
                    precedence = item.Precedence
                    effectiveDate = item.EffectiveDate
                    expirationDate = item.ExpirationDate
                    remark = item.Remark

                    let targetUrl2 = "@Url.Action("AddBomSubstitution", "Product")";
                    let postData2 = {
                        "BomDetailId": bomDetailId,
                        "SubstituteStatus": substituteStatus,
                        "MtlItemId": mtlItemId2,
                        "Quantity": quantity,
                        "SortNumber": sortNumber,
                        "Precedence": precedence,
                        "EffectiveDate": effectiveDate,
                        "ExpirationDate": expirationDate,
                        "Remark": remark
                    };

                    let result = DataAccess.Add(targetUrl2, postData2, false, false);
                    if (result) {

                    } else {
                        alert(result.msg, "alert", 0);

                    }
                });
            }
        }

        function Detail@(itemName)(MtlItemId) {
            if ($(`tr[data-mo-id=${MtlItemId}]`).css("display") == "none") {
                $("tr[data-mo-id]").hide();
                $(`tr[data-mo-id=${MtlItemId}]`).show();
            } else {
                $("tr[data-mo-id]").hide();
            }
        }

        function PopBomCopyView@(itemName)(item) {

            $("#copyBomModalQuery@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });
            GetBOMList@(itemName)();
        }

        function AddCopyBomDetail@(itemName)(BomId, MtlItemId) {
            let targetUrl = "@Url.Action("AddCopyBomDetail", "Product")";
            let postData = {
                "CurrentBomId": $("#BomId").val(),
                "BomId": BomId,
                "MtlItemId": MtlItemId,
                "bomSequenceVal": bomSequenceVal@(itemName)
            };

            let result = DataAccess.Add(targetUrl, postData, false, false);

            if (result) {
                ReturnComponent@(itemName)();
                Datas@(itemName).GetBomDetail@(itemName)();
            }
        }

        $("#cboMaterialProperties@(itemName)").change(function () {
            switch ($("#cboMaterialProperties@(itemName)").val()) {
                case "1":
                    //直接材料
                    $("#chkStandardCostingType@(itemName)Y").prop("checked", true);
                    $("#chkStandardCostingType@(itemName)N").prop("checked", false);
                    break;
                case "2":
                    //間接材料
                    $("#chkStandardCostingType@(itemName)Y").prop("checked", false);
                    $("#chkStandardCostingType@(itemName)N").prop("checked", true);
                    break;
                case "3":
                    //廠商供料
                    $("#chkStandardCostingType@(itemName)Y").prop("checked", false);
                    $("#chkStandardCostingType@(itemName)N").prop("checked", true);
                    break;
                case "4":
                    //不發料
                    $("#chkStandardCostingType@(itemName)Y").prop("checked", false);
                    $("#chkStandardCostingType@(itemName)N").prop("checked", true);
                    break;
                case "5":
                    //客戶供料
                    $("#chkStandardCostingType@(itemName)Y").prop("checked", false);
                    $("#chkStandardCostingType@(itemName)N").prop("checked", true);
                    break;
                default:
            }
        });

        function Clear@(itemName)() {
            $('#txtMtlItemNo@(itemName)').val('');
            $(".help-block").css("display", "none");
        }

        function ReturnSubject@(itemName)() {
            Switch("#SubjectList@(itemName)", "#SubjectEdit@(itemName)");
            Query@(itemName)();
        }

        function ReturnComponent@(itemName)() {
            Switch("#ComponentList@(itemName)", "#ComponentEdit@(itemName)");
            ResetForm(objForm@(itemName));
        }
    </script>
)