@using Business_Manager.Helpers
@{
    string itemName = "BomChange";
    string itemNameText = "Bom變更";
    string authority = ViewBag.authority;

    ViewBag.Title = itemNameText;
}
@Html.Resource("css",
    @<style>
    </style>
                                                                                                                                                                                                        )
<input type="hidden" id="pageAuthority" value="@authority" />
<div class="row">
    <div class="col-12 title-block">
        <h1 class="pt-2 pb-3">@(itemNameText)</h1>
        <div class="unit-block">
            <div class="button-block mb-1">
                <button type="button" class="btn btn-secondary" onclick="Return@(itemName)()"><i class="fas fa-undo"></i>返回</button>
            </div>
        </div>
    </div>
</div>

<!--搜尋-->
<div class="modal fade" id="modalQuery@(itemName)">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">搜尋</h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <fieldset>
                    <div class="form-group row">
                        <label class="col-12 col-form-label">單號</label>
                        <div class="col-12">
                            <input type="text" class="form-control" id="txtBOMChangeNoQ@(itemName)" name="txtBOMChangeNoQ@(itemName)" placeholder="請輸入單號">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-12 col-form-label">拋轉狀態</label>
                        <div class="col-lg-3 col-md-4 col-6">
                            <label class="control control-solid control-solid-info control--checkbox">
                                已拋轉
                                <input type="checkbox" id="cbxTransferStatusQ@(itemName)Y" name="cbxTransferStatusQ@(itemName)" value="Y" />
                                <span class="control__indicator"></span>
                            </label>
                        </div>
                        <div class="col-lg-3 col-md-4 col-6">
                            <label class="control control-solid control-solid-info control--checkbox">
                                未拋轉
                                <input type="checkbox" id="cbxTransferStatusQ@(itemName)N" name="cbxTransferStatusQ@(itemName)" value="N" />
                                <span class="control__indicator"></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-12 col-form-label">狀態</label>
                        <div class="col-lg-4 col-md-4 col-6">
                            <label class="control control-solid control-solid-info control--checkbox">
                                未確認
                                <input type="checkbox" id="cbxConfirmStatusQ@(itemName)N" name="cbxConfirmStatusQ@(itemName)" value="N,R" checked />
                                <span class="control__indicator"></span>
                            </label>
                        </div>
                        <div class="col-lg-4 col-md-4 col-6">
                            <label class="control control-solid control-solid-info control--checkbox">
                                作廢
                                <input type="checkbox" id="cbxConfirmStatusQ@(itemName)V" name="cbxConfirmStatusQ@(itemName)" value="V" />
                                <span class="control__indicator"></span>
                            </label>
                        </div>
                        <div class="col-lg-4 col-md-4 col-6">
                            <label class="control control-solid control-solid-info control--checkbox">
                                已確認
                                <input type="checkbox" id="cbxConfirmStatusQ@(itemName)Y" name="cbxConfirmStatusQ@(itemName)" value="Y" checked />
                                <span class="control__indicator"></span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-12 col-form-label">變更日期 <input type="checkbox" id="cbxUseDate@(itemName)" checked /></label>
                        <div class="col-6">
                            <input type="text" class="form-control" id="txtStartDateQ@(itemName)" name="txtStartDateQ@(itemName)"
                                   data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"
                                   readonly />
                        </div>
                        <div class="col-6">
                            <input type="text" class="form-control" id="txtEndDateQ@(itemName)" name="txtEndDateQ@(itemName)"
                                   data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"
                                   readonly />
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="Query@(itemName)()" style="margin: auto;"><i class="fal fa-wrench"></i>套用</button>
            </div>
        </div>
    </div>
</div>

<!--列表-->
<div class="row" id="listData@(itemName)">
    <div class="col-12">
        <div class="card card-shadow mb-4">
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6 col-sm-6 col-md-6">
                        <a class="btn btn-primary" data-backdrop="static" data-keyboard="false" data-toggle="modal" data-target="#modalQuery@(itemName)" href="javascript:void(0);"><i class="fal fa-search"></i>搜尋</a>
                    </div>
                    <div class="col-6 col-sm-6 col-md-6 text-right">
                        <button type="button" class="btn btn-info" onclick="Edit@(itemName)()"><i class="fas fa-plus"></i>新增</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="mainTblData@(itemName)" style="min-height: 200px;">
                                <thead>
                                    <tr>
                                        <th class="text-center col-sticky" scope="col" style="min-width: 75px;">操作</th>
                                        <th class="text-center" scope="col" style="width: 20px;">#</th>
                                        <th class="text-center" scope="col" style="min-width: 200px;">變更單號</th>
                                        <th class="text-center" scope="col" style="min-width: 200px;">開單者</th>
                                        <th class="text-center" scope="col" style="min-width: 200px;">變更日期</th>
                                        <th class="text-center" scope="col" style="min-width:100px;">拋轉狀態</th>
                                        <th class="text-center" scope="col" style="min-width:100px;">確認狀態</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="page@(itemName)"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!--單頭-->
<!--新增/編輯-->
<div class="row" id="editData@(itemName)" style="display: none;">
    <div class="col-12">
        <div class="card card-shadow mb-4">
            <div class="card-body">
                <form class="container" autocomplete="off" id="editForm@(itemName)">
                    <fieldset>
                        <input type="hidden" id="BomChangeId" name="BomChangeId" value="-1" />
                        <div class="row">

                            <div class="col-lg-6 col-md-12">
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtBomChangePre@(itemName)">單別</label>
                                    <div class="col-12">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="txtBomChangePre@(itemName)" name="txtBomChangePre@(itemName)" placeholder="" value="4101" readonly />

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6 col-md-12">
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtBomChangeNo@(itemName)">單號<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <div class="input-group">
                                            <input type="hidden" id="txtBomChangeId@(itemName)" />
                                            <input type="text" class="form-control" id="txtBomChangeNo@(itemName)" name="txtBomChangeNo@(itemName)" placeholder="請輸入單號" readonly />
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <div class="row">
                            <div class="col-lg-6 col-md-12">

                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtChangeReason@(itemName)">變更原因</label>
                                    <div class="col-12">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="txtChangeReason@(itemName)" name="txtChangeReason@(itemName)" placeholder="請輸入變更原因" />

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-lg-6 col-md-12" style="max-width: 50%; flex-basis: 50%;">
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtChangeDate@(itemName)">變更日期<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <input type="text" class="form-control" id="txtChangeDate@(itemName)" name="txtChangeDate@(itemName)"
                                               placeholder="請輸入變更日期"
                                               data-msg-required="請輸入變更日期" data-rule-required="true"
                                               @*data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"*@
                                               readonly />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6 col-md-12" style="max-width: 50%; flex-basis: 50%;">
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtCheckedBy@(itemName)">確認者</label>
                                    <div class="col-12">
                                        <input type="text" class="form-control" id="txtCheckedBy@(itemName)" name="txtCheckedBy@(itemName)"
                                               placeholder="請輸入確認者" readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12" style="max-width: 50%; flex-basis: 50%;">
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtCheckedDate@(itemName)">確認日期</label>
                                    <div class="col-12">
                                        <input type="text" class="form-control" id="txtCheckedDate@(itemName)" name="txtCheckedDate@(itemName)"
                                               placeholder="請輸入日期"
                                               data-msg-required="請輸入日期"
                                               readonly />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6 col-md-12">
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtEmergencyCode@(itemName)">緊急碼</label>
                                    <div class="col-12">
                                        <input type="number" class="form-control" id="txtEmergencyCode@(itemName)" name="txtEmergencyCode@(itemName)" value="0" min="0" max="9"
                                               placeholder="請輸入0~9" />
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12">
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtRemark@(itemName)">備註</label>
                                    <div class="col-12">
                                        <input type="text" class="form-control" id="txtRemark@(itemName)" name="txtRemark@(itemName)"
                                               placeholder="請輸入備註"
                                               data-msg-maxlength="必須少於 255 個字元" maxlength="255" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>

            <div class="card-footer text-center text-lg-right">
                <button type="button" class="btn btn-success" id="btnSave@(itemName)" onclick="Save@(itemName)()"><i class="fas fa-save"></i>儲存</button>
                <button type="button" class="btn btn-primary" id="btnAdd@(itemName)" onclick="Add@(itemName)()"><i class="fas fa-save"></i>建立</button>
            </div>
        </div>

        <!--單身列表 advanced-block-->
        <div class="advanced-block">

            <div class="row">
                <div class="col-12 title-block">
                    <h1 class="pt-2 pb-3">變更Bom品號</h1>
                </div>
            </div>
            <div class="row" id="fieldListData@(itemName)">
                <div class="col-12">
                    <div class="card card-shadow mb-4">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6 col-sm-6 col-md-6">
                                </div>
                                <div class="col-6 col-sm-6 col-md-6 text-right">
                                    <form autocomplete="off" id="queryForm@(itemName)">
                                        <fieldset>
                                            <a class="btn btn-info" id="PopAddFieldView@(itemName)" href="javascript:PopAddFieldView@(itemName)(-1);" style=""><i class="fas fa-plus"></i>新增</a>
                                        </fieldset>
                                    </form>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="table-custom">
                                        <table class="table table-bordered table-striped table-sticky" id="fteldTblData@(itemName)">
                                            <thead>
                                                <tr>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">主件品號</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">品名</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">規格</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">屬性</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">單位</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">版次</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">標準批量</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">製令單別</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">單據名稱</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">變更原因</th>
                                                    <th class="text-center" style="min-width: 125px;" scope="col">備註</th>
                                                    <th class="text-center col-sticky" scope="col" style="min-width: 125px;">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                    <div class="pagination" id="page@(itemName)"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-center text-lg-right">
                            @*<button type="button" class="btn btn-success" onclick="Save@(itemName)()"><i class="fas fa-redo-alt"></i>拋轉</button>*@
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<!--子單身-->
<div class="modal fade" id="bomSubDetails@(itemName)">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" style="max-width: 80%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    變更元件列表
                    <span class="sub-title">主件品號: <span class="sub-text" id="desBOMsubTitle@(itemName)"></span></span>

                </h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-6 col-sm-6 col-md-6">
                        <a class="btn btn-primary" id="editBomDetail@(itemName)" href="javascript:PopAddBomSubEditView@(itemName)(-1,'editsub');"><i class="fal fa-edit"></i>修改元件</a>
                        <a class="btn btn-info" id="addBomDetail@(itemName)" href="javascript:PopAddBomSubEditView@(itemName)(-1,'addsub');"><i class="fas fa-plus"></i>新增元件</a>

                    </div>

                </div>

                <div class="row" id="bomSubDetailListData@(itemName)">
                    <div class="col-12">
                        <div class="card card-shadow mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        
                                        <input type="hidden" id="BomChangeDetailId" />
                                        <input type="hidden" id="SubDetailBomId" />
                                        <div class="table-custom">
                                            <table class="table table-bordered table-striped table-sticky" id="bomSubDetailTblData@(itemName)">
                                                <thead>
                                                    <tr>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">序號</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">元件品號</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">品名</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">規格</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">單位</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">屬性</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">組成用量</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">底數</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">損耗率(%)</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">生效日期</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">失效日期</th>
                                                        <th class="thead-customized text-center" style="min-width: 125px;" scope="col">變更原因</th>
                                                        <th class="text-center col-sticky" scope="col" style="min-width: 125px;">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                        <div class="pagination" id="SubBompage@(itemName)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                @*<button type="button" class="btn btn-primary" onclick="Query@(itemName)()" style="margin: auto;"><i class="fal fa-wrench"></i>套用</button>*@
            </div>
        </div>
    </div>
</div>


<!--新增單身跳窗-->
<div class="modal fade" id="addModalQuery@(itemName)">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    新增單身
                    @*<span class="sub-title">欄位編號 <span class="sub-text" id="desAddField@(itemName)"></span></span>*@
                </h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="bp-mode">

                    <div class="row" style="width: 100%;">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <input type="hidden" id="BomChangeDetailIdEdit" name="BomChangeDetailIdEdit" value="-1" />
                                <label class="form-label col-12" for="txtMtlItemNo@(itemName)">主件品號<span class="text-danger">*</span></label>
                                <div class="col-12">
                                    <div class="input-group">
                                        <input type="hidden" id="txtMtlItemId@(itemName)" />
                                        <input type="hidden" id="txtBomId@(itemName)" />
                                        <input type="text" class="form-control" id="txtMtlItemNo@(itemName)" name="txtMtlItemNo@(itemName)" placeholder="請輸入品號" data-rule-required="true" />
                                        <div class="input-group-append">
                                            <a class="btn btn-success" id="PopBomView@(itemName)" href="javascript:PopBomView@(itemName)();"><i class="fal fa-search"></i></a>
                                            <a class="btn btn-outline-danger pop-clear" id="clearTxt@(itemName)" href="javascript:MtlItemNoClear@(itemName)();"><i class="fas fa-eraser"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtMtlItemName@(itemName)">品名<span class="text-danger">*</span></label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtMtlItemName@(itemName)" name="txtMtlItemName@(itemName)"
                                           placeholder="請輸入品名" data-rule-required="true"
                                           readonly />
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtMtlItemSpec@(itemName)">規格</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtMtlItemSpec@(itemName)" name="txtMtlItemSpec@(itemName)"
                                           placeholder="請輸入規格"
                                           readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <input type="hidden" id="MtlItemUnitId" name="MtlItemUnitId" value="-1" />
                                <label class="form-label col-12" for="txtMtlItemUnit@(itemName)">單位</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtMtlItemUnit@(itemName)" name="txtMtlItemUnit@(itemName)"
                                           placeholder="請輸入單位"
                                           readonly />
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtMtlItemSmallUnit@(itemName)">小單位</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtMtlItemSmallUnit@(itemName)" name="txtMtlItemSmallUnit@(itemName)"
                                           placeholder="請輸入小單位"
                                           readonly />
                                </div>
                            </div>
                        </div>



                        @*<div class="col-lg-6 col-md-12">
                                <div class="form-group row">
                                    <label class="form-label col-12" for="txtChangeEdition@(itemName)">版次</label>
                                    <div class="col-12">
                                        <input type="text" class="form-control" id="txtChangeEdition@(itemName)" name="txtChangeEdition@(itemName)"
                                               placeholder="請輸入版次"
                                               />
                                    </div>
                                </div>
                            </div>*@


                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtMtlItemAttributes@(itemName)">屬性</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtMtlItemAttributes@(itemName)" name="txtMtlItemAttributes@(itemName)"
                                           placeholder="請輸入屬性"
                                           readonly />
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtStandardLot@(itemName)">標準批量</label>
                                <div class="col-12">
                                    <input type="number" class="form-control" id="txtStandardLot@(itemName)" name="txtStandardLot@(itemName)" value="1" min="1"
                                           placeholder="請輸入標準批量" readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="col-12 col-form-label" for="cboWoErpPrefixQ@(itemName)">單別</label>
                                <div class="col-12">
                                    <select class="form-control" id="cboWoErpPrefixQ@(itemName)" name="cboWoErpPrefixQ@(itemName)">
                                        <option value="">-- 請選擇單別 --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtWoErpPrefix@(itemName)">單據名稱</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtWoErpPrefix@(itemName)" name="txtWoErpPrefix@(itemName)"
                                           placeholder="單據名稱"
                                           data-msg-maxlength="必須少於 255 個字元" maxlength="255"
                                           readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtsubChangeReason@(itemName)">變更原因</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtsubChangeReason@(itemName)" name="txtsubChangeReason@(itemName)"
                                           placeholder="請輸入變更原因"
                                           data-msg-maxlength="必須少於 255 個字元" maxlength="255" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtFieldRemark@(itemName)">備註</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtFieldRemark@(itemName)" name="txtFieldRemark@(itemName)"
                                           placeholder="請輸入備註"
                                           data-msg-maxlength="必須少於 255 個字元" maxlength="255" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="EditDetail@(itemName)()" style="margin: auto;"><i class="fal fa-check"></i>儲存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!--主件列表-->
<div class="modal fade" id="copyBomModalQuery@(itemName)">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" style="max-width: 80%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">主件</h5>
                <button class="close" type="button" onclick="Close@(itemName)('copyBomModalQuery@(itemName)')">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3" id="query@(itemName)">
                    <div class="col-12">
                        <form autocomplete="off" id="queryFormBom@(itemName)">
                            <fieldset>
                                <input type="hidden" id="txtTransferStatusQ@(itemName)" value="" />
                                <div class="form-row align-items-center mb-2">
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtMtlItemQ@(itemName)" name="txtMtlItemQ@(itemName)"
                                               placeholder="請輸入品號/品名" />
                                    </div>

                                    <div class="col-auto">
                                        <button type="button" class="btn btn-primary" onclick="GetBOMList@(itemName)()"><i class="fal fa-search"></i>搜尋</button>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
                <div class="row" id="listData@(itemName)">
                    <div class="col-12">
                        <div class="card card-shadow mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="table-custom">
                                            <table class="table table-bordered table-striped table-sticky" id="BOMListtblData@(itemName)">
                                                <thead>
                                                    <tr>
                                                        <th scope="col" style="width: 20px;">#</th>
                                                        <th scope="col" style="min-width: 125px;">品號</th>
                                                        <th scope="col" style="min-width: 125px;">品名</th>
                                                        <th class="text-center col-sticky" scope="col" style="min-width: 110px;">請選擇</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                        <div class="pagination" id="Bompage@(itemName)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                @*<button type="button" class="btn btn-primary" onclick="Query@(itemName)()" style="margin: auto;"><i class="fal fa-wrench"></i>套用</button>*@
            </div>
        </div>
    </div>
</div>

<!--新增子單身跳窗-->
<div class="modal fade" id="addSubModalQuery@(itemName)">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" >
                    <span class="modal-title"><span class="sub-text" id="addSubModalTitle@(itemName)"></span></span>
                </h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span> 
                </button>
            </div>
            <div class="modal-body">
                <div class="bp-mode">

                    @*<div class="row" id="chkDeleteView@(itemName)">
            <div class="col-lg-6 col-md-12">
                <div class="form-group row">
                    <label class="form-label col-12" for="chkDeleteType@(itemName)">是否刪除該元件</label>
                    <div class="col-12">
                        <div class="row">
                            <div class="col-lg-3 col-md-4 col-6">
                                <label class="control control-solid control-solid-info control--radio col-12">
                                    是
                                    <input type="radio" id="chkDeleteType@(itemName)Y" name="chkDeleteType@(itemName)" value="Y"
                                           data-msg-required="請選擇是否刪除該元件" data-rule-required="true" />
                                    <span class="control__indicator"></span>
                                </label>
                            </div>
                            <div class="col-lg-3 col-md-4 col-6">
                                <label class="control control-solid control-solid-info control--radio col-12">
                                    否
                                    <input type="radio" id="chkDeleteType@(itemName)N" name="chkDeleteType@(itemName)" value="N"
                                           data-msg-required="請選擇是否刪除該元件" data-rule-required="true" checked />
                                    <span class="control__indicator"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>*@

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtSubMtlItemNo@(itemName)">品號<span class="text-danger">*</span></label>
                                <div class="col-12">
                                    <div class="input-group">
                                        <input type="hidden" id="txtBomChangeDetailId@(itemName)" />
                                        <input type="hidden" id="txtSubMtlItemId@(itemName)" />
                                        <input type="hidden" id="txtSubBomDetailId@(itemName)" />
                                        <input type="hidden" id="txtSubUnitId@(itemName)" />
                                        <input type="hidden" id="txtSubMtlItemNoChecked@(itemName)" />
                                        <input type="hidden" id="txtSubBomSeq@(itemName)" />
                                        <input type="hidden" id="txtBomChangeSubDetailIdEdit@(itemName)" />
                                        <input type="text" class="form-control" id="txtSubMtlItemNo@(itemName)" name="txtSubMtlItemNo@(itemName)" placeholder="請輸入品號" data-rule-required="true" />
                                        <div class="input-group-append">
                                            <a class="btn btn-success" id="PopSubDetailSelectView@(itemName)" href="javascript:PopSubDetailSelectView@(itemName)();"><i class="fal fa-search"></i></a>
                                            <a class="btn btn-outline-danger pop-clear" id="clearSubTxt@(itemName)" href="javascript:SubMtlItemNoClear@(itemName)();"><i class="fas fa-eraser"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @*<div class="col-lg-6 col-md-12" id="NewSubBom@(itemName)">
                <div class="form-group row">
                    <label class="form-label col-12" for="txtNewSubBom@(itemName)">新元件品號<span class="text-danger">* 是否修改原元件啟用<input type="checkbox" id="cbxSubBomSequence@(itemName)" /></span></label>
                    <div class="col-12">
                        <div class="input-group">
                            <input type="text" class="form-control" id="txtNewSubBom@(itemName)" name="txtNewSubBom@(itemName)" placeholder="請輸入品號" />
                            <a class="btn btn-success" id="NewSubBomPopMtlitem@(itemName)" href="javascript:PopMtlitem@(itemName)();"><i class="fal fa-search"></i></a>
                            <a class="btn btn-outline-danger pop-clear" id="NewSubBomclearSubTxt@(itemName)" href="javascript:SubMtlItemNoClear@(itemName)();"><i class="fas fa-eraser"></i></a>
                        </div>
                    </div>
                </div>
            </div>*@
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtSubMtlItemName@(itemName)">品名<span class="text-danger">*</span></label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtSubMtlItemName@(itemName)" name="txtSubMtlItemName@(itemName)"
                                           placeholder="請輸入品名" data-rule-required="true"
                                           readonly />
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtSubMtlItemSpec@(itemName)">規格</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtSubMtlItemSpec@(itemName)" name="txtSubMtlItemSpec@(itemName)"
                                           placeholder="請輸入規格"
                                           readonly />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <input type="hidden" id="SubMtlItemUnitId" name="SubMtlItemUnitId" value="-1" />
                                <label class="form-label col-12" for="txtSubMtlItemUnit@(itemName)">單位</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtSubMtlItemUnit@(itemName)" name="txtSubMtlItemUnit@(itemName)"
                                           placeholder="請輸入單位"
                                           readonly />
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtSubStandardLot@(itemName)">組成用量</label>
                                <div class="col-12">
                                    <input type="number" class="form-control" id="txtSubStandardLot@(itemName)" name="txtSubStandardLot@(itemName)" value="1" min="1" step="0.0001"
                                           placeholder="組成用量" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtSubBase@(itemName)">底數</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtSubBase@(itemName)" name="txtSubBase@(itemName)" value="1" min="1" step="0.0001"
                                           placeholder="請輸入底數" />
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtSubLossRate@(itemName)">耗損率%</label>
                                <div class="col-12">
                                    <input type="number" class="form-control" id="txtSubLossRate@(itemName)" name="txtSubLossRate@(itemName)" value="0" min="0" max="99"
                                           placeholder="耗損率%，請輸入1~99的數字" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="chkStandardCostingType@(itemName)">標準成本計算</label>
                                <div class="col-12">
                                    <div class="row">
                                        <div class="col-lg-3 col-md-4 col-6">
                                            <label class="control control-solid control-solid-info control--radio col-12">
                                                是
                                                <input type="radio" id="chkStandardCostingType@(itemName)Y" name="chkStandardCostingType@(itemName)" value="Y"
                                                       data-msg-required="請選擇是否修改標準成本計算" data-rule-required="true" />
                                                <span class="control__indicator"></span>
                                            </label>
                                        </div>
                                        <div class="col-lg-3 col-md-4 col-6">
                                            <label class="control control-solid control-solid-info control--radio col-12">
                                                否
                                                <input type="radio" id="chkStandardCostingType@(itemName)N" name="chkStandardCostingType@(itemName)" value="N"
                                                       data-msg-required="請選擇是否修改標準成本計算" data-rule-required="true" checked />
                                                <span class="control__indicator"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtMaterialProperties@(itemName)">材料性質</label>
                                <div class="col-12">
                                    <select class="form-control" id="cboMaterialProperties@(itemName)" name="cboMaterialProperties@(itemName)"></select>
                                </div>
                            </div>
                        </div>



                    </div>

                    <div class="row">
                        <div class="col-lg-6 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtComponentType@(itemName)">上料類型<span class="text-danger">*</span></label>
                                <div class="col-12">
                                    <select class="form-control" id="cboComponentType@(itemName)" name="cboComponentType@(itemName)"></select>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="row">
                        <div class="col-lg-6 col-md-12" style="max-width: 50%; flex-basis: 50%;">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtEffectiveDateDate@(itemName)">生效日期</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtEffectiveDateDate@(itemName)" name="txtEffectiveDateDate@(itemName)"
                                           placeholder="請輸入日期"
                                           data-msg-required="請輸入日期"
                                           @*data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"*@ />
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6 col-md-12" style="max-width: 50%; flex-basis: 50%;">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtExpirationDate@(itemName)">失效日期</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtExpirationDate@(itemName)" name="txtExpirationDate@(itemName)"
                                           placeholder="請輸入日期"
                                           data-msg-required="請輸入日期"
                                           @*data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"*@ />
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-lg-12 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtSubbChangeReason@(itemName)">變更原因</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtSubbChangeReason@(itemName)" name="txtSubbChangeReason@(itemName)"
                                           placeholder="請輸入變更原因"
                                           data-msg-maxlength="必須少於 255 個字元" maxlength="255" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12 col-md-12">
                            <div class="form-group row">
                                <label class="form-label col-12" for="txtSubFieldRemark@(itemName)">備註</label>
                                <div class="col-12">
                                    <input type="text" class="form-control" id="txtSubFieldRemark@(itemName)" name="txtSubFieldRemark@(itemName)"
                                           placeholder="請輸入備註"
                                           data-msg-maxlength="必須少於 255 個字元" maxlength="255" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="EditSubDetail@(itemName)()" style="margin: auto;"><i class="fal fa-check"></i>儲存子單身</button>
                    </div>
                </div>
        </div>
    </div>
</div>

<!--元件列表-->
<div class="modal fade" id="copyBomDetailModalQuery@(itemName)">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" style="max-width: 80%;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">元件</h5>
                <button class="close" type="button" onclick="Close@(itemName)('copyBomDetailModalQuery@(itemName)')">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3" id="query@(itemName)">
                    @*<div class="col-12">
                            <form autocomplete="off" id="queryFormBomDetail@(itemName)">
                                <fieldset>
                                    <input type="hidden" id="txtTransferStatusQ@(itemName)" value="" />
                                    <div class="form-row align-items-center mb-2">
                                        <div class="col-auto">
                                            <input type="text" class="form-control" id="txtMtlItemQ@(itemName)" name="txtMtlItemQ@(itemName)"
                                                   placeholder="請輸入品號/品名" />
                                        </div>

                                        <div class="col-auto">
                                            <button type="button" class="btn btn-primary" onclick="GetBOMList@(itemName)()"><i class="fal fa-search"></i>搜尋</button>
                                        </div>
                                    </div>
                                </fieldset>
                            </form>
                        </div>*@
                </div>
                <div class="row" id="listDataBomDetail@(itemName)">
                    <div class="col-12">
                        <div class="card card-shadow mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="table-custom">
                                            <table class="table table-bordered table-striped table-sticky" id="BOMDetailListtblData@(itemName)">
                                                <thead>
                                                    <tr>
                                                        <th class="col-12 text-center" style="max-width: 50px;">序號</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">品號</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">品名</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">規格</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">單位</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">單位用量</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">底數</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">損耗率</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">生效日期</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">失效日期</th>
                                                        <th class="col-12 text-center" style="min-width: 125px;">備註</th>
                                                        <th class="text-center col-sticky" scope="col" style="min-width: 110px;">請選擇</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                        <div class="pagination" id="BomDetailpage@(itemName)"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                @*<button type="button" class="btn btn-primary" onclick="Query@(itemName)()" style="margin: auto;"><i class="fal fa-wrench"></i>套用</button>*@
            </div>
        </div>
    </div>
</div>

<!--品名列表-->
<div class="modal fade" id="mtlitemModal@(itemName)">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@(itemNameText)</h5>
                <button class="close" type="button" onclick="Close@(itemName)('mtlitemModal@(itemName)')">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mb-3" id="query@(itemName)">
                    <div class="col-12">
                        <form autocomplete="off" id="queryFormMtl@(itemName)">
                            <fieldset>
                                <div class="form-row align-items-center mb-2">
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtMtlItemNoQ2@(itemName)" name="txtMtlItemNoQ2@(itemName)"
                                               placeholder="請輸入品號" />
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtMtlItemNameQ2@(itemName)" name="txtMtlItemNameQ2@(itemName)"
                                               placeholder="請輸入品名" />
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtCustomerMtlItemNoQ2@(itemName)" name="txtCustomerMtlItemNoQ2@(itemName)"
                                               placeholder="請輸入部番" />
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtMtlItemSpecQ2@(itemName)" name="txtMtlItemSpecQ2@(itemName)"
                                               placeholder="請輸入規格" />
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-primary" onclick="InitMtlitem@(itemName)()"><i class="fal fa-search"></i>搜尋</button>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
                <div class="row" id="mtlitemListData@(itemName)">
                    <div class="col-12">
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="mtlitemTblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col" style="width: 20px;">#</th>
                                        <th scope="col" style="min-width: 175px;">品號</th>
                                        <th scope="col" style="min-width: 175px;">品名</th>
                                        <th scope="col" style="min-width: 200px;">部番</th>
                                        <th scope="col" style="min-width: 150px;">規格</th>
                                        <th class="text-center col-sticky" scope="col" style="min-width: 110px;">請選擇</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="Mtlitempage@(itemName)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>


@Html.Partial("ViewMtlItem")
@Html.Resource("js",
@<script>
    let objPage@(itemName) = {
        "pageIndex": 0,
        "pageSize": 10
    };
    let objPage2@(itemName) = {
        "pageIndex": 0,
        "pageSize": 10
    };
    let objForm@(itemName) = "#editForm@(itemName)";
    let mtlItemId@(itemName) = 0;
    let cangeEdition@(itemName) = 0;
    let lastDataNo@(itemName) = "";
    let bomSequenceVal@(itemName) = -1;
    let provide@(itemName) = "N";
    let detailCount@(itemName) = 0;

    let isTransfer@(itemName) = "N";

    let subSelectType@(itemName) = "";

    let isChangeToNew@(itemName) = "N";

    let isConfirm@(itemName) = "N";


    $(document).ready(function () {
        let currentDate = new Date();


        Suites.DateDropper("#txtStartDateQ@(itemName), #txtEndDateQ@(itemName)");
        Suites.SetDateDropper("#txtEndDateQ@(itemName)", currentDate);
        currentDate.setDate(currentDate.getDate() - 30);
        Suites.SetDateDropper("#txtStartDateQ@(itemName)", currentDate);

        Query@(itemName)();

    });

    //列表
    function Query@(itemName)() {
        objPage@(itemName).pageIndex = 0;
        objPage2@(itemName).pageIndex = 0;
        InitData@(itemName)(objPage@(itemName));
        $("#modalQuery@(itemName)").modal("hide");
    }

    function InitData@(itemName)(objPage) {

        let innerHtml = '';
        let pageCount = 0;

        let targetUrl = "@Url.Action("GetBomChangeData", "Product")";
        let postData = {
            "OrderBy": "",
            "PageIndex": (objPage.pageIndex + 1),
            "PageSize": objPage.pageSize,
            "SearchKey": $("#txtBOMChangeNoQ@(itemName)").val(),
            "TransferStatus": $("input[name='cbxTransferStatusQ@(itemName)']:checked").toArray().map(item => item.value).join(","),
            "ConfirmStatus": $("input[name='cbxConfirmStatusQ@(itemName)']:checked").toArray().map(item => item.value).join(","),
            "StartDate": ($("#cbxUseDate@(itemName)").is(":checked") ? $("#txtStartDateQ@(itemName)").val() : ""),
            "EndDate": ($("#cbxUseDate@(itemName)").is(":checked") ? $("#txtEndDateQ@(itemName)").val() : "")
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {
            pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;

            if (pageCount > 0) {
                objPage = PageCaculate(pageCount, objPage);

                $.each(data.result, function (i, item) {
                    let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";


                    innerHtml += `<tr>
                                        <td class="text-center active-content">
                                            <div class="btn-group mb-4 show" style="margin-bottom: 0 !important;">
                                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" style="padding-top: 0; padding-bottom: 0;">動作</button>
                                                <div class="dropdown-menu btn-text-left-block" x-placement="bottom-start" style="overflow-y: auto; z-index: 999; max-height: 150px;">
                                                    <a class="dropdown-item btn-text-left detail-button" href="javascript:Detail@(itemName)(${item.BomChangeId});"><i class="fas fa-list"></i><span>詳情</span></a>
                                                    <a class="dropdown-item btn-text-left detail-button" href="javascript:Edit@(itemName)(${item.BomChangeId});"><i class="fas fa-edit"></i><span>編輯</span></a>
                                                     ${JudgeConfirm(`${item.ConfirmStatus}`, `${item.TransferStatus}`, `${item.BomChangeId}`)}
                                                </div>
                                            </div>
                                        </td >
                                        <td>${_row}</td>
                                        <td class="ellipsis text-center" data-toggle="tooltip" title="${item.BomChangeId}" style="max-width: 200px;">${item.BomChangePrefix + `-` + item.BomChangeNo}</td>
                                        <td class="ellipsis text-center" data-toggle="tooltip" title="${item.CreatUserNo}" style="max-width: 200px;">${item.CreatUserNo + `-` + item.CreatUserName}</td>
                                        <td class="ellipsis text-center" data-toggle="tooltip" title="${item.ChangeDate}" style="max-width: 200px;">${item.ChangeDate}</td>
                                        <td class="ellipsis text-center" data-toggle="tooltip" title="${item.BomChangeId}" style="max-width: 200px;">${item.TransferStatus == `Y` ? `已拋轉` : `未拋轉`}</td>
                                        <td class="ellipsis text-center" data-toggle="tooltip" title="${item.BomChangeId}" style="max-width: 200px;">${ConfirmSttus(item.ConfirmStatus)}</td>


                                      </tr>
                                      <tr data-mo-id="${item.BomChangeId}" style="display: none;">
                                        <td colspan="13">
                                          <table style="width: 100%; margin: auto; border: 1px solid #d7d7e1;">
                                            <thead>
                                             <tr>
                                                <th class="thead-customized text-center" scope="col">主件品號</th>
                                                <th class="thead-customized text-center" scope="col">品名</th>
                                                <th class="thead-customized text-center" scope="col">規格</th>
                                                <th class="thead-customized text-center" scope="col">屬性</th>
                                                <th class="thead-customized text-center" scope="col">單位</th>
                                                <th class="thead-customized text-center" scope="col">版次</th>
                                                <th class="thead-customized text-center" scope="col">標準批量</th>
                                                <th class="thead-customized text-center" scope="col">製令單別</th>
                                                <th class="thead-customized text-center" scope="col">單據名稱</th>
                                                <th class="thead-customized text-center" scope="col">變更原因</th>
                                                <th class="thead-customized text-center" scope="col">備註</th>
                                              </tr>
                                           </thead>
                                            <tbody>
                                                ${BomChangeDetailData@(itemName)(item.BomChangeDetail)}
                                            </tbody>
                                          </table>
                                        </td>
                                      </tr>`;
                });
            } else {
                innerHtml += `<tr>
                                    <td class="text-center" colspan="13" style="background-color: #fff3cd;">
                                      <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
            }
        } else {
            alert(data.msg, "alert", 0);
        }

        $("#mainTblData@(itemName) tbody").html(innerHtml);
        TableComponentInit();
        Pager("#page@(itemName)", pageCount, objPage, InitData@(itemName));

        function ConfirmSttus(confirmStatus) {
            var statusNo = ""
            switch (confirmStatus) {
                case "Y":
                    statusNo = "已確認";
                    break;
                case "N":
                    statusNo = "未確認";
                    break;
                case "R":
                    statusNo = "需重新確認";
                    break;
                case "V":
                    statusNo = "作廢";
                    break;
            }
            return statusNo;
        }

        function JudgeConfirm(confirmStatus, transferStatus, bomChangeId) {
            let innerHtml = '';
            if (transferStatus == "N") {
                innerHtml += `<a class="dropdown-item btn-text-left auth-import" href="javascript:TransferToERP@(itemName)(${bomChangeId});"><i class="fas fa-redo-alt"> </i><span>拋轉</span></a>
                              <a class="dropdown-item btn-text-left detail-button" href="javascript:Delete@(itemName)(${bomChangeId});"><i class="fas fa-trash-alt"></i><span>刪除</span></a>
                              `;
            }
            else {

                switch (confirmStatus) {
                    case "V": {
                        innerHtml += ``;
                        break;
                    }
                    case "N": {
                        innerHtml += `<a class="dropdown-item btn-text-left auth-confirm" href="javascript:Confirm@(itemName)('${bomChangeId}');"><i class="fas fa-check"></i><span>確認</span></a>
                                      <a class="dropdown-item btn-text-left auth-void" href="javascript:Void@(itemName)('${bomChangeId}');"><i class="fas fa-ban"></i><span>作廢</span></a>`;
                        break;
                    }
                    case "R": {
                        innerHtml += `<a class="dropdown-item btn-text-left auth-confirm" href="javascript:Confirm@(itemName)('${bomChangeId}');"><i class="fas fa-check"></i><span>確認</span></a>
                                      <a class="dropdown-item btn-text-left auth-void" href="javascript:Void@(itemName)('${bomChangeId}');"><i class="fas fa-ban"></i><span>作廢</span></a>`;
                        break;
                    }

                    case "Y": {
                        innerHtml += `
                                      <a class="dropdown-item btn-text-left auth-reconfirm" href="javascript:ReConfirm@(itemName)('${bomChangeId}');"><i class="fas fa-undo-alt"></i><span>反確認</span></a>
                                      `;
                        break;
                    }
                }
            }
            return innerHtml;
        }

    }

    function BomChangeDetailData@(itemName)(DetailData) {//

            let html = '';
        let json = DetailData;

        if (json.length > 0) {


            for (let x = 0; x < json.length; x++) {

                html += `<tr>
                            <td class="tbody-customized text-center" title="${json[x].NewMtlItemNo}">${json[x].NewMtlItemNo}</td>
                            <td class="tbody-customized text-center" title="${json[x].NewMtlItemName}">${json[x].NewMtlItemName}</td>
                            <td class="tbody-customized text-center" title="${json[x].NewMtlItemSpec}">${json[x].NewMtlItemSpec}</td>
                            <td class="tbody-customized text-center" title="${json[x].NewMtlItemAttribute}">${json[x].NewMtlItemAttribute}: ${json[x].NewMtlItemAttributeName}</td>
                            <td class="tbody-customized text-center" title="${json[x].Unit}">${json[x].Unit}</td>
                            <td class="tbody-customized text-center" title="${json[x].ChangeEdition}">${json[x].ChangeEdition}</td>
                            <td class="tbody-customized text-center" title="${json[x].StandardLot}">${json[x].StandardLot}</td>
                            <td class="tbody-customized text-center" title="${json[x].MoPrefix}">${json[x].MoPrefix}</td>
                            <td class="tbody-customized text-center" title="${json[x].MoPrefix}">${GetWipPrefix@(itemName)(json[x].MoPrefix)}</td>
                            <td class="tbody-customized text-center" title="${json[x].ChangeReason}">${json[x].ChangeReason}</td>
                            <td class="tbody-customized text-center" title="${json[x].NewRemark}">${json[x].NewRemark}</td>
                         </tr>`;
            }
        } else {
            html += `<tr>
                       <td class="text-center" colspan="13" style="background-color: #fff3cd;">
                           <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無單身資料。
                       </td>
                     </tr>`;

        }

            return html;
    }

    function Detail@(itemName)(MtlItemChangeId) {
        if ($(`tr[data-mo-id=${MtlItemChangeId}]`).css("display") == "none") {
                $("tr[data-mo-id]").hide();
            $(`tr[data-mo-id=${MtlItemChangeId}]`).show();
            } else {
                $("tr[data-mo-id]").hide();
        }
    }

    //單頭
    function Edit@(itemName)(bomChangeId) {
        $("#BomChangeId").val(bomChangeId ? bomChangeId : 0);
        Switch("#editData@(itemName), .unit-block", "#listData@(itemName)");
        let currentDate = new Date();
        @*Suites.DateDropper("#txtChangeDate@(itemName)");*@
        Suites.SetDateDropper("#txtChangeDate@(itemName)", currentDate);


        GetDetail@(itemName)(bomChangeId);
        $("#txtLastModifiedBy@(itemName)").val($.cookie("Login"));
        if (bomChangeId > 0) {

            @*$("#txtBomChangeNo@(itemName)").attr("readonly", true)*@
            $("#btnSave@(itemName)").show();
            $("#btnAdd@(itemName)").hide();
            $("#PopAddFieldView@(itemName)").show();

            if (isConfirm@(itemName) != "Y") {
                $("#btnSave@(itemName)").show();
                $("#PopAddFieldView@(itemName)").show();
                $("#editBomDetail@(itemName)").show();
                $("#addBomDetail@(itemName)").show();
            } else {
                $("#btnSave@(itemName)").hide();
                $("#PopAddFieldView@(itemName)").hide();
                $("#editBomDetail@(itemName)").hide();
                $("#addBomDetail@(itemName)").hide();
            }

        } else {
            @*GetBomChangeErpNo@(itemName)()*@
            @*$("#txtBomChangeNo@(itemName)").attr("readonly", false)*@
            $("#btnSave@(itemName)").hide();
            $("#btnAdd@(itemName)").show();
            $("#PopAddFieldView@(itemName)").hide();
        }

    }

    function Save@(itemName)() {
        if ($(objForm@(itemName)).valid()) {
            let BomChangeId = parseInt($("#BomChangeId").val());
            if (BomChangeId > 0) {
                let targetUrl = "@Url.Action("UpdateBomChange", "Product")";
                let postData = {
                    "BomChangeId": BomChangeId,
                    "EmergencyCode": $("#txtEmergencyCode@(itemName)").val(),
                    "ChangeReason": $("#txtChangeReason@(itemName)").val(),
                    "Remark": $("#txtRemark@(itemName)").val()

                };
                let data = DataAccess.Update(targetUrl, postData, false, false);
                if (data) {

                    //$("#BomChangeId").val(BomChangeId);
                    //ExpandMtlChangeDetail(mtlItemChangeId);
                    alert("單頭修改成功", "success")
                } else {
                    alert("單頭修改失敗", "alert")
                }
            } else {

            }
        }
        @*Return@(itemName)();*@
    }

    function Add@(itemName)() {
        if ($(objForm@(itemName)).valid()) {

            let BomChangeId = parseInt($("#BomChangeId").val());
            if (BomChangeId <= 0) {
                console.log("oaddddd", BomChangeId)
                let targetUrl = "@Url.Action("AddBomChange", "Product")";
                let postData = {
                    @*"BomChangeNo": $("#txtBomChangeNo@(itemName)").val(),*@
                    "BomChangePrefix": $("#txtBomChangePrefix@(itemName)").val(),
                    "EmergencyCode": $("#txtEmergencyCode@(itemName)").val(),
                    "ChangeReason": $("#txtChangeReason@(itemName)").val(),
                    "Remark": $("#txtRemark@(itemName)").val()
                };
                let data = DataAccess.EditContinued(targetUrl, postData, false);
                if (data.status == "success") {
                    let bomChangeId;
                    bomChangeId = data.msg;
                    $("#BomChangeId").val(bomChangeId);
                     @*$("#txtBomChangeNo@(itemName)").attr("readonly", true)*@
                    $("#btnSave@(itemName)").show();
                    $("#btnAdd@(itemName)").hide();
                    $("#PopAddFieldView@(itemName)").show();
                    GetDetail@(itemName)($("#BomChangeId").val());
                    //ExpandMtlChangeDetail(mtlItemChangeId);
                    Query@(itemName)();
                    alert("新增成功", "success")

                }
            } else {
                console.log("qwertyuio")
            }
        }
        @*Return@(itemName)();*@
    }

    function Delete@(itemName)(bomChangeId) {

        swal.fire({
                    titleText: "確認要刪除該筆變更單嗎?",
                    text: "此動作無法復原，請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
        }).then((pass) => {
            if (pass.isConfirmed) {
                let targetUrl = "@Url.Action("DeleteBomChange", "Product")";
                let postData = {
                    "BomChangeId": bomChangeId

                };

                let result = DataAccess.Delete(targetUrl, postData, false, false);

                if (result) {
                    lastDataNo@(itemName) = "";
                    Query@(itemName)();
                }
            }
        });
    }

    @*function GetBomChangeErpNo@(itemName)() {
        let now = new Date();
        let formatted = now.getFullYear().toString() +
            (now.getMonth() + 1).toString().padStart(2, '0') +
            now.getDate().toString().padStart(2, '0');

        let targetUrl = "@Url.Action("GetBomChangeErpNo", "Product")";
        let postData = {

        };
        let data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {
            lastDataNo@(itemName) = data.result[0]["BomChangeNo"];
            if (formatted != lastDataNo@(itemName).substring(0,8)) {
                $("#txtBomChangeNo@(itemName)").val(formatted + "001");
            } else {
                var newNoNum = parseInt(lastDataNo@(itemName));
                $("#txtBomChangeNo@(itemName)").val((newNoNum + 1).toString());
            }
        }
        else {
            alert(data.msg, "alert")
        }
    }*@

    //單身

    function MtlItemNoClear@(itemName)() {
        $("#txtMtlItemNo@(itemName),#txtMtlItemName@(itemName),#txtMtlItemSpec@(itemName),#txtMtlItemUnit@(itemName),#txtWoErpPrefix@(itemName),#cboWoErpPrefixQ@(itemName),#txtsubChangeReason@(itemName),#txtFieldRemark@(itemName),#txtMtlItemAttributes@(itemName)").val("");
        $("#txtStandardLot@(itemName)").val(1);
    }

    function PopAddFieldView@(itemName)(bomChangeDetailId) {//9
        $("#addModalQuery@(itemName)").modal({
            backdrop: "static",
            keyboard: false,
            show: true
        });
        ComboBoxs.WithText("#cboWoErpPrefixQ@(itemName)", "@Url.Action("GetErpData", "BasicInformation")", { "ColumnName": "WipErpPrefix" }, "", "NA", "", "WoErpPrefixName", "WoErpPrefix"); //製令單別
        $("#BomChangeDetailIdEdit").val(bomChangeDetailId);

        $("#txtMtlItemNo@(itemName)").attr("disabled", false)
        $("#PopBomView@(itemName)").show();
        $("#clearTxt@(itemName)").show();


        if (bomChangeDetailId > 0) {
            GetBomChangeDetailEdit@(itemName)(bomChangeDetailId)
        } else {
            MtlItemNoClear@(itemName)();
        }
    }

    function GetDetail@(itemName)(bomChangeId) {
        let html = '';
        let pageCount = 0;
        let edition = "";
        let targetUrl = "@Url.Action("GetBomChangeDetail", "Product")";
        let postData = {
            "BomChangeId": bomChangeId

        };

        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {
            detailCount@(itemName) = data.result.length;
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {
                        @*mtlItemId@(itemName) = item.MtlItemId;
                        cangeEdition@(itemName) = item.ChangeEdition;*@
                    isConfirm@(itemName)  = item.ConfirmStatus;

                    if (isConfirm@(itemName)  == "Y") {
                        $("#txtEmergencyCode@(itemName)").attr("readonly", true)
                        $("#txtChangeReason@(itemName)").attr("readonly", true)
                        $("#txtRemark@(itemName)").attr("readonly", true)

                    } else {
                        $("#txtEmergencyCode@(itemName)").attr("readonly", false)
                        $("#txtChangeReason@(itemName)").attr("readonly", false)
                        $("#txtRemark@(itemName)").attr("readonly", false)
                    }



                    $("#txtBomChangeNo@(itemName)").val(item.BomChangeNo);
                    $("#txtEmergencyCode@(itemName)").val(item.EmergencyCode);
                    $("#txtChangeReason@(itemName)").val(item.ChangeReason);
                    $("#txtRemark@(itemName)").val(item.Remark);
                    isTransfer@(itemName) = item.TransferStatus;
                    $("#txtCheckedBy@(itemName)").val(item.ConfirmUserNo != "" ? (item.ConfirmUserNo + "-" + item.ConfirmUserName) : "");
                    $("#txtCheckedDate@(itemName)").val(item.ConfirmDate);
                    let json = item.BomChangeDetail;
                    html = BomChangeSubData@(itemName)(json);
                });
                $(".advanced-block").show();

            } else {
                $(".advanced-block").hide();

            }
        } else {
            alert(data.msg, "alert", 0);
            $(".advanced-block").hide();
        }

        $("#fteldTblData@(itemName) tbody").html(html);
        TableComponentInit();


        function BomChangeSubData@(itemName)(DetailData) {

            let html = '';
            let json = DetailData;

            if (json.length > 0) {


                for (let x = 0; x < json.length; x++) {


                    html += `<tr>
                            <td class="tbody-customized text-center" title="${json[x].NewMtlItemNo}">${json[x].NewMtlItemNo}</td>
                            <td class="tbody-customized text-center" title="${json[x].NewMtlItemName}">${json[x].NewMtlItemName}</td>
                            <td class="tbody-customized text-center" title="${json[x].NewMtlItemSpec}">${json[x].NewMtlItemSpec}</td>
                            <td class="tbody-customized text-center" title="${json[x].NewMtlItemAttribute}">${json[x].NewMtlItemAttribute}: ${json[x].NewMtlItemAttributeName}</td>
                            <td class="tbody-customized text-center" title="${json[x].Unit}">${json[x].Unit}</td>
                            <td class="tbody-customized text-center" title="${json[x].ChangeEdition}">${json[x].ChangeEdition}</td>
                            <td class="tbody-customized text-center" title="${json[x].StandardLot}">${json[x].StandardLot}</td>
                            <td class="tbody-customized text-center" title="${json[x].MoPrefix}">${json[x].MoPrefix}</td>
                            <td class="tbody-customized text-center" title="${json[x].MoPrefix}">${GetWipPrefix@(itemName)(json[x].MoPrefix)}</td>
                            <td class="tbody-customized text-center" title="${json[x].ChangeReason}">${json[x].ChangeReason}</td>
                            <td class="tbody-customized text-center" title="${json[x].NewRemark}">${json[x].NewRemark}</td>
                             <td class="text-center active-content col-sticky">
                                <a class="active-link detail-button" href="javascript:GetBomSubDetail@(itemName)(${json[x].BomChangeDetailId}, ${json[x].BomId}, '${json[x].NewMtlItemNo}');"><i class="fas fa-list"></i></a>
                                ${JudgeConfirm(`${isConfirm@(itemName)}`, `${isTransfer@(itemName)}`, `${json[x].BomChangeDetailId}`)}
                            </td >
                           </tr>`;
                }
            } else {
                html += `<tr>
                       <td class="text-center" colspan="14" style="background-color: #fff3cd;">
                           <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無單身資料。
                       </td>
                     </tr>`;

            }

            return html;



            function JudgeConfirm(confirmStatus, transferStatus, bomChangeDetailId) {
                let innerHtml = '';
                if (transferStatus == "N") {
                    innerHtml += `<a class="active-link detail-button" href="javascript:PopAddFieldView@(itemName)(${bomChangeDetailId});"><i class="fas fa-edit"></i></a>
                              <a class="active-link detail-button" href="javascript:DeleteField@(itemName)(${bomChangeDetailId});"><i class="fas fa-trash-alt"></i></a>`;
                }
                else {

                    switch (confirmStatus) {
                        case "V": {
                            innerHtml += `<a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-trash-alt"></i></a>
                                      `;
                            break;
                        }
                        case "N": {
                            innerHtml += `<a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-trash-alt"></i></a>
                                      `;
                            break;
                        }
                        case "R": {
                            innerHtml += `<a class="active-link detail-button" href="javascript:PopAddFieldView@(itemName)(${bomChangeDetailId});"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button" href="javascript:DeleteField@(itemName)(${bomChangeDetailId});"><i class="fas fa-trash-alt"></i></a>`;
                            break;
                        }

                        case "Y": {
                            innerHtml += `<a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-trash-alt"></i></a>
                                      `;
                            break;
                        }
                    }
                }
                return innerHtml;
            }


        }
    
    }

    function EditDetail@(itemName)() {
        let detailId = $("#BomChangeDetailIdEdit").val();
        console.log(9982, detailId);
        if (detailId < 0 || detailId == "") {
            AddField@(itemName)();
        } else {
            UpdateDetail@(itemName)(detailId);
        }
    }

    function AddField@(itemName)() {
        if ($("#txtMtlItemNo@(itemName)").val() == "" && $("#cboWoErpPrefixQ@(itemName)").val() == "") {
            alert("品號或單別為空!", "alert", 0);
        } else {
            let targetUrl = "@Url.Action("AddBomChangeDetail", "Product")";
                let postData = {
                    "BomChangeId": $("#BomChangeId").val(),
                    "MtlItemId": $("#txtMtlItemId@(itemName)").val(),
                    "Unit": $("#MtlItemUnitId").val(),
                    "SmallUnit": $("#txtMtlItemSmallUnit@(itemName)").val(),
                    "StandardLot": $("#txtStandardLot@(itemName)").val(),
                    "MoPrefix": $("#cboWoErpPrefixQ@(itemName)").val(),
                    "ChangeReason": $("#txtsubChangeReason@(itemName)").val(),
                    "NewRemark": $("#txtFieldRemark@(itemName)").val(),
                    "SortNum": "",
                    "BomId": $("#txtBomId@(itemName)").val()

                };
            let data = DataAccess.EditContinued(targetUrl, postData, false);
            if (data.status == "success") {

                    //ExpandMtlChangeDetail(mtlItemChangeId);
                    GetDetail@(itemName)($("#BomChangeId").val());
                    alert("新增成功", "success")

                }
            $("#addModalQuery@(itemName)").modal("hide");
        }
    }

    function DeleteField@(itemName)(bomChangeDetailId) {
        swal.fire({
                    titleText: "確認要刪除嗎?",
                    text: "此動作無法復原，請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
        }).then((pass) => {
            if (pass.isConfirmed) {
                let targetUrl = "@Url.Action("DeleteBomChangeDetail", "Product")";
                let postData = {
                    "BomChangeDetailId": bomChangeDetailId
                };

                let result = DataAccess.Delete(targetUrl, postData, false, false);

                if (result) {
                    GetDetail@(itemName)($("#BomChangeId").val());
                }
            }
        });
    }

    function PopBomView@(itemName)() {

            $("#copyBomModalQuery@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });
        GetBOMList@(itemName)();
        $("#txtMtlItemNoQ2@(itemName)").val("")
        $("#txtMtlItemNameQ2@(itemName)").val("")
        $("#txtCustomerMtlItemNoQ2@(itemName)").val("")
        $("#txtMtlItemQ@(itemName)").val("")
    }

    //子單身

    function GetBomSubDetail@(itemName)(bomChangeDetailId, bomId, no) {
        $("#SubDetailBomId").val(bomId);

        $("#desBOMsubTitle@(itemName)").html(no);

        let innerHtml = '';
        console.log(2468, bomChangeDetailId);
        targetUrl = "@Url.Action("GetBomChangeSubDetail", "Product")";
        postData = {
            "BomChangeDetailId": bomChangeDetailId
        };
        data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {
            PopBomSubDetailView@(itemName)();
            $("#BomChangeDetailId").val(bomChangeDetailId);
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {

                    innerHtml += `<tr>
                        <td class="tbody-customized text-center"title="${item.BomSortNum}">${item.BomSortNum}</td>
                        <td class="tbody-customized text-center"title="${item.NewSubMtlItemNo}">${item.NewSubMtlItemNo}</td>
                        <td class="tbody-customized text-center"title="${item.NewSubMtlItemName}">${item.NewSubMtlItemName}</td>
                        <td class="tbody-customized text-center"title="${item.NewSubMtlItemSpec}">${item.NewSubMtlItemSpec}</td>
                        <td class="tbody-customized text-center"title="${item.SubUnit}">${item.SubUnit}</td>
                        <td class="tbody-customized text-center"title="${item.NewSubMtlItemAttribute}">${item.NewSubMtlItemAttribute}: ${item.NewSubMtlItemAttributeName}</td>
                        <td class="tbody-customized text-center"title="${item.CompositionQuantity}">${item.CompositionQuantity}</td>
                        <td class="tbody-customized text-center"title="${item.Base}">${item.Base}</td>
                        <td class="tbody-customized text-center"title="${item.LossRate * 100}">${item.LossRate * 100}</td>
                        <td class="tbody-customized text-center"title="${item.EffectiveDate}">${item.EffectiveDate}</td>
                        <td class="tbody-customized text-center"title="${item.ExpirationDate}">${item.ExpirationDate}</td>
                        <td class="tbody-customized text-center"title="${item.ChangeReason}">${item.ChangeReason}</td>
                         <td class="text-center active-content col-sticky">
                            ${JudgeConfirm(`${isConfirm@(itemName)}`, `${isTransfer@(itemName)}`, `${item.BomChangeDetailId}`, `${item.BomChangeSubDetailId}`)}

                        </td >
                       </tr>`;
            });
            } else {
                innerHtml += `<tr>
                   <td class="text-center" colspan="14" style="background-color: #fff3cd;">
                       <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無子單身資料。
                   </td>
                 </tr>`;
            }

        }

        $("#bomSubDetailTblData@(itemName) tbody").html(innerHtml);
        TableComponentInit();

        function JudgeConfirm(confirmStatus, transferStatus, bomChangeDetailId, bomChangeSubDetailId) {
                let innerHtml = '';
                if (transferStatus == "N") {
                    innerHtml += `<a class="active-link detail-button" href="javascript:PopAddBomSubEditView@(itemName)(${bomChangeSubDetailId},'editsub');"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button" href="javascript:DeleteSubDetail@(itemName)(${bomChangeDetailId},${bomChangeSubDetailId});"><i class="fas fa-trash-alt"></i></a>`;
                }
                else {

                    switch (confirmStatus) {
                        case "V": {
                            innerHtml += `<a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-trash-alt"></i></a>
                                      `;
                            break;
                        }
                        case "N": {
                            innerHtml += `<a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-trash-alt"></i></a>
                                      `;
                            break;
                        }
                        case "R": {
                            innerHtml += `<a class="active-link detail-button" href="javascript:PopAddBomSubEditView@(itemName)(${bomChangeSubDetailId},'editsub');"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button" href="javascript:DeleteSubDetail@(itemName)(${bomChangeDetailId},${bomChangeSubDetailId});"><i class="fas fa-trash-alt"></i></a>`;
                            break;
                        }

                        case "Y": {
                            innerHtml += `<a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-edit"></i></a>
                                      <a class="active-link detail-button active-disable" href="javascript:void(0);"><i class="fas fa-trash-alt"></i></a>
                                      `;
                            break;
                        }
                    }
                }
                return innerHtml;
            }

    }

    function GetBOMList@(itemName)() {
            @*objPage@(itemName).pageIndex = 0;*@
        let objPage = objPage@(itemName);
            let innerHtml = '';
            let pageCount = 0;
            let targetUrl = "@Url.Action("GetBOMList", "Product")";
            let postData = {
                "OrderBy": "",
                "PageIndex": (objPage.pageIndex + 1),
                "PageSize": objPage.pageSize,
                "CurrentMtlItemId": 0,
                "MtlItem": $("#txtMtlItemQ@(itemName)").val(),
                "TransferStatus": "Y"
                };
            let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;
                if (pageCount > 0) {
                    objPage = PageCaculate(pageCount, objPage);
                    //$("#txtMtlItemQ@(itemName)").val("");
                    $.each(data.result, function (i, item) {
                        let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";
                        innerHtml += `<tr>
                                        <td>${_row}</td>
                                        <td>${item.MtlItemNo}</td>
                                        <td>${item.MtlItemName}</td>
                                        <td  class="text-center col-sticky">
                                          <label class="control control-solid control-solid-info control--radio">
                                            <input type="radio" name="chkMtlItemId@(itemName)" data-mtl-item-id="${item.MtlItemId}" data-bom-id="${item.BomId}"  data-mtl-no="${item.MtlItemNo}"
                                                   data-mtl-name="${item.MtlItemName}"  data-mtl-spec="${item.MtlItemSpec}"  data-mtl-uomid="${item.UomId}"  data-mtl-uomno="${item.UomNo}" data-mtl-wipprefix="${item.WipPrefix}"
                                                   data-mtl-attribute="${item.ItemAttribute}" value="${item.MtlItemId}" />
                                            <span class="control__indicator"></span>
                                          </label>
                                        </td>
                                      </tr>`;


                    });
                }
                else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="9" style="background-color: #fff3cd;">
                                        <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }
                } else {
                    alert(data.msg, "alert", 0);
            }
            $("#BOMListtblData@(itemName) tbody").html(innerHtml);
            TableComponentInit();
            Pager("#Bompage@(itemName)", pageCount, objPage, GetBOMList@(itemName));

            $("input[type='radio']").click(function () {
                if ("[data-mtl-item-id]:checked") {
                    let mtlItemId = $(this).data("mtl-item-id");
                    let mtlItemNo = $(this).data("mtl-no");
                    let mtlItemName = $(this).data("mtl-name");
                    let mtlItemSpec = $(this).data("mtl-spec");
                    let mtemUnitId = $(this).data("mtl-uomid");
                    let mtlItemUnit = $(this).data("mtl-uomno");
                    let mtlItemAttributes = $(this).data("mtl-attribute");
                    let bomId = $(this).data("bom-id");
                    let wipPrefix = $(this).data("mtl-wipprefix");

                    if (mtlItemId) {


                        $("#txtMtlItemId@(itemName)").val(mtlItemId);
                        $("#txtMtlItemNo@(itemName)").val(mtlItemNo);
                        $("#txtMtlItemName@(itemName)").val(mtlItemName);
                        $("#txtMtlItemSpec@(itemName)").val(mtlItemSpec);
                        $("#MtlItemUnitId").val(mtemUnitId);
                        $("#txtMtlItemUnit@(itemName)").val(mtlItemUnit);
                        $("#txtMtlItemAttributes@(itemName)").val(mtlItemAttributes);
                        $("#txtBomId@(itemName)").val(bomId);
                        $("#cboWoErpPrefixQ@(itemName)").val(wipPrefix);
                        GetWipPrefix@(itemName)($("#cboWoErpPrefixQ@(itemName)").val());
                    }
                }
                    $("#copyBomModalQuery@(itemName)").modal('hide');
            });
    }

     $("#editBomDetail@(itemName)").click(function () {
        subSelectType@(itemName) = "BomDetail";
    });

    $("#addBomDetail@(itemName)").click(function () {
        subSelectType@(itemName) = "Mtlitem";
    });

    function PopSubDetailSelectView@(itemName)() {
        if (subSelectType@(itemName) == "BomDetail") {
            PopBomDetail@(itemName)();
        } else if (subSelectType@(itemName) == "Mtlitem") {
            PopMtlitem@(itemName)();
        }
    }

    function PopBomDetail@(itemName)() {
        let innerHtml = ''; 


        let targetUrl = "@Url.Action("GetBomDetail", "Product")";
        let postData = {
            "BomId": $("#SubDetailBomId").val()
        };
        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {

            $("#copyBomDetailModalQuery@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });
            @*bomSequenceVal@(itemName) = data.result.length > 0 ? (data.result.length) * 10 : 0; *@
            provide@(itemName) = "Y";
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {

                    innerHtml += `<tr>
                                        <td>${item.BomSequence}</td>
                                        <td>${item.MtlItemNo}</td>
                                        <td>${item.MtlItemName}</td>
                                        <td>${item.MtlItemSpec}</td>
                                        <td>${item.UomNo}</td>
                                        <td>${item.CompositionQuantity}</td>
                                        <td>${item.Base}</td>
                                        <td>${item.LossRate}</td>
                                        <td>${item.EffectiveDate}</td>
                                        <td>${item.ExpirationDate}</td>
                                        <td>${item.Remark}</td>
                                        <td  class="text-center col-sticky">
                                          <label class="control control-solid control-solid-info control--radio">
                                            <input type="radio" name="chkBomDetailId@(itemName)" data-mtl-item-id="${item.MtlItemId}" data-bomdetail-id="${item.BomDetailId}"  data-mtl-no="${item.MtlItemNo}" data-mtl-base="${item.Base}" data-mtl-lostrate="${item.LossRate}" data-bomsequence="${item.BomSequence}"
                                                   data-mtl-name="${item.MtlItemName}"  data-mtl-spec="${item.MtlItemSpec}"  data-mtl-uomid="${item.UomId}"  data-mtl-uomno="${item.UomNo}" data-mtl-standardlot="${item.CompositionQuantity}" data-mtl-effectivedate="${item.EffectiveDate}" data-mtl-expirationdate="${item.ExpirationDate}" data-mtl-standardcostingtype="${item.StandardCostingType}" data-mtl-materialproperties="${item.MaterialProperties}" data-mtl-componenttype="${item.ComponentType}"
                                                   value="${item.MtlItemId}" />
                                            <span class="control__indicator"></span>
                                          </label>
                                        </td>
                                  </tr>`;
                });
            } else {
                innerHtml += `<tr>
                               <td class="text-center" colspan="14" style="background-color: #fff3cd;">
                                   <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                               </td>
                             </tr>`;
            }

            $("#BOMDetailListtblData@(itemName) tbody").html(innerHtml);
            TableComponentInit();

            $("input[type='radio'][name='chkBomDetailId@(itemName)']").click(function () {
                if ("[data-mtl-item-id]:checked") {
                    let mtlItemId = $(this).data("mtl-item-id");
                    let mtlItemNo = $(this).data("mtl-no");
                    let mtlItemName = $(this).data("mtl-name");
                    let mtlItemSpec = $(this).data("mtl-spec");
                    let mtlItemUnit = $(this).data("mtl-uomno");
                    let mtlItemUnitid = $(this).data("mtl-uomid");
                    let mtlItemBase = $(this).data("mtl-base");
                    let mtlItemLostRate = $(this).data("mtl-lostrate");
                    let bomdetailId = $(this).data("bomdetail-id");
                    let standardLot = $(this).data("mtl-standardlot");
                    let effectiveDate = $(this).data("mtl-effectivedate");
                    let expirationDate = $(this).data("mtl-expirationdate");
                    let materialProperties = $(this).data("mtl-materialproperties");
                    let standardCostingType = $(this).data("mtl-standardcostingtype");
                    let componenttype = $(this).data("mtl-componenttype");

                    bomSequenceVal@(itemName) = $(this).data("bomsequence");
                    console.log(5489, componenttype, materialProperties)
                    if (mtlItemId) {
                        $("#txtSubMtlItemNo@(itemName)").val(mtlItemNo);
                        $("#txtSubBomDetailId@(itemName)").val(bomdetailId);



                        if ($("#cbxSubBomSequence@(itemName)").is(":checked")) {

                        } else {
                            $("#txtSubMtlItemId@(itemName)").val(mtlItemId);
                            $("#txtSubUnitId@(itemName)").val(mtlItemUnitid);

                            $("#txtSubMtlItemName@(itemName)").val(mtlItemName);
                            $("#txtSubMtlItemSpec@(itemName)").val(mtlItemSpec);
                            $("#txtSubMtlItemUnit@(itemName)").val(mtlItemUnit);
                            $("#txtSubStandardLot@(itemName)").val(standardLot);
                            $("#txtEffectiveDateDate@(itemName)").val(effectiveDate);
                            $("#txtExpirationDate@(itemName)").val(expirationDate);
                            $("#txtSubBase@(itemName)").val(mtlItemBase);
                            $("#txtSubLossRate@(itemName)").val(mtlItemLostRate * 100);

                            if (standardCostingType == "Y") {
                                $("#chkStandardCostingType@(itemName)Y").prop("checked", true);
                                $("#chkStandardCostingType@(itemName)N").prop("checked", false);
                            } else {
                                $("#chkStandardCostingType@(itemName)Y").prop("checked", false);
                                $("#chkStandardCostingType@(itemName)N").prop("checked", true);
                            }
                            @*ComboBoxs.Default("#cboMaterialProperties@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MaterialProperties" }, "", "NA", "", "TypeName", "TypeNo");*@
                            $("#cboMaterialProperties@(itemName)").val(materialProperties);
                            $("#cboComponentType@(itemName)").val(componenttype);



                        }
                    }
                }
                $("#copyBomDetailModalQuery@(itemName)").modal('hide');
            });

        } else {
            alert(data.msg, "alert", 0);
        }
    }

    function PopMtlitem@(itemName)() {

        @*if ($("#txtSubBomDetailId@(itemName)").val() == "-1") {
            bomSequenceVal@(itemName) += 10;
        }*@
        if ($("#cbxSubBomSequence@(itemName)").is(":checked")) {

        } else {
            bomSequenceVal@(itemName)  = (GetBomDetailCount@(itemName)() + 1) * 10;

        }

        @*if (bomSequenceVal@(itemName) <= 0) {
            bomSequenceVal@(itemName)  = (GetBomDetailCount@(itemName)() + 1) * 10;
        }*@

         @*$("#txtSubBomDetailId@(itemName)").val("-1");*@
            provide@(itemName) = "N";

            $("#mtlitemModal@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });
        InitMtlitem@(itemName)()

        $("#txtMtlItemNoQ2@(itemName)").val("")
        $("#txtMtlItemNameQ2@(itemName)").val("")
        $("#txtCustomerMtlItemNoQ2@(itemName)").val("")
        $("#txtMtlItemQ@(itemName)").val("")
    }

    function InitMtlitem@(itemName)() {

        let objPage = objPage2@(itemName)
        let innerHtml = '';
        let pageCount = 0;

        let targetUrl = "@Url.Action("GetMtlItem", "Product")"; //MtlItemSpec
        let postData = {
            "OrderBy": "",
            "PageIndex": (objPage.pageIndex + 1),
            "PageSize": objPage.pageSize,
            "MtlItemNo": $("#txtMtlItemNoQ2@(itemName)").val().toUpperCase(),
            "MtlItemName": $("#txtMtlItemNameQ2@(itemName)").val(),
            "CustomerMtlItemNo": $("#txtCustomerMtlItemNoQ2@(itemName)").val().toUpperCase(),
            "MtlItemSpec": $("#txtMtlItemSpecQ2@(itemName)").val().toUpperCase(),
            "TransferStatus": "Y"
        };
        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {
            pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;



            if (pageCount > 0) {
                objPage = PageCaculate(pageCount, objPage);

                $.each(data.result, function (i, item) {
                    let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";

                    let CustomerMtlItemRow = 0;
                    let CustomerMtlItem;
                    if (item.CustomerMtlItem) {
                        CustomerMtlItem = JSON.parse(item.CustomerMtlItem);
                        CustomerMtlItemRow = CustomerMtlItem.data.length;
                    }

                    innerHtml += `<tr>
                                    <td ${(CustomerMtlItemRow > 0 ? `rowspan="${CustomerMtlItemRow}"` : ``)}>${_row}</td>
                                    <td ${(CustomerMtlItemRow > 0 ? `rowspan="${CustomerMtlItemRow}"` : ``)} class="ellipsis" data-toggle="tooltip" title="${item.MtlItemNo}" style="max-width: 175px;">${item.MtlItemNo}</td>
                                    <td ${(CustomerMtlItemRow > 0 ? `rowspan="${CustomerMtlItemRow}"` : ``)} class="ellipsis" data-toggle="tooltip" title="${item.MtlItemName}" style="max-width: 175px;">${item.MtlItemName}</td>
                                    ${CustomerMtlItemRow > 0
                            ? `<td class="ellipsis" data-toggle="tooltip" title="${CustomerMtlItem.data[0].CustomerMtlItemNo}(${CustomerMtlItem.data[0].CustomerNo})" style="max-width: 200px;">${CustomerMtlItem.data[0].CustomerMtlItemNo}<code>(${CustomerMtlItem.data[0].CustomerNo})</code></td>`
                            : `<td ${(CustomerMtlItemRow > 1 ? `rowspan="${CustomerMtlItemRow}"` : ``)}></td>`
                        }
                                    <td ${(CustomerMtlItemRow > 0 ? `rowspan="${CustomerMtlItemRow}"` : ``)} class="ellipsis" data-toggle="tooltip" title="${item.MtlItemSpec}" style="max-width: 150px;">${item.MtlItemSpec}</td>
                                    <td ${(CustomerMtlItemRow > 0 ? `rowspan="${CustomerMtlItemRow}"` : ``)} class="text-center col-sticky">
                                      <label class="control control-solid control-solid-info control--radio">
                                        <input type="radio" name="chkMtlItemId@(itemName)" data-mtl-item-id="${item.MtlItemId}" value="${item.MtlItemId}" />
                                        <span class="control__indicator"></span>
                                      </label>
                                      <input type="hidden" name="txtMtlItemNo@(itemName)" data-mtl-item-id="${item.MtlItemId}" value="${item.MtlItemNo}" />
                                      <input type="hidden" name="txtMtlItemName@(itemName)" data-mtl-item-id="${item.MtlItemId}" value="${item.MtlItemName}" />
                                      <input type="hidden" name="txtMtlItemSpec@(itemName)" data-mtl-item-id="${item.MtlItemId}" value="${item.MtlItemSpec}" />
                                      <input type="hidden" name="txtInventoryId@(itemName)" data-mtl-item-id="${item.MtlItemId}" value="${item.InventoryId}" />
                                      <input type="hidden" name="txtUomId@(itemName)" data-mtl-item-id="${item.MtlItemId}" value="${item.InventoryUomId}" />
                                      <input type="hidden" name="txtUomNo@(itemName)" data-mtl-item-id="${item.MtlItemId}" value="${item.InventoryUomNo}" />
                                      <input type="hidden" name="txtMtlModify@(itemName)" data-mtl-item-id="${item.MtlItemId}" value="${item.MtlModify}" />
                                    </td>
                                  </tr>
                                  ${CustomerMtlItem@(itemName)(item.CustomerMtlItem)}`;
                });
            } else {
                innerHtml += `<tr>
                                <td class="text-center" colspan="11" style="background-color: #fff3cd;">
                                  <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }
        } else {
            alert(data.msg, "alert", 0);
        }

        $("#mtlitemTblData@(itemName) tbody").html(innerHtml);
        TableComponentInit();
        Pager("#Mtlitempage@(itemName)", pageCount, objPage, PopMtlitem@(itemName));

        $("input[type='radio']").click(function () {
            if ("[data-mtl-item-id]:checked") {
                let mtlItemId = $(this).data("mtl-item-id");

                if (mtlItemId) {
                    let mtlItemNo = $(`input[name="txtMtlItemNo@(itemName)"][data-mtl-item-id="${mtlItemId}"]`).val();
                    let mtlItemName = $(`input[name="txtMtlItemName@(itemName)"][data-mtl-item-id="${mtlItemId}"]`).val();
                    let mtlItemSpec = $(`input[name="txtMtlItemSpec@(itemName)"][data-mtl-item-id="${mtlItemId}"]`).val();
                    let inventoryId = $(`input[name="txtInventoryId@(itemName)"][data-mtl-item-id="${mtlItemId}"]`).val();
                    let uomId = $(`input[name="txtUomId@(itemName)"][data-mtl-item-id="${mtlItemId}"]`).val();
                    let uomNo = $(`input[name="txtUomNo@(itemName)"][data-mtl-item-id="${mtlItemId}"]`).val();
                    let mtlModify = $(`input[name="txtMtlModify@(itemName)"][data-mtl-item-id="${mtlItemId}"]`).val();

                    $("#txtSubMtlItemName@(itemName)").val(mtlItemName);
                    $("#txtSubMtlItemSpec@(itemName)").val(mtlItemSpec);
                    $("#txtSubMtlItemUnit@(itemName)").val(uomNo);
                    $("#txtSubMtlItemId@(itemName)").val(mtlItemId);
                    $("#txtSubUnitId@(itemName)").val(uomId);


                    if ($("#cbxSubBomSequence@(itemName)").is(":checked")) {
                        $("#txtNewSubBom@(itemName)").val(mtlItemNo);
                    } else {
                        $("#txtSubMtlItemNo@(itemName)").val(mtlItemNo);


                    }

                }
                $("#mtlitemModal@(itemName)").modal('hide');

            }

        });

        function CustomerMtlItem@(itemName)(source) {
            let html = '';

            if (source) {
                let json = JSON.parse(source);

                for (let x = 1; x < json.data.length; x++) {
                    html += `<tr>
                                   <td class="ellipsis" data-toggle="tooltip" title="${json.data[x].CustomerMtlItemNo}(${json.data[x].CustomerNo})" style="max-width: 200px;">${json.data[x].CustomerMtlItemNo}<code>(${json.data[x].CustomerNo})</code></td>
                                 </tr>`;
                }
            }

            return html;
        }

    }

    function EditSubDetail@(itemName)() {
        let subdetailId = $("#txtBomChangeSubDetailIdEdit@(itemName)").val();

        if ($("#txtSubbChangeReason@(itemName)").val() == "") {
            alert("請輸入變更原因!", "alert", 5000);
        } else {
            if (subdetailId < 0 || subdetailId == "") {
                AddSubDetail@(itemName)();
            } else {
                UpdateSubDetail@(itemName)(subdetailId);
            }
        }
    

        
    }

    function AddSubDetail@(itemName)() {//

        var sortNum = 0;
        var bomDetailId = 0;

        if (($("#txtNewSubBom@(itemName)").val() != "") && $("#cbxSubBomSequence@(itemName)").is(":checked")) {
            if ($("#txtSubMtlItemNo@(itemName)").val() == $("#txtSubMtlItemNoChecked@(itemName)").val()) {
                alert("原元件與所選品號相同!", "alert", 0);
            }
        } else {
            bomDetailId = -1;
        }

        if ($("#txtSubBomDetailId@(itemName)").val() > 0) {
            bomDetailId = $("#txtSubBomDetailId@(itemName)").val();
        }
        sortNum = bomSequenceVal@(itemName);


        if ($("#txtSubMtlItemNo@(itemName)").val() == "") {
            alert("品號或單別為空!", "alert", 0);
        }

        else {
            let targetUrl = "@Url.Action("AddBomChangeSubDetail", "Product")";
            let postData = {
                "BomChangeId": $("#BomChangeId").val(),
                "BomChangeDetailId": $("#BomChangeDetailId").val(),
                "BomDetailId": bomDetailId,
                "MtlItemId": $("#txtSubMtlItemId@(itemName)").val(),
                "Unit": $("#txtSubUnitId@(itemName)").val(),
                "CompositionQuantity": $("#txtSubStandardLot@(itemName)").val(),
                "Base": $("#txtSubBase@(itemName)").val(),
                "LossRate": $("#txtSubLossRate@(itemName)").val(),
                "EffectiveDate": $("#txtEffectiveDateDate@(itemName)").val(),
                "ExpirationDate": $("#txtExpirationDate@(itemName)").val(),
                "StandardCostingType": $("input[name='chkStandardCostingType@(itemName)']:checked").val(),
                "MaterialProperties": $("#cboMaterialProperties@(itemName)").val(),
                "NewRemark": $("#txtSubFieldRemark@(itemName)").val(),
                "ChangeReason": $("#txtSubbChangeReason@(itemName)").val(),
                "SortNum": sortNum,
                "Provide": provide@(itemName),
                "isChangeToNew": isChangeToNew@(itemName),
                "DeleteStatus": "N", //$("input[name='chkDeleteType@(itemName)']:checked").val()
                "BomId": $("#SubDetailBomId").val(),
                "ComponentType": $("#cboComponentType@(itemName)").val()


            };
            let data = DataAccess.EditContinued(targetUrl, postData, false);
            if (data.status == "success") {

                //ExpandMtlChangeDetail(mtlItemChangeId);

                $("#addSubModalQuery@(itemName)").modal("hide");
                GetBomSubDetail@(itemName)($("#BomChangeDetailId").val(), $("#SubDetailBomId").val())
                SubMtlItemNoClear@(itemName)()
                $("#txtSubBomDetailId@(itemName)").val("-1");
                $("#cbxSubBomSequence@(itemName)").prop("checked", false);
                isChangeToNew@(itemName) = "N";

                alert("新增成功", "success")
            } else {
                alert(data.msg, "alert", 1000)
            }
            $("#addSubModalQuery@(itemName)").modal("hide");
            $("#txtSubbChangeReason@(itemName)").val("");
        }
    }


    function PopBomSubDetailView@(itemName)() {
        $("#bomSubDetails@(itemName)").modal({
             backdrop: "static",
             keyboard: false,
             show: true
        });
    }

    function PopAddBomSubEditView@(itemName)(bomChangeSubDetailId, showType) {
        $("#addSubModalQuery@(itemName)").modal({
            backdrop: "static",
            keyboard: false,
            show: true
        });

        $("#txtSubMtlItemNo@(itemName)").attr("disabled", false)
        $("#PopSubDetailSelectView@(itemName)").show();
        $("#clearSubTxt@(itemName)").show();
        $("#txtBomChangeSubDetailIdEdit@(itemName)").val(bomChangeSubDetailId);


        //#region預設【材料型態】跟【標準成本計算】
        $("#chkStandardCostingType@(itemName)Y").prop("checked", true);//【標準成本計算】:是
        $("#chkStandardCostingType@(itemName)N").prop("checked", false);
        ComboBoxs.Default("#cboMaterialProperties@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MaterialProperties" }, "", "NA", "", "TypeName", "TypeNo");
        ComboBoxs.Default("#cboComponentType@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "BomComponentType" }, "", "NA", "", "TypeName", "TypeNo");

        $("#cboMaterialProperties@(itemName)").val("1");//直接材料
        $("#cboComponentType@(itemName)").val("N");//不上料

        //#endregion

        $("#cboMaterialProperties@(itemName)").change(function () {
            if ($(this).val() == "4") {
                $("#chkStandardCostingType@(itemName)Y").prop("checked", false);//【標準成本計算】:是
                $("#chkStandardCostingType@(itemName)N").prop("checked", true);
            } else {
                $("#chkStandardCostingType@(itemName)Y").prop("checked", true);//【標準成本計算】:是
                $("#chkStandardCostingType@(itemName)N").prop("checked", false);
            }
        
    });

        $("#chkDeleteType@(itemName)Y").prop("checked", false);
        $("#chkDeleteType@(itemName)N").prop("checked", true);

        @*MtlItemNoClear@(itemName)();
        ComboBoxs.WithText("#cboWoErpPrefixQ@(itemName)", "@Url.Action("GetErpData", "BasicInformation")", { "ColumnName": "WipErpPrefix" }, "", "NA", "", "WoErpPrefixName", "WoErpPrefix"); //製令單別*@
        Suites.DateDropper("#txtExpirationDate@(itemName)");

        if (bomChangeSubDetailId > 0) {

            GetBomChangeSubDetailEdit@(itemName)(bomChangeSubDetailId);
            $("#addSubModalTitle@(itemName)").html("新增子單身-修改元件。");
            $("#txtBomChangeSubDetailIdEdit@(itemName)").val(bomChangeSubDetailId);
        } else {
            switch (showType) {
                case "editsub":
                    $("#NewSubBom@(itemName)").show();
                    $("#chkDeleteView@(itemName)").show();
                    $("#addSubModalTitle@(itemName)").html("新增子單身-修改元件");
                    $('#txtEffectiveDateDate@(itemName)').dateDropper('destroy');
                    $("#txtEffectiveDateDate@(itemName)").attr("readonly", true)
                    break;
                case "addsub":
                    $("#NewSubBom@(itemName)").hide();
                    $("#chkDeleteView@(itemName)").hide();
                    $("#addSubModalTitle@(itemName)").html("新增子單身-新增元件");
                    $("#txtEffectiveDateDate@(itemName)").attr("readonly", false)
                    Suites.DateDropper("#txtEffectiveDateDate@(itemName)");//

                @*ComboBoxs.Default("#cboSubBomSequence@(itemName)", "@Url.Action("GetBomDetail", "Product")", { "BomId": $("#SubDetailBomId").val() }, "", "NA", "請選擇", "BomSequence", "BomDetailId");*@
                    break;
            }
            $("#txtSubBomSequence@(itemName)").attr("disabled", true)
            SubMtlItemNoClear@(itemName)();
            $("#cbxSubBomSequence@(itemName)").prop("checked", false);
            $("#txtNewSubBom@(itemName)").attr("disabled", true)
            $("#txtSubStandardLot@(itemName)").attr("disabled", false)
            $("#txtSubBase@(itemName)").attr("disabled", false)
            $("#txtSubLossRate@(itemName)").attr("disabled", false)
            $("#chkStandardCostingType@(itemName)Y").attr("disabled", false)
            $("#chkStandardCostingType@(itemName)N").attr("disabled", false)
            $("#cboMaterialProperties@(itemName)").attr("disabled", false)
            $("#cboComponentType@(itemName)").attr("disabled", false)

            $("#txtEffectiveDateDate@(itemName)").attr("disabled", false)
            $("#txtExpirationDate@(itemName)").attr("disabled", false)
            $("#txtNewSubBom@(itemName)").val("");
            $("#NewSubBomPopMtlitem@(itemName)").hide();
            $("#NewSubBomclearSubTxt@(itemName)").hide();
            isChangeToNew@(itemName) = "N";

        }



    }

    function SubMtlItemNoClear@(itemName)() {
        $("#txtSubMtlItemNo@(itemName),#txtSubMtlItemName@(itemName),#txtSubMtlItemSpec@(itemName),#txtSubMtlItemUnit@(itemName),#txtSubStandardLot@(itemName),#txtSubFieldRemark@(itemName),#txtEffectiveDateDate@(itemName),#txtExpirationDate@(itemName)").val("");
        $("#txtSubStandardLot@(itemName)").val(1);
        $("#txtNewSubBom@(itemName)").val("");
        $("#chkStandardCostingType@(itemName)Y").prop("checked", true);//【標準成本計算】:是
        $("#chkStandardCostingType@(itemName)N").prop("checked", false);
        $("#cboMaterialProperties@(itemName)").val("1");//直接材料
        $("#cboComponentType@(itemName)").val("N");//直接材料

        $("#txtSubLossRate@(itemName)").val(0);

        $("#chkDeleteType@(itemName)Y").attr('checked', false);
        $("#chkDeleteType@(itemName)N").attr('checked', true);
    }

    function DeleteSubDetail@(itemName)(bomChangeDetailId, bomChangeSubDetailId) {
        swal.fire({
                    titleText: "確認要刪除嗎?",
                    text: "此動作無法復原，請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
        }).then((pass) => {
            if (pass.isConfirmed) {
                let targetUrl = "@Url.Action("DeleteBomChangeSubDetail", "Product")";
                let postData = {
                    "BomChangeDetailId": bomChangeDetailId,
                    "BomChangeSubDetailId": bomChangeSubDetailId
                };

                let result = DataAccess.Delete(targetUrl, postData, false, false);

                if (result) {
                    GetBomSubDetail@(itemName)($("#BomChangeDetailId").val(), $("#SubDetailBomId").val())
                }
            }
        });
    }

    $("#cbxSubBomSequence@(itemName)").change(function () {
        if ($(this).is(":checked")) {
            $("#txtNewSubBom@(itemName)").attr("disabled", false);
            $("#NewSubBomPopMtlitem@(itemName)").show();
            $("#NewSubBomclearSubTxt@(itemName)").show();
            isChangeToNew@(itemName) = "Y";
            $("#txtSubbChangeReason@(itemName)").val("修改原品號");
        }
        else {
            $("#txtNewSubBom@(itemName)").attr("disabled", true)
            $("#txtNewSubBom@(itemName)").val("");
            $("#NewSubBomPopMtlitem@(itemName)").hide();
            $("#NewSubBomclearSubTxt@(itemName)").hide();
            isChangeToNew@(itemName) = "N";
            $("#txtSubbChangeReason@(itemName)").val("");
        }
        $("#chkDeleteType@(itemName)Y").prop("checked", false);
        $("#chkDeleteType@(itemName)N").prop("checked", true);
        SubMtlItemNoClear@(itemName)()
    })

    $("#chkDeleteType@(itemName)Y").change(function () {
        if ($(this).is(":checked")) {
            $("#cbxSubBomSequence@(itemName)").prop("checked", false);
            $("#txtNewSubBom@(itemName)").attr("disabled", true);
            $("#txtNewSubBom@(itemName)").val("");
            $("#NewSubBomPopMtlitem@(itemName)").hide();
            $("#NewSubBomclearSubTxt@(itemName)").hide();
            isChangeToNew@(itemName) = "N";
            $("#txtSubStandardLot@(itemName)").attr("disabled", true)
            $("#txtSubBase@(itemName)").attr("disabled", true)
            $("#txtSubLossRate@(itemName)").attr("disabled", true)
            $("#chkStandardCostingType@(itemName)Y").attr("disabled", true)
            $("#chkStandardCostingType@(itemName)N").attr("disabled", true)
            $("#cboMaterialProperties@(itemName)").attr("disabled", true)
            $("#cboComponentType@(itemName)").attr("disabled", true)

            $("#txtEffectiveDateDate@(itemName)").attr("disabled", true)
            $("#txtExpirationDate@(itemName)").attr("disabled", true)
            $("#txtSubbChangeReason@(itemName)").val("刪除品號");
        }
        else {

        }
        SubMtlItemNoClear@(itemName)()

    })

    $("#chkDeleteType@(itemName)N").change(function () {
        if ($(this).is(":checked")) {
            $("#cbxSubBomSequence@(itemName)").prop("checked", false);
            $("#txtNewSubBom@(itemName)").attr("disabled", true);
            $("#txtNewSubBom@(itemName)").val("");
            $("#NewSubBomPopMtlitem@(itemName)").hide();
            $("#NewSubBomclearSubTxt@(itemName)").hide();
            isChangeToNew@(itemName) = "N";
            $("#txtSubStandardLot@(itemName)").attr("disabled", false)
            $("#txtSubBase@(itemName)").attr("disabled", false)
            $("#txtSubLossRate@(itemName)").attr("disabled", false)
            $("#chkStandardCostingType@(itemName)Y").attr("disabled", false)
            $("#chkStandardCostingType@(itemName)N").attr("disabled", false)
            $("#cboMaterialProperties@(itemName)").attr("disabled", false)
            $("#cboComponentType@(itemName)").attr("disabled", false)

            $("#txtEffectiveDateDate@(itemName)").attr("disabled", false)
            $("#txtExpirationDate@(itemName)").attr("disabled", false)
            $("#txtSubbChangeReason@(itemName)").val("");
        }
        else {

        }
        SubMtlItemNoClear@(itemName)()

    })

    $("#txtNewSubBom@(itemName)").change(function () {
        $("#txtSubMtlItemNoChecked@(itemName)").val(GetBomDetailForCheck@(itemName)());
    })

   //其他

    $("#cboWoErpPrefixQ@(itemName)").change(function () {
        GetWipPrefix@(itemName)($("#cboWoErpPrefixQ@(itemName)").val());
    });

    function GetWipPrefix@(itemName)(prefix) {
        let wipPrefixName = "";
        let targetUrl = "@Url.Action("GetWipPreFix", "Product")";
        let postData = {
            "WipPrefix": prefix
        };
        data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {
            $.each(data.result, function (i, item) {
                $("#txtWoErpPrefix@(itemName)").val(item.WipPrefixName)
                wipPrefixName = item.WipPrefixName
            });
        }

        return wipPrefixName;
    }

    function GetBomDetailCount@(itemName)() {
        let bomDetailCount = 0;
        let targetUrl = "@Url.Action("GetBomDetail", "Product")";
        let postData = {
            "BomId": $("#SubDetailBomId").val()
        };
        data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {
            bomDetailCount = data.result.length;
        }

        @*if (((bomDetailCount + 1) * 10) == bomSequenceVal@(itemName)) {
            bomDetailCount += 1
        }*@

        return bomDetailCount;
    }

    function GetBomDetailForCheck@(itemName)() {
        let bomDetailMtlNo = "";
        let targetUrl = "@Url.Action("GetBomDetail", "Product")";
        let postData = {
            "BomDetailId": $("#txtSubBomDetailId@(itemName)").val()//ID
        };
        data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {

            $.each(data.result, function (i, item) {
                bomDetailMtlNo = item.MtlItemNo;
            });


        }

        return bomDetailMtlNo;
    }

    function UpdateDetail@(itemName)(bomChangeDetailId) {
        let targetUrl = "@Url.Action("UpdateBomChangeDetail", "Product")";
        let postData = {
            "BomChangeDetailId": $("#BomChangeDetailIdEdit").val(),
            "MoPrefix": $("#cboWoErpPrefixQ@(itemName)").val()
        };
        let data = DataAccess.Update(targetUrl, postData, false, false);
        if (data) {

            GetDetail@(itemName)($("#BomChangeId").val());


            alert("更新成功", "success")

        }
        $("#addModalQuery@(itemName)").modal("hide");
    }

    function UpdateSubDetail@(itemName)(bomChangeSubDetailId) {
        let targetUrl = "@Url.Action("UpdateBomChangeSubDetail", "Product")";
        let postData = {
            "BomChangeSubDetailId": bomChangeSubDetailId,
            "CompositionQuantity": $("#txtSubStandardLot@(itemName)").val(),
            "Base": $("#txtSubBase@(itemName)").val(),
            "LossRate": $("#txtSubLossRate@(itemName)").val(),
            "EffectiveDate": $("#txtEffectiveDateDate@(itemName)").val(),
            "ExpirationDate": $("#txtExpirationDate@(itemName)").val(),
            "StandardCostingType": $("input[name='chkStandardCostingType@(itemName)']:checked").val(),
            "MaterialProperties": $("#cboMaterialProperties@(itemName)").val(),
            "ComponentType": $("#cboComponentType@(itemName)").val(),

            "NewRemark": $("#txtSubFieldRemark@(itemName)").val(),
            "ChangeReason": $("#txtSubbChangeReason@(itemName)").val()


        };
        let data = DataAccess.Update(targetUrl, postData, false, false);
        if (data) {

            $("#addSubModalQuery@(itemName)").modal("hide");
            GetBomSubDetail@(itemName)($("#BomChangeDetailId").val(), $("#SubDetailBomId").val())
            SubMtlItemNoClear@(itemName)()
            $("#txtSubBomDetailId@(itemName)").val("-1");
            $("#txtSubMtlItemNo@(itemName)").attr("disabled", true)
            $("#PopSubDetailSelectView@(itemName)").hide();
            $("#clearSubTxt@(itemName)").hide();
            alert("新增成功", "success")
        }
        $("#txtSubbChangeReason@(itemName)").val("");
    

    }

    function GetBomChangeDetailEdit@(itemName)(bomChangeDetailId) {
        let targetUrl = "@Url.Action("GetBomChangeDetailEdit", "Product")";
        let postData = {
            "BomChangeDetailId": bomChangeDetailId
        };
        data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {

            $.each(data.result, function (i, item) {
                $("#txtMtlItemNo@(itemName)").val(item.NewMtlItemNo);
                $("#txtMtlItemName@(itemName)").val(item.NewMtlItemName);
                $("#txtMtlItemSpec@(itemName)").val(item.NewMtlItemSpec);
                $("#txtMtlItemUnit@(itemName)").val(item.Unit);
                $("#txtMtlItemAttributes@(itemName)").val(item.NewMtlItemAttribute);
                $("#cboWoErpPrefixQ@(itemName)").val(item.MoPrefix);
                GetWipPrefix@(itemName)($("#cboWoErpPrefixQ@(itemName)").val());

                $("#txtMtlItemNo@(itemName)").attr("disabled", true)
                $("#PopBomView@(itemName)").hide();
                $("#clearTxt@(itemName)").hide();

            });


        }
    }

    function GetBomChangeSubDetailEdit@(itemName)(bomChangeSubDetailId) {
        let targetUrl = "@Url.Action("GetBomChangeSubDetailEdit", "Product")";
        let postData = {
            "BomChangeSubDetailId": bomChangeSubDetailId
        };
        data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {

            $.each(data.result, function (i, item) {
                $("#txtSubMtlItemNo@(itemName)").val(item.NewSubMtlItemNo);
                $("#txtSubMtlItemName@(itemName)").val(item.NewSubMtlItemName);
                $("#txtSubMtlItemSpec@(itemName)").val(item.NewSubMtlItemSpec);
                $("#txtSubMtlItemUnit@(itemName)").val(item.SubUnit);
                $("#txtSubStandardLot@(itemName)").val(item.CompositionQuantity);
                $("#txtEffectiveDateDate@(itemName)").val(item.EffectiveDate);
                $("#txtExpirationDate@(itemName)").val(item.ExpirationDate);
                $("#txtSubBase@(itemName)").val(item.Base);
                $("#txtSubLossRate@(itemName)").val((item.LossRate) * 100);
                $("#txtSubbChangeReason@(itemName)").val(item.ChangeReason);
                $("#txtSubFieldRemark@(itemName)").val(item.NewRemark)

                if (item.StandardCosting == "Y") {
                    $("#chkStandardCostingType@(itemName)Y").prop("checked", true);
                    $("#chkStandardCostingType@(itemName)N").prop("checked", false);
                } else {
                    $("#chkStandardCostingType@(itemName)Y").prop("checked", false);
                    $("#chkStandardCostingType@(itemName)N").prop("checked", true);
                }
                            @*ComboBoxs.Default("#cboMaterialProperties@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MaterialProperties" }, "", "NA", "", "TypeName", "TypeNo");*@
                $("#cboMaterialProperties@(itemName)").val(item.BomType);
                $("#cboComponentType@(itemName)").val(item.ComponentType);

                $("#txtSubMtlItemNo@(itemName)").attr("disabled", true)
                $("#PopSubDetailSelectView@(itemName)").hide();
                $("#clearSubTxt@(itemName)").hide();

                if (item.BomDetailId > 0) {
                    $("#txtEffectiveDateDate@(itemName)").attr("readonly", true)
                    $('#txtEffectiveDateDate@(itemName)').dateDropper('destroy');
                } else {
                    $("#txtEffectiveDateDate@(itemName)").attr("readonly", false)
                    Suites.DateDropper("#txtEffectiveDateDate@(itemName)");//
                }

            });


        }
    }

    function TransferToERP@(itemName)(BomChangeId) {
        swal.fire({
            titleText: "是否要拋轉ERP?",
            text: "請確認是否要執行!",
            icon: "warning",
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            reverseButtons: true
        }).then((pass) => {
            if (pass.isConfirmed) {
                let targetUrl = "@Url.Action("UpdateBomChangeToErp", "Product")";
                let postData = {
                    "BomChangeId": BomChangeId
                };
                let data = DataAccess.EditContinued(targetUrl, postData, false);
                if (data) {
                    //ExpandMtlChangeDetail(mtlItemChangeId);
                    $("#addModalQuery@(itemName)").modal("hide");
                    alert("拋轉成功", "success")
                    Query@(itemName)();
                }
            }
        });
    }

    //確認反確認
    function Confirm@(itemName)(bomChangeId) {
        swal.fire({
            titleText: "確認Bom變更單",
            text: "目前核單者工號為'@Session["UserNo"]'，請確認正確後再進行核單確認!!",
            icon: "warning",
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                let targetUrl = "@Url.Action("UpdateBomChangeConfirm", "Product")";
                let postData = {
                    "BomChangeId": bomChangeId
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                Query@(itemName)();
            }
        });

    }

    function ReConfirm@(itemName)(bomChangeId) {
        swal.fire({
            titleText: "反確認Bom變更單",
            text: "目前反確認者工號為'@Session["UserNo"]'，請確認正確後再進行反確認!!",
            icon: "warning",
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                let targetUrl = "@Url.Action("UpdateBomChangeReConfirm", "Product")";
                let postData = {
                    "BomChangeId": bomChangeId
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    Query@(itemName)();
                }
            }
        });

    }

    function Void@(itemName)(bomChangeId) {
        swal.fire({
            titleText: "Bom變更單作廢",
            text: "目前作廢者工號為'@Session["UserNo"]'，請確認正確後再進行作廢!!",
            icon: "warning",
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                let targetUrl = "@Url.Action("UpdateBomChangeVoid", "Product")";
                let postData = {
                    "BomChangeId": bomChangeId
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    Query@(itemName)();
                }
            }
        });

    }

    function Return@(itemName)() {
        Switch("#listData@(itemName)", "#editData@(itemName), .unit-block");
        ResetForm(objForm@(itemName));
        Query@(itemName)();
        bomSequenceVal@(itemName) = 0;
        SubMtlItemNoClear@(itemName)();
        $("#cbxSubBomSequence@(itemName)").prop("checked", false);

        $("#btnSave@(itemName)").show();
        $("#PopAddFieldView@(itemName)").show();
        $("#editBomDetail@(itemName)").show();
        $("#addBomDetail@(itemName)").show();

        $("#txtEmergencyCode@(itemName)").attr("readonly", false)
        $("#txtChangeReason@(itemName)").attr("readonly", false)
        $("#txtRemark@(itemName)").attr("readonly", false)

    }

    function Close@(itemName)(modelName) {
        $("#" + modelName).modal('hide');
        $("#txtMtlItemNoQ2@(itemName)").val("")
        $("#txtMtlItemNameQ2@(itemName)").val("")
        $("#txtCustomerMtlItemNoQ2@(itemName)").val("")
        $("#txtMtlItemQ@(itemName)").val("")
        bomSequenceVal@(itemName) = 0;
    }

</script>
                        )
