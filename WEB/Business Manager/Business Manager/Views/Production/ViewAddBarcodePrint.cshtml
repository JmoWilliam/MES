@using Business_Manager.Helpers
@{
    string itemName = "ViewAddBarcodePrint";
    string itemNameText = "新增批量條碼";
}

@Html.Resource("css",
    @<style>
    </style>
        )

<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    <span class="sub-title">ERP製令:<span class="sub-text" id="desWoErpNo@(itemName)"></span></span>
                    <span class="sub-title">品號: <span class="sub-text" id="desMtlItemNo@(itemName)"></span></span>
                    <span class="sub-title">生產模式: <span class="sub-text" id="desProdMode@(itemName)"></span></span>
                    <span class="sub-title">MES預計產量: <span class="sub-text" id="desQuantity@(itemName)"></span></span>
                    <span class="sub-title">目前批量最大數量: <span class="sub-text" id="desLotQty@(itemName)"></span></span>
                </h5>
            </div>
            <div class="modal-body">
                <form class="container" autocomplete="off" id="editForm@(itemName)">
                    <fieldset>
                        <div class="form-group row">
                            <div class="col-12">
                                <a class="btn btn-info auth-add" href="javascript:AddCavity@(itemName)();"><i class="fas fa-plus"></i>新增穴號</a>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-12">
                                <label class="control control-solid control-solid-info control--checkbox">
                                    全部勾選/取消
                                    <input type="checkbox" id="cbxAllChecked@(itemName)" data-type="AllCavity" />
                                    <span class="control__indicator"></span>
                                </label>
                            </div>
                        </div>
                        <div class="cavity-group">
                            <div class="form-group row">
                                <div class="col-lg-3 col-md-3 col-3">
                                    <label class="control control-solid control-solid-info control--checkbox">
                                        穴號:1
                                        <input type="checkbox" data-type="Cavity" id="cbxCavityNo@(itemName)1" name="cbxCavityNo@(itemName)" value="1" checked="" />
                                        <span class="control__indicator"></span>
                                    </label>
                                    <input type="number" data-type="Cavity" id="txtCavityNo@(itemName)1" name="txtCavityNo@(itemName)" class="form-control" vlaue="" />
                                </div>
                                <div class="col-lg-3 col-md-3 col-3">
                                    <label class="control control-solid control-solid-info control--checkbox">
                                        穴號:2
                                        <input type="checkbox" data-type="Cavity" id="cbxCavityNo@(itemName)2" name="cbxCavityNo@(itemName)" value="2">
                                        <span class="control__indicator"></span>
                                    </label>
                                    <input type="number" data-type="Cavity" id="txtCavityNo@(itemName)2" name="txtCavityNo@(itemName)" class="form-control" vlaue="" />
                                </div>
                                <div class="col-lg-3 col-md-3 col-3">
                                    <label class="control control-solid control-solid-info control--checkbox">
                                        穴號:3
                                        <input type="checkbox" data-type="Cavity" id="cbxCavityNo@(itemName)3" name="cbxCavityNo@(itemName)" value="3">
                                        <span class="control__indicator"></span>
                                    </label>
                                    <input data-type="Cavity" id="txtCavityNo@(itemName)3" name="txtCavityNo@(itemName)" type="number" class="form-control" vlaue="" />
                                </div>
                                <div class="col-lg-3 col-md-3 col-3">
                                    <label class="control control-solid control-solid-info control--checkbox">
                                        穴號:4
                                        <input type="checkbox" data-type="Cavity" id="cbxCavityNo@(itemName)4" name="cbxCavityNo@(itemName)" value="4">
                                        <span class="control__indicator"></span>
                                    </label>
                                    <input data-type="Cavity" id="txtCavityNo@(itemName)4" name="txtCavityNo@(itemName)" type="number" class="form-control" vlaue="" />
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label for="txtBarcodeQty@(itemName)" class="col-12 col-form-label">單次批量數量</label>
                            <div class="col-12">
                                <input type="text" class="form-control" id="txtBarcodeQty@(itemName)" name="txtBarcodeQty@(itemName)" placeholder="請輸入數量" value="">
                            </div>
                        </div>

                    </fieldset>
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="Close@(itemName)()"><i class="fas fa-times"></i>關閉</button>
                <button type="button" class="btn btn-info" onclick="AutoSettingQty@(itemName)()"><i class="fas fa-calculator"></i>自動計算</button>
                <button type="button" class="btn btn-success" onclick="Save@(itemName)()"><i class="fas fa-save"></i>儲存</button>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let mosettingId@(itemName);
        let quantity@(itemName);
        let lotQty@(itemName);
        let objForm@(itemName) = "#editForm@(itemName)";
        let currentCavity = 4;
        function Pop@(itemName)(moSettingId, woErpPrefix, WoErpNo, mtlItemNo, modeNo, modeName, quantity, lotQty) {
            mosettingId@(itemName) = moSettingId;
            quantity@(itemName) = quantity;
            lotQty@(itemName) = lotQty;
            $("#txtBarcodeQty@(itemName)").val(lotQty);
            $("#desWoErpNo@(itemName)").html(woErpPrefix + "-" + WoErpNo);
            $("#desMtlItemNo@(itemName)").html(mtlItemNo);
            $("#desProdMode@(itemName)").html(modeNo + "-" + modeName);
            $("#desLotQty@(itemName)").html(lotQty);
            $("#desQuantity@(itemName)").html(quantity);
            $("#modal@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });
        }

        function AddCavity@(itemName)() {
            let innerHtml = '';
            innerHtml += `<div class="form-group row">
                            <div class="col-lg-3 col-md-3 col-3">
                                <label class="control control-solid control-solid-info control--checkbox">
                                    穴號:${currentCavity + 1}
                                    <input type="checkbox" data-type="Cavity" id="cbxCavityNo@(itemName)${currentCavity + 1}" name="cbxCavityNo@(itemName)" value="${currentCavity + 1}">
                                    <span class="control__indicator"></span>
                                </label>
                                <input data-type="Cavity" id="txtCavityNo@(itemName)${currentCavity + 1}" name="txtCavityNo@(itemName)" type="number" class="form-control" vlaue="" />
                            </div>
                            <div class="col-lg-3 col-md-3 col-3">
                                <label class="control control-solid control-solid-info control--checkbox">
                                    穴號:${currentCavity + 2}
                                    <input type="checkbox" data-type="Cavity" id="cbxCavityNo@(itemName)${currentCavity + 2}" name="cbxCavityNo@(itemName)" value="${currentCavity + 2}">
                                    <span class="control__indicator"></span>
                                </label>
                                <input data-type="Cavity" id="txtCavityNo@(itemName)${currentCavity + 2}" name="txtCavityNo@(itemName)" type="number" class="form-control" vlaue="" />
                            </div>
                            <div class="col-lg-3 col-md-3 col-3">
                                <label class="control control-solid control-solid-info control--checkbox">
                                    穴號:${currentCavity + 3}
                                    <input type="checkbox" data-type="Cavity" id="cbxCavityNo@(itemName)${currentCavity + 3}" name="cbxCavityNo@(itemName)" value="${currentCavity + 3}">
                                    <span class="control__indicator"></span>
                                </label>
                                <input data-type="Cavity" id="txtCavityNo@(itemName)${currentCavity + 3}" name="txtCavityNo@(itemName)" type="number" class="form-control" vlaue="" />
                            </div>
                            <div class="col-lg-3 col-md-3 col-3">
                                <label class="control control-solid control-solid-info control--checkbox">
                                    穴號:${currentCavity + 4}
                                    <input type="checkbox" data-type="Cavity" id="cbxCavityNo@(itemName)${currentCavity + 4}" name="cbxCavityNo@(itemName)" value="${currentCavity + 4}">
                                    <span class="control__indicator"></span>
                                </label>
                                <input data-type="Cavity" id="txtCavityNo@(itemName)${currentCavity + 4}" name="txtCavityNo@(itemName)" type="number" class="form-control" vlaue="" />
                            </div>
                          </div>`;
            $("#editForm@(itemName) .cavity-group").append(innerHtml);
            currentCavity = currentCavity + 4;
        }

        function AutoSettingQty@(itemName)() {
            if (parseInt($("#txtBarcodeQty@(itemName)").val()) > parseInt(lotQty@(itemName))) {
                alert(`單次批量數量無法大於製令設定之批量數量(${lotQty@(itemName)})!`, alert);
                return false;
            }
            $(".cavity-group input[type='number']").val("");
            let cavityNoArray = [];
            $.each($("input[type='checkbox'][data-type='Cavity']:checked"), function (i) {
                let cavityNo = $(this).val();
                cavityNoArray.push(cavityNo);
            });

            let qtyCount = parseInt(parseInt(quantity@(itemName)) / parseInt($("#txtBarcodeQty@(itemName)").val()));
            let cavityCount = cavityNoArray.length;
            if (qtyCount < cavityCount) {
                alert(`穴號最多只能設定${qtyCount}個!請重新設定。`,alert);
                return false;
            }

            let avgCavityNumber = parseInt(qtyCount / cavityCount);

            $.each(cavityNoArray, function (i, item) {
                $(`#txtCavityNo@(itemName)${item}`).val(avgCavityNumber);
            });
        }

        $("#cbxAllChecked@(itemName)").click(function () {
            if ($(this).prop("checked")) {
                $("input[type='checkbox'][data-type='Cavity']").prop("checked", true);
            }
            else {
                $("input[type='checkbox'][data-type='Cavity']").prop("checked", false);
            }
        });

        function AllChecked@(itemName)() {
            $("input[type='checkbox']").prop("checked", true);
        }

        function Close@(itemName)() {
            ResetForm(objForm@(itemName));
            $("#modal@(itemName)").modal('hide');
        }

        function Save@(itemName)() {
            if (parseInt($("#txtBarcodeQty@(itemName)").val()) > parseInt(lotQty@(itemName))) {
                alert(`單次批量數量無法大於製令設定之批量數量(${lotQty@(itemName)})!`, alert);
                return false;
            }

            let cavityNoArray = [];
            $.each($("input[type='checkbox'][data-type='Cavity']:checked"), function (i) {
                let cavityNo = $(this).val();
                cavityNoArray.push(cavityNo);
            });

            let totalQty = 0;
            $.each(cavityNoArray, function (i, item) {
                totalQty += parseInt($(`#txtCavityNo@(itemName)${item}`).val()) * parseInt($("#txtBarcodeQty@(itemName)").val());
            });

            if (totalQty > parseInt(quantity@(itemName))) {
                alert(`批次條碼總數量無法大於MES預計產量(${quantity@(itemName)})!`,alert);
                return false;
            }

            let barcodePrintJson =
            {
                barcodePrintInfo: []
            };
            $.each(cavityNoArray, function (i, item) {
                let inputData =
                {
                    "BarcodeQty": $("#txtBarcodeQty@(itemName)").val(),
                    "MoSettingId": mosettingId@(itemName),
                    "CavityNo": item,
                    "PrintCnt": 0,
                    "PrintStatus": "P"
                };
                barcodePrintJson.barcodePrintInfo.push(inputData);
            });

            let targetUrl = "@Url.Action("AddBarcodePrint", "Production")";
            let postData = {
                "BarcodePrintJson": JSON.stringify(barcodePrintJson)
            };
            var result = DataAccess.Add(targetUrl, postData, false, true);
            if (result) {
                Close@(itemName)();
                ReturnMfgBarcodePrint();
                $(".mtl-setting .flag-link").click();
            }
        }
    </script>
    )
