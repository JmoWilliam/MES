@using Business_Manager.Helpers
@{
    string itemName = "ViewRouting";
    string itemNameText = "綁定MES製令途程";
}

@Html.Resource("css",
    @<style>
        .table-sticky thead .col-sticky:nth-child(1) {
            right: 110px;
        }

        .table-sticky thead .col-sticky:nth-last-child(1) {
            right: 0;
        }

        .table-sticky tbody .col-sticky:nth-child(1) {
            right: 110px;
        }

        .table-sticky tbody .col-sticky:nth-last-child(1) {
            right: 0;
        }
    </style>
                )

<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    <span class="sub-title">生產模式: <span class="sub-text" id="desProdMode@(itemName)"></span></span>
                    <span class="sub-title">製令: <span class="sub-text" id="desWoErpNo@(itemName)"></span></span>
                    <span class="sub-title">品號: <span class="sub-text" id="desMtlItemNo@(itemName)"></span></span>
                    <span class="sub-title">品名: <span class="sub-text" id="desMtlItemName@(itemName)"></span></span>
                </h5>
            </div>
            <div class="modal-body">
                <div class="row mb-3" id="query@(itemName)">
                    <div class="col-12">
                        <form autocomplete="off" id="queryForm@(itemName)">
                            <fieldset>
                                <div class="form-row align-items-center mb-2">
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtRoutingItemIdQ@(itemName)" name="txtRoutingItemIdQ@(itemName)"
                                               placeholder="請輸入辨識碼" />
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtRoutingNameQ@(itemName)" name="txtRoutingNameQ@(itemName)"
                                               placeholder="請輸入途程名稱" />
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtEditionQ@(itemName)" name="txtEditionQ@(itemName)"
                                               placeholder="請輸入設計圖版次" />
                                    </div>
                                    <div class="col-auto">
                                        <select id="cboProdModeQ@(itemName)" name="cboProdModeQ@(itemName)" class="form-control"></select>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-primary" onclick="Query@(itemName)()"><i class="fal fa-search"></i>搜尋</button>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
                <div class="row" id="listData@(itemName)">
                    <div class="col-12">
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="tblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col" style="min-width: 75px;">#</th>
                                        <th scope="col" style="min-width: 100px;">辨識碼</th>
                                        <th scope="col" style="min-width: 250px;">途程名稱</th>
                                        <th scope="col" style="min-width: 175px;">生產模式</th>
                                        <th scope="col" style="min-width: 200px;">版次</th>
                                        <th scope="col" style="min-width: 200px;">2D研發設計圖</th>
                                        <th class="text-center" scope="col" style="min-width: 150px;">製程資訊</th>
                                        <th class="text-center col-sticky" scope="col" style="min-width: 110px; right:110px;">製程順序</th>
                                        <th class="text-center col-sticky" scope="col" style="min-width: 110px;">請選擇</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="page@(itemName)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="Close@(itemName)()"><i class="fas fa-times"></i>關閉</button>
                <button type="button" class="btn btn-success save-mode" onclick="Save@(itemName)()"><i class="fas fa-check"></i>確定</button>
            </div>
        </div>
    </div>
</div>

<!--檢視-途程站別-->
<div class="modal fade" id="modalView@(itemName)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-body"></div>
            </div>

        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let moId@(itemName);
        let mtlItemId@(itemName);
        let objPage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };
        let objForm@(itemName) = "#queryForm@(itemName)";

        function Pop@(itemName)(moId, mtlItemId, modeId, modeNo, modeName, woErpPrefix, woErpNo, mtlItemNo, mtlItemName) {
            moId@(itemName) = moId;
            mtlItemId@(itemName) = mtlItemId;
            modeId@(itemName) = modeId;
            let prodMode = modeNo + "-" + modeName;
            let woErpFullNo = woErpPrefix + "-" + woErpNo;
            $("#desProdMode@(itemName)").html(prodMode);
            $("#desWoErpNo@(itemName)").html(woErpFullNo);
            $("#desMtlItemNo@(itemName)").html(mtlItemNo);
            $("#desMtlItemName@(itemName)").html(mtlItemName);
            Query@(itemName)();

            $("#modal@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });

            if (!isMobile) {
                $("#cboProdModeQ@(itemName)").select2({
                    width: "100%"
                });
            }

            ComboBoxs.Default("#cboProdModeQ@(itemName)", "@Url.Action("GetProdMode", "MesBasicInformation")", {}, "", "NA", "", "txtProdModeWithText", "ModeId");

            $("#cboProdModeQ@(itemName)").change(function () {
                Query@(itemName)();
            });
        }

        function Query@(itemName)() {
            objPage@(itemName).pageIndex = 0;
            InitData@(itemName)(objPage@(itemName));
        }

        function InitData@(itemName)(objPage) {
            let innerHtml = '';
            let pageCount = 0;

            let targetUrl = "@Url.Action("GetRoutingItem", "Routing")";
            let postData = {
                "OrderBy": "",
                "PageIndex": (objPage.pageIndex + 1),
                "PageSize": objPage.pageSize,
                "RoutingItemConfirm": "Y",
                "MtlItemId": mtlItemId@(itemName),
                "MoId": moId@(itemName),
                "RoutingItemId": $("#txtRoutingItemIdQ@(itemName)").val(),
                "RoutingName": $("#txtRoutingNameQ@(itemName)").val(),
                "ModeId": $("#cboProdModeQ@(itemName)").val(),
                "Edition": $("#txtEditionQ@(itemName)").val(),
                "RoutingConfirm": "Y",
                "Status": "A"
            };
            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;

                if (pageCount > 0) {
                    $(".save-mode").show();
                    objPage = PageCaculate(pageCount, objPage);

                    $.each(data.result, function (i, item) {
                        let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";
                        innerHtml += `<tr>
                                        <td scope="col" style="min-width: 75px;">${_row}</td>
                                        <td scope="col" style="min-width: 100px;">${item.RoutingItemId}</td>
                                        <td scope="col" style="min-width: 250px;">${item.RoutingName}</td>
                                        <td scope="col" style="min-width: 145px;">${item.ModeNo}-${item.ModeName}</td>
                                        ${JudgeEdition(`${item.Edition}`, `${item.Version}`)}
                                        ${JudgeCad2DFileAbsolutePath(`${item.Cad2DFileAbsolutePath}`, `${item.Cad2DFile}`, `${item.Cad2DFileInfo}`)}
                                        <td class="text-center active-content" scope="col" style="min-width: 100px;">
                                          <a class="active-link auth-read" data-backdrop="static" data-keyboard="false" data-toggle="modal" data-target="#modalView@(itemName)" href="javascript:void(0);" onclick="ViewRoutingProcess@(itemName)('${item.RoutingId}','${item.RoutingName}')">
                                            <i class="far fa-eye"></i>
                                          </a>
                                        </td>
                                        <td class="text-center col-sticky" scope="col" style="min-width: 110px; right:110px;">
                                          ${JudgeSortNumber(`${item.SortNumber}`, `${item.RoutingItemId}`, `${i}`)}
                                        </td>
                                        <td class="text-center col-sticky">
                                          <label class="control control-solid control-solid-info control--checkbox">
                                            ${JudgeMoRouting(`${item.MoRoutingId}`, `${item.RoutingId}`, `${item.RoutingItemId}`)}
                                            <span class="control__indicator"></span>
                                          </label>
                                        </td>
                                      </tr>`;
                    });
                } else {
                    $(".save-mode").hide();
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="11" style="background-color: #fff3cd;">
                                      <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }

                function JudgeEdition(edition, version) {
                    let innerHtml = '';
                    if (edition != "null") {
                        innerHtml += `<td class="ellipsis" data-toggle="tooltip" title="${edition}(${version})" style="max-width: 200px;">${edition}<code>(${version})</code></td>`;
                    }
                    else {
                        innerHtml += `<td></td>`;
                    }
                    return innerHtml;
                }

                function JudgeCad2DFileAbsolutePath(cad2DFileAbsolutePath, cad2DFile, cad2DFileInfo) {
                    let innerHtml = '';
                    if (cad2DFileAbsolutePath != "null") {
                        let fileFullNameList = cad2DFileAbsolutePath.split('\\');
                        let fileFullName = fileFullNameList[fileFullNameList.length - 1];
                        innerHtml += `<td class="active-content ellipsis" data-toggle="tooltip" title="${fileFullName}" style="max-width: 250px;">
                                            <a class="active-link mr-1" href="/Drawing/GetCadFile?FilePath=${cad2DFileAbsolutePath}"><i class="fas fa-download"></i></a>
                                            ${fileFullName}
                                          </td>`;
                    }
                    else if (cad2DFile != "null") {
                        innerHtml += JudgeCad2DFile(cad2DFile, cad2DFileInfo);
                    }
                    else {
                        innerHtml += `<td></td>`;
                    }
                    return innerHtml;
                }

                function JudgeCad2DFile(cad2DFile, cad2DFileInfo) {
                    let innerHtml = '';
                    if (cad2DFile != "null") {
                        innerHtml += `<td class="active-content ellipsis" data-toggle="tooltip" title="${cad2DFileInfo}" style="max-width: 145px;">
                                    <a class="active-link mr-1" href="/Drawing/GetPdmFile?fileId=${cad2DFile}"><i class="fas fa-download"></i></a>
                                    ${cad2DFileInfo}
                                  </td>`;
                    }
                    else {
                        innerHtml += `<td></td>`;
                    }
                    return innerHtml;
                }

                function JudgeSortNumber(sortNumber, routingItemId, i) {
                    let innerHtml = '';
                    if (sortNumber != "null") {
                        innerHtml += `<input type="number" data-type="sort" data-routing-item-id="${routingItemId}" class="form-control" value="${sortNumber}"/>`;
                    }
                    else {
                        innerHtml += `<input type="number" data-type="sort" data-routing-item-id="${routingItemId}" class="form-control" value="${parseInt(i) + 1}"/>`;
                    }
                    return innerHtml;
                }

                function JudgeMoRouting(moRoutingId, routingId, routingItemId) {
                    let innerHtml = '';
                    if (moRoutingId != "null") {
                        innerHtml += `<input type="checkbox" data-type="MoRoutingY" data-routing-id="${routingId}" data-routing-item-id="${routingItemId}" value="${routingItemId}" checked disabled/>`;
                    }
                    else {
                        innerHtml += `<input type="checkbox" data-type="MoRouting" data-routing-id="${routingId}" data-routing-item-id="${routingItemId}" value="${routingItemId}" />`;
                    }
                    return innerHtml;
                }
            } else {
                alert(data.msg, "alert", 0);
            }

            $("#tblData@(itemName) tbody").html(innerHtml);
            TableComponentInit();
            Pager("#page@(itemName)", pageCount, objPage, InitData@(itemName));
        }

        function ViewRoutingProcess@(itemName)(routingId, routingName) {
            let targetUrl = "@Url.Action("GetRoutingProcess", "Routing")";
            let postData = {
                "RoutingId": routingId
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                let innerHtml = '';
                $("#modalView@(itemName) h5[class='modal-title']").html("途程名稱: " + routingName);
                if (data.result.length==0) {
                    innerHtml += `<span class="empty-data-style"><i class="fas fa-exclamation-triangle"></i> 此途程尚未設定任何製程。</span>`;
                }
                else {
                    innerHtml += `<div class="baseline baseline-border">`;
                    $.each(data.result, function (i, item) {
                        innerHtml += `${JudgeCount(`${i}`)}
                                            <div class="baseline-info">
                                                <div>
                                                    <strong> <code>${item.SortNumber}</code> </strong>
                                                    站別名稱：${item.ProcessName}
                                                </div>
                                                <span class="text-muted">途程站別類別:${item.ProcessNo}&nbsp;&nbsp;,是否必須過站:${item.NecessityStatus}</span>
                                            </div>
                                        </div>
                                      <div>`; 
                    });

                    function JudgeCount(i) {
                        let innerHtml = '';
                        if (i % 2 == 0) innerHtml += `<div class="baseline-list baseline-border baseline-info">`;
                        else innerHtml += `<div class="baseline-list baseline-border baseline-warning">`;
                        return innerHtml;
                    }
                }
                $("#modalView@(itemName) div[class='card-body']").html(innerHtml);
            } else {
                alert(data.msg, "alert", 0);
            }
        }

        function Save@(itemName)() {
            let moRoutingJson =
            {
                moRoutingInfo: []
            };
            $.each($("input[type='checkbox'][data-type='MoRouting']:checked"), function (i) {
                let routingItemId = $(this).data("routing-item-id");
                let SortNumber = $("input[type='number'][data-routing-item-id='" + routingItemId + "']").val();
                if (SortNumber == "") {
                    alert("順序不能為空!", alert);
                    return false;
                }
                let inputData =
                {
                    "MoId": moId@(itemName),
                    "RoutingItemId": $(this).data("routing-item-id"),
                    "ModeId": modeId@(itemName),
                    "SortNumber": SortNumber
                }
                moRoutingJson.moRoutingInfo.push(inputData);
            });

            if (moRoutingJson.moRoutingInfo.length <= 0) {
                alert("至少需要選擇一種途程!", alert);
                return false
            }

            let newMoRoutingInfo = Object.values(moRoutingJson.moRoutingInfo).sort((a, b) => a["SortNumber"] - b["SortNumber"]);
            moRoutingJson.moRoutingInfo = newMoRoutingInfo;

            let targetUrl = "@Url.Action("AddMoRouting", "Production")";
            let postData = {
                "MoRoutingData": JSON.stringify(moRoutingJson)
            };

            let result = DataAccess.Update(targetUrl, postData, false, true);
            if (result) {
                //製令用料設定製程 動態更新
                ComboBoxs.Default("#cboMoProcessMfgMtlSetting", "@Url.Action("GetMoProcess", "Production")", { "MoId": moId@(itemName) }, "", "NA", "", "ProcessAlias", "MoProcessId");
                ComboBoxs.Default("#cboMoProcessIdQMfgMtlSetting", "@Url.Action("GetMoProcess", "Production")", { "MoId": moId@(itemName) }, "", "NA", "", "ProcessAlias", "MoProcessId");
                Close@(itemName)();
                ReturnMfgOrderSetting();
            }
            else {
                $(this).prop("checked", false);
            }
        }

        function Close@(itemName)() {
            ResetForm(objForm@(itemName));
            $("#modal@(itemName)").modal('hide');
            ReturnMfgRoutingSetting();
        }
    </script>
    )