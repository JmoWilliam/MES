@using Business_Manager.Helpers
@{
    string itemName = "ManufacturingUnitExecutionFlowchart";
    string itemNameText = "中揚光電 - 製造單位生產執行流程圖";
    string authority = ViewBag.authority;
    ViewBag.Title = itemNameText;
}

@Html.Resource("css",
    @<style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* 淺灰色背景 */
        }
        /* 自定義 Mermaid 流程圖的樣式，以符合整體視覺效果 */
        .mermaid-container {
            background-color: #ffffff; /* 白色背景 */
            padding: 2.5rem; /* 增加內邊距 */
            border-radius: 0.75rem; /* 圓角 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* 輕微陰影 */
            overflow-x: auto; /* 當流程圖過寬時啟用水平滾動 */
        }
    </style>
)



<div class="row">
    <div class="container">
        <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <!-- 標題 -->
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-900 mb-6 lg:mb-8">
                製造單位生產執行流程圖
            </h1>

            <!-- 流程圖說明 -->
            <p class="text-base sm:text-lg text-gray-700 text-center mb-8 lg:mb-10 leading-relaxed">
                此流程圖概述了從接收生產需求到最終產品出貨的核心製造環節。
                本圖旨在提供一個高層次的流程概覽，以協助您與生管/製造單位進行現有流程圖、
                程序文件與Excel內容的比對工作。
            </p>

            <!-- Mermaid 流程圖容器 -->
            <div class="mermaid-container">
                <div class="mermaid">
                    graph TD
                    A[收到生產需求] --> B(排程審核與確認)
                    B --> C{物料備齊?}
                    C -->|是| D[領料與備料]
                    C -->|否| E[發出採購需求]
                    E --> F[等待物料到貨]
                    F --> B

                    D --> G[製造加工/組裝]
                    G --> H{首件/製程檢驗 OK?}
                    H -->|是| I[批量生產]
                    H -->|否| J[製程異常處理/調整]
                    J --> G

                    I --> K{最終品質檢驗 OK?}
                    K -->|是| L[成品入庫]
                    K -->|否| M[不合格品處理/重工]
                    M --> L

                    L --> N[包裝與標示]
                    N --> O[準備出貨]
                    O --> P[產品出貨]

                    subgraph 異常處理流程
                    J
                    M
                    E
                    end

                    style A fill:#f8fafc,stroke:#a7b1c2,stroke-width:2px
                    style P fill:#f8fafc,stroke:#a7b1c2,stroke-width:2px
                    style C fill:#fffbeb,stroke:#d97706,stroke-width:1.5px
                    style H fill:#fffbeb,stroke:#d97706,stroke-width:1.5px
                    style K fill:#fffbeb,stroke:#d97706,stroke-width:1.5px
                    style E fill:#fee2e2,stroke:#ef4444,stroke-width:1.5px
                    style J fill:#fee2e2,stroke:#ef4444,stroke-width:1.5px
                    style M fill:#fee2e2,stroke:#ef4444,stroke-width:1.5px
                </div>
            </div>

            <!-- 流程節點說明區塊 -->
            <div class="mt-10 p-4 sm:p-6 bg-blue-50 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 border-blue-200">
                    流程節點說明
                </h2>
                <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    <li><strong>收到生產需求 (A)</strong>：業務單位提交的客戶訂單或內部生產計畫。</li>
                    <li><strong>排程審核與確認 (B)</strong>：生管單位根據產能、交期、物料情況進行排程。</li>
                    <li><strong>物料備齊? (C)</strong>：判斷生產所需原物料是否已齊備。</li>
                    <li><strong>領料與備料 (D)</strong>：倉庫根據生產工單領取並準備物料。</li>
                    <li><strong>發出採購需求 (E)</strong>：若物料不足，向採購部門發出補料請求。</li>
                    <li><strong>等待物料到貨 (F)</strong>：等待採購的物料運送到廠。</li>
                    <li><strong>製造加工/組裝 (G)</strong>：實際的生產線作業，包括加工、組裝、測試等。</li>
                    <li><strong>首件/製程檢驗 OK? (H)</strong>：生產過程中的品質檢查，確保符合規範。</li>
                    <li><strong>批量生產 (I)</strong>：品質確認後，進行大規模生產。</li>
                    <li><strong>製程異常處理/調整 (J)</strong>：當製程檢驗不合格時，進行問題分析與調整。</li>
                    <li><strong>最終品質檢驗 OK? (K)</strong>：產品完成後的最終全面品質檢查。</li>
                    <li><strong>成品入庫 (L)</strong>：檢驗合格的成品進入倉庫。</li>
                    <li><strong>不合格品處理/重工 (M)</strong>：最終檢驗不合格品的報廢、重工或特採處理。</li>
                    <li><strong>包裝與標示 (N)</strong>：成品進行包裝、貼標籤、打棧板等。</li>
                    <li><strong>準備出貨 (O)</strong>：根據出貨單準備已包裝的成品。</li>
                    <li><strong>產品出貨 (P)</strong>：將成品交付給物流，完成出貨。</li>
                </ul>
            </div>

            <!-- 未來改進方向或差異點區塊 (供您填寫) -->
            <div class="mt-10 p-4 sm:p-6 bg-yellow-50 rounded-lg shadow-sm">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 border-yellow-200">
                    比對結果與未來改進方向
                </h2>
                <p class="text-gray-700 leading-relaxed mb-4">
                    在您與生管/製造單位完成Excel內容、現有流程圖及程序文件的比對後，
                    請將您發現的任何差異點、不一致之處或建議的改進措施填寫在此處。
                    例如：
                </p>
                <ul class="list-disc pl-5 space-y-2 text-gray-700">
                    <li><strong>範例差異點 1：</strong> 流程圖中「物料備齊?」節點後直接進入領料，但程序文件規定需先由生管發出「領料單」。</li>
                    <li><strong>範例差異點 2：</strong> Excel中記錄了「生產批號」，但在流程圖中沒有明確的產生或使用此批號的步驟。</li>
                    <li><strong>範例建議 1：</strong> 建議在「排程審核與確認」前增加一個「產能負荷評估」步驟，以更精確地規劃。</li>
                    <li><strong>範例缺失 1：</strong> 程序文件未詳細說明「不合格品處理」中「重工」的具體SOP。</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        
        // 等待頁面載入完成
        window.addEventListener('load', function () {
            src = "https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js"
            // 再次檢查並等待 mermaid 載入
            let checkMermaid = setInterval(function () {
                if (typeof mermaid !== 'undefined') {
                    clearInterval(checkMermaid);
                    console.log('Mermaid.js 載入成功');

                    // 初始化 Mermaid
                    mermaid.initialize({
                        startOnLoad: false, // 改為 false，手動渲染
                        theme: 'base',
                        themeVariables: {
                            'primaryColor': '#eff6ff',
                            'primaryBorderColor': '#2563eb',
                            'lineColor': '#3b82f6',
                            'textColor': '#1f2937',
                            'primaryTextColor': '#1f2937',
                            'secondaryColor': '#ffffff',
                            'tertiaryColor': '#fffbeb',
                            'tertiaryBorderColor': '#d97706',
                            'nodeBorder': '#2563eb',
                            'nodeBackground': '#eff6ff',
                            'clusterBkg': '#f0f9ff',
                            'clusterBorder': '#bfdbfe'
                        }
                    });

                    // 手動渲染流程圖
                    const element = document.querySelector('.mermaid');
                    if (element) {
                        mermaid.run({
                            nodes: [element]
                        });
                    }
                }
            }, 100);

            // 10秒後停止檢查，避免無限等待
            setTimeout(function () {
                clearInterval(checkMermaid);
                if (typeof mermaid === 'undefined') {
                    console.error('Mermaid.js 載入超時');
                    // 顯示錯誤訊息給用戶
                    const mermaidContainer = document.querySelector('.mermaid');
                    if (mermaidContainer) {
                        mermaidContainer.innerHTML = `
                            <div class="text-center p-8 bg-red-50 border border-red-200 rounded-lg">
                                <p class="text-red-600 font-medium">流程圖載入失敗</p>
                                <p class="text-red-500 text-sm mt-2">請重新整理頁面或檢查網路連線</p>
                            </div>
                        `;
                    }
                }
            }, 10000);
        });
    </script>
        )
