@using Business_Manager.Helpers
@{
    string itemName = "PasswordSetting";
    string itemNameText = "密碼參數設定";
    string authority = ViewBag.authority;

    ViewBag.Title = itemNameText;
}

@Html.Resource("css",
    @<style>
    </style>
)

<input type="hidden" id="pageAuthority" value="@authority" />

<div class="row">
    <div class="col-12 title-block">
        <h1 class="pt-2 pb-3">@(itemNameText)</h1>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card card-shadow mb-4">
            <div class="card-body">
                <form class="container custom-form-container" autocomplete="off" id="editForm@(itemName)">
                    <fieldset>
                        <div class="form-group row">
                            <label class="col-12 col-md-3 col-lg-3 col-form-label" for="txtPasswordExpiration@(itemName)">密碼過期時間 <span class="text-danger">*</span></label>
                            <div class="col-12 col-md-9 col-lg-9">
                                <div class="input-group">
                                    <input class="form-control" type="number" id="txtPasswordExpiration@(itemName)" name="txtPasswordExpiration@(itemName)" placeholder="請輸入密碼過期時間"
                                           data-msg-required="請輸入密碼過期時間" data-rule-required="true"
                                           step="1" min="1" />
                                    <div class="input-group-append">
                                        <select class="form-control" id="cboPasswordExpirationUnit@(itemName)" name="cboPasswordExpirationUnit@(itemName)">
                                            <option value="minute">分</option>
                                            <option value="hour">時</option>
                                            <option value="day">天</option>
                                            <option value="week">週</option>
                                            <option value="month">月</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-12 col-md-3 col-lg-3 col-form-label" for="txtPasswordFormat@(itemName)">密碼格式 <span class="text-danger">*</span></label>
                            <div class="col-12 col-md-9 col-lg-9">
                                <input class="form-control" type="text" id="txtPasswordFormat@(itemName)" name="txtPasswordFormat@(itemName)" placeholder="請輸入密碼格式"
                                       data-msg-required="請輸入密碼格式" data-rule-required="true" />
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-12 col-md-3 col-lg-3 col-form-label" for="txtPasswordWrongCount@(itemName)">密碼允許錯誤次數 <span class="text-danger">*</span></label>
                            <div class="col-12 col-md-9 col-lg-9">
                                <div class="input-group">
                                    <input class="form-control" type="text" id="txtPasswordWrongCount@(itemName)" name="txtPasswordWrongCount@(itemName)" placeholder="請輸入密碼允許錯誤次數"
                                           data-msg-required="請輸入密碼允許錯誤次數" data-rule-required="true" />
                                    <div class="input-group-addon">
                                        次
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="card-footer text-center text-lg-right">
                <button type="button" class="btn btn-success" onclick="Save@(itemName)()"><i class="fas fa-save"></i>儲存</button>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let objForm@(itemName) = "#editForm@(itemName)";

        $(document).ready(function () {
            InitData@(itemName)();
        });

        function InitData@(itemName)() {
            let targetUrl = "@Url.Action("GetPasswordSetting", "SystemSetting")";
            let postData = {};

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                $.each(data.result, function (i, item) {
                    let minute = parseInt(item.PasswordExpiration);
                    let hour = minute / 60;
                    let day = hour / 24;
                    let week = day / 7;
                    let month = day / 30;

                    $("#txtPasswordExpiration@(itemName)").val(month > 0 ? month : (week > 0 ? week : (day > 0 ? day : (hour > 0 ? hour : minute))));
                    $("#cboPasswordExpirationUnit@(itemName)").val(month > 0 ? "month" : (week > 0 ? "week" : (day > 0 ? "day" : (hour > 0 ? "hour" : "minute"))));

                    $("#txtPasswordFormat@(itemName)").val(item.PasswordFormat);
                    $("#txtPasswordWrongCount@(itemName)").val(item.PasswordWrongCount);
                });
            } else {
                alert(data.msg, "alert", 0);
            }
        }

        function Save@(itemName)() {
            if ($(objForm@(itemName)).valid()) {
                let minute = 0;
                switch ($("#cboPasswordExpirationUnit@(itemName)").val()) {
                    case "minute":
                        minute = parseInt($("#txtPasswordExpiration@(itemName)").val());
                        break;
                    case "hour":
                        minute = parseInt($("#txtPasswordExpiration@(itemName)").val()) * 60;
                        break;
                    case "day":
                        minute = parseInt($("#txtPasswordExpiration@(itemName)").val()) * 24 * 60;
                        break;
                    case "week":
                        minute = parseInt($("#txtPasswordExpiration@(itemName)").val()) * 7 * 24 * 60;
                        break;
                    case "month":
                        minute = parseInt($("#txtPasswordExpiration@(itemName)").val()) * 30 * 24 * 60;
                        break;
                }

                let targetUrl = "@Url.Action("UpdatePasswordSetting", "SystemSetting")";
                let postData = {
                    "PasswordExpiration": minute,
                    "PasswordFormat": $("#txtPasswordFormat@(itemName)").val(),
                    "PasswordWrongCount": $("#txtPasswordWrongCount@(itemName)").val()
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    Return@(itemName)();
                }
            }
        }
    </script>
)