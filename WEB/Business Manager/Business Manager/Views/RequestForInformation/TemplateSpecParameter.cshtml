@using Business_Manager.Helpers
@{
    string itemName = "TemplateSpecParameter";
    string itemNameText = "RFI 樣板資料";
    string authority = ViewBag.authority;
    ViewBag.Title = itemNameText;
}

@Html.Resource("css",
    @<style>
        .toggle-on {
            top: 1px;
        }

        .sort-number {
            font-size: 18px;
            font-weight: 600;
            color: #777;
        }

        .sort-handle, .btn-add {
            cursor: pointer;
        }

        .sort-detail {
            cursor: pointer;
            font-size: large;
            color: #aaa;
            min-width:20px;
            /*display:none;*/
        }

            .sort-detail :hover {

            }

        .sideBar {
            font-size: 18px;
            text-align: right;
            color: #333;
            border: none;
            width: 100%;
            cursor: pointer;
        }

        .openBar {
            /*border-radius: 10px;*/
        }

        @@media screen and (max-width: 1050px) {
            .iCard {
                padding: 0 7px;
                margin-left: 15px;
                float: left;
                position: relative;
                left: 0px;
                top: 0px;
                background-color: #eee;
                border-radius: 10px;
                border: 1px solid #777;
                width: 500px;
            }
        }

        @@media only screen and (min-width: 1050px) and (max-width: 1380px) {
            .iCard {
                padding: 0 7px;
                margin-left: 15px;
                float: left;
                position: relative;
                left: 0px;
                top: 0px;
                background-color: #eee;
                border-radius: 10px;
                border: 1px solid #777;
                width: 48%;
                min-width: 450px;
            }
        } 

        @@media screen and (min-width: 1380px) {
            .iCard {
                padding: 0 7px;
                margin-left: 15px;
                float: left;
                position: relative;
                left: 0px;
                top: 0px;
                background-color: #eee;
                border-radius: 10px;
                border: 1px solid #777;
                width: 32%;
                min-width: 420px;
            }
        }

        .iCard-header {
            /*padding-top: 0;*/
            padding: .75rem 1.25rem;
            /* margin-top: 0; */
            background-color: #eee;
        }

        .iCard-body {
            /*padding: 22px;*/
            padding: .75rem 1.25rem;
            border-radius: 10px;
            background-color: #fff;
            display: none;
        }

        .addCard {
            padding: 0 7px;
            position: relative;
            background-color: #eee;
            border-radius: 10px;
            border: 1px solid #777;
            width: 35%;
            min-width: 434px;
        }

        .closeNewRow {
            margin-left: 25px;
        }

        .input-group-text {
            min-width: 100px;
        }

        .new-detail-icon {
            min-width: 75px;
            color: #070;
        }

        .read-control-icon {
            margin-left:10px;
            color: #cbcbc9;
            width: 20px;
            height: 20px;
            font-size: 20px;
            /* margin-top: -5px; */
        }

        .read-control-title {
            margin-left: 10px;
            color: #cbcbc9;
            width: 100px;
            height: 20px;
            font-size: 16px;
            /* margin-top: -5px; */
        }

        .detail-input {
            margin-left: 15px;
            /* padding-left: 10px; */
            outline: 0 !important;
            width: 60%;
            height: 30px;
            border-top: 0;
            border-left: 0;
            border-right: 0;
            border-bottom: solid 1px #ddd;
            border-radius: 0;
            background: #fff;
        }

        .detail-other {
            color:#0300ff;
        }

        input[name="txtParameterName"] {
            font-size: 18px;
            font-weight:600;
            color:#777;
        }

        input[name="txtParameterEName"] {
            font-size: 16px;
            color: #777;
        }

        .primary {
            background-color:#f5ecff;
        }
            .primary :hover {
                background-color: #c4fff2;
            }

        .secondary {
            background-color: #eaeaea;
        }

            .secondary :hover {
                background-color:#c4fff2;
            }

        .border-focus {
            animation: fade 1000ms 3 ease-in-out;
            border: 3px solid #ff6500;
        }

        @@keyframes fade {
            from {
                opacity :1.0;
            }
            50% {
                opacity: 0.0;
            }
            to {
                opacity: 1.0;
            }
        }
</style>
)

<div class="row" id="listData@(itemName)">
    <div class="col-12">
        <div class="card card-shadow mb-4">
            <div class="card-body">
                <div class="row justify-content-between">
                    <div class="col-6 col-md-6 col-sm-6">
                        <div class="row">
                            <div class="col-12 col-md-8 col-sm-8">
                                <div class="input-group">
                                    <span class="input-group-addon">設計項目</span>
                                    <input type="text" id="txtParameterNameQ@(itemName)" class="form-control" style="" placeholder="請輸入設計項目名稱">
                                    <span class="input-group-addon">設計選項</span>
                                    <input type="text" id="txtPmtDetailNameQ@(itemName)" class="form-control" style="" placeholder="請輸入設計選項名稱">
                                    <div class="input-group-append">
                                        <a class="btn btn-primary auth-read" href="javascript:Query@(itemName)();"><i class="fal fa-search"></i>搜尋</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-md-6 col-sm-6 text-right">
                        <a class="btn btn-info auth-add" href="javascript:Edit@(itemName)();"><i class="fas fa-plus"></i>新增</a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="card card-shadow mb-4">
                            <div class="card-body" id="tblData@(itemName)">
                            </div>
                            <div class="card-footer text-center">
                                <div class="pagination" id="page@(itemName)"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer text-right text-lg-right read-hide">
                <button type="button" class="btn btn-secondary" onclick="Return@(itemName)()"><i class="fas fa-undo"></i>返回</button>
            </div>
        </div>
    </div>
</div>

<div class="row" id="editData@(itemName)" style="display: none;">
    <div class="col-12">
        <div class="card card-shadow mb-4">
            <div class="card-body">
                <form class="addCard border-success container custom-form-container" id="editForm@(itemName)">
                    @Html.Hidden("TempSpId", -1)
                    <div class="card-body" name="tblMain@(itemName)">
                        <div class="row">
                            <div class="col-12 mb-3" style="font-size:18px;"><i class="fas fa-plus">新增</i></div>
                        </div>
                        <div class="row">
                            <div class="col-8 mb-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">設計項目</span>
                                    </div>
                                    <input type="text" class="form-control" id="txtParameterName@(itemName)" name="txtParameterName@(itemName)" placeholder="請輸入設計項目名稱"
                                           data-msg-required="請輸入設計項目名稱" data-rule-required="true" data-msg-maxlength="必須少於 100 個字元" maxlength="100">
                                </div>
                            </div>
                            <div class="col-4" id="cboControlType@(itemName)Box"></div>
                        </div>
                        <div class="row">
                            <div class="col-8 mb-3">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">設計項目</span>
                                    </div>
                                    <input type="text" class="form-control" id="txtParameterEName@(itemName)" name="txtParameterEName@(itemName)" data-msg-maxlength="必須少於 100 個字元" maxlength="100">
                                </div>
                            </div>
                            <div class="col-4 text-right">
                                <input type="checkbox" name="chkStatus@(itemName)" class="auth-add" checked />
                            </div>
                        </div>
                    </div>
                    @*<div class="text-secondary">
                        <div id="tblDetail@(itemName)" name="tblDetail@(itemName)" class="ui-sortable"></div>
                        <div id="tblDefault@(itemName)" name="tblDefault@(itemName)">
                            <div id="-1" class="col-12 mb-3"></div>
                            <div class="col-12 mb-3">
                                <div class="row">
                                    <button type="button" class="btn btn-sm primary" onclick="SetNewDetail@(itemName)(-1, '')">新增選項</button>
                                    <button type="button" class="btn btn-sm secondary" onclick="SetNewDetail@(itemName)(-1, 'O')">新增「其他」</button>
                                </div>
                            </div>
                        </div>
                    </div>*@
                    <div class="card-footer bg-transparent border-success">
                        <div class="row">
                            <div class="col-12 text-right">
                                <input type="checkbox" name="chkRequired@(itemName)" class="auth-add" checked />
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card-footer text-center text-lg-right read-hide">
                <button type="button" class="btn btn-secondary" onclick="Return@(itemName)()"><i class="fas fa-undo"></i>返回</button>
                <button type="button" class="btn btn-success" onclick="Save@(itemName)(-1)"><i class="fas fa-save"></i>儲存</button>
            </div>
        </div>
    </div>
</div>

<div id="tempControlType@(itemName)" style="display:none;">
    <select class="form-control" id="cboControlType@(itemName)" name="cboControlType@(itemName)"></select>
</div>

<!--其他分頁-->
@*<div class="advanced-block">
    <div class="row">
        <div class="col-12">
            <ul class="nav flag-tabs nav-fill" role="tablist">
                <li class="flag-item">
                    <a class="flag-link" data-toggle="tab" href="#tabRfqDetail">
                        <i class="fas fa-sort-size-down"></i> RFI單身資料
                    </a>
                </li>
            </ul>
        </div>
    </div>
    <div class="tab-content">
        <div class="tab-pane" id="tabRfqDetail">
            @Html.Partial("")
        </div>
    </div>
</div>*@

@Html.Resource("js",
    @<script>
        let objForm@(itemName) = "#editForm@(itemName)";
        let objPage@(itemName) = {
            pageIndex: 0,
            pageSize: 20
        };
        let Elements@(itemName) = new ElementControl@(itemName)();
        let Datas@(itemName) = new DataControl@(itemName)();

        $(function () {
            $("#txtParameterNameQ@(itemName), #txtPmtDetailNameQ@(itemName)").val("");
            $("#txtParameterNameQ@(itemName), #txtPmtDetailNameQ@(itemName)").keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    Query@(itemName)();
                    return false;
                }
            });

            ComboBoxs.Default("#cboControlType@(itemName)", "@Url.Action("GetType", "RequestForInformation")", { "TypeSchema": "RfiFormItem.ItemType" }, "", "NA", "", "TypeName", "TypeNo");
        });

        function Expand@(itemName)() {
            if (parseInt($("#ProTypeGroupId").val()) > 0) {
                $(".advanced-block").slideDown("slow");

                Return@(itemName)();
            } else {
                alert("產品群組管理錯誤", "alert");
            }
        }

        function InitData@(itemName)(objPage) {
            let tempSpId = $("#TempSpId").val();
            let innerHtml = '';
            let pageCount = 0;

            let targetUrl = "@Url.Action("GetTemplateSpecParameter", "RequestForInformation")";
            let postData = {
                "OrderBy": "",
                "PageIndex": (objPage.pageIndex + 1),
                "PageSize": objPage.pageSize,
                "TempSpId": tempSpId,
                "ProTypeGroupId": $("#ProTypeGroupId").val(),
                "ParameterName": $("#txtParameterNameQ@(itemName)").val(),
                "ParameterEName": $("#txtParameterENameQ@(itemName)").val(),
                "PmtDetailName": $("#txtPmtDetailNameQ@(itemName)").val(),
                "Status": $("input[name='cbxStatusQ@(itemName)']:checked").toArray().map(item => item.value).join(",")
            };
            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;

                if (pageCount > 0) {
                    objPage = PageCaculate(pageCount, objPage);

                    $.each(data.result, function (i, item) {
                        let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";

                        let targetStatus = $(`#sideStatus@(itemName)-${item.TempSpId}`); //紀錄當前狀態

                        innerHtml += `<div id="${item.TempSpId}" class="iCard border-success mb-3">
                                        <input type="hidden" id="sideStatus@(itemName)-${item.TempSpId}" value="${targetStatus.val()}" />
                                        ${SetMainData@(itemName)(item)}
                                      </div>`
                    });
                } else {
                    innerHtml += `<div class="iCard border-success mb-3" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                　</div>`;
                }
            } else {
                alert(data.msg, "alert", 0);
            }

            $("#tblData@(itemName)").html(innerHtml);
            TableComponentInit();
            Pager("#page@(itemName)", pageCount, objPage, InitData@(itemName));

            $(`.iCard-body`).prop({ 'style': 'display: none;' });

            Elements@(itemName).Initialize@(itemName)();
            Elements@(itemName).SetEffects@(itemName)(300);

            @* $("#cboProductUse@(itemName)").select2({
                dropdownAutoWidth: true,
                width: "100%"
            });*@

            //控制動作滾輪高度
            //$(".dropdown-toggle").off("click").on("click", function () {
            //    let rfqId = $(this).data("rfq-id");

            //    if ($(`.dropdown-menu[data-rfq-id='${rfqId}']`).hasClass("show")) {
            //        $(".dropdown-menu").removeClass("show");
            //    } else {
            //        $(".dropdown-menu").removeClass("show");

            //        $(`.dropdown-menu[data-rfq-id='${rfqId}']`).addClass("show");
            //        $(`.dropdown-menu[data-rfq-id='${rfqId}']`).css({
            //            top: `${$(this).position().top + $(this).height() + 5}px`,
            //            left: `${$(this).position().left - $(this).width() + 38}px`
            //        });
            //    }
            //});

            //$("body").off("click").on("click", function (e) {
            //    if ($(".dropdown-menu").hasClass("show")) {
            //        if (!$(e.target).hasClass("dropdown-toggle")
            //            && !$(e.target).parents().hasClass("dropdown-toggle")) {
            //            $(".dropdown-menu").removeClass("show");
            //        }
            //    }
            //});
        }

        function GetData@(itemName)(tempSpId) {
            let innerHtml = ``;

            let targetUrl = "@Url.Action("GetTemplateSpecParameter", "RequestForInformation")";
            let postData = {
                "PageIndex": 1,
                "PageSize": objPage@(itemName).pageSize,
                "TempSpId": tempSpId,
            };
            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                $.each(data.result, function (i, item) {
                    innerHtml = SetMainData@(itemName)(item);
                });

                let nowStatus = $(`#sideStatus@(itemName)-${tempSpId}`); //紀錄當前狀態

                $(`#tblData@(itemName) > #${tempSpId}`).html(`<input type="hidden" id="sideStatus@(itemName)-${tempSpId}" value="${nowStatus.val()}" />${innerHtml}`);
                Elements@(itemName).Initialize@(itemName)();
                Elements@(itemName).SetEffects@(itemName)(300);
                SetSideVisible@(itemName) (0, `#listData@(itemName)`, $(`#listData@(itemName) #${tempSpId} .sideBar`));
            }
        }

        function ElementControl@(itemName)() {
            addMethod(this, "Initialize@(itemName)", function () {
                //排序拖曳
                $("#listData@(itemName) #tblData@(itemName)").sortable({
                    cancel: ".disabled-sort",
                    handle: ".sort-handle",
                    update: function (event, ui) {
                        Datas@(itemName).UpdateTemplateSpecParameterSort@(itemName)(this, ui.item);
                    }
                });

                //排序拖曳
                $.each($(`#listData@(itemName) div[name="tblDetail@(itemName)"]`), function (i, item) {
                    $(`#${this.id}`).sortable({
                        cancel: ".disabled-sort",
                        handle: ".sort-detail",
                        update: function (event, ui) {
                            Datas@(itemName).UpdateTemplateSpecParameterDetailSort@(itemName)(this, ui.item);
                        }
                    });
                });

                $(`#listData@(itemName) input[name='chkStatus@(itemName)'], #editData@(itemName) input[name='chkStatus@(itemName)']`).bootstrapToggle({
                    on: "啟用",
                    off: "關閉",
                    onstyle: "success",
                    offstyle: "danger",
                    size: "mini",
                    width: "75px"
                });

                $(`#listData@(itemName) input[name='chkRequired@(itemName)'], #editData@(itemName) input[name='chkRequired@(itemName)']`).bootstrapToggle({
                    on: "必填",
                    off: "非必填",
                    onstyle: "success",
                    offstyle: "danger",
                    size: "mini",
                    width: "75px"
                });

                $("#listData@(itemName) button[name='Delete@(itemName)'][data-tempsp-id]").off("click").on("click", function () {
                    Datas@(itemName).Delete@(itemName)(this);
                });

                $("#listData@(itemName) a[name='DeleteDetail@(itemName)'][data-tempspdetail-id]").off("click").on("click", function () {
                    Datas@(itemName).DeleteDetail@(itemName)(this);
                });

                $("#listData@(itemName) input[name='chkStatus@(itemName)'][data-tempsp-id]").off("change").on("change", function () {
                    Datas@(itemName).StatusSwitch@(itemName)(this);
                });

                $("#listData@(itemName) input[name='chkRequired@(itemName)'][data-tempsp-id]").off("change").on("change", function () {
                    Datas@(itemName).RequiredSwitch@(itemName)(this);
                });

                //控制項類型切換
                $(`#listData@(itemName) div[name="tblMain@(itemName)"] select[name="cboControlType@(itemName)"]`).off("change").on("change", function () {
                    Datas@(itemName).UpdateControlType@(itemName)(this);
                });

                //設計項目名稱變更
                $(`#listData@(itemName) input[name="txtParameterName@(itemName)"], #listData@(itemName) input[name="txtParameterEName@(itemName)"]`).off("change").on("change", function (e) {
                    Datas@(itemName).UpdateTemplateSpecParameter@(itemName)(this);
                });

                //規格特徵名稱變更
                $(`#listData@(itemName) input[name="txtPmtDetailName@(itemName)"]`).off("change").on("change", function (e) {
                    Datas@(itemName).UpdateTemplateSpecParameterDetail@(itemName)(this);
                });
            });

            addMethod(this, "SetEffects@(itemName)", function (t) {
                let targetSelector = [`#listData@(itemName)`];
                $.each(targetSelector, function (i, selector) {
                    $(`${selector} .sideBar`).off('click').on('click', function () {
                        SwitchSideVisible@(itemName) (t, selector, this);
                    });
                });
            });
        }

        function DataControl@(itemName)() {
            addMethod(this, "UpdateTemplateSpecParameterSort@(itemName)", function (t, e) {
                console.log($(t).sortable("toArray", { attribute: 'id' }).join());

                let targetUrl = '@Url.Action("UpdateTemplateSpecParameterSort", "RequestForInformation")';
                let postData = {
                    "ProTypeGroupId": $("#ProTypeGroupId").val(),
                    "SortList": $(t).sortable("toArray", { attribute: 'id' }).join()
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    Query@(itemName)();
                }
            });

            addMethod(this, "UpdateTemplateSpecParameterDetailSort@(itemName)", function (t, e) {
                console.log($(t).sortable("toArray", { attribute: 'id' }).join());

                let tempSpId = $(e).data(`tempsp-id`);

                let targetUrl = '@Url.Action("UpdateTemplateSpecParameterDetailSort", "RequestForInformation")';
                let postData = {
                    "TempSpId": tempSpId,
                    "SortList": $(t).sortable("toArray", { attribute: 'id' }).join()
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    GetData@(itemName)(tempSpId);
                }
            });

            addMethod(this, "UpdateControlType@(itemName)", function (e) {
                let tempSpId = $(e).data(`tempsp-id`);

                let targetUrl = '@Url.Action("UpdateTemplateSpecParameterControlType", "RequestForInformation")';
                let postData = {
                    "TempSpId": tempSpId,
                    "ControlType": e.value
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    GetData@(itemName)(tempSpId);
                }
            });

            addMethod(this, "UpdateTemplateSpecParameter@(itemName)", function (e) {
                let tempSpId = $(e).data('tempsp-id');

                let targetUrl = "@Url.Action("UpdateTemplateSpecParameter", "RequestForInformation")";
                let postData = {
                    "TempSpId": tempSpId,
                    "ParameterName": $(`#txtParameterName@(itemName)-${tempSpId}`).val(),
                    "ParameterEName": $(`#txtParameterEName@(itemName)-${tempSpId}`).val(),
                }

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    GetData@(itemName)(tempSpId);
                }
            });

            addMethod(this, "UpdateTemplateSpecParameterDetail@(itemName)", function (e) {
                let tempSpId = $(e).data('tempsp-id');
                let tempSpDetailId = $(e).data('tempspdetail-id');

                let targetUrl = "@Url.Action("UpdateTemplateSpecParameterDetail", "RequestForInformation")";
                let postData = {
                    "TempSpDetailId": tempSpDetailId,
                    "PmtDetailName": $(`#txtPmtDetailName@(itemName)-${tempSpDetailId}`).val()
                }

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    GetData@(itemName)(tempSpId);
                }
            });

            addMethod(this, "StatusSwitch@(itemName)", function (e) {
                var tempSpId = $(e).data("tempsp-id");

                let targetUrl = "@Url.Action("UpdateTemplateSpecParameterStatus", "RequestForInformation")";
                let postData = {
                    "TempSpId": tempSpId,
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    GetData@(itemName)(tempSpId);
                }
            });

            addMethod(this, "RequiredSwitch@(itemName)", function (e) {
                var tempSpId = $(e).data("tempsp-id");

                let targetUrl = "@Url.Action("UpdateTemplateSpecParameterRequired", "RequestForInformation")";
                let postData = {
                    "TempSpId": tempSpId,
                };

                let result = DataAccess.Update(targetUrl, postData, false, true);

                if (result) {
                    GetData@(itemName)(tempSpId);
                }
            });

            addMethod(this, "Delete@(itemName)", function (e) {
                var tempSpId = $(e).data("tempsp-id");
                let row_name = $(`#txtParameterName@(itemName)-${tempSpId}`).val();

                swal.fire({
                    titleText: `確認要刪除${row_name}嗎?`,
                    text: "此動作無法復原，請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        let targetUrl = "@Url.Action("DeleteTemplateSpecParameter", "RequestForInformation")";
                        let postData = {
                            "TempSpId": tempSpId
                        };

                        let result = DataAccess.Delete(targetUrl, postData, false, true);

                        if (result) {
                            Query@(itemName)();
                        }
                    }
                });
            });

            addMethod(this, "DeleteDetail@(itemName)", function (e) {
                let tempSpId = $(e).data('tempsp-id');
                var tempSpDetailId = $(e).data("tempspdetail-id");
                let row_name = $(`#txtPmtDetailName@(itemName)-${tempSpDetailId}`).val();

                swal.fire({
                    titleText: `確認要刪除${row_name}嗎?`,
                    text: "此動作無法復原，請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        let targetUrl = "@Url.Action("DeleteTemplateSpecParameterDetail", "RequestForInformation")";
                        let postData = {
                            "TempSpDetailId": tempSpDetailId
                        };

                        let result = DataAccess.Delete(targetUrl, postData, false, true);

                        if (result) {
                            GetData@(itemName)(tempSpId);
                        }
                    }
                });
            });
        }

        //#region 切換特徵編輯式窗顯示
        function SwitchSideVisible@(itemName) (t, s, e) {
            let tempSpId = $(e).data(`tempsp-id`);
            let activeElement = $(`${s} #${tempSpId} .iCard-body`);
            let nowStatus = $(`${s} #sideStatus@(itemName)-${tempSpId}`); //紀錄當前狀態

            if (activeElement.hasClass(`active`)) {
                activeElement.slideUp(t, function () {
                    $(this).removeClass('active');
                    $(e).addClass('openBar').prop(`title`, `展開`);
                });
                nowStatus.val('');
                $(e).find('i').prop('class', 'fas fa-plus-square');
            }
            else {
                activeElement.slideDown(t, function () {
                    $(this).addClass('active');
                });
                nowStatus.val('active');
                $(e).removeClass('openBar').prop(`title`, `收折`);
                $(e).find('i').prop('class', 'far fa-minus-square');
            }
        }
        //#endregion

        function SetSideVisible@(itemName) (t, s, e) {
            let tempSpId = $(e).data(`tempsp-id`);
            let activeElement = $(`${s} #${tempSpId} .iCard-body`);
            let nowStatus = $(`${s} #sideStatus@(itemName)-${tempSpId}`); //紀錄當前狀態

            if (nowStatus.val() != `active`) {
                activeElement.slideUp(t, function () {
                    $(this).removeClass('active');
                    $(e).addClass('openBar').prop(`title`, `展開`);
                });
                nowStatus.val('');
                $(e).find('i').prop('class', 'fas fa-plus-square');
            }
            else {
                activeElement.slideDown(t, function () {
                    $(this).addClass('active');
                });
                nowStatus.val('active');
                $(e).removeClass('openBar').prop(`title`, `收折`);
                $(e).find('i').prop('class', 'far fa-minus-square');
            }
        }

        function SetDetailDefault@(itemName)(tempSpId, controlType, source) {
            let html = ``;
            let hasOther;

            if (source) {
                let jsonData = JSON.parse(source);
                hasOther = jsonData.find(f => f.DataType === 'O'); //找出是否已包含其他選項
            }

            switch (controlType) {
                case 'C':
                case 'R':
                    if (!hasOther) {
                        html += `<div class="col-12 mb-3">
                                    <div class="row">
                                        <button type="button" class="btn btn-sm primary" onclick="SetNewDetail@(itemName)(${tempSpId}, '')">新增選項</button>
                                        <button type="button" class="btn btn-sm secondary" onclick="SetNewDetail@(itemName)(${tempSpId}, 'O')">新增「其他」</button>
                                    </div>
                                </div>`
                    }
                    else {
                        html += `<div class="col-12 mb-3">
                                    <div class="row">
                                        <button type="button" class="btn btn-sm primary" onclick="SetNewDetail@(itemName)(${tempSpId}, '')">新增選項</button>
                                    </div>
                                </div>`
                    }
                    break;
                default:
                    html += `<div class="col-12 mb-3">
                                <div class="row">
                                    <button type="button" class="btn btn-sm primary" onclick="SetNewDetail@(itemName)(${tempSpId}, '')">新增選項</button>
                                </div>
                            </div>`
                    break;
            }

            return html;
        }

        function SetMainData@(itemName)(item) {
            let html = ``;

            let cboControlType = $(`#cboControlType@(itemName)`).clone();
            cboControlType.val(item.ControlType).find(':selected').attr('selected', true);

            html = `<div name="tblMain@(itemName)" class="iCard-header">
                        <div class="row sortRow">
                            <div class="col-6"><i class="fas fa-arrows-alt sort-handle">排序</i></div>
                            <div class="col-6 sort-number text-right">#${item.SortNumber}</div>
                        </div>
                        <div class="row">
                            <div class="col-8 mb-3">
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text">設計項目</span></div>
                                    <input type="text" class="form-control" id="txtParameterName@(itemName)-${item.TempSpId}" name="txtParameterName@(itemName)" data-tempsp-id="${item.TempSpId}"
                                        placeholder="請輸入設計項目名稱" data-msg-required="請輸入設計項目名稱" data-rule-required="true"
                                        data-msg-maxlength="必須少於 100 個字元" maxlength="100" value="${item.ParameterName}">
                                </div>
                            </div>
                            <div class="col-4"><select class="form-control" id="cboControlType@(itemName)-${item.TempSpId}" name="cboControlType@(itemName)" data-tempsp-id="${item.TempSpId}">${cboControlType.html()}</select></div>
                        </div>
                        <div class="row">
                            <div class="col-8 mb-3">
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text">設計項目</span></div>
                                    <input type="text" class="form-control" id="txtParameterEName@(itemName)-${item.TempSpId}" name="txtParameterEName@(itemName)" data-tempsp-id="${item.TempSpId}"
                                        data-msg-maxlength="必須少於 100 個字元" maxlength="100" value="${item.ParameterEName}">
                                </div>
                            </div>
                            <div class="col-4 text-right">
                                <input type="checkbox" name="chkStatus@(itemName)" class="auth-update" data-tempsp-id="${item.TempSpId}" ${(item.Status == `A` ? `checked` : ``)} />
                                <div>
                                    <i style="color:blue">項目數量：${item.FeatureCount}</i>
                                    <span class="sideBar" data-toggle="tooltip" data-tempsp-id="${item.TempSpId}" title="展開"><i class="fas fa-plus-square"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="iCard-body text-secondary">
                        <div id="tblDetail@(itemName)-${item.TempSpId}" name="tblDetail@(itemName)">
                            ${SetDetailData@(itemName)(item.TempSpId, item.ControlType, item.TempSpecParameterDetail)}
                        </div>
                        <div id="tblDefault@(itemName)-${item.TempSpId}" name="tblDefault@(itemName)">
                            <div id="-1" class="col-12 mb-3"></div>
                            ${SetDetailDefault@(itemName)(item.TempSpId, item.ControlType, item.TempSpecParameterDetail)}
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-success">
                        <div class="row">
                            <div class="col-6">
                                <button type="button" name="Delete@(itemName)" class="btn btn-sm btn-outline-danger auth-delete" data-tempsp-id="${item.TempSpId}"><i class="far fa-trash-alt"></i>刪除</button>
                            </div>
                            <div class="col-6 text-right">
                                <input type="checkbox" name="chkRequired@(itemName)" class="auth-update" data-tempsp-id="${item.TempSpId}" ${(item.Required == 1 ? `checked` : ``)} />
                            </div>
                        </div>
                    </div>`;

            return html;
        }

        function SetDetailData@(itemName)(tempSpId, controlType, source) {
            let html = '';

            if (source) {
                let jsonData = JSON.parse(source);

                $.each(jsonData, function (i, item) {
                    switch (controlType) {
                        case 'C':
                            html += `<div id=${item.TempSpDetailId} class="col-12 mb-3" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}">
                                        <div class="row">
                                            <i class="far fa-ellipsis-v sort-detail"></i>
                                            <span style="min-width:24px;">${i+1}. </span>
                                            <span class="read-control-icon"><i class="far fa-square"></i></span>
                                            <input type="text" class="form-control detail-input ${item.DataType == `O` ? `detail-other` : ``}" id="txtPmtDetailName@(itemName)-${item.TempSpDetailId}" name="txtPmtDetailName@(itemName)" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}" value="${item.PmtDetailName}">
                                            <a href="javascript:void(0);" name="DeleteDetail@(itemName)" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}"><span class="fas fa-times" style="color: #f34;"></span></a>
                                        </div>
                                    </div>`;
                            break;
                        case 'R':
                            html += `<div id=${item.TempSpDetailId} class="col-12 mb-3" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}">
                                        <div class="row">
                                            <i class="far fa-ellipsis-v sort-detail"></i>
                                            <span style="min-width:24px;">${i+1}. </span>
                                            <span class="read-control-icon"><i class="far fa-circle"></i></span>
                                            <input type="text" class="form-control detail-input ${item.DataType == `O` ? `detail-other` : ``}" id="txtPmtDetailName@(itemName)-${item.TempSpDetailId}" name="txtPmtDetailName@(itemName)" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}" value="${item.PmtDetailName}">
                                            <a href="javascript:void(0);" name="DeleteDetail@(itemName)" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}"><span class="fas fa-times" style="color: #f34;"></span></a>
                                        </div>
                                    </div>`;
                            break;
                        case 'D':
                            html += `<div id=${item.TempSpDetailId} class="col-12 mb-3" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}">
                                        <div class="row">
                                            <i class="far fa-ellipsis-v sort-detail"></i>
                                            <span style="min-width:24px;">${i+1}. </span>
                                            <span class="read-control-title">選項名稱</span>
                                            <input type="text" class="form-control detail-input" id="txtPmtDetailName@(itemName)-${item.TempSpDetailId}" name="txtPmtDetailName@(itemName)" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}" value="${item.PmtDetailName}" ${item.DataType == `O` ? `disabled` : ``}>
                                            <a href="javascript:void(0);" name="DeleteDetail@(itemName)" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}"><span class="fas fa-times" style="color: #f34;"></span></a>
                                        </div>
                                    </div>`;
                            break;
                        case 'T':
                        case 'A':
                            html += `<div id=${item.TempSpDetailId} class="col-12 mb-3" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}">
                                        <div class="row">
                                            <i class="far fa-ellipsis-v sort-detail"></i>
                                            <span style="min-width:24px;">${i+1}. </span>
                                            <span class="read-control-title">欄位名稱</span>
                                            <input type="text" class="form-control detail-input" id="txtPmtDetailName@(itemName)-${item.TempSpDetailId}" name="txtPmtDetailName@(itemName)" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}" value="${item.PmtDetailName}" ${item.DataType == `O` ? `disabled` : ``}>
                                            <a href="javascript:void(0);" name="DeleteDetail@(itemName)" data-tempsp-id="${tempSpId}" data-tempspdetail-id="${item.TempSpDetailId}"><span class="fas fa-times" style="color: #f34;"></span></a>
                                        </div>
                                    </div>`;
                            break;
                    }
                });
            }
            return html;
        }

        function SetNewDetail@(itemName)(tempSpId, dataType) {
            let html = ``;

            switch (dataType) {
                case 'O':
                    html = `<div class="row">
                                <span class="fas fa-plus new-detail-icon text-right"></span>
                                <input type="hidden" id="txtDataType@(itemName)-${tempSpId}" name="txtDataType@(itemName)" value="${dataType}" />
                                <input type="text" class="form-control detail-input" id="txtPmtDetailName@(itemName)-${tempSpId}" name="txtPmtDetailName@(itemName)" value="其他">
                                <a href="javascript:void(0);" id="newRow@(itemName)-${tempSpId}" data-tempsp-id="${tempSpId}" data-tempspdetail-id="-1"><span class="fas fa-check" style="color: #070;"></span></a>
                                <a href="javascript:void(0);" id="closeNewRow@(itemName)-${tempSpId}" class="closeNewRow" data-tempsp-id="${tempSpId}"><span class="fas fa-times" style="color: #f34;"></span></a>
                            </div>`
                    break;
                default:
                    html = `<div class="row">
                                <span class="fas fa-plus new-detail-icon text-right"></span>
                                <input type="text" class="form-control detail-input" id="txtPmtDetailName@(itemName)-${tempSpId}" name="txtPmtDetailName@(itemName)">
                                <a href="javascript:void(0);" id="newRow@(itemName)-${tempSpId}" data-tempsp-id="${tempSpId}" data-tempspdetail-id="-1"><span class="fas fa-check" style="color: #070;"></span></a>
                                <a href="javascript:void(0);" id="closeNewRow@(itemName)-${tempSpId}" class="closeNewRow" data-tempsp-id="${tempSpId}"><span class="fas fa-times" style="color: #f34;"></span></a>
                            </div>`
                    break;
            }

            $(`#tblDefault@(itemName)-${tempSpId} div[id="-1"]`).html(html);
            $(`#tblDefault@(itemName)-${tempSpId} #newRow@(itemName)-${tempSpId}`).click(SaveDetail@(itemName));
            $(`#tblDefault@(itemName)-${tempSpId} #closeNewRow@(itemName)-${tempSpId}`).click(CloseNewRow@(itemName));
        }

        function Edit@(itemName)() {
            Switch("#editData@(itemName), .unit-block", "#listData@(itemName)");

            $(`#cboControlType@(itemName)Box`).html($(`#tempControlType@(itemName)`).html()); //複製下拉選單

            $(`#editData@(itemName) input[name='chkStatus@(itemName)'], #editData@(itemName) input[name='chkRequired@(itemName)']`).change(function () {
                let checked = this.checked;
                if (checked) $(`#editData@(itemName) input[name="${this.name}"]`).attr('checked', true);
                else $(`#editData@(itemName) input[name="${this.name}"]`).removeAttr('checked', true);
            });
        }

        function Save@(itemName)(TempSpId) {
            if ($(objForm@(itemName)).valid()) {
                if (TempSpId <= 0) {
                    let targetUrl = "@Url.Action("AddTemplateSpecParameter", "RequestForInformation")";
                    let data = DataAccess.EditContinued(targetUrl,
                        {
                            ProTypeGroupId: $("#ProTypeGroupId").val(),
                            ParameterName: $(`${objForm@(itemName)} #txtParameterName@(itemName)`).val(),
                            ParameterEName: $(`${objForm@(itemName)} #txtParameterEName@(itemName)`).val(),
                            ControlType: $(`${objForm@(itemName)} #cboControlType@(itemName) :selected`).val(),
                            Required: $(`${objForm@(itemName)} input[name="chkRequired@(itemName)"]`).prop('checked') ? `1` : `0`,
                            Status: $(`${objForm@(itemName)} input[name="chkStatus@(itemName)"]`).prop('checked') ? `A` : `S`
                        }, false);

                    if (data) {
                        TempSpId = data.result.TempSpId;
                        ReturnById@(itemName)(TempSpId); //查詢此資料 by TempSpId

                        //focus 特效
                        $(`#listData@(itemName)`).animate({
                            scrollTop: $(`#${TempSpId}`).offset().top
                        }, 300);
                        $(`#listData@(itemName) #${TempSpId}`).removeClass(`border-success`).addClass(`border-focus`);
                        $(`#${TempSpId}`).off('click').on('click', function () { $(this).removeClass(`border-focus`).addClass(`border-success`) });
                    }
                }
            }
        }

        function SaveDetail@(itemName)() {
            @*if ($(objForm@(itemName)).valid()) {}*@

            let TempSpId = $(this).data("tempsp-id");
            let TempSpDetailId = $(this).data("tempspdetail-id");

            if (TempSpDetailId <= 0) {
                let targetUrl = "@Url.Action("AddTemplateSpecParameterDetail", "RequestForInformation")";
                let data = DataAccess.EditContinued(targetUrl,
                    {
                        TempSpId: TempSpId,
                        ControlType: $(`#tblDefault@(itemName)-${TempSpId} #cboControl@(itemName)-${TempSpId}:selected`).val(),
                        PmtDetailName: $(`#tblDefault@(itemName)-${TempSpId} #txtPmtDetailName@(itemName)-${TempSpId}`).val(),
                        DataType: $(`#tblDefault@(itemName)-${TempSpId} #txtDataType@(itemName)-${TempSpId}`).val(),
                        Description: "", //預留欄位
                    }, false);

                if (data) {
                    GetData@(itemName)(TempSpId);
                }
            }
        }

        function CloseNewRow@(itemName)() {
            let TempSpId = $(this).data("tempsp-id");
            $(`#tblDefault@(itemName)-${TempSpId} div[id="-1"]`).html('');
        }

        function Read@(itemName)(TempSpId) {
            Edit@(itemName)(TempSpId);
        }

        function Query@(itemName)() {
            objPage@(itemName).pageIndex = 0;
            InitData@(itemName)(objPage@(itemName));
        }

        function ReturnById@(itemName)(TempSpId) {
            $(`#TempSpId`).val(TempSpId);
            $(`#listData@(itemName) .read-hide`).show();

            ResetForm(objForm@(itemName));
            Switch("#listData@(itemName)", "#editData@(itemName)");
            Query@(itemName)();
        }

        function Return@(itemName)() {
            $(`#TempSpId`).val(-1); //列表頁需重置資料id
            $(`#listData@(itemName) .read-hide`).hide();

            ResetForm(objForm@(itemName));
            Switch("#listData@(itemName)", "#editData@(itemName)");
            Query@(itemName)();
        }
</script>
)
