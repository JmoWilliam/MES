@using Business_Manager.Helpers
@{
    string dateCache = DateTime.Now.ToString("MMddmmss");
    string itemName = "ReplyInterface";

    //(int ProjectTaskId, string UserNo) = ((int, string))TempData["data"];

    string SecretKey = Request.Params["SecretKey"];
    string CompanyNo = Request.Params["Company"];
    string UserNo = Request.Params["UserNo"];
    int.TryParse(Request.Params["ProjectTaskId"], out int ProjectTaskId);

    //string SecretKey = "236BD9384B5648497B3899797594ED07E3AA2FB07ED1FBE8620F0043257A7741";
    //string CompanyNo = "JMO";
    //string UserNo = "ZY00860";
    //int.TryParse("2313", out int ProjectTaskId);
}

@Html.Resource("css", @<link href="@Url.Content("~/Content/dhtmlx/gantt.commercial/7.1.12/dhtmlxgantt.css")" rel="stylesheet" />)

@*@Html.Resource("js", @<script src="@Url.Content("~/assets/js/jquery.min.js")"></script>)
    @Html.Resource("js", @<script src="@Url.Content("~/Scripts/app.js")?@dateCache"></script>)
    @Html.Resource("js", @<script src="@Url.Content("~/Scripts/system.setting.js")?@dateCache"></script>)
    @Html.Resource("js", @<script src="@Url.Content("~/Scripts/locales.js")"></script>)
    @Html.Resource("js", @<script src="@Url.Content("~/Scripts/custom.js")?@dateCache"></script>)*@


<input type="text" id="SecretKey" value=@(SecretKey) />
<input type="text" id="CompanyNo" value=@(CompanyNo) />
<input type="text" id="ProjectTaskId" value=@(ProjectTaskId) />
<input type="text" id="UserNo" value=@(UserNo) />
<div class="gantt-body" id="gantt@(itemName)" style="height: 500px; opacity: 0; position: absolute; z-index: -1;"></div>

<h1 id="info@(itemName)" style="color:#0026ff"></h1>
<button onclick="InitData@(itemName)();">自動排程</button>

@Html.Resource("js", @<script src="@Url.Content("~/Scripts/dhtmlx/gantt.commercial/7.1.12/dhtmlxgantt.js")"></script>)
@Html.Resource("js",
    @<script>
        let gantt@(itemName);

        //window.onload = function () {};
        $(function () {
           InitData@(itemName)();
        });

        function InitData@(itemName)() {
            //#region 專案資料
            let projectData = {};
            let data = DataAccess.Get("@Url.Action("GetProjectApi", "Task")", { "SecretKey": $("#SecretKey").val(), "Company": $("#CompanyNo").val(), "ProjectTaskId": $("#ProjectTaskId").val() }, false);
            if (data.status == "success") {
                $.each(data.result, function (i, item) {
                    projectData.ProjectId = item.ProjectId;
                    projectData.WorkTimeStatus = item.WorkTimeStatus;
                    projectData.WorkTimeInterval = item.WorkTimeInterval;
                });
            } else {
                alert(data.msg, "alert", 0);
            }
            //#endregion

            //#region 任務資料
            let taskData;
            let data2 = DataAccess.Get("@Url.Action("GetTaskGanttApi", "Task")", { "SecretKey": $("#SecretKey").val(), "Company": $("#CompanyNo").val(), "ProjectTaskId": $("#ProjectTaskId").val() }, false);
            if (data2.status == "success") {
                taskData = data2.result;
            } else {
                alert(data2.msg, "alert", 0);
            }
            //#endregion

            if (gantt@(itemName)) gantt@(itemName).destructor();
            gantt@(itemName) = Gantt.getGanttInstance();

            //#region 時間格式組態檔
            let dateToStr = gantt@(itemName).date.date_to_str("%Y-%m-%d"); //日期格式
            let dateOfWeekToStr = gantt@(itemName).date.date_to_str("%Y-%m-%d (%D)"); //日期格式(含星期)
            let datetimeToStr = gantt@(itemName).date.date_to_str("%Y-%m-%d %H:%i"); //日期時間格式
            let timeToStr = gantt@(itemName).date.date_to_str("%H:%i"); //時間格式
            //#endregion

            gantt@(itemName).message.position = "bottom"; //提示訊息位置
            gantt@(itemName).i18n.setLocale(ganttLocales); //設定語系
            gantt@(itemName).plugins({
                auto_scheduling: true //自動排程
            });
            gantt@(itemName).config.date_format = "%Y-%m-%d %H:%i:%s"; //日期格式
            gantt@(itemName).config.work_time = (projectData.WorkTimeStatus == "Y") // 工作天模式
            gantt@(itemName).config.duration_unit = "minute"; //持續時間單位
            gantt@(itemName).config.skip_off_time = false; // 隱藏休息日
            gantt@(itemName).config.start_on_monday = false; //一周起始
            gantt@(itemName).config.round_dnd_dates = false; //允許將任務的開始和結束日期四捨五入到最接近的刻度標記
            gantt@(itemName).config.fit_tasks = true; //甘特圖自動延長時間範圍以適應所有顯示的任務
            gantt@(itemName).config.scroll_size = 10;  //滾動條
            gantt@(itemName).config.time_step = 30;

            gantt@(itemName).config.drag_project = true; //專案類型任務允許拖曳
            gantt@(itemName).config.drag_progress = false; //任務進度禁止調整

            //#region 自動排程
            gantt@(itemName).config.auto_scheduling = true; //自動排程
            gantt@(itemName).config.auto_scheduling_strict = true; //連結任務需接續進行
            gantt@(itemName).config.auto_scheduling_compatibility = false; //自動調度相容性(開啟後自動可能導致往後位移)
            //#endregion

            //#region 設定工作時段
            if (projectData.WorkTimeStatus == "Y" && projectData.WorkTimeInterval) {
                let hourDatas = ToHalfChar(projectData.WorkTimeInterval);
                let hourRanges = hourDatas.split(',');
                let ranges = [];

                $.each(hourRanges, function (i, d) {
                    let t = d.split('-');
                    if (t.length == 2) {
                        if (t[0] > t[1]) {
                            ranges.push(t[0] + '-24:00');
                            ranges.push('00:00-' + t[1]);
                        } else {
                            ranges.push(d);
                        }
                    }
                });
                gantt@(itemName).setWorkTime({ hours: ranges.sort() });
            }
            //#endregion

            gantt@(itemName).attachEvent("onAfterAutoSchedule", DelayTrigger(function (taskId, updatedTasks) {
                let taskJson = JSON.parse('{ "data" : [] }');

                gantt@(itemName).eachTask(function (task) {
                    let json = {
                        ProjectTaskId: task.id,
                        EstimateStart: datetimeToStr(task.start_date),
                        EstimateEnd: datetimeToStr(task.end_date),
                        EstimateDuration: task.duration,
                        TaskName: task.text,
                        TaskStatus: task.task_status,
                        TaskDesc: `MAMO_@(UserNo)`,
                        Index: task.$index,
                        Level: task.$level,
                        Local_index: task.$local_index
                    };
                    taskJson.data.push(json);
                });

                let targetUrl = "@Url.Action("UpdateProjectAllTaskEstimateApi", "Task")";
                let postData = {
                    "SecretKey": $("#SecretKey").val(),
                    "Company": $("#CompanyNo").val(),
                    "ProjectId": projectData.ProjectId,
                    "ProjectTaskId": $("#ProjectTaskId").val(),
                    "TaskData": JSON.stringify(taskJson)
                };

                console.log(`回報任務觸發自動排程`);
                let result = DataAccess.Update(targetUrl, postData, false, false);
                if (result) {
                    window.close();

                    //swal.fire({
                    //    titleText: "訊息",
                    //    text: "工作排程同步完成!",
                    //    icon: "question",
                    //    allowOutsideClick: false,
                    //    allowEscapeKey: false,
                    //    confirmButtonColor: '#87adbd',
                    //    reverseButtons: true
                    //}).then((result) => {
                    //    window.close()
                    //});
                }
            }, 250));
            gantt@(itemName).init("gantt@(itemName)");
            gantt@(itemName).parse(taskData);

            @*let targetUrl = "@Url.Action("GetProjectTaskApi", "api")"; //任務回報
            let postData = {
                "SecretKey": "236BD9384B5648497B3899797594ED07E3AA2FB07ED1FBE8620F0043257A7741",
                "Company": "JMO",
                "ProjectTaskId": 2312
            };*@

            //await fetch(targetUrl, {
            //    method: "POST",
            //    body: JSON.stringify(postData),
            //      headers: {
            //        "Content-type": "application/json; charset=UTF-8"
            //      }
            //})
            //    .then((response) => response.json())
            //    .then((result) => console.log(result))
            //    .catch((error) => console.log("error", error));
            //return false;

            //let data = DataAccess.Get(targetUrl, postData, false);

            //if (data.status == "success") {
            //    console.log(data.result);
            //    alert(JSON.stringify(data.result), "alert", 0);
            //    return data.result;
            //} else {
            //    alert(data.msg, "alert", 0);
            //}
        }

        function ToHalfChar(str) {
            var result = ''; for (i = 0; i < str.length; i++) {
                code = str.charCodeAt(i); //擷取當前字元的unicode編碼
                if (code >= 65281 && code <= 65373) { //在這個unicode編碼範圍中的是所有的英文字母已經各種字元
                    result += String.fromCharCode(str.charCodeAt(i) - 65248);//把全形字元的unicode編碼轉換為對應半形字元的unicode碼
                }
                else if (code == 12288) { //空格
                    result += String.fromCharCode(str.charCodeAt(i) - 12288 + 32);
                }
                else {
                    result += str.charAt(i);
                }
            } return result;
        }
    </script>
                                                                                                        )