@using Business_Manager.Helpers
@{
    string itemName = "ViewPersonalTask";
    string itemNameText = "個人任務";
}

@Html.Resource("css", @<style></style>)

<div class="task-nav" id="nav@(itemName)">
    <div class="container">
        <div class="task-header">
            <a class="set nav-close" href="javascript:void(0);">
                <i class="fas fa-arrow-to-right"></i>
            </a>
            <div class="set-area">
                <a class="set nav-menu far fa-ellipsis-v" href="javascript:void(0);"></a>
                <ul class="set-block hide">
                    <li class="proj-auth-task-update"><a class="update-task" href="javascript:void(0);"><i class="fas fa-edit"></i>切換編輯</a></li>
                    <li class="proj-auth-task-add"><a class="copy-task" href="javascript:void(0);"><i class="fas fa-copy"></i>複製任務</a></li>
                    <li class="proj-auth-task-delete"><a class="delete-task" href="javascript:void(0);"><i class="fas fa-trash-alt"></i>刪除任務</a></li>
                </ul>
            </div>
            <input type="hidden" id="TaskId" name="TaskId" value="-1" />
        </div>

        <h1 class="task-title mb-3">
            <input type="text" class="form-control title-input" id="txtTaskName@(itemName)" name="txtTaskName@(itemName)" placeholder="請輸入任務名稱"
                    maxlength="50" autocomplete="off" />
        </h1>

        <div class="task-box mb-3">
            <ul class="task-list-area">
                <li class="task-list">
                    <span class="title">
                        參與人員
                    </span>
                    <span class="detail" id="desTaskUser@(itemName)"></span>
                    <a class="link update-task-member" href="javascript:void(0);">編輯成員</a>
                </li>
                <li class="task-list">
                    <span class="title">
                        任務描述
                    </span>
                    <input type="text" class="form-control detail-input" id="txtTaskDesc@(itemName)" name="txtTaskDesc@(itemName)" placeholder="請輸入任務描述"
                           maxlength="300" autocomplete="off" style="width: calc(100% - 81px);" />
                </li>
                <li class="task-list">
                    <span class="title">
                        回報頻率
                    </span>
                    <div class="time-block" style="width: calc(100% - 81px);">
                        <div class="input-group">
                            <input class="form-control text-right time-input" id="txtDayReplyFrequency@(itemName)" name="txtDayReplyFrequency@(itemName)" step="1" min="0" value="0" />
                            <span class="input-group-addon">天</span>
                            <input class="form-control text-right time-input" id="txtHourReplyFrequency@(itemName)" name="txtHourReplyFrequency@(itemName)" step="1" min="0" max="23" value="0" />
                            <span class="input-group-addon">小時</span>
                            <input class="form-control text-right time-input" id="txtMinuteReplyFrequency@(itemName)" name="txtMinuteReplyFrequency@(itemName)" step="1" min="0" max="59" value="0" />
                            <span class="input-group-addon">分</span>
                        </div>
                    </div>
                </li>

                <li class="task-list edit-item">
                    <div class="input-group input-group-sm mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="start-label">計畫時間</span>
                        </div>
                        <input type="text" class="form-control detail-input" id="txtPlannedStart@(itemName)" name="txtPlannedStart@(itemName)" style="width:95px;" autocomplete="off">
                        <div class="input-group-append read-item">
                            <span class="input-group-text">至</span>
                        </div>
                        <input type="text" class="form-control read-item" id="txtPlannedEnd@(itemName)" name="txtPlannedEnd@(itemName)" style="width:95px;" disabled>

                        <div class="input-group-append">
                            <span class="input-group-text"> 共</span>
                        </div>
                        <input class="form-control text-right time-input" id="txtDayPlannedDuration@(itemName)" name="txtDayPlannedDuration@(itemName)" step="1" min="0" value="0" />
                        <div class="input-group-append">
                            <span class="input-group-text">天</span>
                        </div>
                        <input class="form-control text-right time-input" id="txtHourPlannedDuration@(itemName)" name="txtHourPlannedDuration@(itemName)" step="1" min="0" max="23" value="0" />
                        <div class="input-group-append">
                            <span class="input-group-text">小時</span>
                        </div>
                        <input class="form-control text-right time-input" id="txtMinutePlannedDuration@(itemName)" name="txtMinutePlannedDuration@(itemName)" step="1" min="0" max="59" value="0" />
                        <div class="input-group-append">
                            <span class="input-group-text">分</span>
                        </div>
                    </div>
                </li>

                <li class="task-list read-item">
                    <div class="input-group input-group-sm mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">實際時間</span>
                        </div>
                        <input type="text" class="form-control" id="txtActualStart@(itemName)" name="txtActualStart@(itemName)" style="width:95px;" disabled>
                        <div class="input-group-append">
                            <span class="input-group-text">至</span>
                        </div>
                        <input type="text" class="form-control" id="txtActualEnd@(itemName)" name="txtActualEnd@(itemName)" style="width:95px;" disabled>

                        <div class="input-group-append">
                            <span class="input-group-text"> 共</span>
                        </div>
                        <input type="text" class="form-control text-right time-data" id="txtDayActualDuration@(itemName)" name="txtDayActualDuration@(itemName)" disabled>
                        <div class="input-group-append">
                            <span class="input-group-text">天</span>
                        </div>
                        <input type="text" class="form-control text-right time-data" id="txtHourActualDuration@(itemName)" name="txtHourActualDuration@(itemName)" disabled>
                        <div class="input-group-append">
                            <span class="input-group-text">小時</span>
                        </div>
                        <input type="text" class="form-control text-right time-data" id="txtMinuteActualDuration@(itemName)" name="txtMinuteActualDuration@(itemName)" disabled>
                        <div class="input-group-append">
                            <span class="input-group-text">分</span>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <div class="task-box">
            <div class="task-box-title">
                <h2>回報列表</h2>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="table-custom table-custom-sm">
                        <table class="table table-bordered table-striped table-sticky table-stack" id="tblReplyData@(itemName)" style="margin-top: 5px;">
                            <thead>
                                <tr>
                                    <th scope="col" style="min-width: 50px;">#</th>
                                    <th scope="col" style="min-width: 105px;">回報人員</th>
                                    <th scope="col" style="min-width: 145px;">回報時間</th>
                                    <th scope="col" style="min-width: 125px;">回報狀態</th>
                                    <th scope="col" style="min-width: 150px;">延後時間</th>
                                    <th scope="col" style="min-width: 200px;">延後原因</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pageReply@(itemName)"></div>
                </div>
            </div>
        </div>

        <div class="task-box">
            <div class="task-box-title">
                <h2>文件檔案</h2>
                <a class="link proj-auth-task-file-download" href="javascript:void(0);" onclick="Forbidden@(itemName)()">
                    <i class="far fa-arrow-alt-circle-down"></i>
                    全部下載
                </a>
            </div>
            <div class="row mb-2 proj-auth-task-file-upload">
                <div class="col-12">
                    <input type="file" id="fileTask@(itemName)" name="fileTask@(itemName)" multiple />
                    <input type="hidden" id="txtFileId@(itemName)" name="txtFileId@(itemName)" />
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="table-custom table-custom-sm">
                        <table class="table table-bordered table-striped table-sticky table-stack" id="tblFileData@(itemName)">
                            <thead>
                                <tr>
                                    <th scope="col" style="min-width: 50px;">#</th>
                                    <th scope="col" style="min-width: 250px;">檔案名稱</th>
                                    <th scope="col" style="min-width: 120px;">閱覽檔案等級</th>
                                    <th scope="col" style="min-width: 110px;">檔案類型</th>
                                    <th scope="col" style="min-width: 145px;">上傳時間</th>
                                    <th class="text-center" scope="col" style="min-width: 125px;">操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pageFile@(itemName)"></div>
                </div>
            </div>
        </div>

        <div class="task-box">
            <div class="message-board">
                <textarea class="form-control message-text" style="" id="txtTemplateDescTemplateManagement" name="txtTemplateDescTemplateManagement" rows="2" data-msg-required="請輸入樣板描述" data-rule-required="true"></textarea>
                <div class="subtask-list" style="border-bottom:0;justify-content:flex-end;">
                    <a class="subtask-link" href="javascript:void(0);" onclick="Forbidden@(itemName)()" style="margin-right: 15px;"> <i class="far fa-paperclip"></i></a>
                    <a class="subtask-link" href="javascript:void(0);" onclick="Forbidden@(itemName)()" style="padding:5px 15px; background:#005bff; color:#fff;">發送</a>
                </div>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let objForm@(itemName) = `#nav@(itemName)`;
        let objTaskId@(itemName) = `${objForm@(itemName)} #TaskId`;
        let taskType@(itemName) = `Personal`;
        let editFlag@(itemName) = false;

        let authority@(itemName);
        let canEdit@(itemName) = false;
        let canAdd@(itemName) = false;
        let canDelete@(itemName) = false;

        let Tasks@(itemName) = new TaskControl@(itemName)();
        let Datas@(itemName) = new DataControl@(itemName)();

        let calendarConfig@(itemName) = {
            dateFormat: "%Y-%m-%d",
            css: "dhx_widget--bordered"
        }

        let calendarS@(itemName) = new dhx.Calendar(null, calendarConfig@(itemName));
        let calendarE@(itemName) = new dhx.Calendar(null, calendarConfig@(itemName));
        let popupS@(itemName) = new dhx.Popup();
        let popupE@(itemName) = new dhx.Popup();
        let dateInputS@(itemName) = document.getElementById(`txtPlannedStart@(itemName)`);
        let dateInputE@(itemName) = document.getElementById(`txtPlannedEnd@(itemName)`);

        let objReplyPage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };
        let objFilePage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };

        function InitData@(itemName)(taskId) {
            $(objTaskId@(itemName)).val(taskId);
            SstTaskUserAuthority@(itemName)();

            if (parseInt(taskId)) {
                Tasks@(itemName).Initialize@(itemName)(`#nav@(itemName)`);
                Tasks@(itemName).LoadData@(itemName)();
            }
        }

        function EditData@(itemName)(taskId) {
            $(objTaskId@(itemName)).val(taskId);
            SstTaskUserAuthority@(itemName)();
            if (parseInt(taskId)) {
                Tasks@(itemName).Initialize@(itemName)(`#nav@(itemName)`);
                Tasks@(itemName).LoadData@(itemName)();
                SwitchInput@(itemName)(true);
            }
        }

        function TaskControl@(itemName)() {
            addMethod(this, "Initialize@(itemName)", function (targetSelector) {
                $(targetSelector).addClass("active");

                //#region 預計時間套件
                dhx.i18n.setLocale("calendar", calendarLocales);
                dhx.i18n.setLocale("timepicker", timepickerLocales);

                //#region 開始時間
                calendarS@(itemName).destructor();
                calendarS@(itemName) = new dhx.Calendar(null, calendarConfig@(itemName));

                popupS@(itemName).destructor();
                popupS@(itemName) = new dhx.Popup();
                popupS@(itemName).attach(calendarS@(itemName));

                calendarS@(itemName).events.on("change", function () {
                    dateInputS@(itemName).value = calendarS@(itemName).getValue();
                    dateInputS@(itemName).dispatchEvent(eventChange);
                    popupS@(itemName).hide();
                });

                let functionAS = function () {
                    popupS@(itemName).show(dateInputS@(itemName));
                };

                dateInputS@(itemName).removeEventListener("click", functionAS, false);
                dateInputS@(itemName).addEventListener("click", functionAS, false);
                //#endregion

                //#region 完成時間
                calendarE@(itemName).destructor();
                calendarE@(itemName) = new dhx.Calendar(null, calendarConfig@(itemName));

                popupE@(itemName).destructor();
                popupE@(itemName) = new dhx.Popup();
                popupE@(itemName).attach(calendarE@(itemName));

                calendarE@(itemName).events.on("change", function () {
                    dateInputE@(itemName).value = calendarE@(itemName).getValue();
                    dateInputE@(itemName).dispatchEvent(eventChange);
                    popupE@(itemName).hide();
                });

                let functionAE = function () {
                    popupE@(itemName).show(dateInputE@(itemName));
                };

                dateInputE@(itemName).removeEventListener("click", functionAE, false);
                dateInputE@(itemName).addEventListener("click", functionAE, false);
                //#endregion

                //#endregion

                //#region 檔案上傳套件
                let uploadConfig = {
                    fileSelector: "#fileTask@(itemName)",
                    targetSelector: "#txtFileId@(itemName)",
                    required: false,
                    uploadPath: "/Task/TaskFile",
                    maxFileCount: 5
                };

                let uploadSetting = {
                    theme: "fas",
                    language: "zh-TW",
                    showCaption: true,
                    showPreview: true,
                    showRemove: false,
                    showUpload: false,
                    showCancel: false,
                    uploadUrl: "/Web/Upload",
                    uploadAsync: true,
                    minFileCount: (uploadConfig.required ? 1 : 0),
                    maxFileCount: uploadConfig.maxFileCount,
                    validateInitialCount: true,
                    overwriteInitial: false,
                    initialPreviewAsData: true,
                    browseOnZoneClick: true,
                    uploadExtraData: {
                        savePath: uploadConfig.uploadPath,
                        isPreview: false
                    },
                    previewFileIconSettings: {
                        doc: '<i class="fas fa-file-word" style="color: #0078d7;"></i>',
                        docx: '<i class="fas fa-file-word" style="color: #0078d7;"></i>',
                        xls: '<i class="fas fa-file-excel" style="color: #1d6f42;"></i>',
                        xlsx: '<i class="fas fa-file-excel" style="color: #1d6f42;"></i>',
                        csv: '<i class="fas fa-file-csv" style="color: #1d6f42;"></i>',
                        ppt: '<i class="fas fa-file-powerpoint" style="color: #d04423"></i>',
                        pptx: '<i class="fas fa-file-powerpoint" style="color: #d04423"></i>'
                    }
                };

                $(uploadConfig.fileSelector).fileinput('destroy');
                $(uploadConfig.fileSelector).fileinput(uploadSetting)
                    .off('filebatchselected')
                    .on('filebatchselected', function (event, files) {
                        $(uploadConfig.fileSelector).fileinput("upload");
                    })
                    .off('fileuploaded')
                    .on('fileuploaded', function (event, previewId, index, fileId) {
                        let uploadPath = previewId.response.initialPreviewConfig[0]["key"];
                        $(uploadConfig.fileSelector).fileinput('clear');

                        let targetUrl = "@Url.Action("AddPersonalTaskFile", "Task")";
                        let postData = {
                            "PersonalTaskId": $(objTaskId@(itemName)).val(),
                            "FileId": uploadPath,
                        };

                        let result = DataAccess.Add(targetUrl, postData, false, false);

                        if (result) {
                            Datas@(itemName).GetPersonalTaskFile@(itemName)(objFilePage@(itemName));
                        }
                    });
                //#endregion

                $(`${targetSelector} .title-input, ${targetSelector} .detail-input, ${targetSelector} .time-input`).off("change");

                $(targetSelector).find(".nav-close").off("click").on("click", function (e) {
                    $(".task-nav").removeClass("active");
                });

                $(targetSelector).find(".nav-menu").off("click").on("click", function (e) {
                    $(targetSelector).find(".set-block").toggleClass("hide");
                });

                $(targetSelector).find(".manual-closed").off("click").on("click", function (e) {
                    Forbidden@(itemName)();
                });

                $(targetSelector).find(".update-task-member").off("click").on("click", function (e) {
                    PopViewTaskUser($(objTaskId@(itemName)).val(), taskType@(itemName));
                });

                //複製任務
                $(targetSelector).find(".copy-task").off("click").on("click", function (e) {
                    Datas@(itemName).CopyPersonalTask@(itemName)(-1);
                });

                //新增任務
                @*$(targetSelector).find(".add-link-task").off("click").on("click", function (e) {
                    AddTask@(itemName)($(objTaskId@(itemName)).val());
                });*@

                //刪除任務
                $(targetSelector).find(".delete-task").off("click").on("click", function (e) {
                    Datas@(itemName).DeletePersonalTask@(itemName)(-1);
                });

                //編輯任務
                $(targetSelector).find(".update-task").off("click").on("click", function (e) {
                    SwitchInput@(itemName)(!editFlag@(itemName));
                    @*editFlag@(itemName) = !editFlag@(itemName);*@
                });

                $("body").off("click").on("click", function (e) {
                    if ($(targetSelector).hasClass("active")) {
                        if (!$(e.target).parents().hasClass("task-nav")
                            && !$(e.target).hasClass("swal2-container")
                            && !$(e.target).hasClass("modal")
                            && !$(e.target).hasClass("file-drop-zone-title")
                            && !$(e.target).parents().hasClass("swal2-container")
                            && !$(e.target).parents().hasClass("select2-container")
                            && !$(e.target).parents().hasClass("modal")
                            && !$(e.target).parents().hasClass("dhx_popup")
                            && !$(e.target).hasClass("auth-add") //新增個人任務按鈕
                        ) {
                            $(".task-nav").removeClass("active");
                            newEvent = {};
                            //$(`div[data-id="${newEvent.id}"]`).hide();
                        }
                    }
                    if (!$(targetSelector).find(".set-block").hasClass("hide") && !$(e.target).hasClass("nav-menu")) {
                        if (!$(e.target).parents().hasClass("set-block")) {
                            $(".set-block").addClass("hide");
                        }
                    }
                });
            });

            addMethod(this, "LoadData@(itemName)", function () {
                $(`${objForm@(itemName)} .detail`).html("");
                $("#tblFileData@(itemName) tbody").html("");
                $(`${objForm@(itemName)} .title-input, ${objForm@(itemName)} .detail-input, ${objForm@(itemName)} .time-input`).val("");

                let taskId = parseInt($(objTaskId@(itemName)).val());
                if (taskId > 0) {
                    Datas@(itemName).GetPersonalTask@(itemName)();
                    Datas@(itemName).GetTaskReply@(itemName)(objReplyPage@(itemName));
                    Datas@(itemName).GetPersonalTaskFile@(itemName)(objFilePage@(itemName));

                    $(`${objForm@(itemName)} .title-input, ${objForm@(itemName)} .detail-input, ${objForm@(itemName)} .time-input`).on("change", function (e) {
                        Datas@(itemName).UpdatePersonalTask@(itemName)(taskId);
                    });
                    SwitchInput@(itemName)(false);
                    @*$(`${objForm@(itemName)} .read-item`).show();
                    $(`${objForm@(itemName)} .title-input, ${objForm@(itemName)} .detail-input, ${objForm@(itemName)} .time-input`).attr(`disabled`, true);*@
                    $(`${objForm@(itemName)} .copy-task, ${objForm@(itemName)} .update-task, ${objForm@(itemName)} .delete-task`).show();

                }
                else {
                    $(`${objForm@(itemName)} .title-input`).on("change", function (e) {
                        Datas@(itemName).AddPersonalTask@(itemName)();
                    });
                    SwitchInput@(itemName)(true);
                    @*$(`${objForm@(itemName)} .read-item`).hide();
                    $(`${objForm@(itemName)} .title-input, ${objForm@(itemName)} .detail-input, ${objForm@(itemName)} .time-input`).removeAttr(`disabled`);*@
                    $(`${objForm@(itemName)} .copy-task, ${objForm@(itemName)} .update-task, ${objForm@(itemName)} .delete-task`).hide();
                }
            });

            //#region 刷新背景頁
            addMethod(this, "LoadViewData@(itemName)", function () {
                switch (viewType) {
                    case "personal":
                        switch (viewMode2) {
                            case "checklist2":
                                InitDataTaskPersonalList(); //個人任務列表
                                break;
                        }
                        break;
                    case "calendar":
                        InitDataTaskCalendar();
                        break;
                }

            });
            //#endregion
        }

        function DataControl@(itemName)() {
            addMethod(this, "GetPersonalTask@(itemName)", function () {
                let targetUrl = "@Url.Action("GetPersonalTask", "Task")";
                let postData = {
                    "PersonalTaskId": $(objTaskId@(itemName)).val()
                };
                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    $.each(data.result, function (i, item) {

                        $(`#txtTaskName@(itemName)`).val(item.TaskName);
                        $(`#desTaskUser@(itemName)`).html(item.TaskUser);
                        $(`#txtTaskDesc@(itemName)`).val(item.TaskDesc);

                        let replyFrequency = parseInt(item.ReplyFrequency);
                        let days = parseInt(replyFrequency / 60 / 24);
                        let hours = parseInt((replyFrequency % (60 * 24)) / 60);
                        let minutes = parseInt(replyFrequency % 60);

                        $("#txtDayReplyFrequency@(itemName)").val(days);
                        $("#txtHourReplyFrequency@(itemName)").val(hours);
                        $("#txtMinuteReplyFrequency@(itemName)").val(minutes);

                        let duration = parseInt(item.PlannedDuration);
                        days = parseInt(duration / 60 / 24);
                        hours = parseInt((duration - days * 24 * 60) / 60);
                        minutes = parseInt(duration - (days * 24 * 60) - (hours * 60));

                        $(`#txtPlannedStart@(itemName)`).val(item.PlannedStart);
                        $(`#txtPlannedEnd@(itemName)`).val(item.PlannedEnd);
                        $(`#txtDayPlannedDuration@(itemName)`).val(days);
                        $(`#txtHourPlannedDuration@(itemName)`).val(hours);
                        $(`#txtMinutePlannedDuration@(itemName)`).val(minutes);

                        //日期選擇預設值
                        @*calendarPS@(itemName).setValue(item.EstimateStart);*@

                        duration = parseInt(item.ActualDuration);
                        days = parseInt(duration / 60 / 24);
                        hours = parseInt((duration - days * 24 * 60) / 60);
                        minutes = parseInt(duration - (days * 24 * 60) - (hours * 60));
                        $(`#txtActualStart@(itemName)`).val(item.ActualStart);
                        $(`#txtActualEnd@(itemName)`).val(item.ActualEnd);
                        $("#txtDayActualDuration@(itemName)").val(days);
                        $("#txtHourActualDuration@(itemName)").val(hours);
                        $("#txtMinuteActualDuration@(itemName)").val(minutes);
                    });
                } else {
                    alert(data.msg, "alert", 0);
                }
            });

            addMethod(this, "GetTaskReply@(itemName)", function (objPage) {
                let innerHtml = ``;
                let pageCount = 0;

                let targetUrl = "@Url.Action("GetTaskReply", "Task")";
                let postData = {
                    "OrderBy": "",
                    "PageIndex": (objPage.pageIndex + 1),
                    "PageSize": objPage.pageSize,
                    "TaskId": $(objTaskId@(itemName)).val(),
                    "ReplyType": taskType@(itemName)
                };
                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;

                    if (pageCount > 0) {
                        $.each(data.result, function (i, item) {
                            let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";

                            let days = parseInt(item.DeferredDuration / 60 / 24);
                            let hours = parseInt((item.DeferredDuration % (60 * 24)) / 60);
                            let minutes = parseInt(item.DeferredDuration % 60);

                            let deferredDuration = `${days > 0 ? `${days} 天` : ``} ${hours > 0 ? `${hours} 小時` : ``} ${minutes > 0 ? `${minutes} 分` : ``}`;

                            innerHtml += `<tr>
                                            <td><span class="stack-title">#</span>${_row}</td>
                                            <td><span class="stack-title">回報人員</span>${item.LogoIcon == -1 ? `` : `<img class="company-logo" src="/Web/GetFile?fileId=${item.LogoIcon}" />`}${item.ReplyUserName}</td>
                                            <td><span class="stack-title">回報時間</span>${item.ReplyDate}</td>
                                            <td><span class="stack-title">回報狀態</span>${StatusUI(item.EventDate)} ${StatusName(`TaskReply.ReplyStatus`, item.ReplyStatus)}</td>
                                            <td><span class="stack-title">延後時間</span>${deferredDuration}</td>
                                            <td class="ellipsis" data-toggle="tooltip" title = "${item.ReplyContent}" style="max-width: 200px;"><span class="stack-title">延後原因</span>${item.ReplyContent}</td>
                                          </tr>`;
                        });
                    }
                    else {
                        innerHtml = `<tr><td class="text-center" colspan="6" style="background-color: #fff3cd;"><i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。</td></tr>`;
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                $("#tblReplyData@(itemName) tbody").html(innerHtml);
                TableComponentInit();
                Pager("#pageReply@(itemName)", pageCount, objPage, Datas@(itemName).GetTaskReply@(itemName));

                function StatusUI(status) {
                    let html = "";

                    switch (status) {
                        case "D":
                            html = `<span class="blink text-danger"><i class="fas fa-siren-on"></i></span>`;
                            break;
                    }
                    return html;
                }
            });

            addMethod(this, "GetPersonalTaskFile@(itemName)", function (objPage) {
                let innerHtml = ``;
                let pageCount = 0;

                let targetUrl = "@Url.Action("GetPersonalTaskFile", "Task")";
                let postData = {
                    "PersonalTaskId": $(objTaskId@(itemName)).val()
                };
                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    //pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;
                    let _row = 0;

                    if (data.result.length > 0) {
                        $.each(data.result, function (i, item) {
                            if (item.SourceType == "T") {
                                //let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";
                                _row++;

                                innerHtml += `<tr>
                                                <td><span class="stack-title">#</span>${_row}</td>
                                                <td class="active-content ellipsis" data-toggle="tooltip" title="${item.FileName}${item.FileExtension}" style="max-width: 250px;">
                                                  <span class="stack-title">檔案名稱</span>
                                                  <a class="active-link proj-auth-task-file-download" href="/Task/DownloadTaskFile?fileId=${item.FileId}&TaskId=${$(objTaskId@(itemName)).val()}&TaskType=${taskType@(itemName)}" target="_blank"><i class="fas fa-download"></i><span>下載</span></a>
                                                  ${item.FileName}${item.FileExtension}
                                                </td>
                                                <td>
                                                  <span class="stack-title">閱覽檔案等級</span>
                                                    ${canEdit@(itemName) ? `<select class="form-control detail-input" name="cboLevelId@(itemName)" data-personal-task-file-id="${item.PersonalTaskFileId}" data-level-id="${item.LevelId}"></select>` : `${item.LevelName}`}
                                                </td>
                                                <td>
                                                  <span class="stack-title">檔案類型</span>${canEdit@(itemName) ? `<select class="form-control detail-input" name="cboFileType@(itemName)" data-personal-task-file-id="${item.PersonalTaskFileId}" data-filetype="${item.FileType}"></select>` : `${TypeName(`ProjectFile.FileType`, item.FileType)}`}
                                                </td>
                                                <td><span class="stack-title">上傳時間</span>${item.CreateDate}</td>
                                                <td class="text-center active-content">
                                                  <span class="stack-title">操作</span>
                                                    ${canDelete@(itemName) ? `<a class="active-link proj-auth-task-file-delete" href="javascript:Datas@(itemName).DeletePersonalTaskFile@(itemName)(${item.PersonalTaskFileId});"><i class="fas fa-trash-alt"></i></a>` : ``}
                                                </td>
                                              </tr>`;
                            }
                        });
                    }
                    else {
                        innerHtml = `<tr><td class="text-center" colspan="6" style="background-color: #fff3cd;"><i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。</td></tr>`;
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                $("#tblFileData@(itemName) tbody").html(innerHtml);
                TableComponentInit();
                Pager("#pageFile@(itemName)", pageCount, objPage, Datas@(itemName).GetPersonalTaskFile@(itemName));

                ComboBoxs.Default("select[name=cboLevelId@(itemName)]", "@Url.Action("GetFileLevel", "PmisBasicInformation")", { "Status": "A" }, "", "CHOOSE-NUMBER", "", "LevelName", "LevelId");
                ComboBoxs.Default("select[name=cboFileType@(itemName)]", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "ProjectFile.FileType" }, "", "CHOOSE", "", "TypeName", "TypeNo");

                $("select[name=cboLevelId@(itemName)]").each(function () {
                    $(this).val($(this).data("level-id"));
                });

                $("select[name=cboFileType@(itemName)]").each(function () {
                    $(this).val($(this).data("filetype"));
                });

                $("select[name=cboLevelId@(itemName)]").off("change").on("change", function () {
                    let personalTaskFileId = $(this).data("personal-task-file-id");

                    let targetUrl = "@Url.Action("UpdatePersonalTaskFileLevel", "Task")";
                    let postData = {
                        "PersonalTaskFileId": personalTaskFileId,
                        "LevelId": $(`select[name=cboLevelId@(itemName)][data-personal-task-file-id=${personalTaskFileId}]`).val()
                    };

                    let result = DataAccess.Update(targetUrl, postData, false, false);

                    if (result) {
                        Datas@(itemName).GetPersonalTaskFile@(itemName)();
                    }
                });

                $("select[name=cboFileType@(itemName)]").off("change").on("change", function () {
                    let personalTaskFileId = $(this).data("personal-task-file-id");

                    let targetUrl = "@Url.Action("UpdatePersonalTaskFileType", "Task")";
                    let postData = {
                        "PersonalTaskFileId": personalTaskFileId,
                        "FileType": $(`select[name=cboFileType@(itemName)][data-personal-task-file-id=${personalTaskFileId}]`).val()
                    };

                    let result = DataAccess.Update(targetUrl, postData, false, false);

                    if (result) {
                        Datas@(itemName).GetPersonalTaskFile@(itemName)();
                    }
                });

                if (!isMobile) {
                    $("select[name=cboLevelId@(itemName)], select[name=cboFileType@(itemName)]").select2({
                        dropdownAutoWidth: true,
                        width: "100%"
                    });
                }
            });

            addMethod(this, "AddPersonalTask@(itemName)", function () {
                let days = parseInt($("#txtDayPlannedDuration@(itemName)").val() ? $("#txtDayPlannedDuration@(itemName)").val() : 0) * 24 * 60;
                let hours = parseInt($("#txtHourPlannedDuration@(itemName)").val() ? $("#txtHourPlannedDuration@(itemName)").val() : 0) * 60;
                let minutes = parseInt($("#txtMinutePlannedDuration@(itemName)").val() ? $("#txtMinutePlannedDuration@(itemName)").val() : 0);
                let plannedDuration = days + hours + minutes;

                days = parseInt($("#txtDayReplyFrequency@(itemName)").val() ? $("#txtDayReplyFrequency@(itemName)").val() : 0) * 24 * 60;
                hours = parseInt($("#txtHourReplyFrequency@(itemName)").val() ? $("#txtHourReplyFrequency@(itemName)").val() : 0) * 60;
                minutes = parseInt($("#txtMinuteReplyFrequency@(itemName)").val() ? $("#txtMinuteReplyFrequency@(itemName)").val() : 0);
                let replyFrequency = days + hours + minutes;

                let targetUrl = "@Url.Action("AddPersonalTask", "Task")";
                let postData = {
                    "TaskName": $("#txtTaskName@(itemName)").val(),
                    "TaskDesc": $("#txtTaskDesc@(itemName)").val(),
                    "PlannedStart": !newEvent ? newEvent.start_date.Format("yyyy-MM-dd") : $("#txtPlannedStart@(itemName)").val(),
                    "PlannedDuration": plannedDuration,
                    "ReplyFrequency": replyFrequency,
                };

                let data = DataAccess.EditContinued(targetUrl, postData, false);

                if (data) {
                    $.each(data.result, function (i, item) {
                        EditData@(itemName)(item.PersonalTaskId);
                    });
                    Tasks@(itemName).LoadViewData@(itemName)();
                }
            });

            addMethod(this, "CopyPersonalTask@(itemName)", function (taskId) {
                taskId = taskId == -1 ? $(objTaskId@(itemName)).val() : taskId;
                swal.fire({
                    titleText: "確認要複製嗎?",
                    text: "",
                    icon: "question",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#87adbd',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        let targetUrl = '@Url.Action("AddPersonalTaskByCopy", "Task")';
                        let postData = {
                            "PersonalTaskId": taskId
                        };
                        let result = DataAccess.Add(targetUrl, postData, false, false);
                        if (result) {
                            alert('複製完成', 'success', 0);
                            Tasks@(itemName).LoadViewData@(itemName)();
                        }
                    }
                });
            });

            addMethod(this, "UpdatePersonalTask@(itemName)", function (taskId) {
                taskId = taskId == -1 ? $(objTaskId@(itemName)).val() : taskId;
                let days = parseInt($("#txtDayPlannedDuration@(itemName)").val() ? $("#txtDayPlannedDuration@(itemName)").val() : 0) * 24 * 60;
                let hours = parseInt($("#txtHourPlannedDuration@(itemName)").val() ? $("#txtHourPlannedDuration@(itemName)").val() : 0) * 60;
                let minutes = parseInt($("#txtMinutePlannedDuration@(itemName)").val() ? $("#txtMinutePlannedDuration@(itemName)").val() : 0);
                let plannedDuration = days + hours + minutes;

                days = parseInt($("#txtDayReplyFrequency@(itemName)").val() ? $("#txtDayReplyFrequency@(itemName)").val() : 0) * 24 * 60;
                hours = parseInt($("#txtHourReplyFrequency@(itemName)").val() ? $("#txtHourReplyFrequency@(itemName)").val() : 0) * 60;
                minutes = parseInt($("#txtMinuteReplyFrequency@(itemName)").val() ? $("#txtMinuteReplyFrequency@(itemName)").val() : 0);
                let replyFrequency = days + hours + minutes;

                let targetUrl = "@Url.Action("UpdatePersonalTask", "Task")";
                let postData = {
                    "PersonalTaskId": taskId,
                    "TaskName": $("#txtTaskName@(itemName)").val(),
                    "TaskDesc": $("#txtTaskDesc@(itemName)").val(),
                    "PlannedStart": $("#txtPlannedStart@(itemName)").val(),
                    "PlannedDuration": plannedDuration,
                    "ReplyFrequency": replyFrequency
                };

                let result = DataAccess.Update(targetUrl, postData, false, false);

                if (result) {
                    Tasks@(itemName).LoadViewData@(itemName)();
                }
            });

            addMethod(this, "DeletePersonalTask@(itemName)", function (taskId) {
                taskId = taskId == -1 ? $(objTaskId@(itemName)).val() : taskId;
                swal.fire({
                    titleText: "確認要刪除嗎?",
                    text: "此動作無法復原，請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        let targetUrl = "@Url.Action("DeletePersonalTask", "Task")";
                        let postData = {
                            "PersonalTaskId": taskId
                        };

                        let result = DataAccess.Delete(targetUrl, postData, false, true);

                        if (result) {
                            $(".task-nav").removeClass("active");
                        }
                        Tasks@(itemName).LoadViewData@(itemName)();
                    }
                });
            });

            addMethod(this, "DeletePersonalTaskFile@(itemName)", function (PersonalTaskFileId) {
                swal.fire({
                    titleText: "確認要刪除嗎?",
                    text: "此動作無法復原，請確認是否要執行!",
                    icon: "warning",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        let targetUrl = "@Url.Action("DeletePersonalTaskFile", "Task")";
                        let postData = {
                            "PersonalTaskFileId": PersonalTaskFileId
                        };

                        let result = DataAccess.Delete(targetUrl, postData, false, true);

                        if (result) {
                            Datas@(itemName).GetPersonalTaskFile@(itemName)(objFilePage@(itemName));
                        }
                    }
                });
            });
        }

        function SwitchInput@(itemName)(flag) {
            editFlag@(itemName) = flag;
            if (!flag) {
                $(`${objForm@(itemName)} .update-task`).html(`<i class="fas fa-edit"></i>切換編輯`)
                $(`${objForm@(itemName)} .read-item`).show();
                $(`${objForm@(itemName)} .time-input`).removeAttr(`type`);
                $(`${objForm@(itemName)} .title-input, ${objForm@(itemName)} .detail-input, ${objForm@(itemName)} .time-input`).attr(`disabled`, true);

            }
            else {
                $(`${objForm@(itemName)} .update-task`).html(`<i class="fas fa-lock"></i>鎖定`)
                $(`${objForm@(itemName)} .read-item`).hide();
                $(`${objForm@(itemName)} .time-input`).attr(`type`,`number`);
                $(`${objForm@(itemName)} .title-input, ${objForm@(itemName)} .detail-input, ${objForm@(itemName)} .time-input`).removeAttr(`disabled`);
            }
        }

        function SstTaskUserAuthority@(itemName)() {
            let taskId = parseInt($(objTaskId@(itemName)).val());
            let targetUrl = "@Url.Action("GetTaskUserAuthority", "Task")";
            let postData = {
                "TaskId": taskId,
                "TaskType": taskType@(itemName)
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                $(`#projectAuthority`).val(JSON.stringify(data.result));

                //let isChange = getObjects(JSON.parse($("#projectAuthority").val()), "AuthorityCode", "change")[0].Authority;
                let isChange = data.result.filter(f => f.AuthorityCode === 'change' && f.Authority === 1).length > 0;

                canEdit@(itemName) = data.result.filter(f => f.AuthorityCode === 'task-member-update' && f.Authority === 1).length > 0;
                canAdd@(itemName) = data.result.filter(f => f.AuthorityCode === 'task-member-add' && f.Authority === 1).length > 0;
                canDelete@(itemName) = data.result.filter(f => f.AuthorityCode === 'task-member-delete' && f.Authority === 1).length > 0;

                if (taskId < 0) {
                    canAdd@(itemName) = true;
                }

                ProjectAuthorityControl();

            } else {
                alert(data.msg, "alert", 0);
            }
        }

        function Forbidden@(itemName)() {
            swal.fire({
                title: "功能尚未開放!",
                icon: "error"
            });
        }
</script>
)