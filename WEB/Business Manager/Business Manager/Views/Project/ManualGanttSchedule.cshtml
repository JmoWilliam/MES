@using Business_Manager.Helpers
@{
    string parentName = "ProjectTaskGantt";
    string itemName = "ManualGanttSchedule";
}

@Html.Resource("css",
    @<style>
    </style>
)

@*<div class="gantt-body" id="gantt@(itemName)" style="height: 500px; opacity: 0; position: absolute; z-index: -1;"></div>*@

@Html.Resource("js",
    @<script>
        let targetItem@(itemName); //目標名稱
        let projectId@(itemName) = -1; //專案id
        let projectTaskId@(itemName) = -1; //任務id

        function InitData@(itemName)(projectId, itemName, gantt@(itemName)) {
            targetItem@(itemName) = itemName;
            projectId@(itemName) = projectId;
            projectTaskId@(itemName) = -1;

            Gantt@(itemName)(gantt@(itemName));
        }

        function Gantt@(itemName)(gantt@(itemName)) {

            //#region 時間格式組態檔
            let dateToStr = gantt@(itemName).date.date_to_str("%Y-%m-%d"); //日期格式
            let dateOfWeekToStr = gantt@(itemName).date.date_to_str("%Y-%m-%d (%D)"); //日期格式(含星期)
            let datetimeToStr = gantt@(itemName).date.date_to_str("%Y-%m-%d %H:%i"); //日期時間格式
            let timeToStr = gantt@(itemName).date.date_to_str("%H:%i"); //時間格式
            //#endregion

            @*//#region 檢視組態檔
            let minuteFormat = function (step) {
                return function (date) {
                    var intervalEnd = new Date(gantt@(itemName).date.add(date, step, "minute") - 1);
                    return timeToStr(date);
                };
            };

            let minuteRangeFormat = function (step) {
                return function (date) {
                    var intervalEnd = new Date(gantt@(itemName).date.add(date, step, "minute") - 1);
                    return timeToStr(date) + " - " + timeToStr(intervalEnd);
                };
            };

            let hourFormat = function (step) {
                return function (date) {
                    var intervalEnd = new Date(gantt@(itemName).date.add(date, step, "hour") - 1);
                    return timeToStr(date);
                };
            };

            let hourRangeFormat = function (step) {
                return function (date) {
                    var intervalEnd = new Date(gantt@(itemName).date.add(date, step, "hour") - 1);
                    return timeToStr(date) + " - " + timeToStr(intervalEnd);
                };
            };

            let zoomConfig = {
                levels: [
                    {
                        name: "half-hour",
                        scale_height: 70,
                        min_column_width: 70,
                        scales: [
                            { unit: "day", step: 1, format: "%m月%d日" },
                            { unit: "minute", step: 30, format: minuteFormat(30) }
                        ]
                    },
                    {
                        name: "hour",
                        scale_height: 70,
                        min_column_width: 70,
                        scales: [
                            { unit: "day", step: 1, format: "%m月%d日 (%D)" },
                            { unit: "hour", step: 1, format: "%H:%i" }
                        ]
                    },
                    {
                        name: "day",
                        scale_height: 70,
                        min_column_width: 110,
                        scales: [
                            { unit: "week", step: 1, format: "%Y年 第%w週" },
                            { unit: "day", step: 1, format: "%m月%d日 (%D)" }
                        ]
                    },
                    {
                        name: "week",
                        scale_height: 70,
                        min_column_width: 100,
                        scales: [
                            { unit: "month", step: 1, format: "%Y年 %F" },
                            { unit: "week", step: 1, format: "第%w週" }
                        ]
                    },
                    {
                        name: "month",
                        scale_height: 70,
                        min_column_width: 100,
                        scales: [
                            { unit: "year", step: 1, format: "%Y年" },
                            { unit: "month", step: 1, format: "%F" }
                        ]
                    },
                    {
                        name: "quarter",
                        scale_height: 70,
                        min_column_width: 150,
                        scales: [
                            { unit: "year", step: 1, format: "%Y年" },
                            {
                                unit: "quarter", step: 1, format: function (date) {
                                    var dateToStr = gantt@(itemName).date.date_to_str("%F");
                                    var endDate = gantt@(itemName).date.add(gantt@(itemName).date.add(date, 3, "month"), -1, "day");
                                    return dateToStr(date) + " ~ " + dateToStr(endDate);
                                }
                            }
                        ]
                    }
                ]
            };
            gantt@(itemName).ext.zoom.init(zoomConfig); //設定檢視
            gantt@(itemName).ext.zoom.setLevel($(`input[name='rdoScale${targetItem@(itemName)}']:checked`).val());
            console.log($(`input[name='rdoScale${targetItem@(itemName)}']:checked`).val());
            //#endregion

            //#region 版面配置組態檔
            let layoutConfig = {
                css: "gantt_container",
                cols: [
                    {
                        width: 500,
                        rows: [
                            { view: "grid", scrollX: "gridScroll", scrollable: true, scrollY: "scrollVer" },
                            { view: "scrollbar", id: "gridScroll", group: "horizontal" }
                        ]
                    },
                    { resizer: false, width: 1 },
                    {
                        rows: [
                            { view: "timeline", scrollX: "scrollHor", scrollY: "scrollVer" },
                            { view: "scrollbar", id: "scrollHor", group: "horizontal" }
                        ]
                    },
                    { view: "scrollbar", id: "scrollVer" }
                ]
            }
            gantt@(itemName).config.layout = layoutConfig; //設定版面配置
            //#endregion*@

            //#region 欄位組態檔
            let columnsConfig = [
                { name: "text", tree: true, width: '*', min_width: 250, resize: true },
                {
                    name: "task_status", label: "操作", width: 75, min_width: 75, max_width: 75, resize: true, template: function (obj) {
                        let output = ``;
                        switch (obj.task_status) {
                            case null:
                                output = `<a href="javascript:void(0);" id="dropdownMenu${obj.id}" data-toggle="dropdown" style="font-size: 18px;"><i class="fas fa-edit"></i></a>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu${obj.id}" style="font-size: 18px;">
                                        ${canAdd ? `<a class="dropdown-item add-link-task" href="javascript:AddViewProjectTask({ ProjectTaskId: -1, ParentTaskId: ${parseFloat(obj.id)} })"><i class="fas fa-plus"></i>新增</a>` : ``}
                                    </ul>`;
                                break;
                            case "B": //待處理 //<i class="fas fa-trash-alt delete-task" style="color: #A23;"></i>
                                output = `<i class="far fa-stop-circle" style="font-size: 18px; color: #e0e0e0;"></i>
                                    <a href="javascript:void(0);" id="dropdownMenu${obj.id}" data-toggle="dropdown" style="font-size: 18px;"><i class="fas fa-edit"></i></a>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu${obj.id}" style="font-size: 18px;">
                                        ${canCopy ? `<a class="dropdown-item copy-task" href="javascript:CopyViewProjectTask({ ProjectTaskId: ${parseInt(obj.id)}, ParentTaskId: -1 })"><i class="fas fa-copy"></i>複製</a>` : ``}
                                        ${canAdd ? `<a class="dropdown-item add-link-task" href="javascript:AddViewProjectTask({ ProjectTaskId: -1, ParentTaskId: ${parseInt(obj.id)} })"><i class="fas fa-plus"></i>新增</a>` : ``}
                                        ${canDelete ? `<a class="dropdown-item ${!canDelete ? `btn_hide` : ``} delete-task" href="javascript:DeleteViewProjectTask({ ProjectTaskId: ${parseInt(obj.id)}, ParentTaskId: -1 })"><i class="fas fa-trash-alt"></i>刪除</a>` : ``}
                                    </ul>`;
                                break;
                            case "I": //進行中
                                output = `<i class="far fa-play-circle" style="font-size: 18px; color: #ffa700;"></i>
                                    <a href="javascript:void(0);" id="dropdownMenu${obj.id}" data-toggle="dropdown" style="font-size: 18px;"><i class="fas fa-edit"></i></a>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu${obj.id}" style="font-size: 18px;">
                                        ${canCopy ? `<a class="dropdown-item copy-task" href="javascript:CopyViewProjectTask({ ProjectTaskId: ${parseInt(obj.id)}, ParentTaskId: -1 })"><i class="fas fa-copy"></i>複製</a>` : ``}
                                        ${canAdd ? `<a class="dropdown-item add-link-task" href="javascript:AddViewProjectTask({ ProjectTaskId: -1, ParentTaskId: ${parseInt(obj.id)} })"><i class="fas fa-plus"></i>新增</a>` : ``}
                                    </ul>`;
                                break;
                            case "T": //待檢驗
                                break;
                            case "C": //已完成
                                output = `<i class="far fa-flag-checkered" style="font-size: 18px; color: #228b22;"></i>
                                    <a href="javascript:void(0);" id="dropdownMenu${obj.id}" data-toggle="dropdown" style="font-size: 18px;"><i class="fas fa-edit"></i></a>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu${obj.id}" style="font-size: 18px;">
                                        ${canCopy ? `<a class="dropdown-item copy-task" href="javascript:CopyViewProjectTask({ ProjectTaskId: ${parseInt(obj.id)}, ParentTaskId: -1 })"><i class="fas fa-copy"></i>複製</a>` : ``}
                                        ${canAdd ? `<a class="dropdown-item add-link-task" href="javascript:AddViewProjectTask({ ProjectTaskId: -1, ParentTaskId: ${parseInt(obj.id)} })"><i class="fas fa-plus"></i>新增</a>` : ``}
                                    </ul>`;
                                break;
                            default:
                                break;
                        }
                        return output;
                    }
                },
                {
                    name: "sub_user", label: "成員數", width: 75, min_width: 75, max_width: 75, resize: true, template: function (obj) {
                        return `<p style="text-align: right; color: #07F;">${obj.sub_user}</p>`;
                    }
                },
                {
                    name: "start_date", align: "center", width: 130, min_width: 130, max_width: 130, resize: true, template: function (obj) {
                        if (datetimeToStr(obj.planned_start) != datetimeToStr(obj.start_date)) {
                            return `<span style="display: inline-block; line-height: 20px;">
                                        <span style="text-decoration: line-through; color: #aaa; font-size: 12px;">${datetimeToStr(obj.planned_start)}</span>
                                        <br /><span>${datetimeToStr(obj.start_date)}</span>
                                    </span>`;
                        } else {
                            return `${datetimeToStr(obj.start_date)}`;
                        }
                    }
                },
                {
                    name: "end_date", align: "center", width: 130, min_width: 130, max_width: 130, resize: true, template: function (obj) {
                        if (datetimeToStr(obj.planned_end) != datetimeToStr(obj.end_date)) {
                            return `<span style="display: inline-block; line-height: 20px;">
                                        <span style="text-decoration: line-through; color: #aaa; font-size: 12px; ">${datetimeToStr(obj.planned_end)}</span>
                                        <br /><span>${datetimeToStr(obj.end_date)}</span>
                                    </span>`;
                        } else {
                            return `${datetimeToStr(obj.end_date)}`;
                        }
                    }
                },
                {
                    name: "duration", align: "center", width: 130, min_width: 130, max_width: 130, resize: true, template: function (obj) {
                        if (obj.duration != obj.planned_duration) {
                            let days = parseInt(obj.planned_duration / 60 / 24);
                            let hours = parseInt((obj.planned_duration % (60 * 24)) / 60);
                            let minutes = parseInt(obj.planned_duration % 60);

                            let planned_output = `${days > 0 ? `${days} 天` : ``} ${hours > 0 ? `${hours} 小時` : ``} ${minutes > 0 ? `${minutes} 分` : ``}`;

                            days = parseInt(obj.duration / 60 / 24);
                            hours = parseInt((obj.duration % (60 * 24)) / 60);
                            minutes = parseInt(obj.duration % 60);

                            let output = `${days > 0 ? `${days} 天` : ``} ${hours > 0 ? `${hours} 小時` : ``} ${minutes > 0 ? `${minutes} 分` : ``}`;

                            return `<span style="display: inline-block; line-height: 20px;">
                                        <span style="text-decoration: line-through; color: #aaa; font-size: 12px; ">${planned_output}</span>
                                        <br /><span>${output}</span>
                                    </span>`;
                        } else {
                            let days = parseInt(obj.duration / 60 / 24);
                            let hours = parseInt((obj.duration % (60 * 24)) / 60);
                            let minutes = parseInt(obj.duration % 60);
                            let output = `${days > 0 ? `${days} 天` : ``} ${hours > 0 ? `${hours} 小時` : ``} ${minutes > 0 ? `${minutes} 分` : ``}`;
                            return output;
                        }
                    }
                }
            ];
            gantt@(itemName).config.columns = columnsConfig; //設定欄位
            //#endregion

            @*//#region 甘特圖主要設定
            gantt@(itemName).i18n.setLocale(ganttLocales); //設定語系
            gantt@(itemName).message.position = "bottom"; //提示訊息位置
            gantt@(itemName).plugins({
                auto_scheduling: true, //自動排程
                drag_timeline: true, //拖拉時間軸
                fullscreen: true, //全螢幕模式
                multiselect: true, //任務多選
                tooltip: true, //任務資訊查看
                marker: true, //標記線
            });
            gantt@(itemName).config.date_format = "%Y-%m-%d %H:%i"; //日期格式
            gantt@(itemName).config.work_time = ($("#cboWorkTimeStatusProjectManagement").val() == "Y") // 工作天模式
            gantt@(itemName).config.duration_unit = "minute"; //持續時間單位
            gantt@(itemName).config.skip_off_time = false; // 隱藏休息日
            gantt@(itemName).config.start_on_monday = false; //一周起始
            gantt@(itemName).config.round_dnd_dates = false; //不允許將任務的開始和結束日期四捨五入到最接近的刻度標記
            gantt@(itemName).config.fit_tasks = false; //甘特圖自動延長時間範圍以適應所有顯示的任務
            gantt@(itemName).config.scroll_size = 10;  //滾動條
            gantt@(itemName).config.time_step = 30;
            gantt@(itemName).config.bar_height = 16;
            gantt@(itemName).config.row_height = 40;
            //#endregion*@

            //#region 甘特圖可手動調整
            gantt@(itemName).config.drag_project = false; //專案類型任務拖曳
            gantt@(itemName).config.drag_progress = false; //任務進度調整
            gantt@(itemName).config.drag_links = canEdit; //任務連結拖曳
            gantt@(itemName).config.drag_resize = canEdit; //任務時程拖曳
            gantt@(itemName).config.drag_move = canEdit; //任務拖曳
            //#endregion

            //#region 自動排程
            gantt@(itemName).config.auto_scheduling = true; //自動排程
            gantt@(itemName).config.auto_scheduling_strict = false; //連結任務需接續進行
            gantt@(itemName).config.auto_scheduling_compatibility = false; //自動調度相容性(開啟後自動可能導致往後位移)
            //#endregion

            @*//#region 設定工作時段
            if ($("#cboWorkTimeStatusProjectManagement").val() == "Y" && $("#txtWorkTimeIntervalProjectManagement").val()) {
                gantt@(itemName).setWorkTime({ hours: $("#txtWorkTimeIntervalProjectManagement").val().split(',') });
            }
            //#endregion

            //#region 專案原始時間線
            gantt@(itemName).config.lightbox.sections = [
                { name: "description", height: 70, map_to: "text", type: "textarea", focus: true },
                { name: "time", map_to: "auto", type: "duration" },
                { name: "baseline", map_to: { start_date: "planned_start", end_date: "planned_end" }, button: true, type: "duration_optional" }
            ];
            gantt@(itemName).config.lightbox.project_sections = [
                { name: "description", height: 70, map_to: "text", type: "textarea", focus: true },
                { name: "time", map_to: "auto", type: "duration", readonly: true },
                { name: "baseline", map_to: { start_date: "planned_start", end_date: "planned_end" }, button: true, type: "duration_optional" }
            ];
            gantt@(itemName).config.lightbox.milestone_sections = [
                { name: "description", height: 70, map_to: "text", type: "textarea", focus: true },
                { name: "time", map_to: "auto", type: "duration", single_date: true },
                { name: "baseline", single_date: true, map_to: { start_date: "planned_start", end_date: "planned_end" }, button: true, type: "duration_optional" }
            ];

            gantt@(itemName).locale.labels.section_baseline = "Planned";

            gantt@(itemName).addTaskLayer(function draw_planned(task) {
                if (task.planned_start && task.planned_end) {
                    var sizes = gantt@(itemName).getTaskPosition(task, task.planned_start, task.planned_end);
                    var el = document.createElement('div');
                    el.className = 'gantt_plan_task_line';
                    el.style.left = sizes.left + 'px';
                    el.style.width = sizes.width + 'px';
                    el.style.top = sizes.top + gantt@(itemName).config.bar_height + 13 + 'px';
                    el.task_id = task.id;
                    return el;
                }
                return false;
            });
            //#endregion

            //#region 標記線
            gantt@(itemName).addMarker({
                start_date: new Date(`${dateToStr(new Date())} 08:00`),
                css: "gantt-today-line",
                text: `<i class="fas fa-flag"></i> 今日`,
                title: dateOfWeekToStr(new Date())
            });
            //#endregion

            //#region 自定義彈跳視窗
            gantt@(itemName).showLightbox = function (id) {
                if (id != "1.1") {
                    EditViewProjectTask(id);
                }
            }
            //#endregionon

            //#region 自定義延遲時間
            gantt@(itemName).templates.rightside_text = function (start, end, task) {
                if (task.planned_end) {
                    if (end.getTime() > task.planned_end.getTime()) {
                        var second = (end.getTime() - task.planned_end.getTime()) / 1000;

                        let days = parseInt(second / 60 / 60 / 24);
                        let hours = parseInt(((second / 60) % (60 * 24)) / 60);
                        let minutes = parseInt((second / 60) % 60);

                        var text = "<b>逾期: " + days + "天 " + hours + "小時 " + minutes + "分</b>";
                        return text;
                    }
                }
            };
            //#endregion

            //#region 自定義任務條文字
            gantt@(itemName).templates.task_text = function (start, end, task) {
                return task.text;
            };
            //#endregion

            //#region 自定義每個row的class
            gantt@(itemName).templates.grid_row_class = gantt@(itemName).templates.task_row_class = function (start, end, task) {
                return "";
            };
            //#endregion

            //#region 自定義每個任務條的class
            gantt@(itemName).templates.task_class = function (start, end, task) {
                if (task.planned_end) {
                    var classes = ['has-baseline'];
                    if (end.getTime() > task.planned_end.getTime()) {
                        classes.push('overdue');
                    }
                    return classes.join(' ');
                }
            };
            //#endregion

            //#region 檢視
            gantt@(itemName).ext.zoom.attachEvent("onAfterZoom", function (level, config) {
                $(`input[name="rdoScale${targetItem@(itemName)}"][value="${config.name}"]`).prop("checked", true);
            });

            $(`input[name='rdoScale${targetItem@(itemName)}']`).off("change").on("change", function () {
                gantt@(itemName).ext.zoom.setLevel($(`input[name='rdoScale${targetItem@(itemName)}']:checked`).val());
            });
            //#endregion

            //#region 全螢幕模式
            gantt@(itemName).attachEvent("onTemplatesReady", function () {
                let toggle = document.createElement("i");
                toggle.className = "fas fa-expand-alt gantt-fullscreen";
                gantt@(itemName).toggleIcon = toggle;
                gantt@(itemName).$container.appendChild(toggle);
                toggle.onclick = function () {
                    gantt@(itemName).ext.fullscreen.toggle();
                };
            });

            gantt@(itemName).attachEvent("onExpand", function () {
                let icon = gantt@(itemName).toggleIcon;
                if (icon) {
                    icon.className = icon.className.replace("fa-expand-alt", "fa-compress-alt");
                }

                $(".gantt-body.gantt-in-progress").addClass("fullscreen");
                $(".smart-scroll").removeClass("scrolled-up").addClass("scrolled-down");
            });

            gantt@(itemName).attachEvent("onCollapse", function () {
                let icon = gantt@(itemName).toggleIcon;
                if (icon) {
                    icon.className = icon.className.replace("fa-compress-alt", "fa-expand-alt");
                }
                $(".gantt-body.gantt-in-progress").removeClass("fullscreen");
                $(".smart-scroll").removeClass("scrolled-down").addClass("scrolled-up");
                ScrollPosition(0, GetElementPosition(`#tabProjectTaskGantt`).y - 63);
            });

            gantt@(itemName).ext.fullscreen.getFullscreenElement = function () {
                return $("#tabProjectTaskGantt .gantt-container")[0];
            }
            //#endregion*@

            /*==========已下為編輯模式必備==========*/
            //#region 任務資訊查看
            gantt@(itemName).templates.tooltip_text = function (start, end, task) {
                return `<b>任務:</b> ${task.text}<br />
                        <b>可用操作:</b> ${task.task_status == `B` ? `插入/刪除/編輯` : `插入/編輯`}<br />
                        <b>狀態:</b> ${task.task_status_name} <br />
                        <b>開始時間:</b> ${datetimeToStr(start)} <br />
                        <b>結束時間:</b> ${datetimeToStr(end)}`;
            };
            //#endregion

            //#region 雙擊連結線
            gantt@(itemName).detachEvent(linkDblClickEvent@(parentName));
            //#endregion

            console.log(`啟動-手動更新甘特圖 gantt${targetItem@(itemName)}`);

            gantt@(itemName).init(`gantt${targetItem@(itemName)}`);
        }
</script>
)