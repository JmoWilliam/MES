@using Business_Manager.Helpers
@{
    string itemName = "ViewPurchaseOrder";
    string itemNameText = "採購單查詢";
    string authority = ViewBag.authority;
}
<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog" style="max-width: 1680px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">@(itemNameText)</h5>
                <a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)()"><i class="fas fa-times"></i></a>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <form autocomplete="off" id="queryForm@(itemName)">
                            <fieldset>
                                <input type="hidden" id="txtCustomerIdQ@(itemName)" name="txtCustomerIdQ@(itemName)" value="-1" />
                                <div class="form-row align-items-center mb-2">
                                    <div class="col-12">
                                        <div class="form-group row">
                                            <div class="col-3">
                                                <select id="cboCompanyQ@(itemName)" name="cboCompanyQ@(itemName)" class="form-control" title="輸入類別"></select>
                                            </div>
                                            <div class="col-3">
                                                <select id="cboPoTypeQ@(itemName)" name="cboPoTypeQ@(itemName)" class="form-control" title="採購單類別"></select>
                                            </div>
                                            <div class="col-3">
                                                <input id="txtSearchKeyQ@(itemName)" name="txtSearchKeyQ@(itemName)" class="form-control" placeholder="請輸入品號/品名/單號" />
                                            </div>
                                            <div class="col-3"></div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-group row">
                                            <label class="col-3 col-form-label text-right" for="">預交起訖時間範圍：</label>
                                            <div class="input-group col-3">
                                                <input type="text" class="form-control datedropper" id="txtStartDateQ@(itemName)" name="txtStartDateQ@(itemName)"
                                                       data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"
                                                       placeholder="預交起日" readonly />
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-outline-danger" onclick="$('#txtStartDateQ@(itemName)').val('')" title="清除">
                                                        <i class="fas fa-eraser"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="input-group col-3">
                                                <input type="text" class="form-control datedropper" id="txtEndDateQ@(itemName)" name="txtEndDateQ@(itemName)"
                                                       data-msg-extraRegex="請輸入正確的日期格式" data-rule-extraRegex="([12]\d{3}\-(0[1-9]|1[0-2])\-(0[1-9]|[12]\d|3[01]))"
                                                       placeholder="預交訖日" readonly />
                                                <div class="input-group-append">
                                                    <button type="button" class="btn btn-outline-danger" onclick="$('#txtEndDateQ@(itemName)').val('')" title="清除">
                                                        <i class="fas fa-eraser"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <button type="button" class="btn btn-primary" onclick="Query@(itemName)()"><i class="fal fa-search"></i>搜尋</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="tblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col" style="min-width: 75px;">#</th>
                                        <th scope="col" style="min-width: 150px;">客戶</th>
                                        <th scope="col" style="min-width: 150px;">單別-單號</th>
                                        <th scope="col" style="min-width: 100px;">序號</th>
                                        <th scope="col" style="min-width: 75px;">客戶品號</th>
                                        <th scope="col" style="min-width: 75px;">客戶品名</th>
                                        <th scope="col" style="min-width: 125px;">規格</th>
                                        <th scope="col" style="min-width: 125px;" class="text-right">單價</th>
                                        <th scope="col" style="min-width: 125px;" class="text-right">數量</th>
                                        <th scope="col" style="min-width: 125px;" class="text-right">金額</th>
                                        <th scope="col" style="min-width: 100px;" class="text-center col-sticky">
                                            <div class="checkbox-mode">
                                                <label class="control control-solid control-solid-info control--checkbox">
                                                    全選 <input type="checkbox" id="cbxSelectAll@(itemName)" />
                                                    <span class="control__indicator"></span>
                                                </label>
                                            </div>
                                            <div class="radio-mode">請選擇</div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="page@(itemName)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="Close@(itemName)()"><i class="fas fa-times"></i>關閉</button>
                <button type="button" class="btn btn-success checkbox-mode" onclick="Save@(itemName)()"><i class="fas fa-check"></i>確定</button>
            </div>
        </div>
    </div>
</div>
@Html.Resource("js",
    @<script>
        @*let userId@(itemName);
        let companyId@(itemName);*@

        let targetSelector@(itemName); //array id 儲存容器 (input:元素id
        let elementSelector@(itemName); //隱藏的欄位
        @*let filter@(itemName); //預設篩選條件值*@
        let type@(itemName); //選擇模式 radio, checkbox

        //#region excep套件設定
        let excelCtrls@(itemName); //excel 套件控制
        let spreadsheet@(itemName); //excel 套件
        let targetHidSelector@(itemName); //excel 隱藏的欄位值
        let excelConfig@(itemName); //excel 套件擴充設定
        let columns@(itemName); //要複寫的欄位
        let row@(itemName); //起始row數
        let identify@(itemName); //資料唯一識別欄位
        let message@(itemName); //訊息顯示欄位
        let groupValid@(itemName); //群組驗證及欄位
        //#endregion

        let dataKeys@(itemName) = [];
        let hiddenData@(itemName) = [];
        let dataJson@(itemName) = [];

        let objPage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };

        $(function () {
            @*GetUserInfo@(itemName)();*@

            $("#txtSearchKeyQ@(itemName)").val("");
            $(`#txtSearchKeyQ@(itemName)`).keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    Query@(itemName)();
                    return false;
                }
            });

            @*let currentDate = new Date();
            Suites.DateDropper("#txtStartDateQ@(itemName), #txtEndDateQ@(itemName)");
            Suites.SetDateDropper("#txtEndDateQ@(itemName)", currentDate);
            currentDate.setDate(currentDate.getDate() - 180);
            Suites.SetDateDropper("#txtStartDateQ@(itemName)", currentDate);*@

            Suites.DateDropper("#txtStartDateQ@(itemName), #txtEndDateQ@(itemName)");

            @*ComboBoxs.Default("#cboPoTypeQ@(itemName)", "@Url.Action("GetPurchaseOrderTypeFromERP", "SaleOrder")", "", "", "NA", "", "NameWithNo", "MQ001");*@
            ComboBoxs.Default("#cboCompanyQ@(itemName)", "@Url.Action("GetCompany", "BasicInformation")", {}, "", "NA", "", "CompanyWithNo", "CompanyId");
            $("#cboCompanyQ@(itemName)").off("change").on("change", function () {
                ComboBoxs.Default("#cboPoTypeQ@(itemName)", "@Url.Action("GetPurchaseOrderTypeFromERP", "SaleOrder")", { CompanyId: this.value }, "", "NA", "", "NameWithNo", "MQ001");
            });
            if (!isMobile) {
                $("#cboPoTypeQ@(itemName), #cboCompanyQ@(itemName)").select2({
                    width: "100%"
                });
            }
        });

        function Pop@(itemName)(config) {
            InitParameter@(itemName)(config);

            $("#modal@(itemName) .modal-body").html($("#template@(itemName)").html());
            Switch(`#modal@(itemName)`, `#editData@(itemName)`);

            $("#modal@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });

            Query@(itemName)();
        }

        function InitParameter@(itemName)(config) {
            targetSelector@(itemName) = config.targetSelector;
            targetHidSelector@(itemName) = config.targetHidSelector;
            elementSelector@(itemName) = config.elementSelector;
            @*filter@(itemName) = config.filter;*@
            type@(itemName) = config.type;

            if (!!config.spreadsheet) {
                spreadsheet@(itemName) = config.spreadsheet.component;
                excelConfig@(itemName) = config.spreadsheet.config;
                columns@(itemName) = config.spreadsheet.columns;
                row@(itemName) = config.spreadsheet.row;
                identify@(itemName) = config.spreadsheet.identify;
                message@(itemName) = config.spreadsheet.message;
                excelCtrls@(itemName) = config.spreadsheet.excelCtrls;
                groupValid@(itemName) = config.spreadsheet.groupValid;
            }
            else {
                columns@(itemName) = config.columns;
                identify@(itemName) = config.identify;
            }

            dataKeys@(itemName) = [];

            if (!!elementSelector@(itemName)) { //預設篩選條件值
                $.each(elementSelector@(itemName), function (i, s) {
                    switch (s.type) {
                        case "txt":
                            $(s.element).val(s.setValue);
                            break;
                        case "cbo":
                            $(s.element).val(s.setValue).trigger("change");
                            break;
                    }
                });

                @*if (!!filter@(itemName).CompanyIds) {
                    $.each(filter@(itemName).CompanyIds, function (i, v) {
                        $(`#cboCompanyQ@(itemName)`).val(v).trigger('change');
                    });
                }
                if (!!filter@(itemName).CompanyNames) {
                    $.each(filter@(itemName).CompanyNames, function (i, v) {
                        $(`#cboCompanyQ@(itemName) :contains("${v}")`).prop("selected", true).trigger('change');
                    });
                }
                if (!!filter@(itemName).CustomerPurchaseOrders) {
                    $.each(filter@(itemName).CustomerPurchaseOrders, function (i, v) {
                        $(`#txtSearchKeyQ@(itemName)`).val(v);
                    });
                }*@
            }

            if (!!spreadsheet@(itemName)) { //套件 欄位資訊
                let dataInfo = spreadsheet@(itemName).serialize().sheets[0].data;
                let rows = [...new Set(dataInfo.map(m => parseInt(m.cell.replace(/^\D+/g, ''))))];

                $.each(rows, function (i, row) {
                    if (row == 1) return;
                    let cell = dataInfo.find(f => f.cell == identify@(itemName) + row);
                    if (!!cell) dataKeys@(itemName).push(cell.value);
                });
            }
            else { //一般資料 欄位資訊
                if (!!$(targetSelector@(itemName)).val()) dataKeys@(itemName) = $(targetSelector@(itemName)).val().split(',');
            }
        }

        @*function GetUserInfo@(itemName)() {
            let targetUrl = "@Url.Action("GetLoginByKey", "User")";
            let postData = {
                "UserNo": $.cookie("Login"),
                "KeyText": $.cookie("LoginKey")
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                userId@(itemName) = data.returnData.UserId;
                companyId@(itemName) = data.returnData.CompanyId;
            } else {
                alert(data.msg, "alert", 0);
            }
        }*@

        function InitData@(itemName)(objPage) {
            let innerHtml = '';
            let pageCount = 0;

            let targetUrl = "@Url.Action("GetPurchaseOrderFromERP", "SaleOrder")";
            let postData = {
                "OrderBy": "",
                "PageIndex": (objPage.pageIndex + 1),
                "PageSize": objPage.pageSize,
                "CompanyId": $("#cboCompanyQ@(itemName)").val(),
                "CustomerId": $("#txtCustomerIdQ@(itemName)").val(),
                "PoErpPrefix": $("#cboPoTypeQ@(itemName)").val(),
                "StartDate": $("#txtStartDateQ@(itemName)").val(),
                "EndDate": $("#txtEndDateQ@(itemName)").val(),
                "SearchKey": $("#txtSearchKeyQ@(itemName)").val()
            };
            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;
                objPage.pageSize = data.result.length > 0 ? parseInt(data.result[0]["PageSize"]) : 10;

                if (pageCount > 0) {
                    objPage = PageCaculate(pageCount, objPage);

                    $.each(data.result, function (i, item) {
                        let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";

                        innerHtml += `<tr>
                                        <td style="max-width: 75px;">${_row}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.ML003}">${item.ML003}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.PoErpPrefixNo}">${item.PoErpPrefixNo}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.TD003}">${item.TD003}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.TD004}">${item.TD004}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.TD005}">${item.TD005}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.TD006}">${item.TD006}</td>
                                        <td class="ellipsis text-right" data-toggle="tooltip" title="${item.TD010.toLocaleString(`en`)}">${item.TD010.toLocaleString(`en`)}</td>
                                        <td class="ellipsis text-right" data-toggle="tooltip" title="${item.TD008.toLocaleString(`en`)}">${item.TD008.toLocaleString(`en`)}</td>
                                        <td class="ellipsis text-right" data-toggle="tooltip" title="${item.TD011.toLocaleString(`en`)}">${item.TD011.toLocaleString(`en`)}</td>
                                        <td class="text-center col-sticky">`;

                        switch (type@(itemName)) {
                            case "radio":
                                innerHtml += `<label class="control control-solid control-solid-info control--radio">
                                                <input type="radio" data-mainkey="${item.MainKey}" value="${item.MainKey}" />
                                                <span class="control__indicator"></span>
                                              </label>`;
                                break;
                            case "checkbox":
                                innerHtml += `<label class="control control-solid control-solid-info control--checkbox">
                                                <input type="checkbox" data-mainkey="${item.MainKey}" value="${item.MainKey}" />
                                                <span class="control__indicator"></span>
                                              </label>`;
                                break;
                        }

                        innerHtml += `  <input type="hidden" name="txtMainKey@(itemName)" data-mainkey="${item.MainKey}" value="${item.MainKey}" />
                                        <input type="hidden" name="txtPoErpPrefixNo@(itemName)" data-mainkey="${item.MainKey}" value="${item.PoErpPrefixNo}" />
                                        <input type="hidden" name="txtPoErpPrefixSno@(itemName)" data-mainkey="${item.MainKey}" value="${item.PoErpPrefixSno}" />
                                        <input type="hidden" name="txtML003@(itemName)" data-mainkey="${item.MainKey}" value="${item.ML003}" />
                                        <input type="hidden" name="txtTD001@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD001}" />
                                        <input type="hidden" name="txtTD002@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD002}" />
                                        <input type="hidden" name="txtTD003@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD003}" />
                                        <input type="hidden" name="txtTD004@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD004}" />
                                        <input type="hidden" name="txtTD005@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD005}" />
                                        <input type="hidden" name="txtTD006@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD006}" />
                                        <input type="hidden" name="txtTD008@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD008}" />
                                        <input type="hidden" name="txtTD009@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD009}" />
                                        <input type="hidden" name="txtTD010@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD010}" />
                                        <input type="hidden" name="txtTD011@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD011}" />
                                        <input type="hidden" name="txtTD015@(itemName)" data-mainkey="${item.MainKey}" value="${item.TD015}" />

                                        <input type="hidden" name="txtPromiseDate@(itemName)" data-mainkey="${item.MainKey}" value="${item.PromiseDate}" />
                                        <input type="hidden" name="txtCustomerMtlItemId@(itemName)" data-mainkey="${item.MainKey}" value="${item.CustomerMtlItemId}" />
                                        <input type="hidden" name="txtCompanyId@(itemName)" data-mainkey="${item.MainKey}" value="${item.CompanyId}" />
                                        <input type="hidden" name="txtCustomerMtlItemNo@(itemName)" data-mainkey="${item.MainKey}" value="${item.CustomerMtlItemNo}" />
                                        <input type="hidden" name="txtCustomerMtlItemName@(itemName)" data-mainkey="${item.MainKey}" value="${item.CustomerMtlItemName}" />
                                        <input type="hidden" name="txtMtlItemNo@(itemName)" data-mainkey="${item.MainKey}" value="${item.MtlItemNo}" />
                                        <input type="hidden" name="txtMtlItemName@(itemName)" data-mainkey="${item.MainKey}" value="${item.MtlItemName}" />
                                        <input type="hidden" name="txtSaleUomNo@(itemName)" data-mainkey="${item.MainKey}" value="${item.SaleUomNo}" />

                                        <input type="hidden" name="txtProductTypeName@(itemName)" data-mainkey="${item.MainKey}" value="贈品量" />
                                        <input type="hidden" name="txtProductType@(itemName)" data-mainkey="${item.MainKey}" value=1 />
                                        <input type="hidden" name="txtFreebieOrSpareQty@(itemName)" data-mainkey="${item.MainKey}" value=0 />
                                    </td></tr>`;
                    });
                } else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="11" style="background-color: #fff3cd;">
                                      <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }

            } else {
                alert(data.msg, "alert", 0);
            }

            $("#tblData@(itemName) tbody").html(innerHtml);
            TableComponentInit();
            Pager("#page@(itemName)", pageCount, objPage, InitData@(itemName));

            InitElement@(itemName)();
        }

        function InitElement@(itemName)() {
            let chkRows = $("input[type='checkbox'][data-mainkey]");
            let checkRows = $("input[type='checkbox'][data-mainkey]:checked");

            $("#cbxSelectAll@(itemName)").prop("checked", false);
            if (checkRows.length == chkRows.length && chkRows > 0) $("#cbxSelectAll@(itemName)").prop("checked", true);

            $("#cbxSelectAll@(itemName)").off("click").on("click", function () {
                if ($("#cbxSelectAll@(itemName)").is(":checked")) {
                    $(`input[type='checkbox'][data-mainkey]`).not(":disabled").prop("checked", true);
                }
                else {
                    $(`input[type='checkbox'][data-mainkey]`).not(":disabled").prop("checked", false);
                }
            });

            $("input[type='checkbox'][data-mainkey]").off("change").on("change", function (e) {
                checkRows = $("input[type='checkbox'][data-mainkey]:checked");
                if (checkRows.length == chkRows.length) $("#cbxSelectAll@(itemName)").prop("checked", true);
                else $("#cbxSelectAll@(itemName)").prop("checked", false);
            });

            switch (type@(itemName)) {
                case "radio":
                    $(".radio-mode").show();
                    $(".checkbox-mode, btn-select").hide();

                    $("input[type='radio']").click(function () {
                        ClearExcel@(itemName)();

                        let dataId = $(this).data("mainkey");
                        SetRowData@(itemName)(dataId);

                        if (!!targetSelector@(itemName)) {
                            $(targetSelector@(itemName)).parent().find(".help-block").css("display", "grid");
                            $(targetSelector@(itemName)).parent().siblings().find(".help-block").css("display", "grid");
                            ElementSetValue(targetSelector@(itemName), dataId, "change");
                        }
                        if (!!targetHidSelector@(itemName)) $(targetHidSelector@(itemName)).val(JSON.stringify(hiddenData@(itemName)));
                        if (!!groupValid@(itemName)) SingleIdentifyValidation@(itemName)();

                        Close@(itemName)();
                    });
                    break;
                case "checkbox":
                    $(".radio-mode").hide();
                    $(".checkbox-mode").show();
                    break;
            }
        }

        function SetRowData@(itemName)(dataId) {
            if (!!spreadsheet@(itemName)) { //excel 套件模式
                let hiddenData = {};
                //let data = {};
                let mainKey = '';
                let mainKeyColName = '';
                $.each(columns@(itemName), function (i, col) {
                    let cellValue = $(`input[name='txt${col.title}@(itemName)'][data-mainkey='${dataId}']`).val();

                    if (!!col.format) spreadsheet@(itemName).setFormat(col.column + row@(itemName), col.format);

                    if (col.column == identify@(itemName)) {
                        mainKeyColName = col.title;
                        mainKey = cellValue;
                        if (hiddenData@(itemName).filter(f => f[col.title] == mainKey).length < 1) {
                            hiddenData = { [col.title]: cellValue };
                            hiddenData@(itemName).push(hiddenData);

                            @*data = { [col.title]: cellValue };
                            dataJson@(itemName).push(data);*@
                        }

                        //#region 判斷資料是否存在
                        if (!!message@(itemName)) {
                            let existsRow = dataKeys@(itemName).filter(f => f == cellValue);
                            if (existsRow.length > 0) {
                                spreadsheet@(itemName).setStyle(message@(itemName) + row@(itemName), { background: "red", color: "#fff" });
                                spreadsheet@(itemName).setValue(message@(itemName) + row@(itemName), "資料重複!");
                            }
                            else {
                                spreadsheet@(itemName).setStyle(message@(itemName) + row@(itemName), { background: "fff", color: "#000" });
                                spreadsheet@(itemName).setValue(message@(itemName) + row@(itemName), "");
                            }
                        }
                        //#endregion

                        dataKeys@(itemName).push(cellValue); //推送當前準備寫入的編號
                    }

                    @*data = dataJson@(itemName).find(f => f[col.title] == mainKey);
                    $.extend(true, data, { [col.title]: cellValue });*@

                    if (col.type == 'hidden') {
                        hiddenData = hiddenData@(itemName).find(f => f[mainKeyColName] == mainKey);
                        $.extend(true, hiddenData, { [col.title]: cellValue });
                        return; //跳過隱藏屬性的欄位
                    }

                    //暫存當前篩選值
                    if (!!elementSelector@(itemName)) {
                        $.each(elementSelector@(itemName).filter(f => f.mapColumn == col.column), function (i, s) {
                            $(s.element).val(cellValue);
                        });
                    }

                    spreadsheet@(itemName).setValue(col.column + row@(itemName), cellValue);
                });

                row@(itemName)++;
            }
            else { //一般模式
                $.each(columns@(itemName), function (i, col) {
                    let cellValue = $(`input[name='txt${col.title}@(itemName)'][data-mainkey='${dataId}']`).val();
                    $(`#${col.column}`).val(cellValue);
                    if (col.title == identify@(itemName)) dataKeys@(itemName).push(cellValue); //推送當前準備寫入的編號

                    //暫存當前篩選值
                    if (!!elementSelector@(itemName)) {
                        $.each(elementSelector@(itemName).filter(f => f.mapColumn == col.column), function (i, s) {
                            $(s.element).val(cellValue);
                        });
                    }
                });
            }
        }

        function SingleIdentifyValidation@(itemName)() {
            dataJson@(itemName) = [];
            let d = spreadsheet@(itemName).serialize().sheets[0].data;
            let g = groupValid@(itemName).groupColumns;
            let r = [...new Set(d.map(m => parseInt(m.cell.replace(/^\D+/g, ''))))].slice(1);

            $.each(r, function (i, row) {
                let data = {};
                $.each(g, function (j, key) {
                    let c = d.find(f => f.cell == `${key}${row}`);
                    let h = dataJson@(itemName).find(f => f[key] != c.value);
                    if (!!h) {
                        spreadsheet@(itemName).clear();
                        excelCtrls@(itemName).InitFirstRow(); //初始化第一列
                        excelCtrls@(itemName).LockFirstRow(); //鎖定第一列
                        alert(`列表已存在其他採購單 ${h.B}`, "error", 0);
                        return false;
                    }
                    $.extend(true, data, { [key]: c.value });
                });
                dataJson@(itemName).push(data);
            });
        }

        function Save@(itemName)() {
            swal.fire({
                titleText: "確定要匯入採購單暫存資料?",
                text: "請確認是否要執行!",
                icon: "question",
                allowOutsideClick: false,
                allowEscapeKey: false,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    let dataList = [];
                    let checkRows = $("input[type='checkbox'][data-mainkey]:checked");
                    ClearExcel@(itemName)();

                    $.each(checkRows, function (i, e) {
                        let dataId = $(this).data("mainkey");
                        dataList.push(dataId);
                        SetRowData@(itemName)(dataId);
                    });

                    if (!!targetSelector@(itemName)) ElementSetValue(targetSelector@(itemName), dataList, "change");
                    if (!!targetHidSelector@(itemName)) $(targetHidSelector@(itemName)).val(JSON.stringify(hiddenData@(itemName)));
                    if (!!groupValid@(itemName)) SingleIdentifyValidation@(itemName)();

                    $("#cbxSelectAll@(itemName)").prop("checked", false);
                    Close@(itemName)();
                }
            });
        }

        function Query@(itemName)() {
            objPage@(itemName).pageIndex = 0;
            InitData@(itemName)(objPage@(itemName));
        }

        function ClearExcel@(itemName)() {
            if (!!spreadsheet@(itemName) && excelConfig@(itemName).writeNew) {
                hiddenData@(itemName) = [];
                spreadsheet@(itemName).clear(); //清空表格
                excelCtrls@(itemName).InitFirstRow(); //初始化第一列
                excelCtrls@(itemName).LockFirstRow(); //鎖定第一列
            }
        }

        function Close@(itemName)() {
            $("#modal@(itemName)").modal('hide');
        }
</script>
    )
