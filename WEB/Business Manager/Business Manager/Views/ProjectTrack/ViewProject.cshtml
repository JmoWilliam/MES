@using Business_Manager.Helpers
@{
    string itemName = "ViewProject";
    string itemNameText = "專案任務";
}

@Html.Resource("css", 
    @<style>
    </style>)

<div class="task-nav" id="nav@(itemName)">
    <div class="container">
        <div class="task-header">
            <a class="set nav-close" href="javascript:void(0);">
                <i class="fas fa-arrow-to-right"></i>
            </a>
            <div class="set-area"></div>
            <input type="hidden" id="ProjectId" name="ProjectId" value="-1" />
        </div>
        <h3 class="task-title">
            <span class="title"><code id="desProjectNo@(itemName)"></code>&nbsp;<span id="desProjectName@(itemName)"></span></span>
        </h3>
        <div class="task-box">
            <ul class="task-list-area">
                <li class="task-list">
                    <span class="title">
                        專案狀態
                    </span>
                    <span id="desProjectStatusName@(itemName)"></span>
                </li>

                <li class="task-list">
                    <span class="title">
                        所屬公司/部門
                    </span>
                    <span class="detail" id="desCorpDeptName@(itemName)"></span>
                </li>

                <li class="task-list">
                    <span class="title">
                        專案管理者
                    </span>
                    <span class="detail" id="desProjectMaster@(itemName)"></span>
                </li>

                <li class="task-list">
                    <span class="title">
                        工作天模式
                    </span>
                    <span class="detail" id="desWorkTime@(itemName)"></span>
                </li>

                <li class="task-list">
                    <span class="title">
                        專案分類
                    </span>
                    <span class="detail" id="desProjectTypeName@(itemName)"></span>
                </li>

                <li class="task-list">
                    <span class="title">
                        專案描述
                    </span>
                    <span class="detail" id="desProjectDesc@(itemName)"></span>
                </li>

                <li class="task-list">
                    <span class="title">
                        專案成員
                    </span>
                    <span class="detail" id="desProjectUser@(itemName)"></span>
                </li>

                <li class="task-list">
                    <span class="title">
                        預計時間
                    </span>
                    <span class="detail" id="desPlanned@(itemName)">
                        2022-11-05 08:00&nbsp;<i class="fas fa-arrow-alt-right"></i>&nbsp;2022-11-10 08:00
                    </span>
                </li>
                <li class="task-list">
                    <span class="title">
                        預估時間
                    </span>
                    <span class="detail" id="desEstimate@(itemName)">
                        2022-11-05 08:00&nbsp;<i class="fas fa-arrow-alt-right"></i>&nbsp;2022-11-10 08:00
                    </span>
                </li>
                <li class="task-list">
                    <span class="title">
                        實際時間
                    </span>
                    <span class="detail" id="desActual@(itemName)">
                        2022-11-05 08:00&nbsp;<i class="fas fa-arrow-alt-right"></i>&nbsp;2022-11-10 08:00
                    </span>
                </li>
            </ul>
        </div>

        <div class="task-box">
            <div class="task-box-title">
                <h2>回報列表</h2>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="table-custom table-custom-sm">
                        <table class="table table-bordered table-striped table-sticky table-stack" id="tblReplyData@(itemName)" style="margin-top: 5px;">
                            <thead>
                                <tr>
                                    <th scope="col" style="min-width: 50px;">#</th>
                                    <th scope="col" style="min-width: 150px;">所屬任務</th>
                                    <th scope="col" style="min-width: 105px;">回報人員</th>
                                    <th scope="col" style="min-width: 145px;">回報時間</th>
                                    <th scope="col" style="min-width: 100px;">回報狀態</th>
                                    <th scope="col" style="min-width: 150px;">延後時間</th>
                                    <th scope="col" style="min-width: 200px;">回報內容</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pageReply@(itemName)"></div>
                </div>
            </div>
        </div>

        <div class="task-box">
            <div class="task-box-title">
                <h2>文件檔案</h2>
                <a class="link auth-download" href="javascript:void(0);" onclick="Forbidden@(itemName)()">
                    <i class="far fa-arrow-alt-circle-down"></i>
                    全部下載
                </a>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="table-custom table-custom-sm">
                        <table class="table table-bordered table-striped table-sticky table-stack" id="tblFileData@(itemName)">
                            <thead>
                                <tr>
                                    <th scope="col" style="min-width: 50px;">#</th>
                                    <th scope="col" style="min-width: 250px;">檔案名稱</th>
                                    <th scope="col" style="min-width: 120px;">閱覽檔案等級</th>
                                    <th scope="col" style="min-width: 110px;">檔案類型</th>
                                    <th scope="col" style="min-width: 145px;">上傳時間</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="pageFile@(itemName)"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let objForm@(itemName) = `#nav@(itemName)`;
        let taskType@(itemName) = `Project`;

        let objProjectId@(itemName) = `${objForm@(itemName)} #ProjectId`;
        let Elements@(itemName) = new ElementControl@(itemName)();
        let Datas@(itemName) = new DataControl@(itemName)();

        let defaultReplyDate@(itemName);

        let objReplyPage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };
        let objFilePage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };

        let replyConfig@(itemName) = [
            {
                Status: "C",
                StatusName: "完成",
                Placeholder: "選填"
            },
            {
                Status: "D",
                StatusName: "延宕",
                Placeholder: "必填"
            },
            {
                Status: "N",
                StatusName: "尚未開始",
                Placeholder: "必填"
            },
            {
                Status: "O",
                StatusName: "案計畫進行",
                Placeholder: "選填"
            },
            {
                Status: "S",
                StatusName: "開始",
                Placeholder: "選填"
            }
        ];

        function InitData@(itemName)(projectId) {
            $(objProjectId@(itemName)).val(projectId);

            Elements@(itemName).Initialize@(itemName)(`#nav@(itemName)`);
            Elements@(itemName).LoadData@(itemName)();
        }

        function ElementControl@(itemName)() {
            addMethod(this, "Initialize@(itemName)", function (targetSelector) {
                $(targetSelector).addClass("active");

                $(targetSelector).find(".nav-close").off("click").on("click", function (e) {
                    $(`#nav@(itemName)`).removeClass("active");
                });

                $(targetSelector).find(".progress-cancel").off("click").on("click", function (e) {
                    $(targetSelector).find(".return-block").addClass("hide");
                });

                $(targetSelector).find(".return-block").addClass("hide");
                $(targetSelector).find(".reply-task").off("click").on("click", function (e) {
                    if ($(targetSelector).find(".return-block").hasClass("hide")) {
                        $(targetSelector).find(".return-block").removeClass("hide");
                        $(targetSelector).find(".control-delay-area, .control-start-area, .control-end-area, .control-content-area").removeClass("show");

                        ResetForm("#replyForm@(itemName)");

                        $("input[name='rdoReplyStatus@(itemName)']").off("change").on("change", function (e) {

                            let status = $("input[name='rdoReplyStatus@(itemName)']:checked").val();
                            let replyConfig = replyConfig@(itemName).find(f => f.Status == status);
                            $(targetSelector).find("#txtReplyContentName@(itemName)").text(`${replyConfig.StatusName}原因`);
                            $(targetSelector).find("#txtReplyContent@(itemName)").prop("placeholder", replyConfig.Placeholder);

                            let dtNow = new Date();
                            let rpDate = dtNow > defaultReplyDate@(itemName) ? dtNow.Format('yyyy-MM-dd hh:mm') : defaultReplyDate@(itemName).Format('yyyy-MM-dd hh:mm');

                            switch (status) {
                                case "C":
                                    $(targetSelector).find(".control-end-area, .control-content-area").addClass("show");
                                    $(targetSelector).find(".control-delay-area, .control-start-area").removeClass("show");
                                    $(`${targetSelector} #txtActualEnd@(itemName)`).val(rpDate);
                                    break;
                                case "D":
                                    $(targetSelector).find(".control-delay-area, .control-content-area").addClass("show");
                                    $(targetSelector).find(".control-start-area, .control-end-area").removeClass("show");
                                    break;
                                case "N":
                                case "O":
                                    $(targetSelector).find(".control-content-area").addClass("show");
                                    $(targetSelector).find(".control-delay-area, .control-start-area, .control-end-area").removeClass("show");
                                    break;
                                case "S":
                                    $(targetSelector).find(".control-start-area, .control-content-area").addClass("show");
                                    $(targetSelector).find(".control-delay-area, .control-end-area").removeClass("show");
                                    $(`${targetSelector} #txtActualStart@(itemName)`).val(rpDate);
                                    break;
                                default:
                                    $(targetSelector).find(".control-delay-area, .control-start-area, .control-end-area, .control-content-area").removeClass("show");
                                    break;
                            }
                        });
                    } else {
                        $(targetSelector).find(".return-block").addClass("hide");
                    }
                });

                $("body").off("click").on("click", function (e) {
                    if ($(targetSelector).hasClass("active")) {
                        if (!$(e.target).parents().hasClass("task-nav")
                            //&& !$(e.target).hasClass("swal2-container")
                            //&& !$(e.target).hasClass("modal")
                            //&& !$(e.target).hasClass("file-drop-zone-title")
                            //&& !$(e.target).parents().hasClass("swal2-container")
                            //&& !$(e.target).parents().hasClass("modal")
                            //&& !$(e.target).parents().hasClass("dhx_popup")
                            //&& !$(e.target).parents().hasClass("content_wrapper")
                        ) {
                            $(`#nav@(itemName)`).removeClass("active");
                        }
                    }

                    if (!$(targetSelector).find(".set-block").hasClass("hide") && !$(e.target).hasClass("nav-menu")) {
                        if (!$(e.target).parents().hasClass("set-block")) {
                            $(".set-block").addClass("hide");
                        }
                    }
                });
            });

            addMethod(this, "LoadData@(itemName)", function () {
                $(`${objForm@(itemName)} .detail`).html("");
                $(`${objForm@(itemName)} .title-input, ${objForm@(itemName)} .detail-input`).val("");

                Datas@(itemName).GetProject@(itemName)();
                Datas@(itemName).GetProjectReply@(itemName)(objReplyPage@(itemName));
                Datas@(itemName).GetProjectFile@(itemName)(objFilePage@(itemName));
                @*Datas@(itemName).GetLastReply@(itemName)();*@
            });
        }

        function DataControl@(itemName)() {
            addMethod(this, "GetProject@(itemName)", function () {
                let targetUrl = "@Url.Action("GetProject", "ProjectTrack")";
                let postData = {
                    "ProjectId": $(objProjectId@(itemName)).val()
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    $.each(data.result, function (i, item) {
                        $("#desProjectNo@(itemName)").text(item.ProjectNo);
                        $("#desProjectName@(itemName)").text(item.ProjectName);
                        $("#desProjectStatusName@(itemName)").text(item.ProjectStatusName).prop({ "class": `proj-status${item.ProjectStatus}`});
                        $("#desCorpDeptName@(itemName)").html(`${item.LogoIcon == -1 ? `` : `<img class="company-logo" src="/Web/GetFile?fileId=${item.LogoIcon}" />`}${item.CompanyName} ${item.DepartmentName}`);
                        $("#desProjectMaster@(itemName)").html(`${item.Gender == `M` ? `<span class="gender-male"><i class="fas fa-male"></i></span>` : item.Gender == `F` ? `<span class="gender-female"><i class="fas fa-female"></i></span>` : ``}${item.ProjectMaster}`);
                        $("#desWorkTime@(itemName)").text(`${item.WorkTimeStatusName}, 工作時段：${item.WorkTimeInterval}`);
                        $("#desProjectTypeName@(itemName)").text(item.ProjectTypeName);
                        $("#desProjectDesc@(itemName)").text(item.ProjectDesc);

                        if (!!item.ProjectUser) {
                            $("#desProjectUser@(itemName)").html(JSON.parse(item.ProjectUser)["data"].map(m => {
                                let icon = m.Gender == `M` ? `<span class="gender-male"><i class="fas fa-male"></i></span>` : m.Gender == `F` ? `<span class="gender-female"><i class="fas fa-female"></i></span>` : ``
                                return icon + m.UserName + '(' + m.UserNo + ')'
                            }).join(','));
                        }

                        let planned = `${item.ProjectPlannedStart}&nbsp;<i class="fas fa-arrow-alt-right"></i>&nbsp;${item.ProjectPlannedEnd}`;
                        $("#desPlanned@(itemName)").html(planned);

                        let estimate = `${item.ProjectEstimateStart}&nbsp;<i class="fas fa-arrow-alt-right"></i>&nbsp;${item.ProjectEstimateEnd}`;
                        $("#desEstimate@(itemName)").html(estimate);

                        let actual = `${item.ProjectActualStart}&nbsp;<i class="fas fa-arrow-alt-right"></i>&nbsp;${item.ProjectActualEnd}`;
                        if (item.ProjectActualStart) $("#desActual@(itemName)").html(actual);

                    });
                } else {
                    alert(data.msg, "alert", 0);
                }
            });

            @*addMethod(this, "GetLastReply@(itemName)", function () {
                let targetUrl = "@Url.Action("GetLastReply", "ProjectTrack")";
                let postData = {
                    "ProjectId": $(objProjectId@(itemName)).val(),
                    "ReplyType": taskType@(itemName)
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    $.each(data.result, function (i, item) {
                        Countdown(item.ReplyFrequency - item.LastReplyInterval, "desReplyCountdown@(itemName)");

                        let days = parseInt(item.LastReplyInterval / 60 / 24);
                        let hours = parseInt((item.LastReplyInterval % (60 * 24)) / 60);
                        let minutes = parseInt(item.LastReplyInterval % 60);
                        $("#desReplyMsg@(itemName)").html("距離上次回報：" + days + "天 " + hours + "小時 " + minutes + "分");

                        days = parseInt(item.ReplyFrequency / 60 / 24);
                        hours = parseInt((item.ReplyFrequency % (60 * 24)) / 60);
                        minutes = parseInt(item.ReplyFrequency % 60);
                        $("#desReplyFrequency@(itemName)").html("回報頻率：" + days + "天 " + hours + "小時 " + minutes + "分");
                    });
                } else {
                    alert(data.msg, "alert", 0);
                }
            });*@

            addMethod(this, "GetProjectReply@(itemName)", function (objPage) {
                let innerHtml = '';
                let pageCount = 0;

                let targetUrl = "@Url.Action("GetProjectReply", "ProjectTrack")";
                let postData = {
                    "OrderBy": "",
                    "PageIndex": (objPage.pageIndex + 1),
                    "PageSize": objPage.pageSize,
                    "ProjectId": $(objProjectId@(itemName)).val(),
                    "ReplyType": taskType@(itemName)
                };
                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;

                    if (pageCount > 0) {
                        $.each(data.result, function (i, item) {
                            let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";

                            let days = parseInt(item.DeferredDuration / 60 / 24);
                            let hours = parseInt((item.DeferredDuration % (60 * 24)) / 60);
                            let minutes = parseInt(item.DeferredDuration % 60);

                            let deferredDuration = `${days > 0 ? `${days} 天` : ``} ${hours > 0 ? `${hours} 小時` : ``} ${minutes > 0 ? `${minutes} 分` : ``}`;

                            innerHtml += `<tr>
                                            <td><span class="stack-title">#</span>${_row}</td>
                                            <td><span class="stack-title">所屬任務</span>${item.TaskName}(${item.TaskStatusName})</td>
                                            <td><span class="stack-title">回報人員</span>${item.LogoIcon == -1 ? `` : `<img class="company-logo" src="/Web/GetFile?fileId=${item.LogoIcon}" />`}${item.ReplyUserName}</td>
                                            <td><span class="stack-title">回報時間</span>${item.EventDate}</td>
                                            <td><span class="stack-title">回報狀態</span>${StatusUI(item.ReplyStatus)} ${item.ReplyStatusName}</td>
                                            <td><span class="stack-title">延後時間</span>${deferredDuration}</td>
                                            <td class="ellipsis" data-toggle="tooltip" title = "${item.ReplyContent}" style="max-width: 200px;"><span class="stack-title">回報內容</span>${item.ReplyContent}</td>
                                          </tr>`;
                        });
                    }
                    else {
                        innerHtml = '<tr><td class="text-center" colspan="7" style="background-color: #fff3cd;"><i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。</td></tr>';
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                $("#tblReplyData@(itemName) tbody").html(innerHtml);
                TableComponentInit();
                Pager("#pageReply@(itemName)", pageCount, objPage, Datas@(itemName).GetProjectReply@(itemName));

                function StatusUI(status) {
                    let html = "";

                    switch (status) {
                        case "D":
                            html = `<span class="blink text-danger"><i class="fas fa-siren-on"></i></span>`;
                            break;
                    }

                    return html;
                }
            });

            addMethod(this, "GetProjectFile@(itemName)", function (objPage) {
                let innerHtml = '';
                let pageCount = 0;

                let targetUrl = "@Url.Action("GetProjectFile", "ProjectTrack")";
                let postData = {
                    "ProjectId": $(objProjectId@(itemName)).val(),
                    "PageIndex": (objPage.pageIndex + 1),
                    "PageSize": objPage.pageSize
                };
                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;

                    if (pageCount > 0) {
                        $.each(data.result.filter(f => f.SourceType == "P"), function (i, item) {
                            let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";

                            innerHtml += `<tr>
                                            <td><span class="stack-title">#</span>${_row}</td>
                                            <td class="active-content ellipsis" data-toggle="tooltip" title="${item.FileName}${item.FileExtension}" style="max-width: 250px;">
                                                <span class="stack-title">專案檔案</span>
                                                <a class="active-link auth-download" href="/ProjectTrack/DownloadFile?fileId=${item.FileId}" target="_blank"><i class="fas fa-download"></i><span>下載</span></a>
                                                ${item.FileName}${item.FileExtension}
                                            </td>
                                            <td>
                                                <span class="stack-title">閱覽檔案等級</span>
                                                ${item.LevelName}
                                            </td>
                                            <td>
                                                <span class="stack-title">檔案類型</span>
                                                ${item.FileTypeName}
                                            </td>
                                            <td><span class="stack-title">上傳時間</span>${item.CreateDate}</td>
                                            </tr>`;
                        });
                    }
                    else {
                        innerHtml = '<tr><td class="text-center" colspan="5" style="background-color: #fff3cd;"><i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。</td></tr>';
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                $("#tblFileData@(itemName) tbody").html(innerHtml);
                TableComponentInit();
                Pager("#pageFile@(itemName)", pageCount, objPage, Datas@(itemName).GetProjectFile@(itemName));
            });
        }

        function Forbidden@(itemName)() {
            swal.fire({
                title: "功能尚未開放!",
                icon: "error"
            });
        }
</script>
)