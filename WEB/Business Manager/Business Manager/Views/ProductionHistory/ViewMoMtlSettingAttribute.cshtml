@using Business_Manager.Helpers
@{
    string itemName = "ViewMoMtlSettingAttribute";
    string itemNameText = "設定上料屬性資料";
}

@Html.Resource("css",
    @<style>
         .modal-body {
             max-height: 50vh;
             overflow-y: auto;
         }

         .page-style {
             padding: 5px;
             max-width: 150px;
             min-width: 75px;
             margin-bottom: 15px;
         }

         .input-header {
             display: flex;
         }
    </style>
)

<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    <span class="sub-title">製令: <span class="sub-text" id="desWoErpFullNo@(itemName)"></span></span>
                    <span class="sub-title">上料品號: <span class="sub-text" id="desMtlItemNo@(itemName)"></span></span>
                    <span class="sub-title">上料品名: <span class="sub-text" id="desMtlItemName@(itemName)"></span></span>
                </h5>
                <a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)()"><i class="fas fa-times"></i></a>
            </div>
            <div class="modal-body">
                <div class="input-header">
                    <div style="margin-right: 15px;">
                        <i class="far fa-sliders-h"></i> <span style="font-weight: 600;">屬性名稱</span>
                        <select id="cboItemNo@(itemName)" class="page-style"></select>
                    </div>
                    <div>
                        <i class="fas fa-file-edit"></i> <span style="font-weight: 600;">屬性值</span>
                        <input type="text" id="txtItemValue@(itemName)" />
                    </div>
                </div>
                <div class="row" id="listData@(itemName)">
                    <div class="col-12">
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="tblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th class="text-center active-content" scope="col" style="max-width: 50px;">
                                            <label class="control control-solid control-solid-info control--checkbox">
                                                選取
                                                <input type="checkbox" id="cbxBarcodeNoAll@(itemName)" name="cbxBarcodeNoAll@(itemName)" checked>
                                                <span class="control__indicator"></span>
                                            </label>
                                        </th>
                                        <th scope="col" style="min-width: 110px;">條碼代碼</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
@<script>
    let objForm@(itemName) = "#queryForm@(itemName)";
    let moProcessId@(itemName);
    let mtlItemId@(itemName);
    let moId@(itemName);
    let BarcodeComponentAttributeJson =
    {
        BarcodeComponentAttributeInfo: []
    };

    function Pop@(itemName)(woErpFullNo, mtlItemNo, mtlItemName, moProcessId, mtlItemId, moId) {
        moProcessId@(itemName) = moProcessId;
        mtlItemId@(itemName) = mtlItemId;
        moId@(itemName) = moId;
        $("#txtItemValue@(itemName)").focus();
        $("#desWoErpFullNo@(itemName)").html(woErpFullNo);
        $("#desMtlItemNo@(itemName)").html(mtlItemNo);
        $("#desMtlItemName@(itemName)").html(mtlItemName);

        Query@(itemName)();

        $("#modal@(itemName)").modal({
            backdrop: "static",
            keyboard: false,
            show: true
        });
    }

    function Query@(itemName)() {
        InitData@(itemName)();
    }

    function InitData@(itemName)() {
        let targetUrl = "@Url.Action("GetMoMtlSettingAttribute", "ProductionHistory")";

        let postData = {
            "MoId": moId@(itemName),
            "MtlItemId": mtlItemId@(itemName)
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {
            if (data.result.length > 0) {
                $("#cboItemNo@(itemName)").empty();
                $.each(data.result, function (i, item) {
                    $("#cboItemNo@(itemName)").append(`<option data-chk-unique="${item.ChkUnique}" data-chk-range="${item.ChkRange}" value="${item.ItemNo}">${item.ItemNo}-${item.ItemName}</option>`);
                });
                GetBarcodeComponentAttribute@(itemName)();
            }
        }

        $("#cbxBarcodeNoAll@(itemName)").click(function () {
            if ($(this).prop("checked")) {
                $("input[type='checkbox'][data-type='BarcodeNo']").prop("checked", true);
            }
            else {
                $("input[type='checkbox'][data-type='BarcodeNo']").prop("checked", false);
            }
        });
    }

    $("#cboItemNo@(itemName)").change(function () {
        GetBarcodeComponentAttribute@(itemName)();
    });

    function GetBarcodeComponentAttribute@(itemName)() {
        let targetUrl = "@Url.Action("GetBarcodeComponentAttribute", "ProductionHistory")";

        let postData = {
            "MoId": moId@(itemName),
            "MtlItemId": mtlItemId@(itemName)
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        let innerHtml = '';
        let checkBool = false;
        if (data.status == "success") {
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {
                    if (item.ItemValue == null) {
                        checkBool = true;
                        innerHtml += `<tr>
                                        <td class="text-center active-content" scope="col" style="max-width: 50px;">
                                            <label class="control control-solid control-solid-info control--checkbox">
                                                <input type="checkbox" data-type="BarcodeNo" id="cbxBarcodeNo@(itemName)${item.BarcodeNo}" name="cbxBarcodeNo@(itemName)" data-barcode-component-id="${item.BarcodeComponentId}" value="${item.BarcodeNo}" checked>
                                                <span class="control__indicator"></span>
                                            </label>
                                        </td>
                                        <td>${item.BarcodeNo}</td>
                                      </tr>`;
                    }
                });
            }
            else {
                innerHtml += `<tr>
                                <td class="text-center" colspan="2" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }

            if (checkBool == false) {
                innerHtml += `<tr>
                                <td class="text-center" colspan="2" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }
        }

        $("#tblData@(itemName) tbody").html(innerHtml);
        TableComponentInit();

        $("#cbxBarcodeNoAll@(itemName)").prop("checked", true);
    }

    $("#txtItemValue@(itemName)").keydown(function (event) {
        if (event.keyCode == 13) {
            BarcodeComponentAttributeJson.BarcodeComponentAttributeInfo = [];
            if ($("#txtItemValue@(itemName)").val() == "") {
                alert("屬性值不可為空", "alert", 0);
            } else {
                $.each($("input[type='checkbox'][data-type='BarcodeNo']:checked"), function (i) {
                    let barcodeComponentId = $(this).data("barcode-component-id");
                    var BarcodeComponentAttributeInfo =
                    {
                        "BarcodeComponentId": barcodeComponentId,
                        "ItemNo": $("#cboItemNo@(itemName)").val(),
                        "ItemValue": $("#txtItemValue@(itemName)").val(),
                        "ChkUnique": $("#cboItemNo@(itemName)").find(":selected").data("chk-unique"),
                        "ChkRange": $("#cboItemNo@(itemName)").find(":selected").data("chk-range"),
                        "MoProcessId": moProcessId@(itemName)
                    };

                    BarcodeComponentAttributeJson.BarcodeComponentAttributeInfo.push(BarcodeComponentAttributeInfo);
                });

                let targetUrl = "@Url.Action("AddBarcodeComponentAttribute", "ProductionHistory")";
                let postData = {
                    "BarcodeComponentAttributeData": JSON.stringify(BarcodeComponentAttributeJson)
                };

                let result = DataAccess.Add(targetUrl, postData, false, false);

                if (result) {
                    Query@(itemName)();
                    ReturnViewMaterial();
                }
                $("#txtItemValue@(itemName)").val("");
            }
        }
    });

    function Close@(itemName)() {
        $("#modal@(itemName)").modal('hide');
    }
</script>
                    )