@using Business_Manager.Helpers
@{
    string itemName = "ViewMaterialVehicle";
    string itemNameText = "上料作業管理(載盤模式)";
}

@Html.Resource("css",
    @<style>
         .modal-body {
             max-height: 60vh;
             overflow-y: auto;
         }
    </style>
                                                                )

<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    <span class="sub-title">製令: <span class="sub-text" id="desWoErpFullNo@(itemName)"></span></span>
                    <span class="sub-title">製程: <span class="sub-text" id="desProcessAlias@(itemName)"></span></span>
                    <span class="sub-title">主條碼: <span class="sub-text" id="desMainBarcodeNo@(itemName)"></span></span>
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="Close@(itemName)('modal@(itemName)')">
                    <span aria-hidden="true">&times;</span>
                </button>
                @*<a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)('modal@(itemName)')"><i class="fas fa-times"></i></a>*@
            </div>
            <div class="modal-body">
                <div class="row" id="listData@(itemName)">
                    <div class="col-3" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" id="txtVehicleNo@(itemName)" placeholder="刷取載盤條碼" />
                    </div>
                    <div class="col-3" style="margin-bottom: 10px;">
                        <a style="font-size: 16px; font-weight: 600;" class="btn btn-success" href="javascript: ImportVehicle@(itemName)();">載盤帶出</a>
                    </div>
                    <div class="col-12">
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="tblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">品號</th>
                                        <th scope="col">品名</th>
                                        <th scope="col">上料方式</th>
                                        <th scope="col">批號</th>
                                        <th class="text-center" scope="col">操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="page@(itemName)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

<!-- 綁定上料條碼作業(條碼模式) -->
<div class="modal fade" id="BindMtlItemModal@(itemName)">
    <div class="modal-dialog modal-lg" style="padding-top:7%;">
        <div class="modal-content working-content" style="min-width:350px;">
            <div class="modal-header" style="align-items: center;">
                <h5 class="modal-title">
                    上料綁定(條碼模式)
                    <span class="sub-title">綁定品號: <span class="sub-text" id="desBindMtlItemNo@(itemName)"></span></span>
                    <span class="sub-title">綁定品名: <span class="sub-text" id="desBindMtlItemName@(itemName)"></span></span>
                </h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 50vh;">
                <div class="row" id=" ">
                    <div class="col-12 input-group mb-2" style="">
                        <label class="input-group-addon" for="basic-addon" style="">
                            <i class="far fa-barcode-alt"></i>
                            <span style="padding-left: 5px;">條碼</span>
                        </label>
                        <input type="text" class="form-control form-control-add" id="txtBarcodeNo@(itemName)" placeholder="請刷取產品條碼">
                    </div>
                    <div class="col-12">
                        <div class="table-custom" style="max-height: 35vh;">
                            <table class="table table-bordered table-striped table-sticky" id="tblBarcodeComponent@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">條碼代碼</th>
                                        <th scope="col">條碼數量</th>
                                        <th class="text-center" scope="col">操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="page@(itemName)"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 綁定上料條碼作業(批號模式) -->
<div class="modal fade" id="BindMtlItemByLotModal@(itemName)">
    <div class="modal-dialog modal-lg" style="padding-top:7%;">
        <div class="modal-content working-content" style="min-width:350px;">
            <div class="modal-header" style="align-items: center;">
                <h5 class="modal-title">
                    上料綁定(批號模式)
                    <span class="sub-title">綁定品號: <span class="sub-text" id="desBindMtlItemNoL@(itemName)"></span></span>
                    <span class="sub-title">綁定品名: <span class="sub-text" id="desBindMtlItemNameL@(itemName)"></span></span>
                </h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 50vh;">
                <div class="row" id=" ">
                    <div class="col-12 input-group mb-2" style="">
                        <label class="input-group-addon" for="basic-addon" style="">
                            <i class="far fa-barcode-alt"></i>
                            <span style="padding-left: 5px;">批號</span>
                        </label>
                        <input type="text" class="form-control form-control-add" id="txtLotNumber@(itemName)" placeholder="請輸入批號">
                    </div>
                    <div class="col-12">
                        <div class="table-custom" style="max-height: 35vh;">
                            <table class="table table-bordered table-striped table-sticky" id="tblBarcodeComponentL@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">批號</th>
                                        <th scope="col">數量</th>
                                        <th class="text-center" scope="col">操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
@<script>
    let moId@(itemName);
    let mainBarcodeNo@(itemName);
    let moProcessId@(itemName);
    let mrDetailId@(itemName);
    let woErpFullNo@(itemName);
    let mtlItemId@(itemName);
    let mtlItemNo@(itemName);
    let objPage@(itemName) = {
        "pageIndex": 0,
        "pageSize": 5
    };
    function Pop@(itemName)(moId, woErpFullNo, processAlias, mainBarcodeNo, moProcessId) {
        $("#desWoErpFullNo@(itemName)").html(woErpFullNo);
        $("#desProcessAlias@(itemName)").html(processAlias);
        $("#desMainBarcodeNo@(itemName)").html(mainBarcodeNo);

        moId@(itemName) = moId;
        mainBarcodeNo@(itemName) = mainBarcodeNo;
        moProcessId@(itemName) = moProcessId;
        woErpFullNo@(itemName) = woErpFullNo;

        Query@(itemName)();

        $("#txtVehicleNo@(itemName)").off('keydown');
        $("#txtVehicleNo@(itemName)").keydown(function (event) {
            if (event.keyCode == 13) {
                ImportVehicle@(itemName)();
                return false;
            }
        });

        $("#modal@(itemName)").modal({
            backdrop: "static",
            keyboard: false,
            show: true
        });
    }

    function Query@(itemName)() {
        InitData@(itemName)();
    }

    function InitData@(itemName)() {
        let targetUrl = "@Url.Action("GetMoProcessMaterials", "ProductionHistory")";

        let postData = {
            "MoId": moId@(itemName),
            "MoProcessId": moProcessId@(itemName),
            "AssemblyBarcodeNo": mainBarcodeNo@(itemName)
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        let innerHtml = '';
        if (data.status == "success") {
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {
                    if (i % 2 == 0) trClass = "line-odd";
                        else trClass = "line-even";
                        innerHtml += `<tr class="${trClass}">
                                        <td>${i + 1}.</td>
                                        <td>${item.MtlItemNo}</td>
                                        <td>${item.MtlItemName}</td>
                                        <td>${item.BindType == `B` ? `條碼` : item.BindType == `L` ? `批號` : `未設定上料方式`}</td>
                                        <td>${item.LotBarcodeComponent != null ? item.LotBarcodeComponent : `尚未綁定批號`}</td>
                                        <td class="text-center">
                                            <a class="active-link" href="javascript:Edit@(itemName)('${item.MtlItemId}', '${item.MtlItemNo}', '${item.MtlItemName}', '${objPage@(itemName)}', '${item.BindType}');" data-mtl-id="1">
                                                <i class="fas fa-link"></i>
                                            </a>
                                        </td>
                                      </tr>`;
                });
            }
            else {
                innerHtml += `<tr>
                                <td class="text-center" colspan="5" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }

            innerHtml += `</tbody>`;
        }
        else {
            alert(data.msg, "alert", 0);
        }

        $("#tblData@(itemName) tbody").html(innerHtml);
        TableComponentInit();
    }

    function ImportVehicle@(itemName)() {
        let vehicleNo = $("#txtVehicleNo@(itemName)").val();
        if (vehicleNo.length <= 0) {
            alert("請輸入載盤條碼!!");
            return false;
        }

        let targetUrl = "@Url.Action("UpdateImportVehicle", "ProductionHistory")";

        let postData = {
            "VehicleNo": vehicleNo,
            "MoProcessId": moProcessId@(itemName),
            "AssemblyBarcodeNo": mainBarcodeNo@(itemName)
        };

        let result = DataAccess.Update(targetUrl, postData, false, true);

        if (result) {
            $("#txtVehicleNo@(itemName)").val("");
            InitData@(itemName)();
        }
    }

    function Edit@(itemName)(MtlItemId, MtlItemNo, MtlItemName, ObjPage, BindType) {
        mtlItemId@(itemName) = MtlItemId;
        mtlItemNo@(itemName) = MtlItemNo;

        if (BindType == "B") {
            setTimeout(function () {
                $("#txtBarcodeNo@(itemName)").focus();
            }, 250);
            $("#desBindMtlItemNo@(itemName)").html(MtlItemNo);
            $("#desBindMtlItemName@(itemName)").html(MtlItemName);
            $("#BindMtlItemModal@(itemName)").modal("show");
            InitBarcodeComponent@(itemName)(MtlItemId);
        }
        else if (BindType == "L") {
            setTimeout(function () {
                $("#txtLotNumber@(itemName)").focus();
            }, 250);
            $("#desBindMtlItemNoL@(itemName)").html(MtlItemNo);
            $("#desBindMtlItemNameL@(itemName)").html(MtlItemName);
            $("#BindMtlItemByLotModal@(itemName)").modal("show");
            InitBarcodeComponentL@(itemName)(MtlItemId)
        }
    }

    function InitBarcodeComponent@(itemName)(MtlItemId) {
        let targetUrl = "@Url.Action("GetBarcodeComponentByLN", "ProductionHistory")";
        let postData = {
            "AssemblyBarcodeNo": mainBarcodeNo@(itemName),
            "ComponentMtlItemId": mtlItemId@(itemName)
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        barcodeList = [];

        let innerHtml = '';
        if (data.status == "success") {
            pageCount = data.result.length > 0 ? parseInt(data.result[0]["TotalCount"]) : 0;
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {
                    barcodeList.push(item.BarcodeNo);
                    innerHtml += `<tr>
                                    <td>${i+1}.</td>
                                    <td>
                                        ${item.BarcodeNo}<br>
                                        ${JudgeItemValue@(itemName)(`${item.ItemValue}`)}
                                    </td>
                                    <td>${item.BarcodeQty}</td>
                                    <td class="text-center active-content">
                                        ${JudgeMoMtlSettingAttribute@(itemName)(`${item.ItemNo}`, `${item.MtlItemNo}`, `${item.MtlItemName}`)}
                                        <a class="active-link" href="javascript:Delete@(itemName)('${item.BarcodeComponentId}', '${MtlItemId}', '${item.MtlItemNo}', '${item.MtlItemName}');">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </td>
                                </tr>`;
                });

                function JudgeMoMtlSettingAttribute@(itemName)(itemNo, mtlItemNo, mtlItemName) {
                    let innerHtml = '';
                    if (itemNo == "null") {
                        innerHtml += `<a class="active-link" href="javascript:PopViewMoMtlSettingAttribute('${woErpFullNo@(itemName)}', '${mtlItemNo}', '${mtlItemName}', '${moProcessId@(itemName)}', '${MtlItemId}', '${moId@(itemName)}');">
                                        <i class="far fa-paperclip"></i>
                                      </a>`;
                    }
                    else {
                        innerHtml += `<a class="active-link active-disable" href="javascript:void(0);">
                                        <i class="far fa-paperclip"></i>
                                      </a>`;
                    }

                    return innerHtml;
                }

                function JudgeItemValue@(itemName)(itemValue) {
                    let innerHtml = '';
                    if (itemValue != "null") {
                        let itemValueJson = JSON.parse(itemValue);
                        $.each(itemValueJson["data"], function (k, item2) {
                            innerHtml += `<code>${item2.ItemValue}</code><br>`;
                        });
                    }

                    return innerHtml;
                }
            }
            else {
                innerHtml += `<tr>
                                <td class="text-center" colspan="4" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }
        }
        else {
            alert(data.msg, "alert", 0);
        }

        $("#tblBarcodeComponent@(itemName) tbody").html(innerHtml);
        TableComponentInit();
    }

    $("#txtBarcodeNo@(itemName)").off('keydown');
    $("#txtBarcodeNo@(itemName)").keydown(function (event) {
        if (event.keyCode == 13) {
            Save@(itemName)();
        }
    });

    function InitBarcodeComponentL@(itemName)(MtlItemId) {
        let innerHtml = '';
        let targetUrl = "@Url.Action("GetBarcodeComponentL", "ProductionHistory")";
        let postData = {
            "AssemblyBarcodeNo": mainBarcodeNo@(itemName),
            "ComponentMtlItemId": mtlItemId@(itemName)
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {
                    innerHtml += `<tr>
                                    <td>${i + 1}.</td>
                                    <td>
                                        ${item.LotNumberNo}<br>
                                    </td>
                                    <td>${item.Quantity}</td>
                                    <td class="text-center active-content">
                                        <a class="active-link" href="javascript:DeleteL@(itemName)('${item.BarcodeComponentId}', '${MtlItemId}', '${item.MtlItemNo}', '${item.MtlItemName}');">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </td>
                                  </tr>`;
                });
            }
            else {
                innerHtml += `<tr>
                                <td class="text-center" colspan="4" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }
        }
        else {
            alert(data.msg);
        }

        $("#tblBarcodeComponentL@(itemName) tbody").html(innerHtml);
        TableComponentInit();

        $("#txtLotNumber@(itemName)").off('keydown');
        $("#txtLotNumber@(itemName)").keydown(function (event) {
            if (event.keyCode == 13) {
                SaveL@(itemName)();
            }
        });
    }

    function Save@(itemName)() {
        let ComponentBarcodeNo = $("#txtBarcodeNo@(itemName)").val();
        let AssemblyBarcodeNo = mainBarcodeNo@(itemName);
        $("#txtBarcodeNo@(itemName)").val("");
        if (ComponentBarcodeNo == "") {
            alert("上料條碼不能為空!");
            return false;
        }

        if (barcodeList.indexOf(ComponentBarcodeNo) == -1) {
            let targetUrl = "@Url.Action("AddBarcodeComponent", "ProductionHistory")";
            let postData = {
                "ComponentBarcodeNo": ComponentBarcodeNo,
                "AssemblyBarcodeNo": AssemblyBarcodeNo,
                "MoProcessId": moProcessId@(itemName)
            };
            let result = DataAccess.Add(targetUrl, postData, false, false);

            if (result) {
                InitBarcodeComponent@(itemName)(mtlItemId@(itemName));
                Return@(itemName)();
                ReturnMesScanningInterface();
            }
        }
        else {
            let targetUrl = "@Url.Action("DeleteBarcodeComponent", "ProductionHistory")";
            let postData = {
                "ComponentBarcodeNo": ComponentBarcodeNo,
                "MoProcessId": moProcessId@(itemName)
            };
            let result = DataAccess.Delete(targetUrl, postData, false, false);

            if (result) {
                let MtlItemNo = $("#desBindMtlItemNo@(itemName)").text();
                let MtlItemName = $("#desBindMtlItemName@(itemName)").text();
                Edit@(itemName)(mrDetailId@(itemName), MtlItemNo, MtlItemName);
                Return@(itemName)();
                ReturnMesScanningInterface();
            }
        }
    }

    function Delete@(itemName)(BarcodeComponentId, MtlItemId, MtlItemNo, MtlItemName) {
        swal.fire({
            titleText: "確認要刪除嗎?",
            text: "此動作無法復原，請確認是否要執行!",
            icon: "warning",
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                let targetUrl = "@Url.Action("DeleteBarcodeComponent", "ProductionHistory")";
                let postData = {
                    "BarcodeComponentId": BarcodeComponentId
                };

                let result = DataAccess.Delete(targetUrl, postData, false, false);

                if (result) {
                    Edit@(itemName)(MtlItemId, MtlItemNo, MtlItemName, objPage@(itemName), "B");
                    Return@(itemName)();
                }
            }
        });
    }

    function SaveL@(itemName)() {
        let lotNumber = $("#txtLotNumber@(itemName)").val();
        let assemblyBarcodeNo = mainBarcodeNo@(itemName);
        $("#txtLotNumber@(itemName)").val("");
        if (lotNumber == "") {
            alert("上料批號不能為空!!");
            return false;
        }

        let targetUrl = "@Url.Action("AddBarcodeComponentL", "ProductionHistory")";
        let postData = {
            "AssemblyBarcodeNo": assemblyBarcodeNo,
            "LotNumber": lotNumber,
            "MoProcessId": moProcessId@(itemName),
            "ComponentMtlItemId": mtlItemId@(itemName)
        };
        let result = DataAccess.Add(targetUrl, postData, false, false);

        if (result) {
            InitBarcodeComponentL@(itemName)();
            Return@(itemName)();
            ReturnMesScanningInterface();
        }
    }

    function DeleteL@(itemName)(BarcodeComponentId, MtlItemId, MtlItemNo, MtlItemName) {
        swal.fire({
            titleText: "確認要刪除嗎?",
            text: "此動作無法復原，請確認是否要執行!",
            icon: "warning",
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                let targetUrl = "@Url.Action("DeleteBarcodeComponentL", "ProductionHistory")";
                let postData = {
                    "BarcodeComponentId": BarcodeComponentId
                };

                let result = DataAccess.Delete(targetUrl, postData, false, true);

                if (result) {
                    $("#BindMtlItemByLotModal@(itemName)").modal("hide");
                    Return@(itemName)();
                }
            }
        });
    }

    function AllUnlink@(itemName)() {
        swal.fire({
            titleText: "確認要刪除嗎?",
            text: "此動作無法復原，請確認是否要執行!",
            icon: "warning",
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                let targetUrl = "@Url.Action("DeleteAllBarcodeComponent", "ProductionHistory")";
                let postData = {
                    "MoId": moId@(itemName)
                };

                let result = DataAccess.Delete(targetUrl, postData, false, false);

                if (result) {
                    Return@(itemName)();
                }
            }
        });
    }

    function Return@(itemName)() {
        Query@(itemName)();
    }

    function Close@(itemName)(modalName) {
        //$("#" + modalName).modal('hide');
        $("#" + modalName + " input").val("");
    }
</script>
                )