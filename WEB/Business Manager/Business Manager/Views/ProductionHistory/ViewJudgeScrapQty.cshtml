@using Business_Manager.Helpers
@{
    string itemName = "ViewJudgeScrapQty";
    string itemNameText = "審核報廢數量";
}

@Html.Resource("css",
    @<style>
         .modal-body {
             max-height: 50vh;
             overflow-y: auto;
         }

         .table-sticky thead .col-sticky:nth-last-child(1) {
             right: 0;
         }

         .table-sticky tbody .col-sticky:nth-last-child(1) {
             right: 0;
         }
    </style>
        )

<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    <span class="sub-title">製令: <span class="sub-text" id="desWoErpFullNo@(itemName)"></span></span>
                </h5>
                <a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)('modal@(itemName)')"><i class="fas fa-times"></i></a>
            </div>
            <div class="modal-body">
                <div class="row" id="listData@(itemName)">
                    <div class="col-12">
                        <div class="table-custom">
                            <table class="table table-bordered table-striped table-sticky" id="tblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col" style="min-width: 50px;">#</th>
                                        <th scope="col" style="min-width: 110px;">站別</th>
                                        <th scope="col" style="min-width: 100px;">報廢數量</th>
                                        <th scope="col" style="min-width: 110px;">投入數量</th>
                                        <th scope="col" style="min-width: 110px;">良品數量</th>
                                        <th scope="col" style="min-width: 110px;">不良品數量</th>
                                        <th scope="col" style="min-width: 100px;">目前在製數量</th>
                                        <th scope="col" style="min-width: 100px;">判定人員</th>
                                        <th class="text-center col-sticky" scope="col" style="min-width: 150px;">操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

<!-- 改判報廢數量 -->
<div class="modal fade" id="AddJudgeScraptQty@(itemName)">
    <div class="modal-dialog modal-lg" style="padding-top:7%;">
        <div class="modal-content working-content" style="min-width:350px;">
            <div class="modal-header" style="align-items: center;">
                <h5 class="modal-title">
                    改判報廢數量
                    <span class="sub-title">改判站別: <span class="sub-text" id="desProcessAlias@(itemName)"></span></span>
                    <span class="sub-title">原報廢數量: <span class="sub-text" id="desScraptQty@(itemName)"></span></span>
                </h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row" id=" ">
                    <div class="col-12">
                        <form autocomplete="off" id="editForm@(itemName)">
                            <div class="row">
                                <div class="col-lg-12 col-md-12 ">
                                    <div class="form-group row">
                                        <label class="form-label col-12" for="cboJudgeType@(itemName)">改判類型<span class="text-danger">*</span></label>
                                        <div class="col-12">
                                            <select id="cboJudgeType@(itemName)" class="form-control">
                                                <option value="P">良品</option>
                                                <option value="F" selected>不良品</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="PassType@(itemName)" style="display: none;">
                                <div class="row">
                                    <div class="col-lg-12 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="txtPassBarcodeQty@(itemName)">改判PASS數量<span class="text-danger">*</span></label>
                                            <div class="col-12">
                                                <input type="number" class="form-control" id="txtPassBarcodeQty@(itemName)" name="txtPassBarcodeQty@(itemName)"
                                                       data-rule-required="true" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="NgType@(itemName)">
                                <div class="row">
                                    <div class="col-lg-12 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="txtNgQty@(itemName)">NG數量<span class="text-danger">*</span></label>
                                            <div class="col-12">
                                                <input type="number" class="form-control" id="txtNgQty@(itemName)" name="txtNgQty@(itemName)"
                                                       data-rule-required="true" />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-12 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="cboNextMoProcess@(itemName)">下一站製程<span class="text-danger">*</span></label>
                                            <div class="col-12">
                                                <select class="form-control" id="cboNextMoProcess@(itemName)" required></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-lg-12 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="txtCauseNo@(itemName)">NG原因<span class="text-danger">*</span></label>
                                            <div class="col-12">
                                                <input type="text" class="form-control" id="txtCauseNo@(itemName)" name="txtCauseNo@(itemName)"
                                                       data-rule-required="true"
                                                       oninput="EditDefectCauseNo@(itemName)('txtCauseNo@(itemName)');" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
            <div class="card-footer text-right text-lg-right">
                <button type="button" class="btn btn-success" onclick="Save@(itemName)()"><i class="fas fa-paper-plane"></i>確認</button>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
@<script>
    let objForm@(itemName) = "#editForm@(itemName)";

    let moId@(itemName);

    let moProcessId@(itemName);

    $(function () {
        $("#cboJudgeType@(itemName)").change(function () {
            if ($("#cboJudgeType@(itemName)").val() == "P") {
                $("#PassType@(itemName)").show();
                $("#NgType@(itemName)").hide();
            }
            else if ($("#cboJudgeType@(itemName)").val() == "F") {
                $("#PassType@(itemName)").hide();
                $("#NgType@(itemName)").show();
            }
        });
    });

    function Pop@(itemName)(moId, woErpFullNo, machineId) {
        moId@(itemName) = moId;

        $("#desWoErpFullNo@(itemName)").html(woErpFullNo);

        if (!isMobile) {
            $("#cboProdModeQ@(itemName)").select2({
                width: "100%"
            });
        }

        Query@(itemName)();

        ComboBoxs.Default("#cboNextMoProcess@(itemName)", "@Url.Action("GetMoProcess", "ProductionHistory")", { "MoId": moId}, "", "NA", "", "ProcessAlias", "MoProcessId");

        $("#modal@(itemName)").modal({
            backdrop: "static",
            keyboard: false,
            show: true
        });
    }

    function Query@(itemName)() {
        InitData@(itemName)();
    }

    function InitData@(itemName)() {
        let innerHtml = '';

        let targetUrl = "@Url.Action("GetMoProcess", "ProductionHistory")";
        let postData = {
            "MoId": moId@(itemName)
        };
        let data = DataAccess.Get(targetUrl, postData, false);

        if (data.status == "success") {
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {
                    innerHtml += `<tr>
                                    <td>${i+1}.</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.ProcessAlias}" style="min-width: 110px;">${item.ProcessAlias}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.TotalScrapQty}" style="min-width: 100px;">${item.TotalScrapQty}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.TotalInputQty}" style="min-width: 100px;">${item.TotalInputQty}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.TotalPassQty}" style="min-width: 100px;">${item.TotalPassQty}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.TotalNgQty}" style="min-width: 100px;">${item.TotalNgQty}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.WipQty}" style="min-width: 100px;">${item.WipQty}</td>
                                    <td class="ellipsis" data-toggle="tooltip" title="${item.UserNo}${item.UserName}" style="min-width: 100px;"><i class="fas fa-user"></i>&nbsp;<code>${item.UserNo}</code>&nbsp;${item.UserName}</td>
                                    <td class="ellipsis text-center active-content col-sticky" style="min-width: 150px;">
                                        <a class="active-link" href="javascript: Edit@(itemName)('${item.MoProcessId}', '${item.ProcessAlias}', '${item.TotalScrapQty}', '${item.NgToBarcode}');"><i class="fas fa-user-check"></i> 改判</a>
                                    </td>
                                  </tr>`;
                });
            } else {
                innerHtml += `<tr>
                                <td class="text-center" colspan="9" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }
        } else {
            alert(data.msg, "alert", 0);
        }

        $("#tblData@(itemName) tbody").html(innerHtml);
        TableComponentInit();
    }

    function Edit@(itemName)(moProcessId, processAlias, scraptQty, ngToBarcode) {
        moProcessId@(itemName) = moProcessId;
        $("#AddJudgeScraptQty@(itemName)").modal("show");
        $("#desProcessAlias@(itemName)").html(processAlias);
        $("#desScraptQty@(itemName)").html(scraptQty);
    }

    function EditDefectCauseNo@(itemName)(id) {
        clearTimeout(timer)
        timer = setTimeout(function () {
            let defectCauseNo = $("#" + id + "").val();
            let targetUrl = "@Url.Action("GetNgCause", "QmsBasicInformation")";
            let postData = {
                "CauseNo": defectCauseNo
            };
            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                if (data.result.length <= 0) {
                    alert("找不到此NG代碼!");
                    $("#" + id + "").val("");
                }
            }
            else {
                alert(data.msg);
            }
        }, 500);
    }

    function Save@(itemName)() {
        let judgeType = $("#cboJudgeType@(itemName)").val();

        if (judgeType == "P") {
            let passBarcodeQty = $("#txtPassBarcodeQty@(itemName)").val();
            if (passBarcodeQty == "") {
                alert("改判PASS數量不能為空!");
                return false;
            }

            let targetUrl = "@Url.Action("UpdateJudgeScraptQty", "ProductionHistory")";
            let postData = {
                "MoProcessId": moProcessId@(itemName),
                "JudgeType": judgeType,
                "PassBarcodeQty": passBarcodeQty
            };

            let result = DataAccess.Update(targetUrl, postData, false, true);

            if (result) {
                Close@(itemName)('AddJudgeScraptQty@(itemName)');
            }
        }
        else if (judgeType == "F") {
            let ngQty = $("#txtNgQty@(itemName)").val();
            let nextMoProcess = $("#cboNextMoProcess@(itemName)").val();
            let causeNo = $("#txtCauseNo@(itemName)").val();

            if (ngQty == "" || nextMoProcess == "" || causeNo == "") {
                alert("請將資訊都填寫完畢!");
                return false;
            }

            let targetUrl = "@Url.Action("UpdateJudgeScraptQty", "ProductionHistory")";
            let postData = {
                "MoProcessId": moProcessId@(itemName),
                "JudgeType": judgeType,
                "NgQty": ngQty,
                "NextMoProcessId": nextMoProcess,
                "CauseNo": causeNo
            };

            let result = DataAccess.Update(targetUrl, postData, false, true);

            if (result) {
                Close@(itemName)('AddJudgeScraptQty@(itemName)');
            }
        }
    }

    function Close@(itemName)(modalName) {
        $("#" + modalName + "").modal('hide');
        ResetForm(objForm@(itemName));
    }
</script>
                    )