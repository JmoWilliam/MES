@using Business_Manager.Helpers
@{
    string itemName = "ViewUploadOQCFile";
    string itemNameText = "上傳出貨檢資料";
}

@Html.Resource("css",
    @<style>
         /*.modal-body {
             max-height: 50vh;
             overflow-y: auto;
         }*/

        div.loadingdiv {
            height: 100%;
            width: 100%;
            /*100%覆蓋網頁內容, 避免user在loading時進行其他操作*/
            position: fixed;
            z-index: 99999;
            /*須大於網頁內容*/
            top: 0;
            left: 0;
            display: block;
            background: #000;
            opacity: 0.6;
            text-align: center;
        }

        div.loadingdiv img {
            position: relative;
            vertical-align: middle;
            text-align: center;
            margin: 0 auto;
            margin-top: 50vh;
        }
    </style>
                                                                                )

<div class="modal fade" data-backdrop="static" id="modal@(itemName)" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    <span class="sub-title">製令ID: <span class="sub-text" id="desMoId@(itemName)"></span></span>
                    <span class="sub-title">製令NO: <span class="sub-text" id="desWoErpFullNo@(itemName)"></span></span>
                </h5>
                <a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)('UploadModal@(itemName)')"><i class="fas fa-times"></i></a>
            </div>
            <div class="modal-body" style="max-height: 350px;">
                <div class="row">
                    <div class="col-12">
                        <div class="card card-shadow mb-4">
                            <div class="card-body">
                                <div class="container">
                                    <div style="display: flex;">
                                        <select class="form-control" id="cboQcMachineMode@(itemName)"></select>
                                        <select class="form-control" id="cboFilePathSetting@(itemName)"></select>
                                        <input id="txtDate@(itemName)" class="form-control" type="date" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-6 col-md-12" style="margin-bottom: -15px; padding: 15px;">
                                            <div class="form-group row">
                                                <div class="col-12">
                                                    <input type="checkbox" id="cbxSelectAll@(itemName)" style="width: 15px; height: 15px;" /><label style="font-size: 18px; font-weight: 600; cursor:pointer;" for="cbxSelectAll@(itemName)">&nbsp;全選</label>
                                                    <label style="font-size: 18px; font-weight: 600; margin-left: 25px; cursor:pointer;" onclick="Previous@(itemName)()">&nbsp;<i class="fas fa-arrow-square-left"></i> 回到上一頁</label>
                                                    <label style="font-size: 18px; font-weight: 600; margin-left: 25px; cursor:pointer;" onclick="GetRoot@(itemName)()">&nbsp;<i class="fas fa-home"></i> 回到首頁</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row" style="max-height: 150px; overflow: scroll;">
                                        <div class="col-lg-12 col-md-12">
                                            <div class="form-group row">
                                                <div class="col-12">
                                                    <div class="row context-scroll" id="folder">
                                                        <!--資料夾項目-->
                                                    </div>
                                                    <div class="context-scroll" style="display:none;" id="files">
                                                        <!--檔案項目-->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="javascript: Save@(itemName)();">
                    <i class="far fa-paper-plane"> 上傳檔案</i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="loadingdiv" id="loading" style="display: none">
    <img src="~/assets/images/new-loading.gif" style="width: 75px;"/>
</div>

@Html.Resource("js",
@<script>
    let moId@(itemName);
    let modeNo@(itemName);
    let modeName@(itemName);
    let itemSeq@(itemName);
    let prePath@(itemName);
    let userId@(itemName);

    function Pop@(itemName)(moId, modeNo, modeName, itemSeq, userId) {
        moId@(itemName) = moId;
        modeNo@(itemName) = modeNo;
        modeName@(itemName) = modeName;
        itemSeq@(itemName) = itemSeq;
        userId@(itemName) = userId;

        $("#desMoId@(itemName)").html(moId);
        $("#desWoErpFullNo@(itemName)").html($("#txtWoErpNoMesOQC").text());

        $("#cbxSelectAll@(itemName)").not(":disabled").prop("checked", false);

        $.each($("label[data-folder-path][data-folder-name]"), function (i) {
            let folderPath = $(this).data("folder-path");
            let folderName = $(this).data("folder-name")

            let targetUrl = "@Url.Action("GetFiles", "ProductionHistory")";
            let postData = {
                FolderPath: folderPath
            };
            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
            let innerHtml = '';
            $.each(data.result, function (i, item) {
                    innerHtml += `<div class="col-md-12" style="font-size: 20px;">
                                    <input id="cbxFile@(itemName)${item.FileName}" type="checkbox" data-mo-id="${moId@(itemName)}" data-file-path="${item.FilePath}" data-file-name="${item.FileName}" style="width: 15px; height: 15px;"/>
                                    <i class="fas fa-file"></i>
                                    <label data-folder-path="${item.FilePath}" data-folder-name="${item.FileName}" for="cbxFile@(itemName)${item.FileName}"> ${item.FileName}</label>
                                </div>`;
            });
            $(`#folderFile@(itemName)${folderName}`).append(innerHtml);
            }
        });

        if (!isMobile) {
            $("#cboProdModeQ@(itemName)").select2({
                width: "100%"
            });
        }

        $("#modal@(itemName)").modal({
            backdrop: "static",
            keyboard: false,
            show: true
        });

        $("#cbxSelectAll@(itemName)").off("click").on("click", function () {
            if ($("#cbxSelectAll@(itemName)").is(":checked")) {
                $("input[type='checkbox'][data-mo-id][data-file-path][data-file-name]").not(":disabled").prop("checked", true);
            } else {
                $("input[type='checkbox'][data-mo-id][data-file-path][data-file-name]").not(":disabled").prop("checked", false);
            }
        });

        ComboBoxs.Default("#cboQcMachineMode@(itemName)", "@Url.Action("GetQcMachineMode", "QmsBasicInformation")", {}, "", "", "請選擇", "QcMachineModeWithNoName", "QcMachineModeId");
        $("#cboFilePathSetting@(itemName)").empty();

        let QcMachineModeId = $("#cboQcMachineMode@(itemName)").val();
        ComboBoxs.Default("#cboFilePathSetting@(itemName)", "@Url.Action("GetFilePathSetting", "ProductionHistory")", { "QcMachineModeId": QcMachineModeId }, "", "", "請選擇", "ItemNo", "ItemNo");
        GetRoot@(itemName)();
    }

    $(function () {
        $("#cboQcMachineMode@(itemName)").change(function () {
            let QcMachineModeId = $("#cboQcMachineMode@(itemName)").val();
            ComboBoxs.Default("#cboFilePathSetting@(itemName)", "@Url.Action("GetFilePathSetting", "ProductionHistory")", { "QcMachineModeId": QcMachineModeId }, "", "", "請選擇", "ItemNo", "ItemNo");
        });

        $("#cboQcMachineMode@(itemName)").change(function () {
            GetRoot@(itemName)();
        });

        $("#cboFilePathSetting@(itemName)").change(function () {
            GetRoot@(itemName)();
        });

        $("#txtDate@(itemName)").change(function () {
            GetRoot@(itemName)();
        });
    });

    function GetFolder@(itemName)(filePathSetting, folderName, t) {
        $("#cbxSelectAll@(itemName)").prop("checked", false);
        if (t) {
            let currentFolderPath = $(`#${t.id}`).data("current-folder-path");
            prePath@(itemName) = currentFolderPath;
            filePathSetting = currentFolderPath + "\\" + folderName;
        }

        $("#folder").show();
        $("#folder").empty();
        $("#files").show();
        $("#files").empty();

        GetFiles@(itemName)(filePathSetting);

        let targetUrl = "@Url.Action("GetFolder", "ProductionHistory")";
        let postData = {
            "FilePathSetting": filePathSetting
        };
        let data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {
            let innerHtml = '';
            $.each(data.result, function (i, item) {
                innerHtml += `<div class="col-md-12" style="font-size: 20px;">
                                <i class="fad fa-folders" id="iFolder@(itemName)${item.FolderName}" style="cursor:pointer;" data-folder-path="${item.FolderPath}" data-folder-name="${item.FolderName}" onclick="javascript: GetFiles@(itemName)(this);"></i>
                                <label id="labelFolder@(itemName)${item.FolderName}" style="cursor:pointer;" data-folder-path="${item.FolderPath}" data-folder-name="${item.FolderName}" data-current-folder-path="${filePathSetting}" onclick="javascript: GetFolder@(itemName)('${filePathSetting}', '${item.FolderName}', this);"> ${item.FolderName}</label>
                                <div id="folderFile@(itemName)${item.FolderName}" data-folder-path = "${item.FolderPath}" style="display: none;"></div>
                                <hr>
                              </div>`;
            });
            $("#folder").append(innerHtml);
        }
    }

    function GetFiles@(itemName)(filePathSetting) {
        $("#cbxSelectAll@(itemName)").prop("checked", true);
        $("#files").empty();
        $("#files").hide();

        let targetUrl = "@Url.Action("GetFiles", "ProductionHistory")";
        let postData = {
            FolderPath: filePathSetting
        };
        let data = DataAccess.Get(targetUrl, postData, false);
        if (data.status == "success") {
            let innerHtml = '';
            $.each(data.result, function (i, item) {
                if (item.FileName.indexOf('.alx.txt') != -1 || item.FileName.indexOf('.aly.txt') != -1 || item.FileName.indexOf('.alx.BF.txt') != -1 || item.FileName.indexOf('.aly.BF.txt') != -1 || item.FileName.indexOf('.csv') != -1 || item.FileName.indexOf('.png') != -1 || item.FileName.indexOf('.xlsx') != -1) {
                    innerHtml += `<div class="col-md-12" style="font-size: 20px;">
                                    <input id="cbxFile@(itemName)${item.FileName}" type="checkbox" data-mo-id="${moId@(itemName)}" data-file-path="${item.FilePath}" data-file-name="${item.FileName}" style="width: 15px; height: 15px;" checked/>
                                    <i class="fas fa-file"></i>
                                    <label data-folder-path="${item.FilePath}" data-folder-name="${item.FileName}" for="cbxFile@(itemName)${item.FileName}"> ${item.FileName}</label>
                                  </div>`;
                }
            });
            $(`#files`).append(innerHtml);
            $("#files").show();
        }
    }

    function GetRoot@(itemName)() {
        let qcMachineModeNo = $("#cboQcMachineMode@(itemName) option:selected").text().split('-')[0];
        let filePathSettingItem = $("#cboFilePathSetting@(itemName)").val();
        let date1 = new Date($("#txtDate@(itemName)").val()).Format("yyyy-MM");
        let date2 = new Date($("#txtDate@(itemName)").val()).Format("yyMMdd");

        let filePathSetting = "";
        if (qcMachineModeNo == "UA3P") {
            filePathSetting = qcMachineModeNo + "\\" + filePathSettingItem + "\\" + date1 + "\\" + date2;
            GetFolder@(itemName)(filePathSetting);
        }
        else {
            filePathSetting = qcMachineModeNo + "\\" + filePathSettingItem + "\\" + date1 + "\\" + date2 + "\\" + moId@(itemName);
            GetFiles@(itemName)(filePathSetting);
        }
    }

    function Previous@(itemName)() {
        if (typeof (prePath@(itemName)) != "undefined") {
            GetFolder@(itemName)(prePath@(itemName));
        }
    }

    function Save@(itemName)() {
        postDataJson.filePaths = [];
        $.each($("input[type='checkbox'][data-mo-id][data-file-path][data-file-name]:checked"), function (i, item) {
            let filePath = $(this).data("file-path");
            let inputFilePaths =
            {
                [i]: filePath
            };
            postDataJson.filePaths.push(inputFilePaths);
        });

        if (postDataJson.filePaths.length <= 0) {
            alert("至少需選擇一個項目!", "alert", 3000);
            return false;
        }

        $.ajax({
            url: "@Url.Action("UploadQcFile", "ProductionHistory")",
            type: "POST",
            async: true,
            data: {
                PostData: JSON.stringify(postDataJson)
            },
            dataType: "json",
            beforeSend: function (XMLHttpRequest) {
                $('#loading').css("display", "");
            },
            success: function (data) {
                if (data.status == "success") {
                    result = data;
                    swal.fire({
                        icon: "success",
                        title: "新增完成"
                    });

                    let dataJson = JSON.parse(result.data);
                    console.log(dataJson);

                    let innerHtml = '';
                    let barcodeNo = "";
                    let qcItemType = "";
                    let lettering = "";
                    let qcNoticeItemSpecId = -1;
                    tempQcItemJson.tempQcItemInfo = [];
                    $.each(barcodeNoListMesOQC, function (j, currentBarcodeNo) {
                        innerHtml = '';
                        $.each(dataJson, function (i, item) {
                            barcodeNo = item.BarcodeNo;
                            qcItemType = item.QcItemType;
                            lettering = item.Lettering;
                            filePath = item.filePath;
                            qcNoticeItemSpecId = item.QcNoticeItemSpecId;
                            let divInfo = $("div[data-barcode-no='" + barcodeNo + "']").html();
                            if (typeof (divInfo) == "undefined") {
                                alert("解析資料與刷取條碼不相符，無法進行工程檢!", "alert", 3000);
                                $(".qc-item-main-body").empty();
                                return false;
                            }

                            //確認是否要做makeCount卡控
                            if (currentBarcodeNo == barcodeNo) {
                                $("div[data-barcode-no='" + barcodeNo + "']").empty();
                                innerHtml += `<div class="col-md-6">
                                                <div class="form-group row">
                                                    <label style="font-weight: 600;" class="col-12 col-form-label" for="txt${item.QcItemName}@(itemName)">${item.QcItemName}-${item.Ordinal} (${item.CavityNo}-${item.ReplicateNo})
                                                        <span id="des${item.QcItemName}" data-barcode-no="${barcodeNo}" data-make-count="${item.Ordinal}" data-qc-machine-mode-id="${item.QcMachineModeId}" data-qmm-detail-Id="${item.QmmDetailId}" style="color: red;">(${item.MachineDesc})</span>
                                                        <span id="desCreateUser${item.QcItemName}" data-make-count="${item.Ordinal}" data-barcode-no="${barcodeNo}" data-qc-machine-mode-id="${item.QcMachineModeId}" data-qmm-detail-Id="${item.QmmDetailId}" ></span>
                                                    </label>
                                                    ${JudgeQcItemType@(itemName)(`${item.QcItemType}`, `${item.QcItemName}`, `${item.DesignValue}`, `${item.UpperTolerance}`, `${item.LowerTolerance}`)}
                                                    <input id="txtQmmDetailId@(itemName)${item.QcItemName}${item.Ordinal}" data-qc-machine-mode-id="" style="display: none;"/>
                                                    <input id="txtQcNoticeItemSpecId@(itemName)${item.QcItemName}${item.Ordinal}" data-barcode-no="${barcodeNo}" data-make-count="${item.Ordinal}" style="display: none;" value="${item.QcNoticeItemSpecId}"/>
                                                    <div class="col-12">
                                                        <div class="input-group">
                                                            <input type="text" class="form-control" data-barcode-no="${barcodeNo}" data-qc-notice-item-spec-id="${item.QcNoticeItemSpecId}" data-qc-item-id="${item.QcItemId}" data-qc-item-name="${item.QcItemName}" data-qc-item-no="${item.QcItemNo}" data-make-count="${item.Ordinal}" data-cavity-no="${item.CavityNo}" data-replicate-no=${item.ReplicateNo} data-repeat-no="${item.RepeatNo}" id="txt${item.QcItemName}@(itemName)" onInput="Edit@(itemName)(this)" value="${item.QcItemType != `3` ? item.MeasureValue : ``}" readonly/>
                                                        </div>
                                                    </div>
                                                </div>
                                              </div>`;

                                function JudgeQcItemType@(itemName)(qcItemType, qcItemName, designValue, upperTolerance, lowerTolerance) {
                                    let inputHtml = '';
                                    if (qcItemType == "1") {
                                        inputHtml += `<label style="font-weight: 600;" class="col-12 col-form-label design-label-style" for="txt${qcItemName}@(itemName)">
                                                        <span class="design-style"><i class="fas fa-sort-alt"></i> 標準值:${designValue}</span>
                                                        <span class="design-style"> 上限:${parseFloat(designValue) + parseFloat(upperTolerance)}</span>
                                                        <span class="design-style"> 下限:${parseFloat(designValue) + parseFloat(lowerTolerance)}</span>
                                                      </label>`;

                                    }
                                    else {
                                        inputHtml += `<label style="font-weight: 600;" class="col-12 col-form-label design-label-style" for="txt${qcItemName}@(itemName)">
                                                        <span class="design-style"><i class="fas fa-sort-alt"></i> 良品:P 不良品:F</span>
                                                      </label>`;
                                    }
                                    return inputHtml;
                                }

                                if (item.QcItemType == "3") {
                                    let inputQcItemInfo =
                                    {
                                        "QcNoticeItemSpecId": item.QcNoticeItemSpecId,
                                        "BarcodeNo": item.BarcodeNo,
                                        "QcItemId": item.QcItemId,
                                        "QcItemName": item.QcItemName,
                                        "MakeCount": item.Ordinal,
                                        "MeasureValue": "",
                                        "SystemStatus": item.MeasureValue,
                                        "QcMachineModeId": item.QcMachineModeId,
                                        "QmmDetailId": item.QmmDetailId,
                                        "Remark": "",
                                        "CreateUserId": userId@(itemName)
                                    };
                                    tempQcItemJson.tempQcItemInfo.push(inputQcItemInfo);
                                }
                                else {
                                    let inputQcItemInfo =
                                    {
                                        "QcNoticeItemSpecId": item.QcNoticeItemSpecId,
                                        "BarcodeNo": item.BarcodeNo,
                                        "QcItemId": item.QcItemId,
                                        "QcItemName": item.QcItemName,
                                        "MakeCount": item.Ordinal,
                                        "MeasureValue": item.MeasureValue,
                                        "QcMachineModeId": item.QcMachineModeId,
                                        "QmmDetailId": item.QmmDetailId,
                                        "Remark": "",
                                        "CreateUserId": userId@(itemName)
                                    };
                                    tempQcItemJson.tempQcItemInfo.push(inputQcItemInfo);
                                }

                                $("div[data-barcode-no='" + barcodeNo + "']").append(innerHtml);
                            }
                        });
                    });

                    Close@(itemName)();
                    
                    if (qcItemType == "3") {
                        $("#btnAiCheckMesOQC").show();
                        $("#btnAiCheckMesOQC").prop("href", `javascript: PopViewAiCheck('${moId@(itemName)}', '${woErpFullNo@(itemName)}', '${processAlias@(itemName)}', '${checkUser@(itemName)}', '${barcodeNo}', '${lettering}', '${qcNoticeItemSpecId}')`);
                        PopViewAiCheck(moId@(itemName), woErpFullNo@(itemName), processAlias@(itemName), checkUser@(itemName), barcodeNo, lettering, qcNoticeItemSpecId);
                    }
                    
                } else {
                    alert(data.msg, "error", 0);
                }
            },
            complete: function (XMLHttpRequest, textStatus) {
                $('#loading').css("display", "none");
                if (textStatus == 'timeout') {
                    var xmlhttp = window.XMLHttpRequest ? new window.XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHttp");
                    xmlhttp.abort();
                    alert("網路逾時!");
                }
            },
            error: function (XMLHttpRequest, textStatus) {
                alert(XMLHttpRequest.statusText, "error", 0);
            }
        });
    }

    function Close@(itemName)() {
        $("#modal@(itemName)").modal('hide');
        postDataJson.filePaths = [];
    }
</script>
                    )