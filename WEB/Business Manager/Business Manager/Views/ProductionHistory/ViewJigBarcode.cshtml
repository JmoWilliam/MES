@using Business_Manager.Helpers
@{
    string itemName = "ViewJigBarcode";
    string itemNameText = "治具綁定條碼資料";
}

@Html.Resource("css",
    @<style>
         .modal-body {
             max-height: 50vh;
             overflow-y: auto;
         }
    </style>
                                )

<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="width: 650px;">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    <span class="sub-title">
                        <span data-key="order">製令:</span>

                         <span class="sub-text" id="desWoErpFullNo@(itemName)"></span>
                    </span>
                    <span class="sub-title">
                        <span data-key="currentprocess">製程:</span>
                         <span class="sub-text" id="desProcessAlias@(itemName)"></span>
                    </span>
                    <span class="sub-title">
                        <span data-key="machine">機台:</span>
                         <span class="sub-text" id="desMachineName@(itemName)"></span>
                    </span>
                    <a style="margin-top: 5px;" class="btn btn-info" data-toggle="modal" data-target="#AddJigBarcodeModal@(itemName)" data-backdrop="static">
                        <i class="fas fa-plus"></i>                        <span data-key="AddFixture">新增治具:</span>
                        
                    </a>
                    <a id="aChangeMoId@(itemName)" style="margin-top: 5px;" class="btn btn-primary" href="javascript: PopViewChangeMoId()">
                        <i class="fas fa-exchange"></i>                        <span data-key="ChangeManufacturingOrderProcess">更換製令製程:</span>
                        
                    </a>
                </h5>
                <a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)('modal@(itemName)')"><i class="fas fa-times"></i></a>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!--左邊table-->
                    <div class="col-5 material-block">
                        <div class=" table-outer" style="border: solid 1px #eee; max-height: 30vh;">
                            <table id="JigBarcodeMainTable@(itemName)" class="table-platform-sticky" style="padding: 0.2rem;">
                                <thead>
                                    <tr class="headerrow">
                                        <th scope="col" width="10%">#</th>
                                        <th data-key="fixture" scope="col" width="60%">治具</th>
                                        <th data-key="quantity" scope="col" width="10%"><span class="">數量</span></th>
                                        <th data-key="operation" scope="col" width="20%">操作</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <!--右邊table-->
                    <div class="col-7 add-code-block" style="display:none;">
                        <div class="input-group mb-2" style="">
                            <label class="input-group-addon" for="basic-addon" style="">
                                <i class="far fa-barcode-alt"></i>
                                <span style="padding-left: 5px;" data-key="barcode">條碼</span>
                            </label>
                            <input type="text" class="form-control form-control-add" id="txtBarcodeNo@(itemName)" placeholder="請刷取模仁條碼" data-key="PleaseScanTheMoldBarcode">
                        </div>
                        <div class="table-outer" style="border: solid 1px #eee; max-height: 30vh;">
                            <table id="JigBarcodeTable@(itemName)" class="table-platform-sticky" style="padding: 0.2rem;">
                                <thead>
                                    <tr class="headerrow">
                                        <th scope="col" width="10%">#</th>
                                        <th data-key="productbarcode" scope="col" width="50%">產品條碼</th>
                                        <th data-key="operation" scope="col" width="20%">操作</th>

                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

<!--新增治具-->
<div class="modal fade" id="AddJigBarcodeModal@(itemName)" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    新增治具
                </h5>
                <a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)('AddJigBarcodeModal@(itemName)')"><i class="fas fa-times"></i></a>
            </div>
            <div class="modal-body">
                <div class="row" id="listData@(itemName)">
                    <div class="col-12">
                        <div class="form-group row">
                            <label class="col-12 col-form-label" for="txtJigNo@(itemName)" data-key="fixturebarcode">治具條碼</label>
                            <div class="col-12">
                                <input type="text" id="txtJigNo@(itemName)" class="form-control" />
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="form-group row">
                            <label class="col-12 col-form-label" for="txtJigBarcodeNo@(itemName)"  data-key="productbarcode">產品條碼</label>
                            <div class="col-12">
                                <input type="text" id="txtJigBarcodeNo@(itemName)" class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="SaveJigBarcode@(itemName)()">
                    <i class="fas fa-save"></i>
                    <span data-key="save">儲存:</span>

                    
                </button>
            </div>
        </div>
    </div>
</div>

@Html.Partial("ViewChangeMoId")

@Html.Resource("js",
@<script>
    let moProcessId@(itemName);
    let woErpFullNo@(itemName);
    let jigId@(itemName);
    let editBarcodeNo = [];
    let checkAnyJig = false;
    let machineId@(itemName);

    function Pop@(itemName)(moProcessId, woErpFullNo, processAlias, machineId, machineName) {
        moProcessId@(itemName) = moProcessId;
        woErpFullNo@(itemName) = woErpFullNo;
        machineId@(itemName) = machineId;

        $("#desWoErpFullNo@(itemName)").html(woErpFullNo);
        $("#desProcessAlias@(itemName)").html(processAlias);
        $("#desMachineName@(itemName)").html(machineName);

        $("#aChangeMoId@(itemName)").prop("href", `javascript: PopViewChangeMoId('${machineId@(itemName)}')`)

        Query@(itemName)();

        setTimeout(function () {
            $("#txtBarcodeNo@(itemName)").focus();
        },200);

        $("#modal@(itemName)").modal({
            backdrop: "static",
            keyboard: false,
            show: true
        });
    }

    $(function () {
        $("#txtJigBarcodeNo@(itemName)").keydown(function (event) {
            if (event.keyCode == 13) {
                SaveJigBarcode@(itemName)();
            }
        });

        $("#txtJigNo@(itemName)").keydown(function (event) {
            if (event.keyCode == 13) {
                $("#txtJigBarcodeNo@(itemName)").focus();
            }
        });

        $(window).keydown(function (event) {
            if (event.keyCode == 13) {
                event.preventDefault();
                return false;
            }
        });

        @*$("#txtJigNo@(itemName)").on("input", function () {
            $(this).val($(this).val().replace(/[^a-zA-Z0-9]/g, ""));
        });

        $("#txtJigBarcodeNo@(itemName)").on("input", function () {
            $(this).val($(this).val().replace(/[^a-zA-Z0-9]/g, ""));
        });*@
    });

    function Query@(itemName)() {
        InitData@(itemName)();
    }

    function InitData@(itemName)() {
        let targetUrl = "@Url.Action("GetJigBarcode", "ProductionHistory")";

        let postData = {
            "MoProcessId": moProcessId@(itemName)
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        let innerHtml = '';
        let firstJigId = -1;
        if (data.status == "success") {
            checkAnyJig = false;
            if (data.result.length > 0) {
                checkAnyJig = true;
                $.each(data.result, function (i, item) {
                    let trClass = "";
                    if (i % 2 == 0) trClass = "line-odd";
                    else trClass = "line-even";

                    if (i == 0) {
                        firstJigId = item.JigId;
                    }

                    innerHtml += `<tr id="${item.JigId}" class="${trClass}">
                                    <td width="10%">${i + 1}.</td>
                                    <td width="60%">${item.JigName}</td>
                                    <td width="10%"><span class="">${item.Count}</span></td>
                                    <td width="20%">
                                        <a class="active-link" href="javascript:Edit@(itemName)('${item.JigId}');" data-mtl-id="1">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                  </tr>`;
                });
            }
            else {
                $(".add-code-block").hide();
                innerHtml += `<tr>
                                <td class="text-center" colspan="4" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }
        }
        else {
            alert(data.msg, "alert", 0);
        }

        $("#JigBarcodeMainTable@(itemName) tbody").html(innerHtml);
        TableComponentInit();

        Edit@(itemName)(firstJigId);
    }

    function Edit@(itemName)(jigId) {
        editBarcodeNo = [];
        jigId@(itemName) = jigId;

        $("td").removeClass("line-active");
        $("tr[id='" + jigId + "'] td").addClass("line-active");

        if (checkAnyJig == true) $(".add-code-block").show();
        else $(".add-code-block").hide();

        let targetUrl = "@Url.Action("GetJigBarcodeDetail", "ProductionHistory")";

        let postData = {
            "JigId": jigId,
            //"MoProcessId": moProcessId@(itemName)
        };

        let data = DataAccess.Get(targetUrl, postData, false);

        let innerHtml = '';
        if (data.status == "success") {
            if (data.result.length > 0) {
                $.each(data.result, function (i, item) {
                    editBarcodeNo.push(item.BarcodeNo);
                    let trClass = "";
                    if (i % 2 == 0) trClass = "line-odd";
                    else trClass = "line-even";

                    innerHtml += `<tr class="${trClass}">
                                    <td width="10%">${i + 1}.</td>
                                    <td width="50%">${item.BarcodeNo}</td>
                                    <td width="20%">
                                        <a class="active-link" href="javascript:Delete@(itemName)('${item.JigBarcodeId}')">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </td>
                                  </tr>`;
                });
            }
            else {
                innerHtml += `<tr>
                                <td class="text-center" colspan="3" style="background-color: #fff3cd;">
                                    <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                </td>
                              </tr>`;
            }
        }
        else {
            alert(data.msg, "alert", 0);
        }

        $("#JigBarcodeTable@(itemName) tbody").html(innerHtml);
        TableComponentInit();
    }

    function SaveJigBarcode@(itemName)() {
        let jigNo = $("#txtJigNo@(itemName)").val();
        let jigBarcodeNo = $("#txtJigBarcodeNo@(itemName)").val();
        if (jigNo == "" || jigBarcodeNo == "") {
            alert("治具條碼或產品條碼不能為空!");
            return false;
        }
        let targetUrl = "@Url.Action("AddJigBarcode", "ProductionHistory")";
        let postData = {
            "JigNo": $("#txtJigNo@(itemName)").val(),
            "BarcodeNo": $("#txtJigBarcodeNo@(itemName)").val(),
            "MoProcessId": moProcessId@(itemName),
            "MachineId": machineId@(itemName)
        };
        let data = DataAccess.EditContinued(targetUrl, postData, false);
        if (data) {
            let JigId;
            $.each(data.result, function (i, item) {
                JigId = item.JigId;
            });
            Return@(itemName)();
            Edit@(itemName)(JigId);
            Close@(itemName)('AddJigBarcodeModal@(itemName)');
            $("#txtJigNo@(itemName)").val("");
            $("#txtJigBarcodeNo@(itemName)").val("");
            $("#txtBarcodeNo@(itemName)").focus();
        }
    }

    $("#txtJigBarcodeNo@(itemName)").keydown(function (event) {
        if (event.keyCode == 13) {
            SaveJigBarcode@(itemName)();
        }
    });

    $("#txtBarcodeNo@(itemName)").keydown(function (event) {
        if (event.keyCode == 13) {
            let barcodeNo = $("#txtBarcodeNo@(itemName)").val();
            $("#txtBarcodeNo@(itemName)").val("");

            if (editBarcodeNo.indexOf(barcodeNo) == -1) {
                let targetUrl = "@Url.Action("AddJigBarcode", "ProductionHistory")";
                let postData = {
                    "JigId": jigId@(itemName),
                    "BarcodeNo": barcodeNo,
                    "MoProcessId": moProcessId@(itemName),
                    "MachineId": machineId@(itemName)
                };

                let data = DataAccess.EditContinued(targetUrl, postData, false);
                if (data) {
                    let JigId;
                    $.each(data.result, function (i, item) {
                        JigId = item.JigId;
                    });
                    Return@(itemName)();
                    Edit@(itemName)(JigId);
                    $("#txtBarcodeNo@(itemName)").focus();
                }
            }
        }
    });

    function Delete@(itemName)(JigBarcodeId) {
        swal.fire({
            titleText: "確認要刪除嗎?",
            text: "此動作無法復原，請確認是否要執行!",
            icon: "warning",
            allowOutsideClick: false,
            allowEscapeKey: false,
            showCancelButton: true,
            confirmButtonColor: '#d33',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                let targetUrl = "@Url.Action("DeleteJigBarcodeDetail", "ProductionHistory")";
                let postData = {
                    "JigBarcodeId": JigBarcodeId
                };

                let result = DataAccess.Delete(targetUrl, postData, false, true);

                if (result) {
                    Return@(itemName)();
                }
            }
        });
    }

    function Return@(itemName)() {
        editBarcodeNo = [];
        Query@(itemName)();
    }

    function Close@(itemName)(modalName) {
        $("#" + modalName).modal('hide');
        $("#" + modalName + " input").val("");
    }
</script>
                    )