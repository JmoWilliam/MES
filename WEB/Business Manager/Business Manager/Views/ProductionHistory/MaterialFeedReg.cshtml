@using Business_Manager.Helpers
@{
    string itemName = "MaterialFeedReg";
    string itemNameText = "投料登记";
    string authority = ViewBag.authority;

    //string UserId = "-1";
    //UserId = Request["UserId"].ToString();
    string UserId = Session["UserId"].ToString();
}
@Html.Resource("css",
@<link href="@Url.Content("~/Content/mes_scan.min.css")?20220623v1" rel="stylesheet" />
                        )
@Html.Resource("css",
@<style>
     .container_full {
         margin-top: 0;
     }

     /* login_03 */
     .select-content {
         display: flex;
         justify-content: space-around;
         flex-direction: row;
     }
      
         .select-content .select-item {
             display: flex;
             width: 50%;
         }
          
             .select-content .select-item .select-self {
                 flex-direction: column;
             }

                 .select-content .select-item .select-self a, .select-content .select-item .select-self .select-font {
                     color: #fff;
                 }

                 .select-content .select-item .select-self span {
                     font-size: 18px;
                     color: #fff;
                 }

     /* login_03 彈窗 機台&站別選擇表格 */
     .dataselect_table {
         display: table;
         border-collapse: collapse;
         text-align: center;
         width: 100%;
         /* margin-top: 0.5rem; */
     }

     .dataselect_td .button_choose {
         padding: 10px 20px;
         background-color: #a768f3;
         color: #fff;
         border-radius: 10px;
         box-shadow: none;
     }

         .dataselect_td .button_choose:hover {
             background-color: #a768f3;
         }


     .dataselect_td, .dataselect_th {
         padding: 0.3rem;
         font-size: 16px;
         line-height: 2.2;
         border-bottom: 1px solid #dee2e6;
     }

     .dataselect_th {
         display: table-cell;
         background-color: #ccc;
         font-weight: bold;
     }

     .dataselect_tr:nth-of-type(odd) {
         background-color: rgba(0,0,0,.03);
     }


     .line-active {
         background-color: #e3b9ff;
     }



     .form-control {
         font-size: 1rem;
     }
</style>
                        )
<div class="container" id="MesConsole">
    <div class="login-content">

        <div class="login-form">
            <div class="logo">
                <a>
                    <img src="@Url.Content("~/Content/images/logo.png")" />
                </a>
            </div>
            <input type="hidden" id="MatFeedRegId" name="MatFeedRegId" value="-1" />
            <div class="input-group">
                <span class="input-group-addon font18" id="basic-addon13" data-key="order">
                    <i class="fa fa-paint-brush" style="padding-right: 5px;"></i> 機台
                </span>
                <input type="text" class="form-control form-control-add lang" id="txtMachineId@(itemName)"
                       aria-describedby="basic-addon13" placeholder="請輸入機台號碼" key="CONTACT" data-key="entermo">
                <div class="input-group-append">
                    <button type="button" class="border-danger" onclick="cleanMachineId@(itemName) ()" title="清除">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
            <div class="input-group">
                <span class="input-group-addon font18" id="basic-addon13" data-key="order">
                    <i class="fa fa-paint-brush" style="padding-right: 5px;"></i> 製令
                </span>
                <input type="text" class="form-control form-control-add lang" id="txtMoId@(itemName)"
                       aria-describedby="basic-addon13" placeholder="請輸入製令號碼" key="CONTACT" data-key="entermo"
                       onkeypress="return handleEnterKey(event, 'SelectMoId@(itemName)()')"> <!-- 添加回车键处理 -->
                <div class="input-group-append">
                    <button type="button" class="border-danger" onclick="cleanMoId@(itemName) ()" title="清除">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
            <div class="input-group">
                <span class="input-group-addon font18" id="basic-addon13">
                    <i class="fa fa-paint-brush" style="padding-right: 5px;"></i> 材料
                </span>
                <select class="form-control" id="cboMaterialId@(itemName)" name="cboMaterialId@(itemName)">
                    <option value="">-- 請選擇材料 --</option>
                </select>
            </div>
            <div class="input-group">
                <span class="input-group-addon font18" id="basic-addon13" data-key="order">
                    <i class="fa fa-paint-brush" style="padding-right: 5px;"></i> 投料數量
                </span>
                <input type="text" class="form-control form-control-add lang" id="txtMatInRegQty@(itemName)"
                       aria-describedby="basic-addon13" placeholder="請輸入投料數量" key="CONTACT" data-key="entermo">
                <div class="input-group-append">
                    <button type="button" class="border-danger" onclick="cleanMatInRegQty@(itemName) ()" title="清除">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>
            <div class="input-group">
                <span class="input-group-addon font18" id="basic-addon13" data-key="order">
                    <i class="fa fa-paint-brush" style="padding-right: 5px;"></i> 單位
                </span>
                <select class="form-control" id="cboUomId@(itemName)" name="cboUomId@(itemName)"></select>
            </div>
            <div class="input-group">
                <span class="input-group-addon font18" id="basic-addon13" data-key="order">
                    <i class="fa fa-paint-brush" style="padding-right: 5px;"></i> 備註
                </span>
                <input type="text" class="form-control form-control-add lang" id="txtRemarks@(itemName)"
                       aria-describedby="basic-addon13" placeholder="請輸入備註" key="CONTACT" data-key="entermo">
                <div class="input-group-append">
                    <button type="button" class="border-danger" onclick="cleanRemarks@(itemName) ()" title="清除">
                        <i class="fas fa-eraser"></i>
                    </button>
                </div>
            </div>

            <button type="button" class="btn-sure btn btn-success btn-flat mb-2 weight-600"
                    onclick="javascript: EnterMaterialFeedingReg();">
                確定
            </button>
            <button type="button" class="btn-sure btn btn-primary btn-flat mb-2 weight-600"
                    onclick="javascript:location.href='/ProductionHistory/MaterialFeedingRecord';">
                投料記錄
            </button>
            <div class="logout" style="width:unset;padding:unset;margin-top: 10px;">
                <a class="btn" onclick="javascript:Logout@(itemName)();">
                    登出<i class="fa fa-sign-out ml-1" style=""></i>
                </a>
            </div>
        </div>
    </div>
</div>


@Html.Resource("js",
@<script>
    let deviceIp@(itemName) = "";
    let objPage@(itemName) = {
        "pageIndex": 0,
        "pageSize": 10
    };
    
    
    let defaultMaterialId@(itemName) = ""; // 新增：存储默认材料ID

    $(document).ready(function () {
       ComboBoxs.Default("#cboUomId@(itemName)", "@Url.Action("GetUnitOfMeasure", "PdmBasicInformation")", { "Status": "A" }, "97", "NA", "", "UomWithNo", "UomId");
        $(`#cboUomId@(itemName)`).select2({
                dropdownAutoWidth: true,
                width: "100%"
            });
    });
    // 处理回车键
    function handleEnterKey(event, functionCall) {
        if (event.key === 'Enter' || event.keyCode === 13) {
            eval(functionCall); // 执行传入的函数调用
            return false; // 阻止表单提交
        }
        return true;
    }

    function EnterMaterialFeedingReg() {
        // 验证机台资料信息
        SelectMatInRegKey@(itemName)();
        // 获取表单值
        const moId = $("#txtMoId@(itemName)").val().trim();
        const materialId = $("#cboMaterialId@(itemName)").val();
        const quantity = $("#txtMatInRegQty@(itemName)").val().trim();
        const UomId = $("#cboUomId@(itemName)").val().trim();
        const Remarks = $("#txtRemarks@(itemName)").val().trim();
        // 统一验证处理函数
        const validateField = (value, message) => {
            if (!value) {
                    alert(message, "alert", 0);
                return false;
            }
            return true;
        };
        // 按顺序验证必填字段
        if (!validateField(moId, "製令不可為空")) return;
        if (!validateField(materialId, "材料未選擇")) return;
        if (!validateField(quantity, "投料數量不可為空")) return;
        if (!validateField(UomId, "單位不可為空")) return;
        // 可选：添加数值类型验证
        if (isNaN(parseFloat(quantity)) || parseFloat(quantity) == 0) {
            alert("投料數量不能為0", "alert", 0);
            return; 
        }

        if ($("#txtMachineId@(itemName)").val() != "" && $("#txtMoId@(itemName)").val() != "" && $("#cboMaterialId@(itemName)").val() != ""
            && $("#txtMatInRegQty@(itemName)").val() != "" && $("#cboUomId@(itemName)").val() != "") {
            let MatFeedRegId = parseInt($("#MatFeedRegId").val());
            console.log(112, MatFeedRegId);
            if (MatFeedRegId <= 0) {
                    let targetUrl = "@Url.Action("AddMaterialFeedReg", "ProductionHistory")";
                    let postData = {
                        "MachineId": $("#txtMachineId@(itemName)").val(),
                        "MoId": $("#txtMoId@(itemName)").val(),
                        "MaterialId": $("#cboMaterialId@(itemName)").val(),
                        "MatInRegQty": $("#txtMatInRegQty@(itemName)").val(),
                        "UomId": $("#cboUomId@(itemName)").val(),
                        "Remarks": $("#txtRemarks@(itemName)").val()
                    };
                console.log("查询结果:", postData)
                    let data = DataAccess.EditContinued(targetUrl, postData, false);

                    if (data) {
                        $.each(data.result, function (i, item) {
                            $("#MatFeedRegId").val(item.MatFeedRegId);
                        });
                        alert("投料登記成功", "success", 1);
                        // 重置表单
                        resetForm@(itemName)();
                    } else {
                        alert("投料登記失敗: " + (data.msg || "未知錯誤"), "error", 0);
                    }
                }
        }

    }

    function SelectMatInRegKey@(itemName)() {
        if ($("#txtMachineId@(itemName)").val() == "") {
            alert("機台編號不可為空", "alert", 0);
        } else {
            let targetUrl = "@Url.Action("GetMachine", "ProductionHistory")";
            let postData = {
                "MachineId": $("#txtMachineId@(itemName)").val()
            };
            let data = DataAccess.Get(targetUrl, postData, false);
            console.log("機台查询结果:", data.result)
            if (data.status == "success") {
                if (data.result.length > 0) {
                    $.each(data.result, function (i, item) {
                        $("#txtMachineId@(itemName)").attr("data-machine-info", JSON.stringify(item));
                    });
                }
                else {
                    alert("查無機台資料!!");
                }
            }
            else {
                alert(data.msg);
            }
        }
    }

    function SelectMoId@(itemName)() {
        if ($("#txtMoId@(itemName)").val() == "") {
            alert("製令不可為空", "alert", 0); 
        } else {
            let targetUrl = "@Url.Action("GetWorOrderMaterial", "ProductionHistory")";
            let postData = {
                "MoId": $("#txtMoId@(itemName)").val()
            };
            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                console.log("制令查询结果:", data.result.length)
                if (data.result.length > 0) {
                    let MoId = $("#txtMoId@(itemName)").val();
                    ComboBoxs.Default("#cboMaterialId@(itemName)", "@Url.Action("GetWorOrderMaterial", "ProductionHistory")", { "MoId": MoId }, "", "CHOOSE", "", "PixMtlItem", "MtlItemId");
                    $(`#cboMaterialId@(itemName)`).select({
                        dropdownAutoWidth: true,
                        width: "100%"
                    });
                } else {
                    alert("查無此製令", "alert", 0);
                    defaultMaterialId@(itemName) = "";
                }
            } else {
                alert(data.msg, "alert", 0);
                defaultMaterialId@(itemName) = "";
            }
        }
    }

    function Logout@(itemName)() {
        let targetUrl = "@Url.Action("Logout", "User")";
        let postData = {
        };

        var result = DataAccess.Update(targetUrl, postData, false, false);

        if (result) window.location.reload();
    }

    // 新增：重置表单函数
    function resetForm@(itemName)() {
        $('#txtMachineId@(itemName)').val('');
        $('#txtMoId@(itemName)').val('');
        $('#cboMaterialId@(itemName)').empty().append('<option value="">-- 請選擇材料 --</option>');
        $('#txtMatInRegQty@(itemName)').val('');
        defaultMaterialId@(itemName) = "";
        $('#MatFeedRegId').val('-1'); 
        $('#txtRemarks@(itemName)').val('');
    }

    //清除
    function cleanMachineId@(itemName) () {
        $('#txtMachineId@(itemName)').val('');
    }

    function cleanMoId@(itemName) () {
        $('#txtMoId@(itemName)').val('');
        // 清除关联的材料选择
        $('#cboMaterialId@(itemName)').empty().append('<option value="">-- 請選擇材料 --</option>');
        defaultMaterialId@(itemName) = "";
    }

    function cleanMatInRegQty@(itemName) () {
        $('#txtMatInRegQty@(itemName)').val('');
    }

    function cleanMaterialId@(itemName) () {
        $('#cboMaterialId@(itemName)').val('');
    }

    function cleanRemarks@(itemName) () {
        $('#txtRemarks@(itemName)').val('');
    }

</script>
                        )