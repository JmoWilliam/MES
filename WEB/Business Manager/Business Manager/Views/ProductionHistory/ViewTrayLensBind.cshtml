@using Business_Manager.Helpers
@{
    string itemName = "ViewTrayLensBind";
    string itemNameText = "Tray盤綁定鏡頭條碼";

    ViewBag.Title = itemNameText;
}

@Html.Resource("css",
    @<style>
         #modalViewCreateNewBarcode .modal-body {
             max-height: 60vh;
             overflow-y: auto;
         }

         .table-sticky thead .col-sticky:nth-last-child(1) {
             right: 0;
         }

         .table-sticky tbody .col-sticky:nth-last-child(1) {
             right: 0;
         }

         /*#modalWatchPictureViewMeasureData .modal-body {
             height: 65vh;
             overflow-y: auto;
         }

         .image-style {
             display: flex;
             justify-content: center;
             overflow: scroll;
         }

         .pre-icon-style {
             background-color: #0d0930;
             width: 30px;
             height: 30px;
             margin-bottom: 250px;
         }

         #listDataViewMeasureData .table-custom {
             max-height: 56vh;
         }*/
    </style>
                          )

<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    @*<label class="form-label" for="txtBarcodeNoQ@(itemName)">請輸入Tray條碼</label>
                        <input type="text" class="form-control" id="txtBarcodeNoQ@(itemName)" name="txtBarcodeNoQ@(itemName)"
                               placeholder="請輸入Tray條碼" />
                        <label class="form-label" for="txtBarcodeNoQ2@(itemName)">請輸入批量條碼Tray條碼</label>
                        <input type="text" class="form-control" id="txtBarcodeNoQ2@(itemName)" name="txtBarcodeNoQ2@(itemName)"
                               placeholder="請輸入批量條碼" />
                        <span class="sub-title">製令: <span class="sub-text" id="desWoErpFullNo@(itemName)"></span></span>
                        <span class="sub-title">目前製程: <span class="sub-text" id="desProcessAlias@(itemName)"></span></span>
                        <span class="sub-title">Tray盤綁定批量條碼: <span class="sub-text" id="desBindBarcode@(itemName)"></span></span>
                        <span class="sub-title">Tray盤可綁定數: <span class="sub-text" id="desBindBarcodeQty@(itemName)"></span></span>*@
                </h5>
                <a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)('#modal@(itemName)')"><i class="fas fa-times"></i></a>
            </div>
            <div class="modal-body">
                <div class="row" id="listData@(itemName)">
                    <div class="col-12">
                        <form autocomplete="off" id="queryForm@(itemName)">
                            <fieldset>
                                <div class="form-row align-items-center mb-2">
                                    <input type="hidden" id="txtBarcodeID@(itemName)" value="" />

                                    <div class="col-lg-3 col-6">
                                        <label class="form-label" for="txtBarcodeNoQ@(itemName)" data-key="pleaseentertraybarcode">請輸入Tray條碼</label>
                                        <input type="text" class="form-control" id="txtBarcodeNoQ@(itemName)" name="txtBarcodeNoQ@(itemName)"
                                               placeholder="請輸入Tray條碼" data-key="pleaseentertraybarcode" />
                                    </div>

                                </div>
                                <div class="form-row align-items-center mb-2">
                                    <div class="col-lg-3 col-6">
                                        <label class="form-label" for="txtBarcodeNoQ2@(itemName)" data-key="pleaseenterbatchbarcode(lot)">請輸入批量條碼(LOT)</label>
                                        <input type="text" class="form-control" id="txtBarcodeNoQ2@(itemName)" name="txtBarcodeNoQ2@(itemName)"
                                               placeholder="請輸入批量條碼" data-key="pleaseenterbatchbarcode(lot)" />
                                    </div>

                                </div>
                                <h5 class="modal-title">
                                    <span class="sub-title">
                                        <span data-key="order">
                                            製令:
                                        </span>

                                        <span class="sub-text" id="desWoErpFullNo@(itemName)"></span>
                                    </span>
                                    <span class="sub-title">
                                        <span data-key="currentprocess">
                                            目前製程:
                                        </span>
                                        <span class="sub-text" id="desProcessAlias@(itemName)"></span>
                                    </span>
                                    <span class="sub-title">
                                        <span data-key="traybindingbatchbarcode">
                                            Tray盤綁定批量條碼:
                                        </span>
                                        <span class="sub-text" id="desBindBarcode@(itemName)"></span>
                                    </span>
                                    <span class="sub-title">
                                        <span data-key="traybindingcount">
                                            Tray盤可綁定數:
                                        </span>
                                        <span class="sub-text" id="desBindBarcodeQty@(itemName)"></span>
                                    </span>
                                </h5>
                                <div class="form-row align-items-center mb-2">
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtXTrayLocalQ@(itemName)" name="txtXTrayLocalQ@(itemName)"
                                               placeholder="請輸入Tray X軸位置" />
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtYTrayLocalQ@(itemName)" name="txtYTrayLocalQ@(itemName)"
                                               placeholder="請輸入Tray Y軸位置" />
                                    </div>
                                    <div class="col-auto">
                                        <input type="text" class="form-control" id="txtLensBarcodeQ@(itemName)" name="txtLensBarcodeQ@(itemName)"
                                               placeholder="請輸入鏡頭條碼" />
                                    </div>
                                    <div class="col-auto">
                                        <label class="col-12 col-form-label" id="txtBindCountQ@(itemName)">
                                            已綁定: 0 / 0
                                        </label>
                                    </div>
                                    <div class="col-auto">
                                        <a class="active-link" href="javascript:UpdateAll@(itemName)();"><i class="fas fa-edit">全部解除綁定</i></a>
                                    </div>
                                    @*<div class="col-auto">
                                            <input type="text" class="form-control" id="txtBarcodeNoQ@(itemName)" name="txtBarcodeNoQ@(itemName)"
                                                   placeholder="請輸入產品條碼搜尋"
                                                   onkeyup="this.value=this.value.replace(/[, ]/g,'')" />
                                        </div>*@

                                </div>


                            </fieldset>
                        </form>

                        <div class="table-custom">

                            <table class="table table-bordered table-striped table-sticky" id="tblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th scope="col" style="min-width: 115px;" data-key="productbarcode">產品條碼</th>
                                        <th scope="col" style="min-width: 115px;" data-key="trayposition">Tray盤位置</th>
                                        <th scope="col" style="min-width: 115px;" data-key="creator">建立人員</th>
                                        <th scope="col" style="min-width: 115px;" data-key="creationtime">建立時間</th>
                                        <th scope="col" style="min-width: 115px;" data-key="operation">操作</th>

                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="pagination" id="page@(itemName)"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>



@Html.Resource("js",
    @<script>
        let objPage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 999
        };

        let objForm@(itemName) = "#editForm@(itemName)";

        let moId@(itemName);
        let moProcessId@(itemName);
        let lotQty@(itemName);
        let barcodePrefix@(itemName);
        let barcodePostfix@(itemName);
        let sequenceLen@(itemName);
        let machineId@(itemName);
        let parentBarcodeId@(itemName);

                let inputType@(itemName);


        function Pop@(itemName)(moId, moProcessId, machineId) {
            moId@(itemName) = moId;
            moProcessId@(itemName) = moProcessId;
            machineId@(itemName) = machineId;
            console.log(248)

            //Query@(itemName)();

            $("#modal@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });

            $("#desWoErpFullNo@(itemName)").html("");
            $("#desProcessAlias@(itemName)").html("");
            $("#desBindBarcode@(itemName)").html("");
            $("#desBindBarcodeQty@(itemName)").html("");
            $("#txtBarcodeNoQ@(itemName)").val("");
            $("#txtXTrayLocalQ@(itemName)").val("");
            $("#txtYTrayLocalQ@(itemName)").val("");
            $("#txtLensBarcodeQ@(itemName)").val("");
            $("#txtBarcodeNoQ2@(itemName)").val("");


             Query@(itemName)()
            if (!isMobile) {
                $("#cboLabelPrintMachine@(itemName)").select2({
                    width: "100%"
                });
            }


            $("#txtBarcodeNoQ@(itemName)").keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    Query@(itemName)();
                    return false;
                }
            });

            $("#txtBarcodeNoQ2@(itemName)").keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    Query2@(itemName)();
                    return false;
                }
            });

            $("#txtTrayLocalQ@(itemName)").keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                   // Query@(itemName)();
                    return false;
                }
            });

             $("#txtLensBarcodeQ@(itemName)").keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    Edit@(itemName)();
                    return false;
                }
            });

            $("#queryForm@(itemName)").keydown(function (event) {
                if (event.keyCode == 13) {
                    event.preventDefault();
                    return false;
                }
            });
        }

        function Query@(itemName)() {
            objPage@(itemName).pageIndex = 0;
            InitData@(itemName)(objPage@(itemName));
        }

        function Query2@(itemName)() {
            objPage@(itemName).pageIndex = 0;
            InitData2@(itemName)(objPage@(itemName));
        }

        function InitData@(itemName)(objPage) {
            let innerHtml = '';
            let pageCount = 0;

            if ($("#txtBarcodeNoQ@(itemName)").val() != "") {
                let targetUrl = "@Url.Action("GetTrayBarcodeInfo", "ProductionHistory")";
                let postData = {
                    "MoId": moId@(itemName),
                    "TrayNo": $("#txtBarcodeNoQ@(itemName)").val().toUpperCase(),
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    inputType@(itemName) = "Tray";

                    pageCount = data.result.length;

                    if (pageCount > 0) {
                        objPage = PageCaculate(pageCount, objPage);
                        $.each(data.result, function (i, item) {
                            let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";
                            $("#desWoErpFullNo@(itemName)").html(item.WoErpPrefix + "-" + item.WoErpNo);
                            $("#desProcessAlias@(itemName)").html(item.ProcessAlias);
                            $("#desBindBarcode@(itemName)").html(item.BarcodeNo);
                            $("#desBindBarcodeQty@(itemName)").html(item.BarcodeQty);
                            $("#txtBarcodeID@(itemName)").val(item.BarcodeId);

                            parentBarcodeId@(itemName) = item.BarcodeId;
                            lotQty@(itemName) = item.BarcodeQty;

                        });

                        GetTrayBindLens@(itemName)(objPage)

                    }
                    else {
                        alert("該Tray盤無綁定任何批量條碼", "alert", 0);

                    }
                } else {
                    alert(data.msg, "alert", 0);
                }
            } else {
                let innerHtml = "";
                innerHtml += `<tr>
                                    <td class="text-center" colspan="9" style="background-color: #fff3cd;">
                                        <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;

                 $("#tblData@(itemName) tbody").html(innerHtml);

            TableComponentInit();
            }

        }

        function InitData2@(itemName)(objPage) {
            let innerHtml = '';
            let pageCount = 0;

            if ($("#txtBarcodeNoQ2@(itemName)").val() != "") {
                let targetUrl = "@Url.Action("GetTrayLOTBarcodeInfo", "ProductionHistory")";
                let postData = {
                    "MoId": moId@(itemName),
                    "inputNo": $("#txtBarcodeNoQ2@(itemName)").val().toUpperCase(),
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    inputType@(itemName) = "LOT";
                    pageCount = data.result.length;

                    if (pageCount > 0) {
                        objPage = PageCaculate(pageCount, objPage);
                        $.each(data.result, function (i, item) {
                            let _row = (objPage.pageSize * objPage.pageIndex + (i + 1)) + ".";
                            $("#desWoErpFullNo@(itemName)").html(item.WoErpPrefix + "-" + item.WoErpNo);
                            $("#desProcessAlias@(itemName)").html(item.ProcessAlias);
                            $("#desBindBarcode@(itemName)").html(item.BarcodeNo);
                            $("#desBindBarcodeQty@(itemName)").html(item.BarcodeQty);
                            $("#txtBarcodeID@(itemName)").val(item.BarcodeId);

                            parentBarcodeId@(itemName) = item.BarcodeId;
                            lotQty@(itemName) = item.BarcodeQty;

                        });

                        GetTrayBindLens@(itemName)(objPage)

                    }
                    else {
                        alert("該Tray盤無綁定任何批量條碼", "alert", 0);

                    }
                } else {
                    alert(data.msg, "alert", 0);
                }
            } else {
                let innerHtml = "";
                innerHtml += `<tr>
                                    <td class="text-center" colspan="9" style="background-color: #fff3cd;">
                                        <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;

                 $("#tblData@(itemName) tbody").html(innerHtml);

            TableComponentInit();
            }

        }

        function GetTrayBindLens@(itemName)(objPage) {
            let innerHtml = '';
            let targetUrl = "@Url.Action("GetTrayBindLens", "ProductionHistory")";
            let postData = {
                "ParentBarcodeId": parentBarcodeId@(itemName)
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                pageCount = data.result.length;
                var countTxt = "已綁定: " + pageCount + "/" + lotQty@(itemName)
                $("#txtBindCountQ@(itemName)").html(countTxt);

                if (pageCount > 0) {
                    objPage = PageCaculate(pageCount, objPage);

                    $.each(data.result, function (i, item) {
                        innerHtml += `<tr>

                                        <td class="ellipsis" data-toggle="tooltip" title="${item.BarcodeNo}" style="min-width: 115px;">
                                            ${item.BarcodeNo}<br>
                                        </td>
<td class="ellipsis" data-toggle="tooltip" title="${item.TrayLocation}" style="min-width: 115px;">
                                            ${item.TrayLocation}<br>
                                        </td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.UserNo}${item.UserName}" style="min-width: 115px;"><i class="fas fa-user"></i>&nbsp;<code>${item.UserNo}</code>&nbsp;${item.UserName}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.CreateDate}" style="min-width: 115px;">${item.CreateDate}</td>
                                        <td class="text-center active-content" style="min-width: 135px;">
                                            <a class="active-link" href="javascript:Update@(itemName)('${item.BarcodeId}');"><i class="fas fa-edit">解除綁定</i></a>
                                         </td>
                                      </tr>`;
                    });
                } else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="9" style="background-color: #fff3cd;">
                                        <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }
            } else {
                alert(data.msg, "alert", 0);
            }

            $("#tblData@(itemName) tbody").html(innerHtml);

            TableComponentInit();
        Pager("#page@(itemName)", pageCount, objPage, GetTrayBindLens@(itemName));

        //<td class="text-center active-content" style="min-width: 135px;">
        //    <a class="active-link" href="javascript:Delete@(itemName)('${item.BarcodeId}');"><i class="fas fa-trash-alt"></i></a>
        //</td>

        }

        @*function GetMoProcessQty@(itemName)() {
            let targetUrl = "@Url.Action("GetMoProcessQty", "ProductionHistory")";
            let postData = {
                "MoProcessId": moProcessId@(itemName)
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                pageCount = data.result.length;


                if (pageCount > 0) {
                    $.each(data.result, function (i, item) {
                        $("#desPassBarcodeQty@(itemName)").html(item.PassBindQty + " / " + item.TotalPassQty);
                        $("#desScrapBarcodeQty@(itemName)").html(item.ScrapBindQty + " / " + item.TotalScrapQty);
                        lotQty@(itemName) = item.LotQty;
                        barcodePrefix@(itemName) = item.BarcodePrefix;
                        barcodePostfix@(itemName) = item.BarcodePostfix;
                        sequenceLen@(itemName) = item.SequenceLen;
                    });
                }
            } else {
                alert(data.msg, "alert", 0);
            }
        }*@



        function Edit@(itemName)() {

            if ($("#txtLensBarcodeQ@(itemName)").val() == "" ) {
                alert("請填入完整資訊", "alert", 0);
                return
            } else {
                if (inputType@(itemName) == "Tray") {
                    let targetUrl = "@Url.Action("AddBarcodeToBindLens", "ProductionHistory")";
                    let postData = {
                        "TrayNo": $("#txtBarcodeNoQ@(itemName)").val(),
                        "XTrayLocation": $("#txtXTrayLocalQ@(itemName)").val(),
                        "YTrayLocation": $("#txtYTrayLocalQ@(itemName)").val(),
                        "MoId": moId@(itemName),
                        "MoProcessId": moProcessId@(itemName),
                        "BarcodeNo": $("#txtLensBarcodeQ@(itemName)").val().toUpperCase()
                    };

                    let data = DataAccess.EditContinued(targetUrl, postData, false);

                    if (data) {
                        //$("#modalQc@(itemName)").modal("hide");
                        $("#txtLensBarcodeQ@(itemName)").val("")
                        $("#txtXTrayLocalQ@(itemName)").val("")
                        $("#txtYTrayLocalQ@(itemName)").val("")

                        Query@(itemName)();
                        alert("新增完成", "success");
                    }
                } else if (inputType@(itemName) == "LOT") {
                    let targetUrl = "@Url.Action("AddBarcodeToBindLensLot", "ProductionHistory")";
                    let postData = {
                        "LotNo": $("#txtBarcodeNoQ2@(itemName)").val(),
                        "XTrayLocation": $("#txtXTrayLocalQ@(itemName)").val(),
                        "YTrayLocation": $("#txtYTrayLocalQ@(itemName)").val(),
                        "MoId": moId@(itemName),
                        "MoProcessId": moProcessId@(itemName),
                        "BarcodeNo": $("#txtLensBarcodeQ@(itemName)").val().toUpperCase()
                    };

                    let data = DataAccess.EditContinued(targetUrl, postData, false);

                    if (data) {
                        //$("#modalQc@(itemName)").modal("hide");
                        $("#txtLensBarcodeQ@(itemName)").val("")
                        $("#txtXTrayLocalQ@(itemName)").val("")
                        $("#txtYTrayLocalQ@(itemName)").val("")

                        Query2@(itemName)();
                        alert("新增完成", "success");
                    }
                }


            }



        }



        function Update@(itemName)(BarcodeId) {
            swal.fire({
                titleText: "確認要解除綁定嗎?",
                text: "此動作無法復原，請確認是否要執行!",
                icon: "warning",
                allowOutsideClick: false,
                allowEscapeKey: false,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    let targetUrl = "@Url.Action("UddateBindingBarcode", "ProductionHistory")";
                    let postData = {
                        "BarcodeId": BarcodeId
                    };

                    let result = DataAccess.Delete(targetUrl, postData, false, false);

                    if (result) {
                        Return@(itemName)();
                    }
                }
            });
        }

        function UpdateAll@(itemName)() {
            swal.fire({
                titleText: "確認要【全部】解除綁定嗎?",
                text: "此動作無法復原，請確認是否要執行!",
                icon: "warning",
                allowOutsideClick: false,
                allowEscapeKey: false,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    let targetUrl = "@Url.Action("UddateAllBindingBarcode", "ProductionHistory")";
                    let postData = {
                        "BarcodeId":  $("#txtBarcodeID@(itemName)").val()
                    };

                    let result = DataAccess.Delete(targetUrl, postData, false, false);

                    if (result) {
                        Return@(itemName)();
                    }
                }
            });
        }


        function Return@(itemName)() {
            //ResetForm(objForm@(itemName));
            //Switch("#listData@(itemName), .list-mode", "#editData@(itemName), .edit-mode");
            $("#txtBarcodeNo@(itemName)").val("");
            if (inputType@(itemName) == "Tray") {
                Query@(itemName)();

            } else if (inputType@(itemName) == "LOT") {
                Query2@(itemName)();

            }

        }

        function Close@(itemName)(modalName) {
            $("#txtBarcodeNoQ@(itemName)").val("")
            $("#txtLensBarcodeQ@(itemName)").val("")
            $("#txtXTrayLocalQ@(itemName)").val("")
            $("#txtYTrayLocalQ@(itemName)").val("")
            $(modalName).modal("hide");
            inputType@(itemName) == "";
            $("#txtBarcodeID@(itemName)").val("");

        }
    </script>
                                                                                        )