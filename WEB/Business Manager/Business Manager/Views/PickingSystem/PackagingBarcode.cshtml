@using Business_Manager.Helpers
@{
    string itemName = "PackagingBarcode";
    string itemNameText = "包裝條碼撿貨";


    ViewBag.Title = itemNameText;
}

<style>
    
    tr.disabled {
        background-color: #f5f5f5;
        color: #999;
    }

    tr.available {
        background-color: #f0f8ff;
    }

    

</style>

<div class="modal fade" id="modalPackagingBarcode@(itemName)">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" style="max-width: 80vw !important; max-height: 95vh !important; width: 80vw; height: 95vh;">
        <div class="modal-content" style="width:100%">
            <div class="modal-header">
                <h5 class="modal-title">包裝揀貨</h5>
                <button class="close" onclick="Return@(itemName)()" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="pack-barcode-container" id="PackagingBarcodePageDiv">

                    <div class="search-section">
                        <div>
                            <span class="number-title">
                                出貨單
                            </span>
                            <span class="number-cell" id="deliverNo@(itemName)">
                            </span>

                        </div>
                        <h2 class="section-title">搜尋條件</h2>
                        <div class="search-row">
                            <input type="hidden" id="deliverId@(itemName)" name="deliverId@(itemName)" value="-1" />

                            <div class="search-group">
                                <label>包裝條碼</label>
                                <input type="text" id="txtPackageBarcode@(itemName)" placeholder="請輸入包裝修碼...">
                            </div>
                            <div class="search-group">
                                <div id="BoxNoDiv">
                                    <input type="hidden" id="boxId@(itemName)" name="boxId@(itemName)" value="-1" />

                                    <label>
                                        物流箱條碼

                                    </label>
                                    <input type="text" id="txtBoxNo@(itemName)" name="txtBoxNo@(itemName)" placeholder="請輸入物流箱條碼"
                                           autocomplete="off" />

                                </div>

                                @*<div class="number choose-carton" id="CartonDetail@(itemName)" style="display: none;"></div>*@
                            </div>
                            @*<div class="search-group">
                                    <label>綁定箱號</label>
                                    <input type="text" id="txtBoxNo@(itemName)" placeholder="綁定箱號...">
                                </div>*@
                            <div>
                                <a class="btn btn-main btn-large" href="javascript:void(0);" onclick="UnCarton@(itemName)()" id="UnCartonB@(itemName)">無物流箱</a>
                                <a class="btn btn-main btn-large" href="javascript:void(0);" onclick="ShowCarton@(itemName)()" id="ShowCartonB@(itemName)">有物流箱</a>

                            </div>
                        </div>
                    </div>

                    <div class="content-wrapper">
                        <div class="stats-section">
                            <h2 class="section-title">出貨明細單 & 撿貨統計</h2>
                            <table class="stats-table" id="DiliverTblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th>選擇</th>
                                        <th>商品</th>
                                        <th>類型</th>
                                        <th>進度</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @*<tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P001</div>
                                                <div class="product-name">測試商品A</div>
                                            </td>
                                            <td><span class="status-badge status-normal">正常品</span></td>
                                            <td>0/5</td>
                                        </tr>
                                        <tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P001</div>
                                                <div class="product-name">測試商品A</div>
                                            </td>
                                            <td><span class="status-badge status-spare">備品</span></td>
                                            <td>0/2</td>
                                        </tr>
                                        <tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P001</div>
                                                <div class="product-name">測試商品A</div>
                                            </td>
                                            <td><span class="status-badge status-gift">贈品</span></td>
                                            <td>0/1</td>
                                        </tr>
                                        <tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P002</div>
                                                <div class="product-name">測試商品B</div>
                                            </td>
                                            <td><span class="status-badge status-normal">正常品</span></td>
                                            <td>0/3</td>
                                        </tr>
                                        <tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P002</div>
                                                <div class="product-name">測試商品B</div>
                                            </td>
                                            <td><span class="status-badge status-spare">備品</span></td>
                                            <td>0/1</td>
                                        </tr>
                                        <tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P002</div>
                                                <div class="product-name">測試商品B</div>
                                            </td>
                                            <td><span class="status-badge status-gift">贈品</span></td>
                                            <td>0/0</td>
                                        </tr>
                                        <tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P003</div>
                                                <div class="product-name">測試商品C</div>
                                            </td>
                                            <td><span class="status-badge status-normal">正常品</span></td>
                                            <td>0/2</td>
                                        </tr>
                                        <tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P003</div>
                                                <div class="product-name">測試商品C</div>
                                            </td>
                                            <td><span class="status-badge status-spare">備品</span></td>
                                            <td>0/1</td>
                                        </tr>
                                        <tr>
                                            <td class="radio-cell">
                                                <input type="radio" name="product-selection" class="custom-radio">
                                            </td>
                                            <td class="product-info">
                                                <div class="product-code">P003</div>
                                                <div class="product-name">測試商品C</div>
                                            </td>
                                            <td><span class="status-badge status-gift">贈品</span></td>
                                            <td>0/0</td>
                                        </tr>*@
                                </tbody>
                            </table>

                        </div>
                        <div class="table-section">
                            <h2 class="section-title">包裝內容物</h2>
                            <table id="barcodeTblData@(itemName)">
                                <thead>
                                    <tr>
                                        <th class="checkbox-cell"><input type="checkbox" id="cbxSelectAll@(itemName)" /></th>
                                        <th>產品條碼</th>
                                        <th>品號</th>
                                        <th>品名</th>
                                        <th>數量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @*<tr>
                                            <td class="checkbox-cell"><input type="checkbox"></td>
                                            <td class="product-code">B001</td>
                                            <td>P001</td>
                                            <td>測試商品A</td>
                                            <td>2</td>
                                            <td><span class="status-badge status-normal">待處理</span></td>
                                        </tr>
                                        <tr>
                                            <td class="checkbox-cell"><input type="checkbox"></td>
                                            <td class="product-code">B002</td>
                                            <td>P002</td>
                                            <td>測試商品B</td>
                                            <td>3</td>
                                            <td><span class="status-badge status-normal">待處理</span></td>
                                        </tr>
                                        <tr>
                                            <td class="checkbox-cell"><input type="checkbox"></td>
                                            <td class="product-code">B003</td>
                                            <td>P003</td>
                                            <td>測試商品C</td>
                                            <td>1</td>
                                            <td><span class="status-badge status-normal">待處理</span></td>
                                        </tr>*@
                                </tbody>
                            </table>
                            <div class="button-group">
                                <button class="btn btn-primary" onclick="Save@(itemName)()">投入揀貨</button>
                            </div>
                        </div>


                    </div>

                </div>

            </div>
            <div class="modal-footer">
                <div class="btn-block">
                    <button class="btn btn-secondary" onclick="Return@(itemName)()"><i class=""></i>&nbsp;返回清單</button>
                </div>
            </div>
        </div>
    </div>
</div>



@Html.Resource("js",
    @<script>
        let maxOrderQuantity@(itemName) = 0;//PickingCartonId
        let picktype@(itemName) = "";
        let pickdetailId@(itemName) = "";
        let pickingCartonId@(itemName) = -999;
        let pickdodetailId@(itemName) = -999;
        let mtlId@(itemName)= -1 ;

        let objPage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };
        
        let objForm@(itemName) = "#editForm@(itemName)";

        function Pop@(itemName)(doid) {
            $("#deliverId@(itemName)").val(doid);
            $("#modalPackagingBarcodePackagingBarcode").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });
            console.log(248, $("#deliverId@(itemName)").val(), doid)

            @*$("#cbxSelectAll@(itemName)").off("click").on("click", function () {
                if ($("#cbxSelectAll@(itemName)").is(":checked")) {
                    $("input[type='checkbox'][data-barcode-id]").not(":disabled").prop("checked", true);
                } else {
                    $("input[type='checkbox'][data-barcode-id]").not(":disabled").prop("checked", false);
                }
            });*@
                        Query@(itemName)();

            $("#txtPackageBarcode@(itemName)").keypress(function (event) {
                var keycode = (event.keyCode ? event.keyCode : event.which);
                if (keycode == '13') {
                    GetPackageInBarcode@(itemName)()
                }


            });

            $("#txtBoxNo@(itemName)").keypress(function (event) {
                var keycode = (event.keyCode ? event.keyCode : event.which);
                if (keycode == '13') {
                    BindBoxNo@(itemName)();
                }


            });
                        $("#ShowCartonB@(itemName)").hide();


        }


        function Query@(itemName)() {
            objPage@(itemName).pageIndex = 0;
            InitData@(itemName)(objPage@(itemName));

        }

        function InitData@(itemName)(objPage) {

            let innerHtml = '';
            let pageCount = 0;
            let targetUrl = "@Url.Action("GetDoDetailForPackage", "PickingSystem")";
            let postData = {
                "DoId": $("#deliverId@(itemName)").val()
            };

            let data = DataAccess.Get(targetUrl, postData, false);//DoErpFullNo deliverNo@(itemName)
            if (data.status == "success") {
                if (data.result.length > 0) {

                    $.each(data.result, function (i, item) {
                        $("#deliverNo@(itemName)").html(item.DoErpFullNo)
                        switch (item.PickType) {
                            case "1":
                                innerHtml += `<tr>
                                                <td class="radio-cell">
                                                    <input type="radio" name="product-selection" class="custom-radio" data-dodetailid-id="${item.DoDetailId}" data-sodetailid-id="${item.SoDetailId}" data-picktype="${item.PickType}" data-pickqty="${item.PickRegularQty}" data-detailqty="${item.RegularQty}" data-mtl-no="${item.MtlItemNo}" data-mtl-id="${item.MtlItemId}">
                                                </td>
                                                <td class="product-info">
                                                    <div class="product-code">${item.MtlItemNo}</div>
                                                    <div class="product-name">${item.MtlItemName}</div>
                                                </td>
                                                <td><span class="status-badge status-spare">${pickType@(itemName)(item.PickType)}</span></td>
                                                <td>${item.PickRegularQty}/${item.RegularQty}</td>
                                              </tr>`;
                                break;
                            case "2":
                                innerHtml += `<tr>
                                                <td class="radio-cell">
                                                    <input type="radio" name="product-selection" class="custom-radio" data-dodetailid-id="${item.DoDetailId}" data-sodetailid-id="${item.SoDetailId}" data-picktype="${item.PickType}" data-pickqty="${item.PickFreebieQty}" data-detailqty="${item.FreebieQty}" data-mtl-no="${item.MtlItemNo}" data-mtl-id="${item.MtlItemId}">
                                                </td>
                                                <td class="product-info">
                                                    <div class="product-code">${item.MtlItemNo}</div>
                                                    <div class="product-name">${item.MtlItemName}</div>
                                                </td>
                                                <td><span class="status-badge status-spare">${pickType@(itemName)(item.PickType)}</span></td>
                                                <td>${item.PickFreebieQty}/${item.FreebieQty}</td>
                                              </tr>`;
                                break;
                            case "3":
                                innerHtml += `<tr>
                                                <td class="radio-cell">
                                                    <input type="radio" name="product-selection" class="custom-radio" data-dodetailid-id="${item.DoDetailId}" data-sodetailid-id="${item.SoDetailId}" data-picktype="${item.PickType}" data-pickqty="${item.PickSpareQty}" data-detailqty="${item.SpareQty}" data-mtl-no="${item.MtlItemNo}" data-mtl-id="${item.MtlItemId}">
                                                </td>
                                                <td class="product-info">
                                                    <div class="product-code">${item.MtlItemNo}</div>
                                                    <div class="product-name">${item.MtlItemName}</div>
                                                </td>
                                                <td><span class="status-badge status-spare">${pickType@(itemName)(item.PickType)}</span></td>
                                                <td>${item.PickSpareQty}/${item.SpareQty}</td>
                                              </tr>`;
                                break;
                            default:
                                break;
                        }




                    });
                } else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="7" style="background-color: #fff3cd;">
                                      <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }

            } else {
                alert(data.msg, "alert", 0);
            }

            $("#DiliverTblData@(itemName) tbody").html(innerHtml);

            TableComponentInit();

            $("input[type='radio']").click(function () {
                if ("[data-sodetailid-id]:checked") {
                    $("input[type='checkbox'][data-barcode-id]").not(":disabled").prop("checked", false);
                    $("#cbxSelectAll@(itemName)").prop("checked", false);
                    //取ID 預計數量 已撿貨數量 maxOrderQuantity TYPE, 若已撿貨數量>0 maxOrderQuantity取(預計數量-已撿貨數量),反之取預計數量
                    //data-pickqty="${item.PickRegularQty} data-detailqty="${item.RegularQty}"
                    pickdetailId@(itemName) = $(this).data("sodetailid-id");
                    picktype@(itemName) = $(this).data("picktype");
                    pickdodetailId@(itemName) = $(this).data("dodetailid-id");
                    mtlId@(itemName) = $(this).data("mtl-id");

                    var preqty = $(this).data("detailqty");
                    var pickedqty = $(this).data("pickqty");
                    if (pickedqty > 0) {
                        maxOrderQuantity@(itemName) = preqty - pickedqty;

                    } else {
                        maxOrderQuantity@(itemName) = preqty;

                    }

                    // 獲取選中的出貨單明細的品號
                    var productNo = $(this).data("mtl-no");

                    // 處理條碼表格
                    $("#barcodeTblData@(itemName) input[type='checkbox'][data-barcode-id]").each(function () {
                        var checkbox = $(this);
                        var row = checkbox.closest("tr");;
                        var rowProductNo = checkbox.data("mtl-no");

                        if (rowProductNo  === productNo) {
                            // 相同品號的行
                            row.removeClass("disabled").addClass("available");
                            checkbox.prop("disabled", false);
                        } else {
                            // 不同品號的行
                            row.addClass("disabled").removeClass("available");
                            checkbox.prop("disabled", true);
                            checkbox.prop("checked", false);
                        }
                        console.log(247, pickdetailId@(itemName), picktype@(itemName), maxOrderQuantity@(itemName), preqty, pickedqty)
                        console.log(2987, productNo, rowProductNo)
                    

                    });

                }
                GetPickitem@(itemName)()
                updateSelectAllState()

            });
        }

        // 全選功能
        $("#cbxSelectAll@(itemName)").click(function () {
            const isChecked = $(this).prop("checked");
            $("#barcodeTblData@(itemName) input[type='checkbox'][data-barcode-id]:not(:disabled)").prop("checked", isChecked);
        });
            // 更新全選checkbox的狀態
        function updateSelectAllState() {
            var availableCheckboxes = $("#barcodeTblData@(itemName) input[type='checkbox'][data-barcode-id]:not(:disabled)");
            var checkedAvailableCheckboxes = $("#barcodeTblData@(itemName) input[type='checkbox'][data-barcode-id]:not(:disabled):checked");

            $("#cbxSelectAll@(itemName)").prop(
                "checked",
                availableCheckboxes.length > 0 &&
                availableCheckboxes.length === checkedAvailableCheckboxes.length
            );
        
        }

        function updateradiuoselectState() {
                    //$("input[type='checkbox'][data-barcode-id]").not(":disabled").prop("checked", false);
                    $("#cbxSelectAll@(itemName)").prop("checked", false);
                    //取ID 預計數量 已撿貨數量 maxOrderQuantity TYPE, 若已撿貨數量>0 maxOrderQuantity取(預計數量-已撿貨數量),反之取預計數量
                    //data-pickqty="${item.PickRegularQty} data-detailqty="${item.RegularQty}"
                    
                    // 獲取選中的出貨單明細的品號
                    var productNo = $("input[type='radio'][data-sodetailid-id]:checked").data("mtl-no");

                    // 處理條碼表格
                    $("#barcodeTblData@(itemName) input[type='checkbox'][data-barcode-id]").each(function () {
                        var checkbox = $(this);
                        var row = checkbox.closest("tr");;
                        var rowProductNo = checkbox.data("mtl-no");

                        if (rowProductNo  === productNo) {
                            // 相同品號的行
                            row.removeClass("disabled").addClass("available");
                            checkbox.prop("disabled", false);
                        } else {
                            // 不同品號的行
                            row.addClass("disabled").removeClass("available");
                            checkbox.prop("disabled", true);
                            checkbox.prop("checked", false);
                        }
                        console.log(311, pickdetailId@(itemName), picktype@(itemName), maxOrderQuantity@(itemName))
                        console.log(312, productNo, rowProductNo)
                    

                    });
                    console.log(313, pickdetailId@(itemName), picktype@(itemName), maxOrderQuantity@(itemName))
                        console.log(314, productNo)
                GetPickitem@(itemName)()
                updateSelectAllState()

        }

            // 監聽個別條碼checkbox的點擊
        $("#barcodeTblData@(itemName) input[type='checkbox'][data-barcode-id]").click(function () {
            updateSelectAllState();
        
        });
        

        function GetPackageInBarcode@(itemName)() {
            let innerHtml = '';


            let targetUrl = "@Url.Action("GetPackageInBarcode", "PickingSystem")";
            let postData = {
                "BarcodeNo": $("#txtPackageBarcode@(itemName)").val()
            };

            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                if (data.result.length > 0) {

                    $.each(data.result, function (i, item) {
                          innerHtml += `<tr>
                                        <td class="text-center" style="max-width: 150px; min-width: 135px;">
                                            <label class="control control-solid control-solid-info control--checkbox">
                                                <input type="checkbox" data-barcode-no="${item.BarcodeNo}" data-barcode-id="${item.BarcodeId}" data-barcode-qty="${item.BarcodeQty}" data-mtl-no="${item.MtlItemNo}" value="${item.BarcodeId}"/>
                                                <span class="control__indicator"></span>
                                            </label>
                                        </td>
                                        <td class="product-code" data-toggle="tooltip" title="${item.BarcodeNo}" style="max-width: 150px;"><span class="stack-title"></span>${item.BarcodeNo}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.MtlItemNo}" style="max-width: 150px;"><span class="stack-title"></span>${item.MtlItemNo}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.MtlItemName}" style="max-width: 150px;"><span class="stack-title"></span>${item.MtlItemName}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.BarcodeQty}" style="max-width: 150px;"><span class="stack-title"></span>${item.BarcodeQty}</td>

                                      </tr>`;

                    });
                } else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="7" style="background-color: #fff3cd;">
                                      <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }

            } else {
                alert(data.msg, "alert", 0);
            }

            $("#barcodeTblData@(itemName) tbody").html(innerHtml);

            TableComponentInit();
            updateradiuoselectState()
            @*$("#cbxSelectAll@(itemName)").off("click").on("click", function () {
                if ($("#cbxSelectAll@(itemName)").is(":checked")) {
                    $("input[type='checkbox'][data-barcode-id]").not(":disabled").prop("checked", true);
                } else {
                    $("input[type='checkbox'][data-barcode-id]").not(":disabled").prop("checked", false);
                }
            });*@
        }


        function Edit@(itemName)() {

        }

        function Save@(itemName)() {
            if ($("#deliverId@(itemName)").val() > 0) {

                let barcodeList = [];
                let jsonString = "";
                if ($("input[type='checkbox'][data-barcode-id]:checked").length > 0) {
                    $.each($("input[type='checkbox'][data-barcode-id]:checked"), function (i) {
                        let barcodeid = $(this).data("barcode-id");
                        let barcodeqty = $(this).data("barcode-qty");
                        let barcodeno = $(this).data("barcode-no");



                        //let createCount = $("input[id='txtCreateCount@(itemName)'][data-process-id='" + processId + "']").val();
                        barcodeList.push({
                            barcodeid: barcodeid,
                            barcodeno: barcodeno,

                            quantity: barcodeqty,
                            category: picktype@(itemName)
                        });



                        //tempNumber@(itemName)++;// not for this case
                    });

                } else {
                    alert("至少需要一筆條碼資料!", "alert", 0);
                    return false;
                }
                var pickjsonn = findBestCombination(maxOrderQuantity@(itemName), barcodeList)
                        jsonString = JSON.stringify(pickjsonn);

                let deliverId = parseInt($("#deliverId@(itemName)").val());
                if (deliverId > 0) {
                    let targetUrl = "@Url.Action("AddPackagePickingItem", "PickingSystem")";
                    let postData = {
                        "DoDetailId": pickdetailId@(itemName),
                        "PickingCartonId": pickingCartonId@(itemName),
                        "PickJson": jsonString,
                        "ItemType": picktype@(itemName)
                    };
                    let data = DataAccess.Get(targetUrl, postData, false);
                    if (data.status == "success") {
                        alert("新增成功", "success", 0);
                        Query@(itemName)()
                       updateradiuoselectState()


                    } else {
                        alert(data.msg, "alert", 0);
                    }
                }
            }
        }

        function BindBoxNo@(itemName)() {
            if (pickdodetailId@(itemName) <= 0) {
                alert('請先選擇要撿貨的出貨單', "alert", 0);
                return false
            }
            let targetUrl = "@Url.Action("GetCartonDetail", "PickingSystem")";
            let postData = {
                "CartonBarcode": $("#txtBoxNo@(itemName)").val(),
                "DoDetailId":  pickdodetailId@(itemName)
            };

        

            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                if (data.result.length > 0) {
                    $.each(data.result, function (i, item) {
                        $("#boxId@(itemName)").val(item.PickingCartonId)
                        pickingCartonId@(itemName) = $("#boxId@(itemName)").val();
                    });
                    alert("該箱子可進行揀貨", "success", 0);

                } else {
                    
                }

            } else {
                alert(data.msg, "alert", 0);
            }

        }

        function UnCarton@(itemName)() {
            $("#txtBoxNo@(itemName)").val("")
            $("#BoxNoDiv").hide();
            $("#ShowCartonB@(itemName)").show();
            $("#UnCartonB@(itemName)").hide();
            pickingCartonId@(itemName) = -999;
            $("#boxId@(itemName)").val("")
        }

        function ShowCarton@(itemName)() {
            $("#txtBoxNo@(itemName)").val("")
            $("#BoxNoDiv").show();
            $("#ShowCartonB@(itemName)").hide();
            $("#UnCartonB@(itemName)").show();
            pickingCartonId@(itemName) = -999;
            $("#boxId@(itemName)").val("")

        

        }

        function findBestCombination(maxSum, barcodes) {
            console.log(249, maxSum, barcodes)

             // 初始化變數
             let bestSolution = null;
             let bestSum = 0;

             // 排序條碼（從大到小）
             const sortedBarcodes = [...barcodes].sort((a, b) => b.quantity - a.quantity);

             // 遞迴搜尋函數
             function search(index = 0, currentSum = 0, currentCombination = []) {
                 // 超過最大值，停止搜尋
                 if (currentSum > maxSum) {
                     return;
                 }

                 // 找到更好的解
                 if (currentSum <= maxSum && currentSum > bestSum) {
                     bestSum = currentSum;
                     bestSolution = [...currentCombination];
                 }

                 // 已經檢查完所有條碼
                 if (index >= sortedBarcodes.length) {
                     return;
                 }

                 // 檢查是否有機會得到更好的解
                 let possibleSum = currentSum;
                 for (let i = index; i < sortedBarcodes.length; i++) {
                     possibleSum += sortedBarcodes[i].quantity;
                 }
                 if (possibleSum <= bestSum) {
                     return;
                 }

                 // 選擇當前條碼
                 const currentBarcode = sortedBarcodes[index];
                 currentCombination.push(currentBarcode);
                 search(
                     index + 1,
                     currentSum + currentBarcode.quantity,
                     currentCombination
                 );
                 currentCombination.pop();

                 // 不選擇當前條碼
                 search(
                     index + 1,
                     currentSum,
                     currentCombination
                 );
             }

             // 開始搜尋
             search();

             // 格式化並返回結果
             if (!bestSolution) {
                 return {
                     maxQuantity: maxSum,
                     bestAchievedQuantity: 0,
                     solution: null
                 };
             }

             return {
                 maxQuantity: maxSum,
                 bestAchievedQuantity: bestSum,
                 solution:
                     bestSolution
             };
         }

        function GetPickitem@(itemName)() {
            let targetUrl = "@Url.Action("GetPickitem", "PickingSystem")";
            let postData = {
                "MtlItemId": mtlId@(itemName)
            
            };
           
            let data = DataAccess.Get(targetUrl, postData, false);
            if (data.status == "success") {
                if (data.result.length > 0) {
                    $.each(data.result, function (i, item) {
                        $("#barcodeTblData@(itemName) input[type='checkbox'][data-barcode-id]").each(function () {
                            var checkbox = $(this);
                            var row = checkbox.closest("tr");;
                            var rowbarcodeId = checkbox.data("barcode-id");

                            if (rowbarcodeId === item.BarcodeId) {
                                // 相同條碼的行
                                row.addClass("disabled").removeClass("available");
                                checkbox.prop("disabled", true);
                                checkbox.prop("checked", false);
                            } else {
                                // 不同條碼的行
                                //row.removeClass("disabled").addClass("available");
                                //checkbox.prop("disabled", false);
                                
                            }
                        });
                    
                    });
                    // 處理條碼表格
                    
                } else {
                    
                }

            } else {
                alert(data.msg, "alert", 0);
            }

        }

        function pickType@(itemName)(type) {
            var typetxt = "";
            switch (type) {
                case "1":
                    typetxt = '正常品'
                    break;
                case "2":
                    typetxt = '贈品'

                    break;
                case "3":
                    typetxt = '備品'
                    break;
                default:
                    break;
            }
            return typetxt;
        }

        function Return@(itemName)() {
            //ResetForm(objForm@(itemName));@(itemName)
            $("#txtPackageBarcode@(itemName)").val("")
            $("#txtBoxNo@(itemName)").val("")
            $("#deliverNo@(itemName)").html("")
            $("#boxId@(itemName)").val(-1)


            $("#deliverId@(itemName)").val(-1)
            $("#cbxSelectAll@(itemName)").prop("checked", false)
            $("#modalPackagingBarcode@(itemName)").modal("hide")
            maxOrderQuantity@(itemName) = 0;
            picktype@(itemName) = "";
            pickdetailId@(itemName) = "";
            pickingCartonId@(itemName) = -999
            pickdodetailId@(itemName) = -999;
            InitDataDeliveryDetail();
            //Query@(itemName)();
        }
    </script>
                                                )