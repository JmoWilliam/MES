@using Business_Manager.Helpers
@{
    string itemName = "CartonItem";
    string itemNameText = "物流箱物件";

    string DoId = Request["DoId"] ?? "";
    string PickingCartonId = Request["PickingCartonId"] ?? "";

    ViewBag.Title = itemNameText;
}

@Html.Resource("css",
    @<style>
        .choose {
            padding: 5px;
            font-weight: bold;
            margin: .35rem 0;
            color: #20A4F3;
            border: 0;
            background: none;
        }

            .choose:focus {
                outline: none;
            }

        .form-input {
            background-color: #fff;
            border: 1px solid #ccc;
        }

        .swal2-styled.swal2-confirm {
            background-color: #0041c4;
        }
    </style>
)

<input type="hidden" id="DoId@(itemName)" value="" />
<input type="hidden" id="PickingCartonId@(itemName)" value="" />

<header class="header-title">
    <div class="link-area left-link">
        <a href="javascript:history.back();">
            <i class="fas fa-chevron-left"></i>
        </a>
        <a class="back-route route-delivery" href="@Url.Action("DeliveryList", "PickingSystem")">
            <i class="fas fa-list-alt"></i>
        </a>
        <a class="back-route route-carton" href="@Url.Action("CartonList", "PickingSystem")">
            <i class="fas fa-list-alt"></i>
        </a>
    </div>
    <div class="title">@(itemNameText)</div>
    <div class="link-area">
        <a href="@Url.Action("Index", "PickingSystem")">
            <i class="fas fa-home-lg-alt"></i>
        </a>
    </div>
</header>

<div class="wrapper wrap-listpick">
    <div class="section secction-picktask">
        <div class="heading-pickup">
            <div class="list-title">
                <div class="number" id="CartonDetail@(itemName)"></div>
            </div>
        </div>
        <p class="choose-block clearfix">
            <button type="button" class="choose select-all" style="float: left;">全選</button>
            <button type="button" class="choose un-select-all" style="display: none; float: left;">取消全選</button>
            <a class="choose" href="javascript:void(0);" onclick="CancelChoose@(itemName)()" style="float: right;">取消選取</a>
        </p>
        <div class="content-picktask">
            <ul class="list-area" id="PickingItem@(itemName)"></ul>
        </div>
        <div class="btn-fixed">
            <div class="btn-block">
                <a class="btn btn-warn" href="javascript:void(0);" onclick="Datas@(itemName).DeletePickingItem@(itemName)()"><i class="fas fa-trash-alt"></i>&nbsp;刪除</a>
                <a class="btn btn-sub" href="javascript:void(0);" onclick="PopCarton@(itemName)()"><i class="fas fa-inbox-out"></i>&nbsp;換箱</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCarton@(itemName)">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">換箱作業</h5>
                <button class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true"><i class="fas fa-times"></i></span>
                </button>
            </div>
            <div class="modal-body">
                <form autocomplete="off" id="editForm@(itemName)">
                    <fieldset>
                        <label class="form-label input-barcode">
                            物流箱條碼 <span class="text-danger">*</span>
                            <input type="text" class="form-input" id="txtCartonBarcode@(itemName)" name="txtCartonBarcode@(itemName)" placeholder="請輸入物流箱條碼"
                                   autocomplete="off" data-msg-required="請輸入物流箱條碼" data-rule-required="true" />
                        </label>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <a class="btn btn-main btn-large" href="javascript:void(0);" onclick="ChangeCarton@(itemName)()"><i class="fas fa-check"></i>&nbsp;確定</a>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let Datas@(itemName) = new DataControl@(itemName)();
        let objForm@(itemName) = "#editForm@(itemName)";

        $(document).ready(function () {
            $("#DoId@(itemName)").val("@(DoId)");
            $("#PickingCartonId@(itemName)").val("@(PickingCartonId)");

            InitData@(itemName)();

            $(".select-all").click(function () {
                $("input[type='checkbox'][name='cbxAllPickingItem@(itemName)']").not(":disabled").prop("checked", true);
                $("input[type='checkbox'][name='cbxPickingItem@(itemName)']").not(":disabled").prop("checked", true);
                $(".select-all").hide();
                $(".un-select-all").show();
            });

            $(".un-select-all").click(function () {
                $("input[type='checkbox'][name='cbxAllPickingItem@(itemName)']").not(":disabled").prop("checked", false);
                $("input[type='checkbox'][name='cbxPickingItem@(itemName)']").not(":disabled").prop("checked", false);
                $(".select-all").show();
                $(".un-select-all").hide();
            });
        });

        function InitData@(itemName)() {
            Datas@(itemName).GetCartonDetail@(itemName)();
            Datas@(itemName).GetPickingItem@(itemName)();
        }

        function DataControl@(itemName)() {
            addMethod(this, "GetCartonDetail@(itemName)", function () {
                let innerHtml = '';

                let targetUrl = "@Url.Action("GetCartonDetail", "PickingSystem")";
                let postData = {
                    "DoId": $("#DoId@(itemName)").val(),
                    "PickingCartonId": $("#PickingCartonId@(itemName)").val()
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    if (data.result.length > 0) {
                        $.each(data.result, function (i, item) {
                            innerHtml += `<span style="display: block;">
                                            <span class="number-cell">${item.CartonName}</span>
                                            <span class="number-barcode">(${item.CartonBarcode})</span>
                                          </span>
                                          ${item.DoId == -1 ? `<span><span class="number-warning">【注意】此物流箱未綁定出貨單</span></span>` : ``}`;

                            $("#DoId@(itemName)").val(item.DoId != -1 ? item.DoId : "");
                        });
                    } else {
                        innerHtml += `<span style="display: block;">
                                        <span class="number-cell">無物流箱</span>
                                        <span class="number-barcode"></span>
                                      </span>`;
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                if ($("#DoId@(itemName)").val() > 0) {
                    $(".route-delivery").show();
                } else {
                    $(".route-carton").show();
                }
                
                $("#CartonDetail@(itemName)").html(innerHtml);
            });

            addMethod(this, "GetPickingItem@(itemName)", function () {
                let innerHtml = '';

                let targetUrl = "@Url.Action("GetPickingItem", "PickingSystem")";
                let postData = {
                    "DoId": $("#DoId@(itemName)").val(),
                    "PickingCartonId": $("#PickingCartonId@(itemName)").val()
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    if (data.result.length > 0) {
                        $.each(data.result, function (i, item) {
                            innerHtml += `<li class="list-box">
                                            <div class="list-title">
                                              <div class="item-detail-box">
                                                <input type="checkbox" class="cb-element" id="cbxAllPickingItem@(itemName)${item.SoDetailId}" name="cbxAllPickingItem@(itemName)" data-so-detail="${item.SoDetailId}" value="${item.SoDetailId}" />
                                                <span class="res-control-indicator"></span>
                                                <label class="res-control res-control-checkbox distance" for="cbxAllPickingItem@(itemName)${item.SoDetailId}">
                                                  <span class="number">
                                                    <span class="number-name">品名</span>
                                                    <span class="number-cell">${item.MtlItemName}</span>
                                                  </span>
                                                </label>
                                              </div>
                                              <div class="icon-collapse" onclick="Toggle@(itemName)(${i})">
                                                <i class="fas fa-caret-circle-up active"></i>
                                              </div>
                                                </div>
                                                <div class="list-content" style="display: block;">
                                                  <ul class="list-item number-object">
                                                    <li>
                                                        <span class="heading">已揀貨數量【正常品】</span>
                                                        <span class="detail detail-warning">${item.PickRegularQty}</span>
                                                    </li>
                                                    <li>
                                                        <span class="heading">已揀貨數量【贈品】</span>
                                                        <span class="detail detail-warning">${item.PickFreebieQty}</span>
                                                    </li>
                                                    <li>
                                                        <span class="heading">已揀貨數量【備品】</span>
                                                        <span class="detail detail-warning">${item.PickSpareQty}</span>
                                                    </li>
                                                  </ul>
                                              <div class="list-item">
                                                ${DetailData@(itemName)(item.ItemDetail)}
                                              </div>
                                            </div>
                                          </li>`;
                        });
                    } else {
                        swal.fire({
                            titleText: "物流箱已無物件!",
                            icon: "warning",
                            allowOutsideClick: false,
                            allowEscapeKey: false,
                            showCancelButton: false,
                            confirmButtonColor: '#0041c4',
                            cancelButtonColor: '#bdbdbd',
                            reverseButtons: true
                        }).then((result) => {
                            if (result.isConfirmed) {
                                if ($("#DoId@(itemName)").val()) {
                                    location.href = `@Url.Action("DeliveryDetail", "PickingSystem")?DoId=${$("#DoId@(itemName)").val()}`;
                                } else {
                                    location.href = `@Url.Action("CartonList", "PickingSystem")`;
                                }
                            }
                        });
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                $("#PickingItem@(itemName)").html(innerHtml);

                function DetailData@(itemName)(source) {
                    let html = '';

                    if (source) {
                        html += `<span class="item-title">物件條碼/刻字碼</span>`;

                        let json = JSON.parse(source);

                        for (var i = 0; i < json.data.length; i++) {
                            switch (json.data[i].ItemStatus) {
                                case "B":
                                    html += `<div class="item-detail-box" style="display: unset;">
                                               <input type="checkbox" class="cb-element" id="cbxPickingItem@(itemName)${json.data[i].PickingItemId}" name="cbxPickingItem@(itemName)" data-so-detail="${json.data[i].SoDetailId}" value="${json.data[i].PickingItemId}" />
                                               <span class="res-control-indicator"></span>
                                               <label class="res-control res-control-checkbox distance" style="display: flex;" for="cbxPickingItem@(itemName)${json.data[i].PickingItemId}">
                                                 <span class="item-detail02">
                                                   <span class="date_num">${json.data[i].ItemBarcode}(${ItemTypeName(json.data[i].ItemType)})</span>
                                                   <span>${json.data[i].LetteringNo}</span>
                                                 </span>
                                                 <div class="item-block-object"> 
                                                   <div class="num">${json.data[i].ItemQty}</div>
                                                   PCS
                                                 </div>
                                               </label>
                                             </div>`;
                                    break;
                                case "N":
                                    html += `<div class="item-detail-box" style="display: unset;" onclick="OpenLotList(${json.data[i].PickingItemId})">
                                               <input type="checkbox" class="cb-element" id="cbxPickingItem@(itemName)${json.data[i].PickingItemId}" name="cbxPickingItem@(itemName)" data-so-detail="${json.data[i].SoDetailId}" value="${json.data[i].PickingItemId}" />
                                               <span class="res-control-indicator"></span>
                                               <label class="res-control res-control-checkbox distance" style="display: flex;" for="cbxPickingItem@(itemName)${json.data[i].PickingItemId}">
                                                 <span class="item-detail02">
                                                   <span>此物件為無條碼(${ItemTypeName(json.data[i].ItemType)})</span>
                                                   <span id="PickingLotTitle@(itemName)${json.data[i].PickingItemId}" style="color:red;">點擊展開批號列表</span>
                                                 </span>
                                                 <div class="item-block-object"> 
                                                   <div class="num">${json.data[i].ItemQty}</div>
                                                   PCS
                                                 </div>
                                               </label>
                                               <input type="hidden" id="LotListStatus@(itemName)${json.data[i].PickingItemId}" value="S" />
                                             </div>
                                             <div id="PickingLot@(itemName)${json.data[i].PickingItemId}" class="PickingLot"></div>`;
                                    break;
                                case "S":
                                    html += `<div class="item-detail-box" style="display: unset;">
                                               <input type="checkbox" class="cb-element" id="cbxPickingItem@(itemName)${json.data[i].PickingItemId}" name="cbxPickingItem@(itemName)" data-so-detail="${json.data[i].SoDetailId}" value="${json.data[i].PickingItemId}" />
                                               <span class="res-control-indicator"></span>
                                               <label class="res-control res-control-checkbox distance" style="display: flex;"  for="cbxPickingItem@(itemName)${json.data[i].PickingItemId}">
                                                 <span class="item-detail02">
                                                   <span>此物件為替代品(${ItemTypeName(json.data[i].ItemType)})</span>
                                                 </span>
                                                 <div class="item-block-object"> 
                                                   <div class="num">${json.data[i].ItemQty}</div>
                                                   PCS
                                                 </div>
                                               </label>
                                             </div>`;
                                    break;
                            }
                        }
                    }
                    return html;
                }

                function ItemTypeName(itemType) {
                    switch (itemType) {
                        case "1":
                            return "正常品";
                            break;
                        case "2":
                            return "贈品";
                            break;
                        case "3":
                            return "備品";
                            break;
                    }
                }

                @*$("input[type='checkbox'][name='cbxAllPickingItem@(itemName)']").click(function () {
                    let soDetailId = $(this).val();

                    if ($(`input[type='checkbox'][name='cbxAllPickingItem@(itemName)'][data-so-detail='${soDetailId}']`).is(":checked")) {
                        $(`input[type='checkbox'][name='cbxPickingItem@(itemName)'][data-so-detail='${soDetailId}']`).prop("checked", true);
                    } else {
                        $(`input[type='checkbox'][name='cbxPickingItem@(itemName)'][data-so-detail='${soDetailId}']`).prop("checked", false);
                    }
                });*@
            });

            addMethod(this, "DeletePickingItem@(itemName)", function () {
                let itemList = [];
                $.each($("input[name='cbxPickingItem@(itemName)']:checked"), function () {
                    itemList.push($(this).val());
                });

                if (itemList.length > 0) {
                    swal.fire({
                        titleText: "確認要刪除嗎?",
                        text: "此動作無法復原，請確認是否要執行!",
                        icon: "warning",
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showCancelButton: true,
                        confirmButtonColor: '#0041c4',
                        cancelButtonColor: '#bdbdbd',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            let targetUrl = "@Url.Action("DeletePickingItem", "PickingSystem")";
                            let postData = {
                                "PickingItemIds": itemList.join(",")
                            };

                            let result = DataAccess.Delete(targetUrl, postData, false, false);

                            if (result) {
                                InitData@(itemName)();
                            }
                        }
                    });
                } else {
                    alert("請選取物件!");
                }
            });

            addMethod(this, "DeletePickingLot@(itemName)", function (PickingLotId) {

                if (PickingLotId > 0) {
                    swal.fire({
                        titleText: "確認要刪除嗎?",
                        text: "此動作無法復原，請確認是否要執行!",
                        icon: "warning",
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showCancelButton: true,
                        confirmButtonColor: '#0041c4',
                        cancelButtonColor: '#bdbdbd',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            let targetUrl = "@Url.Action("DeletePickingLot", "PickingSystem")";
                            let postData = {
                                "PickingLotId": PickingLotId
                            };

                            let result = DataAccess.Delete(targetUrl, postData, false, false);

                            if (result) {
                                InitData@(itemName)();
                            }
                        }
                    });
                } else {
                    alert("請選取物件!");
                }
            });
        }

        function PopCarton@(itemName)() {
            let itemList = [];
            $.each($("input[name='cbxPickingItem@(itemName)']:checked"), function () {
                itemList.push($(this).val());
            });

            if (itemList.length > 0) {
                $("#modalCarton@(itemName)").modal({
                    backdrop: "static",
                    keyboard: false,
                    show: true
                });
            } else {
                alert("請選取物件!");
            }
        }

        function ChangeCarton@(itemName)() {
            let itemList = [];
            $.each($("input[name='cbxPickingItem@(itemName)']:checked"), function () {
                itemList.push($(this).val());
            });

            $.cookie('pickingItem', itemList.join(","), { path: '/', expires: 1 });
            $.cookie('pickingCarton', $("#txtCartonBarcode@(itemName)").val(), { path: '/', expires: 1 });

            if ($(objForm@(itemName)).valid()) {
                DelayFn(function () {
                    if ($("#DoId@(itemName)").val()) {
                        location.href = `@Url.Action("ChangeCarton", "PickingSystem")?DoId=${$("#DoId@(itemName)").val()}&PickingCartonId=${$("#PickingCartonId@(itemName)").val()}`;
                    } else {
                        location.href = `@Url.Action("ChangeCarton", "PickingSystem")?PickingCartonId=${$("#PickingCartonId@(itemName)").val()}`;
                    }
                }, 500);
            }
        }

        function Toggle@(itemName)(id) {
            $(".list-box").find($(".list-content")[id]).slideToggle(200);
            $(".list-box").find($(".icon-collapse .fa-caret-circle-up")[id]).toggleClass("active");
        }

        function CancelChoose@(itemName)() {
            if ($("#DoId@(itemName)").val()) {
                location.href = `@Url.Action("PickingItem", "PickingSystem")?DoId=${$("#DoId@(itemName)").val()}&PickingCartonId=${$("#PickingCartonId@(itemName)").val()}`;
            } else {
                location.href = `@Url.Action("PickingItem", "PickingSystem")?PickingCartonId=${$("#PickingCartonId@(itemName)").val()}`;
            }
        }

        function OpenLotList(PickingItemId) {

            if ($(`#cbxPickingItem@(itemName)${PickingItemId}`).is(":checked")) {
                $(`#cbxPickingItem@(itemName)${PickingItemId}`).prop("checked", true);
            } else {
                $(`##cbxPickingItem@(itemName)${PickingItemId}`).prop("checked", false);
            }

            let LotListStatus = $(`#LotListStatus@(itemName)${PickingItemId}`).val()
            if (LotListStatus == "A") {
                $(`#LotListStatus@(itemName)${PickingItemId}`).val("S")
                $(`#PickingLotTitle@(itemName)${PickingItemId}`).text("展開批號列表")
                $(`#PickingLot@(itemName)${PickingItemId}`).html("")

            }
            else {
                $(`#LotListStatus@(itemName)${PickingItemId}`).val("A")
                $(`#PickingLotTitle@(itemName)${PickingItemId}`).text("關閉批號列表")

                let innerHtml = '';

                let targetUrl = "@Url.Action("GetPickingLot", "PickingSystem")";
                let postData = {
                    "PickingItemId": PickingItemId
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    if (data.result.length > 0) {
                        $.each(data.result, function (i, item) {
                            innerHtml += `<div class="item-detail-box" style="background-color: #ff75bd1c;">
                                            <div class="item-block-object icon" style="margin-right: 13px;">
                                            </div>
                                            <span class="item-detail02">
                                                <span>批號:${item.LotNumber}</span>
                                            </span>
                                            <div class="item-block-object">
                                                <div class="num">${item.ItemQty}</div>
                                                PCS
                                            </div>
                                            @*<span class="delete-icon">
                                                <a href="javascript:void(0);" onclick="Datas@(itemName).DeletePickingLot@(itemName)(${item.PickingLotId})"><i class="fas fa-minus-circle"></i></a>
                                            </span>*@
                                            </div>`;
                        });
                    } else {
                        innerHtml += `<a class="modal-quote" href="javascript:void(0);" style="background-color: #fff3cd;">
                                        <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                      </a>`;
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                $(`#PickingLot@(itemName)${PickingItemId}`).html(innerHtml)
            }
        }
    </script>
)