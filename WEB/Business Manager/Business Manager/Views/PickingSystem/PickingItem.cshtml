@using Business_Manager.Helpers
@{
    string itemName = "PickingItem";
    string itemNameText = "物件資料";

    string DoId = Request["DoId"] ?? "";
    string PickingCartonId = Request["PickingCartonId"] ?? "";

    ViewBag.Title = itemNameText;
}

@Html.Resource("css",
    @<style>
        .choose {
            float: right;
            padding: 5px;
            font-weight: bold;
            margin: .35rem 0;
        }
    </style>
)

<input type="hidden" id="DoId@(itemName)" value="" />
<input type="hidden" id="PickingCartonId@(itemName)" value="" />

<header class="header-title">
    <div class="link-area left-link">
        <a href="javascript:history.back();">
            <i class="fas fa-chevron-left"></i>
        </a>
        <a class="back-route route-delivery" href="@Url.Action("DeliveryList", "PickingSystem")">
            <i class="fas fa-list-alt"></i>
        </a>
        <a class="back-route route-carton" href="@Url.Action("CartonList", "PickingSystem")">
            <i class="fas fa-list-alt"></i>
        </a>
    </div>
    <div class="title">@(itemNameText)</div>
    <div class="link-area">
        <a href="@Url.Action("Index", "PickingSystem")">
            <i class="fas fa-home-lg-alt"></i>
        </a>
    </div>
</header>

<div class="wrapper wrap-boxtask">
    <div class="section secction-picktask">
        <div class="heading-pickup">
            <div class="list-title">
                <div class="number" id="CartonDetail@(itemName)"></div>
            </div>
        </div>
        <p class="choose-block clearfix">
            <a class="choose picking-item" href="javascript:void(0);" onclick="ChooseItem@(itemName)()">選取物件</a>
        </p>
        <div class="content-picktask">
            <ul class="list-area" id="PickingItem@(itemName)"></ul>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let Datas@(itemName) = new DataControl@(itemName)();

        $(document).ready(function () {
            $("#DoId@(itemName)").val("@(DoId)");
            $("#PickingCartonId@(itemName)").val("@(PickingCartonId)");

            InitData@(itemName)();
        });

        function InitData@(itemName)() {
            $(".picking-item").show();
            Datas@(itemName).GetCartonDetail@(itemName)();
            Datas@(itemName).GetPickingItem@(itemName)();
        }

        function DataControl@(itemName)() {
            addMethod(this, "GetCartonDetail@(itemName)", function () {
                let innerHtml = '';

                let targetUrl = "@Url.Action("GetCartonDetail", "PickingSystem")";
                let postData = {
                    "DoId": $("#DoId@(itemName)").val(),
                    "PickingCartonId": $("#PickingCartonId@(itemName)").val()
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    if (data.result.length > 0) {
                        $.each(data.result, function (i, item) {
                            innerHtml += `<span style="display: block;">
                                            <span class="number-cell">${item.CartonName}</span>
                                            <span class="number-barcode">(${item.CartonBarcode})</span>
                                          </span>
                                          ${item.DoId == -1 ? `<span><span class="number-warning">【注意】此物流箱未綁定出貨單</span></span>` : ``}`;

                            $("#DoId@(itemName)").val(item.DoId != -1 ? item.DoId : "");

                            switch (item.Status) {
                                case "R":
                                case "S":
                                    $(".picking-item").hide();
                                    break;
                            }
                        });
                    } else {
                        innerHtml += `<span style="display: block;">
                                        <span class="number-cell">無物流箱</span>
                                        <span class="number-barcode"></span>
                                      </span>`;
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                if ($("#DoId@(itemName)").val() > 0) {
                    $(".route-delivery").show();
                } else {
                    $(".route-carton").show();
                }
                
                $("#CartonDetail@(itemName)").html(innerHtml);
            });

            addMethod(this, "GetPickingItem@(itemName)", function () {
                let innerHtml = '';

                let targetUrl = "@Url.Action("GetPickingItem", "PickingSystem")";
                let postData = {
                    "DoId": $("#DoId@(itemName)").val(),
                    "PickingCartonId": $("#PickingCartonId@(itemName)").val()
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    $.each(data.result, function (i, item) {
                        innerHtml += `<li class="list-box">
                                        <div class="list-title">
                                          <span class="number">
                                            <span class="number-name">品名</span>
                                            <span class="number-cell">${item.MtlItemName}</span>
                                          </span>
                                          <div class="icon-collapse" onclick="Toggle@(itemName)(${i})">
                                            <i class="fas fa-caret-circle-up active"></i>
                                          </div>
                                        </div>
                                        <div class="list-content" style="display: block;">
                                          <ul class="list-item number-object">
                                            <li>
                                              <span class="heading">已揀貨數量【正常品】</span>
                                              <span class="detail detail-warning">${item.PickRegularQty}</span>
                                            </li>
                                            <li>
                                              <span class="heading">已揀貨數量【贈品】</span>
                                              <span class="detail detail-warning">${item.PickFreebieQty}</span>
                                            </li>
                                            <li>
                                              <span class="heading">已揀貨數量【備品】</span>
                                              <span class="detail detail-warning">${item.PickSpareQty}</span>
                                            </li>
                                          </ul>
                                          <div class="list-item">
                                            ${DetailData@(itemName)(item.ItemDetail)}
                                          </div>
                                        </div>
                                      </li>`;
                    });
                } else {
                    alert(data.msg, "alert", 0);
                }

                $("#PickingItem@(itemName)").html(innerHtml);

                function DetailData@(itemName)(source) {
                    let html = '';

                    if (source) {
                        html += `<span class="item-title">物件條碼/刻字碼</span>`;

                        let json = JSON.parse(source);

                        for (var i = 0; i < json.data.length; i++) {
                            switch (json.data[i].ItemStatus) {
                                case 'B':
                                    html += `<div class="item-detail-box">
                                               <div class="item-block-object icon"> 
                                                 <i class="far fa-box-alt"></i>
                                               </div>
                                               <span class="item-detail02">
                                                 <span class="date_num">${json.data[i].ItemBarcode}(${ItemTypeName(json.data[i].ItemType)})</span>
                                                 <span>${json.data[i].LetteringNo}</span>
                                                 ${json.data[i].LotNumber.length > 0 ? `<span>批號: ${json.data[i].LotNumber}</span>` : ``}
                                               </span>
                                               <div class="item-block-object"> 
                                                 <div class="num">${json.data[i].ItemQty}</div>
                                                 PCS
                                               </div>
                                             </div>`;
                                    break;
                                case 'N':
                                    html += `<div class="item-detail-box" onclick="OpenLotList(${json.data[i].PickingItemId})" >
                                               <div class="item-block-object icon">
                                                 <i class="far fa-box-alt"></i>
                                               </div>
                                               <span class="item-detail02">
                                                 <span>無條碼物件(${ItemTypeName(json.data[i].ItemType)})</span>
                                                 <span id="PickingLotTitle@(itemName)${json.data[i].PickingItemId}" style="color:red;">點擊展開批號列表</span>
                                               </span>
                                               <div class="item-block-object">
                                                 <div class="num">${json.data[i].ItemQty}</div>
                                                 PCS
                                               </div>
                                               <input type="hidden" id="LotListStatus@(itemName)${json.data[i].PickingItemId}" value="S" />
                                             </div>
                                             <div id="PickingLot@(itemName)${json.data[i].PickingItemId}" ></div>`;
                                    break;
                                case 'S':
                                    html += `<div class="item-detail-box">
                                               <div class="item-block-object icon">
                                                 <i class="far fa-box-alt"></i>
                                               </div>
                                               <span class="item-detail02">
                                                 <span>替代品物件(${ItemTypeName(json.data[i].ItemType)})</span>
                                               </span>
                                               <div class="item-block-object">
                                                 <div class="num">${json.data[i].ItemQty}</div>
                                                 PCS
                                               </div>
                                             </div>`;
                                    break;
                            }
                        }
                    }
                    return html;
                }

                function ItemTypeName(itemType) {
                    switch (itemType) {
                        case "1":
                            return "正常品";
                            break;
                        case "2":
                            return "贈品";
                            break;
                        case "3":
                            return "備品";
                            break;
                    }
                }
            });

            addMethod(this, "DeletePickingLot@(itemName)", function (PickingLotId) {

                if (PickingLotId > 0) {
                    swal.fire({
                        titleText: "確認要刪除嗎?",
                        text: "此動作無法復原，請確認是否要執行!",
                        icon: "warning",
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showCancelButton: true,
                        confirmButtonColor: '#0041c4',
                        cancelButtonColor: '#bdbdbd',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            let targetUrl = "@Url.Action("DeletePickingLot", "PickingSystem")";
                            let postData = {
                                "PickingLotId": PickingLotId
                            };

                            let result = DataAccess.Delete(targetUrl, postData, false, false);

                            if (result) {
                                InitData@(itemName)();
                            }
                        }
                    });
                } else {
                    alert("請選取物件!");
                }
            });
        }

        function Toggle@(itemName)(id) {
            $(".list-box").find($(".list-content")[id]).slideToggle(200);
            $(".list-box").find($(".icon-collapse .fa-caret-circle-up")[id]).toggleClass("active");
        }

        function ChooseItem@(itemName)() {
            if ($("#DoId@(itemName)").val()) {
                location.href = `@Url.Action("CartonItem", "PickingSystem")?DoId=${$("#DoId@(itemName)").val()}&PickingCartonId=${$("#PickingCartonId@(itemName)").val()}`;
            } else {
                location.href = `@Url.Action("CartonItem", "PickingSystem")?PickingCartonId=${$("#PickingCartonId@(itemName)").val()}`;
            }
        }

        function OpenLotList(PickingItemId) {
            let LotListStatus = $(`#LotListStatus@(itemName)${PickingItemId}`).val()
            if (LotListStatus == "A") {
                $(`#LotListStatus@(itemName)${PickingItemId}`).val("S")
                $(`#PickingLotTitle@(itemName)${PickingItemId}`).text("展開批號列表")
                $(`#PickingLot@(itemName)${PickingItemId}`).html("")

            }
            else {
                $(`#LotListStatus@(itemName)${PickingItemId}`).val("A")
                $(`#PickingLotTitle@(itemName)${PickingItemId}`).text("關閉批號列表")

                let innerHtml = '';

                let targetUrl = "@Url.Action("GetPickingLot", "PickingSystem")";
                let postData = {
                    "PickingItemId": PickingItemId
                };

                let data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    if (data.result.length > 0) {
                        $.each(data.result, function (i, item) {
                            innerHtml += `<div class="item-detail-box" style="background-color: #ff75bd1c;">
                                            <div class="item-block-object icon" style="margin-right: 13px;">
                                            </div>
                                            <span class="item-detail02">
                                                <span>批號:${item.LotNumber}</span>
                                            </span>
                                            <div class="item-block-object">
                                                <div class="num">${item.ItemQty}</div>
                                                PCS
                                            </div>
                                            @*<span class="delete-icon">
                                                <a href="javascript:void(0);" onclick="Datas@(itemName).DeletePickingLot@(itemName)(${item.PickingLotId})"><i class="fas fa-minus-circle"></i></a>
                                            </span>*@
                                            </div>`;
                        });
                    } else {
                        innerHtml += `<a class="modal-quote" href="javascript:void(0);" style="background-color: #fff3cd;">
                                        <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                      </a>`;
                    }
                } else {
                    alert(data.msg, "alert", 0);
                }

                $(`#PickingLot@(itemName)${PickingItemId}`).html(innerHtml)
            }
        }
    </script>
)
