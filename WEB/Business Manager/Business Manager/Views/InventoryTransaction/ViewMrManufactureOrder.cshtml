@using Business_Manager.Helpers
@{
    string itemName = "ViewMrManufactureOrder";
    string itemNameText = "單據綁定製令資料管理";
}

@Html.Resource("css",
    @<style>
         .help-block {
             display: none;
             margin: 5px 0 0;
             border: 3px dashed #b1b1b1;
             border-radius: 5px;
             padding: 5px 10px;
         }

         dt {
             float: left;
             clear: left;
             width: 110px;
         }

             dt::after {
                 content: "：";
             }

         dd {
             margin: 0 0 0 80px;
             padding: 0;
             color: #36a2f5;
             font-weight: bold;
         }

         .table-sticky thead .col-sticky:nth-last-child(1) {
             right: 0;
         }

         .table-sticky tbody .col-sticky:nth-last-child(1) {
             right: 0;
         }

        .sub-title {
            color: #6f6b6b !important;
        }

        .search-moid {
            display: flex;
        }

        .row label {
            font-size: 14px;
            font-weight: 600;
            margin-right: 8px;
            width: 100%;
        }

        .modal-dialog {
            max-width: 750px !important;
        }
    </style>
                        )

<div class="modal fade" id="modal@(itemName)">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    @(itemNameText)
                    <span class="sub-title">領退料單號: <span class="sub-text" id="desMrErpFullNo@(itemName)"></span></span>
                </h5>
                <a class="close list-mode" href="javascript:void(0);" onclick="Close@(itemName)()"><i class="fas fa-times"></i></a>
            </div>
            <div class="modal-body">
                <div class="control-bar">
                    <a class="control-btn list-mode" href="javascript: Edit@(itemName)();"><i class="fas fa-plus"></i> 新增</a>
                </div>
                <div class="detail-table" id="listData@(itemName)">
                    <table id="tblData@(itemName)" class="table table-bordered table-striped table-sticky">
                        <thead>
                            <tr>
                                <th style="min-width: 110px; text-align: center;">操作</th>
                                <th style="min-width: 65px;">序號</th>
                                <th style="min-width: 65px;">製令</th>
                                <th style="min-width: 110px;">領料方式</th>
                                <th style="min-width: 110px;">領退套數</th>
                                <th style="min-width: 65px;">備註</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="row" id="editData@(itemName)" style="display: none;">
                    <div class="col-12">
                        <form class="container" autocomplete="off" id="editForm@(itemName)">
                            <input type="hidden" id="txtMrId@(itemName)" value="" />
                            <input type="hidden" id="MoId@(itemName)" value="" />
                            <fieldset>
                                <div class="form-group row">
                                    <label class="col-12 col-form-label" for="txtMoId@(itemName)">綁定MES製令<span class="text-danger">*</span></label>
                                    <div class="col-12">
                                        <div class="search-moid">
                                            <input type="hidden" id="txtMoId@(itemName)" value="" />
                                            <input type="text" class="form-control" id="txtWoErpFullNo@(itemName)" name="txtWoErpFullNo@(itemName)"
                                                   placeholder="請輸入製令">
                                            <div class="input-group-append">
                                                <div class="btn-group">
                                                    <a class="btn btn-success pop-view" href="javascript:QueryManufactureOrder@(itemName)();"><i class="fal fa-search"></i></a>
                                                    <a class="btn btn-danger pop-view" href="javascript:ClearManufactureOrder@(itemName)();"><i class="fas fa-eraser"></i></a>
                                                </div>
                                            </div>
                                        </div>
                                        <dl class="help-block">
                                            <dt>預計產量</dt>
                                            <dd id="desMesQuantity@(itemName)"></dd>
                                            <dt>品號</dt>
                                            <dd id="desMtlItemNo@(itemName)"></dd>
                                            <dt>品名</dt>
                                            <dd id="desMtlItemName@(itemName)"></dd>
                                            <dt>規格</dt>
                                            <dd id="desMtlItemSpec@(itemName)"></dd>
                                        </dl>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="txtMrType@(itemName)">領料方式<span class="text-danger">*</span></label>
                                            <div class="col-12">
                                                <select class="form-control" id="cboMrType@(itemName)" name="cboMrType@(itemName)" required></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-12 col-md-12">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="txtQuantity@(itemName)">領退料套數</label>
                                            <div class="col-12">
                                                <input type="number" step="any" class="form-control" id="txtQuantity@(itemName)" name="txtQuantity@(itemName)"
                                                       value=""
                                                       placeholder="請輸入領退料數"
                                                       data-msg-required="請輸入領退料數" data-rule-required="true" />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="display: none;">
                                    <div class="col-lg-6 col-md-12">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="txtMaterialCategory@(itemName)">材料型態</label>
                                            <div class="col-12">
                                                <select class="form-control" id="cboMaterialCategory@(itemName)" name="cboMaterialCategory@(itemName)" required></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="txtSubinventoryType@(itemName)">庫別型態<span class="text-danger">*</span></label>
                                            <div class="col-12">
                                                <select class="form-control" id="cboSubinventoryType@(itemName)" name="cboSubinventoryType@(itemName)" required disabled></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="display: none;">
                                    <div class="col-lg-6 col-md-12">
                                        <div class="form-group row">
                                            <label for="txtRequisitionCode@(itemName)">領料碼</label>
                                            <div class="col-12">
                                                <select class="form-control" id="cboRequisitionCode@(itemName)" name="cboRequisitionCode@(itemName)" required></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-12 ">
                                        <div class="form-group row">
                                            <label for="txtNegativeStatus@(itemName)">庫存不足照領<span class="text-danger">*</span></label>
                                            <div class="col-12">
                                                <select class="form-control" id="cboNegativeStatus@(itemName)" name="cboNegativeStatus@(itemName)" required>
                                                    <option value="Y">是</option>
                                                    <option value="N" selected>否</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="display: none;">
                                    <div class="col-lg-12 col-md-12">
                                        <div class="form-group row">
                                            <label class="form-label col-12" for="txtLineSeq@(itemName)">輸入序號</label>
                                            <div class="col-12">
                                                <input type="text" class="form-control" id="txtLineSeq@(itemName)" name="txtLineSeq@(itemName)"
                                                       value=""
                                                       data-rule-required="true"
                                                       readonly />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-6 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="col-12 col-form-label" for="cboInventoryId@(itemName)">領料庫別</label>
                                            <div class="col-12">
                                                <select class="form-control" id="cboInventoryId@(itemName)" name="cboInventoryId@(itemName)" required></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-6 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="col-12 col-form-label" for="cboInventoryId@(itemName)">儲位</label>
                                            <div class="col-12" style="display: flex;">
                                                <input type="text" class="form-control" id="txtStorageLocation@(itemName)" name="txtStorageLocation@(itemName)"
                                                       placeholder="請輸入儲位"
                                                       readonly />
                                                <div class="input-group-append">
                                                    <div class="btn-group">
                                                        <a class="btn btn-success pop-view" href="javascript:QueryStorageLocation@(itemName)();"><i class="fal fa-search"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-12 col-md-12 ">
                                        <div class="form-group row">
                                            <label class="col-12 col-form-label" for="txtRemark@(itemName)">備註</label>
                                            <div class="col-12">
                                                <textarea class="form-control" id="txtRemark@(itemName)" name="txtRemark@(itemName)" rows="2"
                                                          placeholder="請輸入備註"
                                                          data-msg-required="請輸入備註"
                                                          data-msg-maxlength="必須少於 255 個字元" maxlength="255"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a class="clear-btn edit-mode" href="javascript: Return@(itemName)();" style="display:none;"><i class="fas fa-undo"></i> 返回</a>
                <a class="edit-mode" href="javascript: Save@(itemName)();" style="display:none;"><i class="fas fa-save"></i> 儲存</a>
            </div>
        </div>
    </div>
</div>

@Html.Resource("js",
    @<script>
        let objPage@(itemName) = {
            "pageIndex": 0,
            "pageSize": 10
        };
        let objForm@(itemName) = "#editForm@(itemName)";

        let mrId@(itemName);

        let woErpFullNo@(itemName);

        $(document).ready(function () {
            $("#txtWoErpFullNo@(itemName)").keydown(function (event) {
                if (event.keyCode === 13) {
                    QueryManufactureOrder@(itemName)();
                    event.preventDefault();
                    return false;
                }
            });
        });

        function Pop@(itemName)(mrId, mrErpFullNo, woErpFullNo) {
            mrId@(itemName) = -1;
            mrId@(itemName) = mrId;
            $("#desMrErpFullNo@(itemName)").html(mrErpFullNo);

            Query@(itemName)();

            GetExcessFlag();

            $("#modal@(itemName)").modal({
                backdrop: "static",
                keyboard: false,
                show: true
            });

            if (woErpFullNo) {
                Edit@(itemName)();
                $("#txtWoErpFullNo@(itemName)").val(woErpFullNo);
                QueryManufactureOrder@(itemName)();
            }
        }

        function Query@(itemName)() {
            objPage@(itemName).pageIndex = 0;
            InitData@(itemName)(objPage@(itemName));
        }

        function InitData@(itemName)(objPage) {
            let innerHtml = '';
            let pageCount = 0;

            let targetUrl = "@Url.Action("GetMrWipOrder", "InventoryTransaction")";
            let postData = {
                "MrId": mrId@(itemName)
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                pageCount = data.result.length;
                
                if (pageCount > 0) {
                    objPage = PageCaculate(pageCount, objPage);

                    $.each(data.result, function (i, item) {
                        innerHtml += `<tr>
                                        <td style="text-align: center;">
                                            <a class="menu-btn" href="javascript: OpenControlMenu@(itemName)(${item.MrId}, ${item.MoId});"><i class="fas fa-chevron-circle-down"></i> 選單</a>
                                            <div class="control-menu" data-mr-id="${item.MrId}" data-mo-id=${item.MoId} data-visible="false">
                                                <a href="javascript: Edit@(itemName)(${item.MrId}, ${item.MoId});"><i class="fas fa-edit"></i> 修改</a>
                                                <a href="javascript: Delete@(itemName)(${item.MrId}, ${item.MoId})"><i class="fas fa-trash-alt"></i> 刪除</a>
                                            </div>
                                        </td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.LineSeq}">${item.LineSeq}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.WoErpPrefix}-${item.WoErpNo}(${item.WoSeq})">${item.WoErpPrefix}-${item.WoErpNo}(${item.WoSeq})</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.MrTypeNo}">${item.MrTypeNo}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.Quantity}">${item.Quantity}</td>
                                        <td class="ellipsis" data-toggle="tooltip" title="${item.Remark}">${item.Remark}</td>
                                      </tr>`;
                    });
                } else {
                    innerHtml += `<tr>
                                    <td class="text-center" colspan="6" style="background-color: #f5f5f5;">
                                        <i class="fal fa-exclamation-circle"></i>&nbsp;目前尚無資料。
                                    </td>
                                  </tr>`;
                }
            } else {
                alert(data.msg, "alert", 0);
            }

            $("#tblData@(itemName) tbody").html(innerHtml);

            TableComponentInit();
            Pager("#page@(itemName)", pageCount, objPage, InitData@(itemName));
        }

        function Edit@(itemName)(mrId, moId) {
            $("#txtMrId@(itemName)").val(mrId ? mrId : 0);
            $("#MoId@(itemName)").val(moId ? moId : 0);
            Switch("#editData@(itemName), .edit-mode, .btn-group@(itemName)", "#listData@(itemName), .list-mode");

            setTimeout(function () {
                $("#txtWoErpFullNo@(itemName)").focus();
            }, 250);

            $(".help-block").css("display", "none");
            $("#txtMoId@(itemName)").val("");

            if (!isMobile) {
                $("#cboMrType@(itemName)").select2({
                    width: "100%"
                });
                $("#cboRequisitionCode@(itemName)").select2({
                    width: "100%"
                });
                $("#cboMaterialCategory@(itemName)").select2({
                    width: "100%"
                });
                $("#cboSubinventoryType@(itemName)").select2({
                    width: "100%"
                });
                 $("#cboInventoryId@(itemName)").select2({
                    width: "100%"
                });
            }

            //領退料方式
            let docType = $("#cboMrErpPrefixMaterialRequisition").val();
            docType = docType.substring(0, 2);
            if (docType == "54" || docType == "55") {
                ComboBoxs.Default("#cboMrType@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MrWipOrder.MrType" }, "1", "NA", "", "TypeName", "TypeNo");
                $("#cboMrType@(itemName) option[value='4']").remove();
                $("#cboMrType@(itemName) option[value='5']").remove();
            }
            else {
                ComboBoxs.Default("#cboMrType@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MrWipOrder.MrType" }, "4", "NA", "", "TypeName", "TypeNo");
                $("#cboMrType@(itemName) option[value='1']").remove();
                $("#cboMrType@(itemName) option[value='2']").remove();
                $("#cboMrType@(itemName) option[value='3']").remove();
            }

            //領料碼
            ComboBoxs.Default("#cboRequisitionCode@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MrWipOrder.RequisitionCode" }, "1", "NA", "", "TypeName", "TypeNo");

            //材料型態
            ComboBoxs.Default("#cboMaterialCategory@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MrWipOrder.MaterialCategory" }, "*", "NA", "", "TypeName", "TypeNo");

            //庫別型態
            ComboBoxs.Default("#cboSubinventoryType@(itemName)", "@Url.Action("GetType", "BasicInformation")", { "TypeSchema": "MrWipOrder.SubinventoryType" }, "1", "NA", "", "TypeName", "TypeNo");

            $("#cboMaterialCategory@(itemName)").prop("disabled", false);

            GetDeviceInventory@(itemName)();

            if (mrId > 0 && moId > 0) {
                let targetUrl = "@Url.Action("GetMrWipOrder", "InventoryTransaction")";
                let postData = {
                    "MrId": mrId,
                    "MoId": moId
                }
                data = DataAccess.Get(targetUrl, postData, false);

                if (data.status == "success") {
                    $(".help-block").show();
                    $.each(data.result, function (i, item) {
                        $("#txtMoId@(itemName)").val(moId);
                        $("#txtWoErpFullNo@(itemName)").val(item.WoErpPrefix + "-" + item.WoErpNo + "(" + item.WoSeq + ")");
                        $("#desMesQuantity@(itemName)").html(item.MesQuantity);
                        $("#desMtlItemNo@(itemName)").html(item.MtlItemNo);
                        $("#desMtlItemName@(itemName)").html(item.MtlItemName);
                        $("#desMtlItemSpec@(itemName)").html(item.MtlItemSpec);
                        $("#cboMrType@(itemName)").val(item.MrType);
                        $("#txtQuantity@(itemName)").val(item.Quantity);
                        $("#cboRequisitionCode@(itemName)").val(item.RequisitionCode);
                        $("#cboNegativeStatus@(itemName)").val(item.NegativeStatus);
                        $("#cboMaterialCategory@(itemName)").val(item.MaterialCategory);
                        $("#cboSubinventoryType@(itemName)").val(item.SubinventoryType);
                        $("#txtLineSeq@(itemName)").val(item.LineSeq);
                        $("#txtRemark@(itemName)").val(item.Remark);
                        $("#cboMaterialCategory@(itemName)").prop("disabled", true);
                        $("#cboInventoryId@(itemName)").val(item.InventoryId);
                        $("#txtStorageLocation@(itemName)").val(item.StorageLocation);
                    });
                } else {
                    alert(data.msg, "alert", 0);
                }
            }

            $("#txtMoId@(itemName)").change(function () {
                setTimeout(function () {
                    let moId = $("#txtMoId@(itemName)").val();
                    let targetUrl = "@Url.Action("GetLineSeq", "Inventory")";
                    let postData = {
                        "MrId": mrId@(itemName)
                    };

                    let data = DataAccess.Get(targetUrl, postData, false);

                    if (data.status == "success") {
                        $.each(data.result, function (i, item) {
                            let count = (item.Count + 1).toString().padStart(4, 0);
                            $("#txtLineSeq@(itemName)").val(count);
                        });
                    }

                    let mtlItemNo = $("#desMtlItemNo@(itemName)").text();
                    let inventory = $("#cboInventoryId@(itemName)").val();
                    $("#aInventoryQty@(itemName)").prop("href", `javascript: PopViewInventoryQty('${mtlItemNo}', '${inventory}', '#cboInventoryIdViewMrWipOrder')`);
                },500);
            });

            $("#cboMrType@(itemName)").change(function () {
                $("#txtQuantity@(itemName)").prop("readonly", false);
                let mesQuanity = $("#desMesQuantity@(itemName)").text();
                let requisitionSetQty = $("#desRequisitionSetQty@(itemName)").text();

                if ($("#cboMrType@(itemName)").val() == "1") {
                    $("#txtQuantity@(itemName)").val(mesQuanity - requisitionSetQty);
                }
                else if ($("#cboMrType@(itemName)").val() == "2") {
                    $("#txtQuantity@(itemName)").val(mesQuanity - requisitionSetQty);
                }
                else if ($("#cboMrType@(itemName)").val() == "3") {
                    $("#txtQuantity@(itemName)").val("0");
                }
                else if ($("#cboMrType@(itemName)").val() == "4") {
                    $("#txtQuantity@(itemName)").val(requisitionSetQty);
                }
                else if ($("#cboMrType@(itemName)").val() == "5") {
                    $("#txtQuantity@(itemName)").val(requisitionSetQty);
                    //$("#txtQuantity@(itemName)").prop("readonly", true);
                }
            });

            GetInventoryLocationFlag@(itemName)();

            $("#cboInventoryId@(itemName)").change(function () {
                GetInventoryLocationFlag@(itemName)();
            });
        }

        function QueryManufactureOrder@(itemName)() {
            let targetUrl = "@Url.Action("GetManufactureOrder", "InventoryTransaction")";
            let postData = {
                "WoErpFullNo": $("#txtWoErpFullNo@(itemName)").val().trim()
            }
            data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                if (data.result.length > 0) {
                    $.each(data.result, function (i, item) {
                        $("#txtMoId@(itemName)").val(item.MoId);
                        $("#txtWoErpFullNo@(itemName)").val(item.WoErpPrefix + "-" + item.WoErpNo + "(" + item.WoSeq + ")");
                        $("#txtQuantity@(itemName)").val(item.Quantity);
                        $("#desMesQuantity@(itemName)").html(item.Quantity);
                        $("#desMtlItemNo@(itemName)").html(item.MtlItemNo);
                        $("#desMtlItemName@(itemName)").html(item.MtlItemName);
                        $("#desMtlItemSpec@(itemName)").html(item.MtlItemSpec);

                        $(".help-block").css("display", "grid");
                    });
                }
                else {
                    $("#txtMoId@(itemName)").val("");
                    $("#txtWoErpFullNo@(itemName)").val("");
                    $(".help-block").css("display", "none");
                    alert("查無此製令相關訊息!!");
                }
            }
            else {
                alert(data.msg);
            }
        }

        function ClearManufactureOrder@(itemName)() {
            $("#txtMoId@(itemName)").val("");
            $("#txtWoErpFullNo@(itemName)").val("");
            $("#cboMrType@(itemName)").val("1");
            $("#txtQuantity@(itemName)").val("");
            $(".help-block").css("display", "none");
        }

        function Save@(itemName)() {
            if ($(objForm@(itemName)).valid()) {
                let mrId = parseInt($("#txtMrId@(itemName)").val());
                let moId = parseInt($("#MoId@(itemName)").val());

                if (mrId <= 0 && moId <= 0) {
                    let targetUrl = "@Url.Action("AddMrWipOrder", "InventoryTransaction")";
                    let postData = {
                        "MrId": mrId@(itemName),
                        "MoId": $("#txtMoId@(itemName)").val(),
                        "WoErpPrefix": $("#txtWoErpFullNo@(itemName)").val().split('-')[0],
                        "WoErpNo": $("#txtWoErpFullNo@(itemName)").val().split('-')[1].split('(')[0],
                        "MrType": $("#cboMrType@(itemName)").val(),
                        "Quantity": parseFloat($("#txtQuantity@(itemName)").val()),
                        "RequisitionCode": $("#cboRequisitionCode@(itemName)").val(),
                        "NegativeStatus": $("#cboNegativeStatus@(itemName)").val(),
                        "Remark": $("#txtRemark@(itemName)").val(),
                        "MaterialCategory": $("#cboMaterialCategory@(itemName)").val(),
                        "SubinventoryType": $("#cboSubinventoryType@(itemName)").val(),
                        "LineSeq": $("#txtLineSeq@(itemName)").val(),
                        "InventoryId": $("#cboInventoryId@(itemName)").val(),
                        "StorageLocation": $("#txtStorageLocation@(itemName)").val()
                    };

                    let result = DataAccess.Add(targetUrl, postData, false, true);

                    if (result) {
                        Return@(itemName)();
                        EditMaterialRequisition(mrId@(itemName));
                        Close@(itemName)();
                    }
                }
                else {
                    let targetUrl;
                    swal.fire({
                        titleText: "是否要重計單身?",
                        text: "重計前請先確認單身無綁定之條碼!",
                        icon: "warning",
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        reverseButtons: true,
                        confirmButtonText: "重計",
                        cancelButtonText: "不重計"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            targetUrl = "@Url.Action("UpdateMrWipOrder", "InventoryTransaction")";
                        }
                        else {
                            targetUrl = "@Url.Action("UpdateMrWipOrderNoRC", "InventoryTransaction")";
                        }

                        let postData = {
                            "MrId": mrId@(itemName),
                            "MoId": $("#txtMoId@(itemName)").val(),
                            "WoErpPrefix": $("#txtWoErpFullNo@(itemName)").val().split('-')[0],
                            "WoErpNo": $("#txtWoErpFullNo@(itemName)").val().split('-')[1].split('(')[0],
                            "MrType": $("#cboMrType@(itemName)").val(),
                            "Quantity": parseFloat($("#txtQuantity@(itemName)").val()),
                            "RequisitionCode": $("#cboRequisitionCode@(itemName)").val(),
                            "NegativeStatus": $("#cboNegativeStatus@(itemName)").val(),
                            "Remark": $("#txtRemark@(itemName)").val(),
                            "MaterialCategory": $("#cboMaterialCategory@(itemName)").val(),
                            "SubinventoryType": $("#cboSubinventoryType@(itemName)").val(),
                            "LineSeq": $("#txtLineSeq@(itemName)").val(),
                            "InventoryId": $("#cboInventoryId@(itemName)").val(),
                            "StorageLocation": $("#txtStorageLocation@(itemName)").val()
                        };

                        let resultData = DataAccess.Update(targetUrl, postData, false, true);

                        if (resultData) {
                            Return@(itemName)();
                            EditMaterialRequisition(mrId@(itemName));
                            Close@(itemName)();
                        }
                    });
                }
            }
        }

        function OpenControlMenu@(itemName)(mrId, moId) {
            $(`.control-menu[data-mr-id][data-mo-id][data-visible]`).hide();

            $.each($(`.control-menu[data-mr-id][data-mo-id][data-visible]`), function (i, item) {
                let itemMrId = $(item).data("mr-id");
                let itemMoId = $(item).data("mo-id");

                if (itemMrId == mrId && itemMoId != moId) {
                    let itemVisible = $(item).data("visible");
                    if (itemVisible == "true") {
                        $(item).data("visible", "false");
                    }
                }
            });

            let item = $(`.control-menu[data-mr-id="${mrId}"][data-mo-id="${moId}"][data-visible]`);
            let visible = item.data("visible");

            if (visible == "true") {
                item.hide();
                item.data("visible", "false");
            }
            else {
                item.show();
                item.data("visible", "true");
            }
        }

        function GetInventoryLocationFlag@(itemName)() {
            let targetUrl = "@Url.Action("GetInventoryLocationFlag", "InventoryTransaction")";

            let postData = {
                "InventoryId": $("#cboInventoryId@(itemName)").val()
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                pageCount = data.result.length;
                if (pageCount > 0) {
                    $.each(data.result, function (i, item) {
                        if (item.LocationFlag == "Y") {
                            $(`#txtStorageLocation@(itemName)`).prop("readonly", false);
                        }
                        else {
                            $(`#txtStorageLocation@(itemName)`).prop("readonly", true);
                            $(`#txtStorageLocation@(itemName)`).val("");
                        }
                    });
                }
            }
        }

        function QueryStorageLocation@(itemName)() {
            let inventoryId = $("#cboInventoryId@(itemName)").val();
            let storageLocation = $("#txtStorageLocation@(itemName)").val();
            let mtlItemNo = $("#desMtlItemNo@(itemName)").html();

            if (mtlItemNo == "") {
                alert("請先輸入品號後再查詢儲位!!")
                return false;
            }

            PopViewStorageLocation(inventoryId, storageLocation, mtlItemNo, "#txtStorageLocation@(itemName)");
        }

        function Delete@(itemName)(mrId, moId) {
            swal.fire({
                titleText: "確認要刪除嗎?",
                text: "此動作無法復原，請確認是否要執行!",
                icon: "warning",
                allowOutsideClick: false,
                allowEscapeKey: false,
                showCancelButton: true,
                confirmButtonColor: '#d33',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    let targetUrl = "@Url.Action("DeleteMrWipOrder", "InventoryTransaction")";
                    let postData = {
                        "MrId": mrId,
                        "MoId": moId
                    };

                    let result = DataAccess.Delete(targetUrl, postData, false, true);

                    if (result) {
                        Query@(itemName)();
                        EditMaterialRequisition(mrId);
                    }
                }
            });
        }

        function GetDeviceInventory@(itemName)() {

            let targetUrl = "@Url.Action("GetDeviceInventory", "InventoryTransaction")";

            let postData = {
            };

            let data = DataAccess.Get(targetUrl, postData, false);

            if (data.status == "success") {
                if (data.result.length > 0) {
                    $.each(data.result, function (i, item) {
                        ComboBoxs.Default("#cboInventoryId@(itemName)", "@Url.Action("GetDeviceInventory", "InventoryTransaction")", {}, "", "NA", "", "InventoryWithNo", "InventoryId");
                        $("#cboInventoryId@(itemName)").val(item.InventoryId);
                        return false;
                    });
                }
            }
        }

        function Return@(itemName)() {
            ResetForm(objForm@(itemName));
            Switch("#listData@(itemName), .list-mode", "#editData@(itemName), .edit-mode");
            Query@(itemName)();
        }

        function Close@(itemName)() {
            $("#modal@(itemName)").modal("hide");
        }
    </script>
                                )