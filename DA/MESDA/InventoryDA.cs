using Dapper;
using Helpers;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using NLog;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;
using System.Web;

namespace MESDA
{
    public class InventoryDA
    {
        public string MainConnectionStrings = "";
        public string ErpConnectionStrings = "";
        public string ErpSysConnectionStrings = "";
        public string HrmConnectionStrings = "";

        public int CurrentCompany = -1;
        public int CurrentUser = -1;
        public int CreateBy = -1;
        public int LastModifiedBy = -1;
        public DateTime CreateDate = default(DateTime);
        public DateTime LastModifiedDate = default(DateTime);

        public string sql = "";
        public JObject jsonResponse = new JObject();
        public Logger logger = LogManager.GetCurrentClassLogger();
        public SqlQuery sqlQuery = new SqlQuery();
        public DynamicParameters dynamicParameters = new DynamicParameters();
        public ErpHelper erpHelper = new ErpHelper();

        public InventoryDA()
        {
            MainConnectionStrings = ConfigurationManager.AppSettings["MainDb"];
            ErpSysConnectionStrings = ConfigurationManager.AppSettings["ErpSysDb"];
            HrmConnectionStrings = ConfigurationManager.AppSettings["HrmDb"];

            GetUserInfo();
            CreateDate = DateTime.Now;
            LastModifiedDate = DateTime.Now;

            dynamicParameters = new DynamicParameters();
            sqlQuery = new SqlQuery();
        }

        #region //GetUserInfo 取得使用者資訊
        private void GetUserInfo()
        {
            try
            {
                CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["UserCompany"]);
                CurrentUser = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                CreateBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                LastModifiedBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);

                if (HttpContext.Current.Session["CompanySwitch"] != null)
                {
                    if (HttpContext.Current.Session["CompanySwitch"].ToString() == "manual")
                    {
                        CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["CompanyId"]);
                    }
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }
        }
        #endregion

        #region //INSERT UserOperateLog 紀錄使用者操作流程
        public void AddUserOperateLog(int DocId = -1, string ErpFullNo = "")
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string FullFunctionName = HttpContext.Current.Request.Path;
                        string IpAddress = BaseHelper.ClientIP();
                        dynamicParameters = new DynamicParameters();

                        sql = @"INSERT INTO BAS.UserOperateLog (DocId, ErpFullNo, FullFunctionName, IpAddress
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@DocId, @ErpFullNo, @FullFunctionName, @IpAddress
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                DocId,
                                ErpFullNo,
                                FullFunctionName,
                                IpAddress,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }
        }
        #endregion

        #region //Get
        #region //GetMaterialRequisition -- 取得領退料單資料 -- Ann 2022-08-16
        public async Task<string> GetMaterialRequisition(int MrId, string RequesitionNo, string MrErpFullNo, string DocType, string JournalStatus
            , string NegativeStatus, string SignupStatus, string SourceType, string ConfirmStatus, string UserNo, string TransferStatus, string WoErpFullNo
            , string MtlItemNo, string MtlItemName
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MrId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.RequesitionNo, a.MrErpPrefix ,a.MrErpNo, FORMAT(a.MrDate, 'yyyy-MM-dd') MrDate
                        , FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate, a.DocType, a.ProductionLine, a.Remark, a.JournalStatus
                        , a.PriorityType, a.NegativeStatus, a.SignupStatus, a.SourceType, a.ConfirmStatus, a.ConfirmUserId
                        , a.ProductionLine, a.TransferStatus, a.ContractManufacturer
                        , b.TypeName DocTypeNo
                        , c.StatusName SignupStatusNo
                        , d.TypeName SourceTypeNo
                        , e.TypeName PriorityTypeNo
                        , f.UserNo ConfirmUserNo, f.UserName ConfirmUserName
                        , g.StatusName ConfirmStatusNo
                        , h.UserNo CreateUserNo, h.UserName CreateUserName";
                    sqlQuery.mainTables =
                        @"FROM MES.MaterialRequisition a
                        INNER JOIN BAS.[Type] b ON a.DocType = b.TypeNo AND b.TypeSchema = 'MaterialRequisition.DocType'
                        INNER JOIN BAS.[Status] c ON a.SignupStatus = c.StatusNo AND c.StatusSchema = 'MaterialRequisition.SignupStatus'
                        INNER JOIN BAS.[Type] d ON a.SourceType = d.TypeNo AND d.TypeSchema = 'MaterialRequisition.SourceType'
                        INNER JOIN BAS.[Type] e ON a.PriorityType = e.TypeNo AND e.TypeSchema = 'MaterialRequisition.PriorityType'
                        LEFT JOIN BAS.[User] f ON a.ConfirmUserId = f.UserId
                        INNER JOIN BAS.[Status] g ON a.ConfirmStatus = g.StatusNo AND g.StatusSchema = 'MaterialRequisition.ConfirmStatus'
                        INNER JOIN BAS.[User] h ON a.CreateBy = h.UserId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MrId", @" AND a.MrId = @MrId", MrId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "RequesitionNo", @" AND a.RequesitionNo LIKE '%' + @RequesitionNo + '%'", RequesitionNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MrErpFullNo", @" AND (a.MrErpPrefix + '-' + a.MrErpNo) LIKE '%' + @MrErpFullNo + '%'", MrErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DocType", @" AND a.DocType = @DocType", DocType);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "JournalStatus", @" AND a.JournalStatus = @JournalStatus", JournalStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NegativeStatus", @" AND a.NegativeStatus = @NegativeStatus", NegativeStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SignupStatus", @" AND a.SignupStatus = @SignupStatus", SignupStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SourceType", @" AND a.SourceType = @SourceType", SourceType);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ConfirmStatus", @" AND a.ConfirmStatus = @ConfirmStatus", ConfirmStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserNo", @" AND h.UserNo LIKE '%' + @UserNo + '%'", UserNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferStatus", @" AND a.TransferStatus = @TransferStatus", TransferStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND EXISTS (SELECT TOP 1 1 FROM MES.MrDetail x INNER JOIN MES.ManufactureOrder xa ON x.MoId = xa.MoId WHERE x.MrId = a.MrId AND (x.WoErpPrefix + '-' + x.WoErpNo + '(' + CONVERT(VARCHAR(10), xa.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%')", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND EXISTS (SELECT TOP 1 1 FROM MES.MrDetail x INNER JOIN PDM.MtlItem xa ON x.MtlItemId = xa.MtlItemId WHERE x.MrId = a.MrId AND xa.MtlItemNo LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND EXISTS (SELECT TOP 1 1 FROM MES.MrDetail x INNER JOIN PDM.MtlItem xa ON x.MtlItemId = xa.MtlItemId WHERE x.MrId = a.MrId AND xa.MtlItemName LIKE '%' + @MtlItemName + '%')", MtlItemName);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MrId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = await BaseHelper.SqlQueryAsync(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMrDetail -- 取得領退料單詳細資料 -- Ann 2022-08-19
        public string GetMrDetail(int MrDetailId, int MrId, string WoErpFullNo, string MtlItemNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<MrDetail> mrDetails = new List<MrDetail>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MrDetailId, a.MrId, a.MrSequence, a.MtlItemId, a.Quantity, a.ActualQuantity, a.UomId, a.InventoryId
                            , a.ProcessCode, a.LotNumber, a.MoId, a.DetailDesc, a.Remark, a.MaterialCategory, a.ConfirmStatus, a.ProcessCode
                            , a.BondedStatus, a.SubstituteStatus, a.OfficialItemStatus, a.SubstitutionId, a.SubstituteProcessCode, a.SubstituteQty, a.SubstituteRate
                            , a.SubstitutionMtlItemNo
                            , b.WoSeq, b.Quantity MesQuantity
                            , c.WoErpPrefix, c.WoErpNo
                            , d.MtlItemNo, d.MtlItemName, d.MtlItemSpec, d.LotManagement
                            , e.UomNo, e.UomName
                            , f.InventoryNo, f.InventoryName
                            , g.MtlItemId BomSubstitutionMtlItemId
                            , h.MtlItemNo BomSubstitutionMtlItemNo, h.MtlItemName BomSubstitutionMtlItemName
                            , i.TypeName MaterialCategoryNo
                            , j.WoDetailId, j.DemandRequisitionQty, j.RequisitionQty
                            , ISNULL(k.CompositionQuantity, 0) CompositionQuantity, k.BarcodeCtrl, k.MainBarcode, k.ControlType
                            , l.DocType, l.MrErpPrefix
                            , (
                                SELECT ISNULL(SUM(x.BarcodeQty), 0) TotalBarcodeQty
                                FROM MES.Barcode x
                                INNER JOIN MES.MrBarcodeRegister xa ON x.BarcodeNo = xa.BarcodeNo
                                WHERE xa.MrDetailId = a.MrDetailId
                            ) TotalBarcodeQty
                            , m.MtlItemNo MoMtlItemNo, m.MtlItemName MoMtlItemName, m.MtlItemSpec MoMtlItemSpec
                            , (
                                SELECT x.BarcodeCtrl
                                FROM MES.MoMtlSetting x 
                                INNER JOIN MES.WoDetail xa ON x.WoDetailId = xa.WoDetailId
                                WHERE x.MoId = a.MoId AND xa.MtlItemId = a.SubstitutionId
                            ) BomBarcodeCtrl
                            FROM MES.MrDetail a
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                            INNER JOIN PDM.MtlItem d ON a.MtlItemId = d.MtlItemId
                            INNER JOIN PDM.UnitOfMeasure e ON a.UomId = e.UomId
                            INNER JOIN SCM.Inventory f ON a.InventoryId = f.InventoryId
                            LEFT JOIN PDM.BomSubstitution g ON a.SubstitutionId = g.SubstitutionId
                            LEFT JOIN PDM.MtlItem h ON g.MtlItemId = h.MtlItemId
                            INNER JOIN BAS.[Type] i ON a.MaterialCategory = i.TypeNo AND i.TypeSchema = 'MrDetail.MaterialCategory'
                            LEFT JOIN MES.WoDetail j ON a.MtlItemId = j.MtlItemId AND c.WoId = j.WoId
                            LEFT JOIN MES.MoMtlSetting k ON b.MoId = k.MoId AND k.WoDetailId = j.WoDetailId
                            INNER JOIN MES.MaterialRequisition l ON a.MrId = l.MrId
                            INNER JOIN PDM.MtlItem m ON c.MtlItemId = m.MtlItemId
                            WHERE c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MrDetailId", @" AND a.MrDetailId = @MrDetailId", MrDetailId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MrId", @" AND a.MrId = @MrId", MrId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND (c.WoErpPrefix + '-' + c.WoErpNo) LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND d.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);

                    sql += @" ORDER BY a.MrId, a.MrSequence";

                    mrDetails = sqlConnection.Query<MrDetail>(sql, dynamicParameters).ToList();

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    int i = 0;
                    foreach (var item in mrDetails)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(LTRIM(RTRIM(TB004)), 0) DemandRequisitionQty
                                , ISNULL(LTRIM(RTRIM(TB005)), 0) RequisitionQty
                                FROM MOCTB
                                WHERE TB001 = @TB001
                                AND TB002 = @TB002
                                AND TB003 = @TB003";
                        dynamicParameters.Add("TB001", item.WoErpPrefix);
                        dynamicParameters.Add("TB002", item.WoErpNo);
                        dynamicParameters.Add("TB003", item.MtlItemNo);
                        var moctbResult = sqlConnection.Query(sql, dynamicParameters);

                        if (moctbResult.Count() <= 0) mrDetails[i].RequisitionQty = 0;

                        foreach (var item2 in moctbResult)
                        {
                            mrDetails[i].RequisitionQty = Convert.ToDecimal(item2.RequisitionQty);
                            mrDetails[i].DemandRequisitionQty = Convert.ToDecimal(item2.DemandRequisitionQty);
                        }
                        i++;
                    }
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    data = mrDetails
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMrWipOrder -- 取得領退料單設定資料 -- Ann 2022-08-19
        public string GetMrWipOrder(int MrId, int MoId, int WoId, string MrErpFullNo, string WoErpFullNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                string WoErpPrefix = "";
                string WoErpNo = "";
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MrId, a.MoId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MrType, a.Quantity, a.InventoryId, a.RequisitionCode, a.NegativeStatus, a.Remark
                        , a.MaterialCategory, a.SubinventoryType, a.LineSeq, a.UomId
                        , b.InputQty, b.Quantity MesQuantity, b.WoSeq
                        , c.WoErpPrefix, c.WoErpNo, c.PlanQty, c.RequisitionSetQty, c.StockInQty
                        , d.TypeName MrTypeNo
                        , e.InventoryNo, e.InventoryName
                        , f.TypeName RequisitionCodeNo
                        , g.TypeName MaterialCategoryNo
                        , h.TypeName SubinventoryTypeNo
                        , i.MtlItemNo, i.MtlItemName, i.MtlItemSpec
                        , j.DocType
                        , k1.UomNo, k1.UomName";
                    sqlQuery.mainTables =
                        @"FROM MES.MrWipOrder a
                        INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                        INNER JOIN MES.WipOrder c ON c.WoId = b.WoId
                        INNER JOIN BAS.[Type] d ON a.MrType = d.TypeNo AND d.TypeSchema = 'MrWipOrder.MrType'
                        INNER JOIN SCM.Inventory e ON a.InventoryId = e.InventoryId
                        INNER JOIN BAS.[Type] f ON a.RequisitionCode = f.TypeNo AND f.TypeSchema = 'MrWipOrder.RequisitionCode'
                        INNER JOIN BAS.[Type] g ON a.MaterialCategory = g.TypeNo AND g.TypeSchema = 'MrWipOrder.MaterialCategory'
                        INNER JOIN BAS.[Type] h ON a.SubinventoryType = h.TypeNo AND h.TypeSchema = 'MrWipOrder.SubinventoryType'
                        INNER JOIN PDM.MtlItem i ON c.MtlItemId = i.MtlItemId
                        INNER JOIN MES.MaterialRequisition j ON a.MrId = j.MrId
                        INNER JOIN PDM.UnitOfMeasure k1 ON a.UomId = k1.UomId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MrId", @" AND a.MrId = @MrId", MrId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoId", @" AND c.WoId = @WoId", WoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MrErpFullNo", @" AND (c.MrErpPrefix + '-' + c.MrErpNo) LIKE '%' + @MrErpFullNo + '%'", MrErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (c.WoErpPrefix + '-' + c.WoErpNo) LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.LineSeq";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetLineSeq -- 取得領退料單輸入序號 -- Ann 2022-08-22
        public string GetLineSeq(int MrId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT COUNT(1) Count
                            FROM MES.MrWipOrder 
                            WHERE MrId = @MrId";
                    dynamicParameters.Add("MrId", MrId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMrDocInfo -- 取得領料單DOC相關資料 -- Ann 2023-09-18
        public string GetMrDocInfo(int MrId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //先取得單頭MES資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MrErpPrefix, a.MrErpNo
                                FROM MES.MaterialRequisition a 
                                WHERE a.MrId = @MrId";
                        dynamicParameters.Add("MrId", MrId);

                        var MrResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MrResult.Count() <= 0) throw new SystemException("MES領料單資料錯誤!!");

                        string MrErpPrefix = "";
                        string MrErpNo = "";
                        foreach (var item in MrResult)
                        {
                            MrErpPrefix = item.MrErpPrefix;
                            MrErpNo = item.MrErpNo;
                        }
                        #endregion

                        #region //取得ERP領料單單頭 MOCTC
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.TC001)) TC001, LTRIM(RTRIM(a.TC002)) TC002
                                , CASE WHEN LEN(LTRIM(RTRIM(a.TC014))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.TC014)) AS date), 'yyyy/MM/dd') ELSE '' END TC014
                                , LTRIM(RTRIM(a.TC004)) TC004, LTRIM(RTRIM(a.TC005)) TC005, LTRIM(RTRIM(a.TC006)) TC006, LTRIM(RTRIM(a.TC007)) TC007
                                , LTRIM(RTRIM(b.MQ002)) MQ002, b.MQ010
                                , LTRIM(RTRIM(c.MB002)) MB002
                                , ISNULL(LTRIM(RTRIM(d.MD002)), '') MD002
                                FROM MOCTC a 
                                INNER JOIN CMSMQ b ON a.TC001 = b.MQ001
                                INNER JOIN CMSMB c ON a.TC004 = c.MB001
                                LEFT JOIN CMSMD d ON a.TC005 = d.MD001
                                WHERE a.TC001 = @MrErpPrefix
                                AND a.TC002 = @MrErpNo";
                        dynamicParameters.Add("MrErpPrefix", MrErpPrefix);
                        dynamicParameters.Add("MrErpNo", MrErpNo);

                        var moctcResult = sqlConnection2.Query(sql, dynamicParameters);
                        #endregion

                        #region //取得ERP領料單單身 MOCTE
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.TE003)) Seq, LTRIM(RTRIM(a.TE004)) MtlItemNo, LTRIM(RTRIM(a.TE006)) UomNo, a.TE005 Quantity, LTRIM(RTRIM(a.TE008)) InventoryNo
                                , LTRIM(RTRIM(a.TE011)) + '-' + LTRIM(RTRIM(a.TE012)) WoErpFullNo, LTRIM(RTRIM(a.TE009)) ProcessCode, LTRIM(RTRIM(a.TE010)) LotNumber
                                , ISNULL(LTRIM(RTRIM(a.TE013)), '') Requisition, ISNULL(LTRIM(RTRIM(a.TE014)), '') Remark, LTRIM(RTRIM(a.TE026)) Type
                                , LTRIM(RTRIM(b.MB002)) MtlItemName, LTRIM(RTRIM(b.MB003)) MtlItemSpec
                                , LTRIM(RTRIM(c.MC002)) InventoryName
                                , ISNULL(LTRIM(RTRIM(d.MC003)), '') Location
                                FROM MOCTE a 
                                INNER JOIN INVMB b ON a.TE004 = MB001
                                INNER JOIN CMSMC c ON a.TE008 = c.MC001
                                LEFT JOIN INVMC d ON a.TE004 = d.MC001 AND d.MC002 = a.TE008
                                WHERE TE001 = @MrErpPrefix
                                AND TE002 = @MrErpNo";
                        dynamicParameters.Add("MrErpPrefix", MrErpPrefix);
                        dynamicParameters.Add("MrErpNo", MrErpNo);

                        var mocteResult = sqlConnection2.Query(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = moctcResult,
                            dataDetail = mocteResult
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMrSequence -- 取得領退料單領料序號 -- Ann 2022-08-25
        public string GetMrSequence(int MrId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT COUNT(1) Count 
                            FROM MES.MrDetail
                            WHERE MrId = @MrId";
                    dynamicParameters.Add("MrId", MrId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMrBarcodeRegister -- 取得領料條碼限制資料 -- Ann 2022-09-05
        public string GetMrBarcodeRegister(int BarcodeRegisterId, int MrDetailId, string BarcodeNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeRegisterId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MrDetailId, a.BarcodeNo, FORMAT(a.CreateDate, 'yyyy-MM-dd') CreateDate
                        , b.UserNo, b.UserName
                        , d.TrayBarcode
                        , e.TrayNo
                        , ISNULL(f.BarcodeQty, 1) BarcodeQty
                        , (
                            SELECT ISNULL(SUM(x.BarcodeQty), 0) TotalBarcodeQty
                            FROM MES.Barcode x
                            INNER JOIN MES.MrBarcodeRegister xa ON x.BarcodeNo = xa.BarcodeNo
                            WHERE xa.MrDetailId = a.MrDetailId
                        ) TotalBarcodeQty
                        , (
                            SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                            , CASE WHEN LEN(LTRIM(RTRIM(x.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(x.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                            FROM MES.BarcodeAttribute x
                            INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE x.BarcodeId = f.BarcodeId
                            FOR JSON PATH, ROOT('data')
                        ) ItemValue";
                    sqlQuery.mainTables =
                        @"FROM MES.MrBarcodeRegister a
                        INNER JOIN BAS.[User] b ON a.CreateBy = b.UserId
                        INNER JOIN MES.MrDetail c ON a.MrDetailId = c.MrDetailId
                        INNER JOIN MES.MoSetting d ON c.MoId = d.MoId
                        LEFT JOIN MES.Tray e ON a.BarcodeNo = e.BarcodeNo
                        LEFT JOIN MES.Barcode f ON a.BarcodeNo = f.BarcodeNo";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND 1=1";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeRegisterId", @" AND a.BarcodeRegisterId = @BarcodeRegisterId", BarcodeRegisterId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MrDetailId", @" AND a.MrDetailId = @MrDetailId", MrDetailId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo LIKE '%' + @BarcodeNo + '%'", BarcodeNo);
                    sqlQuery.conditions = queryCondition;

                    if (OrderBy == "Create") OrderBy = "a.CreateDate DESC";
                    else if (OrderBy == "BarcodeNo") OrderBy = "a.BarcodeNo";
                    else OrderBy = "a.CreateDate DESC";

                    sqlQuery.orderBy = OrderBy;
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMrBarcodeReRegister -- 取得退料條碼限制資料 -- Ann 2022-12-09
        public string GetMrBarcodeReRegister(int BarcodeReRegisterId, int MrDetailId, string BarcodeNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeReRegisterId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MrDetailId, a.BarcodeNo, FORMAT(a.CreateDate, 'yyyy-MM-dd') CreateDate
                        , b.UserNo, b.UserName
                        , (
                            SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                            , CASE WHEN LEN(LTRIM(RTRIM(x.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(x.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                            FROM MES.BarcodeAttribute x
                            INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE x.BarcodeId = c.BarcodeId
                            FOR JSON PATH, ROOT('data')
                        ) ItemValue";
                    sqlQuery.mainTables =
                        @"FROM MES.MrBarcodeReRegister a
                        INNER JOIN BAS.[User] b ON a.CreateBy = b.UserId
                        INNER JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND 1=1";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeReRegisterId", @" AND a.BarcodeReRegisterId = @BarcodeReRegisterId", BarcodeReRegisterId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MrDetailId", @" AND a.MrDetailId = @MrDetailId", MrDetailId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo LIKE '%' + @BarcodeNo + '%'", BarcodeNo);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.BarcodeReRegisterId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetErpInventoryQty -- 取得ERP庫存資料 -- Ann 2023-01-18
        public string GetErpInventoryQty(string MtlItemNo, int InventoryId, string InventoryNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            if (MtlItemNo.Length <= 0) throw new SystemException("品號不能為空!!");
            //if (InventoryId <= 0 && InventoryNo.Length <= 0) throw new SystemException("庫別不能為空!!");

            try
            {
                List<INVMC> iNVMCs = new List<INVMC>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //找InventoryNo
                        if (InventoryId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.InventoryNo
                                    FROM SCM.Inventory a
                                    WHERE a.InventoryId = @InventoryId
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.Add("InventoryId", InventoryId);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            var inventoryResult = sqlConnection.Query(sql, dynamicParameters);

                            if (inventoryResult.Count() <= 0) throw new SystemException("查無此庫別資料!");

                            foreach (var item in inventoryResult)
                            {
                                InventoryNo = item.InventoryNo;
                            }
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.MC001, a.MC002";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", LTRIM(RTRIM(a.MC001)) MtlItemNo, LTRIM(RTRIM(a.MC002)) InventoryNo, LTRIM(RTRIM(a.MC003)) InventorySite, LTRIM(RTRIM(a.MC007)) InventoryQty";
                        sqlQuery.mainTables =
                            @"FROM INVMC a";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"";
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND a.MC001 LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "InventoryNo", @" AND a.MC002 = @InventoryNo", InventoryNo);
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MC001";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        iNVMCs = BaseHelper.SqlQuery<INVMC>(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //回MES查資料
                        int i = 0;
                        foreach (var item in iNVMCs)
                        {
                            #region //查庫別資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.InventoryId, a.InventoryName
                                    FROM SCM.Inventory a
                                    WHERE a.InventoryNo = @InventoryNo
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.Add("InventoryNo", item.InventoryNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            var inventoryResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in inventoryResult)
                            {
                                iNVMCs[i].InventoryId = item2.InventoryId;
                                iNVMCs[i].InventoryName = item2.InventoryName;
                            }
                            #endregion

                            #region //查品號資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemName
                                    FROM PDM.MtlItem a
                                    WHERE a.MtlItemNo = @MtlItemNo
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            var mtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in mtlItemResult)
                            {
                                iNVMCs[i].MtlItemName = item2.MtlItemName;
                            }
                            #endregion
                            i++;
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = iNVMCs
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetLotNumberInventory -- 取得品號批號庫存數量 -- Shintokuro 2023-10-11
        public string GetLotNumberInventory(string MtlItemNo, int InventoryId, string Receipt, string isNon
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                var ErpNo = "";
                string ErpDbName = "";
                string InventoryNo = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                        ErpNo = item.ErpNo;
                    }
                    #endregion

                    #region //判斷庫別資料是否存在
                    if (Receipt != "Mr")
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 InventoryNo
                                FROM SCM.Inventory
                                WHERE InventoryId = @InventoryId";
                        dynamicParameters.Add("InventoryId", InventoryId);

                        var resultInventory = sqlConnection.Query(sql, dynamicParameters);
                        if (resultInventory.Count() <= 0) throw new SystemException("庫別資料錯誤或不存在!");
                        foreach (var item in resultInventory)
                        {
                            InventoryNo = item.InventoryNo;
                        }

                    }
                    #endregion

                    #region //判斷品號是否存在
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 LotManagement
                            FROM PDM.MtlItem
                            WHERE MtlItemNo = @MtlItemNo";
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("品號錯誤或不存在!");
                    foreach (var item in result)
                    {
                        if (item.LotManagement == "N")
                        {
                            throw new SystemException("該品號不需要維護批號!!!");
                        }
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷品號是否存在
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT LTRIM(RTRIM(a.ME001)) ME001, LTRIM(RTRIM(a.ME002)) ME002,LTRIM(RTRIM(a.ME003)) ME003,LTRIM(RTRIM(a.ME009)) ME009,ISNULL(b.num,0) num ,LTRIM(RTRIM(b.MF007)) MF007
                            FROM INVME a
                            OUTER APPLY(
                                  SELECT SUM(x.MF010*x.MF008) num,x.MF007 FROM INVMF x
                                  WHERE x.MF001 = a.ME001 AND x.MF002 = a.ME002
                                  GROUP BY x.MF007
                              ) b
                            WHERE 1 = 1
                            AND a.ME007 = 'N'
                            AND a.ME007 = 'N'
                            AND a.ME001 = @MtlItemNo
                            ";

                    if (isNon == "true") {
                        sql += " AND num != 0";
                    }

                    if (Receipt != "Mr")
                    {
                        sql += " AND b.MF007 = @InventoryNo";
                        dynamicParameters.Add("InventoryNo", InventoryNo);
                    }
                    sql += " ORDER BY a.ME003 ASC";
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        foreach (var item in result)
                        {
                            if (item.LotManagement == "N")
                            {
                                throw new SystemException("該品號不需要維護批號!!!");
                            }
                        }
                    }
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetExcessFlag -- 取得領料單別是否可以超領的欄位資料 -- Ann 2023-05-23
        public string GetExcessFlag(string MrErpPrefix)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        /* 卡控邏輯 by weiwei大幫手
                         (1) CMSMQ.MQ019 = Y ---> 需核對製令(需判斷製令單身物料)
                            * 判斷MOCTE.TE011製令單別、TE012製令單號，TE011、TE012必填。
                            * 判斷MOCTE.TE011製令單別、TE012製令單號，不可領製令單身以外的材料MOCTB.TB003。

                              if CMSMQ.MQ019 = Y(核對製令) and CMSMQ.MQ054 = Y(控制超領)
                              * 如果領料數量MOCTE.TE005 大於 未領料量(需領用量MOCTB.TB004-已領用量MOCTB.TB005)，卡控msg:"數量超領!"
                              * 如果所領材料不存在製令單身，卡控msg:"材料品號、製程不存在此製令用料中!"
  
                              if CMSMQ.MQ019 = Y(核對製令) and CMSMQ.MQ054 = W(警告超領)
                              * 如果領料數量MOCTE.TE005 大於 未領料量(需領用量MOCTB.TB004-已領用量MOCTB.TB005)，警告msg:"數量超領!"
                              * 如果所領材料不存在製令單身，卡控msg:"材料品號、製程不存在此製令用料中!"
  
                              if CMSMQ.MQ019 = Y(核對製令) and CMSMQ.MQ054 = N(不卡超領)
                              * 可以超領製令單身有的材料。
                              * 如果所領材料不存在製令單身，卡控msg:"材料品號、製程不存在此製令用料中!"
  

                         (2) CMSMQ.MQ019 = W ---> 需核對製令(需判斷製令單身物料)
                            * 判斷MOCTE.TE011製令單別、TE012製令單號，TE011、TE012非必填。
                            * CMSMQ.MQ054固定為N(不控制超領)，製令單身原有材料可以超領數量。
                            * 如果所領材料不存在製令單身，警告msg:"材料品號、製程不存在此製令用料中!"
                            * 如果未打MOCTE.TE011製令單別、TE012製令單號，警告msg:"此單據為核對製令,製令編號不可空白!"

                         (3) CMSMQ.MQ019 = N ---> 不核對製令
                            * MOCTE.TE011製令單別、TE012製令單號非必填。
                            * CMSMQ.MQ054固定為N(不控制超領)，製令單身原有材料可以超領數量。
                        */

                        #region //取得是否可以超領的欄位資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MQ019)) MQ019, LTRIM(RTRIM(a.MQ054)) MQ054
                                FROM CMSMQ a
                                WHERE a.MQ001 = @MQ001";
                        dynamicParameters.Add("MQ001", MrErpPrefix);
                        var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = CMSMQResult
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckInventoryQty -- 依據指定製令確認ERP庫存是否足夠 -- Ann 2023-02-08
        public string GetCheckInventoryQty(int MoId, string MrType, double Quantity, int InventoryId)
        {
            try
            {
                List<CheckInventoryQtyClass> checkInventoryQtyClasses = new List<CheckInventoryQtyClass>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //確認MES製令用料資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(a.CompositionQuantity, 1) CompositionQuantity, ISNULL(a.Base, 1) Base
                                , b.DemandRequisitionQty, b.RequisitionQty
                                , c.InventoryNo, c.InventoryName
                                , d.MtlItemNo, d.MtlItemName
                                , e.PlanQty
                                FROM MES.MoMtlSetting a
                                INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                INNER JOIN SCM.Inventory c ON b.InventoryId = c.InventoryId
                                INNER JOIN PDM.MtlItem d ON b.MtlItemId = d.MtlItemId
                                INNER JOIN MES.WipOrder e ON b.WoId = e.WoId
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var moMtlResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        int count = 0;
                        foreach (var item in moMtlResult)
                        {
                            double MrDetailQty = -1;
                            if (item.BomDetailId != null)
                            {
                                double unitQuantity = (item.DemandRequisitionQty - item.RequisitionQty) / item.PlanQty / item.CompositionQuantity;
                                if (unitQuantity * Quantity * item.CompositionQuantity > (item.DemandRequisitionQty - item.RequisitionQty)) MrDetailQty = item.DemandRequisitionQty - item.RequisitionQty;
                                else MrDetailQty = unitQuantity * Quantity * item.CompositionQuantity;
                            }
                            else
                            {
                                switch (MrType)
                                {
                                    case "1":
                                        MrDetailQty = (Quantity * item.CompositionQuantity) / item.Base;
                                        break;
                                    case "2":
                                        MrDetailQty = item.DemandRequisitionQty - item.RequisitionQty;
                                        break;
                                    case "3":
                                        MrDetailQty = item.DemandRequisitionQty - item.RequisitionQty;
                                        break;
                                    case "4":
                                    case "5":
                                        MrDetailQty = item.RequisitionQty;
                                        break;
                                }
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.MC001)) MtlItemNo, LTRIM(RTRIM(a.MC002)) InventoryNo
                                    , LTRIM(RTRIM(a.MC003)) InventorySite, LTRIM(RTRIM(a.MC007)) InventoryQty
                                    FROM INVMC a
                                    WHERE a.MC001 = @MtlItemNo
                                    AND a.MC002 = @InventoryNo";
                            dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                            dynamicParameters.Add("InventoryNo", item.InventoryNo);

                            var inventoryQtyReault = sqlConnection2.Query(sql, dynamicParameters);

                            if (inventoryQtyReault.Count() <= 0) throw new SystemException("查無此庫別庫存資料!");

                            foreach (var item2 in inventoryQtyReault)
                            {
                                var checkInventoryQtyElement = new CheckInventoryQtyClass()
                                {
                                    MtlItemNo = item.MtlItemNo,
                                    MtlItemName = item.MtlItemName,
                                    InventoryNo = item.InventoryNo,
                                    InventoryName = item.InventoryName,
                                    InventoryQty = Convert.ToDouble(item2.InventoryQty),
                                    MrDetailQty = MrDetailQty
                                };
                                checkInventoryQtyClasses.Add(checkInventoryQtyElement);
                            }
                            count++;
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = checkInventoryQtyClasses
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomSubstitution -- 取得取替代料資料 -- Ann 2023-08-31
        public string GetBomSubstitution(string BomMtlItemNo, string BillMtlItemNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (BomMtlItemNo.Length <= 0) throw new SystemException("BOM元件不可為空!");
                if (BillMtlItemNo.Length <= 0) throw new SystemException("BOM主件不可為空!");
                List<BomSubstitution> bomSubstitutions = new List<BomSubstitution>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //取得ERP取替代料資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MB003)) SubstituteStatus, a.MB005 Quantity, a.MB009 SortNumber
                                , CASE WHEN LEN(LTRIM(RTRIM(a.MB006))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MB006)) as date), 'yyyy-MM-dd') ELSE NULL END EffectiveDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.MB007))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MB007)) as date), 'yyyy-MM-dd') ELSE NULL END ExpirationDate
                                , LTRIM(RTRIM(a.MB008)) Remark
                                , LTRIM(RTRIM(b.MB001)) MtlItemNo, LTRIM(RTRIM(b.MB002)) MtlItemName, LTRIM(RTRIM(b.MB003)) MtlItemSpec, LTRIM(RTRIM(b.MB004)) UomNo
                                , ISNULL(LTRIM(RTRIM(c.MC002)), '') InventoryNo, ISNULL(c.MC007, 0) InventoryQty
                                , LTRIM(RTRIM(d.MB001)) BomMtlItemNo, LTRIM(RTRIM(d.MB002)) BomMtlItemName, LTRIM(RTRIM(d.MB003)) BomMtlItemSpec, LTRIM(RTRIM(d.MB004)) BomUomNo
                                FROM BOMMB a 
                                INNER JOIN INVMB b ON a.MB004 = b.MB001
                                LEFT JOIN INVMC c ON c.MC001 = a.MB004
                                INNER JOIN INVMB d ON a.MB001 = d.MB001
                                WHERE a.MB001 = @BomMtlItemNo 
                                AND a.MB002 = @BillMtlItemNo";
                        dynamicParameters.Add("BomMtlItemNo", BomMtlItemNo);
                        dynamicParameters.Add("BillMtlItemNo", BillMtlItemNo);

                        bomSubstitutions = sqlConnection2.Query<BomSubstitution>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //取得MES相對應資料
                        int count = 0;
                        foreach (var item in bomSubstitutions)
                        {
                            #region //取替代料品號
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemId
                                    FROM PDM.MtlItem a 
                                    WHERE a.MtlItemNo = @MtlItemNo
                                    AND a.CompanyId = @CompanyId";
                            dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var MtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in MtlItemResult)
                            {
                                bomSubstitutions[count].MtlItemId = item2.MtlItemId;
                            }
                            #endregion

                            #region //元件品號
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemId
                                    FROM PDM.MtlItem a 
                                    WHERE a.MtlItemNo = @MtlItemNo
                                    AND a.CompanyId = @CompanyId";
                            dynamicParameters.Add("MtlItemNo", item.BomMtlItemNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var BomMtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in BomMtlItemResult)
                            {
                                bomSubstitutions[count].BomMtlItemId = item2.MtlItemId;
                            }
                            #endregion

                            #region //單位
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UomId, a.UomName
                                    FROM PDM.UnitOfMeasure a 
                                    WHERE a.UomNo = @UomNo
                                    AND a.CompanyId = @CompanyId";
                            dynamicParameters.Add("UomNo", item.UomNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var UomResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in UomResult)
                            {
                                bomSubstitutions[count].UomId = item2.UomId;
                                bomSubstitutions[count].UomName = item2.UomName;
                            }
                            #endregion

                            #region //庫別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.InventoryId, ISNULL(a.InventoryName, '查無庫別資訊') InventoryName
                                    FROM SCM.Inventory a 
                                    WHERE a.InventoryNo = @InventoryNo
                                    AND a.CompanyId = @CompanyId";
                            dynamicParameters.Add("InventoryNo", item.InventoryNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var InventoryResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in InventoryResult)
                            {
                                bomSubstitutions[count].InventoryId = item2.InventoryId;
                                bomSubstitutions[count].InventoryName = item2.InventoryName;
                            }
                            #endregion

                            #region //類型
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.StatusName SubstituteStatusNo
                                    FROM BAS.[Status] a 
                                    WHERE a.StatusSchema = 'BomSubstitute.SubstituteStatus'
                                    AND a.StatusNo = @StatusNo";
                            dynamicParameters.Add("StatusNo", item.SubstituteStatus);

                            var SubstituteStatusResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in SubstituteStatusResult)
                            {
                                bomSubstitutions[count].SubstituteStatusNo = item2.SubstituteStatusNo;
                            }
                            #endregion

                            count++;
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = bomSubstitutions
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoWarehouseEnry -- 取得入庫單資料 -- Ted 2022-09-05
        public string GetMoWarehouseEnry(int MweId, string MweErpPrefix, string MweErpFullNo, string DocDate, string ReceiptDate
            , string StartDocDate, string EndDocDate, string StartReceiptDate, string EndReceiptDate, string ConfirmStatus, string TransferStatus
            , string WoErpPrefix, string WoErpFullNo, string MtlItemNo, string MtlItemName, int InventoryId, string UserName
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MweId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MweErpPrefix, a.MweErpNo ,a.CompanyId,FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate,FORMAT(a.ReceiptDate, 'yyyy-MM-dd') ReceiptDate, a.Remark
                          , a.ConfirmStatus,a.ReConfirmStatus, a.TransferStatus
                          ,a.SupplierId,a.TaxCode,a.TaxType,a.TaxRate,a.UiNo,FORMAT(a.InvoiceDate, 'yyyy-MM-dd') InvoiceDate
                          ,a.InvoiceNo,a.ApplyYYMM,a.DepartmentNo,a.InvoiceType,a.DeductType,a.CurrencyCode
                          ,a.Exchange,a.SupplierSo,a.RowCnt,a.PaymentTerm,a.AutoMaterialBilling,a.SupplierPicking
                          ,a.OrigAmount ,a.OrigPreTaxAmount ,a.DeductAmount ,a.OrigTax ,a.ReceiptAmount ,a.PretaxAmount 
                          ,a.TaxAmount ,a.Quantity
                          ,a.IsAmortize
                          ,b.UserName 
                          ,b1.UserName ConfirmUserName
                          ,c.SupplierNo,c.GuiNumber 
                          ";
                    sqlQuery.mainTables =
                        @"FROM MES.MoWarehouseEnry a
                          INNER JOIN BAS.[User] b on a.CreateBy = b.UserId
                          LEFT JOIN BAS.[User] b1 on a.ConfirmUserId = b1.UserId
                          INNER JOIN SCM.Supplier c ON a.SupplierId = c.SupplierId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MweId", @" AND a.MweId = @MweId", MweId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MweErpPrefix", @" AND a.MweErpPrefix = @MweErpPrefix", MweErpPrefix);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MweErpFullNo", @" AND (a.MweErpPrefix + '-' + a.MweErpNo) LIKE '%' + @MweErpFullNo + '%'", MweErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDocDate", @" AND a.DocDate >= @StartDocDate ", StartDocDate.Length > 0 ? Convert.ToDateTime(StartDocDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDocDate", @" AND a.DocDate <= @EndDocDate ", EndDocDate.Length > 0 ? Convert.ToDateTime(EndDocDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartReceiptDate", @" AND a.ReceiptDate >= @StartReceiptDate ", StartReceiptDate.Length > 0 ? Convert.ToDateTime(StartReceiptDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndReceiptDate", @" AND a.ReceiptDate <= @EndReceiptDate ", EndReceiptDate.Length > 0 ? Convert.ToDateTime(EndReceiptDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ConfirmStatus", @" AND a.ConfirmStatus = @ConfirmStatus", ConfirmStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferStatus", @" AND a.TransferStatus = @TransferStatus", TransferStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpPrefix", @" AND EXISTS ( SELECT x.MweId FROM MES.MweDetail x INNER JOIN MES.ManufactureOrder x1 on x.MoId = x1.MoId INNER JOIN MES.WipOrder x2 on x1.WoId = x2.WoId WHERE a.MweId = x.MweId AND x2.WoErpPrefix = @WoErpPrefix)", WoErpPrefix);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND EXISTS ( SELECT x.MweId FROM MES.MweDetail x INNER JOIN MES.ManufactureOrder x1 on x.MoId = x1.MoId INNER JOIN MES.WipOrder x2 on x1.WoId = x2.WoId WHERE a.MweId = x.MweId AND (x2.WoErpPrefix + '-' + x2.WoErpNo + '(' + CAST(x1.WoSeq AS NVARCHAR) +')')  LIKE '%' + @WoErpFullNo + '%')", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND EXISTS ( SELECT x.MweId FROM MES.MweDetail x INNER JOIN PDM.MtlItem x1 on x.MtlItemId = x1.MtlItemId WHERE a.MweId = x.MweId AND  x1.MtlItemNo LIKE '%'+ @MtlItemNo +'%')", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND EXISTS ( SELECT x.MweId FROM MES.MweDetail x INNER JOIN PDM.MtlItem x1 on x.MtlItemId = x1.MtlItemId WHERE a.MweId = x.MweId AND  x1.MtlItemName LIKE '%'+ @MtlItemName +'%')", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "InventoryId", @" AND EXISTS ( SELECT x.MweId FROM MES.MweDetail x WHERE a.MweId = x.MweId AND x.InventoryId = @InventoryId)", InventoryId);
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CreateBy", @" AND b.UserName LIKE '%' + @CreateBy + '%'", CreateBy);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MweId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMweDetail -- 取得入庫單單身資料 -- Ted 2022-09-06
        public string GetMweDetail(int MweDetailId, int MweId, int MoId, string MtlItemNo, int InventoryId, string StartAcceptanceDate, string EndAcceptanceDate, string ConfirmStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MweDetailId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                          @", a.MweId, a.MweSeq, a.MtlItemId, a.ReceiptQty, a.UomId, a.InventoryId, a.LotNumber, a.IsAmortize
                            ,FORMAT(a.AvailableDate, 'yyyy-MM-dd') AvailableDate, FORMAT(a.ReCheckDate, 'yyyy-MM-dd') ReCheckDate, a.MoId, a.ProcessCode, a.ReceiptPackageQty, a.AcceptancePackageQty 
                            ,FORMAT(a.AcceptanceDate, 'yyyy-MM-dd') AcceptanceDate, a.AcceptQty, a.AvailableQty, a.ScriptQty, a.ReturnQty, a.ProjectCode, a.Overdue, a.QcStatus
                            ,a.ReturnCode, a.ConfirmStatus MweConfirmStatus, a.CloseStatus, a.ReNewStatus, a.Remark, a.ConfirmUserId
                            ,a.OrigUnitPrice, a.OrigAmount, a.OrigDiscountAmt, a.ReceiptExpense, a.DiscountDescription, a.VoucherPayablePrefix
                            ,a.VoucherPayableSeq, a.PaymentHold, a.CostEntry, a.ExpenseEntry, a.OrigPreTaxAmt,a.OrigTaxAmt
                            ,a.PreTaxAmt, a.TaxAmt, a.ReserveTaxCode, a.ApproveStatus, a.TransferStatus MweTransferStatus
                            ,a1.ConfirmStatus ,a1.TransferStatus ,a1.ReConfirmStatus 
                            ,b.MtlItemNo,b.MtlItemName,b.MtlItemSpec,b.LotManagement,b.MeasureType
                            ,c.InventoryNo,c.InventoryName
                            ,d.WoSeq
                            ,d1.ScrapRegister
                            ,e.WoErpPrefix,e.WoErpNo,e.PlanQty,e.StockInQty,e.RequisitionSetQty
                            ,f.MweBarcodeNum
                            ,g.BarcodeCtrl,g.OutputBarcodeFlag
                            ";
                    sqlQuery.mainTables =
                        @"FROM MES.MweDetail a
                          INNER JOIN MES.MoWarehouseEnry a1 ON a.MweId = a1.MweId
                          INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                          INNER JOIN SCM.Inventory c ON a.InventoryId = c.InventoryId
                          INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                          INNER JOIN MES.ProdMode d1 ON d.ModeId = d1.ModeId
                          INNER JOIN MES.WipOrder e ON d.WoId = e.WoId
                          LEFT JOIN (SELECT COUNT(f1.MweBarcodeId) MweBarcodeNum,f1.MweDetailId FROM MES.MweBarcode f1 
                                     INNER JOIN MES.MweDetail f2 on f1.MweDetailId = f2.MweDetailId
                                     INNER JOIN MES.MoSetting f3 on f2.MoId = f3.MoId
                                     WHERE f3.BarcodeCtrl = 'N'
                                     GROUP BY f1.MweDetailId
                                    ) f on a.MweDetailId = f.MweDetailId
                          INNER JOIN MES.MoSetting g ON d.MoId = g.MoId
                          ";
                    sqlQuery.auxTables = "";
                    string queryCondition = "";
                    //dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MweDetailId", @" AND a.MweDetailId = @MweDetailId", MweDetailId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MweId", @" AND a.MweId = @MweId", MweId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND b.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "InventoryId", @" AND a.InventoryId = @InventoryId", InventoryId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartAcceptanceDate", @" AND a.DocDate >= @StartAcceptanceDate ", StartAcceptanceDate.Length > 0 ? Convert.ToDateTime(StartAcceptanceDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndAcceptanceDate", @" AND a.DocDate <= @EndAcceptanceDate ", EndAcceptanceDate.Length > 0 ? Convert.ToDateTime(EndAcceptanceDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ConfirmStatus", @" AND a.ConfirmStatus = @ConfirmStatus", ConfirmStatus);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MweDetailId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMweDetailListData -- 取得入庫單身(簡單)-- Shintokuro 2023-08-10
        public string GetMweDetailListData(int MweId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MweId <= 0) throw new SystemException("缺少入庫單據ID,請重新確認!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT (d1.WoErpPrefix + '-' + d1.WoErpNo + '(' + CAST(d.WoSeq AS NVARCHAR) +')' ) FullErp
                            ,a.ReceiptQty,b.MtlItemNo,b.MtlItemName,c.InventoryNo,c.InventoryName 
                            FROM　MES.MweDetail a
                            INNER JOIN PDM.MtlItem b on a. MtlItemId = b.MtlItemId
                            INNER JOIN SCM.Inventory c on a.InventoryId = c.InventoryId
                            INNER JOIN MES.ManufactureOrder d on a.MoId = d.MoId
                            INNER JOIN MES.WipOrder d1 on d.WoId = d1.WoId
                            WHERE a.MweId = @MweId
                            ORDER BY a.MweDetailId DESC";
                    dynamicParameters.Add("MweId", MweId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoIdBarcode -- 取得製令下的條碼 -- Shintokuro 2022-09-16
        public string GetMoIdBarcode(int MoId, int MweDetailId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoId <= 0) throw new SystemException("缺少MES製令ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷該入庫單單身是否有入庫條碼 - 條碼轉移時
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT 'Y' checkBarcode
                                FROM MES.MweBarcode
                                WHERE MweDetailId = @MweDetailId";
                    dynamicParameters.Add("MweDetailId", MweDetailId);
                    var result1 = sqlConnection.Query(sql, dynamicParameters);
                    #endregion

                    #region //判斷該製令是否要做出貨檢才能入庫
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT OQcCheckType
                                FROM MES.MoSetting
                                WHERE MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    var resultOQcCheckType = sqlConnection.Query(sql, dynamicParameters);
                    if (resultOQcCheckType.Count() <= 0) throw new SystemException("資料有問題,設定未完成出貨檢是否可以過站參數有問題");
                    string OQcCheckType = "";
                    foreach (var item in resultOQcCheckType)
                    {
                        OQcCheckType = item.OQcCheckType;
                    }
                    #endregion

                    if (OQcCheckType == "N")
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT  a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus
                                ,a1.MweDetailId, a1.AmortizeTtype
                                ,c.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
                                FROM MES.Barcode a
                                INNER JOIN MES.QcBarcode b on a.BarcodeId = b.BarcodeId
                                INNER JOIN MES.QcRecord b1 on b.QcRecordId = b1.QcRecordId
                                INNER JOIN QMS.QcType b2 on b1.QcTypeId = b2.QcTypeId
                                INNER JOIN MES.MoProcess c on a.CurrentMoProcessId = c.MoProcessId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
                                OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
                                WHERE 1=1
                                AND b2.QcTypeNo = 'OQC' AND a.MoId = @MoId AND a.CurrentProdStatus in ('P','M','R','NK') 
								AND a.BarcodeQty != 0
                                AND a.ParentBarcode is null
                                UNION
								SELECT  a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus 
								,a1.MweDetailId, a1.AmortizeTtype
                                ,c.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
								FROM MES.Barcode a 
                                INNER JOIN MES.MoProcess c on a.CurrentMoProcessId = c.MoProcessId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
								OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
								WHERE 1=1
                                AND a.CurrentProdStatus = 'S' 
								AND a.MoId = @MoId
								AND a.BarcodeQty != 0
                                AND a.ParentBarcode is null
                                UNION
								SELECT  a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus 
								,a1.MweDetailId, a1.AmortizeTtype
                                ,c.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
								FROM MES.Barcode a 
                                INNER JOIN MES.MoProcess c on a.CurrentMoProcessId = c.MoProcessId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
								OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
								WHERE 1=1
                                AND a.BarcodeStatus in ('0','7','8') 
								AND a.MoId = @MoId
								AND a.BarcodeQty != 0
                                AND a.ParentBarcode is null
                                ORDER BY a.BarcodeId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            if (result1.Count() > 0)
                            {
                                result = result1;
                            }
                            else
                            {
                                throw new SystemException("該製製令目前沒有可入庫的條碼,請確認是否有做出貨檢");
                            }
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                    else
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT a.LastModifiedDate, a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus
                                ,a1.MweDetailId, a1.AmortizeTtype
                                ,b.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
                                ,a5.NecessityStatus
                                FROM MES.Barcode a
                                INNER JOIN MES.MoProcess b on a.CurrentMoProcessId = b.MoProcessId
		                        LEFT JOIN MES.BarcodeProcess b1 ON b.MoProcessId = b1.MoProcessId and a.BarcodeId =b1.BarcodeId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
                                OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
                                OUTER APPLY(
                                    SELECT TOP 1 x.MoProcessId, x.SortNumber,x.NecessityStatus 
                                    FROM　MES.MoProcess x
                                    WHERE x.MoId = @MoId
                                    AND NecessityStatus = 'Y'
                                    ORDER BY SortNumber DESC
                                ) a4
                                OUTER APPLY(
                                    SELECT 
                                    CASE 
                                        WHEN EXISTS (
                                            SELECT 1 
                                            FROM MES.BarcodeProcess x 
                                            WHERE a4.MoProcessId = x.MoProcessId 
                                            AND x.BarcodeId = a.BarcodeId
                                            AND x.FinishDate IS NOT NULL
                                        ) THEN 'Y'
                                        ELSE 'N'
                                    END AS NecessityStatus
                                ) a5
                                WHERE 1=1
                                AND a.MoId = @MoId
                                AND a.CurrentProdStatus in ('P','M','R','NK')
								AND a.BarcodeQty != 0
                                AND a.ParentBarcode is null
                                UNION
								SELECT DISTINCT a.LastModifiedDate, a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus 
								,a1.MweDetailId, a1.AmortizeTtype
                                ,c.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
                                ,'N' NecessityStatus
								FROM MES.Barcode a 
                                INNER JOIN MES.MoProcess c on a.CurrentMoProcessId = c.MoProcessId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
								OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
								WHERE 1=1
                                AND a.CurrentProdStatus = 'S' 
								AND a.MoId = @MoId
								AND a.BarcodeQty != 0
                                AND a.ParentBarcode is null
                                --ORDER BY CASE WHEN a.CurrentProdStatus  = 'S' THEN 0 ELSE 1 END, a.BarcodeId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            if (result1.Count() > 0)
                            {
                                #region //Response
                                jsonResponse = JObject.FromObject(new
                                {
                                    status = "success",
                                    data = result1
                                });
                                #endregion
                            }
                            else
                            {
                                throw new SystemException("該製製令目前沒有可入庫的條,請確認是否有做出貨檢");
                            }
                        }
                        else
                        {
                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                data = result
                            });
                            #endregion
                        }
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoIdBarcodePass -- 取得製令下的條碼(要入待報廢倉) -- Shintokuro 2022-09-16
        public string GetMoIdBarcodePass(int MoId, int MweDetailId, string BarcodeNo, string CurrentProdStatus, string BarcodeStatus)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoId <= 0) throw new SystemException("缺少MES製令ID!!!");


                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷該入庫單單身是否有入庫條碼 - 條碼轉移時
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT 'Y' checkBarcode
                            FROM MES.MweBarcode
                            WHERE MweDetailId = @MweDetailId";
                    dynamicParameters.Add("MweDetailId", MweDetailId);

                    var result1 = sqlConnection.Query(sql, dynamicParameters);
                    #endregion

                    #region //判斷該製令是否要做出貨檢才能入庫
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT OQcCheckType
                            FROM MES.MoSetting
                            WHERE MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    var resultOQcCheckType = sqlConnection.Query(sql, dynamicParameters);
                    if (resultOQcCheckType.Count() <= 0) throw new SystemException("資料有問題,設定未完成出貨檢是否可以過站參數有問題");
                    string OQcCheckType = "";
                    foreach (var item in resultOQcCheckType)
                    {
                        OQcCheckType = item.OQcCheckType;
                    }
                    #endregion

                    if (CurrentProdStatus == "S")
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT  a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus 
								,a1.MweDetailId, a1.AmortizeTtype
                                ,c.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
								FROM MES.Barcode a 
                                INNER JOIN MES.MoProcess c on a.CurrentMoProcessId = c.MoProcessId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
								OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
								WHERE a.CurrentProdStatus = 'S' 
                                AND a.ParentBarcode is null
								AND a.BarcodeQty != 0
								AND a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "CurrentProdStatus", @" AND a.CurrentProdStatus = @CurrentProdStatus", CurrentProdStatus);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeStatus", @" AND a.BarcodeStatus = @BarcodeStatus", BarcodeStatus);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            if (result1.Count() > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.BarcodeId,b.BarcodeNo,b.BarcodeQty,b.BarcodeStatus,c.ProcessAlias , a.AmortizeTtype
                                    FROM MES.MweBarcode a
								    INNER JOIN MES.BarcodeLog b on a.BarcodeId = b.BarcodeId
								    INNER JOIN MES.MoProcess c on b.CurrentMoProcessId = c.MoProcessId
								    WHERE MweDetailId = @MweDetailId
								    AND BarcodeStatus = '0'";
                                dynamicParameters.Add("MweDetailId", MweDetailId);
                                result = sqlConnection.Query(sql, dynamicParameters);
                            }
                            else
                            {
                                throw new SystemException("該製製令目前沒有可入庫的報廢條碼");
                            }
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion

                    }
                    else
                    {
                        if (OQcCheckType == "N")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT  a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus
                                ,a1.MweDetailId, a1.AmortizeTtype
                                ,c.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
                                ,a5.NecessityStatus
                                FROM MES.Barcode a
                                INNER JOIN MES.QcBarcode b on a.BarcodeId = b.BarcodeId
                                INNER JOIN MES.QcRecord b1 on b.QcRecordId = b1.QcRecordId
                                INNER JOIN MES.MoProcess c on a.CurrentMoProcessId = c.MoProcessId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
                                INNER JOIN QMS.QcType e ON b1.QcTypeId=e.QcTypeId
                                OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
                                OUTER APPLY(
                                    SELECT TOP 1 x.MoProcessId, x.SortNumber,x.NecessityStatus 
                                    FROM　MES.MoProcess x
                                    WHERE x.MoId = @MoId
                                    AND NecessityStatus = 'Y'
                                    ORDER BY SortNumber DESC
                                ) a4
                                OUTER APPLY(
                                    SELECT 
                                    CASE 
                                        WHEN EXISTS (
                                            SELECT 1 
                                            FROM MES.BarcodeProcess x 
                                            WHERE a4.MoProcessId = x.MoProcessId 
                                            AND x.BarcodeId = a.BarcodeId
                                            AND x.FinishDate IS NOT NULL
                                        ) THEN 'Y'
                                        ELSE 'N'
                                    END AS NecessityStatus
                                ) a5
                                WHERE 1=1
                                AND e.QcTypeNo = 'OQC' AND a.MoId = @MoId
								AND a.BarcodeQty != 0
                                AND a.ParentBarcode is null
                                UNION
								SELECT  a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus 
								,a1.MweDetailId, a1.AmortizeTtype
                                ,c.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
                                ,a5.NecessityStatus
								FROM MES.Barcode a 
                                INNER JOIN MES.MoProcess c on a.CurrentMoProcessId = c.MoProcessId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
								OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
                                OUTER APPLY(
                                    SELECT TOP 1 x.MoProcessId, x.SortNumber,x.NecessityStatus 
                                    FROM　MES.MoProcess x
                                    WHERE x.MoId = @MoId
                                    AND NecessityStatus = 'Y'
                                    ORDER BY SortNumber DESC
                                ) a4
                                OUTER APPLY(
                                    SELECT 
                                    CASE 
                                        WHEN EXISTS (
                                            SELECT 1 
                                            FROM MES.BarcodeProcess x 
                                            WHERE a4.MoProcessId = x.MoProcessId 
                                            AND x.BarcodeId = a.BarcodeId
                                            AND x.FinishDate IS NOT NULL
                                        ) THEN 'Y'
                                        ELSE 'N'
                                    END AS NecessityStatus
                                ) a5
								WHERE 1=1
								AND a.BarcodeStatus in ( '7','8') 
                                AND a.MoId = @MoId
								AND a.BarcodeQty != 0
                                AND a.ParentBarcode is null
                                ";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("MweDetailId", MweDetailId);
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "CurrentProdStatus", @" AND a.CurrentProdStatus IN @CurrentProdStatus", CurrentProdStatus.Split(','));
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeStatus", @" AND a.BarcodeStatus = @BarcodeStatus", BarcodeStatus);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                if (result1.Count() > 0)
                                {
                                    result = result1;
                                }
                                else
                                {
                                    throw new SystemException("該製製令目前沒有可入庫的良品條碼,請確認是否有做出貨檢");
                                }
                            }

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                data = result
                            });
                            #endregion
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"
                                SELECT DISTINCT a.LastModifiedDate, a.BarcodeId ,a.BarcodeNo,a.CurrentMoProcessId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus
                                ,a1.MweDetailId, a1.AmortizeTtype
                                ,b.ProcessAlias
                                ,a2.ItemValue
                                ,a3.TrayNo
                                ,d.TrayBarcode
                                ,a5.NecessityStatus
                                FROM MES.Barcode a
                                INNER JOIN MES.MoProcess b on a.CurrentMoProcessId = b.MoProcessId
		                        LEFT JOIN MES.BarcodeProcess b1 ON b.MoProcessId = b1.MoProcessId and a.BarcodeId =b1.BarcodeId
                                INNER JOIN MES.MoSetting d on a.MoId = d.MoId
                                OUTER  APPLY(
	                                SELECT * from MES.MweBarcode b
	                                WHERE a.BarcodeId = b.BarcodeId
                                    AND b.MweDetailId = @MweDetailId
                                ) a1
                                OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                )a2
                                OUTER APPLY(
	                                SELECT TrayNo
	                                FROM MES.Tray c
	                                WHERE a.BarcodeNo = c.BarcodeNo
                                ) a3
                                OUTER APPLY(
                                    SELECT TOP 1 x.MoProcessId, x.SortNumber,x.NecessityStatus 
                                    FROM　MES.MoProcess x
                                    WHERE x.MoId = @MoId
                                    AND NecessityStatus = 'Y'
                                    ORDER BY SortNumber DESC
                                ) a4
                                OUTER APPLY(
                                    SELECT 
                                    CASE 
                                        WHEN EXISTS (
                                            SELECT 1 
                                            FROM MES.BarcodeProcess x 
                                            WHERE a4.MoProcessId = x.MoProcessId 
                                            AND x.BarcodeId = a.BarcodeId
                                            AND x.FinishDate IS NOT NULL
                                        ) THEN 'Y'
                                        ELSE 'N'
                                    END AS NecessityStatus
                                ) a5
                                WHERE 1=1
                                AND a.ParentBarcode is null
								AND a.BarcodeQty != 0
                                AND a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("MweDetailId", MweDetailId);
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "CurrentProdStatus", @" AND a.CurrentProdStatus IN @CurrentProdStatus", CurrentProdStatus.Split(','));
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeStatus", @" AND a.BarcodeStatus = @BarcodeStatus", BarcodeStatus);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                if (result1.Count() > 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT b.BarcodeId,b.BarcodeNo,b.BarcodeQty,b.BarcodeStatus,c.ProcessAlias , a.AmortizeTtype
                                            FROM MES.MweBarcode a
								            INNER JOIN MES.BarcodeLog b on a.BarcodeId = b.BarcodeId
								            INNER JOIN MES.MoProcess c on b.CurrentMoProcessId = c.MoProcessId
								            WHERE MweDetailId = @MweDetailId
								            AND BarcodeStatus = '0'";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);
                                    result = sqlConnection.Query(sql, dynamicParameters);
                                }
                                else
                                {
                                    throw new SystemException("該製製令目前沒有可入庫的良品條碼,請確認是否有做出貨檢");
                                }
                            }

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                data = result
                            });
                            #endregion
                        }
                    }

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMweBarcodeTransfer -- 取得入庫單移轉條碼 -- Shintokuro 2023-04-12
        public string GetMweBarcodeTransfer(int MoId, int MweDetailId)
        {
            try
            {
                string BarcodeCtrl = "";
                string OutputBarcodeFlag = "";
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoId <= 0) throw new SystemException("缺少MES製令ID!!!");


                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷製令是否存在
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 b.BarcodeCtrl,b.OutputBarcodeFlag
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.MoSetting b on a.MoId = b.MoId
                            WHERE a.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【入庫單錯誤】製令不存在,請重新確認資料");
                    foreach (var item in result)
                    {
                        BarcodeCtrl = item.BarcodeCtrl;
                        OutputBarcodeFlag = item.OutputBarcodeFlag;
                    }
                    #endregion

                    if (BarcodeCtrl == "Y" || (BarcodeCtrl == "N" && OutputBarcodeFlag == "Y"))
                    {
                        #region //判斷該入庫單單身是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                            FROM MES.MweBarcode
                            WHERE MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【入庫單錯誤】入庫單身不存在,請重新確認資料");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT c.BarcodeId,c.BarcodeNo,a.MweBarcodeQty,a2.ItemValue 
                            FROM MES.MweBarcode a
                            INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                            INNER JOIN MES.Barcode c on a.BarcodeId =c.BarcodeId
                            OUTER APPLY(
	                                SELECT STUFF((SELECT ', ' + ItemNo + ':' + Convert(varchar(100),c.ItemValue) 
	                                FROM MES.BarcodeAttribute c
	                                WHERE a.BarcodeId = c.BarcodeId
                                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS ItemValue
                                ) a2
                            WHERE b.MoId != c.MoId
                            AND b.MoId = @MoId
                            AND b.MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWipOrderRequisitionSetQty -- 檢查製令是否領料+取得該製令已領套數數量 -- Ted 2022-09-20
        public string GetWipOrderRequisitionSetQty(int MoId, int MweId, int MweDetailId, string ConfirmStatus, string MoIdType)
        {
            try
            {
                int WoId = -1;
                int ModeId = -1;
                string WoErpPrefix = "";
                string WoErpNo = "";
                string MweErpPrefix = "";
                int PlanQty = -1;
                int TotalPassQty = 0;
                int TotalScrapQty = 0;
                int? TotalInputQty = 0;

                int ReceiptQtyERP = 0;
                int AcceptQtyERP = 0;
                int ScriptQtyERP = 0;

                int ReceiptQty = 0;
                int AcceptQty = 0;
                int ScriptQty = 0;

                //數量用
                int AllReceiptQty = -1;
                int AllAcceptQty = -1;
                int AllScrapQty = -1;

                int MrQuantity = 0; //領料單套數

                string BarcodeCtrl = "";
                string ScrapRegister = "";
                string OutputBarcodeFlag = "";
                string AllOutsourcing = "N";
                string WarnMessage = "";
                string LotManagement = "";
                string EfficientDays = "";
                string RetestDays = "";

                List<string> caseNumList = new List<string>();
                List<string> RequisitionSetQtyList = new List<string>();
                List<string> enterQtyList = new List<string>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoId <= 0) throw new SystemException("缺少MES製令ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //入庫單單別撈取
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MweErpPrefix
                            FROM MES.MoWarehouseEnry a
                            WHERE a.MweId = @MweId";
                    dynamicParameters.Add("MweId", MweId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【入庫單】－入庫單單頭不存在,製令有問題");
                    foreach (var item in result)
                    {
                        MweErpPrefix = item.MweErpPrefix;
                    }
                    #endregion  

                    #region //MES製令相關資料撈取
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.WoId,a.ModeId
                            ,b.WoErpPrefix,b.WoErpNo,b.MtlItemId ManMtlItemId,b.PlanQty,b1.DemandRequisitionQty
                            ,b1.CompositionQuantity,b1.Base,b1.LossRate
                            ,b2.MtlItemNo,b2.LotManagement,b2.EfficientDays,b2.RetestDays
                            ,c.StandardLot
							,d.BarcodeCtrl ,d.OutputBarcodeFlag
							,d1.ScrapRegister
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b on a.WoId =b.WoId
                            INNER JOIN MES.WoDetail b1 on b.WoId =b1.WoId
                            INNER JOIN PDM.MtlItem b2 on b.MtlItemId =b2.MtlItemId
                            LEFT JOIN PDM.BillOfMaterials c on b.MtlItemId =c.MtlItemId
                            INNER JOIN MES.MoSetting d on a.MoId =d.MoId
                            INNER JOIN MES.ProdMode d1 on a.ModeId =d1.ModeId
                            WHERE a.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【入庫單】－MES製令ID有問題");
                    foreach (var item in result)
                    {
                        WoErpPrefix = item.WoErpPrefix;
                        WoErpNo = item.WoErpNo;
                        PlanQty = item.PlanQty;
                        BarcodeCtrl = item.BarcodeCtrl;
                        ScrapRegister = item.ScrapRegister;
                        WoId = item.WoId;
                        ModeId = item.ModeId;
                        OutputBarcodeFlag = item.OutputBarcodeFlag;
                        LotManagement = item.LotManagement;
                        EfficientDays = item.EfficientDays.ToString();
                        RetestDays = item.RetestDays.ToString();
                    }


                    //foreach (var item in result)
                    //{
                    //    //Double? caseNum = item.CompositionQuantity / item.Base / item.StandardLot * (1 + item.LossRate);
                    //    //if (caseNum == null || caseNum == 0)
                    //    //{
                    //    //    caseNum = 1;
                    //    //}
                    //    string caseArr = Convert.ToString(item.DemandRequisitionQty) + "," + item.MtlItemNo;
                    //    caseNumList.Add(caseArr);
                    //}
                    #endregion

                    #region //檢查MES製令是否有產品條碼
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT 
                                CASE 
                                    WHEN a.BarcodeCtrl  = 'N' AND a.OutputBarcodeFlag = 'Y' THEN 1 
                                    WHEN a.BarcodeCtrl  = 'N' AND a.OutputBarcodeFlag = 'N' THEN 0 
                                    ELSE 0 END num
                            FROM MES.MoSetting a
                            WHERE a.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    int? MoIdTypeBase = -1;
                    foreach (var item in result)
                    {
                        MoIdTypeBase = Convert.ToInt32(item.num);
                    }
                    if (MoIdTypeBase == 0)
                    {
                        MoIdType = "N";
                    }
                    else
                    {
                        MoIdType = "Y";
                    }
                    #endregion

                    #region //判斷製令是否為全委外
                    if (MoIdType == "Y") //判斷製令是否有條碼
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            AllOutsourcing = "Y";
                        }
                    }
                    else if (MoIdType == "N")
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcessTransaction a
                                    WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            AllOutsourcing = "Y";
                        }
                    }
                    #endregion


                    #region //判斷是否需要做出貨檢的產品可以入庫
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.OQcCheckType 
                            FROM MES.MoSetting a
                            WHERE a.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        string OQcCheckType = "";
                        foreach (var item in result)
                        {
                            OQcCheckType = item.OQcCheckType;
                        }
                        if (OQcCheckType == "N") //要做
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.QcTypeId 
                                    FROM MES.QcRecord a
                                    INNER JOIN QMS.QcType b on a.QcTypeId = b.QcTypeId
                                    WHERE a.MoId = @MoId
                                    AND b.QcTypeNo = 'OQC'";
                            dynamicParameters.Add("MoId", MoId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeId  
                                        FROM MES.Barcode a
                                        WHERE a.MoId = @MoId
                                        AND a.CurrentProdStatus = 'S'
                                        UNION
										SELECT a.BarcodeId  
                                        FROM MES.Barcode a
                                        WHERE a.MoId = @MoId
                                        AND a.NextMoProcessId = -1
                                        AND a.BarcodeStatus = '7'";
                                dynamicParameters.Add("MoId", MoId);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0)
                                {
                                    if (AllOutsourcing == "Y" && MweErpPrefix == "5903") //全委外不用檢核
                                    {
                                        throw new SystemException("該製令目前無可以進貨產品(可能未做工程檢或是條碼為刷過站)");
                                    }
                                    else
                                    {
                                        throw new SystemException("該製令目前無可以進貨產品(可能未做工程檢或是條碼為刷過站)");
                                    }
                                }
                            }
                        }
                    }
                    #endregion

                    #region //撈出MES系統下的ERP製令的入庫數量
                    dynamicParameters = new DynamicParameters();
                    sql = @" SELECT SUM(a.ReceiptQty) ReceiptQty,SUM(a.AcceptQty) AcceptQty,SUM(a.ScriptQty) ScriptQty
                             FROM MES.MweDetail a
                             INNER JOIN MES.MoWarehouseEnry b on a.MweId = b.MweId
                             INNER JOIN MES.ManufactureOrder c on a.MoId = c.MoId
                             INNER JOIN MES.WipOrder c1 on c.WoId = c1.WoId
                             WHERE c1.WoId = @WoId
                             AND b.ConfirmStatus !='V'";
                    dynamicParameters.Add("WoId", WoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        ReceiptQtyERP = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ReceiptQty);
                        AcceptQtyERP = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).AcceptQty);
                        ScriptQtyERP = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ScriptQty);
                    }
                    #endregion

                    #region //撈出該MES製令下入庫數量 =>後續要比對 其領料單可生產的數量是否有超過
                    dynamicParameters = new DynamicParameters();
                    sql = @" SELECT SUM(a.ReceiptQty) ReceiptQty,SUM(a.AcceptQty) AcceptQty,SUM(a.ScriptQty) ScriptQty
                             FROM MES.MweDetail a
                             INNER JOIN MES.MoWarehouseEnry b on a.MweId = b.MweId
                             WHERE a.MoId = @MoId
                             AND a.ConfirmStatus != 'V'";
                    dynamicParameters.Add("MoId", MoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        foreach (var item in result)
                        {
                            ReceiptQty = Convert.ToInt32(item.ReceiptQty);
                            AcceptQty = Convert.ToInt32(item.AcceptQty);
                            ScriptQty = Convert.ToInt32(item.ScriptQty);
                        }
                    }
                    #endregion

                    #region //撈出該MES製令下領料單 領料套數
                    //dynamicParameters = new DynamicParameters();
                    //sql = @" SELECT SUM(a.Quantity) MrQuantity
                    //         FROM MES.MrWipOrder a
                    //         WHERE a.MoId = @MoId";
                    //dynamicParameters.Add("MoId", MoId);

                    //result = sqlConnection.Query(sql, dynamicParameters);
                    //if (result.Count() > 0)
                    //{
                    //    MrQuantity = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MrQuantity);
                    //}

                    //if (MrQuantity < ReceiptQty) throw new SystemException("領料單數量不足,進貨數量超過領料單數量");
                    #endregion

                    #region//撈出該製令下的生產數量 報廢數  TotalInputQty TotalPassQty
                    if (AllOutsourcing == "Y" && MweErpPrefix == "5903") //全委外且入庫單為5903不用判斷
                    {

                    }
                    else
                    {
                        if (BarcodeCtrl == "N" && OutputBarcodeFlag == "N")
                        {
                            #region //撈出該製令下最後一個必要過站
                            dynamicParameters = new DynamicParameters();

                            sql = @"SELECT MAX(c.SortNumber) SortNumber
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.ProdMode b on a.ModeId = b.ModeId
                                INNER JOIN MES.MoProcess c ON a.MoId = c.MoId
                                WHERE a.MoId = @MoId
                                AND c.NecessityStatus = 'Y'";
                            dynamicParameters.Add("MoId", MoId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到製令下最後一個必要過站");
                            int SortNumberMax = -1;
                            foreach (var item in result)
                            {
                                SortNumberMax = Convert.ToInt32(item.SortNumber);
                            }
                            #endregion

                            #region //撈出該製令下已經產品完工數量(數量過站)
                            int SortNumber = -1;

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 c.SortNumber,c.TotalInputQty,c.TotalScrapQty,c.TotalPassQty,AllReceiptQty,x.AllAcceptQty,x.AllScrapQty
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.ProdMode b on a.ModeId = b.ModeId
                                INNER JOIN MES.MoProcess c ON a.MoId = c.MoId
                                INNER JOIN MES.MoProcessTransaction d ON c.MoProcessId = d.MoProcessId
                                OUTER APPLY(
	                                SELECT  SUM(x1.ReceiptQty) AllReceiptQty,SUM(x1.AcceptQty) AllAcceptQty,SUM(x1.ScriptQty) AllScrapQty
	                                FROM MES.MweDetail x1
	                                WHERE a.MoId = x1.MoId
	                                AND x1.ConfirmStatus != 'V'
                                ) x
                                WHERE a.MoId = @MoId
                                AND c.NecessityStatus = 'Y'
                                AND d.ProdStatus = 'P'
                                Order By c.SortNumber DESC";
                            dynamicParameters.Add("MoId", MoId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到完工數量");
                            foreach (var item in result)
                            {
                                SortNumber = item.SortNumber;
                                TotalInputQty = item.TotalInputQty;
                                TotalPassQty = item.TotalPassQty;
                                AllReceiptQty = item.AllReceiptQty != null ? item.AllReceiptQty : 0;
                                AllAcceptQty = item.AllAcceptQty != null ? item.AllAcceptQty : 0;
                                AllScrapQty = item.AllScrapQty != null ? item.AllScrapQty : 0;
                                if (SortNumberMax != SortNumber) throw new SystemException("該製令最後一站未生產產品");

                            }
                            #endregion

                            #region //撈出該製令下產品報廢數量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT SUM(a.Quantity) TotalScrapQty
                                FROM MES.MoProcessTransaction a
                                WHERE MoId = @MoId
                                AND ProdStatus = 'S' ";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in result)
                            {
                                TotalScrapQty = Convert.ToInt32(item.TotalScrapQty);
                            }
                            #endregion

                            #region //撈出該製令下產品NG數量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT SUM(a.Quantity) TotalNgQuantity
                                FROM MES.MoProcessTransaction a
                                WHERE MoId = @MoId
                                AND ProdStatus = 'F'";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            int TotalNgQuantity = -1;
                            foreach (var item in result)
                            {
                                TotalNgQuantity = Convert.ToInt32(item.TotalNgQuantity);
                            }
                            TotalInputQty = TotalInputQty - TotalNgQuantity;
                            //TotalPassQty = TotalPassQty - TotalNgQuantity;
                            #endregion
                        }
                        else
                        {
                            #region //撈出該製令下已經產品投入數量(條碼)
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT SUM(b.BarcodeQty) TotalInputQty
                                            FROM MES.ManufactureOrder a
                                            INNER JOIN MES.Barcode b ON a.MoId = b.MoId
                                            WHERE a.MoId = @MoId
                                            AND exists(SELECT 1
                                            FROM MES.BarcodeProcess c
			                                WHERE a.MoId = c.MoId
			                                AND b.BarcodeId = c.BarcodeId)";
                            dynamicParameters.Add("MoId", MoId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in result)
                            {
                                TotalInputQty = Convert.ToInt32(item.TotalInputQty);
                            }
                            #endregion

                            #region //撈出該製令下產品完工數量+NG數量(條碼)
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT x.Pass,y.Ng
								            FROM
								            (
									           SELECT SUM(b.BarcodeQty) Pass
									           FROM MES.ManufactureOrder a
									           INNER JOIN MES.Barcode b ON a.MoId = b.MoId
									           WHERE a.MoId = @MoId
									           AND b.CurrentProdStatus IN ('P','M','R')
									           AND b.BarcodeStatus !='1' 
                                               AND NOT EXISTS(SELECT 1
                                                              FROM MES.MweDetail c
					                                          INNER JOIN MES.MweBarcode d ON c.MweDetailId = d.MweDetailId
				                                              WHERE c.MoId = b.MoId
				                                              AND b.BarcodeId = d.BarcodeId)
								            ) x,
								            (
									           SELECT SUM(b.BarcodeQty) Ng
									           FROM MES.ManufactureOrder a
									           INNER JOIN MES.Barcode b ON a.MoId = b.MoId
									           WHERE a.MoId = @MoId
									           AND b.CurrentProdStatus = 'S'
									           AND b.BarcodeStatus !='1'
                                               AND NOT EXISTS(SELECT 1
                                                              FROM MES.MweDetail c
					                                          INNER JOIN MES.MweBarcode d ON c.MweDetailId = d.MweDetailId
				                                              WHERE c.MoId = b.MoId
				                                              AND b.BarcodeId = d.BarcodeId)
								            ) y";
                            dynamicParameters.Add("MoId", MoId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到完工數量");
                            foreach (var item in result)
                            {
                                TotalPassQty = Convert.ToInt32(item.Pass);
                                TotalScrapQty = Convert.ToInt32(item.Ng);
                            }
                            #endregion
                        }
                    }
                    #endregion

                }
                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷生產數量是否超過領料單可生產數量

                    #region //撈取單據缺領設定
                    string PickingListOutSet = "";
                    string PickingListInSet = "";
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT MQ055,MQ056
                            FROM CMSMQ 
                            WHERE MQ001=@MweErpPrefix";
                    dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                    var resultSetting1 = sqlConnection.Query(sql, dynamicParameters);
                    if (resultSetting1.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                    foreach (var item1 in resultSetting1)
                    {
                        PickingListOutSet = item1.MQ055;
                        PickingListInSet = item1.MQ056;
                    }
                    #endregion

                    #region //撈出該製令下材料領料單全部領料數並計算出目前可入庫的最大產品套數
                    dynamicParameters = new DynamicParameters();
                    Double MakeNum = 0;
                    int num = 0;

                    #region //獲取ERP單據的材料和須領用量
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT LTRIM(RTRIM(TB003)) TB003,SUM(TB004) TB004
                            FROM MOCTB 
                            WHERE TB001=@WoErpPrefix
                            AND TB002 =@WoErpNo
                            AND TB018 ='Y'
                            AND TB011 !=3
                            AND TB011 !=4
                            AND TB004 !=0
                            GROUP BY TB003";
                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                    dynamicParameters.Add("WoErpNo", WoErpNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                    foreach (var item in result)
                    {
                        string caseArr = Convert.ToString(item.TB004) + "," + item.TB003;
                        caseNumList.Add(caseArr);
                    }
                    #endregion

                    foreach (var item in caseNumList)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TE027,sum(a.TE005*b.MQ010*-1) NumSet
                                FROM MOCTE a
                                INNER JOIN CMSMQ b on a.TE001 =b.MQ001 
                                WHERE a.TE011=@WoErpPrefix
                                AND a.TE012 =@WoErpNo
                                AND a.TE027 =@MtlItemNo
                                AND a.TE019 ='Y'
                                Group by a.TE027";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);
                        dynamicParameters.Add("MtlItemNo", item.Split(',')[1]);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            Double NumSet = 0;
                            foreach (var item1 in result)
                            {
                                NumSet = Convert.ToDouble(item1.NumSet);
                            }
                            Double MaterialMtlItemNoNum = Convert.ToDouble(item.Split(',')[0]);
                            Double RatioOfMaterials = Math.Round(Convert.ToDouble(PlanQty / (MaterialMtlItemNoNum / NumSet)), 2);
                            RatioOfMaterials = RatioOfMaterials > 0 ? Math.Floor(RatioOfMaterials) : Math.Ceiling(RatioOfMaterials);
                            if (num == 0)
                            {
                                MakeNum = RatioOfMaterials;
                            }
                            else
                            {
                                //這段意思是 如果該品號是多種材料組成的 會以 可領的最小套數當最大套數
                                if (MakeNum > RatioOfMaterials)
                                {
                                    MakeNum = RatioOfMaterials;
                                }
                            }
                            num++;
                        }
                        else
                        {
                            #region //判斷入庫數是否有超過領料套數
                            switch (PickingListOutSet)
                            {
                                case "Y":
                                    WarnMessage += "【入庫單】－材料:" + item.Split(',')[1] + "未領取,不能入庫<br>";
                                    break;
                            }
                            #endregion
                        }

                    }
                    if (WarnMessage != "") throw new SystemException(WarnMessage);

                    #endregion

                    #region //ERP撈出該製令下已入庫產品數量(核單)
                    int EnterNum = 0;
                    int PassNum = 0;
                    int NgQtyErp = 0;
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ISNULL(sum(TI007),0) TINUM,ISNULL(sum(TI019),0) TINUM1, ISNULL(sum(TI021),0) TINUM2
                            FROM MOCTI 
                            WHERE TI013=@WoErpPrefix
                            AND TI014 =@WoErpNo
                            AND TI001 != '5902'
                            AND TI037 ='Y'";
                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                    dynamicParameters.Add("WoErpNo", WoErpNo);
                    var result1 = sqlConnection.Query(sql, dynamicParameters);
                    if (result1.Count() <= 0) throw new SystemException("工單製令有問題!");
                    foreach (var item in result1)
                    {
                        EnterNum = Convert.ToInt32(item.TINUM);
                        PassNum = Convert.ToInt32(item.TINUM1);
                        NgQtyErp = Convert.ToInt32(item.TINUM2);
                    }
                    #endregion


                    // PlanQty預計產量 ,MakeNum目前可生產最大套數, Purchase可進貨數 ,noMakeNum未生產數 ,EnterNum已入倉庫數 , nowPassNum目前可進貨數, nowNgQty目前可報廢數, TotalInputQty已生產套數, TotalPassQty已生產良品數, TotalScrapQty全部報廢數(MES)
                    #endregion

                    int nowPassNum = 0;
                    int nowNgQty = 0;
                    int noMakeNum = 0;
                    int Purchase = 0;

                    #region //ERP撈出該製令下已入庫產品數量(有單據)(未核+有核)
                    int EnterNumAll = 0;
                    int PassNumAll = 0;
                    int NgQtyErpAll = 0;
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ISNULL(sum(TI007),0) TINUM,ISNULL(sum(TI019),0) TINUM1, ISNULL(sum(TI021),0) TINUM2
                                FROM MOCTI 
                                WHERE TI013=@WoErpPrefix
                                AND TI014 =@WoErpNo
                                AND TI001 != '5902'
                                AND TI037 in ('Y','N')";
                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                    dynamicParameters.Add("WoErpNo", WoErpNo);
                    result1 = sqlConnection.Query(sql, dynamicParameters);
                    if (result1.Count() <= 0) throw new SystemException("工單製令有問題!");
                    foreach (var item in result1)
                    {
                        EnterNumAll = Convert.ToInt32(item.TINUM);
                        PassNumAll = Convert.ToInt32(item.TINUM1);
                        NgQtyErpAll = Convert.ToInt32(item.TINUM2);
                    }
                    //if(EnterNumAll != ReceiptQty) throw new SystemException("MES 於ERP 兩邊進貨數量不一致");
                    #endregion

                    if (MweErpPrefix == "5903" && AllOutsourcing == "Y")
                    {
                        nowPassNum = 0;                  //5903由人員自行維護
                        nowNgQty = 0;                   //5903由人員自行維護
                        noMakeNum = PlanQty - Convert.ToInt32(MakeNum);     //未生產數   = 計畫數 - 可生產最高套數(領料數)
                        Purchase = Convert.ToInt32(MakeNum) - EnterNumAll;   //可進貨數   = 可生產最高套數(領料數) - 已入庫數
                    }
                    else
                    {
                        if (BarcodeCtrl == "N" && OutputBarcodeFlag == "N")
                        {
                            nowPassNum = TotalPassQty - AllAcceptQty;                  //可以驗收數 = 總良品數 - MES已入庫良品數
                            nowNgQty = TotalScrapQty - AllScrapQty;                   //可以報廢數 = 總報廢數 - MES已入庫報廢數 
                            noMakeNum = PlanQty - Convert.ToInt32(MakeNum);     //未生產數   = 計畫數 - 可生產最高套數(領料數)
                            Purchase = Convert.ToInt32(MakeNum) - ReceiptQtyERP;   //可進貨數   = 可生產最高套數(領料數) - 已入庫數
                        }
                        else
                        {
                            nowPassNum = TotalPassQty;                  //可以驗收數 = 總良品數 - MES已入庫良品數
                            nowNgQty = TotalScrapQty;                   //可以報廢數 = 總報廢數 - MES已入庫報廢數 
                            noMakeNum = PlanQty - Convert.ToInt32(MakeNum);     //未生產數   = 計畫數 - 可生產最高套數(領料數)
                            Purchase = Convert.ToInt32(MakeNum) - ReceiptQtyERP;   //可進貨數   = 可生產最高套數(領料數) - 已入庫數
                        }
                    }


                    if (ConfirmStatus != "Y")
                    {
                        //if (PlanQty == ReceiptQty) throw new SystemException("製令【" + WoErpPrefix + "-" + WoErpNo + "】的產品已經全數入庫");
                        //if (nowPassNum <= 0) throw new SystemException("領量單不足,製令【" + WoErpPrefix + "-" + WoErpNo + "】目前可以進貨數0");
                    }

                    string[] numArr = { PlanQty.ToString(), Purchase.ToString(), noMakeNum.ToString(), ReceiptQty.ToString(), nowPassNum.ToString(), nowNgQty.ToString(), WarnMessage, LotManagement, EfficientDays, RetestDays, ModeId.ToString() };

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = numArr
                    });
                    #endregion

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckMoIdDateQa-- 檢查每日入庫型的製令品質判定結果-- Shintokuro 2024-09-09
        public string GetCheckMoIdDateQa(int MweId, int MoId, string LotNumber, string CheckMode)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("缺少MES製令ID!!!");
                if (LotNumber.Length <= 0) throw new SystemException("缺少批號!!!");

                string CheckResult = ""; // Y:可以入庫良品,N:入庫報廢品,A:採用一般入庫模式,S:不能執行入庫
                string CheckMsg = "";
                string CheckQty = "";
                string QcTypeName = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷該製令是否需要每日檢驗才能入庫
                    string CheckStatus = "";
                    string QcDocDate = "";
                    string BarcodeCtrl = "";
                    string LotManagement = "";
                    string FullPassQcFlag = "";
                    int? QcRecordId = -1;
                    int? QcTypeId = -1;
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a1.BarcodeCtrl, a1.FullPassQcFlag,a3.LotManagement,c.ModeName,b.QcTypeNo,b.QcTypeName,b.QcTypeId,x.QcRecordId,x.CheckStatus,x.QcDocDate
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.MoSetting a1 on a.MoId = a1.MoId
                            INNER JOIN MES.WipOrder a2 on a.WoId = a2.WoId
                            INNER JOIN PDM.MtlItem a3 on a2.MtlItemId = a3.MtlItemId
                            INNER JOIN QMS.QcType b on a.ModeId = b.ModeId
                            INNEr JOIN MES.ProdMode c on b.ModeId = c.ModeId
                            OUTER APPLY(
                                SELECT TOP 1 x1.QcRecordId,x1.QcStatus CheckStatus,FORMAT(x1.CreateDate, 'yyyy-MM-dd') QcDocDate
                                FROM MES.QcRecord x1
                                INNER JOIN QMS.QcMeasureData x2 on x1.QcRecordId = x2.QcRecordId
                                WHERE x1.QcTypeId = b.QcTypeId
                                AND x1.MoId = a.MoId
                                AND x2.LotNumber = @LotNumber
                                ORDER BY x1.QcRecordId DESC
                            ) x
                            WHERE a.MoId = @MoId
                            AND b.DailyInspection ='Y'";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("LotNumber", LotNumber);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        foreach (var item in result)
                        {
                            BarcodeCtrl = item.BarcodeCtrl;
                            FullPassQcFlag = item.FullPassQcFlag;
                            LotManagement = item.LotManagement;
                            QcTypeId = item.QcTypeId;
                            QcTypeName = item.QcTypeName;
                            QcRecordId = item.QcRecordId;
                            CheckStatus = item.CheckStatus;
                            QcDocDate = item.QcDocDate;

                            if (LotManagement != "N")
                            {
                                if (LotNumber.Length <= 0) throw new SystemException("缺少批號!!!");
                            }

                            if (FullPassQcFlag == "Y")
                            {
                                if (QcRecordId > 0) //有量測單據
                                {
                                    switch (CheckStatus)
                                    {
                                        case "P":
                                            CheckResult = "Y";
                                            CheckMsg = "【" + QcTypeName + @"】的量測檢驗判定良品，可以入庫良品數量";
                                            break;
                                        case "F":
                                            string JudgeStatus = "";
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT ISNULL(a.JudgeStatus, 'N') JudgeStatus
                                                FROM QMS.AqBarcode a 
                                                WHERE a.QcRecordId = @QcRecordId";
                                            dynamicParameters.Add("QcRecordId", QcRecordId);
                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() > 0)
                                            {
                                                foreach (var item1 in result)
                                                {
                                                    JudgeStatus = item1.JudgeStatus;
                                                }
                                                switch (JudgeStatus)
                                                {
                                                    case "R":
                                                        CheckResult = "Y";
                                                        CheckMsg = "【" + QcTypeName + @"】的量測檢驗判定不良品，品異判定特採，可以入庫良品數量";
                                                        break;
                                                    case "S":
                                                        CheckResult = "N";
                                                        CheckMsg = "【" + QcTypeName + @"】的量測檢驗判定不良品，品異判定報廢，須入庫報廢數量";
                                                        break;
                                                    case "N":
                                                        CheckResult = "S";
                                                        CheckMsg = "【" + QcTypeName + @"】的量測檢驗判定不良品，品異尚未判定，不能執行入庫";
                                                        break;
                                                    case "AM":
                                                        CheckResult = "S";
                                                        CheckMsg = "【" + QcTypeName + @"】的量測檢驗判定不良品，品異判定重新量測，不能執行入庫";
                                                        break;
                                                }
                                            }
                                            else
                                            {
                                                CheckResult = "S";
                                                CheckMsg = "【" + QcTypeName + @"】的量測檢驗數據為不良，但品異單未開立，請確認量測資料是否有執行品異流程判定!!";
                                            }
                                            break;
                                        case "N":
                                            CheckResult = "S";
                                            CheckMsg = "【" + QcTypeName + @"】的量測檢驗尚未判定，不能入庫";
                                            break;
                                        case "R":
                                            CheckResult = "S";
                                            CheckMsg = "【" + QcTypeName + @"】的量測檢驗判定需補正，該判定尚無規劃請洽系統開發室";
                                            break;
                                    }
                                }
                                else //無量測單據
                                {
                                    CheckResult = "S";

                                    CheckMsg = "本次入庫採用批號【" + LotNumber + "】尚未做【" + QcTypeName + @"】的量測檢驗，不能入庫";
                                }

                                //if (QcTypeId == 1034) //成形-全吋檢
                                //{
                                //    DateTime parsedTestDay = DateTime.Parse(QcDocDate);

                                //    // 計算加上 30 天的日期
                                //    DateTime testDayPlus30 = parsedTestDay.AddDays(30);

                                //    // 取得今天的日期
                                //    DateTime today = DateTime.Today;

                                //    // 比較是否小於今天
                                //    if (testDayPlus30 < today)
                                //    {
                                //        CheckResult = "S";
                                //        CheckMsg = "【" + QcTypeName + @"】的量測檢驗已超過30天，不能入庫";
                                //        break;
                                //    }
                                //    else
                                //    {
                                //        //判斷批號有沒有綁定入庫單
                                //        //有=>代表當時用 全吋入或是全吋+工程檢入
                                //        //沒有=>
                                //        CheckResult = "Y";
                                //        CheckMsg = "【" + QcTypeName + @"】的量測檢驗判定良品，可以入庫良品數量";
                                //    }
                                //}
                            }
                            else
                            {
                                CheckResult = "A";
                                CheckMsg = "該製令入庫採用一般入庫檢核模式";
                                break;
                            }
                        }
                    }
                    else
                    {
                        CheckResult = "A";
                        CheckMsg = "該製令入庫採用一般入庫檢核模式";
                    }
                    #endregion

                    string[] checkResult = { CheckResult.ToString(), CheckMsg.ToString(), CheckQty.ToString(), QcRecordId.ToString() };

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = checkResult
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckBarcode -- 檢查產品入庫的產品條碼(刷取用) -- Ted 2022-09-13
        public string GetCheckBarcode(int MoId, string BarcodeNo, int InventoryId, string BarcodeType)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoId <= 0) throw new SystemException("缺少MES製令ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder a
                                WHERE a.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    if (BarcodeType != "Package")
                    {
                        dynamicParameters = new DynamicParameters();
                        string BarcodeNoOnTray = "";
                        sql = @"SELECT a.TrayNo,a.BarcodeNo
                                FROM MES.Tray a
                                WHERE a.TrayNo = @TrayNo";
                        dynamicParameters.Add("TrayNo", BarcodeNo);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                BarcodeNoOnTray = item.BarcodeNo;
                            }
                            BarcodeNo = BarcodeNoOnTray;
                        }

                        dynamicParameters = new DynamicParameters();
                        string BarcodeStatus = "";
                        sql = @"SELECT a.BarcodeId,a.BarcodeNo,a.CurrentProdStatus,a.BarcodeStatus
                                FROM MES.Barcode a
                                WHERE a.BarcodeNo = @BarcodeNo
                                AND a.MoId = MoId";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("MoId", MoId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("該製令下沒有這組條碼");
                        foreach (var item in result)
                        {
                            BarcodeStatus = item.BarcodeStatus;
                        }

                        if (BarcodeStatus == "0" || BarcodeStatus == "7")
                        {

                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            string CurrentProdStatus = "";
                            sql = @"SELECT a.BarcodeId,a.BarcodeNo,a.CurrentProdStatus,a.BarcodeStatus
                                    FROM MES.Barcode a
                                    INNER JOIN MES.MweBarcode b on a.BarcodeId = b.BarcodeId
                                    WHERE a.BarcodeNo = @BarcodeNo
                                    AND a.MoId = MoId";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("MoId", MoId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("該條碼未完工,不能入庫");
                            foreach (var item in result)
                            {
                                CurrentProdStatus = item.CurrentProdStatus;
                            }
                        }

                    }
                    else
                    {
                        dynamicParameters = new DynamicParameters();
                        string CurrentProdStatus = "";
                        sql = @"SELECT TOP 1 1 FROM MES.PackageBarcode a
                                INNER JOIN MES.MoProcess b on a.MoProcessId = b.MoProcessId
                                WHERE b.MoId = @MoId
                                AND a.PackageBarcodeNo = @PackageBarcodeNo";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("PackageBarcodeNo", BarcodeNo);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("該包裝條碼不存在,請重新確認!");

                    }



                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPackageBarcode -- 取得包裝條碼 -- Shintokuro 2023-05-17
        public string GetPackageBarcode(string PackageBarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (PackageBarcodeNo.Length <= 0) throw new SystemException("缺少包裝條碼,請重新確認!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.PackageBarcodeNo,c.BarcodeId,c.BarcodeNo,d.TrayNo FROM MES.PackageBarcode a
                            INNER JOIN MES.PackageBarcodeReference b on a.PackageBarcodeId = b.PackageBarcodeId
                            INNER JOIN MES.Barcode c on b.BarcodeId = c.BarcodeId
                            LEFT JOIN MES.Tray d on c.BarcodeNo = d.BarcodeNo
                            WHERE a.PackageBarcodeNo = @PackageBarcodeNo";
                    dynamicParameters.Add("PackageBarcodeNo", PackageBarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSupplierNo -- 取得加工廠商編號 -- Shintokuro 2023-01-19
        public string GetSupplierNo(int SupplierId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (SupplierId <= 0) throw new SystemException("找不到加工廠商ID,資料錯誤!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT TOP 1 SupplierNo
                            FROM SCM.Supplier a
                            WHERE a.SupplierId = @SupplierId";
                    dynamicParameters.Add("SupplierId", SupplierId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckMoIdType -- 檢查MES製令是否有條碼 -- Ted 2022-09-15
        public string GetCheckMoIdType(int MoId, int MweDetailId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoId <= 0) throw new SystemException("缺少MES製令ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();
                    string ConfirmStatus = "";
                    string BarcodeCtrl = "";
                    string OutputBarcodeFlag = "";
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ConfirmStatus
                            FROM MES.MweDetail a
                            WHERE a.MweDetailId = @MweDetailId";
                    dynamicParameters.Add("MweDetailId", MweDetailId);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    foreach (var item in result)
                    {
                        ConfirmStatus = item.ConfirmStatus;
                    }

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeCtrl, a.OutputBarcodeFlag
                            FROM MES.MoSetting a
                            WHERE a.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);
                    result = sqlConnection.Query(sql, dynamicParameters);
                    foreach (var item in result)
                    {
                        BarcodeCtrl = item.BarcodeCtrl;
                        OutputBarcodeFlag = item.OutputBarcodeFlag;
                    }

                    string[] setting = { ConfirmStatus.ToString(), BarcodeCtrl.ToString(), OutputBarcodeFlag.ToString() };

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = setting
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckScrapRegister -- 檢查MES製令是否報廢品是否要入報廢倉 -- Ted 2023-01-09
        public string GetCheckScrapRegister(int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoId <= 0) throw new SystemException("缺少MES製令ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT b.ScrapRegister,c1.MeasureType FROM MES.ManufactureOrder a
							INNER JOIN MES.ProdMode b on a.ModeId = b.ModeId
                            INNER JOIN MES.WipOrder c on a.WoId = c.WoId
                            INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
							WHERE a.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMweBarcode -- 取得入庫單條碼相關資料 -- Shintokuro 2022-11-28
        public string GetMweBarcode(int MweId, int MweDetailId, int MweBarcodeId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MweDetailId <= 0) throw new SystemException("缺少MES製令ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MweBarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",b.BarcodeId,b.BarcodeNo,b.BarcodeQty,a.MweBarcodeId";
                    sqlQuery.mainTables =
                        @"FROM MES.MweBarcode a
                          INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                          INNER JOIN MES.MweDetail c on a.MweDetailId = c.MweDetailId
                          INNER JOIN MES.MoSetting c1 on c.MoId = c1.MoId
                            ";
                    string queryTable = "";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @"AND a.MweDetailId = @MweDetailId AND c1.BarcodeCtrl = 'N'";
                    dynamicParameters.Add("MweDetailId", MweDetailId);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MweBarcodeId", @" AND a.MweBarcodeId = @MweBarcodeId", MweBarcodeId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MweBarcodeId ASC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    //-------------
                    //#region //判斷入庫單單身是否存在+撈取MoId
                    //sql = @"SELECT a.MoId,c.BarcodeNo,c.LotQty
                    //        FROM MES.MweDetail a
                    //        INNER JOIN MES.MwePrintBarcode c on a.MweDetailId = c.MweDetailId
                    //        WHERE a.MweDetailId = @MweDetailId";
                    //dynamicParameters.Add("MweDetailId", MweDetailId);

                    //var result = sqlConnection.Query(sql, dynamicParameters);
                    //if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到該入庫單身Id");
                    //#endregion


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMweBarcodeSetting -- 取得入庫單條碼設定 -- Shintokuro 2022-11-28
        public string GetMweBarcodeSetting(int MweDetailId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MweDetailId <= 0) throw new SystemException("缺少MES製令ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷入庫單單身是否存在+撈取MoId
                    sql = @"SELECT a.MoId,b.BarcodeNo
                            FROM MES.MweDetail a
                            INNER JOIN MES.Barcode b on a.MoId = b.MoId
                            WHERE a.MweDetailId = @MweDetailId";
                    dynamicParameters.Add("MweDetailId", MweDetailId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到該入庫單身Id");
                    int MoId = -1;
                    string BarcodeNo = "";
                    foreach (var item in result)
                    {
                        MoId = item.MoId;
                        BarcodeNo = item.BarcodeNo;
                    }
                    #endregion

                    if (BarcodeNo != null)
                    {
                        #region //撈取 前綴 + 後綴 + 流水號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT value FROM STRING_SPLIT(@BarcodeNo, '-')";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到該入庫單身Id");
                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetReConfirmStatus -- 檢查入庫單是否有反確認過 -- Shintokuro 2023-03-09
        public string GetReConfirmStatus(int MweId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MweId <= 0) throw new SystemException("缺少入庫單ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT ReConfirmStatus
                            FROM MES.MoWarehouseEnry a
                            WHERE a.MweId = @MweId";
                    dynamicParameters.Add("MweId", MweId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckoutStatus -- 檢查入庫單結帳碼 -- Shintokuro 2023-11-12
        public string GetCheckoutStatus(int MweId)
        {
            try
            {
                var ErpNo = "";
                string ErpDbName = "";
                string MweErpPrefix = "";
                string MweErpNo = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MweId <= 0) throw new SystemException("缺少入庫單ID!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                        ErpNo = item.ErpNo;
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT MweErpPrefix,MweErpNo
                            FROM MES.MoWarehouseEnry a
                            WHERE a.MweId = @MweId";
                    dynamicParameters.Add("MweId", MweId);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("找不到入庫單請重新確認!");

                    foreach (var item in result)
                    {
                        MweErpPrefix = item.MweErpPrefix;
                        MweErpNo = item.MweErpNo;
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();



                    #region //結帳碼判定
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TI038,a.TI041,a.TI018,b.MA013
                            FROM MOCTI a
                            OUTER APPLY(
                                SELECT MA013
                                FROM CMSMA 
                            ) b
                            WHERE a.TI001=@MweErpPrefix
                            AND a.TI002=@MweErpNo";
                    dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                    dynamicParameters.Add("MweErpNo", MweErpNo);
                    var resultCloseStatus = sqlConnection.Query(sql, dynamicParameters);
                    foreach (var item in resultCloseStatus)
                    {
                        if (item.TI038 == "Y") throw new SystemException("【入庫單】－單據目前已經結帳不可以異動!!!");
                        if (item.TI041 == "Y") throw new SystemException("【入庫單】－單據分錄碼已經產生不可以異動!!!");

                        string CloseDateBase = item.MA013;
                        string DocDateBase = item.TI018;
                        DateTime docDateBase;
                        DateTime closeDateBase;
                        if (DateTime.TryParseExact(DocDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out docDateBase) &&
                            DateTime.TryParseExact(CloseDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out closeDateBase))
                        {
                            int resultDate = DateTime.Compare(docDateBase, closeDateBase);

                            if (resultDate <= 0)
                            {
                                throw new SystemException("【入庫單】ERP已經結帳,不可以在異動【" + CloseDateBase + "】之前的單據");
                            }
                        }
                        else
                        {
                            throw new SystemException("日期字符串无效，无法比较");
                        }
                    }

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = resultCloseStatus
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeQty -- 取得條碼數量 -- Shintokuro 2023-03-09
        public string GetBarcodeQty(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (BarcodeNo.Length <= 0) throw new SystemException("缺少條碼,請重新確認!!!");

                    #region //確認是否為TrayNo
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeNo
                            FROM MES.Tray a 
                            WHERE a.TrayNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in TrayResult)
                    {
                        BarcodeNo = item.BarcodeNo;
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT BarcodeQty
                            FROM MES.Barcode a
                            WHERE a.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeStatusContent -- 取得條碼階段+狀態 -- Shinotkuro 2023-08-04
        public string GetBarcodeStatusContent(string Type, string StatusSchema)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (Type.Length <= 0) throw new SystemException("資料錯誤");
                    if (StatusSchema.Length <= 0) throw new SystemException("資料錯誤");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    switch (Type)
                    {
                        case "S":
                            sql = @"SELECT a.StatusNo,a.StatusName 
                                    FROM BAS.[Status] a
                                    WHERE a.StatusSchema = @StatusSchema";
                            dynamicParameters.Add("StatusSchema", StatusSchema);
                            break;
                        case "T":
                            sql = @"SELECT a.TypeNo,a.TypeName 
                                    FROM BAS.[Type] a 
                                    WHERE TypeSchema = @TypeSchema";
                            dynamicParameters.Add("TypeSchema", StatusSchema);
                            break;
                    }

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //取得拆併盤條碼資訊 -- GPai 20230509
        public string GetBarcodePrintInfo(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (BarcodeNo.Length <= 0) throw new SystemException("缺少條碼,請重新確認!!!");

                    #region //先確認是否為Tray條碼
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT BarcodeNo
                            FROM MES.Tray
                            WHERE TrayNo = @TrayNo";
                    dynamicParameters.Add("TrayNo", BarcodeNo);

                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in TrayResult)
                    {
                        BarcodeNo = item.BarcodeNo;
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.BarcodeId,a.BarcodeNo,b.MoSettingId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus, g.StatusName, b.MoId,b.LotStatus,b.LotQty,e.MtlItemNo ,(d.WoErpPrefix + '-' + d.WoErpNo)WoErpNo,
                                    b.BarcodePostfix,b.BarcodePrefix,f.ItemNo,f.ItemValue,a.CurrentMoProcessId,b.SequenceLen
                            FROM MES.Barcode a
                            INNER JOIN MES.MoSetting b ON b.MoId = a.MoId
                            INNER JOIN MES.ManufactureOrder c ON c.MoId = b.MoId
                            INNER JOIN MES.WipOrder d ON d.WoId = c.WoId
                            INNER JOIN PDM.MtlItem e ON e.MtlItemId = d.MtlItemId
						    LEFT JOIN MES.BarcodeAttribute f ON f.BarcodeId = a.BarcodeId
                            INNER JOIN BAS.[Status] g ON a.BarcodeStatus = g.StatusNo AND g.StatusSchema = 'Barcode.BarcodeStatus'
                            WHERE a.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("找不到條碼資訊! " + BarcodeNo);
                    if (result.First().CurrentProdStatus != "P") throw new SystemException("非良品條碼! " + BarcodeNo);
                    if (result.First().BarcodeStatus != "8") throw new SystemException("非良品條碼!(" + result.First().StatusName + ")");
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMergeLog 取得拆併歷史資料 --Gpai 20230511
        public string GetMergeLog(string WoErpNo, string FromBarcodeNo, string ToBarcodeNo, string MtlItemNo, string StartDate, string EndDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sqlQuery.mainKey = "a.LogId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",a.FromBarcodeId,(b.BarcodeNo)FromBarcodeNo, a.ToBarcodeId,(c.BarcodeNo)ToBarcodeNo,a.FromMoId,(f.WoErpPrefix + '-' + f.WoErpNo)FromWoErpNo,a.ToMoId,
                          (g.WoErpPrefix + '-' + g.WoErpNo)ToWoErpNo,h.MtlItemNo,b.CurrentProdStatus,a.MergeQty,(i.UserNo + ' ' + i.UserName)Merger,FORMAT (a.CreateDate, 'yyyy-MM-dd HH:MM:ss')CreateDate
                         ";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodeMergeLog a
                          INNER JOIN MES.Barcode b ON b.BarcodeId = a.FromBarcodeId
                          INNER JOIN MES.Barcode c ON c.BarcodeId = a.ToBarcodeId
                          INNER JOIN MES.ManufactureOrder d ON d.MoId = a.FromMoId
                          INNER JOIN MES.ManufactureOrder e ON e.MoId = a.ToMoId
                          INNER JOIN MES.WipOrder f ON f.WoId = d.WoId
                          INNER JOIN MES.WipOrder g ON g.WoId = e.WoId
                          INNER JOIN PDM.MtlItem h ON h.MtlItemId = f.MtlItemId
                          INNER JOIN BAS.[User] i on i.UserId = a.CreateBy
                         ";
                    string queryTable = "";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @"AND f.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpNo", @" AND(f.WoErpPrefix + '-' + f.WoErpNo) = @WoErpNo OR (g.WoErpPrefix + '-' + g.WoErpNo) = @WoErpNo", WoErpNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FromBarcodeNo", @" AND b.BarcodeNo = @FromBarcodeNo", FromBarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToBarcodeNo", @" AND  c.BarcodeNo = @ToBarcodeNo", ToBarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND h.MtlItemNo = @MtlItemNo", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.CreateDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.CreateDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMweDocInfo -- 取得入庫單DOC相關資料 -- GPAI 2024-11-22
        public string GetMweDocInfo(int MweId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //先取得單頭MES資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MweErpPrefix, a.MweErpNo
                                FROM MES.MoWarehouseEnry a 
                                WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var MrResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MrResult.Count() <= 0) throw new SystemException("MES領料單資料錯誤!!");

                        string MweErpPrefix = "";
                        string MweErpNo = "";
                        foreach (var item in MrResult)
                        {
                            MweErpPrefix = item.MweErpPrefix;
                            MweErpNo = item.MweErpNo;
                        }
                        #endregion

                        #region //取得ERP入庫單單頭 MOCTH
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.TH001)) TH001,  LTRIM(RTRIM(a.TH002)) TH002,  LTRIM(RTRIM(b.MQ002)) MQ002, a.TH005, a.TH006
                                , CASE WHEN LEN(LTRIM(RTRIM(a.TH029))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.TH029)) AS date), 'yyyy/MM/dd') ELSE '' END TH029
                                , CASE WHEN LEN(LTRIM(RTRIM(a.TH003))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.TH003)) AS date), 'yyyy/MM/dd') ELSE '' END TH003
                                , a.TH004, c.MB002, a.TH008, a.TH009, a.TH010, a.UDF01, a.TH018, a.TH019, a.TH021, a.TH022, a.TH027, a.TH020, a.TH031, a.TH032
                                , ( a.TH027 + a.TH020) CurrencyTotal, ( a.TH031 + a.TH032) LocalTotal, a.TH007, a.TH008, a.TH011, ISNULL(a.TH013, '')TH013, a.TH014
								, a.TH030, a.TH015, a.TH016, a.TH023, a.TH033, a.TH012, a.TH018, a.TH027
                                FROM MOCTH a
                                INNER JOIN CMSMQ b ON a.TH001 = b.MQ001
                                INNER JOIN CMSMB c ON a.TH004 = c.MB001
                                WHERE a.TH001 = @MweErpPrefix
                                AND a.TH002 = @MweErpNo";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        dynamicParameters.Add("MweErpNo", MweErpNo);

                        var mocthResult = sqlConnection2.Query(sql, dynamicParameters);
                        #endregion

                        #region //取得ERP入庫單單身 MOCTI
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.TI003)) Seq, LTRIM(RTRIM(a.TI004)) MtlItemNo, LTRIM(RTRIM(a.TI005)) MtlItemName, LTRIM(RTRIM(a.TI006)) MtlItemSpec
                                , a.TI007 Quantity, LTRIM(RTRIM(a.TI008)) UomNo, LTRIM(RTRIM(a.TI048)) Acute, a.TI019 AccertQty, a.TI021 ScrapQry, a.TI022 ReturnQty
                                , LTRIM(RTRIM(a.TI009)) InventoryNo, LTRIM(RTRIM(c.MC002)) InventoryName, a.TI024 UnitAmount, a.TI025 TotalAmount, a.TI026 DeduteAmount, a.TI027 FeeAmount
                                , LTRIM(RTRIM(a.TI013)) + '-' + LTRIM(RTRIM(a.TI014)) WoErpFullNo, LTRIM(RTRIM(a.TI040)) Remark, a.TI032 Project, a.TI020 AmountQty
								, CASE WHEN LEN(LTRIM(RTRIM(a.TI018))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.TI018)) AS date), 'yyyy/MM/dd') ELSE '' END TI018
								, LTRIM(RTRIM(a.TI010)) LotNo, a.TI035 Verify
                                ,(a.TI007 - a.TI019 - a.TI021) Inspec
                                , CASE WHEN (a.TI019) > (a.TI007) THEN ROUND((a.TI019 / a.TI007), 2)  ELSE 0.00 END OverRate, a.TI015
                                FROM MOCTI a 
                                INNER JOIN INVMB b ON a.TI004 = MB001
                                INNER JOIN CMSMC c ON a.TI009 = c.MC001
                                LEFT JOIN INVMC d ON a.TI004 = d.MC001 AND d.MC002 = a.TI009
                                WHERE TI001 = @MweErpPrefix
                                AND TI002 = @MweErpNo";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        dynamicParameters.Add("MweErpNo", MweErpNo);

                        var moctiResult = sqlConnection2.Query(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = mocthResult,
                            dataDetail = moctiResult
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPackageInBarcodes -- 取得包裝條碼下所有條碼 -- GPAI 2024-12-11
        public string GetPackageInBarcodes(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    //if (BarcodeNo.Length <= 0) throw new SystemException("缺少輸入資料,請重新確認!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeNo, a.BarcodeId
                                        FROM MES.Barcode a
                                        WHERE a.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                    var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                    if (BarcodeResult.Count() < 0) throw new SystemException("查無此條碼資訊!");
                    int BarcodeId = 0;
                    foreach (var item in BarcodeResult)
                    {
                        BarcodeId = item.BarcodeId;
                    }

                    dynamicParameters = new DynamicParameters();

                    sql = @"DECLARE @InputBarcode INT = @BarcodeId;
                            DECLARE @CurrentBarcode INT;
                            DECLARE @PrevBarcodeId INT;
                            
                            -- 建立表變量來存儲結果
                            DECLARE @BarcodeResults TABLE (
                                BarcodeId INT,
                                BarcodeNo NVARCHAR(100),
                                PrevBarcodeId INT,
                                BarcodeQty INT,
                                isLeaf NVARCHAR(100),
								MtlItemNo NVARCHAR(100),
								MtlItemName NVARCHAR(100)

                            );
                            
                            INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, PrevBarcodeId, BarcodeQty,isLeaf, MtlItemNo, MtlItemName)
                            SELECT 
                                a.BarcodeId,
                                a.BarcodeNo,
                                a.PrevBarcodeId,
                                a.BarcodeQty,
                                a.isLeaf,
									d.MtlItemNo,
									d.MtlItemName
                            FROM MES.Barcode a
							left JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
							left JOIN MES.WipOrder c ON b.WoId = c.WoId
							left JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId

                            WHERE a.BarcodeId = @InputBarcode;
                            
                            -- PrevBarcodeId
                            SET @PrevBarcodeId = (SELECT PrevBarcodeId FROM MES.Barcode WHERE BarcodeId = @InputBarcode);
                            
                            
                            
                            SET @CurrentBarcode = @InputBarcode;
                            
                            -- 向下查找下層條碼
                            WHILE @CurrentBarcode IS NOT NULL
                            BEGIN
                                -- 所有下層條碼
                                INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, PrevBarcodeId, BarcodeQty,isLeaf, MtlItemNo, MtlItemName)
                                SELECT 
                                    a.BarcodeId,
                                    a.BarcodeNo,
                                    a.PrevBarcodeId,
                                    a.BarcodeQty,
                                    a.isLeaf,
									d.MtlItemNo,
									d.MtlItemName
                                FROM MES.Barcode a
							left JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
							left JOIN MES.WipOrder c ON b.WoId = c.WoId
							left JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                WHERE a.PrevBarcodeId = @CurrentBarcode;
                            
                                SET @CurrentBarcode = (SELECT TOP 1 BarcodeId FROM MES.Barcode WHERE PrevBarcodeId = @CurrentBarcode);
                            
                                IF @CurrentBarcode IS NULL
                                    BREAK;
                            END
                            
                            -- 查同ParentBarcode其他條碼
                            INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, PrevBarcodeId, BarcodeQty,isLeaf, MtlItemNo, MtlItemName)
                            SELECT 
                                BarcodeId,
                                BarcodeNo,
                                PrevBarcodeId,
                                BarcodeQty,
                                isLeaf,
									d.MtlItemNo,
									d.MtlItemName
                                FROM MES.Barcode a
							left JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
							left JOIN MES.WipOrder c ON b.WoId = c.WoId
							left JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                            WHERE a.PrevBarcodeId = @PrevBarcodeId
                              AND a.BarcodeId <> @InputBarcode;  -- 排除查詢的條碼
                            
                            -- 顯示所有條碼資料
                            SELECT 
                                BarcodeId,
                                BarcodeNo,
                                PrevBarcodeId,
                                BarcodeQty,
                                isLeaf,
								MtlItemNo,
								MtlItemName
                            FROM @BarcodeResults
                            WHERE BarcodeId NOT IN (
							 SELECT PrevBarcodeId FROM @BarcodeResults WHERE PrevBarcodeId IS NOT NULL
							);";
                    dynamicParameters.Add("BarcodeId", BarcodeId);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetMaterialFeedingManagement  -- 取得投料记录  Jean 2025-06-03
        public string GetMaterialFeedingManagement(int MatFeedRegId, int MachineId, int MoId, string StartFeedDate, string EndFeedDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try

            {

                // StartFeedDate = DateTime.Parse(StartFeedDate).ToString("yyyyMMdd");
                //EndFeedDate = DateTime.Parse(EndFeedDate).ToString("yyyyMMdd");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MatFeedRegId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",a.MachineId,b.MachineNo,b.MachineName
                            ,a.MoId,e.WoErpPrefix+'-'+e.WoErpNo+'('+CAST(c.WoSeq AS VARCHAR(10))+')' WoErpPrefix
                            ,g.MtlItemNo WoErpMtlItemNo,g.MtlItemName WoErpMtlItemName
                            ,a.MaterialId,d.MtlItemNo,d.MtlItemName,d.MtlItemSpec
                            ,a.MatInRegQty,a.UomId,f.UomNo,f.UomName,a.Status,a.CreateDate,CONVERT(VARCHAR(10), a.FeedDate, 120)FeedDate
                            ,a.Remarks
                          ";
                    sqlQuery.mainTables =
                        @"FROM MES.MaterialFeedReg a
                            INNER JOIN MES.Machine b ON b.MachineId=a.MachineId
                            INNER JOIN MES.ManufactureOrder c ON c.MoId=a.MoId
                            INNER JOIN MES.WipOrder e ON e.WoId=c.WoId
                            INNER JOIN PDM.MtlItem d ON d.MtlItemId=a.MaterialId
                            INNER JOIN PDM.UnitOfMeasure f ON f.UomId=a.UomId
                            LEFT JOIN PDM.MtlItem g ON g.MtlItemId=e.MtlItemId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.Status='A'";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MatFeedRegId", @" AND a.MatFeedRegId= @MatFeedRegId", MatFeedRegId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineId", @" AND a.MachineId= @MachineId", MachineId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId =@MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartFeedDate", @" AND CONVERT(VARCHAR(10), a.FeedDate, 120) >= @StartFeedDate", StartFeedDate);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndFeedDate", @" AND CONVERT(VARCHAR(10), a.FeedDate, 120) <= @EndFeedDate", EndFeedDate);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MatFeedRegId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;
                    //sqlQuery.distinct = true;


                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachine 取得晶彩機台資訊
        public string GetMachine(int MachineId)
        {
            try
            {
                // if (MachineId == -1) throw new Exception("MachineId不可為空");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.MachineId, a.ShopId,a.MachineNo, a.MachineName, a.MachineDesc ,'('+CAST(a.MachineId AS VARCHAR(10))+')'+ ' '+ a.MachineNo+ ' '+ a.MachineName MachinePix
                            FROM MES.Machine a
                            WHERE 1=1 AND Status='A' AND a.MachineNo LIKE 'J%' ";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineId", @" AND a.MachineId = @MachineId", MachineId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetMaterialInputStatisticsReport -- 投料统计表 -- Jean 2025.07.15
        public string GetMaterialInputStatisticsReport(string WoErpPrefix, string WoErpMtlItemName, string MtlItemNo, string StartDate, string EndDate, string FilterType
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                string MESCompanyNo = "";
                string ErpDb = "";

                List<ERPWipOrders> erpWipOrders = new List<ERPWipOrders>();
                List<MatFeedRegs> matFeedRegs = new List<MatFeedRegs>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        MESCompanyNo = item.ErpNo;
                        ErpDb = item.ErpDb;
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(MainConnectionStrings))
                    {
                        
                        #region //撈取投料登记资料
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "x.MoId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @",x.WoErpPrefix,x.WoErpPre,x.WoErpNo
                                ,x.WoErpMtlItemNo,x.WoErpMtlItemName,x.WoErpMtlItemSpec
                                ,x.MaterialId,x.MtlItemNo,x.MtlItemName,x.CreateDate
                                ,x.DemandRequisitionQty,x.RequisitionQty
                                ,x.SUMMatInRegQty
                                ,CASE WHEN x.SUMMatInRegQty >= x.DemandRequisitionQty THEN ROUND(x.SUMMatInRegQty-x.DemandRequisitionQty,3) ELSE 0 END AS CLQty
                                ,CASE WHEN x.RequisitionQty >= x.SUMMatInRegQty THEN ROUND(x.RequisitionQty-x.SUMMatInRegQty,3) ELSE 0 END AS WSYQty
                                ,x.WoStatus
                              ";
                        sqlQuery.mainTables =
                            @"FROM(
	                                SELECT a.MoId,e.WoErpPrefix+'-'+e.WoErpNo+'('+CAST(c.WoSeq AS VARCHAR(10))+')' WoErpPrefix,e.WoErpPrefix WoErpPre,e.WoErpNo
	                                ,g.MtlItemNo WoErpMtlItemNo,g.MtlItemName WoErpMtlItemName,g.MtlItemSpec WoErpMtlItemSpec
	                                ,a.MaterialId,d.MtlItemNo,d.MtlItemName,d.MtlItemSpec,e.CreateDate
	                                ,f.DemandRequisitionQty,f.RequisitionQty
	                                ,sum(ROUND(a.MatInRegQty,1))SUMMatInRegQty
                                    ,e.WoStatus
	                                FROM MES.MaterialFeedReg a
	                                INNER JOIN MES.Machine b ON b.MachineId=a.MachineId
	                                INNER JOIN MES.ManufactureOrder c ON c.MoId=a.MoId
	                                INNER JOIN MES.WipOrder e ON e.WoId=c.WoId
	                                INNER JOIN PDM.MtlItem d ON d.MtlItemId=a.MaterialId
	                                LEFT JOIN PDM.MtlItem g ON g.MtlItemId=e.MtlItemId
	                                INNER JOIN MES.WoDetail f ON f.WoId=e.WoId
	                                WHERE 1=1
	                                GROUP BY a.MoId,e.WoErpPrefix,e.WoErpNo,g.MtlItemNo,g.MtlItemName,g.MtlItemSpec,a.MaterialId,d.MtlItemNo,d.MtlItemName,d.MtlItemSpec,c.WoSeq,e.CreateDate,f.DemandRequisitionQty,f.RequisitionQty,e.WoStatus
                                )x ";
                        sqlQuery.auxTables = "";
                        string queryCondition = @" ";
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpPrefix", @" AND x.WoErpPrefix = @WoErpPrefix", WoErpPrefix);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpMtlItemName", @" AND x.WoErpMtlItemName like '%' + @WoErpMtlItemName + '%'", WoErpMtlItemName);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND x.MtlItemNo = @MtlItemNo", MtlItemNo);

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND x.CreateDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00.000") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND x.CreateDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59.999") : "");

                        // 添加 FilterType 参数处理
                        if (!string.IsNullOrEmpty(FilterType) && FilterType == "over")
                        {
                            queryCondition += @" AND x.SUMMatInRegQty > x.DemandRequisitionQty ";
                        }
                        else if (!string.IsNullOrEmpty(FilterType) && FilterType == "unfinished")
                        {
                            queryCondition += @" AND x.RequisitionQty < x.DemandRequisitionQty ";
                        }
                        else if (!string.IsNullOrEmpty(FilterType) && FilterType == "overNoOrder")
                        {
                            queryCondition += @" AND x.SUMMatInRegQty > x.DemandRequisitionQty AND x.DemandRequisitionQty = x.RequisitionQty ";
                        }
                        else if (!string.IsNullOrEmpty(FilterType) && FilterType == "noReturn")
                        {
                            queryCondition += @" AND x.WoStatus IN('y','Y') AND x.RequisitionQty > x.SUMMatInRegQty ";
                        }
                        else if (!string.IsNullOrEmpty(FilterType) && FilterType == "notFullyInput")
                        {
                            queryCondition += @" AND x.RequisitionQty > x.SUMMatInRegQty ";
                        }

                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "x.MoId DESC ";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;
                        //sqlQuery.distinct = true;

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);


                        #endregion
                        

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion

        #region //Add
        #region //AddMaterialRequisition -- 新增領退料單資料 -- Ann 2022-08-17
        public string AddMaterialRequisition(string RequesitionNo, string MrErpPrefix, string MrDate, string DocDate, string DocType, string Remark, string JournalStatus
            , string SignupStatus, string SourceType, string PriorityType, string NegativeStatus, string ProductionLine, string ContractManufacturer)
        {
            try
            {
                int UserId = CreateBy;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            if (RequesitionNo.Length < 0) throw new SystemException("【MES領退料單號】不能為空!");
                            if (MrErpPrefix.Length < 0) throw new SystemException("【ERP領退料單別】不能為空!");
                            if (MrErpPrefix.Length > 4) throw new SystemException("【ERP領退料單別】長度錯誤!");
                            if (MrDate.Length < 0) throw new SystemException("【領退料日期】不能為空!");
                            if (DocDate.Length < 0) throw new SystemException("【單據建立日期】不能為空!");
                            if (DocType.Length < 0) throw new SystemException("【單據性質】不能為空!");
                            if (JournalStatus.Length <= 0) throw new SystemException("【產生分錄碼】不能為空!");
                            if (SignupStatus.Length <= 0) throw new SystemException("【簽核狀態碼】不能為空!");
                            if (SourceType.Length <= 0) throw new SystemException("【來源別】不能為空!");
                            if (PriorityType.Length <= 0) throw new SystemException("【需再確認邏輯】不能為空!");
                            if (NegativeStatus.Length <= 0) throw new SystemException("【庫存不足照領】不能為空!");
                            //if (ProductionLine.Length <= 0) throw new SystemException("【生產線別】不能為空!");
                            if ((DocType != "55" && DocType != "57") && ContractManufacturer.Length > 0) throw new SystemException("非託外單別無法填入加工廠商!!");

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(DocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + DocDate + ")之單據!!");
                            }
                            #endregion

                            #region //判斷 公司+MES領料單號 是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MaterialRequisition
                                    WHERE CompanyId = @CompanyId
                                    AND RequesitionNo = @RequesitionNo";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("RequesitionNo", RequesitionNo);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0) throw new SystemException("【公司 + MES領料單號】重複，請重新輸入!");

                            string MrErpNo = BaseHelper.RandomCode(11);
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "MaterialRequisition");
                            dynamicParameters.Add("DetailCode", "add");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MaterialRequisition (CompanyId, RequesitionNo, MrErpPrefix, MrErpNo, MrDate
                                    , DocDate, DocType, ProductionLine, Remark, JournalStatus, PriorityType, NegativeStatus, SignupStatus
                                    , SourceType, ConfirmStatus, ContractManufacturer
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MrId, INSERTED.MrErpPrefix, INSERTED.MrErpNo, INSERTED.CreateBy, INSERTED.CompanyId
                                    VALUES (@CompanyId, @RequesitionNo, @MrErpPrefix, @MrErpNo, @MrDate
                                    , @DocDate, @DocType, @ProductionLine, @Remark, @JournalStatus, @PriorityType, @NegativeStatus, @SignupStatus
                                    , @SourceType, @ConfirmStatus, @ContractManufacturer
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    CompanyId = CurrentCompany,
                                    RequesitionNo,
                                    MrErpPrefix,
                                    MrErpNo,
                                    MrDate,
                                    DocDate,
                                    DocType,
                                    ProductionLine,
                                    Remark,
                                    JournalStatus,
                                    PriorityType,
                                    NegativeStatus,
                                    SignupStatus,
                                    SourceType,
                                    ConfirmStatus = "N",
                                    ContractManufacturer,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            int rowsAffected = insertResult.Count();

                            foreach (var item in insertResult)
                            {
                                if (BaseHelper.CheckUserAuthority(item.CreateBy, item.CompanyId, "A", "MaterialRequisition", "add", sqlConnection).Equals("N")) throw new SystemException("人員權限檢核有異常，請嘗試重新登入!");
                            }

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)",
                                data = insertResult
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMrWipOrder -- 新增領退料單設定資料(MrWipOrder + MrDetail) -- Ann 2022-08-22
        public string AddMrWipOrder(int MrId, int MoId, string WoErpPrefix, string WoErpNo, string MrType, double Quantity, int InventoryId, string RequisitionCode, string NegativeStatus, string Remark
            , string MaterialCategory, string SubinventoryType, string LineSeq, int UomId)
        {
            try
            {
                if (WoErpPrefix.Length < 0) throw new SystemException("【製令單別】不能為空!");
                if (WoErpPrefix.Length > 4) throw new SystemException("【製令單別】長度錯誤!");
                if (WoErpNo.Length < 0) throw new SystemException("【製令單號】不能為空!");
                if (WoErpNo.Length > 11) throw new SystemException("【製令單號】長度錯誤!");
                if (MrType.Length < 0) throw new SystemException("【領料方式】長度錯誤!");
                if (Quantity < 0) throw new SystemException("【領退料套數】不能小於0!");
                if (RequisitionCode.Length < 0) throw new SystemException("【領料碼】不能為空!");
                if (NegativeStatus.Length < 0) throw new SystemException("【庫存不足照領】不能為空!");
                if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                if (MaterialCategory.Length < 0) throw new SystemException("【材料型態】不能為空!");
                if (SubinventoryType.Length < 0) throw new SystemException("【庫別型態】不能為空!");
                if (SubinventoryType.Length < 0) throw new SystemException("【輸入序號】不能為空!");
                if (SubinventoryType.Length > 4) throw new SystemException("【輸入序號】長度錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MrDate, ConfirmStatus, MrErpPrefix, MrErpNo
                                    FROM MES.MaterialRequisition
                                    WHERE CompanyId = @CompanyId
                                    AND MrId = @MrId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料有誤!");

                            DateTime MrDate = new DateTime();
                            string MrErpPrefix = "";
                            string MrErpNo = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單已確認，無法更改!");
                                MrDate = item.MrDate;
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                            }
                            #endregion

                            #region //查詢單據類別設定資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MQ010, LTRIM(RTRIM(a.MQ019)) MQ019, LTRIM(RTRIM(a.MQ054)) MQ054
                                    FROM CMSMQ a 
                                    WHERE MQ001 = @MrErpPrefix";
                            dynamicParameters.Add("MrErpPrefix", MrErpPrefix);

                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP單別資料有誤!!");

                            int MQ010 = -1;
                            string CheckMoFlag = "";
                            string ExcessFlag = "";
                            foreach (var item in CMSMQResult)
                            {
                                MQ010 = Convert.ToInt32(item.MQ010);
                                CheckMoFlag = item.MQ019;
                                ExcessFlag = item.MQ054;
                                if (ExcessFlag == "N" && Remark == "") throw new SystemException("超領單別備註不可為空!!");
                            }
                            #endregion

                            #region //確認製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.Quantity
                                    FROM MES.ManufactureOrder a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            if (ManufactureOrderResult.Count() <= 0) throw new SystemException("製令資料錯誤!!");

                            int MoQuantity = 0;
                            foreach (var item in ManufactureOrderResult)
                            {
                                //if (Quantity > item.Quantity) throw new SystemException("領取套數不能大於此製令預計生產數(" + item.Quantity + ")!!");
                                MoQuantity = item.Quantity;
                            }
                            #endregion

                            #region //查詢ERP製令資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TA015 PlanQty, a.TA016 RequisitionSetQty
                                    , a.TA017 StockInQty, a.TA018 ScrapQty, FORMAT(CONVERT(DATETIME, LTRIM(RTRIM(a.TA014))), 'yyyy-MM-dd') ActualEnd
                                    FROM MOCTA a
                                    WHERE a.TA001 = @WoErpPrefix
                                    AND a.TA002 = @WoErpNo";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);

                            var ErpWoInfoResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (ErpWoInfoResult.Count() <= 0) throw new SystemException("ERP製令(MOCTA)資料有誤!");

                            double PlanQty = -1;
                            double RequisitionSetQty = -1;
                            double StockInQty = -1;
                            string ActualEnd = "";
                            double ScrapQty = -1;
                            foreach (var item in ErpWoInfoResult)
                            {
                                PlanQty = Convert.ToDouble(item.PlanQty);
                                RequisitionSetQty = Convert.ToDouble(item.RequisitionSetQty);
                                StockInQty = Convert.ToDouble(item.StockInQty);
                                ActualEnd = item.ActualEnd;
                                ScrapQty = Convert.ToDouble(item.ScrapQty);
                            }
                            #endregion

                            #region //搜尋此製令所有領料單資訊，並找出實際已核單領料套數
                            double ErpQuantity = 0;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MrErpPrefix, b.MrErpNo
                                    , c.Quantity
                                    , d.WoErpPrefix, d.WoErpNo
                                    FROM MES.MrWipOrder a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                    INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrWipOrderResult.Count() > 0)
                            {
                                foreach (var item2 in MrWipOrderResult)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TD006 Quantity
                                            , b.MQ010
                                            , (
                                                SELECT TOP 1 1
                                                FROM MOCTE x
                                                WHERE x.TE001 = a.TD001
                                                AND x.TE002 = a.TD002
                                                AND x.TE019 = 'Y'
                                            ) CheckConfirm
                                            FROM MOCTD a
                                            INNER JOIN CMSMQ b ON a.TD001 = b.MQ001
                                            WHERE a.TD001 = @MrErpPrefix
                                            AND a.TD002 = @MrErpNo
                                            AND a.TD003 = @WoErpPrefix
                                            AND a.TD004 = @WoErpNo";
                                    dynamicParameters.Add("MrErpPrefix", item2.MrErpPrefix);
                                    dynamicParameters.Add("MrErpNo", item2.MrErpNo);
                                    dynamicParameters.Add("WoErpPrefix", item2.WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", item2.WoErpNo);

                                    var ErpMrWipOrderResult = sqlConnection2.Query(sql, dynamicParameters);

                                    foreach (var item3 in ErpMrWipOrderResult)
                                    {
                                        if (item3.CheckConfirm != null)
                                        {
                                            if (item3.MQ010 > 0)
                                            {
                                                ErpQuantity -= Convert.ToDouble(item3.Quantity);
                                            }
                                            else
                                            {
                                                ErpQuantity += Convert.ToDouble(item3.Quantity);
                                            }
                                        }
                                    }
                                }
                            }
                            #endregion

                            #region //判斷是否超領/超退
                            if (ExcessFlag == "Y")
                            {
                                if (MQ010 < 0) //領料
                                {
                                    if (Quantity > (MoQuantity - ErpQuantity) && ExcessFlag == "Y") throw new SystemException("領取數量超過未領用量(" + (MoQuantity - ErpQuantity).ToString() + ")!");
                                }
                                else if (MQ010 > 0) //退料
                                {
                                    if (ErpQuantity != 0 && MrType != "5")
                                    {
                                        //超退套數檢核公式: 本次退套數 MOCTD.TD006 > 已領套數 MOCTA.TA016 - ( 已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018)
                                        ErpQuantity = ErpQuantity - StockInQty - ScrapQty;
                                        if (Quantity > ErpQuantity) throw new SystemException("退料數量超過剩餘已領套數(" + ErpQuantity.ToString() + ")!");
                                    }
                                }
                                else
                                {
                                    throw new SystemException("此領料單別(" + MrErpPrefix + ")設定資料有誤，請通知開發人員!!");
                                }
                            }
                            #endregion

                            #region //判斷庫別資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 InventoryNo
                                    FROM SCM.Inventory
                                    WHERE InventoryId = @InventoryId";
                            dynamicParameters.Add("InventoryId", InventoryId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("庫別資料有誤!");

                            string InventoryNo = "";
                            foreach (var item in result3)
                            {
                                InventoryNo = item.InventoryNo;
                            }
                            #endregion

                            #region //判斷 領退料單 + MES製令 + 領退料方式 是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrWipOrder
                                    WHERE MrId = @MrId
                                    AND MoId = @MoId
                                    AND MrType = @MrType";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("MrType", MrType);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() > 0) throw new SystemException("【領退料單 + MES製令 + 領退料方式】重複，請重新輸入!");
                            #endregion

                            #region //判斷單位資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT UomNo
                                    FROM PDM.UnitOfMeasure
                                    WHERE UomId = @UomId";
                            dynamicParameters.Add("UomId", UomId);

                            var uomResult = sqlConnection.Query(sql, dynamicParameters);
                            if (uomResult.Count() <= 0) throw new SystemException("單位資料有誤!");

                            string UomNo = "";
                            foreach (var item in uomResult)
                            {
                                UomNo = item.UomNo;
                            }
                            #endregion

                            #region //新增MES.MrWipOrder
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MrWipOrder (MrId, MoId, WoErpPrefix, WoErpNo, MrType, Quantity
                                    , InventoryId, SubInventoryCode, RequisitionCode, NegativeStatus, Remark
                                    , MaterialCategory, SubinventoryType, LineSeq, UomId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MrId, INSERTED.MoId
                                    VALUES (@MrId, @MoId, @WoErpPrefix, @WoErpNo, @MrType, @Quantity
                                    , @InventoryId, @SubInventoryCode, @RequisitionCode, @NegativeStatus, @Remark
                                    , @MaterialCategory, @SubinventoryType, @LineSeq, @UomId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MrId,
                                    MoId,
                                    WoErpPrefix,
                                    WoErpNo,
                                    MrType,
                                    Quantity,
                                    InventoryId,
                                    SubInventoryCode = InventoryNo,
                                    RequisitionCode,
                                    NegativeStatus,
                                    Remark,
                                    MaterialCategory,
                                    SubinventoryType,
                                    LineSeq,
                                    UomId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            int rowsAffected = insertResult.Count();
                            #endregion

                            #region //新增MES.MrDetail

                            #region //確認沒有條碼已開工
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss')  BarcodeCreateDate
                                    FROM MES.MrBarcodeRegister a 
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrId = @MrId
                                    AND b.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            var MrBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in MrBarcodeResult)
                            {
                                #region //比對條碼歷程時間判斷是否為舊條碼
                                DateTime BarcodeCreateDate = Convert.ToDateTime(item.BarcodeCreateDate);
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 b.FinishDate
                                        FROM MES.Barcode a
                                        INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId
                                        WHERE a.BarcodeNo = @BarcodeNo
                                        AND b.MoId = @MoId
                                        ORDER BY FinishDate DESC";
                                dynamicParameters.Add("BarcodeNo", item.BarcodeNo);
                                dynamicParameters.Add("MoId", MoId);

                                var CheckBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                if (CheckBarcodeProcessResult.Count() > 0)
                                {
                                    foreach (var item2 in CheckBarcodeProcessResult)
                                    {
                                        DateTime BarcodeProcessDate = item2.FinishDate;
                                        int dateResult = DateTime.Compare(BarcodeProcessDate, BarcodeCreateDate);
                                        if (dateResult > 0) throw new SystemException("條碼【" + item.BarcodeNo + "】已有過站紀錄，無法重整單身資料!!");
                                    }
                                }
                                #endregion
                            }
                            #endregion

                            #region //檢查此發料單單身是否有條碼轉移紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                    , b.BarcodeStatus CurrentBarcodeStatus
                                    , c.StatusName
                                    FROM MES.MrBarcodeTransferLog a
                                    INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                    INNER JOIN BAS.[Status] c ON b.BarcodeStatus = c.StatusNo AND c.StatusSchema = 'Barcode.BarcodeStatus'
                                    INNER JOIN MES.MrDetail d ON a.MrDetailId = d.MrDetailId
                                    WHERE d.MrId = @MrId
                                    AND d.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TransferLogResult.Count() > 0)
                            {
                                foreach (var item2 in TransferLogResult)
                                {
                                    if (item2.CurrentBarcodeStatus != "1" && item2.CurrentBarcodeStatus != "3")
                                    {
                                        throw new SystemException("此條碼【" + item2.BarcodeNo + "】狀態【" + item2.StatusName + "】無法刪除，請先進行退料或解除綁定!");
                                    }

                                    #region //UPDATE MES.Barcode回原先資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            MoId = @MoId,
                                            CurrentMoProcessId = @CurrentMoProcessId,
                                            NextMoProcessId = @NextMoProcessId,
                                            CurrentProdStatus = @CurrentProdStatus,
                                            BarcodeStatus = @BarcodeStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeNo = @BarcodeNo";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          item2.MoId,
                                          item2.CurrentMoProcessId,
                                          item2.NextMoProcessId,
                                          item2.CurrentProdStatus,
                                          item2.BarcodeStatus,
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          item2.BarcodeNo
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //將轉移LOG移除
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                            WHERE LogId = @LogId";
                                    dynamicParameters.Add("LogId", item2.LogId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //刪除MES.Barcode資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE a
                                        FROM MES.Barcode a
                                        INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                        INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                        WHERE c.MrId = @MrId
                                        AND c.MoId = @MoId";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MoId", MoId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //DELETE MES.MrBarcodeRegister
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrBarcodeRegister a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrId = @MrId
                                    AND b.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //DELETE MES.MrDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrDetail a
                                    WHERE a.MrId = @MrId
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //查看目前MrDetail序號
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MAX(MrSequence) MrSequence
                                    FROM MES.MrDetail
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var result5 = sqlConnection.Query(sql, dynamicParameters);
                            int currentMrSequence = -1;
                            foreach (var item in result5)
                            {
                                currentMrSequence = Convert.ToInt32(item.MrSequence);
                            }

                            string MrSequence = (currentMrSequence + 1).ToString().PadLeft(4, '0');
                            #endregion

                            #region //取得MES製令用料設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(a.CompositionQuantity, 1) CompositionQuantity, ISNULL(a.Base, 1) Base, ISNULL(a.LossRate, 0) LossRate, a.BarcodeCtrl, a.MainBarcode, a.ControlType, a.DecompositionFlag
                                    , b.MtlItemId, b.DemandRequisitionQty, b.RequisitionQty, b.SubstituteMtlItemId, b.MaterialProperties, b.SubstituteStatus
                                    , c.WoErpPrefix, c.WoErpNo, c.PlanQty, c.StockInQty
                                    , d.UomId, d.UomNo
                                    , e.MtlItemNo, e.MtlItemName
                                    , f.InventoryId, f.InventoryNo
                                    , g.MtlItemNo SubstitutionMtlItemNo, g.MtlItemName SubstitutionMtlItemName
                                    , h.TypeName
                                    , i.MtlItemNo
                                    FROM MES.MoMtlSetting a
                                    INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                    INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                                    INNER JOIN PDM.MtlItem e ON b.MtlItemId = e.MtlItemId
                                    INNER JOIN SCM.Inventory f ON b.InventoryId = f.InventoryId
                                    INNER JOIN PDM.MtlItem g ON b.SubstituteMtlItemId = g.MtlItemId
                                    INNER JOIN BAS.[Type] h ON a.ControlType = h.TypeNo AND h.TypeSchema = 'MoMtlSetting.ControlType'
                                    INNER JOIN PDM.MtlItem i ON b.MtlItemId = i.MtlItemId
                                    WHERE a.MoId = @MoId
                                    ORDER BY a.MainBarcode DESC";
                            dynamicParameters.Add("MoId", MoId);

                            var result6 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result6)
                            {
                                if (item.SubstituteStatus == "Y" && (item.MtlItemId != item.SubstituteMtlItemId))
                                {
                                    //continue;
                                }

                                #region //依據材料性質判斷要帶出的用料MaterialCategory
                                string MaterialProperties = "";
                                if (item.MaterialProperties == null || item.MaterialProperties == "")
                                {
                                    throw new SystemException("材料性質設定錯誤，請確認工單資料是否正確!!");
                                }
                                else
                                {
                                    if (item.MaterialProperties != "1" && item.MaterialProperties != "2" && item.MaterialProperties != "5") continue;
                                    MaterialProperties = item.MaterialProperties;
                                }

                                if (MaterialCategory != "1" && MaterialCategory != "*" && MaterialCategory != "2" && MaterialCategory != "5")
                                {
                                    MaterialCategory = "*";
                                }

                                if (MaterialCategory != "*")
                                {
                                    if (MaterialCategory != MaterialProperties) continue;
                                }
                                #endregion

                                #region //取得ERP製令單身需領/已領用量
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TB004 DemandRequisitionQty, a.TB005 RequisitionQty
                                        , b.TA015, b.TA016, b.TA017, b.TA018
                                        FROM MOCTB a
                                        INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                                        WHERE a.TB001 = @WoErpPrefix
                                        AND a.TB002 = @WoErpNo
                                        AND a.TB003 = @MtlItemNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);
                                dynamicParameters.Add("MtlItemNo", item.MtlItemNo);

                                var ErpWoDetailResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (ErpWoDetailResult.Count() <= 0) throw new SystemException("查無ERP製令單身資料!!");

                                double DemandRequisitionQty = -1;
                                double RequisitionQty = -1;
                                double TA015 = 0; //預計生產量
                                double TA016 = 0; //已領套數
                                double TA017 = 0; //已生產量
                                double TA018 = 0; //報廢數量
                                double unitRate = 0;
                                foreach (var item2 in ErpWoDetailResult)
                                {
                                    DemandRequisitionQty = Convert.ToDouble(item2.DemandRequisitionQty);
                                    RequisitionQty = Convert.ToDouble(item2.RequisitionQty);
                                    TA015 = Convert.ToDouble(item2.TA015);
                                    TA016 = Convert.ToDouble(item2.TA016);
                                    TA017 = Convert.ToDouble(item2.TA017);
                                    TA018 = Convert.ToDouble(item2.TA018);
                                    unitRate = DemandRequisitionQty / TA015;
                                }
                                #endregion

                                #region //此套數比例下物料領退料數量
                                double mtlItemQty = Quantity * unitRate;
                                #endregion

                                #region //領料單
                                if (MQ010 < 0)
                                {
                                    #region //若為補足需領量，從EPR查是否有剩餘的料要領
                                    if (MrType == "2" || MrType == "3")
                                    {
                                        if (DemandRequisitionQty - RequisitionQty <= 0) continue;
                                    }
                                    #endregion
                                }
                                #endregion
                                #region //退料單
                                else
                                {
                                    //若無已領用量直接跳過
                                    if (RequisitionQty <= 0) continue;
                                }
                                #endregion

                                #region //計算一套可以領/退多少料
                                double MrDetailQty = -1; //預計領料量
                                double ActualQuantity = -1; //實際領料量
                                if (item.BomDetailId != null)
                                {
                                    double unitQuantity = (DemandRequisitionQty - RequisitionQty) / item.PlanQty / item.CompositionQuantity;
                                    if (unitQuantity * Quantity * item.CompositionQuantity > (DemandRequisitionQty - RequisitionQty)) MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                    else MrDetailQty = unitQuantity * Quantity * item.CompositionQuantity;
                                }
                                else
                                {
                                    #region //計算退料狀況，最多可退數量
                                    //超退檢核公式: 本次退料量 MOCTE.TE005 > 已領用量 MOCTB.TB005 - (需領用量MOCTB.TB004 * (已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018) / 預計產量MOCTA.TA015))
                                    double allowQty = RequisitionQty - (DemandRequisitionQty * (TA017 + TA018) / TA015);
                                    if (allowQty <= 0 && MQ010 > 0) continue;
                                    #endregion

                                    switch (MrType)
                                    {
                                        case "1":
                                            MrDetailQty = mtlItemQty;
                                            break;
                                        case "2":
                                            MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                            break;
                                        case "3":
                                            MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                            break;
                                        case "4":
                                            MrDetailQty = mtlItemQty;
                                            break;
                                        case "5":
                                            MrDetailQty = allowQty;
                                            break;
                                    }
                                }

                                if (item.DecompositionFlag == "Y")
                                {
                                    ActualQuantity = MrDetailQty;
                                }
                                else if (item.BarcodeCtrl == "Y" && item.UomNo == "PCS")
                                {
                                    ActualQuantity = 0;
                                }
                                else
                                {
                                    ActualQuantity = MrDetailQty;
                                }
                                #endregion

                                #region //計算領料備註
                                string DetailDesc = "";
                                if (MQ010 < 0)
                                {
                                    DetailDesc = erpHelper.GetDetailDesc(item.MtlItemNo, item.InventoryNo, MrErpPrefix, MrErpNo, MrId, item.MtlItemId, item.InventoryId, MrDetailQty
                                        , sqlConnection, sqlConnection2);
                                }
                                #endregion

                                #region //INSERT MES.MrDetail
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MrDetail (MrId, MrSequence, MtlItemId, Quantity, ActualQuantity, UomId, Unit
                                        , InventoryId, SubInventoryCode, ProcessCode, LotNumber, MoId, WoErpPrefix, WoErpNo
                                        , DetailDesc, Remark, MaterialCategory, ConfirmStatus, ProjectCode, BondedStatus
                                        , SubstituteStatus, OfficialItemStatus, SubstitutionId, SubstitutionMtlItemNo, SubstituteProcessCode
                                        , SubstituteQty, SubstituteRate
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MrDetailId
                                        VALUES (@MrId, @MrSequence, @MtlItemId, @Quantity, @ActualQuantity, @UomId, @Unit
                                        , @InventoryId, @SubInventoryCode, @ProcessCode, @LotNumber, @MoId, @WoErpPrefix, @WoErpNo
                                        , @DetailDesc, @Remark, @MaterialCategory, @ConfirmStatus, @ProjectCode, @BondedStatus
                                        , @SubstituteStatus, @OfficialItemStatus, @SubstitutionId, @SubstitutionMtlItemNo, @SubstituteProcessCode
                                        , @SubstituteQty, @SubstituteRate
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MrId,
                                        MrSequence,
                                        item.MtlItemId,
                                        Quantity = Math.Round(MrDetailQty * 1000) / 1000,
                                        ActualQuantity = Math.Round(ActualQuantity * 1000) / 1000,
                                        item.UomId,
                                        Unit = item.UomNo,
                                        item.InventoryId,
                                        SubInventoryCode = item.InventoryNo,
                                        ProcessCode = "****",
                                        LotNumber = "",
                                        MoId,
                                        WoErpPrefix,
                                        WoErpNo,
                                        DetailDesc,
                                        Remark = ExcessFlag == "N" ? Remark : "",
                                        MaterialCategory = MaterialProperties,
                                        ConfirmStatus = "N",
                                        ProjectCode = "",
                                        BondedStatus = "N",
                                        SubstituteStatus = "N",
                                        OfficialItemStatus = "2",
                                        SubstitutionId = item.SubstitutionId != null ? (int?)item.SubstituteMtlItemId : null,
                                        item.SubstitutionMtlItemNo,
                                        SubstituteProcessCode = "****",
                                        SubstituteQty = 0,
                                        SubstituteRate = 0,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();

                                int MrDetailId = -1;
                                foreach (var item2 in insertResult)
                                {
                                    MrDetailId = item2.MrDetailId;
                                }

                                int nextMrSequence = Convert.ToInt32(MrSequence) + 1;
                                MrSequence = nextMrSequence.ToString().PadLeft(4, '0');
                                #endregion
                            }
                            #endregion
                            #endregion

                            #region //將單頭拋轉狀態改為R
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    TransferStatus = 'R',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  LastModifiedDate,
                                  LastModifiedBy = CurrentUser,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)",
                                data = insertResult
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBatchMrWipOrder -- 批量新增領退料單設定資料(MrWipOrder + MrDetail) -- Ann 2025-04-29
        public string AddBatchMrWipOrder(int MrId, string MoIds)
        {
            try
            {
                if (MoIds.Length < 0) throw new SystemException("【製令列表】不能為空!");

                string MrType = "1";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MrDate, ConfirmStatus, MrErpPrefix, MrErpNo
                                    FROM MES.MaterialRequisition
                                    WHERE CompanyId = @CompanyId
                                    AND MrId = @MrId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料有誤!");

                            DateTime MrDate = new DateTime();
                            string MrErpPrefix = "";
                            string MrErpNo = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單已確認，無法更改!");
                                MrDate = item.MrDate;
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                            }
                            #endregion

                            #region //查詢單據類別設定資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MQ010, LTRIM(RTRIM(a.MQ019)) MQ019, LTRIM(RTRIM(a.MQ054)) MQ054
                                    FROM CMSMQ a 
                                    WHERE MQ001 = @MrErpPrefix";
                            dynamicParameters.Add("MrErpPrefix", MrErpPrefix);

                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP單別資料有誤!!");

                            int MQ010 = -1;
                            string CheckMoFlag = "";
                            string ExcessFlag = "";
                            foreach (var item in CMSMQResult)
                            {
                                MQ010 = Convert.ToInt32(item.MQ010);
                                CheckMoFlag = item.MQ019;
                                ExcessFlag = item.MQ054;
                                if (ExcessFlag == "N") throw new SystemException("批量新增模式尚不支援超領單別!!");
                            }
                            #endregion

                            var moIdList = MoIds.Split(','); 
                            foreach (var MoId in moIdList)
                            {
                                #region //確認製令資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.Quantity
                                        , b.WoErpPrefix, b.WoErpNo
                                        , c.InventoryId, c.InventoryUomId
                                        FROM MES.ManufactureOrder a
                                        INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                        INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                        WHERE a.MoId = @MoId";
                                dynamicParameters.Add("MoId", MoId);

                                var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                                if (ManufactureOrderResult.Count() <= 0) throw new SystemException("製令資料錯誤!!");

                                int MoQuantity = 0;
                                string WoErpPrefix = "";
                                string WoErpNo = "";
                                int InventoryId = -1;
                                int UomId = -1;
                                foreach (var item in ManufactureOrderResult)
                                {
                                    MoQuantity = item.Quantity;
                                    WoErpPrefix = item.WoErpPrefix;
                                    WoErpNo = item.WoErpNo;
                                    InventoryId = item.InventoryId;
                                    UomId = item.InventoryUomId;
                                }
                                #endregion

                                #region //查詢ERP製令資訊
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TA015 PlanQty, a.TA016 RequisitionSetQty
                                        , a.TA017 StockInQty, a.TA018 ScrapQty, FORMAT(CONVERT(DATETIME, LTRIM(RTRIM(a.TA014))), 'yyyy-MM-dd') ActualEnd
                                        FROM MOCTA a
                                        WHERE a.TA001 = @WoErpPrefix
                                        AND a.TA002 = @WoErpNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);

                                var ErpWoInfoResult = sqlConnection2.Query(sql, dynamicParameters);
                                if (ErpWoInfoResult.Count() <= 0) throw new SystemException("ERP製令(MOCTA)資料有誤!");

                                double PlanQty = -1;
                                double RequisitionSetQty = -1;
                                double StockInQty = -1;
                                string ActualEnd = "";
                                double ScrapQty = -1;
                                double Quantity = 0;
                                foreach (var item in ErpWoInfoResult)
                                {
                                    PlanQty = Convert.ToDouble(item.PlanQty);
                                    RequisitionSetQty = Convert.ToDouble(item.RequisitionSetQty);
                                    StockInQty = Convert.ToDouble(item.StockInQty);
                                    ActualEnd = item.ActualEnd;
                                    ScrapQty = Convert.ToDouble(item.ScrapQty);
                                    Quantity = PlanQty - RequisitionSetQty;
                                }
                                #endregion

                                #region //搜尋此製令所有領料單資訊，並找出實際已核單領料套數
                                double ErpQuantity = 0;
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.MrErpPrefix, b.MrErpNo
                                        , c.Quantity
                                        , d.WoErpPrefix, d.WoErpNo
                                        FROM MES.MrWipOrder a
                                        INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                        INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                        INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                        WHERE a.MoId = @MoId";
                                dynamicParameters.Add("MoId", MoId);

                                var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MrWipOrderResult.Count() > 0)
                                {
                                    foreach (var item2 in MrWipOrderResult)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.TD006 Quantity
                                                , b.MQ010
                                                , (
                                                    SELECT TOP 1 1
                                                    FROM MOCTE x
                                                    WHERE x.TE001 = a.TD001
                                                    AND x.TE002 = a.TD002
                                                    AND x.TE019 = 'Y'
                                                ) CheckConfirm
                                                FROM MOCTD a
                                                INNER JOIN CMSMQ b ON a.TD001 = b.MQ001
                                                WHERE a.TD001 = @MrErpPrefix
                                                AND a.TD002 = @MrErpNo
                                                AND a.TD003 = @WoErpPrefix
                                                AND a.TD004 = @WoErpNo";
                                        dynamicParameters.Add("MrErpPrefix", item2.MrErpPrefix);
                                        dynamicParameters.Add("MrErpNo", item2.MrErpNo);
                                        dynamicParameters.Add("WoErpPrefix", item2.WoErpPrefix);
                                        dynamicParameters.Add("WoErpNo", item2.WoErpNo);

                                        var ErpMrWipOrderResult = sqlConnection2.Query(sql, dynamicParameters);

                                        foreach (var item3 in ErpMrWipOrderResult)
                                        {
                                            if (item3.CheckConfirm != null)
                                            {
                                                if (item3.MQ010 > 0)
                                                {
                                                    ErpQuantity -= Convert.ToDouble(item3.Quantity);
                                                }
                                                else
                                                {
                                                    ErpQuantity += Convert.ToDouble(item3.Quantity);
                                                }
                                            }
                                        }
                                    }
                                }
                                #endregion

                                #region //判斷是否超領/超退
                                if (ExcessFlag == "Y")
                                {
                                    if (MQ010 < 0) //領料
                                    {
                                        if (Quantity > (MoQuantity - ErpQuantity) && ExcessFlag == "Y") throw new SystemException("領取數量超過未領用量(" + (MoQuantity - ErpQuantity).ToString() + ")!");
                                    }
                                    else if (MQ010 > 0) //退料
                                    {
                                        throw new SystemException("批量新增模式暫不支援退料單!!");
                                    }
                                    else
                                    {
                                        throw new SystemException("此領料單別(" + MrErpPrefix + ")設定資料有誤，請通知開發人員!!");
                                    }
                                }
                                #endregion

                                #region //判斷庫別資料是否有誤
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 InventoryNo
                                        FROM SCM.Inventory
                                        WHERE InventoryId = @InventoryId";
                                dynamicParameters.Add("InventoryId", InventoryId);

                                var result3 = sqlConnection.Query(sql, dynamicParameters);
                                if (result3.Count() <= 0) throw new SystemException("庫別資料有誤!");

                                string InventoryNo = "";
                                foreach (var item in result3)
                                {
                                    InventoryNo = item.InventoryNo;
                                }
                                #endregion

                                #region //判斷 領退料單 + MES製令 + 領退料方式 是否重複
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.MrWipOrder
                                        WHERE MrId = @MrId
                                        AND MoId = @MoId
                                        AND MrType = @MrType";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MrType", MrType);

                                var result4 = sqlConnection.Query(sql, dynamicParameters);
                                if (result4.Count() > 0) throw new SystemException("【領退料單 + MES製令 + 領退料方式】重複，請重新輸入!");
                                #endregion

                                #region //判斷單位資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT UomNo
                                        FROM PDM.UnitOfMeasure
                                        WHERE UomId = @UomId";
                                dynamicParameters.Add("UomId", UomId);

                                var uomResult = sqlConnection.Query(sql, dynamicParameters);
                                if (uomResult.Count() <= 0) throw new SystemException("單位資料有誤!");

                                string UomNo = "";
                                foreach (var item in uomResult)
                                {
                                    UomNo = item.UomNo;
                                }
                                #endregion

                                #region //取得領料單輸入序號
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT COUNT(1) Count
                                        FROM MES.MrWipOrder 
                                        WHERE MrId = @MrId";
                                dynamicParameters.Add("MrId", MrId);

                                var MrWipOrderCount = sqlConnection.Query(sql, dynamicParameters);

                                string LineSeq = (MrWipOrderCount.FirstOrDefault().Count).ToString("D4");
                                #endregion

                                #region //新增MES.MrWipOrder
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MrWipOrder (MrId, MoId, WoErpPrefix, WoErpNo, MrType, Quantity
                                        , InventoryId, SubInventoryCode, RequisitionCode, NegativeStatus, Remark
                                        , MaterialCategory, SubinventoryType, LineSeq, UomId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MrId, INSERTED.MoId
                                        VALUES (@MrId, @MoId, @WoErpPrefix, @WoErpNo, @MrType, @Quantity
                                        , @InventoryId, @SubInventoryCode, @RequisitionCode, @NegativeStatus, @Remark
                                        , @MaterialCategory, @SubinventoryType, @LineSeq, @UomId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MrId,
                                        MoId,
                                        WoErpPrefix,
                                        WoErpNo,
                                        MrType,
                                        Quantity,
                                        InventoryId,
                                        SubInventoryCode = InventoryNo,
                                        RequisitionCode = "1",
                                        NegativeStatus = "N",
                                        Remark = "批量新增",
                                        MaterialCategory = "*",
                                        SubinventoryType = "1",
                                        LineSeq,
                                        UomId,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                int rowsAffected = insertResult.Count();
                                #endregion

                                #region //新增MES.MrDetail

                                #region //確認沒有條碼已開工
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss')  BarcodeCreateDate
                                        FROM MES.MrBarcodeRegister a 
                                        INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                        WHERE b.MrId = @MrId
                                        AND b.MoId = @MoId";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MoId", MoId);

                                var MrBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in MrBarcodeResult)
                                {
                                    #region //比對條碼歷程時間判斷是否為舊條碼
                                    DateTime BarcodeCreateDate = Convert.ToDateTime(item.BarcodeCreateDate);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 b.FinishDate
                                            FROM MES.Barcode a
                                            INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId
                                            WHERE a.BarcodeNo = @BarcodeNo
                                            AND b.MoId = @MoId
                                            ORDER BY FinishDate DESC";
                                    dynamicParameters.Add("BarcodeNo", item.BarcodeNo);
                                    dynamicParameters.Add("MoId", MoId);

                                    var CheckBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (CheckBarcodeProcessResult.Count() > 0)
                                    {
                                        foreach (var item2 in CheckBarcodeProcessResult)
                                        {
                                            DateTime BarcodeProcessDate = item2.FinishDate;
                                            int dateResult = DateTime.Compare(BarcodeProcessDate, BarcodeCreateDate);
                                            if (dateResult > 0) throw new SystemException("條碼【" + item.BarcodeNo + "】已有過站紀錄，無法重整單身資料!!");
                                        }
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //檢查此發料單單身是否有條碼轉移紀錄
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                        , b.BarcodeStatus CurrentBarcodeStatus
                                        , c.StatusName
                                        FROM MES.MrBarcodeTransferLog a
                                        INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                        INNER JOIN BAS.[Status] c ON b.BarcodeStatus = c.StatusNo AND c.StatusSchema = 'Barcode.BarcodeStatus'
                                        INNER JOIN MES.MrDetail d ON a.MrDetailId = d.MrDetailId
                                        WHERE d.MrId = @MrId
                                        AND d.MoId = @MoId";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MoId", MoId);

                                var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                                if (TransferLogResult.Count() > 0)
                                {
                                    foreach (var item2 in TransferLogResult)
                                    {
                                        if (item2.CurrentBarcodeStatus != "1" && item2.CurrentBarcodeStatus != "3")
                                        {
                                            throw new SystemException("條碼【" + item2.BarcodeNo + "】狀態【" + item2.StatusName + "】無法刪除，請先進行退料或解除綁定!");
                                        }

                                        #region //UPDATE MES.Barcode回原先資料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode SET
                                                MoId = @MoId,
                                                CurrentMoProcessId = @CurrentMoProcessId,
                                                NextMoProcessId = @NextMoProcessId,
                                                CurrentProdStatus = @CurrentProdStatus,
                                                BarcodeStatus = @BarcodeStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BarcodeNo = @BarcodeNo";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              item2.MoId,
                                              item2.CurrentMoProcessId,
                                              item2.NextMoProcessId,
                                              item2.CurrentProdStatus,
                                              item2.BarcodeStatus,
                                              LastModifiedDate,
                                              LastModifiedBy,
                                              item2.BarcodeNo
                                          });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //將轉移LOG移除
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                                WHERE LogId = @LogId";
                                        dynamicParameters.Add("LogId", item2.LogId);

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                                else
                                {
                                    #region //刪除MES.Barcode資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE a
                                        FROM MES.Barcode a
                                        INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                        INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                        WHERE c.MrId = @MrId
                                        AND c.MoId = @MoId";
                                    dynamicParameters.Add("MrId", MrId);
                                    dynamicParameters.Add("MoId", MoId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion

                                #region //DELETE MES.MrBarcodeRegister
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE a 
                                        FROM MES.MrBarcodeRegister a
                                        INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                        WHERE b.MrId = @MrId
                                        AND b.MoId = @MoId";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MoId", MoId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //DELETE MES.MrDetail
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE a 
                                        FROM MES.MrDetail a
                                        WHERE a.MrId = @MrId
                                        AND a.MoId = @MoId";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MoId", MoId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //查看目前MrDetail序號
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MAX(MrSequence) MrSequence
                                        FROM MES.MrDetail
                                        WHERE MrId = @MrId";
                                dynamicParameters.Add("MrId", MrId);

                                var result5 = sqlConnection.Query(sql, dynamicParameters);
                                int currentMrSequence = -1;
                                foreach (var item in result5)
                                {
                                    currentMrSequence = Convert.ToInt32(item.MrSequence);
                                }

                                string MrSequence = (currentMrSequence + 1).ToString().PadLeft(4, '0');
                                #endregion

                                #region //取得MES製令用料設定
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(a.CompositionQuantity, 1) CompositionQuantity, ISNULL(a.Base, 1) Base, ISNULL(a.LossRate, 0) LossRate, a.BarcodeCtrl, a.MainBarcode, a.ControlType, a.DecompositionFlag
                                        , b.MtlItemId, b.DemandRequisitionQty, b.RequisitionQty, b.SubstituteMtlItemId, b.MaterialProperties, b.SubstituteStatus
                                        , c.WoErpPrefix, c.WoErpNo, c.PlanQty, c.StockInQty
                                        , d.UomId, d.UomNo
                                        , e.MtlItemNo, e.MtlItemName
                                        , f.InventoryId, f.InventoryNo
                                        , g.MtlItemNo SubstitutionMtlItemNo, g.MtlItemName SubstitutionMtlItemName
                                        , h.TypeName
                                        , i.MtlItemNo
                                        FROM MES.MoMtlSetting a
                                        INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                        INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                        INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                                        INNER JOIN PDM.MtlItem e ON b.MtlItemId = e.MtlItemId
                                        INNER JOIN SCM.Inventory f ON b.InventoryId = f.InventoryId
                                        INNER JOIN PDM.MtlItem g ON b.SubstituteMtlItemId = g.MtlItemId
                                        INNER JOIN BAS.[Type] h ON a.ControlType = h.TypeNo AND h.TypeSchema = 'MoMtlSetting.ControlType'
                                        INNER JOIN PDM.MtlItem i ON b.MtlItemId = i.MtlItemId
                                        WHERE a.MoId = @MoId
                                        ORDER BY a.MainBarcode DESC";
                                dynamicParameters.Add("MoId", MoId);

                                var result6 = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in result6)
                                {
                                    if (item.SubstituteStatus == "Y" && (item.MtlItemId != item.SubstituteMtlItemId))
                                    {
                                        //continue;
                                    }

                                    #region //依據材料性質判斷要帶出的用料MaterialCategory
                                    string MaterialProperties = "";
                                    if (item.MaterialProperties == null || item.MaterialProperties == "")
                                    {
                                        throw new SystemException("材料性質設定錯誤，請確認工單資料是否正確!!");
                                    }
                                    else
                                    {
                                        if (item.MaterialProperties != "1" && item.MaterialProperties != "2" && item.MaterialProperties != "5") continue;
                                        MaterialProperties = item.MaterialProperties;
                                    }

                                    string MaterialCategory = "*";
                                    #endregion

                                    #region //取得ERP製令單身需領/已領用量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TB004 DemandRequisitionQty, a.TB005 RequisitionQty
                                            , b.TA015, b.TA016, b.TA017, b.TA018
                                            FROM MOCTB a
                                            INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                                            WHERE a.TB001 = @WoErpPrefix
                                            AND a.TB002 = @WoErpNo
                                            AND a.TB003 = @MtlItemNo";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", WoErpNo);
                                    dynamicParameters.Add("MtlItemNo", item.MtlItemNo);

                                    var ErpWoDetailResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (ErpWoDetailResult.Count() <= 0) throw new SystemException("查無ERP製令單身資料!!");

                                    double DemandRequisitionQty = -1;
                                    double RequisitionQty = -1;
                                    double TA015 = 0; //預計生產量
                                    double TA016 = 0; //已領套數
                                    double TA017 = 0; //已生產量
                                    double TA018 = 0; //報廢數量
                                    foreach (var item2 in ErpWoDetailResult)
                                    {
                                        DemandRequisitionQty = Convert.ToDouble(item2.DemandRequisitionQty);
                                        RequisitionQty = Convert.ToDouble(item2.RequisitionQty);
                                        TA015 = Convert.ToDouble(item2.TA015);
                                        TA016 = Convert.ToDouble(item2.TA016);
                                        TA017 = Convert.ToDouble(item2.TA017);
                                        TA018 = Convert.ToDouble(item2.TA018);
                                    }
                                    #endregion

                                    if (MQ010 > 0)
                                    {
                                        if (RequisitionQty <= 0) continue;
                                    }

                                    #region //若為補足需領量，從EPR查是否有剩餘的料要領
                                    if (MrType == "2" || MrType == "3")
                                    {
                                        if (DemandRequisitionQty - RequisitionQty <= 0) continue;
                                    }
                                    #endregion

                                    #region //若為退已領用量，從ERP查是否有已領量
                                    if (MrType == "5")
                                    {
                                        if (RequisitionQty <= 0) continue;
                                    }
                                    #endregion

                                    #region //計算一套可以領/退多少料
                                    //領料公式: 未領用量 / 總套數(預計生產量) / 單位用量 / 底數
                                    //退料公式: 剩餘生產量 / 單位用量
                                    double MrDetailQty = -1; //預計領料量
                                    double ActualQuantity = -1; //實際領料量
                                    if (item.BomDetailId != null)
                                    {
                                        double unitQuantity = (DemandRequisitionQty - RequisitionQty) / item.PlanQty / item.CompositionQuantity;
                                        if (unitQuantity * Quantity * item.CompositionQuantity > (DemandRequisitionQty - RequisitionQty)) MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                        else MrDetailQty = unitQuantity * Quantity * item.CompositionQuantity;
                                    }
                                    else
                                    {
                                        #region //計算退料狀況，最多可退數量
                                        //超退檢核公式: 本次退料量 MOCTE.TE005 > 已領用量 MOCTB.TB005 - (需領用量MOCTB.TB004 * (已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018) / 預計產量MOCTA.TA015))
                                        double allowQty = RequisitionQty - (DemandRequisitionQty * (TA017 + TA018) / TA015);
                                        if (allowQty <= 0 && MQ010 > 0) continue;
                                        #endregion

                                        switch (MrType)
                                        {
                                            //確認公式是否為: ((領料數量*單位用量)/基數) + ((領料數量*單位用量/基數)*損耗率) 再四捨五入
                                            case "1":
                                                //MrDetailQty = ((Quantity * Convert.ToDouble(item.CompositionQuantity)) / Convert.ToDouble(item.Base)) + (((Quantity * Convert.ToDouble(item.CompositionQuantity)) / Convert.ToDouble(item.Base)) * item.LossRate);
                                                MrDetailQty = (Quantity * Convert.ToDouble(item.CompositionQuantity)) / Convert.ToDouble(item.Base);
                                                break;
                                            case "2":
                                                MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                                break;
                                            case "3":
                                                MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                                break;
                                            case "4":
                                                MrDetailQty = (Quantity * item.CompositionQuantity) / item.Base;
                                                break;
                                            case "5":
                                                MrDetailQty = allowQty;
                                                break;
                                        }
                                    }

                                    if (item.DecompositionFlag == "Y")
                                    {
                                        ActualQuantity = MrDetailQty;
                                    }
                                    else if (item.BarcodeCtrl == "Y" && item.UomNo == "PCS")
                                    {
                                        ActualQuantity = 0;
                                    }
                                    else
                                    {
                                        ActualQuantity = MrDetailQty;
                                    }
                                    #endregion

                                    #region //計算領料備註
                                    string DetailDesc = "";
                                    if (MQ010 < 0)
                                    {
                                        DetailDesc = erpHelper.GetDetailDesc(item.MtlItemNo, item.InventoryNo, MrErpPrefix, MrErpNo, MrId, item.MtlItemId, item.InventoryId, MrDetailQty
                                            , sqlConnection, sqlConnection2);
                                    }
                                    #endregion

                                    #region //INSERT MES.MrDetail
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.MrDetail (MrId, MrSequence, MtlItemId, Quantity, ActualQuantity, UomId, Unit
                                            , InventoryId, SubInventoryCode, ProcessCode, LotNumber, MoId, WoErpPrefix, WoErpNo
                                            , DetailDesc, Remark, MaterialCategory, ConfirmStatus, ProjectCode, BondedStatus
                                            , SubstituteStatus, OfficialItemStatus, SubstitutionId, SubstitutionMtlItemNo, SubstituteProcessCode
                                            , SubstituteQty, SubstituteRate
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.MrDetailId
                                            VALUES (@MrId, @MrSequence, @MtlItemId, @Quantity, @ActualQuantity, @UomId, @Unit
                                            , @InventoryId, @SubInventoryCode, @ProcessCode, @LotNumber, @MoId, @WoErpPrefix, @WoErpNo
                                            , @DetailDesc, @Remark, @MaterialCategory, @ConfirmStatus, @ProjectCode, @BondedStatus
                                            , @SubstituteStatus, @OfficialItemStatus, @SubstitutionId, @SubstitutionMtlItemNo, @SubstituteProcessCode
                                            , @SubstituteQty, @SubstituteRate
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MrId,
                                            MrSequence,
                                            item.MtlItemId,
                                            Quantity = Math.Round(MrDetailQty * 1000) / 1000,
                                            ActualQuantity = Math.Round(ActualQuantity * 1000) / 1000,
                                            item.UomId,
                                            Unit = item.UomNo,
                                            item.InventoryId,
                                            SubInventoryCode = item.InventoryNo,
                                            ProcessCode = "****",
                                            LotNumber = "",
                                            MoId,
                                            WoErpPrefix,
                                            WoErpNo,
                                            DetailDesc,
                                            Remark = "",
                                            MaterialCategory = MaterialProperties,
                                            ConfirmStatus = "N",
                                            ProjectCode = "",
                                            BondedStatus = "N",
                                            SubstituteStatus = "N",
                                            OfficialItemStatus = "2",
                                            SubstitutionId = item.SubstitutionId != null ? (int?)item.SubstituteMtlItemId : null,
                                            item.SubstitutionMtlItemNo,
                                            SubstituteProcessCode = "****",
                                            SubstituteQty = 0,
                                            SubstituteRate = 0,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();

                                    int MrDetailId = -1;
                                    foreach (var item2 in insertResult)
                                    {
                                        MrDetailId = item2.MrDetailId;
                                    }

                                    int nextMrSequence = Convert.ToInt32(MrSequence) + 1;
                                    MrSequence = nextMrSequence.ToString().PadLeft(4, '0');
                                    #endregion
                                }
                                #endregion
                                #endregion

                                #region //將單頭拋轉狀態改為R
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MaterialRequisition SET
                                        TransferStatus = 'R',
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MrId = @MrId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      LastModifiedDate,
                                      LastModifiedBy = CurrentUser,
                                      MrId
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //Response
                                jsonResponse = JObject.FromObject(new
                                {
                                    status = "success",
                                    msg = "(" + rowsAffected + " rows affected)",
                                    data = insertResult
                                });
                                #endregion
                            }
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMrDetail -- 新增領退料單詳細資料(MrDetail) -- Ann 2022-08-25
        public string AddMrDetail(int MrId, int MoId, string MrSequence, int MtlItemId, double Quantity, int UomId, int InventoryId, string LotNumber, string DetailDesc, string Remark, string MaterialCategory
            , string ProjectCode, string BondedStatus, string SubstituteStatus)
        {
            try
            {
                double epsilon = 0.0001;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            if (CreateBy <= 0) throw new SystemException("【使用者ID】錯誤，請嘗試重新整理頁面!!");
                            if (MrSequence.Length <= 0) throw new SystemException("【領料序號】不能為空!");
                            if (MrSequence.Length > 4) throw new SystemException("【領料序號】長度錯誤!");
                            if (Quantity < 0) throw new SystemException("【領料數量】不能為空!");
                            if (LotNumber.Length > 20) throw new SystemException("【材料庫存批號】長度錯誤!");
                            if (DetailDesc.Length > 60) throw new SystemException("【領料說明】長度錯誤!");
                            if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                            if (MaterialCategory.Length <= 0) throw new SystemException("【材料性質】不能為空!");
                            if (ProjectCode.Length > 20) throw new SystemException("【專案代號】長度錯誤!");
                            if (BondedStatus.Length <= 0) throw new SystemException("【保稅碼】不能為空!");
                            if (SubstituteStatus.Length <= 0) throw new SystemException("【領替代料】不能為空!");

                            #region //判斷領退料單資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ConfirmStatus, a.MrErpPrefix, FORMAT(a.DocDate, 'yyyy-MM-dd HH:mm:ss') DocDate
                                    FROM MES.MaterialRequisition a
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料有誤!");

                            string MrErpPrefix = "";
                            DateTime DocDate = new DateTime();
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單狀態無法修改!!");
                                MrErpPrefix = item.MrErpPrefix;
                                DocDate = Convert.ToDateTime(item.DocDate);
                            }
                            #endregion

                            #region //取得單據性質設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MQ010, LTRIM(RTRIM(a.MQ019)) MQ019
                                    , LTRIM(RTRIM(a.MQ040)) MQ040
                                    , LTRIM(RTRIM(a.MQ054)) MQ054
                                    FROM CMSMQ a
                                    WHERE a.MQ001 = @MQ001";
                            dynamicParameters.Add("MQ001", MrErpPrefix);
                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP尚未維護此領料單單別(" + MrErpPrefix + ")!!");

                            string CheckMoFlag = "";
                            string ExcessFlag = "";
                            decimal? MQ010 = 0;
                            string EffectiveFlag = "";
                            foreach (var item2 in CMSMQResult)
                            {
                                CheckMoFlag = item2.MQ019;
                                ExcessFlag = item2.MQ054;
                                MQ010 = item2.MQ010;
                                EffectiveFlag = item2.EffectiveFlag;
                            }
                            #endregion

                            #region //取得此料號用料設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeCtrl, a.DecompositionFlag
                                    FROM MES.MoMtlSetting a 
                                    INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                    WHERE a.MoId = @MoId
                                    AND b.MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var MoMtlSettingResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MoMtlSettingResult.Count() <= 0 && ExcessFlag == "Y") throw new SystemException("取得料號用料設定時發生錯誤!!");

                            string BarcodeCtrl = "N";
                            string DecompositionFlag = "N";
                            foreach (var item in MoMtlSettingResult)
                            {
                                BarcodeCtrl = item.BarcodeCtrl;
                                DecompositionFlag = item.DecompositionFlag;
                            }
                            #endregion

                            #region //判斷製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.WoId, b.WoErpPrefix, b.WoErpNo, b.MtlItemId
                                    , c.BarcodeCtrl, c.DecompositionFlag
                                    , d.MtlItemNo MainMtlItemNo
                                    FROM MES.ManufactureOrder a
                                    INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                    INNER JOIN MES.MoMtlSetting c ON a.MoId = c.MoId
                                    INNER JOIN PDM.MtlItem d ON b.MtlItemId = d.MtlItemId
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            if (ManufactureOrderResult.Count() <= 0) throw new SystemException("製令資料錯誤!!");

                            int WoId = -1;
                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            string MainMtlItemNo = "";
                            foreach (var item in ManufactureOrderResult)
                            {
                                if (item.MtlItemId == MtlItemId && item.WoErpPrefix.IndexOf("52") == -1) throw new SystemException("非重工製令無法領取主件料號!!");
                                WoId = item.WoId;
                                WoErpPrefix = item.WoErpPrefix;
                                WoErpNo = item.WoErpNo;
                                MainMtlItemNo = item.MainMtlItemNo;
                            }
                            #endregion

                            #region //判斷品號資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemNo, TransferStatus
                                    FROM PDM.MtlItem
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("品號資料有誤!");

                            string MtlItemNo = "";
                            foreach (var item in result3)
                            {
                                if (item.TransferStatus != "Y") throw new SystemException("此品號尚未拋轉到ERP，無法使用!!");
                                MtlItemNo = item.MtlItemNo;
                            }
                            #endregion

                            #region //若MQ019為Y，檢查用料是否為製令BOM
                            if (CheckMoFlag == "Y")
                            {
                                if (MoId <= 0) throw new SystemException("此單別需要指定製令!!");

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MOCTB
                                        WHERE TB001 = @WoErpPrefix
                                        AND TB002 = @WoErpNo
                                        AND TB003 = @MtlItemNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);
                                dynamicParameters.Add("MtlItemNo", MtlItemNo);

                                var MOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (MOCTBResult.Count() <= 0) throw new SystemException("品號【" + MtlItemNo + "】並未在此製令用料中!!");
                            }
                            #endregion

                            #region //若MQ054為Y，則檢查是否超領/超退
                            if (ExcessFlag == "Y")
                            {
                                if (MQ010 < 0)
                                {
                                    #region //檢核超領
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TB004 DemandRequisitionQty, TB005 RequisitionQty
                                            FROM MOCTB
                                            WHERE TB001 = @WoErpPrefix
                                            AND TB002 = @WoErpNo
                                            AND TB003 = @MtlItemNo";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", WoErpNo);
                                    dynamicParameters.Add("MtlItemNo", MtlItemNo);

                                    var ErpWoDetailResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (ErpWoDetailResult.Count() <= 0) throw new SystemException("查無ERP製令單身資料!!");

                                    double DemandRequisitionQty = -1;
                                    double RequisitionQty = -1;
                                    foreach (var item2 in ErpWoDetailResult)
                                    {
                                        DemandRequisitionQty = Convert.ToDouble(item2.DemandRequisitionQty);
                                        RequisitionQty = Convert.ToDouble(item2.RequisitionQty);
                                    }

                                    if (MQ010 < 0)
                                    {
                                        if (Quantity > (DemandRequisitionQty - RequisitionQty))
                                        {
                                            if (Math.Abs(Quantity - (DemandRequisitionQty - RequisitionQty)) > epsilon)
                                            {
                                                throw new SystemException("此用料已領最大領料數，無法超領!!");
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    #region //檢核超退

                                    #region //取得製令相關資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TB004, a.TB005
                                            , b.TA015, b.TA016, b.TA017, b.TA018
                                            FROM MOCTB a 
                                            INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                                            WHERE a.TB001 = @T2 
                                            AND a.TB002 = @T3 
                                            AND a.TB003 = @T1";
                                    dynamicParameters.Add("T1", MtlItemNo);
                                    dynamicParameters.Add("T2", WoErpPrefix);
                                    dynamicParameters.Add("T3", WoErpNo);

                                    var MOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (MOCTBResult.Count() <= 0) throw new SystemException("查詢製令相關資料時錯誤!!");

                                    double TB004 = 0; //需領用量
                                    double TB005 = 0; //已領用量
                                    double TA015 = 0; //預計生產量
                                    double TA016 = 0; //已領套數
                                    double TA017 = 0; //已生產量
                                    double TA018 = 0; //報廢數量
                                    foreach (var item in MOCTBResult)
                                    {
                                        TB004 = Convert.ToDouble(item.TB004);
                                        TB005 = Convert.ToDouble(item.TB005);
                                        TA015 = Convert.ToDouble(item.TA015);
                                        TA016 = Convert.ToDouble(item.TA016);
                                        TA017 = Convert.ToDouble(item.TA017);
                                        TA018 = Convert.ToDouble(item.TA018);
                                    }
                                    #endregion

                                    //超退檢核公式: 本次退料量 MOCTE.TE005 > 已領用量 MOCTB.TB005 - (需領用量MOCTB.TB004 * (已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018) / 預計產量MOCTA.TA015))
                                    double allowQty = TB005 - (TB004 * (TA017 + TA018) / TA015);
                                    if (Quantity > allowQty)
                                    {
                                        throw new SystemException("料號【" + MtlItemNo + "】超過可退最大數量【" + allowQty + "】，無法新增!!");
                                    }
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //確認物料是否有進行NG拆盤
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.NgQty, a.AlreadyQty
                                        FROM MES.TrayMtlItemNg a 
                                        INNER JOIN PDM.BomDetail b ON a.BomDetailId = b.BomDetailId
                                        WHERE a.MoId = @MoId
                                        AND b.MtlItemId = @MtlItemId";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MtlItemId", MtlItemId);

                                var TrayMtlItemNgResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in TrayMtlItemNgResult)
                                {
                                    //if ((Quantity + Convert.ToDouble(item.AlreadyQty)) > item.NgQty) throw new SystemException("此用料【" + MtlItemNo + "】已進行NG拆盤。<br>剩餘可超領數量為【" + (item.NgQty - item.AlreadyQty) + "】!!");
                                }
                                #endregion
                            }
                            #endregion

                            #region //判斷單位資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 UomNo
                                    FROM PDM.UnitOfMeasure
                                    WHERE UomId = @UomId";
                            dynamicParameters.Add("UomId", UomId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("單位資料有誤!");

                            string UomNo = "";
                            foreach (var item in result4)
                            {
                                UomNo = item.UomNo;
                            }
                            #endregion

                            #region //確認ERP品號相關資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB004)) MB004
                                    , LTRIM(RTRIM(MB030)) MB030
                                    , LTRIM(RTRIM(MB031)) MB031
                                    FROM INVMB
                                    WHERE MB001 = @MB001";
                            dynamicParameters.Add("MB001", MtlItemNo);

                            var INVMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (INVMBResult.Count() <= 0) throw new SystemException("ERP品號基本資料錯誤!!");

                            foreach (var item in INVMBResult)
                            {
                                #region //比對單位與ERP品號基本資料單位是否相同
                                if (item.MB004 != UomNo) throw new SystemException("物料單位(" + UomNo + ")與ERP品號庫存單位(" + item.MB004 + ")不同!!");
                                #endregion

                                if (EffectiveFlag == "N")
                                {
                                    #region //判斷ERP品號生效日與失效日
                                    if (item.MB030 != "" && item.MB030 != null)
                                    {
                                        #region //判斷日期需大於或等於生效日
                                        string EffectiveDate = item.MB030;
                                        string effYear = EffectiveDate.Substring(0, 4);
                                        string effMonth = EffectiveDate.Substring(4, 2);
                                        string effDay = EffectiveDate.Substring(6, 2);
                                        DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                        int effresult = DateTime.Compare(DocDate, effFullDate);
                                        if (effresult < 0) throw new SystemException("此品號尚未生效，無法使用!!");
                                        #endregion
                                    }

                                    if (item.MB031 != "" && item.MB031 != null)
                                    {
                                        #region //判斷日期需小於或等於失效日
                                        string ExpirationDate = item.MB031;
                                        string effYear = ExpirationDate.Substring(0, 4);
                                        string effMonth = ExpirationDate.Substring(4, 2);
                                        string effDay = ExpirationDate.Substring(6, 2);
                                        DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                        int effresult = DateTime.Compare(DocDate, effFullDate);
                                        if (effresult > 0) throw new SystemException("此品號已失效，無法使用!!");
                                        #endregion
                                    }
                                    #endregion
                                }
                            }
                            #endregion

                            #region //判斷庫存資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 InventoryNo
                                    FROM SCM.Inventory
                                    WHERE InventoryId = @InventoryId";
                            dynamicParameters.Add("InventoryId", InventoryId);

                            var result5 = sqlConnection.Query(sql, dynamicParameters);
                            if (result5.Count() <= 0) throw new SystemException("庫存資料有誤!");

                            string InventoryNo = "";
                            foreach (var item in result5)
                            {
                                InventoryNo = item.InventoryNo;
                            }
                            #endregion

                            #region //判斷領退料單詳細資料 + 領料序號是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrDetail
                                    WHERE MrId = @MrId
                                    AND MrSequence = @MrSequence";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MrSequence", MrSequence);

                            var result6 = sqlConnection.Query(sql, dynamicParameters);
                            if (result6.Count() > 0) throw new SystemException("領退料單詳細資料 + 領料序號重複!");
                            #endregion

                            #region //計算ActualQuantity
                            double ActualQuantity = 0;
                            if (DecompositionFlag == "Y")
                            {
                                ActualQuantity = Math.Round(Quantity * 1000) / 1000;
                            }
                            else if (BarcodeCtrl == "Y" && UomNo == "PCS")
                            {
                                ActualQuantity = 0;
                            }
                            else
                            {
                                ActualQuantity = Math.Round(Quantity * 1000) / 1000;
                            }
                            #endregion

                            #region //檢查此料號是否已在ERP製令單身存在，並且為取替代料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TB023
                                    FROM MOCTB a 
                                    WHERE a.TB001 = @WoErpPrefix
                                    AND a.TB002 = @WoErpNo
                                    AND a.TB003 = @MtlItemNo
                                    AND a.TB023 != a.TB003
                                    AND a.TB027 = '2'";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);

                            var CheckSubResult = sqlConnection2.Query(sql, dynamicParameters);

                            string BomMtlItemNo = "";
                            int BomMtlItemId = -1;
                            if (CheckSubResult.Count() > 0)
                            {
                                foreach (var item in CheckSubResult)
                                {
                                    BomMtlItemNo = item.TB023;

                                    #region //取得MES原元件資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MtlItemId
                                            FROM PDM.MtlItem a 
                                            WHERE a.MtlItemNo = @MtlItemNo";
                                    dynamicParameters.Add("MtlItemNo", BomMtlItemNo);

                                    var BomMtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item2 in BomMtlItemResult)
                                    {
                                        BomMtlItemId = item2.MtlItemId;
                                    }
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //檢查此料號是否為製令中某元件替代料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(a.TB003)) TB003
                                        , LTRIM(RTRIM(b.TA006)) TA006
                                        FROM MOCTB a
                                        INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                                        WHERE TB001 = @WoErpPrefix
                                        AND TB002 = @WoErpNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);

                                var CheckMOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                string TempBomMtlItemNo = "";
                                foreach (var item in CheckMOCTBResult)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM BOMMB a 
                                            INNER JOIN INVMB b ON a.MB004 = b.MB001
                                            LEFT JOIN INVMC c ON c.MC001 = a.MB004
                                            INNER JOIN INVMB d ON a.MB001 = d.MB001
                                            WHERE a.MB002 = @BillMtlItemNo
                                            AND a.MB001 = @BomMtlItemNo
                                            AND a.MB004 = @MtlItemNo";
                                    dynamicParameters.Add("BillMtlItemNo", item.TA006);
                                    dynamicParameters.Add("BomMtlItemNo", item.TB003);
                                    dynamicParameters.Add("MtlItemNo", MtlItemNo);

                                    var CheckBOMMBResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (CheckBOMMBResult.Count() > 0)
                                    {
                                        TempBomMtlItemNo = item.TB003;
                                        break;
                                    }
                                }
                                #endregion

                                if (TempBomMtlItemNo != "")
                                {
                                    BomMtlItemNo = TempBomMtlItemNo;

                                    #region //取得MES元件ID
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MtlItemId
                                            FROM PDM.MtlItem a 
                                            WHERE a.MtlItemNo = @BomMtlItemNo";
                                    dynamicParameters.Add("BomMtlItemNo", BomMtlItemNo);

                                    var BomMtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BomMtlItemResult.Count() <= 0) throw new SystemException("查詢MES元件ID時錯誤!!");

                                    foreach (var item in BomMtlItemResult)
                                    {
                                        BomMtlItemId = item.MtlItemId;
                                    }
                                    #endregion
                                }
                                else
                                {
                                    BomMtlItemNo = MtlItemNo;
                                    BomMtlItemId = MtlItemId;
                                }
                            }
                            #endregion

                            #region //檢查此品號材料類型
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MD017)) MD017
                                    FROM BOMMD
                                    INNER JOIN BOMMC ON MD001 = MC001
                                    WHERE MD001 = @MainMtlItemNo
                                    AND MD003 = @MtlItemNo";
                            dynamicParameters.Add("MainMtlItemNo", MainMtlItemNo);
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);

                            var BomDetailResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in BomDetailResult)
                            {
                                if (item.MD017 == "4") throw new SystemException("此料號【" + MtlItemNo + "】設定為不發料，無法新增!!");
                            }
                            #endregion

                            #region //新增MES.MrDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MrDetail (MrId, MrSequence, MtlItemId, Quantity, ActualQuantity, UomId, Unit
                                    , InventoryId, SubInventoryCode, ProcessCode, LotNumber, MoId, WoErpPrefix, WoErpNo
                                    , DetailDesc, Remark, MaterialCategory, ConfirmStatus, ProjectCode, BondedStatus
                                    , SubstituteStatus, OfficialItemStatus, SubstitutionId, SubstitutionMtlItemNo, SubstituteProcessCode
                                    , SubstituteQty, SubstituteRate
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MrDetailId
                                    VALUES (@MrId, @MrSequence, @MtlItemId, @Quantity, @ActualQuantity, @UomId, @Unit
                                    , @InventoryId, @SubInventoryCode, @ProcessCode, @LotNumber, @MoId, @WoErpPrefix, @WoErpNo
                                    , @DetailDesc, @Remark, @MaterialCategory, @ConfirmStatus, @ProjectCode, @BondedStatus
                                    , @SubstituteStatus, @OfficialItemStatus, @SubstitutionId, @SubstitutionMtlItemNo, @SubstituteProcessCode
                                    , @SubstituteQty, @SubstituteRate
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MrId,
                                    MrSequence,
                                    MtlItemId,
                                    Quantity = Math.Round(Quantity * 1000) / 1000,
                                    ActualQuantity,
                                    UomId,
                                    Unit = UomNo,
                                    InventoryId,
                                    SubInventoryCode = InventoryNo,
                                    ProcessCode = "****",
                                    LotNumber = "",
                                    MoId = MoId > 0 ? MoId : (int?)null,
                                    WoErpPrefix,
                                    WoErpNo,
                                    DetailDesc,
                                    Remark,
                                    MaterialCategory = "1",
                                    ConfirmStatus = "N",
                                    ProjectCode = "",
                                    BondedStatus = "N",
                                    SubstituteStatus = "N",
                                    OfficialItemStatus = "2",
                                    SubstitutionId = BomMtlItemId,
                                    SubstitutionMtlItemNo = BomMtlItemNo,
                                    SubstituteProcessCode = "****",
                                    SubstituteQty = 0,
                                    SubstituteRate = 0,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            int rowsAffected = insertResult.Count();
                            #endregion

                            #region //將單頭拋轉狀態改為R
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    TransferStatus = 'R',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  LastModifiedDate,
                                  LastModifiedBy = CurrentUser,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)",
                                data = insertResult
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMrBarcodeRegister -- 新增物料條碼控管資料 -- Ann 2022-09-05
        public string AddMrBarcodeRegister(int MrDetailId, string BarcodeNo)
        {
            try
            {
                AddUserOperateLog(MrDetailId);

                BarcodeNo = BarcodeNo.Trim(); //濾掉空格
                int UserId = CreateBy;
                int rowsAffected = 0;
                string ErpNo = "";
                string ErpDbName = "";

                if (UserId <= 0) throw new SystemException("使用者ID錯誤，請嘗試重新登入!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            if (BarcodeNo.Length < 0) throw new SystemException("【條碼代碼】不能為空!");
                            if (BarcodeNo.Length > 32) throw new SystemException("【條碼代碼】長度錯誤!");

                            BarcodeNo = BarcodeNo.ToString().ToUpper(); //將條碼強制轉成大寫

                            #region //檢查領退料單詳細資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ConfirmStatus, a.ActualQuantity, a.MoId, a.Quantity, a.Unit
                                    , b.WoErpPrefix, b.WoErpNo
                                    , c.DemandRequisitionQty, c.RequisitionQty
                                    , d.TrayBarcode, d.Source, d.MrType
                                    , e.MtlItemNo, e.MtlItemName, e.LotManagement
                                    , FORMAT(f.DocDate, 'MM') DocDate
                                    , g.MtlItemNo MrDetailMtlItemNo
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.WipOrder b ON a.WoErpPrefix = b.WoErpPrefix AND a.WoErpNo = b.WoErpNo
                                    LEFT JOIN MES.WoDetail c ON a.MtlItemId = c.MtlItemId AND c.WoId = b.WoId
                                    INNER JOIN MES.MoSetting d ON a.MoId = d.MoId
                                    LEFT JOIN PDM.MtlItem e ON c.MtlItemId = e.MtlItemId
                                    INNER JOIN MES.MaterialRequisition f ON f.MrId = a.MrId
                                    INNER JOIN PDM.MtlItem g ON a.MtlItemId = g.MtlItemId
                                    WHERE MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單詳細資料有誤!");

                            double? ActualQuantity = -1;
                            int MoId = -1;
                            string Unit = "";
                            double? DemandRequisitionQty = -1;
                            double? RequisitionQty = -1;
                            string TrayBarcode = "";
                            string Source = "";
                            double? Quantity = -1;
                            string MtlItemNo = "";
                            string MtlItemName = "";
                            string MrType = "";
                            string DocDate = "";
                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            string MrDetailMtlItemNo = "";
                            string LotManagement = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單已被確認，無法更改!");
                                Unit = item.Unit;
                                Quantity = item.Quantity;
                                ActualQuantity = item.ActualQuantity;
                                MoId = item.MoId;
                                TrayBarcode = item.TrayBarcode;
                                Source = item.Source;
                                DemandRequisitionQty = item.DemandRequisitionQty;
                                RequisitionQty = item.RequisitionQty;
                                MtlItemNo = item.MtlItemNo;
                                MtlItemName = item.MtlItemName;
                                MrType = item.MrType;
                                DocDate = item.DocDate;
                                WoErpPrefix = item.WoErpPrefix;
                                WoErpNo = item.WoErpNo;
                                MrDetailMtlItemNo = item.MrDetailMtlItemNo;
                                LotManagement = item.LotManagement;
                            }
                            #endregion

                            #region //確認ERP工單(MOCTA)狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TA011)) Status
                                    FROM MOCTA
                                    WHERE TA001 = @TA001
                                    AND TA002 = @TA002";
                            dynamicParameters.Add("TA001", WoErpPrefix);
                            dynamicParameters.Add("TA002", WoErpNo);
                            var WoErpStatusReesult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item2 in WoErpStatusReesult)
                            {
                                if (item2.Status == "Y" || item2.Status == "y") throw new SystemException("ERP製令狀態無法進行領料!!");
                            }
                            #endregion

                            #region //確認是否為Tray模式
                            if (TrayBarcode == "Y" && Source == "MR")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo, a.TrayNo
                                        FROM MES.Tray a
                                        WHERE a.TrayNo = @TrayNo";
                                dynamicParameters.Add("TrayNo", BarcodeNo);

                                var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                if (TrayResult.Count() < 0) throw new SystemException("查無此Tray盤資訊!");

                                string TrayNo = "";
                                foreach (var item in TrayResult)
                                {
                                    if (item.BarcodeNo == null) throw new SystemException("此Tray盤尚未綁定條碼!");
                                    TrayNo = item.TrayNo;
                                    BarcodeNo = item.BarcodeNo;
                                }
                            }
                            #endregion

                            #region //確認是否為包裝條碼領料

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo, a.BarcodeId
                                        FROM MES.Barcode a
                                        WHERE a.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (BarcodeResult.Count() < 0) throw new SystemException("查無此條碼資訊!");
                            int BarcodeId = 0;
                            foreach (var item in BarcodeResult)
                            {
                                BarcodeId = item.BarcodeId;
                            }
                            dynamicParameters = new DynamicParameters();
                            sql = @"select * from MES.Barcode 
                                    where PrevBarcodeId = @BarcodeId
                                    ";
                            dynamicParameters.Add("BarcodeId", BarcodeId);

                            var PackageBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "MaterialRequisition");
                            dynamicParameters.Add("DetailCode", "barcode-control");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            if (PackageBarcodeResult.Count() > 0)
                            {
                                throw new SystemException("此條碼為包裝條碼，請使用包裝領料功能!");
                            }
                            else
                            {
                                MrBarcodeFunction();
                            }

                            void MrBarcodeFunction()
                            {
                                #region //判斷 領退料單詳細資料+條碼代碼 是否重複
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.MrBarcodeRegister
                                        WHERE MrDetailId = @MrDetailId
                                        AND BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("MrDetailId", MrDetailId);
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                var result2 = sqlConnection.Query(sql, dynamicParameters);
                                if (result2.Count() > 0) throw new SystemException("【領退料單詳細資料 + 條碼代碼】重複，請重新輸入!");
                                #endregion

                                #region //確認此條碼是否已註冊且尚未開工
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.MrBarcodeRegister a
                                        WHERE a.BarcodeNo = @BarcodeNo
                                        AND a.MrDetailId = @MrDetailId";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                var MrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);
                                if (MrBarcodeRegisterResult.Count() > 0) throw new SystemException("此條碼【" + BarcodeNo + "】已綁定!");
                                #endregion

                                #region //確認及更改BARCODE資訊

                                #region //先查詢現在製令首站
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 a.MoProcessId
                                        FROM MES.MoProcess a
                                        WHERE a.MoId = @MoId
                                        ORDER BY a.SortNumber";
                                dynamicParameters.Add("MoId", MoId);

                                var MoProcessIdResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MoProcessIdResult.Count() <= 0) throw new SystemException("查詢新製令首站時發生錯誤!!");

                                int CurrentMoProcessId = -1;
                                foreach (var item3 in MoProcessIdResult)
                                {
                                    CurrentMoProcessId = item3.MoProcessId;
                                }
                                #endregion

                                #region //查詢此發料條碼是否為新條碼或舊條碼
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeId, a.MoId, a.BarcodeQty, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                        , b.StatusName
                                        FROM MES.Barcode a
                                        INNER JOIN BAS.[Status] b ON a.BarcodeStatus = b.StatusNo AND b.StatusSchema = 'Barcode.BarcodeStatus'
                                        WHERE a.BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                var CheckBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                #endregion

                                #region //判斷此料號是否為主條碼及是否為可切割料號
                                string MainBarcode = "";
                                string DecompositionFlag = "";
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT d.MainBarcode, d.DecompositionFlag
                                        FROM MES.MrDetail a
                                        INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                        INNER JOIN MES.WoDetail c ON a.MtlItemId = c.MtlItemId AND c.WoId = b.WoId
                                        INNER JOIN MES.MoMtlSetting d ON c.WoDetailId = d.WoDetailId
                                        WHERE a.MrDetailId = @MrDetailId";
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                var MainBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                foreach (var item3 in MainBarcodeResult)
                                {
                                    MainBarcode = item3.MainBarcode;
                                    DecompositionFlag = item3.DecompositionFlag;
                                }
                                #endregion

                                if (CheckBarcodeResult.Count() <= 0)
                                {
                                    #region //新條碼流程

                                    #region //確認是否需做批號管理，若需要則不允許新條碼
                                    if (LotManagement == "Y")
                                    {
                                        throw new SystemException("元件品號【" + MtlItemNo + "】需做批號管理，新條碼請先綁定批號後再進行條碼註冊!!");
                                    }
                                    #endregion

                                    #region //確認MES1.0資料庫是否有此條碼資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT BarcodeQty
                                            FROM MES.MfgBarcode
                                            WHERE BarcodeNo = @BarcodeNo";
                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                    var MfgBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                    int BarcodeQty = 1;
                                    foreach (var item in MfgBarcodeResult)
                                    {
                                        BarcodeQty = item.BarcodeQty;
                                    }
                                    #endregion

                                    #region //INSERT MES.Barcode
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeNo,
                                            CurrentMoProcessId,
                                            NextMoProcessId = CurrentMoProcessId,
                                            MoId,
                                            BarcodeQty,
                                            BarcodeProcessId = -1,
                                            CurrentProdStatus = "P",
                                            BarcodeStatus = MainBarcode == "Y" ? "1" : "3",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult2.Count();
                                    #endregion

                                    if (Unit == "PCS" && (DecompositionFlag == "N" || DecompositionFlag == "")) //因鎢鋼模仁流程，故只能先以單位管控
                                    {
                                        if (MtlItemName == null) MtlItemName = MrDetailMtlItemNo;
                                        if ((ActualQuantity + BarcodeQty) > Quantity) throw new SystemException("此條碼數量(" + BarcodeQty + ")已超過【" + MtlItemName + "】未領用量(" + (Quantity - ActualQuantity) + ")");
                                        ActualQuantity += BarcodeQty;
                                    }
                                    #endregion
                                }
                                else
                                {
                                    #region //舊條碼流程
                                    foreach (var item4 in CheckBarcodeResult)
                                    {
                                        #region //確認是否為晶彩委託中揚製造
                                        //需確認為晶彩託外單且供應商為中揚
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 a.OspBarcodeId
                                                , (
                                                    SELECT TOP 1 1 
                                                    FROM MES.OspReceiptDetail x 
                                                    WHERE x.OspDetailId = a.OspDetailId
                                                ) OspReceiptDetail
                                                FROM MES.OspBarcode a
                                                INNER JOIN MES.OspDetail b ON a.OspDetailId = b.OspDetailId 
                                                INNER JOIN MES.OutsourcingProduction c ON b.OspId = c.OspId
                                                INNER JOIN SCM.Supplier d ON c.SupplierId = d.SupplierId
                                                WHERE a.BarcodeNo = @BarcodeNo
                                                AND c.CompanyId = 4
                                                AND d.SupplierNo = '200B0002'
                                                ORDER BY a.CreateDate DESC";
                                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                        var OspBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion

                                        if (OspBarcodeResult.Count() <= 0)
                                        {
                                            #region //確認條碼狀態是否可以領料
                                            if (item4.BarcodeStatus != "8" && item4.BarcodeStatus != "10" && item4.BarcodeStatus != "11")
                                            {
                                                throw new SystemException("此條碼【" + BarcodeNo + "】【目前製令:" + item4.MoId + "】已存在，且狀態【" + item4.StatusName + "】不可重新發料!!");
                                            }
                                            #endregion

                                            #region //確認此條碼所屬入庫單無任何未核單之單據
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 c.MweErpPrefix, c.MweErpNo
                                                    FROM MES.MweBarcode a 
                                                    INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                                                    INNER JOIN MES.MoWarehouseEnry c ON b.MweId = c.MweId
                                                    WHERE a.BarcodeId = @BarcodeId
                                                    AND c.ConfirmStatus != 'Y'";
                                            dynamicParameters.Add("BarcodeId", item4.BarcodeId);

                                            var MweBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                            if (MweBarcodeResult.Count() > 0)
                                            {
                                                foreach (var item in MweBarcodeResult)
                                                {
                                                    throw new SystemException("此條碼【" + BarcodeNo + "】目前尚有入庫單【" + item.MweErpPrefix + "-" + item.MweErpNo + "】未完成核單，無法領料!!");
                                                }
                                            }
                                            #endregion
                                        }

                                        #region //檢查條碼狀態
                                        if (item4.CurrentProdStatus != "P" && item4.CurrentProdStatus != "R" && item4.CurrentProdStatus != "NK" && item4.CurrentProdStatus != "M") throw new SystemException("此條碼【" + BarcodeNo + "】非良品條碼，無法領取!!");
                                        #endregion

                                        #region //檢查此條碼是否已完工狀態
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 d.WoErpPrefix + '-' + d.WoErpNo WoErpFullNo, e.ProcessAlias
                                                FROM MES.BarcodeProcess a 
                                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                                INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                                INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                                INNER JOIN MES.MoProcess e ON a.MoProcessId = e.MoProcessId
                                                WHERE b.BarcodeNo = @BarcodeNo
                                                AND a.FinishDate IS NULL";
                                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (BarcodeProcessResult.Count() > 0)
                                        {
                                            foreach (var item in BarcodeProcessResult)
                                            {
                                                throw new SystemException("此條碼【" + BarcodeNo + "】尚在製令【" + item.WoErpFullNo + "】【" + item.ProcessAlias + "】未完工!!");
                                            }
                                        }
                                        #endregion

                                        #region //後續條碼領料流程

                                        #region //檢查是否為批量條碼未過首站
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT b.BarcodeId
                                                FROM MES.BarcodePrint a
                                                LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                                WHERE a.BarcodeNo = @BarcodeNo";
                                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                        var result4 = sqlConnection.Query(sql, dynamicParameters);

                                        if (result4.Count() > 0)
                                        {
                                            foreach (var item2 in result4)
                                            {
                                                if (item2.BarcodeId == null) throw new SystemException("此條碼【" + BarcodeNo + "】已註冊為批量條碼，無法發料!");
                                            }
                                        }
                                        #endregion

                                        #region //確認當月物料卡控機制
                                        if (MrType == "N")
                                        {
                                            #region //取得舊條碼ERP製令單據日期
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT FORMAT(a.DocDate, 'yyyy-MM') OldDocDate
                                                    FROM MES.WipOrder a 
                                                    INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                                                    WHERE b.MoId = @MoId";
                                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                            dynamicParameters.Add("MoId", MoId);

                                            var OldDocDateResult = sqlConnection.Query(sql, dynamicParameters);

                                            string OldDocDate = "";
                                            foreach (var item in OldDocDateResult)
                                            {
                                                OldDocDate = item.OldDocDate;
                                            }
                                            #endregion

                                            #region //取得現在領料單ERP製令單據日期
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT FORMAT(c.DocDate, 'yyyy-MM') NewDocDate
                                                    FROM MES.MrDetail a 
                                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                                    WHERE a.MrDetailId = @MrDetailId";
                                            dynamicParameters.Add("MrDetailId", MrDetailId);

                                            var NewDocDateResult = sqlConnection.Query(sql, dynamicParameters);

                                            string NewDocDate = "";
                                            foreach (var item in NewDocDateResult)
                                            {
                                                NewDocDate = item.NewDocDate;
                                            }
                                            #endregion

                                            if (OldDocDate != NewDocDate) throw new SystemException("此製令已設定無法領取非當月物料!!");
                                        }
                                        #endregion

                                        #region //UPDAET BARCODE STATUS
                                        int BarcodeStatusRowsAffected = 0;
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode SET
                                                MoId = @MoId,
                                                CurrentMoProcessId = @CurrentMoProcessId,
                                                NextMoProcessId = @NextMoProcessId,
                                                BarcodeQty = @BarcodeQty,
                                                BarcodeStatus = @BarcodeStatus,
                                                CurrentProdStatus = @CurrentProdStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BarcodeNo = @BarcodeNo";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MoId,
                                                CurrentMoProcessId,
                                                NextMoProcessId = CurrentMoProcessId,
                                                item4.BarcodeQty,
                                                BarcodeStatus = MainBarcode == "Y" ? "1" : "3",
                                                CurrentProdStatus = "P",
                                                LastModifiedDate,
                                                LastModifiedBy = UserId,
                                                BarcodeNo
                                            });

                                        BarcodeStatusRowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        if (BarcodeStatusRowsAffected <= 0) throw new SystemException("條碼狀態未被更改成功，請重新操作一次!!");
                                        #endregion

                                        #region //INSERT LOG
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.MrBarcodeTransferLog (MrDetailId, MoId, BarcodeNo, CurrentMoProcessId, NextMoProcessId, CurrentProdStatus, BarcodeStatus
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.LogId
                                                VALUES (@MrDetailId, @MoId, @BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @CurrentProdStatus, @BarcodeStatus
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MrDetailId,
                                                item4.MoId,
                                                BarcodeNo,
                                                item4.CurrentMoProcessId,
                                                item4.NextMoProcessId,
                                                item4.CurrentProdStatus,
                                                item4.BarcodeStatus,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy = UserId,
                                                LastModifiedBy = UserId
                                            });

                                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult2.Count();

                                        if (insertResult2.Count() < 1) throw new SystemException("LOG紀錄新增失敗!!");
                                        #endregion

                                        if (Unit == "PCS" && DecompositionFlag == "N" || DecompositionFlag == "") //因鎢鋼模仁流程，故只能先以單位管控
                                        {
                                            if ((ActualQuantity + item4.BarcodeQty) > Quantity) throw new SystemException("此條碼【" + BarcodeNo + "】數量(" + item4.BarcodeQty + ")已超過未領用量(" + (Quantity - ActualQuantity) + ")");
                                            ActualQuantity += item4.BarcodeQty;
                                        }
                                        #endregion
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //INSERT MES.MrBarcodeRegister
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MrBarcodeRegister (MrDetailId, BarcodeNo
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@MrDetailId, @BarcodeNo
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MrDetailId,
                                        BarcodeNo,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                #endregion

                                #region //更新MrDetail領取套數
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MrDetail SET
                                        ActualQuantity = @ActualQuantity,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MrDetailId = @MrDetailId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ActualQuantity,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        MrDetailId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMrBarcodeReRegister -- 新增物料退料條碼控管資料 -- Ann 2022-12-09
        public string AddMrBarcodeReRegister(int MrDetailId, string BarcodeNo)
        {
            try
            {
                BarcodeNo = BarcodeNo.Trim(); //濾掉空格
                int UserId = CreateBy;

                if (UserId <= 0) throw new SystemException("使用者ID錯誤，請嘗試重新登入!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (BarcodeNo.Length < 0) throw new SystemException("【條碼代碼】不能為空!");
                        if (BarcodeNo.Length > 32) throw new SystemException("【條碼代碼】長度錯誤!");

                        #region //檢查領退料單詳細資料是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ConfirmStatus, a.ActualQuantity, a.MoId, a.Quantity
                                , b.WoErpPrefix, b.WoErpNo
                                , c.DemandRequisitionQty, c.RequisitionQty
                                , d.DecompositionFlag
                                FROM MES.MrDetail a
                                INNER JOIN MES.WipOrder b ON a.WoErpPrefix = b.WoErpPrefix AND a.WoErpNo = b.WoErpNo
                                INNER JOIN MES.WoDetail c ON a.MtlItemId = c.MtlItemId AND c.WoId = b.WoId
                                INNER JOIN MES.MoMtlSetting d ON c.WoDetailId = d.WoDetailId
                                WHERE a.MrDetailId = @MrDetailId";
                        dynamicParameters.Add("MrDetailId", MrDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("領退料單詳細資料有誤!");

                        double ActualQuantity = -1;
                        double Quantity = -1;
                        int MoId = -1;
                        string WoErpPrefix = "";
                        string WoErpNo = "";
                        string DecompositionFlag = "";
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("領退料單已被確認，無法更改!");
                            ActualQuantity = item.ActualQuantity;
                            MoId = item.MoId;
                            WoErpPrefix = item.WoErpPrefix;
                            WoErpNo = item.WoErpNo;
                            Quantity = item.Quantity;
                            DecompositionFlag = item.DecompositionFlag;
                        }
                        #endregion

                        #region //確認條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeStatus, a.BarcodeQty, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.MoId
                                , b.StatusName
                                , (
                                    SELECT TOP 1 1
                                    FROM MES.BarcodeProcess x 
                                    WHERE x.BarcodeId = a.BarcodeId
                                    AND x.FinishDate IS NULL
                                ) BarcodeProcess
                                FROM MES.Barcode a 
                                INNER JOIN BAS.[Status] b ON a.BarcodeStatus = b.StatusNo AND b.StatusSchema = 'Barcode.BarcodeStatus'
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeResult.Count() <= 0) throw new SystemException("條碼【" + BarcodeNo + "】資料錯誤!!");

                        string BarcodeStatus = "";
                        int CurrentMoProcessId = -1;
                        int NextMoProcessId = -1;
                        string CurrentProdStatus = "";
                        int OldMoId = -1;
                        int BarcodeQty = 0;
                        foreach (var item in BarcodeResult)
                        {
                            if (item.BarcodeProcess != null) throw new SystemException("條碼【" + BarcodeNo + "】目前非完工狀態!!");
                            if (item.MoId != MoId) throw new SystemException("條碼【" + BarcodeNo + "】非此製令【" + item.WoErpPrefix + "-" + item.WoErpNo + "】所綁定!!");
                            if ((ActualQuantity + item.BarcodeQty > Quantity) && DecompositionFlag != "Y") throw new SystemException("退料數量已達上限!");
                            if (item.BarcodeStatus == "4") throw new SystemException("條碼【" + BarcodeNo + "】目前尚為上料綁定狀態，請先由上料系統解綁後再進行退料!!");
                            if (item.BarcodeStatus == "8") throw new SystemException("條碼【" + BarcodeNo + "】目前為已入庫狀態，無法退料!!");
                            if (item.BarcodeStatus == "10") throw new SystemException("條碼【" + BarcodeNo + "】目前為已出貨狀態，無法退料!!");
                            BarcodeStatus = item.BarcodeStatus;
                            CurrentMoProcessId = item.CurrentMoProcessId;
                            NextMoProcessId = item.NextMoProcessId;
                            CurrentProdStatus = item.CurrentProdStatus;
                            OldMoId = item.MoId;
                            BarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //判斷 領退料單詳細資料+條碼代碼 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MrBarcodeReRegister
                                WHERE MrDetailId = @MrDetailId
                                AND BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("MrDetailId", MrDetailId);
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("【領退料單詳細資料 + 條碼代碼】重複，請重新輸入!");
                        #endregion

                        #region //INSERT MES.MrBarcodeReRegister
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MrBarcodeReRegister (MrDetailId, BarcodeNo
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@MrDetailId, @BarcodeNo
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MrDetailId,
                                BarcodeNo,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();
                        #endregion

                        #region //更新MrDetail領取套數
                        if (DecompositionFlag == "Y") BarcodeQty = 0;

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MrDetail SET
                                ActualQuantity = @ActualQuantity,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MrDetailId = @MrDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ActualQuantity = ActualQuantity + BarcodeQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                MrDetailId
                            });

                        rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //INSERT MES.MrBarcodeTransferLog
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MrBarcodeTransferLog (MrDetailId, MoId, BarcodeNo, CurrentMoProcessId, NextMoProcessId, CurrentProdStatus, BarcodeStatus
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@MrDetailId, @MoId, @BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @CurrentProdStatus, @BarcodeStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MrDetailId,
                                MoId,
                                BarcodeNo,
                                CurrentMoProcessId,
                                NextMoProcessId,
                                CurrentProdStatus,
                                BarcodeStatus,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //更新MES.Barcode Status
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeStatus = '8',
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              LastModifiedDate,
                              LastModifiedBy,
                              BarcodeNo
                          });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddKeyenceMrBarcodeRegister -- 新增物料條碼控管資料(Keyence模式/包裝條碼模式) -- Ann 2023-05-30
        public string AddKeyenceMrBarcodeRegister(int MrDetailId, string keyenceBarcodeList)
        {
            try
            {
                int UserId = CreateBy;
                int rowsAffected = 0;
                int OldBarcodeCompany = 0;
                string ErpNo = "";
                string ErpDbName = "";
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            if (keyenceBarcodeList.Length < 0) throw new SystemException("【條碼代碼】不能為空!");

                            #region //檢查領退料單詳細資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ConfirmStatus, a.ActualQuantity, a.MoId, a.Quantity, a.Unit
                                    , b.WoErpPrefix, b.WoErpNo
                                    , c.DemandRequisitionQty, c.RequisitionQty
                                    , d.TrayBarcode, d.Source, d.MrType
                                    , e.MtlItemNo, e.MtlItemName
                                    , FORMAT(f.DocDate, 'MM') DocDate
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.WipOrder b ON a.WoErpPrefix = b.WoErpPrefix AND a.WoErpNo = b.WoErpNo
                                    INNER JOIN MES.WoDetail c ON a.MtlItemId = c.MtlItemId AND c.WoId = b.WoId
                                    INNER JOIN MES.MoSetting d ON a.MoId = d.MoId
                                    INNER JOIN PDM.MtlItem e ON c.MtlItemId = e.MtlItemId
                                    INNER JOIN MES.MaterialRequisition f ON f.MrId = a.MrId
                                    WHERE MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單詳細資料有誤!");

                            double ActualQuantity = -1;
                            int MoId = -1;
                            string Unit = "";
                            double DemandRequisitionQty = -1;
                            double RequisitionQty = -1;
                            string TrayBarcode = "";
                            string Source = "";
                            double Quantity = -1;
                            string MtlItemNo = "";
                            string MtlItemName = "";
                            string MrType = "";
                            string DocDate = "";
                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單已被確認，無法更改!");
                                Unit = item.Unit;
                                Quantity = item.Quantity;
                                ActualQuantity = item.ActualQuantity;
                                MoId = item.MoId;
                                TrayBarcode = item.TrayBarcode;
                                Source = item.Source;
                                DemandRequisitionQty = item.DemandRequisitionQty;
                                RequisitionQty = item.RequisitionQty;
                                MtlItemNo = item.MtlItemNo;
                                MtlItemName = item.MtlItemName;
                                MrType = item.MrType;
                                DocDate = item.DocDate;
                                WoErpPrefix = item.WoErpPrefix;
                                WoErpNo = item.WoErpNo;
                            }
                            #endregion

                            #region //確認ERP工單(MOCTA)狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TA011)) Status
                                    FROM MOCTA
                                    WHERE TA001 = @TA001
                                    AND TA002 = @TA002";
                            dynamicParameters.Add("TA001", WoErpPrefix);
                            dynamicParameters.Add("TA002", WoErpNo);
                            var WoErpStatusReesult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item2 in WoErpStatusReesult)
                            {
                                if (item2.Status == "Y" || item2.Status == "y") throw new SystemException("ERP製令狀態無法進行領料!!");
                            }
                            #endregion

                            var BarcodeList = keyenceBarcodeList.Split(',');

                            foreach (var barcode in BarcodeList)
                            {
                                string BarcodeNo = barcode.ToString().ToUpper(); //將條碼強制轉成大寫

                                #region //確認是否為Tray模式
                                if (TrayBarcode == "Y" && Source == "MR")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeNo, a.TrayNo
                                            FROM MES.Tray a
                                            WHERE a.TrayNo = @TrayNo";
                                    dynamicParameters.Add("TrayNo", BarcodeNo);

                                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (TrayResult.Count() < 0) throw new SystemException("查無此Tray盤資訊!");

                                    string TrayNo = "";
                                    foreach (var item in TrayResult)
                                    {
                                        if (item.BarcodeNo == null) throw new SystemException("此Tray盤尚未綁定條碼!");
                                        TrayNo = item.TrayNo;
                                        BarcodeNo = item.BarcodeNo;
                                    }
                                }
                                #endregion


                               
                                MrBarcodeFunction();

                                void MrBarcodeFunction()
                                {
                                    #region //判斷 領退料單詳細資料+條碼代碼 是否重複
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.MrBarcodeRegister
                                            WHERE MrDetailId = @MrDetailId
                                            AND BarcodeNo = @BarcodeNo";
                                    dynamicParameters.Add("MrDetailId", MrDetailId);
                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                    var result2 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result2.Count() > 0) throw new SystemException("【領退料單詳細資料 + 條碼代碼】重複，請重新輸入!");
                                    #endregion

                                    #region //確認此條碼是否已註冊且尚未開工
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.MrBarcodeRegister a
                                            WHERE a.BarcodeNo = @BarcodeNo
                                            AND a.MrDetailId = @MrDetailId";
                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                    dynamicParameters.Add("MrDetailId", MrDetailId);

                                    var MrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (MrBarcodeRegisterResult.Count() > 0) throw new SystemException("此條碼【" + BarcodeNo + "】已綁定!");
                                    #endregion

                                    #region //確認及更改BARCODE資訊

                                    #region //先查詢現在製令首站
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MoProcessId
                                            FROM MES.MoProcess a
                                            WHERE a.MoId = @MoId AND a.SortNumber = 1
                                            AND a.NecessityStatus = 'Y'";
                                    dynamicParameters.Add("MoId", MoId);

                                    var MoProcessIdResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (MoProcessIdResult.Count() <= 0) throw new SystemException("查詢新製令首站時發生錯誤!!");

                                    int CurrentMoProcessId = -1;
                                    foreach (var item3 in MoProcessIdResult)
                                    {
                                        CurrentMoProcessId = item3.MoProcessId;
                                    }
                                    #endregion

                                    #region //查詢此發料條碼是否為新條碼或舊條碼
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MoId, a.BarcodeQty, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                            , b.StatusName
                                            FROM MES.Barcode a
                                            INNER JOIN BAS.[Status] b ON a.BarcodeStatus = b.StatusNo AND b.StatusSchema = 'Barcode.BarcodeStatus'
                                            WHERE a.BarcodeNo = @BarcodeNo";
                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                    var CheckBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion

                                    #region //判斷此料號是否為主條碼及是否為可切割料號
                                    string MainBarcode = "";
                                    string DecompositionFlag = "";
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT d.MainBarcode, d.DecompositionFlag
                                            FROM MES.MrDetail a
                                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                            INNER JOIN MES.WoDetail c ON a.MtlItemId = c.MtlItemId AND c.WoId = b.WoId
                                            INNER JOIN MES.MoMtlSetting d ON c.WoDetailId = d.WoDetailId
                                            WHERE a.MrDetailId = @MrDetailId";
                                    dynamicParameters.Add("MrDetailId", MrDetailId);

                                    var MainBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item3 in MainBarcodeResult)
                                    {
                                        MainBarcode = item3.MainBarcode;
                                        DecompositionFlag = item3.DecompositionFlag;
                                    }
                                    #endregion

                                    if (CheckBarcodeResult.Count() <= 0)
                                    {
                                        #region //新條碼流程

                                        #region //INSERT MES.Barcode
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BarcodeNo,
                                                CurrentMoProcessId,
                                                NextMoProcessId = CurrentMoProcessId,
                                                MoId,
                                                BarcodeQty = 1,
                                                BarcodeProcessId = -1,
                                                CurrentProdStatus = "P",
                                                BarcodeStatus = "1",
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy = UserId,
                                                LastModifiedBy = UserId
                                            });

                                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult2.Count();
                                        #endregion

                                        if (Unit == "PCS" && DecompositionFlag == "N") //因鎢鋼模仁流程，故只能先以單位管控
                                        {
                                            if ((ActualQuantity + 1) > Quantity) throw new SystemException("此條碼數量(1)已超過【" + MtlItemName + "】未領用量(" + (Quantity - ActualQuantity) + ")");
                                            ActualQuantity++;
                                        }

                                        #endregion
                                    }
                                    else
                                    {
                                        #region //舊條碼流程
                                        foreach (var item4 in CheckBarcodeResult)
                                        {
                                            #region //取得條碼公司別
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT c.CompanyId
                                                      FROM MES.Barcode a
                                                           INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
	                                                       INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                                     WHERE a.BarcodeNo = @BarcodeNo";

                                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                            var OldCompanyResult = sqlConnection.Query(sql, dynamicParameters);
                                            if (OldCompanyResult.Count() > 0)
                                            {
                                                foreach (var item in OldCompanyResult)
                                                {
                                                    OldBarcodeCompany = Convert.ToInt32(item.CompanyId);
                                                }
                                            }
                                            else
                                            {
                                                OldBarcodeCompany = CurrentCompany;
                                            }
                                            #endregion

                                            #region //確認條碼狀態是否可以領料
                                            if (OldBarcodeCompany.Equals(CurrentCompany))
                                            {
                                                if (item4.BarcodeStatus != "7" && item4.BarcodeStatus != "8" && item4.BarcodeStatus != "11")
                                                {
                                                    throw new SystemException("此條碼【" + BarcodeNo + "】【目前製令:" + item4.MoId + "】已存在，且狀態【" + item4.StatusName + "】不可重新發料!!");
                                                }
                                            }
                                            else
                                            {
                                                if (item4.BarcodeStatus != "10" && item4.BarcodeStatus != "8")
                                                {
                                                    throw new SystemException("此條碼【" + BarcodeNo + "】【目前製令:" + item4.MoId + "】已存在，且狀態【" + item4.StatusName + "】不可重新發料!!");
                                                }
                                            }
                                            #endregion

                                            #region //後續條碼領料流程

                                            #region //檢查是否為批量條碼未過首站
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT b.BarcodeId
                                                    FROM MES.BarcodePrint a
                                                    LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                                    WHERE a.BarcodeNo = @BarcodeNo";
                                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                            var result4 = sqlConnection.Query(sql, dynamicParameters);

                                            if (result4.Count() > 0)
                                            {
                                                foreach (var item2 in result4)
                                                {
                                                    if (item2.BarcodeId == null) throw new SystemException("此條碼【" + BarcodeNo + "】已註冊為批量條碼，無法發料!");
                                                }
                                            }
                                            #endregion

                                            #region //確認當月物料卡控機制
                                            if (MrType == "N")
                                            {
                                                #region //確認此條碼是否為MR發料模式
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT FORMAT(c.DocDate, 'MM') OriDocDate
                                                        FROM MES.MrBarcodeRegister a
                                                        INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                                        INNER JOIN MES.MaterialRequisition c ON b.MrId = c.MrId
                                                        WHERE a.BarcodeNo = @BarcodeNo AND b.MoId = @MoId";
                                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                                dynamicParameters.Add("MoId", MoId);

                                                var CheckMrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);

                                                foreach (var item in CheckMrBarcodeRegisterResult)
                                                {
                                                    if (item.OriDocDate != DocDate) throw new SystemException("此製令已設定無法領取非當月物料!!");
                                                }
                                                #endregion

                                                #region //確認此條碼是否為批量條碼發料
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT FORMAT(d.DocDate, 'MM') OriDocDate
                                                        FROM MES.BarcodePrint a
                                                        INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                                        INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
                                                        INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                                        WHERE a.BarcodeNo = @BarcodeNo";
                                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                                dynamicParameters.Add("MoId", MoId);

                                                var CheckBarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);

                                                foreach (var item in CheckBarcodePrintResult)
                                                {
                                                    if (item.OriDocDate != DocDate) throw new SystemException("此製令已設定無法領取非當月物料!!");
                                                }
                                                #endregion
                                            }
                                            #endregion

                                            #region //UPDAET BARCODE STATUS
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    MoId = @MoId,
                                                    CurrentMoProcessId = @CurrentMoProcessId,
                                                    NextMoProcessId = @NextMoProcessId,
                                                    BarcodeQty = @BarcodeQty,
                                                    BarcodeStatus = @BarcodeStatus,
                                                    CurrentProdStatus = @CurrentProdStatus,
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE BarcodeNo = @BarcodeNo";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MoId,
                                                    CurrentMoProcessId,
                                                    NextMoProcessId = CurrentMoProcessId,
                                                    item4.BarcodeQty,
                                                    BarcodeStatus = MainBarcode == "Y" ? "1" : "3",
                                                    CurrentProdStatus = "P",
                                                    LastModifiedDate,
                                                    LastModifiedBy = UserId,
                                                    BarcodeNo
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion

                                            #region //INSERT LOG
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.MrBarcodeTransferLog (MrDetailId, MoId, BarcodeNo, CurrentMoProcessId, NextMoProcessId, CurrentProdStatus, BarcodeStatus
                                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                    VALUES (@MrDetailId, @MoId, @BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @CurrentProdStatus, @BarcodeStatus
                                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MrDetailId,
                                                    item4.MoId,
                                                    BarcodeNo,
                                                    item4.CurrentMoProcessId,
                                                    item4.NextMoProcessId,
                                                    item4.CurrentProdStatus,
                                                    item4.BarcodeStatus,
                                                    CreateDate,
                                                    LastModifiedDate,
                                                    CreateBy = UserId,
                                                    LastModifiedBy = UserId
                                                });

                                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                            rowsAffected += insertResult2.Count();
                                            #endregion

                                            if (Unit == "PCS" && DecompositionFlag == "N") //因鎢鋼模仁流程，故只能先以單位管控
                                            {
                                                if ((ActualQuantity + item4.BarcodeQty) > Quantity) throw new SystemException("此條碼【" + BarcodeNo + "】數量(" + item4.BarcodeQty + ")已超過未領用量(" + (Quantity - ActualQuantity) + ")");
                                                ActualQuantity += item4.BarcodeQty;
                                            }
                                            #endregion
                                        }
                                        #endregion
                                    }
                                    #endregion

                                    #region //INSERT MES.MrBarcodeRegister
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.MrBarcodeRegister (MrDetailId, BarcodeNo
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            VALUES (@MrDetailId, @BarcodeNo
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MrDetailId,
                                            BarcodeNo,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion

                                    #region //更新MrDetail領取套數
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.MrDetail SET
                                            ActualQuantity = @ActualQuantity,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE MrDetailId = @MrDetailId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            ActualQuantity,
                                            LastModifiedDate,
                                            LastModifiedBy = UserId,
                                            MrDetailId
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMoWarehouseEnry -- 新增入庫單資料 -- Ted 2022-09-05
        public string AddMoWarehouseEnry(string DocDate, string ReceiptDate, string MweErpPrefix, string Remark, int SupplierId, string ReserveTaxCode
            , string TaxCode, string TaxType, double TaxRate, string ApplyYYMM, string InvoiceType, string DeductType, string UiNo, string InvoiceDate, string InvoiceNo
            , string DepartmentNo, string CurrencyCode, double Exchange, int RowCnt, string SupplierSo, string PaymentTerm, string AutoMaterialBilling, string SupplierPicking
            , int ViewCompanyId)
        {
            try
            {
                if (DocDate.Length <= 0) throw new SystemException("【開單日】不能為空!");
                if (ReceiptDate.Length <= 0) throw new SystemException("【進貨日】不能為空!");
                if (MweErpPrefix.Length <= 0) throw new SystemException("【入庫單單別】不能為空!");
                if (MweErpPrefix == "5902") throw new SystemException("【入庫單】 - 如欲開立5902入庫單,請使用托外生產管理模組開立");
                if (SupplierId <= 0) throw new SystemException("【加工廠商】不能為空!");
                if (TaxCode.Length <= 0) throw new SystemException("【稅別碼】不能為空!");
                if (TaxType.Length <= 0) throw new SystemException("【課稅別】不能為空!");
                if (TaxRate < 0) throw new SystemException("【營業稅率】不能小於0!");
                if (ApplyYYMM.Length < 0) throw new SystemException("【申報年月】不能為空!");
                if (InvoiceType.Length < 0) throw new SystemException("【發票聯數】不能為空!");
                if (DeductType.Length < 0) throw new SystemException("【扣抵區分】不能為空!");
                if (CurrencyCode.Length <= 0) throw new SystemException("【幣別】不能為空!");
                if (Exchange < 0) throw new SystemException("【匯率】不能小於0!");
                if (RowCnt < 0) throw new SystemException("【件數】不能小於0!");
                if (CurrentCompany != 4)
                {
                    if (PaymentTerm.Length <= 0) throw new SystemException("【付款條件】不能為空!");
                }
                if (AutoMaterialBilling.Length <= 0) throw new SystemException("【自動扣料】資料有問題!");
                if (SupplierPicking.Length <= 0) throw new SystemException("【廠供料自動扣料】資料有問題!");

                string FactoryCode = "";//廠別
                string ErpNo = "";//廠別

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();


                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb, ErpNo
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //加工廠商是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 GuiNumber
                                FROM SCM.Supplier
                                WHERE SupplierId = @SupplierId";
                        dynamicParameters.Add("SupplierId", SupplierId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【加工廠商】資料錯誤，請重新輸入!");
                        string GuiNumber = "";
                        foreach (var item in result)
                        {
                            GuiNumber = item.GuiNumber;
                        }
                        if (GuiNumber != UiNo) throw new SystemException("【統一編號】資料錯誤，請重新輸入!");
                        #endregion

                        #region //扣抵區分是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TypeNo FROM BAS.[Type] 
                                WHERE 1=1
                                AND TypeSchema = 'OspReceipt.DeductType'
                                AND TypeNo=@DeductType";
                        dynamicParameters.Add("DeductType", DeductType);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【扣抵區分】資料錯誤，請重新輸入!");
                        #endregion

                        #region //課稅別是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TypeNo FROM BAS.[Type] 
                                WHERE 1=1
                                AND TypeSchema = 'Customer.Taxation'
                                AND TypeNo=@TaxType";
                        dynamicParameters.Add("TaxType", TaxType);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【課稅別】資料錯誤，請重新輸入!");
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //入庫單單別是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT LTRIM(RTRIM(a.MQ001)) MweErpPrefix, LTRIM(RTRIM(a.MQ002)) MweErpPrefixName 
                                FROM CMSMQ a
                                LEFT JOIN CMSMU b ON a.MQ001 = b.MU001 
                                WHERE (a.MQ003 = '59')  
                                AND ((b.MU003 = 'DS' AND a.MQ029 = 'Y')  or a.MQ029 = 'N' )
                                AND a.MQ001 = @MweErpPrefix";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【入庫單單別】資料錯誤，請重新輸入!");
                        #endregion

                        #region //判斷開立日期是否超過結帳日
                        string CloseDateBase = "";
                        string DocDateBase = "";
                        if (DateTime.TryParse(DocDate, out DateTime docDate))
                        {
                            DocDateBase = docDate.ToString("yyyyMMdd");
                        }
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MA013
                                FROM CMSMA ";
                        var resultCloseDate = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultCloseDate)
                        {
                            CloseDateBase = item.MA013;
                        }

                        DateTime docDateBase;
                        DateTime closeDateBase;

                        if (DateTime.TryParseExact(DocDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out docDateBase) &&
                            DateTime.TryParseExact(CloseDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out closeDateBase))
                        {
                            int resultDate = DateTime.Compare(docDateBase, closeDateBase);

                            if (resultDate <= 0)
                            {
                                throw new SystemException("【入庫單】ERP已經結帳,不可以在新增【" + CloseDateBase + "】之前的單據");
                            }
                        }
                        else
                        {
                            throw new SystemException("日期字符串无效，无法比较");
                        }
                        #endregion

                        #region //稅別碼是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(NN001)) TaxNo
                                    FROM CMSNN 
                                    WHERE 1=1
                                    AND NN001=@TaxCode";
                        dynamicParameters.Add("TaxCode", TaxCode);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【稅別碼】資料錯誤，請重新輸入!");
                        #endregion

                        #region //營業稅率是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(NN004)) BusinessTaxRate
                                    FROM CMSNN 
                                    WHERE 1=1
                                    AND NN001=@TaxCode
                                    AND NN004 =@TaxRate";
                        dynamicParameters.Add("TaxCode", TaxCode);
                        dynamicParameters.Add("TaxRate", TaxRate);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【營業稅率】資料錯誤，請重新輸入!");
                        #endregion

                        #region //發票聯數是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(NM001)) InvoiceCountNo
                                    FROM CMSNM a
                                    INNER JOIN CMSNN b ON a.NM001 = b.NN005
                                    WHERE 1=1
                                    AND a.NM001=@InvoiceType
                                    AND b.NN001=@TaxCode";
                        dynamicParameters.Add("InvoiceType", InvoiceType);
                        dynamicParameters.Add("TaxCode", TaxCode);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【發票聯數】資料錯誤，請重新輸入!");
                        #endregion

                        #region //ERP廠別取得
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MB001  
                                            FROM CMSMB";
                        var resultPlant = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultPlant)
                        {
                            FactoryCode = item.MB001;
                        }
                        #endregion

                        #region //費用部門是否存在
                        if (DepartmentNo.Length > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(ME001)) DepartmentNo
                                    FROM CMSME 
                                    WHERE 1=1
                                    AND ME001=@DepartmentNo";
                            dynamicParameters.Add("DepartmentNo", DepartmentNo);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【費用部門】資料錯誤，請重新輸入!");
                        }
                        #endregion

                        #region //幣別是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(MF001)) Currency
                                    FROM CMSMF 
                                    WHERE 1=1
                                    AND MF001=@CurrencyCode";
                        dynamicParameters.Add("CurrencyCode", CurrencyCode);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【幣別】資料錯誤，請重新輸入!");
                        #endregion

                        #region //付款條件是否存在
                        if (CurrentCompany != 4)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(NA002)) PaymentTermNo
                                    FROM CMSNA 
                                    WHERE 1=1
                                    AND NA002=@PaymentTerm";
                            dynamicParameters.Add("PaymentTerm", PaymentTerm);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【付款條件】資料錯誤，請重新輸入!");
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        //品號暫時給亂碼
                        var MweErpNo = BaseHelper.RandomCode(11);
                        int? nullDate = null;
                        //ApplyYYMM = "2023-01";
                        ApplyYYMM = ApplyYYMM.Replace("-", "");


                        #region //判斷單別+單號是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoWarehouseEnry
                                WHERE MweErpPrefix = @MweErpPrefix
                                AND MweErpNo = @MweErpNo
                                AND CompanyId = @CompanyId";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        dynamicParameters.Add("MweErpNo", MweErpNo);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【單別單號】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MoWarehouseEnry (CompanyId, MweErpPrefix, MweErpNo, DocDate, ReceiptDate, FactoryCode, SupplierId, 
                                Remark, PackageQuantity, ReserveTaxCode, QcFlag, FlowStatus,  
                                TaxCode, TaxType, TaxRate, ApplyYYMM, InvoiceType, DeductType, UiNo, InvoiceDate, InvoiceNo, DepartmentNo,
                                CurrencyCode, Exchange, RowCnt, SupplierSo, PaymentTerm, AutoMaterialBilling, SupplierPicking, OrigAmount, OrigPreTaxAmount, 
                                DeductAmount, OrigTax, ReceiptAmount, PretaxAmount, TaxAmount, Quantity, ConfirmUserId,
                                ConfirmStatus, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MweId, INSERTED.MweErpPrefix, INSERTED.MweErpNo, INSERTED.SupplierId
                                VALUES (@CompanyId, @MweErpPrefix, @MweErpNo, @DocDate, @ReceiptDate, @FactoryCode, @SupplierId,
                                @Remark, @PackageQuantity, @ReserveTaxCode, @QcFlag, @FlowStatus,  
                                @TaxCode, @TaxType, @TaxRate, @ApplyYYMM, @InvoiceType, @DeductType, @UiNo, @InvoiceDate, @InvoiceNo, @DepartmentNo,
                                @CurrencyCode, @Exchange, @RowCnt, @SupplierSo, @PaymentTerm, @AutoMaterialBilling, @SupplierPicking, @OrigAmount, @OrigPreTaxAmount,
                                @DeductAmount, @OrigTax, @ReceiptAmount, @PretaxAmount, @TaxAmount, @Quantity, @ConfirmUserId,
                                @ConfirmStatus, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                MweErpPrefix,
                                MweErpNo,
                                DocDate,
                                ReceiptDate = DocDate,
                                FactoryCode,
                                SupplierId,
                                Remark,
                                PackageQuantity = 0,
                                ReserveTaxCode,
                                QcFlag = "N",
                                FlowStatus = 1,
                                TaxCode,
                                TaxType,
                                TaxRate,
                                ApplyYYMM,
                                InvoiceType,
                                DeductType,
                                UiNo,
                                InvoiceDate = InvoiceDate.Length > 0 ? InvoiceDate : null,
                                InvoiceNo,
                                DepartmentNo,
                                CurrencyCode,
                                Exchange,
                                RowCnt,
                                SupplierSo,
                                PaymentTerm = CurrentCompany != 4 ? PaymentTerm : "",
                                AutoMaterialBilling,
                                SupplierPicking,
                                OrigAmount = 0,
                                OrigPreTaxAmount = 0,
                                DeductAmount = 0,
                                OrigTax = 0,
                                ReceiptAmount = 0,
                                PretaxAmount = 0,
                                TaxAmount = 0,
                                Quantity = 0,
                                ConfirmUserId = nullDate,
                                ConfirmStatus = "N",
                                TransferStatus = "N",
                                TransferDate = nullDate,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion

                        if (ViewCompanyId != CurrentCompany) throw new SystemException("頁面公司別與系統後台公司別不相同,請重新登入系統");
                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMweDetail -- 新增入庫單單身資料 -- Ted 2022-09-06
        public string AddMweDetail(int MweId, int MoId, int MtlItemId, int UomId, int InventoryId, string AcceptanceDate
            , int ReceiptQty, int AcceptQty, int AvailableQty, int ScriptQty, int ReturnQty
            , double OrigUnitPrice, double OrigAmount, double OrigDiscountAmt, double ReceiptExpense, double OrigPreTaxAmt
            , double OrigTaxAmt, double PreTaxAmt, double TaxAmt, string DiscountDescription
            , string Remark, string ProjectCode, string ProcessCode
            , string QcStatus, string Overdue, string ReserveTaxCode, string PaymentHold
            , string BarcodeNoY, string BarcodeNoN, string ScrapRegister, string LotNumber, string AvailableDate, string ReCheckDate
            , string BarcodeListAmortizeTtypeY, string IsAmortize, int AmortizeNewCount, string QaResult, int QcRecordId, string OverMsg
            )
        {
            try
            {
                int rowsAffected = 0;
                var ErpNo = "";
                string ErpDbName = "";
                string WoErpPrefix = "";
                string MweErpPrefix = "";
                string WoErpNo = "";
                string NgToDisassembly = "";
                int PlanQty = -1;
                int ReceiptQtyAllMes = 0;
                int QuantityExceeds = 0;
                string AllOutsourcing = "N";
                string NgToBarcode = "";
                string Source = "";
                string MeasureType = "";
                string LotManagement = "";
                if (MweId <= 0) throw new SystemException("【入庫單單頭ID】有問題!");
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                if (MtlItemId <= 0) throw new SystemException("【品號】不能為空!");
                if (UomId <= 0) throw new SystemException("【單位】不能為空!");
                if (InventoryId <= 0) throw new SystemException("【倉庫】不能為空!");
                if (AcceptanceDate.Length <= 0) throw new SystemException("【驗收日期】不能為空!");
                if (ReceiptQty <= 0) throw new SystemException("【進貨數量】不能為空 或 0 或 負數!");
                if (ReceiptQty != (AcceptQty + ScriptQty + ReturnQty)) throw new SystemException("【進貨" +
                    "數量】!= 【驗收數量】+【報廢數量】+【驗退數量】,資料異常請重新確認!");
                if (AcceptQty < 0) throw new SystemException("【驗收數量】不能為空或負數!");
                if (AvailableQty < 0) throw new SystemException("【計價數量】不能為空或負數!");
                if (ScriptQty < 0) throw new SystemException("【報廢數量】不能為負數!");
                if (ReturnQty < 0) throw new SystemException("【驗退數量】不能為負數!");
                if (OrigUnitPrice < 0) throw new SystemException("【加工單價】不能為負數!");
                if (OrigAmount < 0) throw new SystemException("【加工金額】不能為負數!");
                if (OrigDiscountAmt < 0) throw new SystemException("【扣款金額】不能為負數!");
                if (ReceiptExpense < 0) throw new SystemException("【進貨費用】不能為負數!");
                if (OrigPreTaxAmt < 0) throw new SystemException("【原幣未稅金額】不能為負數!");
                if (OrigTaxAmt < 0) throw new SystemException("【原幣稅金額】不能為負數!");
                if (PreTaxAmt < 0) throw new SystemException("【本幣未稅額】不能為負數!");
                if (TaxAmt < 0) throw new SystemException("【本幣稅額】不能為負數!");



                var returnData = new Dictionary<string, object>();

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        List<int> BarcodeIdList = new List<int>();
                        List<int> ScriptBarcodeIdList = new List<int>();
                        int? nulldate = null;
                        string nulldateStr = null;

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷入庫單單頭是否存在 + 撈取單頭進貨日期 + 營業稅 + 匯率
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT  CompanyId, FORMAT(DocDate, 'yyyy-MM-dd') DocDate, FORMAT(ReceiptDate, 'yyyy-MM-dd') ReceiptDate, TaxRate, Exchange, MweErpPrefix, ReConfirmStatus, ConfirmStatus,TransferStatus
                                FROM MES.MoWarehouseEnry
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單資料有問題");
                        string ReceiptDate = "";
                        string DocDate = "";
                        double TaxRate = -1;
                        double Exchange = -1;
                        foreach (var item in result)
                        {
                            if (item.CompanyId != CurrentCompany) throw new SystemException("入庫單單頭公司別與後端資料不相符,請重新登入再繼續操作");
                            if (item.ConfirmStatus == "V") throw new SystemException("該入庫單據已經作廢,不能新增單身");
                            if (item.ConfirmStatus == "Y") throw new SystemException("該入庫單據已經核單,不能新增單身");
                            if (item.TransferStatus == "Y" && item.ReConfirmStatus == "N") throw new SystemException("該入庫單據已經拋轉ERP,不能新增單身");

                            ReceiptDate = item.ReceiptDate;
                            DocDate = item.DocDate;
                            MweErpPrefix = item.MweErpPrefix;
                            TaxRate = Convert.ToDouble(item.TaxRate);
                            Exchange = Convert.ToDouble(item.Exchange);
                        }
                        #endregion

                        #region //判斷製令是否為全委外
                        if (BarcodeNoY != "")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                AllOutsourcing = "Y";
                            }
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcessTransaction a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                AllOutsourcing = "Y";
                            }
                        }
                        #endregion

                        #region //判斷製令資料是否存在
                        int WoId = -1;
                        int ModeId = -1;
                        string LotStatus = "";
                        string ScrapRegisterBase = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MoId,a.Status,b.WoId,b.PlanQty,c.ScrapRegister,c.LotStatus,b.WoErpPrefix,b.WoErpNo,b.CompanyId,a.ModeId
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.WipOrder b on a.WoId = b.WoId
                                INNER JOIN MES.ProdMode c on a.ModeId = c.ModeId
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令資料錯誤或不存在!");
                        string MoStatus = "";
                        foreach (var item in result)
                        {
                            if (item.CompanyId != CurrentCompany) throw new SystemException("欲入庫的資料的公司別與後端資料不相符,請重新登入再繼續操作");
                            MoStatus = item.Status;
                            LotStatus = item.LotStatus;
                            ModeId = item.ModeId;
                        }
                        //if (Status == "F") throw new SystemException("該製令產品已經全數完工，不能做入庫");
                        if (MweErpPrefix == "5903" && AllOutsourcing == "Y")
                        {
                            string NoCheck = "單別為5903且為全委外製成不用檢核";
                        }
                        else
                        {
                            if (MoStatus != "A" && MoStatus != "F") throw new SystemException("該製令未處與開工中狀態，不能做入庫");
                        }
                        foreach (var item in result)
                        {
                            WoErpPrefix = item.WoErpPrefix;
                            WoErpNo = item.WoErpNo;
                            PlanQty = item.PlanQty;
                            WoId = item.WoId;
                            ScrapRegisterBase = item.ScrapRegister;
                        }

                        if (ScrapRegisterBase != ScrapRegister) throw new SystemException("是否要入報廢倉判定,與資料庫資料不相符,請重新確認");
                        #endregion

                        #region //判斷品號資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemId, LotManagement, MeasureType
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId
                                AND TransferStatus = 'Y'";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號資料錯誤或不存在!");
                        foreach (var item in result)
                        {
                            LotManagement = item.LotManagement;
                            if (LotManagement != "N")
                            {
                                if (LotNumber == "") throw new SystemException("入庫品號需要做批號管理,批號欄位不可為空");
                            }
                            else
                            {
                                if (LotNumber != "") throw new SystemException("入庫品號不需要做批號管理,批號欄位不可填寫");
                                AvailableDate = nulldateStr;
                                ReCheckDate = nulldateStr;
                            }
                            MeasureType = item.MeasureType;
                        }
                        #endregion

                        #region //判斷庫別單位資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"
                                SELECT '庫別' AS MissingField
                                WHERE NOT EXISTS (
                                    SELECT 1 FROM SCM.Inventory WHERE InventoryId = @InventoryId
                                )
                                UNION ALL
                                SELECT '單位' AS MissingField
                                WHERE NOT EXISTS (
                                    SELECT 1 FROM PDM.UnitOfMeasure WHERE UomId = @UomId
                                );
                                ";
                        var result1 = sqlConnection.Query<dynamic>(sql, new { InventoryId, UomId });
                        var missing = string.Join("、", result1.Select(r => (string)r.MissingField));
                        if (result1.Any())
                        {
                            throw new SystemException($"以下資料錯誤或不存在：{missing}");
                        }
                        #endregion

                        #region //撈出所有5902託外入庫單據判斷當前可入庫數量
                        dynamicParameters = new DynamicParameters();
                        //檢查用SQL
                        //sql = @"SELECT a.MoId,a.OspId,a.OspDetailId,c.PlanQty,a.OspQty,ISNULL(x.SumAcceptQty,0),a.OspQty - ISNULL(x.SumAcceptQty,0) NotYetQty
                        //        , c.PlanQty - a.OspQty + ISNULL(x.SumAcceptQty,0) CurrentQty
                        //        ,'託外生產單:'+a1.OspNo + '-製令:' + c.WoErpPrefix + '-' + c.WoErpNo + '-製程' + a.ProcessCodeName + ' (尚有 ' +
                        //        CAST(a.OspQty - ISNULL(x.SumAcceptQty, 0) AS VARCHAR) + ' PCS,未做託外入庫單)' AS Remark
                        //        FROM MES.OspDetail a
                        //        INNER JOIN MES.OutsourcingProduction a1 on a.OspId = a1.OspId
                        //        INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                        //        INNER JOIN MES.WipOrder c on b.WoId = c.WoId
                        //        OUTER APPLY(
                        //            SELECT SUM(x1.AcceptQty) SumAcceptQty 
                        //            FROM MES.OspReceiptDetail x1
                        //            WHERE x1.OspDetailId = a.OspDetailId
                        //        ) x
                        //        WHERE 1=1
                        //        AND a.MoId = 38218
                        //        --AND c.WoErpPrefix + '-' +c.WoErpNo = '5101-2025061401'
                        //        AND (x.SumAcceptQty IS NULL OR a.OspQty != x.SumAcceptQty)
                        //        ";
                        sql = @"SELECT c.PlanQty - a.OspQty + ISNULL(x.SumAcceptQty,0) CurrentQty
                                ,'託外生產單:'+a1.OspNo + '-製令:' + c.WoErpPrefix + '-' + c.WoErpNo + '-製程' + a.ProcessCodeName + ' (尚有 ' +
                                CAST(a.OspQty - ISNULL(x.SumAcceptQty, 0) AS VARCHAR) + ' PCS,未做託外入庫單)' AS NotYetRemark
                                FROM MES.OspDetail a
                                INNER JOIN MES.OutsourcingProduction a1 on a.OspId = a1.OspId
                                INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                                INNER JOIN MES.WipOrder c on b.WoId = c.WoId
                                OUTER APPLY(
                                    SELECT SUM(x1.AcceptQty) SumAcceptQty 
                                    FROM MES.OspReceiptDetail x1
                                    WHERE x1.OspDetailId = a.OspDetailId
                                    AND x1.TransferStatus = 'Y'
                                ) x
                                WHERE 1=1
                                AND a.MoId = @MoId AND a1.[Status]='Y'
                                AND (x.SumAcceptQty IS NULL OR a.OspQty != x.SumAcceptQty)
                                ";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        int CurrentQty = -1;
                        string NotYetRemark = "";
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                if (CurrentQty == -1)//第一次放入當前可入庫數量
                                {
                                    CurrentQty = item.CurrentQty;
                                }
                                else
                                {
                                    if (CurrentQty < item.CurrentQty) //取當前可入庫數量最小值
                                    {
                                        CurrentQty = item.CurrentQty;
                                    }
                                }
                                NotYetRemark += "<br>" + item.NotYetRemark;
                            }
                            if (ReceiptQty > CurrentQty)
                            {
                                NotYetRemark = $"當前只能入庫{CurrentQty}PCS<bt>" + NotYetRemark;
                                throw new SystemException(NotYetRemark);
                            }
                        }
                        #endregion

                        #region //判斷製令是否有條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeCtrl,a.OutputBarcodeFlag, a.NgToDisassembly, a.NgToBarcode, a.Source
                                FROM MES.MoSetting a
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        string BarcodeCtrl = "";
                        string OutputBarcodeFlag = "";
                        foreach (var item in result)
                        {
                            BarcodeCtrl = item.BarcodeCtrl;
                            OutputBarcodeFlag = item.OutputBarcodeFlag;
                            NgToDisassembly = item.NgToDisassembly;
                            NgToBarcode = item.NgToBarcode;
                            Source = item.Source;
                        }

                        if (BarcodeCtrl == "Y")
                        {
                            if (BarcodeNoY == "") throw new SystemException("【入庫單】－條碼模式需選取條碼才能入庫，請重新確認");
                        }
                        else if (BarcodeCtrl == "N")
                        {
                            if (OutputBarcodeFlag == "Y")
                            {
                                if (BarcodeNoY == "") throw new SystemException("【入庫單】－數量入庫且有設定產新條碼的模式需選取條碼才能入庫，請重新確認");
                            }
                            else if (OutputBarcodeFlag == "N")
                            {
                                if (BarcodeNoY != "") throw new SystemException("【入庫單】－資料異常:數量入庫且有設定產新條碼的模式不需選取條碼");
                            }
                        }
                        else
                        {
                            throw new SystemException("【入庫單】－是否有產品條碼的狀態錯誤，請重新確認");
                        }
                        #endregion

                        #region //入庫數量驗證
                        int ScriptQtyTrue = 0;
                        int AcceptQtyTrue = 0;
                        if (BarcodeNoY != "") //條碼模式
                        {
                            if (BarcodeCtrl == "Y" && OutputBarcodeFlag == "N")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT BarcodeId,BarcodeNo,CurrentProdStatus,BarcodeStatus,BarcodeQty
                                        FROM MES.Barcode
                                        WHERE 1=1";
                                BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND BarcodeId IN @BarcodeId", BarcodeNoY.Split(','));

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("條碼資料有問題");
                                string AberrantBarcodeList = "";
                                int AberrantBarcodeNum = 0;
                                string IssueStr = "";
                                List<string> IssueList = new List<string>();

                                foreach (var item in result)
                                {
                                    if (item.CurrentProdStatus == "S" && NgToDisassembly == "Y") throw new SystemException("【MES製令設定：NG品可拆解】只能入庫良品條碼!!請重新確認");

                                    #region //判斷系統自動生產的報廢條碼是否有入庫過
                                    if (item.CurrentProdStatus == "S" && NgToBarcode == "N" && Source == "BP")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                                FROM MES.MweBarcode a
                                                WHERE a.BarcodeId = @BarcodeId";
                                        dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() > 0) throw new SystemException("報廢條碼【" + item.BarcodeNo + "】已經入庫過了,請重新確認!!!");
                                    }
                                    #endregion

                                    #region //判斷條碼的領料單是否有領料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT 
                                            CASE 
                                                WHEN a.Source != 'MR' THEN 'P'
                                                ELSE 
                                                    CASE 
                                                        WHEN EXISTS (
                                                            SELECT (ac.MrErpPrefix + '-' + ac.MrErpNo) AS MrFullNo
                                                            FROM MES.MrBarcodeRegister aa 
                                                            INNER JOIN MES.MrDetail ab ON aa.MrDetailId = ab.MrDetailId 
                                                            INNER JOIN MES.MaterialRequisition ac ON ab.MrId = ac.MrId 
                                                            WHERE ab.MoId = a.MoId
                                                            AND aa.BarcodeNo = @BarcodeNo
                                                        )
                                                        THEN 
                                                            CASE 
                                                                WHEN EXISTS (
                                                                    SELECT 1
                                                                    FROM MES.MrBarcodeRegister aa 
                                                                    INNER JOIN MES.MrDetail ab ON aa.MrDetailId = ab.MrDetailId 
                                                                    INNER JOIN MES.MaterialRequisition ac ON ab.MrId = ac.MrId 
                                                                    WHERE ab.MoId = a.MoId
                                                                    AND aa.BarcodeNo = @BarcodeNo
                                                                    AND ab.ConfirmStatus = 'Y'
                                                                ) 
                                                                THEN 'P'
                                                                ELSE (
                                                                    SELECT (ac.MrErpPrefix + '-' +  ac.MrErpNo) AS MrFullNo
                                                                    FROM MES.MrBarcodeRegister aa 
                                                                    INNER JOIN MES.MrDetail ab ON aa.MrDetailId = ab.MrDetailId 
                                                                    INNER JOIN MES.MaterialRequisition ac ON ab.MrId = ac.MrId 
                                                                    WHERE ab.MoId = a.MoId
                                                                    AND aa.BarcodeNo = @BarcodeNo
                                                                )
                                                            END
                                                        ELSE 'P'
                                                    END
                                            END AS MrFullNo
                                        FROM MES.MoSetting a
                                        WHERE a.MoId = @MoId;";
                                    dynamicParameters.Add("BarcodeNo", item.BarcodeNo);
                                    dynamicParameters.Add("MoId", MoId);
                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item1 in result)
                                    {
                                        if (item1.MrFullNo != "P" && !IssueList.Contains(item1.MrFullNo))
                                        {
                                            IssueList.Add(item1.MrFullNo);
                                            IssueStr += "【" + item1.MrFullNo + "】";
                                        }
                                    }
                                    if (IssueList.Count() > 0)
                                    {
                                        continue;
                                    }
                                    #endregion

                                    #region //判斷條碼屬性過站歷程中是否有維護完整
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT x.MoProcessId
                                        ,c.ItemNo,c.ItemValue
                                        ,a.BarcodeId,a.BarcodeNo,a.CurrentProdStatus
                                        ,z.Num
                                        FROM MES.Barcode a
                                        OUTER APPLY(
                                              select x1.MoProcessId FROM MES.BarcodeProcess x1 where x1.BarcodeId = a.BarcodeId AND x1.MoId = a.MoId
                                            ) x
                                        INNER JOIN MES.MoProcessItem b on x.MoProcessId = b.MoProcessId 
                                        LEFT JOIN MES.BarcodeAttribute c on b.ItemNo = c.ItemNo and a.BarcodeId = c.BarcodeId and a.MoId = c.MoId
                                        OUTER APPLY(
                                              select COUNT(z2.MoProcessItemId) Num FROM MES.BarcodeProcess z1 
                                              INNER JOIN MES.MoProcessItem z2 on z1.MoProcessId = z2.MoProcessId
                                              where z1.BarcodeId = a.BarcodeId  AND z1.MoId = a.MoId
                                            ) z
                                        WHERE a.BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", item.BarcodeId);

                                    var resultCheckAttribute = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item2 in resultCheckAttribute)
                                    {

                                        if (item2.CurrentProdStatus != "S")
                                        {
                                            if (item2.ItemNo != null)
                                            {
                                                if (Convert.ToInt32(item2.Num) != resultCheckAttribute.Count())
                                                {
                                                    if (AberrantBarcodeNum == 0)
                                                    {
                                                        AberrantBarcodeList += item.BarcodeNo;
                                                    }
                                                    else
                                                    {
                                                        AberrantBarcodeList += "," + item.BarcodeNo;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                AberrantBarcodeList += "," + item.BarcodeNo;
                                            }
                                        }

                                    }
                                    #endregion

                                    #region //確認此條碼是否有刻字置換資料未確認(鍍鎳站除外)
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.OriBarcodeAttrId, a.NewBarcodeAttrId
                                            , b.[Status]
                                            , (
                                                SELECT TOP 1 1
                                                FROM MES.BarcodeProcess x 
                                                WHERE x.BarcodeId = @BarcodeId
                                                AND x.FinishDate IS NULL
                                            ) CheckBarcodeProcess
                                            FROM MES.BarcodeProcessAttributeLog a 
                                            LEFT JOIN MES.BpalDetail b ON a.ProcessAttrLogId = b.ProcessAttrLogId
                                            WHERE a.NewBarcodeId = @BarcodeId
                                            ORDER BY a.CreateDate DESC";
                                    dynamicParameters.Add("BarcodeId", item.BarcodeId);

                                    var BarcodeProcessAtrLogResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item2 in BarcodeProcessAtrLogResult)
                                    {
                                        if (item2.OriBarcodeAttrId != item2.NewBarcodeAttrId)
                                        {
                                            if (item2.Status != "Y" && item2.CheckBarcodeProcess == null)
                                            {
                                                throw new SystemException("條碼【" + item.BarcodeNo + "】已被置換，請實際執行重新刻字的動作後再進行後續過站!!");
                                            }
                                        }
                                    }
                                    #endregion

                                    #region //判斷條碼是否結束流程
                                    if (item.BarcodeStatus != "7")
                                    {
                                        if (item.BarcodeStatus != "0")
                                        {
                                            if (item.BarcodeStatus == "1")
                                            {
                                                #region //判斷條碼最後一個必要過站是否完成
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TOP 1 1
                                                        FROM MES.Barcode a
                                                        OUTER APPLY (
                                                            SELECT  TOP 1 x.MoProcessId FROM MES.MoProcess x
                                                            WHERE x.MoId = a.MoId
                                                            AND x.NecessityStatus = 'Y'
                                                            ORDER BY SortNumber DESC
                                                        ) x1
                                                        WHERE a.MoId = @MoId
                                                        AND a.BarcodeId = @BarcodeId";
                                                dynamicParameters.Add("MoId", MoId);
                                                dynamicParameters.Add("BarcodeId", item.BarcodeId);

                                                var resultNecessityStatus = sqlConnection.Query(sql, dynamicParameters);
                                                if (resultNecessityStatus.Count() <= 0) throw new SystemException("產品條碼" + item.BarcodeNo + "未完工");
                                                BarcodeIdList.Add(item.BarcodeId);

                                                #endregion
                                            }
                                        }
                                        else
                                        {
                                            #region //判斷完工入庫的條碼必要過站是否都是PASS
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT d.BarcodeNo,d.CurrentProdStatus, c.MoProcessId,c.ProcessAlias,e.ProdStatus,y.PrintStatus
                                                    FROM MES.WipOrder a
                                                    LEFT JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
	                                                LEFT JOIN MES.MoProcess c ON b.MoId = c.MoId
	                                                LEFT JOIN MES.Barcode d ON b.MoId = d.MoId
	                                                LEFT JOIN MES.BarcodeProcess e ON d.BarcodeId = e.BarcodeId AND c.MoProcessId = e.MoProcessId
                                                    OUTER APPLY(
                                                        SELECT y3.PrintStatus
                                                        FROM MES.BarcodeTransfer y1
                                                        INNER JOIN MES.Barcode y2 on y2.BarcodeId =  y1.ToBarcodeId
                                                        INNER JOIN MES.BarcodePrint y3 on y3.BarcodeNo =  d.BarcodeNo
                                                        WHERE y1.ToBarcodeId = d.BarcodeId
                                                    ) y
                                                    WHERE b.MoId = @MoId
                                                    AND d.BarcodeId = @BarcodeId
                                                    AND d.CurrentProdStatus in ('P','M','R')
                                                    AND c.NecessityStatus = 'Y'
                                                    AND e.ProdStatus is null";
                                            dynamicParameters.Add("MoId", MoId);
                                            dynamicParameters.Add("BarcodeId", item.BarcodeId);

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() > 0)
                                            {
                                                string MoProcessNotPass = "";
                                                string BarcodeNo = "";
                                                int num = 0;
                                                foreach (var item1 in result)
                                                {
                                                    if (item1.PrintStatus != "F")
                                                    {
                                                        if (num > 0)
                                                        {
                                                            MoProcessNotPass += ",【" + item1.ProcessAlias + "】";

                                                        }
                                                        else
                                                        {
                                                            MoProcessNotPass += "【" + item1.ProcessAlias + "】";
                                                            BarcodeNo += item1.BarcodeNo;
                                                        }
                                                        num++;
                                                        throw new SystemException("【條碼:" + BarcodeNo + "】過站異常，" + MoProcessNotPass + "為必要站,請完成過站程序!!!");
                                                    }
                                                    else
                                                    {
                                                        BarcodeIdList.Add(item.BarcodeId);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                BarcodeIdList.Add(item.BarcodeId);
                                            }
                                            #endregion
                                        }
                                    }
                                    else
                                    {
                                        BarcodeIdList.Add(item.BarcodeId);
                                    }
                                    #endregion


                                    #region //報廢數量計算 + 判斷庫別是否符合產品應該入的庫別
                                    if (item.CurrentProdStatus == "S")
                                    {
                                        if (ScrapRegister == "Y")
                                        {
                                            switch (CurrentCompany)
                                            {
                                                case 2:
                                                    if (InventoryId != 12) throw new SystemException("該條碼為報廢品!!!該製令設定報廢品要入【待報廢倉】，請入請新選擇");
                                                    break;
                                                case 3:
                                                    if (InventoryId != 129) throw new SystemException("該條碼為報廢品!!!該製令設定報廢品要入【待報廢倉】，請入請新選擇");
                                                    break;
                                                case 4:
                                                    if (InventoryId != 46) throw new SystemException("該條碼為報廢品!!!該製令設定報廢品要入【待報廢倉】，請入請新選擇");
                                                    break;
                                                case 5:
                                                    if (InventoryId != 115) throw new SystemException("該條碼為報廢品!!!該製令設定報廢品要入【待報廢倉】，請入請新選擇");
                                                    break;
                                                default:
                                                    throw new SystemException("公司資料錯誤");
                                                    break;
                                            }
                                            ScriptQtyTrue += item.BarcodeQty;
                                        }
                                        else
                                        {
                                            ScriptQtyTrue += item.BarcodeQty;
                                            ScriptBarcodeIdList.Add(item.BarcodeId);

                                        }
                                    }
                                    else
                                    {
                                        switch (CurrentCompany)
                                        {
                                            case 2:
                                                if (InventoryId == 12) throw new SystemException("該條碼為良品，不能【待報廢倉】");
                                                break;
                                            case 3:
                                                if (InventoryId == 129) throw new SystemException("該條碼為良品，不能【待報廢倉】");
                                                break;
                                            case 4:
                                                if (InventoryId == 46) throw new SystemException("該條碼為良品，不能【待報廢倉】");
                                                break;
                                            case 5:
                                                if (InventoryId == 115) throw new SystemException("該條碼為良品，不能【待報廢倉】");
                                                break;
                                            default:
                                                throw new SystemException("公司資料錯誤");
                                                break;
                                        }
                                        AcceptQtyTrue += item.BarcodeQty;
                                    }
                                    #endregion
                                }
                                if (IssueStr.Length > 0) throw new SystemException(IssueStr + "以上領料單未核單！！！");

                                if (AberrantBarcodeList != "")
                                {
                                    throw new SystemException("產品條碼【" + AberrantBarcodeList + "】屬性沒有維護完整,請重新確認");

                                }
                            }
                            else if (BarcodeCtrl == "N" && OutputBarcodeFlag == "Y")
                            {
                                #region //判斷完工入庫的條碼必要過站是否都是PASS
                                foreach (var item in BarcodeNoY.Split(','))
                                {
                                    BarcodeIdList.Add(Convert.ToInt32(item));
                                }

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT SUM(a.BarcodeQty) BarcodeQty ,a.CurrentProdStatus
                                        FROM MES.Barcode a
                                        WHERE 1=1
                                        AND a.MoId = @MoId
                                        AND a.CurrentProdStatus in ('P','S')
                                        GROUP BY a.CurrentProdStatus";
                                dynamicParameters.Add("MoId", MoId);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("條碼資料有問題");
                                foreach (var item in result)
                                {
                                    if (item.CurrentProdStatus == "P")
                                    {
                                        AcceptQtyTrue = item.BarcodeQty;
                                    }
                                    if (item.CurrentProdStatus == "S")
                                    {
                                        ScriptQtyTrue = item.BarcodeQty;
                                    }
                                }

                                #endregion
                            }
                            else
                            {
                                throw new SystemException("資料異常!!!請洽系統開發室重新確認~~~~~~~~~~");
                            }
                        }
                        else // 數量模式
                        {
                            int EnterMweQty = 0;
                            int EnterPassQty = 0;
                            int EnterScrapQty = 0;

                            #region //撈出該製令下MES入庫數量
                            dynamicParameters = new DynamicParameters();
                            sql = @" SELECT SUM(a.ReceiptQty) ReceiptQty,SUM(a.AcceptQty) AcceptQty,SUM(a.ScriptQty) ScriptQty
                                     FROM MES.MweDetail a
                                     WHERE a.MoId = @MoId
                                     AND a.ConfirmStatus != 'V'";
                            dynamicParameters.Add("MoId", MoId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item in result)
                                {
                                    EnterMweQty = Convert.ToInt32(item.ReceiptQty);
                                    EnterPassQty = Convert.ToInt32(item.AcceptQty);
                                    EnterScrapQty = Convert.ToInt32(item.ScriptQty);
                                }
                            }
                            #endregion

                            if (MweErpPrefix == "5903" && AllOutsourcing == "Y")
                            {
                                //單別為5903且為全委外製成不用檢核
                            }
                            else
                            {
                                #region //撈出該製令下最後一個必要過站
                                dynamicParameters = new DynamicParameters();

                                sql = @" SELECT MAX(c.SortNumber) SortNumber
                                     FROM MES.ManufactureOrder a
                                     INNER JOIN MES.ProdMode b on a.ModeId = b.ModeId
                                     INNER JOIN MES.MoProcess c ON a.MoId = c.MoId
                                     WHERE a.MoId = @MoId
                                     AND c.NecessityStatus = 'Y'";
                                dynamicParameters.Add("MoId", MoId);

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到製令下最後一個必要過站");
                                int SortNumberMax = -1;
                                foreach (var item in result)
                                {
                                    SortNumberMax = item.SortNumber;
                                }
                                #endregion

                                #region //撈出該製令下已經產品完工數量(數量過站)
                                dynamicParameters = new DynamicParameters();

                                sql = @" SELECT TOP 1 c.SortNumber,c.TotalInputQty,c.TotalScrapQty,c.TotalPassQty
                                     FROM MES.ManufactureOrder a
                                     INNER JOIN MES.ProdMode b on a.ModeId = b.ModeId
                                     INNER JOIN MES.MoProcess c ON a.MoId = c.MoId
                                     INNER JOIN MES.MoProcessTransaction d ON c.MoProcessId = d.MoProcessId
                                     WHERE a.MoId = @MoId
                                     AND c.NecessityStatus = 'Y'
                                     AND d.ProdStatus = 'P'
                                     Order By c.SortNumber DESC";
                                dynamicParameters.Add("MoId", MoId);

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到完工數量");
                                int SortNumber = -1;
                                int TotalPassQty = -1;
                                foreach (var item in result)
                                {
                                    SortNumber = item.SortNumber;
                                    TotalPassQty = item.TotalPassQty;
                                }
                                if (SortNumberMax != SortNumber) throw new SystemException("該製令最後一站未生產產品");
                                #endregion

                                #region //撈出該製令下產品報廢數量
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT SUM(a.Quantity) TotalScrapQty
                                        FROM MES.MoProcessTransaction a      
                                        WHERE MoId = @MoId
                                        AND ProdStatus = 'S' ";
                                dynamicParameters.Add("MoId", MoId);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                int TotalScrapQty = -1;
                                foreach (var item in result)
                                {
                                    TotalScrapQty = Convert.ToInt32(item.TotalScrapQty);
                                }
                                #endregion

                                //正式上線切換
                                if (ModeId != 17 || (ModeId == 17 && LotManagement == "N")) //生產模式:鏡片模造 不卡控
                                {
                                    if (AcceptQty > TotalPassQty - EnterPassQty) throw new SystemException("資料錯誤,驗收數欄位輸入的數據不可以大於資料庫紀錄數據");
                                    if (ScriptQty > TotalScrapQty - EnterScrapQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據不可以大於資料庫紀錄數據");
                                }

                                //if (AcceptQty > TotalPassQty - EnterPassQty) throw new SystemException("資料錯誤,驗收數欄位輸入的數據不可以大於資料庫紀錄數據");
                                //if (ScriptQty > TotalScrapQty - EnterScrapQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據不可以大於資料庫紀錄數據");

                                ScriptQtyTrue += ScriptQty;
                                AcceptQtyTrue += AcceptQty;


                            }
                        }

                        #region //判斷頁面欄位與後端計算數量是否相符
                        if ((MweErpPrefix == "5903" && AllOutsourcing == "Y") || QaResult == "Y")
                        {
                            //不需動作
                        }
                        else
                        {
                            if (ScrapRegister == "Y")
                            {
                                switch (CurrentCompany)
                                {
                                    case 2:
                                        if (InventoryId == 12)
                                        {
                                            //if (ScriptQtyTrue  != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                            if ((ScriptQtyTrue - AmortizeNewCount) != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符 ");

                                            if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                        }
                                        break;
                                    case 3:
                                        if (InventoryId == 129)
                                        {
                                            //if (ScriptQtyTrue != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                            if ((ScriptQtyTrue - AmortizeNewCount) != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符  ");
                                            if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                        }
                                        break;
                                    case 4:
                                        if (InventoryId == 46)
                                        {
                                            //if (ScriptQtyTrue != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                            if ((ScriptQtyTrue - AmortizeNewCount) != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符   ");

                                            if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                        }
                                        break;
                                    case 5:
                                        if (InventoryId == 115)
                                        {
                                            //if (ScriptQtyTrue != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                            if ((ScriptQtyTrue - AmortizeNewCount) != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符    ");

                                            if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                        }
                                        break;
                                    default:
                                        throw new SystemException("公司資料錯誤");
                                        break;
                                }
                            }
                            else
                            {
                                int MweBarcodeQtyS = 0;

                                #region //判斷報廢條碼是否有被使用過

                                foreach (var item1 in ScriptBarcodeIdList)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeId,SUM(a.MweBarcodeQty) MweBarcodeQty
                                        FROM MES.MweBarcode a
                                        INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                                        WHERE b.MoId = @MoId
                                        AND a.BarcodeId = @BarcodeId
                                        GROUP BY a.BarcodeId";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("BarcodeId", item1);

                                    var resultMwe = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultMwe.Count() > 0)
                                    {
                                        int MweBarcodeQty = -1;
                                        foreach (var item in resultMwe)
                                        {
                                            MweBarcodeQty = Convert.ToInt32(item.MweBarcodeQty);
                                        }
                                        MweBarcodeQtyS += MweBarcodeQty;
                                    }
                                }
                                #endregion
                                if (BarcodeCtrl == "N" && OutputBarcodeFlag == "Y")
                                {

                                }
                                else
                                {
                                    //if (ScriptQtyTrue != ScriptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                    if ((ScriptQtyTrue + AmortizeNewCount) != ScriptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符     ");
                                    if (AcceptQtyTrue != (AcceptQty + AmortizeNewCount)) throw new SystemException("資料錯誤,驗收數欄位輸入的數據於後端計算不相符      ");
                                    if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                }
                                if (MweBarcodeQtyS > 0)
                                {
                                    ScriptQty = ScriptQty - MweBarcodeQtyS;
                                    ReceiptQty = ScriptQty + AcceptQtyTrue;
                                }
                            }
                        }
                        #endregion

                        #region //檢核今日是否有開立送測單

                        #endregion
                        #endregion

                        #region //金額計算
                        double OrigAmountBackstage = Math.Round(AvailableQty * OrigUnitPrice); //加工金額
                        double OrigPreTaxAmtBackstage = Math.Round(AvailableQty * OrigUnitPrice - OrigDiscountAmt); //原幣未稅金額
                        double OrigTaxAmtBackstage = Math.Round((AvailableQty * OrigUnitPrice - OrigDiscountAmt) * TaxRate); //原幣稅金額
                        double PreTaxAmtBackstage = Math.Round((AvailableQty * OrigUnitPrice - OrigDiscountAmt) * Exchange); //本幣未稅額
                        double TaxAmtBackstage = Math.Round((AvailableQty * OrigUnitPrice - OrigDiscountAmt) * Exchange * TaxRate); //本幣稅額
                        //if (OrigAmountBackstage != OrigAmount) throw new SystemException("【加工金額】前後端計算結果不相符，資料有問題請重新確認");
                        //if (OrigPreTaxAmtBackstage != OrigPreTaxAmt) throw new SystemException("【原幣未稅金額】前後端計算結果不相符，資料有問題請重新確認");
                        //if (OrigTaxAmtBackstage != OrigTaxAmt) throw new SystemException("【原幣稅金額】前後端計算結果不相符，資料有問題請重新確認");
                        //if (PreTaxAmtBackstage != PreTaxAmt) throw new SystemException("【本幣未稅額】前後端計算結果不相符，資料有問題請重新確認");
                        //if (TaxAmtBackstage != TaxAmt) throw new SystemException("【本幣稅額】前後端計算結果不相符，資料有問題請重新確認");


                        if (MeasureType != "0")
                        {
                            if (ReceiptQty != AcceptQty && QcStatus != "3") throw new SystemException("【檢驗類別】檢驗類別應設定為不良，資料有問題請重新確認");
                            if (ReceiptQty == AcceptQty && QcStatus != "2") throw new SystemException("【檢驗類別】檢驗類別應設定為合格，資料有問題請重新確認");
                        }
                        else
                        {
                            if (QcStatus != "0") throw new SystemException("【檢驗類別】品號檢驗方式為免檢，故檢驗類別因設定免檢，資料有問題請重新確認");
                        }

                        //string QcStatusBackstage = "";
                        //if (QcStatus != "0")
                        //{
                        //    if (ScriptQty > 0 || ReturnQty > 0)
                        //    {
                        //        QcStatusBackstage = "3";
                        //    }
                        //    else if (AcceptQty > 0 && ScriptQty == 0 && ReturnQty == 0)
                        //    {
                        //        QcStatusBackstage = "2";
                        //    }
                        //    else if (AcceptQty == 0 && ScriptQty == 0 && ReturnQty == 0)
                        //    {
                        //        QcStatusBackstage = "1";
                        //    }
                        //}
                        //if (ScrapRegister == "Y")
                        //{
                        //    switch (CurrentCompany)
                        //    {
                        //        case 2:
                        //            if (InventoryId == 12)
                        //            {
                        //            }
                        //            break;
                        //        case 3:
                        //            if (InventoryId == 129)
                        //            {
                        //            }
                        //            break;
                        //        case 4:
                        //            if (InventoryId == 46)
                        //            {
                        //            }
                        //            break;
                        //        case 5:
                        //            if (InventoryId == 115)
                        //            {
                        //            }
                        //            break;
                        //        default:
                        //            throw new SystemException("公司資料錯誤");
                        //            break;
                        //    }
                        //}
                        //else
                        //{
                        //    if (QcStatusBackstage != QcStatus) throw new SystemException("【檢驗類別】前後端計算結果不相符，資料有問題請重新確認");
                        //}
                        #endregion

                        #region //新增單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MweDetail (MweId, MweSeq, MoId, MtlItemId, UomId, InventoryId, AvailableDate, ReCheckDate, 
                                AcceptanceDate, AcceptQty, AvailableQty, ScriptQty, ReturnQty, ReceiptQty, OrigUnitPrice, OrigAmount, 
                                OrigDiscountAmt, ReceiptExpense, OrigPreTaxAmt, OrigTaxAmt, PreTaxAmt, TaxAmt, DiscountDescription, Remark, 
                                LotNumber, ProjectCode, ProcessCode, QcStatus, Overdue, ReserveTaxCode, PaymentHold, TransferStatus, 
                                ConfirmUserId, ConfirmStatus, ReturnCode, CloseStatus, ReNewStatus, CostEntry, ExpenseEntry, ApproveStatus, 
                                ReceiptPackageQty, AcceptancePackageQty, VoucherPayablePrefix, VoucherPayableNo, VoucherPayableSeq, 
                                LabelStatus, QcRecordId, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy, IsAmortize
                                )
                                OUTPUT INSERTED.MweDetailId,INSERTED.MtlItemId
                                VALUES (@MweId, @MweSeq, @MoId, @MtlItemId, @UomId, @InventoryId, @AvailableDate, @ReCheckDate,
                                @AcceptanceDate, @AcceptQty, @AvailableQty, @ScriptQty, @ReturnQty, @ReceiptQty, @OrigUnitPrice, @OrigAmount,
                                @OrigDiscountAmt, @ReceiptExpense, @OrigPreTaxAmt, @OrigTaxAmt, @PreTaxAmt, @TaxAmt, @DiscountDescription, @Remark,
                                @LotNumber, @ProjectCode, @ProcessCode, @QcStatus, @Overdue, @ReserveTaxCode, @PaymentHold, @TransferStatus, 
                                @ConfirmUserId, @ConfirmStatus, @ReturnCode, @CloseStatus, @ReNewStatus, @CostEntry, @ExpenseEntry, @ApproveStatus, 
                                @ReceiptPackageQty, @AcceptancePackageQty, @VoucherPayablePrefix, @VoucherPayableNo, @VoucherPayableSeq,
                                @LabelStatus, @QcRecordId, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy, @IsAmortize
                                )";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MweId,
                                MweSeq = "",
                                MoId,
                                MtlItemId,
                                UomId,
                                InventoryId,
                                AvailableDate,
                                ReCheckDate,
                                AcceptanceDate,
                                AcceptQty = QaResult != "Y" ? AcceptQty : 0,
                                AvailableQty,
                                ScriptQty = QaResult != "Y" ? ScriptQty : AcceptQty + ScriptQty,
                                ReturnQty,
                                ReceiptQty,
                                OrigUnitPrice,
                                OrigAmount = OrigAmountBackstage,
                                OrigDiscountAmt = OrigDiscountAmt,
                                ReceiptExpense,
                                OrigPreTaxAmt = OrigPreTaxAmtBackstage,
                                OrigTaxAmt = OrigTaxAmtBackstage,
                                PreTaxAmt = PreTaxAmtBackstage,
                                TaxAmt = TaxAmtBackstage,
                                DiscountDescription,
                                Remark,
                                LotNumber,
                                ProjectCode,
                                ProcessCode = ProcessCode.Length > 0 ? ProcessCode : "****",
                                QcStatus,
                                Overdue = Overdue == "Y" ? Overdue : "N",
                                ReserveTaxCode,
                                PaymentHold,
                                TransferStatus = "N",
                                ConfirmUserId = nulldate,
                                ConfirmStatus = "N",
                                ReturnCode = "N",
                                CloseStatus = "N",
                                ReNewStatus = "N",
                                CostEntry = "N",
                                ExpenseEntry = "N",
                                ApproveStatus = "N",
                                ReceiptPackageQty = 0,
                                AcceptancePackageQty = 0,
                                VoucherPayablePrefix = nulldate,
                                VoucherPayableNo = nulldate,
                                VoucherPayableSeq = nulldate,
                                LabelStatus = "S",
                                QcRecordId,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy,
                                IsAmortize
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int MweDetailId = 0;
                        foreach (var item in insertResult)
                        {
                            MweDetailId = item.MweDetailId;
                            returnData["MweDetailId"] = item.MweDetailId;
                            returnData["MtlItemId"] = item.MtlItemId;

                        }
                        rowsAffected += insertResult.Count();
                        #endregion

                        #region //目前該入庫單的總金額計畫
                        double OrigAmountAll = 0;
                        double OrigDiscountAmtAll = 0;
                        double ReceiptExpenseAll = 0;
                        double OrigPreTaxAmtAll = 0;
                        double OrigTaxAmtAll = 0;
                        double PreTaxAmtAll = 0;
                        double TaxAmtAll = 0;
                        double AcceptQtyAllBase = 0;
                        dynamicParameters = new DynamicParameters();
                        sql = @" SELECT SUM(a.OrigAmount) OrigAmountAll, SUM(a.OrigDiscountAmt) OrigDiscountAmtAll, SUM(a.ReceiptExpense) ReceiptExpenseAll
                                 ,SUM(a.OrigPreTaxAmt) OrigPreTaxAmtAll,                                                                                                                                                                                                                       SUM(a.OrigTaxAmt) OrigTaxAmtAll
                                 ,SUM(a.PreTaxAmt) PreTaxAmtAll, SUM(a.TaxAmt) TaxAmtAll, SUM(a.AcceptQty) AcceptQtyAll
                                 FROM MES.MweDetail a 
                                 WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                OrigAmountAll = item.OrigAmountAll;
                                OrigDiscountAmtAll = item.OrigDiscountAmtAll;
                                ReceiptExpenseAll = item.ReceiptExpenseAll;
                                OrigPreTaxAmtAll = item.OrigPreTaxAmtAll;
                                OrigTaxAmtAll = item.OrigTaxAmtAll;
                                PreTaxAmtAll = item.PreTaxAmtAll;
                                TaxAmtAll = item.TaxAmtAll;
                                AcceptQtyAllBase = item.AcceptQtyAll;
                            }
                        }
                        #endregion

                        #region //撈取目前最新驗收日帶入托外進貨日
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT FORMAT(MAX(a.AcceptanceDate), 'yyyy-MM-dd') MaxAcceptanceDate
                                FROM MES.MweDetail a
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單資料錯誤!");
                        string MaxAcceptanceDate = "";
                        foreach (var item in result)
                        {
                            MaxAcceptanceDate = item.MaxAcceptanceDate;
                        }

                        DateTime dateA = DateTime.Parse(DocDate);
                        DateTime dateB = DateTime.Parse(MaxAcceptanceDate);
                        if (dateA > dateB)
                        {
                            throw new SystemException("資料異常:單身驗收日不可以小於單據日!!");
                        }
                        #endregion

                        #region //將金額回寫單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoWarehouseEnry SET
                                ReceiptDate = @ReceiptDate,
                                OrigAmount = @OrigAmountAll,
                                OrigPreTaxAmount = @OrigPreTaxAmtAll,
                                DeductAmount = @OrigDiscountAmtAll,
                                OrigTax = @OrigTaxAmtAll,
                                ReceiptAmount = @ReceiptExpenseAll,
                                PretaxAmount = @PreTaxAmtAll,
                                TaxAmount = @TaxAmtAll,
                                Quantity = @AcceptQtyAllBase,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ReceiptDate = MaxAcceptanceDate,
                                OrigAmountAll,
                                OrigPreTaxAmtAll,
                                OrigDiscountAmtAll,
                                OrigTaxAmtAll,
                                ReceiptExpenseAll,
                                PreTaxAmtAll,
                                TaxAmtAll,
                                AcceptQtyAllBase,
                                LastModifiedDate,
                                LastModifiedBy,
                                MweId
                            });
                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //入庫條碼寫入資料庫 +更新條碼狀態
                        if (BarcodeNoY != "")
                        {
                            var insertResult1 = "";
                            string errOsp = "";

                            foreach (var item in BarcodeIdList)
                            {
                                #region //撈取條碼數量
                                int BarcodeQty = 0;
                                int NextMoProcessId = 0;
                                string BarcodeStatus = "";
                                string BarcodeCurrentProdStatus = "";

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeQty,a.CurrentProdStatus,a.NextMoProcessId,a.BarcodeStatus
                                        FROM MES.Barcode a
                                        WHERE a.BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", item);
                                var resultBarcodeQty = sqlConnection.Query(sql, dynamicParameters);
                                if (resultBarcodeQty.Count() > 0)
                                {
                                    foreach (var item1 in resultBarcodeQty)
                                    {
                                        BarcodeCurrentProdStatus = item1.CurrentProdStatus;
                                        BarcodeQty = item1.BarcodeQty;
                                        NextMoProcessId = item1.NextMoProcessId;
                                        BarcodeStatus = item1.BarcodeStatus;

                                    }
                                    if (BarcodeCurrentProdStatus != "S")
                                    {
                                    }
                                    else
                                    {
                                        int MweBarcodeQtyS = 0;

                                        #region //判斷報廢條碼是否有被使用過
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeId,SUM(a.MweBarcodeQty) MweBarcodeQty
                                                FROM MES.MweBarcode a
                                                INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                                                WHERE b.MoId = @MoId
                                                AND a.BarcodeId = @BarcodeId
                                                GROUP BY a.BarcodeId";
                                        dynamicParameters.Add("MoId", MoId);
                                        dynamicParameters.Add("BarcodeId", item);

                                        var resultMwe = sqlConnection.Query(sql, dynamicParameters);
                                        if (resultMwe.Count() > 0)
                                        {
                                            int MweBarcodeQty = -1;
                                            foreach (var item2 in resultMwe)
                                            {
                                                MweBarcodeQty = Convert.ToInt32(item2.MweBarcodeQty);
                                            }
                                            BarcodeQty = BarcodeQty - MweBarcodeQty;
                                        }
                                        #endregion
                                    }
                                }
                                else
                                {
                                    throw new SystemException("有問題但我懶得想了請回報");
                                }
                                #endregion

                                #region //撈出所有5902託外入庫單據
                                dynamicParameters = new DynamicParameters();
                                sql = @"
                                        SELECT a.BarcodeNo,x.TransferStatus 
                                        FROM MES.Barcode a
                                        OUTER APPLY(
                                            SELECT TOP 1
                                             CASE 
                                                WHEN x1.OspBarcodeId is not null AND  x4.TransferStatus is null THEN 'N'
                                                WHEN x1.OspBarcodeId is not null AND  x4.TransferStatus = 'N' THEN 'N'
                                                WHEN x1.OspBarcodeId is not null AND  x4.TransferStatus = 'Y' THEN 'Y'
                                                WHEN x1.OspBarcodeId is null AND  x4.TransferStatus is null  THEN 'Y'
                                            END TransferStatus
                                            FROM MES.OspBarcode x1
                                            INNER JOIN MES.OspDetail x2 on x1.OspDetailId = x2.OspDetailId
                                            LEFT JOIN MES.OspReceiptBarcode x3 on x1.OspBarcodeId =x3.OspBarcodeId
                                            LEFT JOIN MES.OspReceiptDetail x4 on x3.OsrDetailId =x4.OsrDetailId
                                            WHERE x2.MoId =@MoId
                                            AND x1.BarcodeNo = a.BarcodeNo
                                            ORDER BY x4.TransferStatus ASC
                                        ) x
                                        WHERE a.BarcodeId = @BarcodeId
                                        AND a.MoId = @MoId    
                                        ";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("BarcodeId", item);

                                var resultOsp = sqlConnection.Query(sql, dynamicParameters);
                                if (resultOsp.Count() > 0)
                                {
                                    foreach (var item2 in resultOsp)
                                    {
                                        if (item2.TransferStatus == "N")
                                        {
                                            errOsp += "," + item2.BarcodeNo;
                                        }
                                    }
                                }
                                if (errOsp.Length > 0)
                                {
                                    continue;
                                }

                                #endregion


                                #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改8
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.BarcodeComponent a 
                                        INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                        WHERE a.AssemblyBarcodeId = @BarcodeId
                                        AND b.MoId = @MoId";
                                dynamicParameters.Add("BarcodeId", item);
                                dynamicParameters.Add("MoId", MoId);
                                var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                if (resultComponent.Count() > 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"update MES.Barcode  SET  
                                            BarcodeStatus = @BarcodeStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            FROM  MES.Barcode a 
                                            INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                            WHERE b.AssemblyBarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeStatus = "8",
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            BarcodeId = item
                                        });
                                    insertResult1 += sqlConnection.Query(sql, dynamicParameters);
                                }
                                #endregion

                                string[] amortizeList = BarcodeListAmortizeTtypeY.Split(',');
                                var amortizetype = "";
                                int itemindex = Array.IndexOf(amortizeList, item.ToString());

                                if (amortizeList.Contains(item.ToString()))
                                {
                                    amortizetype = "Y";
                                }
                                else
                                {
                                    amortizetype = "N";
                                }

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MweBarcode (MweDetailId, BarcodeId, MweBarcodeQty, SourceType, 
                                        NextMoProcessId, BarcodeStatus, AmortizeTtype, QaResult,
                                        CreateDate, LastModifiedDate, CreateBy,LastModifiedBy)
                                        OUTPUT INSERTED.MweBarcodeId
                                        VALUES (@MweDetailId, @BarcodeId, @MweBarcodeQty, @SourceType, 
                                        @NextMoProcessId, @BarcodeStatus, @AmortizeTtype, @QaResult,
                                        @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MweDetailId,
                                        BarcodeId = item,
                                        MweBarcodeQty = BarcodeQty,
                                        SourceType = "MA",
                                        NextMoProcessId,
                                        BarcodeStatus,
                                        AmortizeTtype = amortizetype,
                                        QaResult = BarcodeCurrentProdStatus == "P" && QaResult == "Y" ? "Y" : "N",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                insertResult1 += sqlConnection.Query(sql, dynamicParameters);

                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        BarcodeStatus = @BarcodeStatus,
                                        CurrentProdStatus = @CurrentProdStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeStatus = "8",
                                        CurrentProdStatus = QaResult != "Y" ? BarcodeCurrentProdStatus : "S",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        BarcodeId = item
                                    });
                                insertResult1 += sqlConnection.Query(sql, dynamicParameters);
                            }

                            if (errOsp.Length > 0)
                            {
                                errOsp = errOsp.Substring(1);
                                throw new SystemException("【" + errOsp + "】以上條碼有開立託外生產單,尚未開立所對應的託外入庫單,或是其所對應的託外單未拋轉ERP!!");
                            }
                        }


                        #endregion

                        #region //取得製令目前入庫總數
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT SUM(a.ReceiptQty) ReceiptQtyAllMes 
                                FROM MES.MweDetail a
                                INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                                WHERE b.MoId = @MoId
                                AND a.ConfirmStatus != 'V'";
                        dynamicParameters.Add("MoId", MoId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                if (item.ReceiptQtyAllMes == null)
                                {
                                    ReceiptQtyAllMes = 0;
                                }
                                else
                                {
                                    ReceiptQtyAllMes = item.ReceiptQtyAllMes;
                                }
                            }
                        }
                        else
                        {
                            ReceiptQtyAllMes = 0;
                        }
                        #endregion



                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        List<string> caseNumList = new List<string>();


                        #region //判斷ERP製令是否已經完工
                        string WoStatus = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TA011
                                FROM MOCTA a
                                WHERE TA001 = @WoErpPrefix
                                AND TA002 = @WoErpNo";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);

                        var moctaResult = sqlConnection.Query(sql, dynamicParameters);

                        if (moctaResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in moctaResult)
                        {
                            WoStatus = item.TA011;
                            if (WoStatus == "Y" || WoStatus == "y") throw new SystemException("製令已經結案不可以再入庫!");

                        }
                        #endregion

                        #region //判斷生產數量是否超過領料單可生產數量

                        #region //撈取單據缺領設定
                        string PickingListOutSet = "";
                        string PickingListInSet = "";
                        string WarnMessage = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MQ055,MQ056
                                FROM CMSMQ 
                                WHERE MQ001=@MweErpPrefix";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        var resultSetting1 = sqlConnection.Query(sql, dynamicParameters);
                        if (resultSetting1.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                        foreach (var item1 in resultSetting1)
                        {
                            PickingListOutSet = item1.MQ055;
                            PickingListInSet = item1.MQ056;
                        }
                        #endregion

                        #region //撈出該製令下材料領料單全部領料數並計算出目前可入庫的最大產品套數
                        dynamicParameters = new DynamicParameters();
                        Double MakeNum = 0;
                        int num = 0;

                        #region //獲取ERP單據的材料和須領用量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(TB003)) TB003,SUM(TB004) TB004
                                FROM MOCTB 
                                WHERE TB001=@WoErpPrefix
                                AND TB002 =@WoErpNo
                                AND TB018 ='Y'
                                AND TB011 !=3
                                AND TB011 !=4
                                AND TB004 !=0
                                GROUP BY TB003";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                        foreach (var item in result)
                        {
                            string caseArr = Convert.ToString(item.TB004) + "," + item.TB003;
                            caseNumList.Add(caseArr);
                        }
                        #endregion

                        string MineMtlItemNo = "";
                        foreach (var item in caseNumList)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TE027,sum(a.TE005*b.MQ010*-1) NumSet
                                    FROM MOCTE a
                                    INNER JOIN CMSMQ b on a.TE001 =b.MQ001 
                                    WHERE a.TE011=@WoErpPrefix
                                    AND a.TE012 =@WoErpNo
                                    AND a.TE027 =@MtlItemNo
                                    AND a.TE019 ='Y'
                                    Group by a.TE027";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);
                            dynamicParameters.Add("MtlItemNo", item.Split(',')[1]);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                Double NumSet = 0;
                                foreach (var item1 in result)
                                {
                                    NumSet = Convert.ToDouble(item1.NumSet);
                                }
                                Double MaterialMtlItemNoNum = Convert.ToDouble(item.Split(',')[0]);
                                Double RatioOfMaterials = Math.Round(Convert.ToDouble(PlanQty / (MaterialMtlItemNoNum / NumSet)), 2);
                                RatioOfMaterials = RatioOfMaterials > 0 ? Math.Floor(RatioOfMaterials) : Math.Ceiling(RatioOfMaterials);
                                if (num == 0)
                                {
                                    MakeNum = RatioOfMaterials;
                                    MineMtlItemNo = item.Split(',')[1];
                                }
                                else
                                {
                                    //這段意思是 如果該品號是多種材料組成的 會以 可領的最小套數當最大套數
                                    if (MakeNum > RatioOfMaterials)
                                    {
                                        MakeNum = RatioOfMaterials;
                                        MineMtlItemNo = item.Split(',')[1];
                                    }
                                }
                                num++;
                            }
                            else
                            {
                                #region //判斷入庫數是否有超過領料套數
                                switch (PickingListOutSet)
                                {
                                    case "Y":
                                        WarnMessage += "【入庫單】－材料:" + item.Split(',')[1] + "未領取,不能入庫<br>";
                                        break;
                                }
                                #endregion
                            }

                        }
                        if (WarnMessage != "") throw new SystemException(WarnMessage);

                        #endregion

                        #region //ERP撈出該製令下已入庫產品數量(核單)
                        int ReceiptQtyAllERP = 0;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(sum(TI007),0) ReceiptQtyAllERP,ISNULL(sum(TI019),0) TINUM1, ISNULL(sum(TI021),0) TINUM2
                                FROM MOCTI 
                                WHERE TI013=@WoErpPrefix
                                AND TI014 =@WoErpNo
                                AND TI001 != '5902'
                                AND TI037 !='V'";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);
                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                        if (result1.Count() <= 0) throw new SystemException("找不到該製令入庫的單身!");
                        foreach (var item in result1)
                        {
                            ReceiptQtyAllERP = Convert.ToInt32(item.ReceiptQtyAllERP);
                        }
                        #endregion

                        #region //判斷入庫數是否有超過領料套數
                        switch (PickingListOutSet)
                        {
                            case "Y":
                                if (ReceiptQtyAllMes > MakeNum) throw new SystemException("【單據設定控制缺領】領料單可生產套數為" + MakeNum + "; 欲入庫數量已超過,領料不足!!!!!!!! 目前套數領料最低品號為" + MineMtlItemNo);
                                break;
                            case "N":
                                if (MakeNum < ReceiptQtyAllMes) WarnMessage = "【單據設定不控制缺領】生產數量超過領料單可生產數量,領料不足!!!!!!!!";
                                break;
                            case "W":
                                if (MakeNum < ReceiptQtyAllMes) WarnMessage = "【單據設定警告缺領】生產數量超過領料單可生產數量,領料不足!";
                                break;
                        }
                        if (PlanQty < ReceiptQtyAllMes)
                        {
                            switch (PickingListInSet)
                            {
                                case "Y":
                                    if (WoStatus == "Y") throw new SystemException("ERP製令已經完工了!請重新確認!!");
                                    OverMsg = "P";

                                    //throw new SystemException("【入庫單】－目前單據單別不可以超入!!");
                                    break;
                                case "N":
                                    WarnMessage = "【單據設定不控制超入】生產數量超過製令預計產量!!!!!!!!";
                                    if (OverMsg != "P")
                                    {
                                        OverMsg = "N";
                                    }
                                    break;
                                case "W":
                                    WarnMessage = "【單據設定警告超入】生產數量超過製令預計產量!!!!";
                                    if (OverMsg != "P")
                                    {
                                        OverMsg = "N";
                                    }
                                    break;
                            }

                        }
                        else
                        {
                            OverMsg = "P";
                        }

                        returnData["OverMsg"] = OverMsg;

                        #endregion

                        #endregion

                        if (MweErpPrefix == "5903" && AllOutsourcing == "Y")
                        {
                            //單別為5903且為全委外製成不用檢核
                        }
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)",
                        data = returnData
                    });
                    #endregion

                    if (OverMsg == "P")
                    {
                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMweToERP -- 新增入庫單拋轉ERP -- Shintokuro 2023-01-12
        public string AddMweToERP(int MweId = -1)
        {
            try
            {
                List<MOCTH> mocths = new List<MOCTH>();
                List<MOCTI> moctis = new List<MOCTI>();

                List<string> seqList = new List<string>();
                List<string> ErpNoFullList = new List<string>();
                List<int> MoIdList = new List<int>();

                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string dateNowMonth = DateTime.Now.ToString("yyyyMM");

                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                //int userId = BaseHelper.CurrentUser();
                string userNo = "";
                int Quantity = 0;
                int TotalScrapQty = 0;

                string MweErpPrefix = "";
                string MweErpNo = "";
                string TransferStatusBase = "";
                string WoErpPrefix = "";
                string WoErpNo = "";

                int rowsAffected = 0;
                var ErpNo = "";
                string ErpDbName = "";
                string USR_GROUP = "";
                string ReceiptDate = "";
                int? QuantityBase = 0;
                int CompanyIdBase = -1;

                string ReceiptDateErp = "";
                string docDate = "";
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //取得MES.MoWarehouseEnry(MOCTH)
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.MweId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.MweErpPrefix TH001, a.MweErpNo TH002, FORMAT(a.DocDate, 'yyyyMMdd') TH029, FORMAT(a.ReceiptDate, 'yyyyMMdd') TH003 ,a.ReceiptDate, a.FactoryCode TH004
                              , a.SupplierId, a.Remark TH010, a.PackageQuantity TH034, a.ReserveTaxCode TH037, a.QcFlag TH061,a.TaxCode TH044,a.TaxType TH015,a.TaxRate TH030
                              ,a.ApplyYYMM TH028,a.InvoiceType TH012,a.DeductType TH016,a.UiNo TH011, FORMAT(a.InvoiceDate, 'yyyyMMdd') TH013,a.InvoiceNo TH014,a.DepartmentNo UDF01,a.CurrencyCode TH007
                              ,a.Exchange TH008,a.RowCnt TH009,a.SupplierSo TH006,a.PaymentTerm TH033,a.AutoMaterialBilling TH026,a.SupplierPicking TH035,a.OrigAmount TH018
                              ,a.OrigPreTaxAmount TH027,a.DeductAmount TH019,a.OrigTax TH020,a.ReceiptAmount TH021,a.PretaxAmount TH031,a.TaxAmount TH032,a.Quantity TH022
                              , a.ConfirmStatus TH023,a.TransferStatus,a.CompanyId
                              , b.SupplierNo TH005";
                        sqlQuery.mainTables =
                            @"FROM MES.MoWarehouseEnry a
                              INNER JOIN SCM.Supplier b ON a.SupplierId = b.SupplierId
                              INNER JOIN BAS.[User] c ON a.CreateBy = c.UserId";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = "";

                        mocths = BaseHelper.SqlQuery<MOCTH>(sqlConnection, dynamicParameters, sqlQuery);
                        if (mocths.Count() <= 0) throw new SystemException("入庫單資料有誤!");
                        foreach (var item in mocths)
                        {
                            MweErpPrefix = item.TH001;
                            MweErpNo = item.TH002;
                            QuantityBase = Convert.ToInt32(item.TH022);
                            TransferStatusBase = item.TransferStatus;
                            CompanyIdBase = item.CompanyId;
                            ReceiptDate = item.ReceiptDate;
                            ReceiptDateErp = item.TH003;
                        }
                        if (CompanyIdBase != CurrentCompany) throw new SystemException("使用者公司別與單據公司別不同，請嘗試重新登入!!");

                        #endregion

                        #region //取得MES.MweDetail(MOCTI)
                        dynamicParameters = new DynamicParameters();

                        sqlQuery.mainKey = "a.MweDetailId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.MweId, a.MtlItemId, a.UomId, a.InventoryId, a.MweSeq TI003,
                              FORMAT(a.AvailableDate, 'yyyyMMdd') TI011, FORMAT(a.ReCheckDate, 'yyyyMMdd') TI012, a.MoId,
                              FORMAT(a.AcceptanceDate, 'yyyyMMdd') TI018,
                              a.ReceiptQty TI007, a.AcceptQty TI019, a.AvailableQty TI020, a.ScriptQty TI021, a.ReturnQty TI022, a.OrigUnitPrice TI024, a.OrigAmount TI025,
                              a.OrigDiscountAmt TI026, a.ReceiptExpense TI027, a.OrigPreTaxAmt TI044, a.OrigTaxAmt TI045, a.PreTaxAmt TI046, a.TaxAmt TI047, a.DiscountDescription TI028,
                              a.Remark TI040, a.LotNumber TI010, a.ProjectCode TI032, a.ProcessCode TI015, a.QcStatus TI035, a.Overdue TI034, a.ReserveTaxCode TI052, a.PaymentHold TI033,
                              a.TransferStatus TI054, a.ReturnCode TI036, a.ConfirmStatus TI037, a.CloseStatus TI038, a.ReNewStatus TI039, a.CostEntry TI041, a.ExpenseEntry TI042, a.ApproveStatus TI053,
                              a.ReceiptPackageQty TI016, a.AcceptancePackageQty TI017, 
                              b.MweErpPrefix TI001,b.MweErpNo TI002,
                              c.MtlItemNo TI004,c.MtlItemName TI005,c.MtlItemSpec TI006,
                              d.UomNo TI008,
                              e.InventoryNo TI009,
                              g.WoErpPrefix TI013,g.WoErpNo TI014";
                        sqlQuery.mainTables =
                            @"FROM MES.MweDetail a
                              INNER JOIN MES.MoWarehouseEnry b ON a.MweId = b.MweId
                              INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
                              INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                              INNER JOIN SCM.Inventory e ON a.InventoryId = e.InventoryId
                              INNER JOIN MES.ManufactureOrder f ON a.MoId = f.MoId
                              INNER JOIN MES.WipOrder g ON f.WoId = g.WoId";
                        sqlQuery.auxTables = "";
                        queryCondition = @"AND a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = "";
                        var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                        moctis = BaseHelper.SqlQuery<MOCTI>(sqlConnection, dynamicParameters, sqlQuery);
                        if (moctis.Count() <= 0) throw new SystemException("入庫單單身資料有誤!");

                        //全部單身的驗收產品數量 = 單頭的Quantity 數量合計
                        foreach (var item in result)
                        {
                            Quantity += item.TI019;
                            var ErpNoFull = item.TI013 + "," + item.TI014 + "," + item.TI007;
                            ErpNoFullList.Add(ErpNoFull);
                        }
                        #endregion



                        #region //撈取使用者No
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.UserNo
                            FROM BAS.[User] a
                            WHERE a.UserId = @userId";
                        dynamicParameters.Add("userId", CurrentUser);
                        userNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).UserNo;

                        mocths
                            .ToList()
                            .ForEach(x =>
                            {
                                //x.TH022 = Quantity;
                                x.CREATOR = userNo;
                                x.MODIFIER = userNo;
                            });
                        moctis
                            .ToList()
                            .ForEach(x =>
                            {
                                x.CREATOR = userNo;
                                x.MODIFIER = userNo;
                            });
                        #endregion

                        #region //撈取全部製令入庫數量
                        #endregion

                    }
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //ERP公司代碼取得
                        string CompanyNoErp = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ML001  
                                FROM CMSML";
                        var resultCompanyNo = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultCompanyNo)
                        {
                            CompanyNoErp = item.ML001;
                        }
                        if (ErpNo != CompanyNoErp) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                        #endregion

                        #region //審核ERP權限
                        USR_GROUP = BaseHelper.CheckErpAuthority(userNo, sqlConnection, "MOCI06", "CREATE");
                        #endregion

                        #region //找出小數位數換算
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MF003
                                      FROM CMSMF
                                     WHERE MF001 = (SELECT MA003 FROM CMSMA)";
                        var resultMF003 = sqlConnection.Query(sql, dynamicParameters);
                        if (resultMF003.Count() <= 0) throw new SystemException("找不到幣別小數位設定!!!");
                        int? MF003 = -1;
                        foreach (var item in resultMF003)
                        {
                            MF003 = Convert.ToInt32(item.MF003);
                        }
                        #endregion

                        #region //判斷入庫日不可以小於製令實際開工日
                        DateTime receiptDate = DateTime.ParseExact(ReceiptDateErp, "yyyyMMdd", null);

                        foreach (var item in ErpNoFullList)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TA012
                                    FROM MOCTA a
                                    WHERE TA001 = @TA001 AND TA002 = @TA002
                                    ";
                            dynamicParameters.Add("TA001", item.Split(',')[0]);
                            dynamicParameters.Add("TA002", item.Split(',')[1]);
                            var resultDate = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item1 in resultDate)
                            {
                                DateTime TA012 = DateTime.ParseExact(item1.TA012, "yyyyMMdd", null);
                                if (receiptDate < TA012)
                                {
                                    throw new SystemException($"入庫日期不可以小於實際製令開工日期,ERP製令{item.Split(',')[0]}-{item.Split(',')[1]}");
                                }
                            }
                        }
                        #endregion



                        #region //判斷入庫數量是否會超過該製令入庫數量
                        foreach (var item in ErpNoFullList)
                        {
                            #region //ERP撈出該製令下已入庫產品數量(核單)
                            int ReceiptQtyAllERP = 0;
                            int PlanQtyErp = 0;
                            string OverGet = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT sum(TI007) ReceiptQtyAllERP,x.TA015,y.MQ056
                                    FROM MOCTI a
                                    OUTER APPLY(
                                        SELECT TA015 
                                        FROM MOCTA x1
                                        WHERE 1=1
                                        AND x1.TA001 = a.TI013
                                        AND x1.TA002 = a.TI014
                                    ) x
                                    OUTER APPLY
                                    (
                                        SELECT x1.MQ056
                                        FROM CMSMQ x1
                                        WHERE x1.MQ001=a.TI001
                                    ) y
                                    WHERE a.TI013 = @TI013
                                    AND a.TI014 = @TI014
                                    AND a.TI037 !='V'
                                    AND a.TI001 != '5902'
                                    AND a.TI001+'-'+ a.TI002 != @MweErpNoFull
                                    GROUP BY x.TA015,y.MQ056";
                            dynamicParameters.Add("TI013", item.Split(',')[0]);
                            dynamicParameters.Add("TI014", item.Split(',')[1]);
                            dynamicParameters.Add("MweErpNoFull", MweErpPrefix+"-"+ MweErpNo);
                            var result1 = sqlConnection.Query(sql, dynamicParameters);

                            if (result1.Count() > 0)
                            {
                                foreach (var item1 in result1)
                                {
                                    ReceiptQtyAllERP = Convert.ToInt32(item1.ReceiptQtyAllERP);
                                    PlanQtyErp = Convert.ToInt32(item1.TA015);
                                    OverGet = item1.MQ056;
                                }
                            }

                            #endregion

                            if (OverGet == "Y")
                            {
                                var matchedMocti = moctis.FirstOrDefault(m => m.TI013 == item.Split(',')[0] && m.TI014 == item.Split(',')[1]);

                                if (matchedMocti != null)
                                {
                                    int ReceiptQtyA = Convert.ToInt32(matchedMocti.TI007);

                                    if (ReceiptQtyA > PlanQtyErp)
                                    {
                                        throw new SystemException($"已經超入，製令：{item.Split(',')[0]}-{item.Split(',')[1]}");
                                    }
                                }
                            }

                            //dynamicParameters = new DynamicParameters();
                            //sql = @"SELECT SUM(a.TI007) ReceiptQtyAll,x1.TA016 RequisitionSetQty  FROM MOCTI a
                            //    INNER JOIN MOCTH b on a.TI001 = b.TH001 AND a.TI002 = b.TH002
                            //    OUTER APPLY(
                            //     SELECT TA016 FROM MOCTA  c
                            //     WHERE a.TI013  = c.TA001 AND a.TI014  = c.TA002
                            //    ) x1
                            //    WHERE TI013 = @TI013 AND TI014 = @TI014
                            //    --AND TH001 != @TH001 AND TH002 != @TH002
                            //    AND TH023 IN ('Y','N')
                            //    GROUP BY x1.TA016 ";
                            //dynamicParameters.Add("TI013", item.Split(',')[0]);
                            //dynamicParameters.Add("TI014", item.Split(',')[1]);
                            //int ReceiptQtyAll = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ReceiptQtyAll);
                            //int RequisitionSetQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).RequisitionSetQty);

                            //if(ReceiptQtyAll + Convert.ToInt32(item.Split(',')[2]) > RequisitionSetQty) throw new SystemException("該製令ERP入庫單目前進貨數量加當前欲入庫數量已經超過目前領料單領料套數,請重新確認");
                        }
                        #endregion




                        if (mocths.Select(x => x.TH023).FirstOrDefault() == "N") //入庫單沒有確認
                        {
                            if (mocths.Count() > 0)
                            {

                                //單頭清單
                                List<MOCTH> addMocths = mocths.Where(x => x.TransferStatus == "N").ToList(); //新增
                                List<MOCTH> updateMocths = mocths.Where(x => x.TransferStatus == "Y").ToList(); //更新

                                //單身清單
                                List<MOCTI> addMoctis = moctis.Where(x => x.TI037 == "N").ToList(); //以最新為主

                                if (mocths.Select(x => x.TransferStatus).FirstOrDefault() == "N") //沒有拋轉過
                                {
                                    addMoctis = moctis.Where(x => x.TI037 == "N").ToList();

                                    #region //取值
                                    MweErpPrefix = mocths.Select(x => x.TH001).FirstOrDefault();
                                    string DocDate = mocths.Select(x => x.TH029).FirstOrDefault();

                                    #region //撈取單據編號編碼格式設定
                                    string ReceiptNo = "";
                                    string WoType = "";
                                    string encode = ""; // 編碼格式
                                    int yearLength = 0; // 年碼數
                                    int lineLength = 0; // 流水碼數
                                    DateTime referenceTime = default(DateTime);
                                    docDate = addMocths.Select(x => x.TH029).FirstOrDefault();
                                    referenceTime = DateTime.ParseExact(docDate, "yyyyMMdd", CultureInfo.InvariantCulture);

                                    #region //判斷開立日期是否超過結帳日
                                    string CloseDateBase = "";
                                    string DocDateBase = DocDate;
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MA013
                                            FROM CMSMA ";
                                    var resultCloseDate = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item in resultCloseDate)
                                    {
                                        CloseDateBase = item.MA013;
                                    }

                                    DateTime docDateBase;
                                    DateTime closeDateBase;

                                    if (DateTime.TryParseExact(DocDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out docDateBase) &&
                                        DateTime.TryParseExact(CloseDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out closeDateBase))
                                    {
                                        int resultDate = DateTime.Compare(docDateBase, closeDateBase);

                                        if (resultDate <= 0)
                                        {
                                            throw new SystemException("【入庫單】ERP已經結帳,不可以在新增【" + CloseDateBase + "】之前的單據");
                                        }
                                    }
                                    else
                                    {
                                        throw new SystemException("日期字符串无效，无法比较");
                                    }
                                    #endregion

                                    #region //撈取ERP單據設定
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MQ004, a.MQ005, a.MQ006, a.MQ044, a.MQ017
                                            FROM CMSMQ a
                                            WHERE MQ001 = @MweErpPrefix";
                                    dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                                    var resultReceiptNo = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item in resultReceiptNo)
                                    {
                                        encode = item.MQ004; //編碼方式
                                        yearLength = Convert.ToInt32(item.MQ005); //年碼數
                                        lineLength = Convert.ToInt32(item.MQ006); //流水號碼數
                                        WoType = item.MQ017;
                                    }
                                    #endregion

                                    #region //單號自動取號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TH002))), '" + new string('0', lineLength) + @"'), " + lineLength + @")) + 1 CurrentNum
                                            FROM MOCTH
                                            WHERE TH001 = @MweErpPrefix";
                                    dynamicParameters.Add("MweErpPrefix", MweErpPrefix);


                                    #region //編碼格式相關
                                    string dateFormat = "";
                                    switch (encode)
                                    {
                                        case "1": //日編
                                            if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                            if ((lineLength + yearLength + 4) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                            dateFormat = new string('y', yearLength) + "MMdd";
                                            sql += @" AND RTRIM(LTRIM(TH002)) LIKE @ReferenceTime  + '" + new string('_', lineLength) + @"'";
                                            //sql += @" AND TH002 LIKE '%' + @ReferenceTime + '%' + '" + new string('_', lineLength) + @"'";
                                            dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));

                                            string tedstNo = referenceTime.ToString(dateFormat);
                                            MweErpNo = referenceTime.ToString(dateFormat);
                                            break;
                                        case "2": //月編
                                            if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                            if ((lineLength + yearLength + 2) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                            dateFormat = new string('y', yearLength) + "MM";
                                            sql += @" AND RTRIM(LTRIM(TH002))  LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                            dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                            MweErpNo = referenceTime.ToString(dateFormat);
                                            break;
                                        case "3": //流水號
                                            if (yearLength == 0) throw new SystemException("【ERP單據性質】年碼數必須等於0");
                                            if (lineLength <= 0 || lineLength > 11) throw new SystemException("【ERP單據性質】流水編碼碼數必須大於0小於等於11");
                                            break;
                                        case "4": //手動編號
                                            break;
                                        default:
                                            throw new SystemException("編碼方式錯誤!");
                                    }
                                    int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                                    MweErpNo += string.Format("{0:" + new string('0', lineLength) + "}", currentNum);
                                    #endregion

                                    #endregion

                                    #endregion

                                    #region //判斷ERP入庫單單號是否重複
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MOCTH
                                            WHERE TH001 = @MweErpPrefix
                                            AND TH002 = @MweErpNo";
                                    dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                                    dynamicParameters.Add("MweErpNo", MweErpNo);

                                    var result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0) throw new SystemException("【入庫單單號】重複，請重新取號!");
                                    #endregion


                                    #endregion

                                    #region //新增
                                    #region //單頭
                                    if (addMocths.Count > 0)
                                    {
                                        addMocths
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.COMPANY = ErpNo;
                                                x.USR_GROUP = USR_GROUP;
                                                x.CREATE_DATE = dateNow;
                                                x.MODI_DATE = dateNow;
                                                x.FLAG = "1";
                                                x.CREATE_TIME = timeNow;
                                                x.CREATE_AP = BaseHelper.ClientComputer();
                                                x.CREATE_PRID = "BM";
                                                x.MODI_TIME = timeNow;
                                                x.MODI_AP = "";
                                                x.MODI_PRID = "BM";
                                                x.TH002 = MweErpNo;
                                                x.TH017 = "N";
                                                x.TH024 = "N";
                                                x.TH025 = 0;
                                                x.TH036 = "N";
                                                x.TH037 = "0";
                                                x.TH038 = 0;
                                                x.TH039 = 0;
                                                x.TH040 = 0;
                                                x.TH041 = "N";
                                                x.TH042 = "";
                                                x.TH043 = "";
                                                x.TH045 = "";
                                                x.TH046 = "";
                                                x.TH047 = 1;
                                                x.TH048 = 0;
                                                x.TH049 = 0;
                                                x.TH050 = "";
                                                x.TH051 = "";
                                                x.TH052 = "";
                                                x.TH053 = "";
                                                x.TH054 = "";
                                                x.TH055 = "";
                                                x.TH056 = "";
                                                x.TH057 = "";
                                                x.TH058 = "";
                                                x.TH059 = "";
                                                x.TH060 = "";
                                                x.TH061 = "";
                                                x.TH062 = "";
                                                x.TH063 = "";
                                                x.TH500 = "";
                                                x.UDF02 = "";
                                                x.UDF03 = "";
                                                x.UDF04 = "";
                                                x.UDF05 = "";
                                                x.UDF06 = 0;
                                                x.UDF07 = 0;
                                                x.UDF08 = 0;
                                                x.UDF09 = 0;
                                                x.UDF10 = 0;
                                            });
                                        sql = @"INSERT INTO MOCTH (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, 
                                                CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TH001, TH002, TH003, TH004, TH005, TH006, TH007, TH008, 
                                                TH009, TH010, TH011, TH012, TH013, TH014, TH015, TH016, TH017, TH018, TH019, TH020, TH021, TH022, TH023, 
                                                TH024, TH025, TH026, TH027, TH028, TH029, TH030, TH031, TH032, TH033, TH034, TH035, TH036, TH037, TH038, 
                                                TH039, TH040, TH041, TH042, TH043, TH044, TH045, TH046, TH047, TH048, TH049, TH050, TH051, TH052, TH500, 
                                                UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, TH053, TH054, TH055, 
                                                TH056, TH057, TH058, TH059, TH060, TH061, TH062, TH063)
                                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, @CREATE_AP,
                                                @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TH001, @TH002, @TH003, @TH004, @TH005, @TH006, @TH007, @TH008,
                                                @TH009, @TH010, @TH011, @TH012, @TH013, @TH014, @TH015, @TH016, @TH017, @TH018, @TH019, @TH020, @TH021, @TH022, @TH023,
                                                @TH024, @TH025, @TH026, @TH027, @TH028, @TH029, @TH030, @TH031, @TH032, @TH033, @TH034, @TH035, @TH036, @TH037, @TH038,
                                                @TH039, @TH040, @TH041, @TH042, @TH043, @TH044, @TH045, @TH046, @TH047, @TH048, @TH049, @TH050, @TH051, @TH052, @TH500,
                                                @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10, @TH053, @TH054, @TH055,
                                                @TH056, @TH057, @TH058, @TH059, @TH060, @TH061, @TH062, @TH063)";
                                        rowsAffected += sqlConnection.Execute(sql, addMocths);
                                    }
                                    #endregion

                                    #region //單身
                                    var MweSeqStr = "";
                                    var num = 1;

                                    if (addMoctis.Count > 0)
                                    {
                                        addMoctis
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                #region //批號管理設定-有效日複檢日取得
                                                string BatchNumberStatus = "";
                                                string AvailableDate = "";
                                                string AcceptanceDate = "";
                                                int ValidDays = -1;
                                                int RetestDay = -1;
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TOP 1 MB022,MB023,MB024  
                                                        FROM INVMB
                                                        WHERE RTRIM(LTRIM(MB001)) = @MtlItemNo";
                                                dynamicParameters.Add("MtlItemNo", "3A12J002-2304-026");
                                                var resultMtlItemSetting = sqlConnection.Query(sql, dynamicParameters);
                                                foreach (var item in resultMtlItemSetting)
                                                {
                                                    CompanyNoErp = item.ML001;
                                                    if (item.MB022 != "N")
                                                    {
                                                        BatchNumberStatus = item.MB022;
                                                        ValidDays = Convert.ToInt32(item.MB023);
                                                        RetestDay = Convert.ToInt32(item.MB024);
                                                    }
                                                }
                                                if (BatchNumberStatus != "")
                                                {
                                                    DateTime date = DateTime.Parse(ReceiptDate);

                                                    AvailableDate = date.AddDays(ValidDays).ToString("yyyyMMdd");
                                                    AcceptanceDate = date.AddDays(RetestDay).ToString("yyyyMMdd");
                                                }
                                                #endregion


                                                MweSeqStr = string.Format("{0:0000}", num);
                                                x.COMPANY = ErpNo;
                                                x.USR_GROUP = USR_GROUP;
                                                x.CREATE_DATE = dateNow;
                                                x.MODI_DATE = dateNow;
                                                x.FLAG = "1";
                                                x.CREATE_TIME = timeNow;
                                                x.CREATE_AP = BaseHelper.ClientComputer();
                                                x.CREATE_PRID = "BM";
                                                x.MODI_TIME = timeNow;
                                                x.MODI_AP = "";
                                                x.MODI_PRID = "BM";
                                                x.TI001 = MweErpPrefix;
                                                x.TI002 = MweErpNo;
                                                x.TI003 = MweSeqStr;
                                                x.TI011 = AvailableDate;
                                                x.TI012 = AcceptanceDate;
                                                x.TI023 = x.TI008;
                                                x.TI029 = "";
                                                x.TI030 = "";
                                                x.TI031 = "";
                                                x.TI048 = "N";
                                                x.TI049 = "";
                                                x.TI050 = 0;
                                                x.TI051 = 0;
                                                x.TI054 = "N";
                                                x.TI055 = 0;
                                                x.TI056 = "2";
                                                x.TI057 = "";
                                                x.TI058 = 0;
                                                x.TI059 = 0;
                                                x.TI060 = "";
                                                x.TI061 = "";
                                                x.TI062 = "";
                                                x.TI063 = "";
                                                x.TI064 = "";
                                                x.TI065 = 0;
                                                x.TI066 = 0;
                                                x.TI067 = 0;
                                                x.TI068 = "0";
                                                x.TI069 = "";
                                                x.TI070 = "";
                                                x.TI071 = 0;
                                                x.TI072 = "";
                                                x.TI073 = "";
                                                x.TI500 = "";
                                                x.TI501 = "";
                                                x.TI502 = "";
                                                x.TI503 = 0;
                                                x.TI504 = 0;
                                                x.TI505 = 0;
                                                x.TI506 = 0;
                                                x.TI507 = "";
                                                x.TI550 = "";
                                                x.TI551 = 0;
                                                x.TI552 = 0;
                                                x.TI553 = 0;
                                                x.TI554 = 0;
                                                x.TI555 = 0;
                                                x.TI556 = 0;
                                                x.TI557 = "";
                                                x.TI558 = "";
                                                x.TI559 = "";
                                                x.TI560 = "";
                                                x.TI561 = "";
                                                x.TI562 = "";
                                                x.TI563 = "";
                                                x.TI564 = "";
                                                x.TI565 = "";
                                                x.TI567 = "";
                                                x.TI568 = "";
                                                x.TI569 = "";
                                                x.TI570 = "";
                                                x.UDF01 = "";
                                                x.UDF02 = "";
                                                x.UDF03 = "";
                                                x.UDF04 = "";
                                                x.UDF05 = "";
                                                x.UDF06 = 0;
                                                x.UDF07 = 0;
                                                x.UDF08 = 0;
                                                x.UDF09 = 0;
                                                x.UDF10 = 0;

                                                seqList.Add(x.MweDetailId + "+" + MweSeqStr + "+" + AvailableDate + "+" + AcceptanceDate);

                                                num++;
                                            });
                                        sql = @"INSERT INTO MOCTI (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                                CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TI001, TI002, TI003, TI004, TI005, TI006, TI007, 
                                                TI008, TI009, TI010, TI011, TI012, TI013, TI014, TI015, TI016, TI017, TI018, TI019, TI020, TI021, TI022, TI023, TI024, 
                                                TI025, TI026, TI027, TI028, TI029, TI030, TI031, TI032, TI033, TI034, TI035, TI036, TI037, TI038, TI039, TI040, TI041, 
                                                TI042, TI043, TI044, TI045, TI046, TI047, TI048, TI049, TI050, TI051, TI052, TI053, TI054, TI055, TI056, TI057, TI058, 
                                                TI059, TI060, TI061, TI062, TI063, TI064, TI065, TI066, TI067, TI068, TI069, TI070, TI071, TI500, TI501, TI502, TI503, 
                                                TI504, TI505, TI506, TI507, TI550, TI551, TI552, TI553, TI554, TI555, TI556, TI557, TI558, TI559, TI560, TI561, TI562, 
                                                TI563, TI564, TI565, TI567, TI568, TI569, TI570, UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, 
                                                UDF09, UDF10, TI072, TI073)
                                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME,
                                                @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TI001, @TI002, @TI003, @TI004, @TI005, @TI006, @TI007,
                                                @TI008, @TI009, @TI010, @TI011, @TI012, @TI013, @TI014, @TI015, @TI016, @TI017, @TI018, @TI019, @TI020, @TI021, @TI022, @TI023, @TI024,
                                                @TI025, @TI026, @TI027, @TI028, @TI029, @TI030, @TI031, @TI032, @TI033, @TI034, @TI035, @TI036, @TI037, @TI038, @TI039, @TI040, @TI041,
                                                @TI042, @TI043, @TI044, @TI045, @TI046, @TI047, @TI048, @TI049, @TI050, @TI051, @TI052, @TI053, @TI054, @TI055, @TI056, @TI057, @TI058,
                                                @TI059, @TI060, @TI061, @TI062, @TI063, @TI064, @TI065, @TI066, @TI067, @TI068, @TI069, @TI070, @TI071, @TI500, @TI501, @TI502, @TI503,
                                                @TI504, @TI505, @TI506, @TI507, @TI550, @TI551, @TI552, @TI553, @TI554, @TI555, @TI556, @TI557, @TI558, @TI559, @TI560, @TI561, @TI562,
                                                @TI563, @TI564, @TI565, @TI567, @TI568, @TI569, @TI570, @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08,
                                                @UDF09, @UDF10, @TI072, @TI073)";
                                        rowsAffected += sqlConnection.Execute(sql, addMoctis);
                                    }
                                    #endregion
                                    #endregion

                                }
                                else if (mocths.Select(x => x.TransferStatus).FirstOrDefault() == "Y") //有拋轉過
                                {
                                    #region //MOCTI ERP入庫單是否有核單
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TH023 FROM MOCTH
                                            WHERE TH001 = @TH001
                                            AND TH002 = @TH002";
                                    dynamicParameters.Add("TH001", MweErpPrefix);
                                    dynamicParameters.Add("TH002", MweErpNo);
                                    var confirmStatusResult = sqlConnection.Query(sql, dynamicParameters);
                                    string ConfirmStatus = "";
                                    foreach (var item in confirmStatusResult)
                                    {
                                        ConfirmStatus = item.TH023;
                                    }
                                    if (ConfirmStatus != "N") throw new SystemException("入庫單已經核單了!!!!!!!!!!!!!!!!!");

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TI037 FROM MOCTI
                                            WHERE TI001 = @TI001
                                            AND TI002 = @TI002";
                                    dynamicParameters.Add("TI001", MweErpPrefix);
                                    dynamicParameters.Add("TI002", MweErpNo);
                                    confirmStatusResult = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item in confirmStatusResult)
                                    {
                                        ConfirmStatus = item.TI037;
                                    }
                                    if (ConfirmStatus != "N") throw new SystemException("入庫單單身已經核單了!!!!!!!!!!!!!!!!!");
                                    #endregion

                                    #region //MOCTI ERP入庫單單身刪除
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE MOCTI
                                    WHERE TI001 = @TI001
                                    AND TI002 = @TI002";
                                    dynamicParameters.Add("TI001", MweErpPrefix);
                                    dynamicParameters.Add("TI002", MweErpNo);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //MOCTH 入庫單單頭更新
                                    if (updateMocths.Count > 0)
                                    {
                                        updateMocths
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.TH022 = QuantityBase;
                                                x.TH023 = "Y";
                                                x.MODI_DATE = dateNow;
                                                x.MODI_TIME = timeNow;
                                            });

                                        sql = @"UPDATE MOCTH SET
                                                MODIFIER = @MODIFIER,
                                                TH001 = @TH001,
                                                TH003 = @TH003,
                                                TH010 = @TH010,
                                                TH022 = @TH022,
                                                MODI_DATE = @MODI_DATE,
                                                MODI_TIME = @MODI_TIME
                                                WHERE TH001 = @TH001
                                                AND TH002 = @TH002";

                                        rowsAffected += sqlConnection.Execute(sql, updateMocths);
                                    }
                                    #endregion

                                    #region //MOCTI 入庫單身新增
                                    var MweSeqStr = "";
                                    var num = 1;
                                    if (addMoctis.Count > 0)
                                    {
                                        addMoctis
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                #region //批號管理設定-有效日複檢日取得
                                                string BatchNumberStatus = "";
                                                string AvailableDate = "";
                                                string AcceptanceDate = "";
                                                int ValidDays = -1;
                                                int RetestDay = -1;
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TOP 1 MB022,MB023,MB024  
                                                        FROM INVMB
                                                        WHERE RTRIM(LTRIM(MB001)) = @MtlItemNo";
                                                dynamicParameters.Add("MtlItemNo", "3A12J002-2304-026");
                                                var resultMtlItemSetting = sqlConnection.Query(sql, dynamicParameters);
                                                foreach (var item in resultMtlItemSetting)
                                                {
                                                    CompanyNoErp = item.ML001;
                                                    if (item.MB022 != "N")
                                                    {
                                                        BatchNumberStatus = item.MB022;
                                                        ValidDays = Convert.ToInt32(item.MB023);
                                                        RetestDay = Convert.ToInt32(item.MB024);
                                                    }
                                                }
                                                if (BatchNumberStatus != "")
                                                {
                                                    DateTime date = DateTime.Parse(ReceiptDate);

                                                    AvailableDate = date.AddDays(ValidDays).ToString("yyyyMMdd");
                                                    AcceptanceDate = date.AddDays(RetestDay).ToString("yyyyMMdd");
                                                }
                                                #endregion


                                                MweSeqStr = string.Format("{0:0000}", num);
                                                x.COMPANY = ErpNo;
                                                x.USR_GROUP = USR_GROUP;
                                                x.CREATE_DATE = dateNow;
                                                x.MODI_DATE = dateNow;
                                                x.FLAG = "1";
                                                x.CREATE_TIME = timeNow;
                                                x.CREATE_AP = BaseHelper.ClientComputer();
                                                x.CREATE_PRID = "BM";
                                                x.MODI_TIME = timeNow;
                                                x.MODI_AP = "";
                                                x.MODI_PRID = "BM";
                                                x.TI001 = MweErpPrefix;
                                                x.TI002 = MweErpNo;
                                                x.TI003 = MweSeqStr;
                                                x.TI011 = AvailableDate;
                                                x.TI012 = AcceptanceDate;
                                                x.TI023 = x.TI008;
                                                x.TI024 = 0;
                                                x.TI029 = "";
                                                x.TI030 = "";
                                                x.TI031 = "";
                                                x.TI048 = "N";
                                                x.TI049 = "";
                                                x.TI050 = 0;
                                                x.TI051 = 0;
                                                x.TI055 = 0;
                                                x.TI056 = "2";
                                                x.TI054 = "N";
                                                x.TI057 = "";
                                                x.TI058 = 0;
                                                x.TI059 = 0;
                                                x.TI060 = "";
                                                x.TI061 = "";
                                                x.TI062 = "";
                                                x.TI063 = "";
                                                x.TI064 = "";
                                                x.TI065 = 0;
                                                x.TI066 = 0;
                                                x.TI067 = 0;
                                                x.TI068 = "0";
                                                x.TI069 = "";
                                                x.TI070 = "";
                                                x.TI071 = 0;
                                                x.TI072 = "";
                                                x.TI073 = "";
                                                x.TI500 = "";
                                                x.TI501 = "";
                                                x.TI502 = "";
                                                x.TI503 = 0;
                                                x.TI504 = 0;
                                                x.TI505 = 0;
                                                x.TI506 = 0;
                                                x.TI507 = "";
                                                x.TI550 = "";
                                                x.TI551 = 0;
                                                x.TI552 = 0;
                                                x.TI553 = 0;
                                                x.TI554 = 0;
                                                x.TI555 = 0;
                                                x.TI556 = 0;
                                                x.TI557 = "";
                                                x.TI558 = "";
                                                x.TI559 = "";
                                                x.TI560 = "";
                                                x.TI561 = "";
                                                x.TI562 = "";
                                                x.TI563 = "";
                                                x.TI564 = "";
                                                x.TI565 = "";
                                                x.TI567 = "";
                                                x.TI568 = "";
                                                x.TI569 = "";
                                                x.TI570 = "";
                                                x.UDF01 = "";
                                                x.UDF02 = "";
                                                x.UDF03 = "";
                                                x.UDF04 = "";
                                                x.UDF05 = "";
                                                x.UDF06 = 0;
                                                x.UDF07 = 0;
                                                x.UDF08 = 0;
                                                x.UDF09 = 0;
                                                x.UDF10 = 0;

                                                seqList.Add(x.MweDetailId + "+" + MweSeqStr + "+" + AvailableDate + "+" + AcceptanceDate);
                                                num++;
                                            });
                                        sql = @"INSERT INTO MOCTI (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                                CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TI001, TI002, TI003, TI004, TI005, TI006, TI007, 
                                                TI008, TI009, TI010, TI011, TI012, TI013, TI014, TI015, TI016, TI017, TI018, TI019, TI020, TI021, TI022, TI023, TI024, 
                                                TI025, TI026, TI027, TI028, TI029, TI030, TI031, TI032, TI033, TI034, TI035, TI036, TI037, TI038, TI039, TI040, TI041, 
                                                TI042, TI043, TI044, TI045, TI046, TI047, TI048, TI049, TI050, TI051, TI052, TI053, TI054, TI055, TI056, TI057, TI058, 
                                                TI059, TI060, TI061, TI062, TI063, TI064, TI065, TI066, TI067, TI068, TI069, TI070, TI071, TI500, TI501, TI502, TI503, 
                                                TI504, TI505, TI506, TI507, TI550, TI551, TI552, TI553, TI554, TI555, TI556, TI557, TI558, TI559, TI560, TI561, TI562, 
                                                TI563, TI564, TI565, TI567, TI568, TI569, TI570, UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, 
                                                UDF09, UDF10, TI072, TI073)
                                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME,
                                                @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TI001, @TI002, @TI003, @TI004, @TI005, @TI006, @TI007,
                                                @TI008, @TI009, @TI010, @TI011, @TI012, @TI013, @TI014, @TI015, @TI016, @TI017, @TI018, @TI019, @TI020, @TI021, @TI022, @TI023, @TI024,
                                                @TI025, @TI026, @TI027, @TI028, @TI029, @TI030, @TI031, @TI032, @TI033, @TI034, @TI035, @TI036, @TI037, @TI038, @TI039, @TI040, @TI041,
                                                @TI042, @TI043, @TI044, @TI045, @TI046, @TI047, @TI048, @TI049, @TI050, @TI051, @TI052, @TI053, @TI054, @TI055, @TI056, @TI057, @TI058,
                                                @TI059, @TI060, @TI061, @TI062, @TI063, @TI064, @TI065, @TI066, @TI067, @TI068, @TI069, @TI070, @TI071, @TI500, @TI501, @TI502, @TI503,
                                                @TI504, @TI505, @TI506, @TI507, @TI550, @TI551, @TI552, @TI553, @TI554, @TI555, @TI556, @TI557, @TI558, @TI559, @TI560, @TI561, @TI562,
                                                @TI563, @TI564, @TI565, @TI567, @TI568, @TI569, @TI570, @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08,
                                                @UDF09, @UDF10, @TI072, @TI073)";
                                        rowsAffected += sqlConnection.Execute(sql, addMoctis);
                                    }
                                    #endregion

                                }
                                else
                                {
                                    throw new SystemException("【入庫單】-資料錯錯拋轉狀態有問題");
                                }
                            }
                        }
                        else
                        {
                            throw new SystemException("操作錯誤，入庫單目前為確認狀態!");
                        }

                        #region //取出ERP托外入庫單據資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"
                                     SELECT TH001 AS D_A1
                                            ,TH002 AS D_A2
                                            ,TI003 AS D_A3 
                                            ,TH003 AS D_A4 
                                            ,TI004 AS D_B1 
                                            ,TI006 AS D_B2
                                            ,MB022 AS D_B3 
                                            ,ROUND(CAST(ISNULL(MB065/NULLIF(MB064, 0), 0) AS FLOAT), @MF003) AS D_B4
                                            ,CONVERT(varchar(12) ,DATEADD(d,MB023, convert(datetime, TH003)), 112) AS D_B5
                                            ,TI019*MQ010 AS D_D1 
                                            ,ROUND(CAST(ISNULL(MD004/MD003,1)AS FLOAT) ,@MF003) AS D_D3
                                            ,TI009 AS D_D4 
                                            ,TI010 AS D_D5 
                                            ,TI014 AS D_D6 
                                            ,TI017 AS D_D7 
                                            ,TI057 AS D_D8 
                                            ,TI012 AS D_O1
                                            ,MQ019 AS D_O3 
                                            ,MQ055 AS D_O4 
                                            ,MQ010 AS D_O5 
                                            ,MQ008 AS D_O6 
                                            ,MQ011 AS D_O7 
                                            ,MQ019 AS D_O8
                                            ,TI011 AS JMO_1
                                            ,TI040 AS JMO_2
                                            ,TI017 AS JMO_3
                                            ,TI013 AS JMO_4
                                            ,MQ054 AS JMO_5
                                            ,TH005 AS JMO_6
                                            ,TI018 AS JMO_7
                                            ,TI032 AS D_O9
                                    FROM MOCTH
                                    INNER JOIN MOCTI ON TH001=TI001 AND TH002=TI002
                                    INNER JOIN INVMB ON MB001=TI004
                                    INNER JOIN CMSMQ ON MQ001=TI001
                                    INNER JOIN CMSMC ON MC001=TI009
                                    LEFT JOIN INVMD ON MD001=TI008
                                    WHERE TH001 = @MweErpPrefix
                                      AND TH002 = @MweErpNo";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        dynamicParameters.Add("MweErpNo", MweErpNo);
                        dynamicParameters.Add("MF003", MF003);
                        var ErpMweResult = sqlConnection.Query(sql, dynamicParameters);
                        if (ErpMweResult.Count() <= 0) throw new SystemException("找不到ERP入庫單據!");
                        #endregion

                        #region //入庫相關欄位驗證+資料表新增異動
                        foreach (var item in ErpMweResult)
                        {
                            #region //取出SQL欄位置到變數
                            string D_A1 = item.D_A1; //入庫單單別
                            string D_A2 = item.D_A2; //入庫單單號
                            string D_A3 = item.D_A3; //入庫單單身序號
                            string D_A4 = item.D_A4; //進貨日期
                            string D_B1 = item.D_B1; //品號
                            string D_B2 = item.D_B2; //規格
                            string D_B3 = item.D_B3; //批號管理
                            double D_B4 = Convert.ToDouble(item.D_B4);
                            string D_B5 = item.D_B5;
                            double D_D1 = Convert.ToDouble(item.D_D1);
                            double D_D3 = Convert.ToDouble(item.D_D3);
                            string D_D4 = item.D_D4; //進貨庫別
                            string D_D5 = item.D_D5 != null ? item.D_D5 : ""; //批號
                            string D_D6 = item.D_D6; //製令單號
                            int D_D7 = Convert.ToInt32(item.D_D7); //驗收包裝數量
                            string D_D8 = item.D_D8 != "" ? item.D_D8 : "##########"; //儲位
                            string D_O1 = item.D_O1; //複檢日期
                            string D_O3 = item.D_O3; //核對採購/製令/訂單/託工
                            string D_O4 = item.D_O4; //控制缺領
                            int D_O5 = Convert.ToInt32(item.D_O5); //庫存影響
                            string D_O6 = item.D_O6; //異動類別
                            string D_O7 = item.D_O7; //影響成本
                            string D_O8 = item.D_O8; //核對採購/製令/訂單/託工
                            string D_O9 = item.D_O9; //專案代號
                            string JMO_1 = item.JMO_1; //有效日期
                            string JMO_2 = item.JMO_2; //備註
                            double JMO_3 = Convert.ToDouble(item.JMO_3); //驗收包裝數量
                            string JMO_4 = item.JMO_4; //製令單別
                            string JMO_5 = item.JMO_5; //控制超領
                            string JMO_6 = item.JMO_6; //加工廠商
                            string JMO_7 = item.JMO_7; //驗收日
                            #endregion

                            #region //判斷生產數量是否超過領料單可生產數量

                            #region //撈取單據缺領設定
                            string PickingListOutSet = "";
                            string PickingListInSet = "";
                            string WarnMessage = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MQ055,MQ056
                                        FROM CMSMQ 
                                        WHERE MQ001=@MweErpPrefix";
                            dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                            var resultSetting1 = sqlConnection.Query(sql, dynamicParameters);
                            if (resultSetting1.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                            foreach (var item1 in resultSetting1)
                            {
                                PickingListOutSet = item1.MQ055;
                                PickingListInSet = item1.MQ056;
                            }
                            #endregion

                            #region //撈出該製令下材料領料單全部領料數並計算出目前可入庫的最大產品套數
                            List<string> caseNumList = new List<string>();
                            Double MakeNum = 0;
                            int num = 0;

                            #region //獲取ERP單據的材料和須領用量
                            int PlanQty = -1;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TB003)) TB003,SUM(TB004) TB004,TA015
                                        FROM MOCTB 
                                        INNER JOIN MOCTA on TA001 = TB001 AND TA002 = TB002
                                        WHERE TB001=@WoErpPrefix
                                        AND TB002 =@WoErpNo
                                        AND TB018 ='Y'
                                        AND TB011 !=3
                                        AND TB011 !=4
                                        AND TB004 !=0
                                        GROUP BY TB003,TA015";
                            dynamicParameters.Add("WoErpPrefix", JMO_4);
                            dynamicParameters.Add("WoErpNo", D_D6);
                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                            foreach (var item1 in result)
                            {
                                string caseArr = Convert.ToString(item1.TB004) + "," + item1.TB003;
                                caseNumList.Add(caseArr);
                                PlanQty = Convert.ToInt32(item1.TA015);
                            }
                            #endregion

                            foreach (var item1 in caseNumList)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TE027,sum(a.TE005*b.MQ010*-1) NumSet
                                            FROM MOCTE a
                                            INNER JOIN CMSMQ b on a.TE001 =b.MQ001 
                                            WHERE a.TE011=@WoErpPrefix
                                            AND a.TE012 =@WoErpNo
                                            AND a.TE027 =@MtlItemNo
                                            AND a.TE019 ='Y'
                                            Group by a.TE027";
                                dynamicParameters.Add("WoErpPrefix", JMO_4);
                                dynamicParameters.Add("WoErpNo", D_D6);
                                dynamicParameters.Add("MtlItemNo", item1.Split(',')[1]);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() > 0)
                                {
                                    Double NumSet = 0;
                                    foreach (var item2 in result)
                                    {
                                        NumSet = Convert.ToDouble(item2.NumSet);
                                    }
                                    Double MaterialMtlItemNoNum = Convert.ToDouble(item1.Split(',')[0]);
                                    Double RatioOfMaterials = Math.Round(Convert.ToDouble(PlanQty / (MaterialMtlItemNoNum / NumSet)), 2);
                                    RatioOfMaterials = RatioOfMaterials > 0 ? Math.Floor(RatioOfMaterials) : Math.Ceiling(RatioOfMaterials);
                                    if (num == 0)
                                    {
                                        MakeNum = RatioOfMaterials;
                                    }
                                    else
                                    {
                                        //這段意思是 如果該品號是多種材料組成的 會以 可領的最小套數當最大套數
                                        if (MakeNum > RatioOfMaterials)
                                        {
                                            MakeNum = RatioOfMaterials;
                                        }
                                    }
                                    num++;
                                }
                                else
                                {
                                    #region //判斷入庫數是否有超過領料套數
                                    switch (PickingListOutSet)
                                    {
                                        case "Y":
                                            WarnMessage += "【入庫單】－材料:" + item1.Split(',')[1] + "未領取,不能入庫<br>";
                                            break;
                                    }
                                    #endregion
                                }

                            }
                            if (WarnMessage != "") throw new SystemException(WarnMessage);
                            #endregion

                            #region //ERP撈出該製令下已入庫產品數量(核單)
                            int EnterNum = 0;
                            int PassNum = 0;
                            int NgQtyErp = 0;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(sum(TI007),0) TINUM,ISNULL(sum(TI019),0) TINUM1, ISNULL(sum(TI021),0) TINUM2
                                    FROM MOCTI 
                                    WHERE TI013=@WoErpPrefix
                                    AND TI014 =@WoErpNo
                                    AND TI001 != '5902'
                                    AND TI037 ='Y'";
                            dynamicParameters.Add("WoErpPrefix", JMO_4);
                            dynamicParameters.Add("WoErpNo", D_D6);
                            var result1 = sqlConnection.Query(sql, dynamicParameters);
                            if (result1.Count() <= 0) throw new SystemException("工單製令有問題!");
                            foreach (var item1 in result1)
                            {
                                EnterNum = Convert.ToInt32(item1.TINUM);
                                PassNum = Convert.ToInt32(item1.TINUM1);
                                NgQtyErp = Convert.ToInt32(item1.TINUM2);
                            }
                            #endregion

                            #region //判斷入庫數是否有超過領料套數
                            switch (PickingListOutSet)
                            {
                                case "Y":
                                    if (MakeNum < D_D1 * D_D3) throw new SystemException("【入庫單】－請確認該製令是否有料未領取!!!或是領料單據有核單了嗎?");
                                    break;
                                case "N":
                                    if (MakeNum < D_D1 * D_D3) WarnMessage = "【單據設定不控制缺領】生產數量超過領料單可生產數量,領料不足!!!!!!!!";
                                    break;
                                case "W":
                                    if (MakeNum < D_D1 * D_D3) WarnMessage = "【單據設定警告缺領】生產數量超過領料單可生產數量,領料不足!";
                                    break;
                            }
                            #endregion

                            #endregion
                        }
                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings)) //拋轉ERP後 單號資料回寫MES
                    {
                        #region //回寫MES入庫單單頭 單號和數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoWarehouseEnry SET
                                MweErpNo = @MweErpNo,
                                TransferStatus = @TransferStatus,
                                ReConfirmStatus = @ReConfirmStatus,
                                TransferDate = @LastModifiedDate,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              MweErpNo,
                              TransferStatus = 'Y',
                              ReConfirmStatus = 'N',
                              LastModifiedDate,
                              LastModifiedBy,
                              MweId
                          });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //回寫MES入庫單單身 序號
                        foreach (var item in seqList)
                        {
                            int MweDetailId = Convert.ToInt32(item.Split('+')[0]);
                            string seq = item.Split('+')[1];
                            string AvailableDate = item.Split('+')[2];
                            string ReCheckDate = item.Split('+')[3];
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MweDetail SET
                                    MweSeq = @MweSeq,
                                    AvailableDate = @AvailableDate,
                                    ReCheckDate = @ReCheckDate,
                                    TransferStatus = @TransferStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MweId = @MweId
                                    AND MweDetailId = @MweDetailId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  MweSeq = seq,
                                  AvailableDate,
                                  ReCheckDate,
                                  TransferStatus = 'Y',
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  MweId,
                                  MweDetailId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion

                        #region //單號自動取號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MweErpNo
                                FROM MES.MoWarehouseEnry
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "拋轉成功!",
                            data = insertResult

                        });
                        #endregion
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();

        }
        #endregion

        #region //AddMweBarcodePrint -- 新增入庫單批量條碼 -- Shintokuro 2022-11-28
        public string AddMweBarcodePrint(int MweDetailId, int BarcodeQty, string BarcodePrefix, string BarcodePostfix, int SequenceLen)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (MweDetailId <= 0) throw new SystemException("【入庫單身】不能為空!");
                        if (BarcodeQty <= 0) throw new SystemException("【批次條碼數量】不能為空!");
                        if (SequenceLen <= 0) throw new SystemException("【流水號】不能為空!");
                        if (BarcodePrefix.Contains("*/*")) throw new SystemException("【前綴】不可以包含特殊字元【*/*】!!!");
                        if (BarcodePostfix.Contains("*/*")) throw new SystemException("【後綴】不可以包含特殊字元【*/*】!!!");

                        int? nullDate = null;
                        string BarcodeNo = "";
                        string writeModel = "";

                        if (BarcodePrefix.Length > 0 && BarcodePostfix.Length > 0)
                        {
                            BarcodeNo = "MWE-" + BarcodePrefix + "*/*" + 1.ToString().PadLeft(SequenceLen, '0') + "*/*" + BarcodePostfix;
                            writeModel = "A";
                        }
                        else if (BarcodePrefix.Length > 0 && BarcodePostfix.Length <= 0)
                        {
                            BarcodeNo = "MWE-" + BarcodePrefix + "*/*" + 1.ToString().PadLeft(SequenceLen, '0');
                            writeModel = "B";


                        }
                        else if (BarcodePrefix.Length <= 0 && BarcodePostfix.Length > 0)
                        {
                            BarcodeNo = "MWE-" + 1.ToString().PadLeft(SequenceLen, '0') + "*/*" + BarcodePostfix;
                            writeModel = "C";


                        }
                        else if (BarcodePrefix.Length <= 0 && BarcodePostfix.Length <= 0)
                        {
                            BarcodeNo = "MWE-" + 1.ToString().PadLeft(SequenceLen, '0');
                            writeModel = "D";

                        }



                        #region //判斷入庫單是否有條碼
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MweBarcodeId
                                FROM MES.MweDetail a
                                INNER JOIN MES.MweBarcode b on a.MweDetailId = b.MweDetailId
                                WHERE a.MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("該入庫單已經有條碼,不可以在生產");
                        #endregion


                        #region //判斷入庫單是否存在+撈取入庫數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.AcceptQty,a.MoId
                                FROM MES.MweDetail a
                                WHERE MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到入庫單單身ID");
                        int AcceptQty = -1;
                        int MoId = -1;
                        foreach (var item in result)
                        {
                            AcceptQty = Convert.ToInt32(item.AcceptQty);
                            if (AcceptQty == 0) throw new SystemException("驗收數量為0的狀態下,不可以列印");
                            MoId = item.MoId;

                        }
                        int AddCount = Convert.ToInt32(AcceptQty / BarcodeQty);
                        int Remainder = Convert.ToInt32(AcceptQty % BarcodeQty);
                        #endregion

                        #region //先判斷條碼編號是否存在單顆條碼中並撈出最大號

                        #region //先判斷條碼編號是否存在Barcode中 
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT BarcodeNo,'Barcode' TableFrom
                                    FROM MES.Barcode
                                    WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //沒有才判斷條碼編號是否存在BarcodePrinte中
                        if (result2.Count() <= 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT BarcodeNo,'BarcodePrint' TableFrom
                                    FROM MES.BarcodePrint
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            result2 = sqlConnection.Query(sql, dynamicParameters);
                        }
                        #endregion

                        #region //撈取最大序號
                        int maxSequence = 0;
                        if (result2.Count() > 0)
                        {
                            string TableFrom = "";
                            foreach (var item in result2)
                            {
                                TableFrom = item.TableFrom;
                            }
                            var strLength = BarcodeNo.Length;
                            var BarcodePrefix1 = "";
                            var BarcodePrefix2 = "";
                            var BarcodePostfix1 = "";
                            var BarcodePostfix2 = "";

                            //1 原模樣 2是調整模樣 

                            switch (writeModel)
                            {
                                case "A":
                                    BarcodePrefix1 = "MWE-" + BarcodePrefix + "*/*";
                                    BarcodePostfix1 = "*/*" + BarcodePostfix;
                                    BarcodePrefix2 = "MWE-" + BarcodePrefix + "%";
                                    BarcodePostfix2 = "%" + BarcodePostfix;


                                    break;
                                case "B":
                                    BarcodePrefix1 = "MWE-" + BarcodePrefix + "*/*";
                                    BarcodePostfix1 = "";
                                    BarcodePrefix2 = "MWE-" + BarcodePrefix + "%";
                                    BarcodePostfix2 = "";

                                    break;
                                case "C":
                                    BarcodePrefix1 = "MWE-";
                                    BarcodePostfix1 = "*/*" + BarcodePostfix;
                                    BarcodePrefix2 = "MWE-%";
                                    BarcodePostfix2 = "%" + BarcodePostfix;

                                    break;
                                case "D":
                                    BarcodePrefix1 = "MWE-";
                                    BarcodePostfix1 = "";
                                    BarcodePrefix2 = "MWE-%";
                                    BarcodePostfix2 = "";

                                    break;
                                default:
                                    break;
                            }

                            switch (TableFrom)
                            {
                                case "BarcodePrint":
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MAX(REPLACE(REPLACE(BarcodeNo,@BarcodePrefix1,''),@BarcodePostfix1,'')) maxSequence 
                                            FROM MES.BarcodePrint 
                                            WHERE BarcodeNo LIKE @BarcodePrefix2
                                            AND LEN(BarcodeNo) = @strLength";
                                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodePostfix2", @" AND BarcodeNo LIKE @BarcodePostfix2", BarcodePostfix2);
                                    dynamicParameters.Add("BarcodePrefix1", BarcodePrefix1);
                                    dynamicParameters.Add("BarcodePostfix1", BarcodePostfix1);
                                    dynamicParameters.Add("BarcodePrefix2", BarcodePrefix2);
                                    dynamicParameters.Add("BarcodePostfix2", BarcodePostfix2);
                                    dynamicParameters.Add("strLength", strLength);

                                    maxSequence = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).maxSequence);
                                    break;
                                case "Barcode":
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MAX(REPLACE(REPLACE(BarcodeNo,@BarcodePrefix1,''),@BarcodePostfix1,'')) maxSequence 
                                            FROM MES.Barcode 
                                            WHERE BarcodeNo LIKE @BarcodePrefix2
                                            AND LEN(BarcodeNo) = @strLength";
                                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodePostfix2", @" AND BarcodeNo LIKE @BarcodePostfix2", BarcodePostfix2);
                                    dynamicParameters.Add("BarcodePrefix1", BarcodePrefix1);
                                    dynamicParameters.Add("BarcodePostfix1", BarcodePostfix1);
                                    dynamicParameters.Add("BarcodePrefix2", BarcodePrefix2);
                                    dynamicParameters.Add("BarcodePostfix2", BarcodePostfix2);
                                    dynamicParameters.Add("strLength", strLength);

                                    maxSequence = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).maxSequence);
                                    break;
                                default:
                                    break;
                            }
                        }
                        if (maxSequence <= 0)
                        {
                            maxSequence = 1;
                        }
                        else
                        {
                            maxSequence += 1;

                        }
                        #endregion
                        #endregion


                        #region //滿盤新增
                        int rowsAffected = 0;
                        for (int i = maxSequence; i < maxSequence + AddCount; i++)
                        {

                            if (BarcodePrefix.Length > 0 && BarcodePostfix.Length > 0)
                            {
                                BarcodeNo = "MWE-" + BarcodePrefix + "*/*" + i.ToString().PadLeft(SequenceLen, '0') + "*/*" + BarcodePostfix;
                            }
                            else if (BarcodePrefix.Length > 0 && BarcodePostfix.Length <= 0)
                            {
                                BarcodeNo = "MWE-" + BarcodePrefix + "*/*" + i.ToString().PadLeft(SequenceLen, '0');

                            }
                            else if (BarcodePrefix.Length <= 0 && BarcodePostfix.Length > 0)
                            {
                                BarcodeNo = "MWE-" + i.ToString().PadLeft(SequenceLen, '0') + "*/*" + BarcodePostfix;

                            }
                            else if (BarcodePrefix.Length <= 0 && BarcodePostfix.Length <= 0)
                            {
                                BarcodeNo = "MWE-" + i.ToString().PadLeft(SequenceLen, '0');
                            }


                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, ParentBarcode
                                    , BarcodeProcessId, Memo, CurrentProdStatus, BarcodeStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeId
                                    VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @ParentBarcode
                                    , @BarcodeProcessId, @Memo, @CurrentProdStatus, @BarcodeStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeNo,
                                    CurrentMoProcessId = -1,
                                    NextMoProcessId = -1,
                                    MoId,
                                    BarcodeQty,
                                    ParentBarcode = nullDate,
                                    BarcodeProcessId = -1,
                                    Memo = nullDate,
                                    CurrentProdStatus = "P",
                                    BarcodeStatus = "8",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            int BarcodeId = 0;
                            foreach (var item in insertResult)
                            {
                                BarcodeId = Convert.ToInt32(item.BarcodeId);
                            }


                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MweBarcode (MweDetailId, BarcodeId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MweDetailId, @BarcodeId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MweDetailId,
                                    BarcodeId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }
                        #endregion

                        #region //尾盤新增
                        if (Remainder > 0)
                        {
                            if (BarcodePrefix.Length > 0 && BarcodePostfix.Length > 0)
                            {
                                BarcodeNo = "MWE-" + BarcodePrefix + "*/*" + (maxSequence + AddCount).ToString().PadLeft(SequenceLen, '0') + "*/*" + BarcodePostfix;
                            }
                            else if (BarcodePrefix.Length > 0 && BarcodePostfix.Length <= 0)
                            {
                                BarcodeNo = "MWE-" + BarcodePrefix + "*/*" + (maxSequence + AddCount).ToString().PadLeft(SequenceLen, '0');

                            }
                            else if (BarcodePrefix.Length <= 0 && BarcodePostfix.Length > 0)
                            {
                                BarcodeNo = "MWE-" + (maxSequence + AddCount).ToString().PadLeft(SequenceLen, '0') + "*/*" + BarcodePostfix;

                            }
                            else if (BarcodePrefix.Length <= 0 && BarcodePostfix.Length <= 0)
                            {
                                BarcodeNo = "MWE-" + (maxSequence + AddCount).ToString().PadLeft(SequenceLen, '0');
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, ParentBarcode
                                    , BarcodeProcessId, Memo, CurrentProdStatus, BarcodeStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeId
                                    VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @ParentBarcode
                                    , @BarcodeProcessId, @Memo, @CurrentProdStatus, @BarcodeStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeNo,
                                    CurrentMoProcessId = -1,
                                    NextMoProcessId = -1,
                                    MoId,
                                    BarcodeQty = Remainder,
                                    ParentBarcode = nullDate,
                                    BarcodeProcessId = -1,
                                    Memo = nullDate,
                                    CurrentProdStatus = "P",
                                    BarcodeStatus = "8",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            int BarcodeId = 0;
                            foreach (var item in insertResult)
                            {
                                BarcodeId = Convert.ToInt32(item.BarcodeId);
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MweBarcode (MweDetailId, BarcodeId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MweDetailId, @BarcodeId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MweDetailId,
                                    BarcodeId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }
                        #endregion


                        #region //更新 - 入庫單單身標籤印製狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MweDetail SET
                                LabelStatus = 'A',
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweDetailId = @MweDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LastModifiedDate,
                                LastModifiedBy,
                                MweDetailId,

                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion


                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMaterialFeedingManagement -- 新增投料登记 Jean 2025-06-16
        public string AddMaterialFeedingManagement(string FeedDate, int MachineId, int MoId, int MaterialId, double MatInRegQty, int UomId , string Remarks)
        {
            try
            {
                if (FeedDate.Length <= 0) throw new SystemException("【投料日期】不能為空!");
                if (MachineId <= 0) throw new SystemException("【機台】不能為空!");
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                if (MaterialId <= 0) throw new SystemException("【材料】不能為空!");
                if (MatInRegQty == 0) throw new SystemException("【投料數量】不能為0!");
                if (UomId <= 0) throw new SystemException("【單位】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();


                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MaterialFeedReg (FeedDate, MachineId, MoId, MaterialId, MatInRegQty, UomId, Remarks, Status, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MatFeedRegId
                                VALUES (@FeedDate, @MachineId, @MoId, @MaterialId, @MatInRegQty, @UomId, @Remarks,'A', @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FeedDate,
                                MachineId,
                                MoId,
                                MaterialId,
                                MatInRegQty,
                                UomId,
                                Remarks,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region /新增拆併盤紀錄 --GPai 20230511
        public string AddMergeData(int FromBarcodeId, int ToBarcodeId, int FromMoId, int ToMoId, int MergeQty)
        {
            try
            {
                int UserId = CreateBy;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {


                        #region //新增拆併盤紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeMergeLog (FromBarcodeId, ToBarcodeId, FromMoId, ToMoId,
                                MergeQty, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.LogId
                                VALUES (@FromBarcodeId, @ToBarcodeId, @FromMoId, @ToMoId,
                                @MergeQty, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";

                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FromBarcodeId,
                                ToBarcodeId,
                                FromMoId,
                                ToMoId,
                                MergeQty,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //新增拆併盤空條碼 --GPai 20230517
        public string AddEmptyMergeBarcode(int MoId, string MtlItemNo, string ItemNo, string ItemValue, int CurrentMoProcessId, int MoSettingId, int SequenceLen)
        {
            try
            {
                int UserId = CreateBy;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //取得批量條碼數
                        int BarcodeCount = 0;
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        sql = @"SELECT * FROM MES.BarcodePrint
                            WHERE BarcodeNo LIKE @MtlItemNo + '%'";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        BarcodeCount = result.Count() + 1;
                        string NewBarcodeNo = (MtlItemNo + "-" + BarcodeCount.ToString().PadLeft(SequenceLen, '0')).ToUpper();
                        int rowsAffected = 0;
                        #endregion

                        #region ////新增MES.BarcodePrint紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodePrint (BarcodeNo, BarcodeQty, MoSettingId, ParentBarcode, PrintCnt, PrintStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@BarcodeNo, @BarcodeQty, @MoSettingId, @ParentBarcode, @PrintCnt, @PrintStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo = NewBarcodeNo,
                                BarcodeQty = 0,
                                MoSettingId,
                                ParentBarcode = "",
                                PrintCnt = 0,
                                PrintStatus = 'P',
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult0 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult0.Count();
                        #endregion



                        #region //新增MES.Barcode紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, BarcodeProcessId, MoId, BarcodeQty,
                                CurrentProdStatus, BarcodeStatus, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeId,INSERTED.BarcodeNo
                                VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @BarcodeProcessId, @MoId, @BarcodeQty,
                                @CurrentProdStatus, @BarcodeStatus, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";

                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo = NewBarcodeNo,
                                CurrentMoProcessId,
                                NextMoProcessId = -1,
                                BarcodeProcessId = -1,
                                MoId,
                                BarcodeQty = 0,
                                CurrentProdStatus = 'P',
                                BarcodeStatus = 8,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });
                        var insertResult1 = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected = insertResult1.Count();
                        #endregion



                        #region //新增MES.BarcodeAttribute紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeAttribute (MoId, BarcodeId, ItemNo, ItemValue, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeAttrId
                                VALUES (@MoId, @BarcodeId, @ItemNo, @ItemValue,
                                 @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";

                        int ID = insertResult1.First().BarcodeId;
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoId,
                                BarcodeId = ID,
                                ItemNo,
                                ItemValue,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });
                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult1
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //Update
        #region //UpdateMaterialRequisition -- 更新領退料單資料 -- Ann 2022-08-18
        public string UpdateMaterialRequisition(int MrId, string RequesitionNo, string MrErpPrefix, string MrDate, string DocDate, string DocType, string Remark, string JournalStatus
            , string SignupStatus, string SourceType, string PriorityType, string NegativeStatus, string ProductionLine, string ContractManufacturer)
        {
            try
            {
                if (MrDate.Length < 0) throw new SystemException("【領退料日期】不能為空!");
                if (MrErpPrefix.Length < 0) throw new SystemException("【ERP領退料單別】不能為空!");
                if (MrErpPrefix.Length > 4) throw new SystemException("【ERP領退料單別】長度錯誤!");
                if (DocDate.Length < 0) throw new SystemException("【單據建立日期】不能為空!");
                if (DocType.Length < 0) throw new SystemException("【單據性質】不能為空!");
                if (JournalStatus.Length <= 0) throw new SystemException("【產生分錄碼】不能為空!");
                if (SignupStatus.Length <= 0) throw new SystemException("【簽核狀態碼】不能為空!");
                if (SourceType.Length <= 0) throw new SystemException("【來源別】不能為空!");
                if (PriorityType.Length <= 0) throw new SystemException("【需再確認邏輯】不能為空!");
                if (NegativeStatus.Length <= 0) throw new SystemException("【庫存不足照領】不能為空!");
                //if (ProductionLine.Length <= 0) throw new SystemException("【生產線別】不能為空!");
                if ((DocType != "55" && DocType != "57") && ContractManufacturer.Length > 0) throw new SystemException("非託外單別無法填入加工廠商!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(DocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + DocDate + ")之單據!!");
                            }
                            #endregion

                            #region //判斷領退料單資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MrErpPrefix, MrErpNo, ConfirmStatus, ConfirmUserId
                                    FROM MES.MaterialRequisition
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料錯誤!");

                            string MrErpNo = "";
                            string ConfirmStatus = "";
                            int ConfirmUserId = -1;
                            foreach (var item in result)
                            {
                                MrErpNo = item.MrErpNo;
                                ConfirmStatus = item.ConfirmStatus;
                                if (item.ConfirmUserId == null) ConfirmUserId = -1;
                                else ConfirmUserId = item.ConfirmUserId;
                            }

                            if (ConfirmStatus != "N") throw new SystemException("領退料單已確認，無法更改!");
                            #endregion

                            #region //判斷領退料單號是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MaterialRequisition
                                    WHERE RequesitionNo = @RequesitionNo";
                            dynamicParameters.Add("RequesitionNo", RequesitionNo);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("領退料單號錯誤!");
                            #endregion

                            #region //判斷 公司+MES領料單號 是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MaterialRequisition
                                    WHERE CompanyId = @CompanyId
                                    AND RequesitionNo = @RequesitionNo
                                    AND MrId != @MrId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("RequesitionNo", RequesitionNo);
                            dynamicParameters.Add("MrId", MrId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() > 0) throw new SystemException("【公司 + MES領料單號】重複，請重新輸入!");
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "MaterialRequisition");
                            dynamicParameters.Add("DetailCode", "update");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    CompanyId = @CompanyId,
                                    RequesitionNo = @RequesitionNo,
                                    MrErpPrefix = @MrErpPrefix,
                                    MrErpNo = @MrErpNo,
                                    MrDate = @MrDate,
                                    DocDate = @DocDate,
                                    DocType = @DocType,
                                    ProductionLine = @ProductionLine,
                                    Remark = @Remark,
                                    JournalStatus = @JournalStatus,
                                    PriorityType = @PriorityType,
                                    NegativeStatus = @NegativeStatus,
                                    SignupStatus = @SignupStatus,
                                    SourceType = @SourceType,
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    ContractManufacturer = @ContractManufacturer,
                                    TransferStatus = 'R',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    CompanyId = CurrentCompany,
                                    RequesitionNo,
                                    MrErpPrefix,
                                    MrErpNo,
                                    MrDate,
                                    DocDate,
                                    DocType,
                                    ProductionLine,
                                    Remark,
                                    JournalStatus,
                                    PriorityType,
                                    NegativeStatus,
                                    SignupStatus,
                                    SourceType,
                                    ConfirmStatus,
                                    ConfirmUserId,
                                    ContractManufacturer,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MrId
                                });

                            int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrWipOrder -- 更新領退料單設定資料(重計單身) -- Ann 2022-08-23
        public string UpdateMrWipOrder(int MrId, int MoId, string WoErpPrefix, string WoErpNo, string MrType, double Quantity
            , int InventoryId, string RequisitionCode, string NegativeStatus, string Remark
            , string MaterialCategory, string SubinventoryType, string LineSeq)
        {
            try
            {
                if (WoErpPrefix.Length < 0) throw new SystemException("【製令單別】不能為空!");
                if (WoErpPrefix.Length > 4) throw new SystemException("【製令單別】長度錯誤!");
                if (WoErpNo.Length < 0) throw new SystemException("【製令單號】不能為空!");
                //if (WoErpNo.Length > 11) throw new SystemException("【製令單號】長度錯誤!");
                if (MrType.Length < 0) throw new SystemException("【領料方式】長度錯誤!");
                if (Quantity < 0) throw new SystemException("【領退料套數】不能小於0!");
                if (RequisitionCode.Length < 0) throw new SystemException("【領料碼】不能為空!");
                if (NegativeStatus.Length < 0) throw new SystemException("【庫存不足照領】不能為空!");
                if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                if (MaterialCategory.Length < 0) throw new SystemException("【材料型態】不能為空!");
                if (SubinventoryType.Length < 0) throw new SystemException("【庫別型態】不能為空!");
                if (LineSeq.Length < 0) throw new SystemException("【輸入序號】不能為空!");
                if (LineSeq.Length > 4) throw new SystemException("【輸入序號】長度錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ConfirmStatus, MrErpPrefix, MrErpNo
                                    FROM MES.MaterialRequisition
                                    WHERE CompanyId = @CompanyId
                                    AND MrId = @MrId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料有誤!");

                            string MrErpPrefix = "";
                            string MrErpNo = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單已確認，無法更改!");
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                            }
                            #endregion

                            #region //查詢單據類別設定資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MQ010, LTRIM(RTRIM(a.MQ054)) MQ054
                                    FROM CMSMQ a 
                                    WHERE MQ001 = @MrErpPrefix";
                            dynamicParameters.Add("MrErpPrefix", MrErpPrefix);

                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP單別資料有誤!!");

                            int MQ010 = -1;
                            string ExcessFlag = "";
                            foreach (var item in CMSMQResult)
                            {
                                MQ010 = Convert.ToInt32(item.MQ010);
                                ExcessFlag = item.MQ054;
                            }
                            #endregion

                            #region //確認製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.Quantity
                                    FROM MES.ManufactureOrder a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            if (ManufactureOrderResult.Count() <= 0) throw new SystemException("製令資料錯誤!!");

                            int MoQuantity = 0;
                            foreach (var item in ManufactureOrderResult)
                            {
                                //if (Quantity > item.Quantity) throw new SystemException("領取套數不能大於此製令預計生產數(" + item.Quantity + ")!!");
                                MoQuantity = item.Quantity;
                            }
                            #endregion

                            #region //查詢ERP製令資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.TA015)) PlanQty, LTRIM(RTRIM(a.TA016)) RequisitionSetQty
                                    , LTRIM(RTRIM(a.TA017)) StockInQty, a.TA018 ScrapQty
                                    FROM MOCTA a
                                    WHERE a.TA001 = @WoErpPrefix
                                    AND a.TA002 = @WoErpNo";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);

                            var ErpWoInfoResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (ErpWoInfoResult.Count() <= 0) throw new SystemException("ERP製令(MOCTA)資料有誤!");

                            double PlanQty = -1;
                            double RequisitionSetQty = -1;
                            double StockInQty = -1;
                            double ScrapQty = -1;
                            foreach (var item in ErpWoInfoResult)
                            {
                                PlanQty = Convert.ToDouble(item.PlanQty);
                                RequisitionSetQty = Convert.ToDouble(item.RequisitionSetQty);
                                StockInQty = Convert.ToDouble(item.StockInQty);
                                ScrapQty = Convert.ToDouble(item.ScrapQty);
                            }
                            #endregion

                            #region //搜尋此製令所有領料單資訊，並找出實際已核單領料套數
                            double ErpQuantity = 0;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MrErpPrefix, b.MrErpNo
                                    , c.Quantity
                                    , d.WoErpPrefix, d.WoErpNo
                                    FROM MES.MrWipOrder a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                    INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrWipOrderResult.Count() > 0)
                            {
                                foreach (var item2 in MrWipOrderResult)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TD006 Quantity
                                            , b.MQ010
                                            , (
                                                SELECT TOP 1 1
                                                FROM MOCTE x
                                                WHERE x.TE001 = a.TD001
                                                AND x.TE002 = a.TD002
                                                AND x.TE019 = 'Y'
                                            ) CheckConfirm
                                            FROM MOCTD a
                                            INNER JOIN CMSMQ b ON a.TD001 = b.MQ001
                                            WHERE a.TD001 = @MrErpPrefix
                                            AND a.TD002 = @MrErpNo
                                            AND a.TD003 = @WoErpPrefix
                                            AND a.TD004 = @WoErpNo";
                                    dynamicParameters.Add("MrErpPrefix", item2.MrErpPrefix);
                                    dynamicParameters.Add("MrErpNo", item2.MrErpNo);
                                    dynamicParameters.Add("WoErpPrefix", item2.WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", item2.WoErpNo);

                                    var ErpMrWipOrderResult = sqlConnection2.Query(sql, dynamicParameters);

                                    foreach (var item3 in ErpMrWipOrderResult)
                                    {
                                        if (item3.CheckConfirm != null)
                                        {
                                            if (item3.MQ010 > 0)
                                            {
                                                ErpQuantity -= Convert.ToDouble(item3.Quantity);
                                            }
                                            else
                                            {
                                                ErpQuantity += Convert.ToDouble(item3.Quantity);
                                            }
                                        }
                                    }
                                }
                            }
                            #endregion

                            #region //判斷是否超領/超退
                            if (ExcessFlag == "Y")
                            {
                                if (MQ010 < 0) //領料
                                {
                                    if (Quantity > (MoQuantity - ErpQuantity) && ExcessFlag == "Y") throw new SystemException("領取數量超過未領用量(" + (MoQuantity - ErpQuantity).ToString() + ")!");
                                }
                                else if (MQ010 > 0) //退料
                                {
                                    //超退套數檢核公式: 本次退套數 MOCTD.TD006 > 已領套數 MOCTA.TA016 - ( 已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018)
                                    ErpQuantity = ErpQuantity - StockInQty - ScrapQty;
                                    if (Quantity > ErpQuantity) throw new SystemException("退料套數超過可退套數(" + ErpQuantity.ToString() + ")!");
                                }
                                else
                                {
                                    throw new SystemException("此領料單別(" + MrErpPrefix + ")設定資料有誤，請通知開發人員!!");
                                }
                            }
                            #endregion

                            #region //判斷庫別資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 InventoryNo
                                FROM SCM.Inventory
                                WHERE InventoryId = @InventoryId";
                            dynamicParameters.Add("InventoryId", InventoryId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("庫別資料有誤!");

                            string InventoryNo = "";
                            foreach (var item in result3)
                            {
                                InventoryNo = item.InventoryNo;
                            }
                            #endregion

                            #region //UPDATE MES.MrWipOrder
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MrWipOrder SET
                                    WoErpPrefix = @WoErpPrefix,
                                    WoErpNo = @WoErpNo,
                                    MrType = @MrType,
                                    Quantity = @Quantity,
                                    InventoryId = @InventoryId,
                                    RequisitionCode = @RequisitionCode,
                                    NegativeStatus = @NegativeStatus,
                                    Remark = @Remark,
                                    MaterialCategory = @MaterialCategory,
                                    SubinventoryType = @SubinventoryType,
                                    LineSeq = @LineSeq,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId
                                    AND MoId = @MoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    WoErpPrefix,
                                    WoErpNo,
                                    MrType,
                                    Quantity,
                                    InventoryId,
                                    InventoryNo,
                                    RequisitionCode,
                                    NegativeStatus,
                                    Remark,
                                    MaterialCategory,
                                    SubinventoryType,
                                    LineSeq,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MrId,
                                    MoId
                                });

                            int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //確認是否已有條碼控管
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrBarcodeRegister a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrId = @MrId AND b.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            var MrBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrBarcodeResult.Count() > 0)
                            {
                                throw new SystemException("此製令領料單身已有條碼綁定，若需更改請先將條碼解除綁定後再做嘗試!!");
                            }
                            #endregion

                            #region //刪除原本單身
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrDetail a
                                    WHERE a.MrId = @MrId
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //查看目前MrDetail序號
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MAX(MrSequence) MrSequence
                                    FROM MES.MrDetail
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var result5 = sqlConnection.Query(sql, dynamicParameters);
                            int currentMrSequence = -1;
                            foreach (var item in result5)
                            {
                                currentMrSequence = Convert.ToInt32(item.MrSequence);
                            }

                            string MrSequence = (currentMrSequence + 1).ToString().PadLeft(4, '0');
                            #endregion

                            #region //同步更新MrDetail
                            #region //取得MES製令用料設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(a.CompositionQuantity, 1) CompositionQuantity, ISNULL(a.Base, 1) Base, ISNULL(a.LossRate, 0) LossRate, a.BarcodeCtrl, a.MainBarcode, a.ControlType, a.DecompositionFlag
                                    , b.MtlItemId, b.DemandRequisitionQty, b.RequisitionQty, b.SubstituteMtlItemId, b.MaterialProperties
                                    , c.WoErpPrefix, c.WoErpNo, c.PlanQty, c.StockInQty
                                    , d.UomId, d.UomNo
                                    , e.MtlItemNo, e.MtlItemName
                                    , f.InventoryId, f.InventoryNo
                                    , g.MtlItemNo SubstitutionMtlItemNo, g.MtlItemName SubstitutionMtlItemName
                                    , h.TypeName
                                    , i.MtlItemNo
                                    FROM MES.MoMtlSetting a
                                    INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                    INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                                    INNER JOIN PDM.MtlItem e ON b.MtlItemId = e.MtlItemId
                                    INNER JOIN SCM.Inventory f ON b.InventoryId = f.InventoryId
                                    INNER JOIN PDM.MtlItem g ON b.SubstituteMtlItemId = g.MtlItemId
                                    INNER JOIN BAS.[Type] h ON a.ControlType = h.TypeNo AND h.TypeSchema = 'MoMtlSetting.ControlType'
                                    INNER JOIN PDM.MtlItem i ON b.MtlItemId = i.MtlItemId
                                    WHERE a.MoId = @MoId
                                    ORDER BY a.MainBarcode DESC";
                            dynamicParameters.Add("MoId", MoId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result4)
                            {
                                #region //依據材料性質判斷要帶出的用料MaterialCategory
                                string MaterialProperties = "";
                                if (item.MaterialProperties == null)
                                {
                                    throw new SystemException("材料性質設定錯誤，請確認工單資料是否正確!!");
                                }
                                else
                                {
                                    if (item.MaterialProperties != "1" && item.MaterialProperties != "2" && item.MaterialProperties != "5") continue;
                                    MaterialProperties = item.MaterialProperties;
                                }

                                if (MaterialCategory != "1" && MaterialCategory != "*" && MaterialCategory != "2" && MaterialCategory != "5")
                                {
                                    MaterialCategory = "*";
                                }

                                if (MaterialCategory != "*")
                                {
                                    if (MaterialCategory != MaterialProperties) continue;
                                }
                                #endregion

                                #region //取得ERP製令單身需領/已領用量
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TB004 DemandRequisitionQty, a.TB005 RequisitionQty
                                        , b.TA015, b.TA016, b.TA017, b.TA018
                                        FROM MOCTB a
                                        INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                                        WHERE a.TB001 = @WoErpPrefix
                                        AND a.TB002 = @WoErpNo
                                        AND a.TB003 = @MtlItemNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);
                                dynamicParameters.Add("MtlItemNo", item.MtlItemNo);

                                var ErpWoDetailResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (ErpWoDetailResult.Count() <= 0) throw new SystemException("查無ERP製令單身資料!!");

                                double DemandRequisitionQty = -1;
                                double RequisitionQty = -1;
                                double TA015 = 0; //預計生產量
                                double TA016 = 0; //已領套數
                                double TA017 = 0; //已生產量
                                double TA018 = 0; //報廢數量
                                double unitRate = 0; //單位用量
                                foreach (var item2 in ErpWoDetailResult)
                                {
                                    DemandRequisitionQty = Convert.ToDouble(item2.DemandRequisitionQty);
                                    RequisitionQty = Convert.ToDouble(item2.RequisitionQty);
                                    TA015 = Convert.ToDouble(item2.TA015);
                                    TA016 = Convert.ToDouble(item2.TA016);
                                    TA017 = Convert.ToDouble(item2.TA017);
                                    TA018 = Convert.ToDouble(item2.TA018);
                                    unitRate = DemandRequisitionQty / TA015;
                                }

                                double mtlItemQty = Quantity * unitRate;
                                #endregion

                                if (MQ010 > 0)
                                {
                                    if (RequisitionQty <= 0) continue;
                                }

                                #region //若為補足需領量，從EPR查是否有剩餘的料要領
                                if (MrType == "2" || MrType == "3")
                                {
                                    if (DemandRequisitionQty - RequisitionQty <= 0) continue;
                                }
                                #endregion

                                #region //若為退已領用量，從ERP查是否有已領量
                                if (MrType == "5")
                                {
                                    if (RequisitionQty <= 0) continue;
                                }
                                #endregion

                                #region //計算一套可以領/退多少料
                                //領料公式: 未領用量 / 總套數(預計生產量) / 單位用量 / 底數
                                //退料公式: 剩餘生產量 / 單位用量
                                double MrDetailQty = -1; //預計領料量
                                double ActualQuantity = -1; //實際領料量
                                if (item.BomDetailId != null)
                                {
                                    double unitQuantity = (DemandRequisitionQty - RequisitionQty) / item.PlanQty / item.CompositionQuantity;
                                    if (unitQuantity * Quantity * item.CompositionQuantity > (DemandRequisitionQty - RequisitionQty)) MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                    else MrDetailQty = unitQuantity * Quantity * item.CompositionQuantity;
                                }
                                else
                                {
                                    #region //計算退料狀況，最多可退數量
                                    //超退檢核公式: 本次退料量 MOCTE.TE005 > 已領用量 MOCTB.TB005 - (需領用量MOCTB.TB004 * (已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018) / 預計產量MOCTA.TA015))
                                    double calculateProportion = DemandRequisitionQty / TA015;
                                    double allowQty = RequisitionQty - (DemandRequisitionQty * (TA017 + TA018) / TA015);
                                    if (allowQty <= 0 && MQ010 > 0) continue;
                                    #endregion

                                    switch (MrType)
                                    {
                                        //確認公式是否為: ((領料數量*單位用量)/基數) + ((領料數量*單位用量/基數)*損耗率) 再四捨五入
                                        case "1":
                                            MrDetailQty = mtlItemQty;
                                            break;
                                        case "2":
                                            MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                            break;
                                        case "3":
                                            MrDetailQty = DemandRequisitionQty - RequisitionQty;
                                            break;
                                        case "4":
                                            MrDetailQty = mtlItemQty;
                                            break;
                                        case "5":
                                            MrDetailQty = allowQty;
                                            break;
                                    }
                                }

                                if (item.DecompositionFlag == "Y")
                                {
                                    ActualQuantity = MrDetailQty;
                                }
                                else if (item.BarcodeCtrl == "Y" && item.UomNo == "PCS")
                                {
                                    ActualQuantity = 0;
                                }
                                else
                                {
                                    ActualQuantity = MrDetailQty;
                                }
                                #endregion

                                #region //計算領料備註
                                string DetailDesc = "";
                                if (MQ010 < 0)
                                {
                                    DetailDesc = erpHelper.GetDetailDesc(item.MtlItemNo, item.InventoryNo, MrErpPrefix, MrErpNo, MrId, item.MtlItemId, item.InventoryId, MrDetailQty
                                        , sqlConnection, sqlConnection2);
                                }
                                #endregion

                                #region //INSERT MES.MrDetail
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MrDetail (MrId, MrSequence, MtlItemId, Quantity, ActualQuantity, UomId, Unit
                                        , InventoryId, SubInventoryCode, ProcessCode, LotNumber, MoId, WoErpPrefix, WoErpNo
                                        , DetailDesc, Remark, MaterialCategory, ConfirmStatus, ProjectCode, BondedStatus
                                        , SubstituteStatus, OfficialItemStatus, SubstitutionId, SubstitutionMtlItemNo, SubstituteProcessCode
                                        , SubstituteQty, SubstituteRate
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MrDetailId
                                        VALUES (@MrId, @MrSequence, @MtlItemId, @Quantity, @ActualQuantity, @UomId, @Unit
                                        , @InventoryId, @SubInventoryCode, @ProcessCode, @LotNumber, @MoId, @WoErpPrefix, @WoErpNo
                                        , @DetailDesc, @Remark, @MaterialCategory, @ConfirmStatus, @ProjectCode, @BondedStatus
                                        , @SubstituteStatus, @OfficialItemStatus, @SubstitutionId, @SubstitutionMtlItemNo, @SubstituteProcessCode
                                        , @SubstituteQty, @SubstituteRate
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MrId,
                                        MrSequence,
                                        item.MtlItemId,
                                        Quantity = Math.Round(MrDetailQty * 1000) / 1000,
                                        ActualQuantity = Math.Round(ActualQuantity * 1000) / 1000,
                                        item.UomId,
                                        Unit = item.UomNo,
                                        item.InventoryId,
                                        SubInventoryCode = item.InventoryNo,
                                        ProcessCode = "****",
                                        LotNumber = "",
                                        MoId,
                                        WoErpPrefix,
                                        WoErpNo,
                                        DetailDesc,
                                        Remark = ExcessFlag == "N" ? Remark : "",
                                        MaterialCategory = MaterialProperties,
                                        ConfirmStatus = "N",
                                        ProjectCode = "",
                                        BondedStatus = "N",
                                        SubstituteStatus = "N",
                                        OfficialItemStatus = "2",
                                        SubstitutionId = item.SubstitutionId != null ? (int?)item.SubstituteMtlItemId : null,
                                        item.SubstitutionMtlItemNo,
                                        SubstituteProcessCode = "****",
                                        SubstituteQty = 0,
                                        SubstituteRate = 0,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();

                                int MrDetailId = -1;
                                foreach (var item2 in insertResult)
                                {
                                    MrDetailId = item2.MrDetailId;
                                }

                                int nextMrSequence = Convert.ToInt32(MrSequence) + 1;
                                MrSequence = nextMrSequence.ToString().PadLeft(4, '0');
                                #endregion
                            }
                            #endregion
                            #endregion

                            #region //將單頭拋轉狀態改為R
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    TransferStatus = 'R',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  LastModifiedDate,
                                  LastModifiedBy = CurrentUser,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrWipOrderNoRC -- 更新領退料單設定資料(不重計單身) -- Ann 2022-08-23
        public string UpdateMrWipOrderNoRC(int MrId, int MoId, string WoErpPrefix, string WoErpNo, string MrType, double Quantity
            , int InventoryId, string RequisitionCode, string NegativeStatus, string Remark
            , string MaterialCategory, string SubinventoryType, string LineSeq)
        {
            try
            {
                if (WoErpPrefix.Length < 0) throw new SystemException("【製令單別】不能為空!");
                if (WoErpPrefix.Length > 4) throw new SystemException("【製令單別】長度錯誤!");
                if (WoErpNo.Length < 0) throw new SystemException("【製令單號】不能為空!");
                //if (WoErpNo.Length > 11) throw new SystemException("【製令單號】長度錯誤!");
                if (MrType.Length < 0) throw new SystemException("【領料方式】長度錯誤!");
                if (Quantity < 0) throw new SystemException("【領退料套數】不能小於0!");
                if (RequisitionCode.Length < 0) throw new SystemException("【領料碼】不能為空!");
                if (NegativeStatus.Length < 0) throw new SystemException("【庫存不足照領】不能為空!");
                if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                if (MaterialCategory.Length < 0) throw new SystemException("【材料型態】不能為空!");
                if (SubinventoryType.Length < 0) throw new SystemException("【庫別型態】不能為空!");
                if (LineSeq.Length < 0) throw new SystemException("【輸入序號】不能為空!");
                if (LineSeq.Length > 4) throw new SystemException("【輸入序號】長度錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ConfirmStatus, MrErpPrefix, MrErpNo
                                    FROM MES.MaterialRequisition
                                    WHERE CompanyId = @CompanyId
                                    AND MrId = @MrId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料有誤!");

                            string MrErpPrefix = "";
                            string MrErpNo = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單已確認，無法更改!");
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                            }
                            #endregion

                            #region //查詢單據類別設定資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MQ010, LTRIM(RTRIM(a.MQ054)) MQ054
                                    FROM CMSMQ a 
                                    WHERE MQ001 = @MrErpPrefix";
                            dynamicParameters.Add("MrErpPrefix", MrErpPrefix);

                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP單別資料有誤!!");

                            int MQ010 = -1;
                            string ExcessFlag = "";
                            foreach (var item in CMSMQResult)
                            {
                                MQ010 = Convert.ToInt32(item.MQ010);
                                ExcessFlag = item.MQ054;
                            }
                            #endregion

                            #region //確認製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.Quantity
                                    FROM MES.ManufactureOrder a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            if (ManufactureOrderResult.Count() <= 0) throw new SystemException("製令資料錯誤!!");

                            int MoQuantity = 0;
                            foreach (var item in ManufactureOrderResult)
                            {
                                //if (Quantity > item.Quantity) throw new SystemException("領取套數不能大於此製令預計生產數(" + item.Quantity + ")!!");
                                MoQuantity = item.Quantity;
                            }
                            #endregion

                            #region //查詢ERP製令資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.TA015)) PlanQty, LTRIM(RTRIM(a.TA016)) RequisitionSetQty
                                    , LTRIM(RTRIM(a.TA017)) StockInQty, a.TA018 ScrapQty
                                    FROM MOCTA a
                                    WHERE a.TA001 = @WoErpPrefix
                                    AND a.TA002 = @WoErpNo";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);

                            var ErpWoInfoResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (ErpWoInfoResult.Count() <= 0) throw new SystemException("ERP製令(MOCTA)資料有誤!");

                            double PlanQty = -1;
                            double RequisitionSetQty = -1;
                            double StockInQty = -1;
                            double ScrapQty = -1;
                            foreach (var item in ErpWoInfoResult)
                            {
                                PlanQty = Convert.ToDouble(item.PlanQty);
                                RequisitionSetQty = Convert.ToDouble(item.RequisitionSetQty);
                                StockInQty = Convert.ToDouble(item.StockInQty);
                                ScrapQty = Convert.ToDouble(item.ScrapQty);
                            }
                            #endregion

                            #region //搜尋此製令所有領料單資訊，並找出實際已核單領料套數
                            double ErpQuantity = 0;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MrErpPrefix, b.MrErpNo
                                    , c.Quantity
                                    , d.WoErpPrefix, d.WoErpNo
                                    FROM MES.MrWipOrder a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                    INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrWipOrderResult.Count() > 0)
                            {
                                foreach (var item2 in MrWipOrderResult)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TD006 Quantity
                                            , b.MQ010
                                            , (
                                                SELECT TOP 1 1
                                                FROM MOCTE x
                                                WHERE x.TE001 = a.TD001
                                                AND x.TE002 = a.TD002
                                                AND x.TE019 = 'Y'
                                            ) CheckConfirm
                                            FROM MOCTD a
                                            INNER JOIN CMSMQ b ON a.TD001 = b.MQ001
                                            WHERE a.TD001 = @MrErpPrefix
                                            AND a.TD002 = @MrErpNo
                                            AND a.TD003 = @WoErpPrefix
                                            AND a.TD004 = @WoErpNo";
                                    dynamicParameters.Add("MrErpPrefix", item2.MrErpPrefix);
                                    dynamicParameters.Add("MrErpNo", item2.MrErpNo);
                                    dynamicParameters.Add("WoErpPrefix", item2.WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", item2.WoErpNo);

                                    var ErpMrWipOrderResult = sqlConnection2.Query(sql, dynamicParameters);

                                    foreach (var item3 in ErpMrWipOrderResult)
                                    {
                                        if (item3.CheckConfirm != null)
                                        {
                                            if (item3.MQ010 > 0)
                                            {
                                                ErpQuantity -= Convert.ToDouble(item3.Quantity);
                                            }
                                            else
                                            {
                                                ErpQuantity += Convert.ToDouble(item3.Quantity);
                                            }
                                        }
                                    }
                                }
                            }
                            #endregion

                            #region //判斷是否超領/超退
                            if (ExcessFlag == "Y")
                            {
                                if (MQ010 < 0) //領料
                                {
                                    if (Quantity > (MoQuantity - ErpQuantity) && ExcessFlag == "Y") throw new SystemException("領取數量超過未領用量(" + (MoQuantity - ErpQuantity).ToString() + ")!");
                                }
                                else if (MQ010 > 0) //退料
                                {
                                    //超退套數檢核公式: 本次退套數 MOCTD.TD006 > 已領套數 MOCTA.TA016 - ( 已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018)
                                    ErpQuantity = ErpQuantity - RequisitionSetQty;
                                    if (Quantity > ErpQuantity) throw new SystemException("退料數量超過已領套數(" + ErpQuantity.ToString() + ")!");
                                }
                                else
                                {
                                    throw new SystemException("此領料單別(" + MrErpPrefix + ")設定資料有誤，請通知開發人員!!");
                                }
                            }
                            #endregion

                            #region //判斷庫別資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 InventoryNo
                                FROM SCM.Inventory
                                WHERE InventoryId = @InventoryId";
                            dynamicParameters.Add("InventoryId", InventoryId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("庫別資料有誤!");

                            string InventoryNo = "";
                            foreach (var item in result3)
                            {
                                InventoryNo = item.InventoryNo;
                            }
                            #endregion

                            #region //UPDATE MES.MrWipOrder
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MrWipOrder SET
                                    WoErpPrefix = @WoErpPrefix,
                                    WoErpNo = @WoErpNo,
                                    MrType = @MrType,
                                    Quantity = @Quantity,
                                    InventoryId = @InventoryId,
                                    RequisitionCode = @RequisitionCode,
                                    NegativeStatus = @NegativeStatus,
                                    Remark = @Remark,
                                    MaterialCategory = @MaterialCategory,
                                    SubinventoryType = @SubinventoryType,
                                    LineSeq = @LineSeq,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId
                                    AND MoId = @MoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    WoErpPrefix,
                                    WoErpNo,
                                    MrType,
                                    Quantity,
                                    InventoryId,
                                    InventoryNo,
                                    RequisitionCode,
                                    NegativeStatus,
                                    Remark,
                                    MaterialCategory,
                                    SubinventoryType,
                                    LineSeq,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MrId,
                                    MoId
                                });

                            int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion


                            #region //將單頭拋轉狀態改為R
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    TransferStatus = 'R',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  LastModifiedDate,
                                  LastModifiedBy = CurrentUser,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrDetail -- 更新領退料單詳細資料 -- Ann 2022-08-24
        public string UpdateMrDetail(int MrDetailId, int MoId, string MrSequence, int MtlItemId, double Quantity, int UomId, int InventoryId, string LotNumber, string DetailDesc, string Remark, string MaterialCategory
            , string ProjectCode, string BondedStatus, string SubstituteStatus)
        {
            try
            {
                double epsilon = 0.0001;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            if (CreateBy <= 0) throw new SystemException("【使用者ID】錯誤，請嘗試重新整理頁面!!");
                            if (MrSequence.Length <= 0) throw new SystemException("【領料序號】不能為空!");
                            if (MrSequence.Length > 4) throw new SystemException("【領料序號】長度錯誤!");
                            if (Quantity < 0) throw new SystemException("【領料數量】不能為空!");
                            if (LotNumber.Length > 20) throw new SystemException("【材料庫存批號】長度錯誤!");
                            if (DetailDesc.Length > 60) throw new SystemException("【領料說明】長度錯誤!");
                            if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                            if (MaterialCategory.Length <= 0) throw new SystemException("【材料性質】不能為空!");
                            if (ProjectCode.Length > 20) throw new SystemException("【專案代號】長度錯誤!");
                            if (BondedStatus.Length <= 0) throw new SystemException("【保稅碼】不能為空!");
                            if (SubstituteStatus.Length <= 0) throw new SystemException("【領替代料】不能為空!");

                            #region //判斷領料單身資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MrId, a.Quantity, a.ActualQuantity, a.Unit
                                    , b.ConfirmStatus, b.MrErpPrefix, FORMAT(b.DocDate, 'yyyy-MM-dd HH:mm:ss') DocDate
                                    , ISNULL(c.BarcodeCtrl, 'N') BarcodeCtrl, ISNULL(c.DecompositionFlag, 'N') DecompositionFlag
                                    , (
                                        SELECT TOP 1 1
                                        FROM MES.MrBarcodeRegister x 
                                        WHERE x.MrDetailId = a.MrDetailId
                                    ) MrBarcodeRegister
                                    , (
                                        SELECT TOP 1 1
                                        FROM MES.MrBarcodeReRegister x 
                                        WHERE x.MrDetailId = a.MrDetailId
                                    ) MrBarcodeReRegister
                                    FROM MES.MrDetail a 
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    LEFT JOIN MES.MoMtlSetting c ON a.MoId = c.MoId
                                    LEFT JOIN MES.WoDetail d ON c.WoDetailId = d.WoDetailId AND d.MtlItemId = a.MtlItemId
                                    WHERE a.MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrDetailResult.Count() <= 0) throw new SystemException("領料單單身資料錯誤!!");

                            string MrErpPrefix = "";
                            DateTime DocDate = new DateTime();
                            int MrId = -1;
                            string BarcodeCtrl = "";
                            string DecompositionFlag = "";
                            double ActualQuantity = 0;
                            string Unit = "";
                            foreach (var item in MrDetailResult)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單狀態無法修改!!");
                                //if ((item.MrBarcodeRegister != null || item.MrBarcodeReRegister != null) && item.Quantity != Quantity && item.DecompositionFlag == "N") throw new SystemException("此領料單身已綁定條碼，<br>請先解除條碼後再進行修改!!");
                                MrErpPrefix = item.MrErpPrefix;
                                DocDate = Convert.ToDateTime(item.DocDate);
                                MrId = item.MrId;
                                BarcodeCtrl = item.BarcodeCtrl;
                                DecompositionFlag = item.DecompositionFlag;
                                ActualQuantity = item.ActualQuantity;
                                Unit = item.Unit;
                            }
                            #endregion

                            #region //取得單據性質設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MQ010, LTRIM(RTRIM(a.MQ019)) MQ019
                                    , LTRIM(RTRIM(a.MQ040)) MQ040
                                    , LTRIM(RTRIM(a.MQ054)) MQ054
                                    FROM CMSMQ a
                                    WHERE a.MQ001 = @MQ001";
                            dynamicParameters.Add("MQ001", MrErpPrefix);
                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP尚未維護此領料單單別(" + MrErpPrefix + ")!!");

                            string CheckMoFlag = "";
                            string ExcessFlag = "";
                            decimal? MQ010 = 0;
                            string EffectiveFlag = "";
                            foreach (var item2 in CMSMQResult)
                            {
                                CheckMoFlag = item2.MQ019;
                                ExcessFlag = item2.MQ054;
                                MQ010 = item2.MQ010;
                                EffectiveFlag = item2.EffectiveFlag;
                            }
                            #endregion

                            #region //判斷製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.WoId, b.WoErpPrefix, b.WoErpNo, b.MtlItemId
                                    , c.BarcodeCtrl, c.DecompositionFlag
                                    , d.MtlItemNo MainMtlItemNo
                                    FROM MES.ManufactureOrder a
                                    INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                    INNER JOIN MES.MoMtlSetting c ON a.MoId = c.MoId
                                    INNER JOIN PDM.MtlItem d ON b.MtlItemId = d.MtlItemId
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            if (ManufactureOrderResult.Count() <= 0) throw new SystemException("製令資料錯誤!!");

                            int WoId = -1;
                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            string MainMtlItemNo = "";
                            foreach (var item in ManufactureOrderResult)
                            {
                                if (item.MtlItemId == MtlItemId && item.WoErpPrefix.IndexOf("52") == -1) throw new SystemException("非重工製令無法領取主件料號!!");
                                WoId = item.WoId;
                                WoErpPrefix = item.WoErpPrefix;
                                WoErpNo = item.WoErpNo;
                                MainMtlItemNo = item.MainMtlItemNo;
                            }
                            #endregion

                            #region //判斷品號資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemNo, TransferStatus
                                    FROM PDM.MtlItem
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("品號資料有誤!");

                            string MtlItemNo = "";
                            foreach (var item in result3)
                            {
                                if (item.TransferStatus != "Y") throw new SystemException("此品號尚未拋轉到ERP，無法使用!!");
                                MtlItemNo = item.MtlItemNo;
                            }
                            #endregion

                            #region //若MQ019為Y，檢查用料是否為製令BOM
                            if (CheckMoFlag == "Y")
                            {
                                if (MoId <= 0) throw new SystemException("此單別需要指定製令!!");

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MOCTB
                                        WHERE TB001 = @WoErpPrefix
                                        AND TB002 = @WoErpNo
                                        AND TB003 = @MtlItemNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);
                                dynamicParameters.Add("MtlItemNo", MtlItemNo);

                                var MOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (MOCTBResult.Count() <= 0) throw new SystemException("品號【" + MtlItemNo + "】並未在此製令用料中!!");
                            }
                            #endregion

                            #region //若MQ054為Y，則檢查是否超領/超退
                            if (ExcessFlag == "Y")
                            {
                                if (MQ010 < 0)
                                {
                                    #region //檢核超領
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TB004 DemandRequisitionQty, TB005 RequisitionQty
                                        FROM MOCTB
                                        WHERE TB001 = @WoErpPrefix
                                        AND TB002 = @WoErpNo
                                        AND TB003 = @MtlItemNo";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", WoErpNo);
                                    dynamicParameters.Add("MtlItemNo", MtlItemNo);

                                    var ErpWoDetailResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (ErpWoDetailResult.Count() <= 0) throw new SystemException("查無ERP製令單身資料!!");

                                    double DemandRequisitionQty = -1;
                                    double RequisitionQty = -1;
                                    foreach (var item2 in ErpWoDetailResult)
                                    {
                                        DemandRequisitionQty = Convert.ToDouble(item2.DemandRequisitionQty);
                                        RequisitionQty = Convert.ToDouble(item2.RequisitionQty);
                                    }

                                    if (MQ010 < 0)
                                    {
                                        if (Quantity > (DemandRequisitionQty - RequisitionQty))
                                        {
                                            if (Math.Abs(Quantity - (DemandRequisitionQty - RequisitionQty)) > epsilon)
                                            {
                                                throw new SystemException("此用料已領最大領料數，無法超領!!");
                                            }
                                        }
                                    }
                                    #endregion
                                }
                                else
                                {
                                    #region //檢核超退

                                    #region //取得製令相關資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TB004, a.TB005
                                            , b.TA015, b.TA016, b.TA017, b.TA018
                                            FROM MOCTB a 
                                            INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                                            WHERE a.TB001 = @T2 
                                            AND a.TB002 = @T3 
                                            AND a.TB003 = @T1";
                                    dynamicParameters.Add("T1", MtlItemNo);
                                    dynamicParameters.Add("T2", WoErpPrefix);
                                    dynamicParameters.Add("T3", WoErpNo);

                                    var MOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (MOCTBResult.Count() <= 0) throw new SystemException("查詢製令相關資料時錯誤!!");

                                    double TB004 = 0; //需領用量
                                    double TB005 = 0; //已領用量
                                    double TA015 = 0; //預計生產量
                                    double TA016 = 0; //已領套數
                                    double TA017 = 0; //已生產量
                                    double TA018 = 0; //報廢數量
                                    foreach (var item in MOCTBResult)
                                    {
                                        TB004 = Convert.ToDouble(item.TB004);
                                        TB005 = Convert.ToDouble(item.TB005);
                                        TA015 = Convert.ToDouble(item.TA015);
                                        TA016 = Convert.ToDouble(item.TA016);
                                        TA017 = Convert.ToDouble(item.TA017);
                                        TA018 = Convert.ToDouble(item.TA018);
                                    }
                                    #endregion

                                    //超退檢核公式: 本次退料量 MOCTE.TE005 > 已領用量 MOCTB.TB005 - (需領用量MOCTB.TB004 * (已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018) / 預計產量MOCTA.TA015))
                                    double allowQty = TB005 - (TB004 * (TA017 + TA018) / TA015);
                                    if (Quantity > allowQty)
                                    {
                                        throw new SystemException("料號【" + MtlItemNo + "】超過可退最大數量【" + allowQty + "】，無法新增!!");
                                    }
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //確認物料是否有進行NG拆盤
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.NgQty, a.AlreadyQty
                                        FROM MES.TrayMtlItemNg a 
                                        INNER JOIN PDM.BomDetail b ON a.BomDetailId = b.BomDetailId
                                        WHERE a.MoId = @MoId
                                        AND b.MtlItemId = @MtlItemId";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MtlItemId", MtlItemId);

                                var TrayMtlItemNgResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in TrayMtlItemNgResult)
                                {
                                    //if ((Quantity + Convert.ToDouble(item.AlreadyQty)) > item.NgQty) throw new SystemException("此用料【" + MtlItemNo + "】已進行NG拆盤。<br>剩餘可超領數量為【" + (item.NgQty - item.AlreadyQty) + "】!!");
                                }
                                #endregion
                            }
                            #endregion

                            #region //判斷單位資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 UomNo
                                    FROM PDM.UnitOfMeasure
                                    WHERE UomId = @UomId";
                            dynamicParameters.Add("UomId", UomId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("單位資料有誤!");

                            string UomNo = "";
                            foreach (var item in result4)
                            {
                                UomNo = item.UomNo;
                            }
                            #endregion

                            #region //確認ERP品號相關資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB004)) MB004
                                    , LTRIM(RTRIM(MB030)) MB030
                                    , LTRIM(RTRIM(MB031)) MB031
                                    FROM INVMB
                                    WHERE MB001 = @MB001";
                            dynamicParameters.Add("MB001", MtlItemNo);

                            var INVMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (INVMBResult.Count() <= 0) throw new SystemException("ERP品號基本資料錯誤!!");

                            foreach (var item in INVMBResult)
                            {
                                #region //比對單位與ERP品號基本資料單位是否相同
                                if (item.MB004 != UomNo) throw new SystemException("物料單位(" + UomNo + ")與ERP品號庫存單位(" + item.MB004 + ")不同!!");
                                #endregion

                                if (EffectiveFlag == "N")
                                {
                                    #region //判斷ERP品號生效日與失效日
                                    if (item.MB030 != "" && item.MB030 != null)
                                    {
                                        #region //判斷日期需大於或等於生效日
                                        string EffectiveDate = item.MB030;
                                        string effYear = EffectiveDate.Substring(0, 4);
                                        string effMonth = EffectiveDate.Substring(4, 2);
                                        string effDay = EffectiveDate.Substring(6, 2);
                                        DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                        int effresult = DateTime.Compare(DocDate, effFullDate);
                                        if (effresult < 0) throw new SystemException("此品號尚未生效，無法使用!!");
                                        #endregion
                                    }

                                    if (item.MB031 != "" && item.MB031 != null)
                                    {
                                        #region //判斷日期需小於或等於失效日
                                        string ExpirationDate = item.MB031;
                                        string effYear = ExpirationDate.Substring(0, 4);
                                        string effMonth = ExpirationDate.Substring(4, 2);
                                        string effDay = ExpirationDate.Substring(6, 2);
                                        DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                        int effresult = DateTime.Compare(DocDate, effFullDate);
                                        if (effresult > 0) throw new SystemException("此品號已失效，無法使用!!");
                                        #endregion
                                    }
                                    #endregion
                                }
                            }
                            #endregion

                            #region //判斷庫存資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 InventoryNo
                                    FROM SCM.Inventory
                                    WHERE InventoryId = @InventoryId
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.Add("InventoryId", InventoryId);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var result5 = sqlConnection.Query(sql, dynamicParameters);
                            if (result5.Count() <= 0) throw new SystemException("庫存資料有誤!");

                            string InventoryNo = "";
                            foreach (var item in result5)
                            {
                                InventoryNo = item.InventoryNo;
                            }
                            #endregion

                            #region //判斷領退料單詳細資料 + 領料序號是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrDetail
                                    WHERE MrId = @MrId
                                    AND MrSequence = @MrSequence
                                    AND MrDetailId != @MrDetailId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MrSequence", MrSequence);
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            var result6 = sqlConnection.Query(sql, dynamicParameters);
                            if (result6.Count() > 0) throw new SystemException("領退料單詳細資料 + 領料序號重複!");
                            #endregion

                            #region //檢查此料號是否已在ERP製令單身存在，並且為取替代料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TB023
                                    FROM MOCTB a 
                                    WHERE a.TB001 = @WoErpPrefix
                                    AND a.TB002 = @WoErpNo
                                    AND a.TB003 = @MtlItemNo
                                    AND a.TB023 != a.TB003
                                    AND a.TB027 = '2'";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);

                            var CheckSubResult = sqlConnection2.Query(sql, dynamicParameters);

                            string BomMtlItemNo = "";
                            int BomMtlItemId = -1;
                            if (CheckSubResult.Count() > 0)
                            {
                                foreach (var item in CheckSubResult)
                                {
                                    BomMtlItemNo = item.TB023;

                                    #region //取得MES原元件資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MtlItemId
                                            FROM PDM.MtlItem a 
                                            WHERE a.MtlItemNo = @MtlItemNo";
                                    dynamicParameters.Add("MtlItemNo", BomMtlItemNo);

                                    var BomMtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item2 in BomMtlItemResult)
                                    {
                                        BomMtlItemId = item2.MtlItemId;
                                    }
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //檢查此料號是否為製令中某元件替代料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(a.TB003)) TB003
                                        , LTRIM(RTRIM(b.TA006)) TA006
                                        FROM MOCTB a
                                        INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                                        WHERE TB001 = @WoErpPrefix
                                        AND TB002 = @WoErpNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);

                                var CheckMOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                string TempBomMtlItemNo = "";
                                foreach (var item in CheckMOCTBResult)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM BOMMB a 
                                            INNER JOIN INVMB b ON a.MB004 = b.MB001
                                            LEFT JOIN INVMC c ON c.MC001 = a.MB004
                                            INNER JOIN INVMB d ON a.MB001 = d.MB001
                                            WHERE a.MB002 = @BillMtlItemNo
                                            AND a.MB001 = @BomMtlItemNo
                                            AND a.MB004 = @MtlItemNo";
                                    dynamicParameters.Add("BillMtlItemNo", item.TA006);
                                    dynamicParameters.Add("BomMtlItemNo", item.TB003);
                                    dynamicParameters.Add("MtlItemNo", MtlItemNo);

                                    var CheckBOMMBResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (CheckBOMMBResult.Count() > 0)
                                    {
                                        TempBomMtlItemNo = item.TB003;
                                        break;
                                    }
                                }
                                #endregion

                                if (TempBomMtlItemNo != "")
                                {
                                    BomMtlItemNo = TempBomMtlItemNo;

                                    #region //取得MES元件ID
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MtlItemId
                                            FROM PDM.MtlItem a 
                                            WHERE a.MtlItemNo = @BomMtlItemNo";
                                    dynamicParameters.Add("BomMtlItemNo", BomMtlItemNo);

                                    var BomMtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BomMtlItemResult.Count() <= 0) throw new SystemException("查詢MES元件ID時錯誤!!");

                                    foreach (var item in BomMtlItemResult)
                                    {
                                        BomMtlItemId = item.MtlItemId;
                                    }
                                    #endregion
                                }
                                else
                                {
                                    BomMtlItemNo = MtlItemNo;
                                    BomMtlItemId = MtlItemId;
                                }
                            }
                            #endregion

                            #region //檢查此品號材料類型
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MD017)) MD017
                                    FROM BOMMD
                                    INNER JOIN BOMMC ON MD001 = MC001
                                    WHERE MD001 = @MainMtlItemNo
                                    AND MD003 = @MtlItemNo";
                            dynamicParameters.Add("MainMtlItemNo", MainMtlItemNo);
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);

                            var BomDetailResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in BomDetailResult)
                            {
                                if (item.MD017 == "4") throw new SystemException("此料號【" + MtlItemNo + "】設定為不發料，無法新增!!");
                            }
                            #endregion

                            #region //UPDATE MES.MrDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MrDetail SET
                                    MrSequence = @MrSequence,
                                    MtlItemId = @MtlItemId,
                                    Quantity = @Quantity,
                                    ActualQuantity = @ActualQuantity,
                                    UomId = @UomId,
                                    Unit = @Unit,
                                    InventoryId = @InventoryId,
                                    SubInventoryCode = @SubInventoryCode,
                                    LotNumber = @LotNumber,
                                    MoId = @MoId,
                                    WoErpPrefix = @WoErpPrefix,
                                    WoErpNo = @WoErpNo,
                                    DetailDesc = @DetailDesc,
                                    Remark = @Remark,
                                    MaterialCategory = @MaterialCategory,
                                    ProjectCode = @ProjectCode,
                                    BondedStatus = @BondedStatus,
                                    SubstituteStatus = @SubstituteStatus,
                                    SubstitutionId = @SubstitutionId,
                                    SubstitutionMtlItemNo = @SubstitutionMtlItemNo,
                                    SubstituteQty = @SubstituteQty,
                                    SubstituteRate = @SubstituteRate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrDetailId = @MrDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MrSequence,
                                    MtlItemId,
                                    Quantity,
                                    ActualQuantity = (DecompositionFlag == "Y" || BarcodeCtrl == "N") ? Quantity : ActualQuantity,
                                    UomId,
                                    Unit = UomNo,
                                    InventoryId,
                                    SubInventoryCode = InventoryNo,
                                    LotNumber,
                                    MoId,
                                    WoErpPrefix,
                                    WoErpNo,
                                    DetailDesc,
                                    Remark,
                                    MaterialCategory,
                                    ProjectCode,
                                    BondedStatus,
                                    SubstituteStatus,
                                    SubstitutionId = BomMtlItemId,
                                    SubstitutionMtlItemNo = BomMtlItemNo,
                                    SubstituteQty = 0,
                                    SubstituteRate = 0,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MrDetailId
                                });

                            int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //將單頭拋轉狀態改為R
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    TransferStatus = 'R',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  LastModifiedDate,
                                  LastModifiedBy = CurrentUser,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)",
                                data = rowsAffected
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrLotNumber -- 更新領退料批號 -- Shintokuro 2023-10-16
        public string UpdateMrLotNumber(int MrDetailId, string LotNumber, string InventoryNo)
        {
            try
            {
                if (LotNumber.Length > 20) throw new SystemException("【材料庫存批號】長度錯誤!");
                if (LotNumber.Length <= 0) throw new SystemException("【材料庫存批號】不可為空!");

                int InventoryId = -1;
                string ErpDbName = "";
                string ErpNo = "";
                string MtlItemNo = "";
                string DocDate = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //確認是否需要維護批號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.InventoryId
                                ,b.MtlItemNo ,b.LotManagement
                                ,c.ConfirmStatus ,FORMAT(c.DocDate, 'yyyyMMdd') DocDate
                                FROM MES.MrDetail a
                                INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                INNER JOIN MES.MaterialRequisition c on a.MrId = c.MrId
                                WHERE a.MrDetailId = @MrDetailId";
                        dynamicParameters.Add("MrDetailId", MrDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);

                        if (result.Count() <= 0) throw new SystemException("領料單單身找不到,請重新確認");
                        foreach (var item in result)
                        {
                            InventoryId = item.InventoryId;
                            MtlItemNo = item.MtlItemNo;
                            DocDate = item.DocDate;
                            if (item.LotManagement == "N") throw new SystemException("該材料品號不需要維護批號!!");
                            if (item.ConfirmStatus != "N") throw new SystemException("單據須處於未確認狀態下才能異動!!");
                        }
                        #endregion

                        if (InventoryNo != "")
                        {
                            #region //確認庫別是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.InventoryId
                                FROM SCM.Inventory a
                                WHERE a.InventoryNo = @InventoryNo
                                AND a.CompanyId = @CompanyId";
                            dynamicParameters.Add("InventoryNo", InventoryNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            result = sqlConnection.Query(sql, dynamicParameters);

                            if (result.Count() <= 0) throw new SystemException("庫別【" + InventoryNo + "】找不到,請重新確認");
                            foreach (var item in result)
                            {
                                InventoryId = item.InventoryId;
                            }
                            #endregion
                        }

                        #region //UPDATE MES.MrDetail
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MrDetail SET
                                LotNumber = @LotNumber,
                                InventoryId = @InventoryId,
                                SubInventoryCode = @InventoryNo,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MrDetailId = @MrDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LotNumber,
                                InventoryId,
                                InventoryNo,
                                LastModifiedDate,
                                LastModifiedBy,
                                MrDetailId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //ERP公司代碼取得
                        string CompanyNoErp = "";
                        string ExpirationDate = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ME009 
                                FROM INVME
                                WHERE ME001 = @ME001
                                AND ME002 = @ME002";
                        dynamicParameters.Add("ME001", MtlItemNo);
                        dynamicParameters.Add("ME002", LotNumber);

                        var resultCompanyNo = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultCompanyNo)
                        {
                            ExpirationDate = item.ME009;
                        }
                        #endregion

                        if (ExpirationDate != "")
                        {
                            // 將日期字符串轉換為 DateTime 對象
                            DateTime docDate = DateTime.ParseExact(DocDate, "yyyyMMdd", null);
                            DateTime expirationDate = DateTime.ParseExact(ExpirationDate, "yyyyMMdd", null);

                            // 比較日期
                            if (docDate > expirationDate)
                            {
                                throw new SystemException("單據日期已經超過該批號失效日,請重新確認");
                            }
                        }


                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrBomSubstitution -- 使用取替代料取代原領料詳細資料 -- Ann 2023-09-05
        public string UpdateMrBomSubstitution(int MrDetailId, int SubMtlItemId, double Quantity, int BomMtlItemId, double SubQuantity, int InventoryId, int UomId)
        {
            try
            {
                int MoId = -1;
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單詳細資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MrId, a.MoId, a.ProcessCode, a.ConfirmStatus, a.OfficialItemStatus
                                    , a.SubstituteProcessCode, a.SubstituteQty, a.ActualQuantity, a.Quantity
                                    , c.WoId, c.WoErpPrefix, c.WoErpNo
                                    , d.MtlItemNo BillMtlItemNo
                                    , FORMAT(e.DocDate, 'yyyy-MM-dd HH:mm:ss') DocDate
                                    , e.MrErpPrefix
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId =  b.MoId
                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                    INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                    INNER JOIN MES.MaterialRequisition e ON a.MrId = e.MrId
                                    WHERE a.MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單詳細資料有誤!");

                            int MrId = -1;
                            string ConfirmStatus = "";
                            double BomQuantity = -1;
                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            string BillMtlItemNo = "";
                            int WoId = -1;
                            double ActualQuantity = -1;
                            DateTime DocDate = new DateTime();
                            string MrErpPrefix = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N")
                                {
                                    throw new SystemException("領退料單已確認，無法更改!");
                                }

                                MrId = item.MrId;
                                ConfirmStatus = item.ConfirmStatus;
                                BomQuantity = item.Quantity;
                                MoId = item.MoId;
                                WoErpPrefix = item.WoErpPrefix;
                                WoErpNo = item.WoErpNo;
                                BillMtlItemNo = item.BillMtlItemNo;
                                WoId = item.WoId;
                                ActualQuantity = item.ActualQuantity;
                                DocDate = Convert.ToDateTime(item.DocDate);
                                MrErpPrefix = item.MrErpPrefix;
                            }
                            #endregion

                            #region //取得單據性質設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.MQ054)) MQ054
                                    , LTRIM(RTRIM(a.MQ040)) MQ040
                                    FROM CMSMQ a
                                    WHERE a.MQ001 = @MQ001";
                            dynamicParameters.Add("MQ001", MrErpPrefix);
                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP尚未維護此領料單單別(" + MrErpPrefix + ")!!");

                            string ExcessFlag = "";
                            string EffectiveFlag = "";
                            foreach (var item2 in CMSMQResult)
                            {
                                ExcessFlag = item2.MQ054;
                                EffectiveFlag = item2.MQ040;
                            }
                            #endregion

                            #region //判斷取替代料品號資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemNo, MtlItemName, MtlItemSpec
                                    FROM PDM.MtlItem
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", SubMtlItemId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("取替代料品號資料有誤!");

                            string MtlItemNo = "";
                            string MtlItemName = "";
                            string MtlItemSpec = "";
                            foreach (var item in result3)
                            {
                                MtlItemNo = item.MtlItemNo;
                                MtlItemName = item.MtlItemName;
                                MtlItemSpec = item.MtlItemSpec;
                            }
                            #endregion

                            #region //判斷元件品號資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemNo BomMtlItemNo
                                    FROM PDM.MtlItem a 
                                    WHERE a.MtlItemId = @BomMtlItemId";
                            dynamicParameters.Add("BomMtlItemId", BomMtlItemId);

                            var BomMtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                            if (BomMtlItemResult.Count() <= 0) throw new SystemException("元件品號資料有誤!");

                            string BomMtlItemNo = "";
                            foreach (var item in BomMtlItemResult)
                            {
                                BomMtlItemNo = item.BomMtlItemNo;
                            }
                            #endregion

                            #region //確認ERP品號相關資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB004)) UomNo
                                    , LTRIM(RTRIM(MB017)) InventoryNo
                                    , LTRIM(RTRIM(MB030)) MB030
                                    , LTRIM(RTRIM(MB031)) MB031
                                    FROM INVMB
                                    WHERE MB001 = @MB001";
                            dynamicParameters.Add("MB001", MtlItemNo);

                            var INVMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (INVMBResult.Count() <= 0) throw new SystemException("ERP品號基本資料錯誤!!");

                            foreach (var item in INVMBResult)
                            {
                                if (EffectiveFlag == "N")
                                {
                                    #region //判斷ERP品號生效日與失效日
                                    if (item.MB030 != "" && item.MB030 != null)
                                    {
                                        #region //判斷日期需大於或等於生效日
                                        string EffectiveDate = item.MB030;
                                        string effYear = EffectiveDate.Substring(0, 4);
                                        string effMonth = EffectiveDate.Substring(4, 2);
                                        string effDay = EffectiveDate.Substring(6, 2);
                                        DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                        int effresult = DateTime.Compare(DocDate, effFullDate);
                                        if (effresult < 0) throw new SystemException("此品號尚未生效，無法使用!!");
                                        #endregion
                                    }

                                    if (item.MB031 != "" && item.MB031 != null)
                                    {
                                        #region //判斷日期需小於或等於失效日
                                        string ExpirationDate = item.MB031;
                                        string effYear = ExpirationDate.Substring(0, 4);
                                        string effMonth = ExpirationDate.Substring(4, 2);
                                        string effDay = ExpirationDate.Substring(6, 2);
                                        DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                        int effresult = DateTime.Compare(DocDate, effFullDate);
                                        if (effresult > 0) throw new SystemException("此品號已失效，無法使用!!");
                                        #endregion
                                    }
                                    #endregion
                                }
                            }
                            #endregion

                            #region //確認取替代件單位資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UomNo
                                    FROM PDM.UnitOfMeasure a 
                                    WHERE a.UomId = @UomId";
                            dynamicParameters.Add("UomId", UomId);

                            var UomResult = sqlConnection.Query(sql, dynamicParameters);

                            if (UomResult.Count() <= 0) throw new SystemException("取替代件單位資料錯誤!!");

                            string UomNo = "";
                            foreach (var item in UomResult)
                            {
                                UomNo = item.UomNo;
                            }
                            #endregion

                            #region //確認取替代件庫別資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.InventoryNo
                                    FROM SCM.Inventory a 
                                    WHERE a.InventoryId = @InventoryId";
                            dynamicParameters.Add("InventoryId", InventoryId);

                            var InventoryResult = sqlConnection.Query(sql, dynamicParameters);

                            if (InventoryResult.Count() <= 0) throw new SystemException("取替代件庫別資料錯誤!!");

                            string InventoryNo = "";
                            foreach (var item in InventoryResult)
                            {
                                InventoryNo = item.InventoryNo;
                            }
                            #endregion

                            #region //檢查此取替代料庫存
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MC007
                                    FROM INVMC
                                    WHERE MC001 = @MtlItemNo
                                    AND MC002 = @InventoryNo";
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);
                            dynamicParameters.Add("InventoryNo", InventoryNo);

                            var INVMCResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVMCResult)
                            {
                                if (Convert.ToDouble(item.MC007) < Quantity) throw new SystemException("此取替代件【" + MtlItemNo + "】在庫別【" + InventoryNo + "】庫存不足!!");
                            }
                            #endregion

                            #region //UPDATE MES.MrDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MrDetail SET
                                    MtlItemId = @MtlItemId,
                                    Quantity = @Quantity,
                                    ActualQuantity = @ActualQuantity,
                                    UomId = @UomId,
                                    Unit = @Unit,
                                    InventoryId = @InventoryId,
                                    SubInventoryCode = @SubInventoryCode,
                                    SubstitutionId = @SubstitutionId,
                                    SubstitutionMtlItemNo = @SubstitutionMtlItemNo,
                                    SubstituteQty = @SubstituteQty,
                                    SubstituteRate = @SubstituteRate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrDetailId = @MrDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MtlItemId = SubMtlItemId,
                                    Quantity,
                                    ActualQuantity,
                                    UomId,
                                    Unit = UomNo,
                                    InventoryId,
                                    SubInventoryCode = InventoryNo,
                                    SubstitutionId = BomMtlItemId,
                                    SubstitutionMtlItemNo = BomMtlItemNo,
                                    SubstituteQty = BomQuantity,
                                    SubstituteRate = SubQuantity,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MrDetailId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrTransfer -- 將MES領料單上拋ERP，但不核單 -- Ann 2022-08-29
        public string UpdateMrTransfer(int MrId)
        {
            try
            {
                AddUserOperateLog(MrId);

                List<MaterialRequisition> materialRequisitions = new List<MaterialRequisition>();
                List<MrWipOrder> mrWipOrders = new List<MrWipOrder>();
                List<MrDetail> mrDetails = new List<MrDetail>();

                List<MOCTC> moctcs = new List<MOCTC>();
                List<MOCTD> moctds = new List<MOCTD>();
                List<MOCTE> moctes = new List<MOCTE>();

                string MrErpPrefix = "";
                string MrErpNo = "";
                int rowsAffected = 0;
                string ErpNo = "";
                string ErpDbName = "";
                string DetailDesc = "";
                int UserId = CreateBy;
                string ExcessFlag = "";

                int currentNum = 0, yearLength = 0, lineLength = 0;
                string encode = "", paymentTerm = "", factory = "";
                DateTime referenceTime = default(DateTime);

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (BaseHelper.CheckUserAuthority(UserId, CurrentCompany, "A", "MaterialRequisition", "data-transfer", sqlConnection).Equals("N")) throw new SystemException("人員權限檢核有異常，請嘗試重新登入!");

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //取得MES.MaterialRequisition資料(MOCTC)
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.MrId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.CompanyId, a.MrErpPrefix, a.MrErpNo, FORMAT(a.MrDate, 'yyyyMMdd') MrDate, FORMAT(a.DocDate, 'yyyyMMdd') DocDate, a.DocType, a.ProductionLine, a.Remark
                                , a.JournalStatus, a.PriorityType, a.NegativeStatus, a.SignupStatus, a.SourceType, a.ConfirmStatus, FORMAT(a.CreateDate, 'yyyyMMdd') CreateDate
                                , FORMAT(a.CreateDate, 'HH:mm:ss') CreateTime, a.CreateBy, a.TransferStatus, FORMAT(a.DocDate, 'yyyy-MM-dd') MrDocDate, a.ContractManufacturer
                                , b.UserNo ConfirmUserNo
                                , c.UserNo CreateUserNo";
                            sqlQuery.mainTables =
                                @"FROM MES.MaterialRequisition a
                                LEFT JOIN BAS.[User] b ON a.ConfirmUserId = b.UserId
                                INNER JOIN BAS.[User] c ON a.CreateBy = c.UserId";
                            sqlQuery.auxTables = "";
                            string queryCondition = @"AND a.CompanyId = @CompanyId AND a.MrId = @MrId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("MrId", MrId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            materialRequisitions = BaseHelper.SqlQuery<MaterialRequisition>(sqlConnection, dynamicParameters, sqlQuery);
                            if (materialRequisitions.Count() <= 0) throw new SystemException("領退料單資料有誤!");
                            if (materialRequisitions[0].ConfirmStatus != "N") throw new SystemException("領退料單狀態無法重複拋轉!");
                            if (materialRequisitions[0].CompanyId != CurrentCompany) throw new SystemException("使用者公司別與單據公司別不同，請嘗試重新登入!!");
                            MrErpPrefix = materialRequisitions[0].MrErpPrefix;
                            MrErpNo = materialRequisitions[0].MrErpNo;
                            #endregion

                            #region //確認此領料單是否為超領單別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.MQ010)) MQ010
                                    , LTRIM(RTRIM(a.MQ040)) MQ040
                                    , LTRIM(RTRIM(a.MQ054)) MQ054
                                    FROM CMSMQ a
                                    WHERE a.MQ001 = @MQ001";
                            dynamicParameters.Add("MQ001", materialRequisitions[0].MrErpPrefix);
                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP尚未維護此領料單單別(" + materialRequisitions[0].MrErpPrefix + ")!!");

                            int MQ010 = -1;
                            string EffectiveFlag = "";
                            foreach (var item2 in CMSMQResult)
                            {
                                ExcessFlag = item2.MQ054;
                                MQ010 = Convert.ToInt32(item2.MQ010);
                                EffectiveFlag = item2.MQ040;
                            }
                            #endregion

                            #region //確認ERP單頭(MOCTC)確認狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TC009)) ConfirmStatus
                                    FROM MOCTC
                                    WHERE TC001 = @TC001
                                    AND TC002 = @TC002";
                            dynamicParameters.Add("TC001", materialRequisitions[0].MrErpPrefix);
                            dynamicParameters.Add("TC002", materialRequisitions[0].MrErpNo);
                            var ErpTcConfirmStatusReesult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in ErpTcConfirmStatusReesult)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("此單據已核准，無法拋轉!!");
                            }
                            #endregion

                            #region //確認ERP單身(MOCTE)確認狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TE019)) ConfirmStatus
                                    FROM MOCTE
                                    WHERE TE001 = @TE001
                                    AND TE002 = @TE002";
                            dynamicParameters.Add("TE001", materialRequisitions[0].MrErpPrefix);
                            dynamicParameters.Add("TE002", materialRequisitions[0].MrErpNo);
                            var ErpTeConfirmStatusReesult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in ErpTeConfirmStatusReesult)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("此單據已核准，無法拋轉!!");
                            }
                            #endregion

                            #region //取得MES.MrWipOrder資料(MOCTD)
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.MrId, a.MoId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.WoErpPrefix, a.WoErpNo, a.MrType, a.Quantity, a.InventoryId, a.SubInventoryCode, a.RequisitionCode, a.NegativeStatus, a.Remark
                                , a.MaterialCategory, a.SubinventoryType, a.LineSeq, FORMAT(a.CreateDate, 'yyyyMMdd') CreateDate, FORMAT(a.CreateDate, 'HH:mm:dd') CreateTime
                                , b.InventoryNo
                                , c.UserNo CreateUserNo";
                            sqlQuery.mainTables =
                                @"FROM MES.MrWipOrder a
                                INNER JOIN SCM.Inventory b ON a.InventoryId = b.InventoryId
                                INNER JOIN BAS.[User] c ON a.CreateBy = c.UserId";
                            sqlQuery.auxTables = "";
                            queryCondition = @"AND a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            mrWipOrders = BaseHelper.SqlQuery<MrWipOrder>(sqlConnection, dynamicParameters, sqlQuery);
                            //if (mrWipOrders.Count() <= 0 && ExcessFlag != "N") throw new SystemException("領退料單設定資料有誤!");
                            #endregion

                            #region //取得MES.MrDetail資料(MOCTE)
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.MrDetailId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.MrSequence, a.MtlItemId, a.Quantity, a.ActualQuantity, a.Unit, a.SubInventoryCode, a.ProcessCode, a.LotNumber, a.MoId, a.WoErpPrefix, a.WoErpNo, a.DetailDesc, a.Remark
                                , a.MaterialCategory, a.ConfirmStatus, a.ProjectCode, a.BondedStatus, a.SubstituteStatus, a.OfficialItemStatus, a.SubstitutionMtlItemNo, a.StorageLocation, a.InventoryId
                                , a.SubstituteProcessCode, a.SubstituteQty, a.SubstituteRate, FORMAT(a.CreateDate, 'yyyyMMdd') CreateDate, FORMAT(a.CreateDate, 'HH:mm:dd') CreateTime
                                , b.UserNo CreateUserNo
                                , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec, c.LotManagement
                                , d.InventoryNo
                                , g.MtlItemNo BillMtlItemNo
                                , h.UomNo";
                            sqlQuery.mainTables =
                                @"FROM MES.MrDetail a
                                INNER JOIN BAS.[User] b ON a.CreateBy = b.UserId
                                INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
                                INNER JOIN SCM.Inventory d ON a.InventoryId = d.InventoryId
                                INNER JOIN MES.ManufactureOrder e ON a.MoId = e.MoId
                                INNER JOIN MES.WipOrder f ON e.WoId = f.WoId
                                INNER JOIN PDM.MtlItem g ON f.MtlItemId = g.MtlItemId
                                INNEr JOIN PDM.UnitOfMeasure h ON a.UomId = h.UomId";
                            sqlQuery.auxTables = "";
                            queryCondition = @"AND a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            mrDetails = BaseHelper.SqlQuery<MrDetail>(sqlConnection, dynamicParameters, sqlQuery);
                            //if (mrDetails.Count() <= 0) throw new SystemException("領退料單詳細資料有誤!");

                            foreach (var item in mrDetails)
                            {
                                if (item.LotManagement != "N")
                                {
                                    if (item.LotNumber == "") throw new SystemException("材料品號【" + item.MtlItemNo + "】需要維護批號,請重新確認!");
                                }

                                if (ExcessFlag == "N")
                                {
                                    if (item.Remark.ToString().Length <= 0) throw new SystemException("超領單別備註為必填欄位，請確認領料序號【" + item.MrSequence + "】備註是否已填!!");

                                    #region //確認物料是否有進行NG拆盤
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.NgQty, a.AlreadyQty
                                            FROM MES.TrayMtlItemNg a 
                                            INNER JOIN PDM.BomDetail b ON a.BomDetailId = b.BomDetailId
                                            WHERE a.MoId = @MoId
                                            AND b.MtlItemId = @MtlItemId";
                                    dynamicParameters.Add("MoId", item.MoId);
                                    dynamicParameters.Add("MtlItemId", item.MtlItemId);

                                    var TrayMtlItemNgResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item2 in TrayMtlItemNgResult)
                                    {
                                        //if ((Convert.ToDouble(item.Quantity) + Convert.ToDouble(item2.AlreadyQty)) > item2.NgQty) throw new SystemException("此用料【" + item.MtlItemNo + "】已進行NG拆盤。<br>剩餘可超領數量為【" + (item2.NgQty - item2.AlreadyQty) + "】!!");
                                    }
                                    #endregion
                                }
                            }
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "MaterialRequisition");
                            dynamicParameters.Add("DetailCode", "data-transfer");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            #region //審核ERP權限
                            string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "MOCI03", "CREATE");
                            #endregion

                            #region //查詢ERP資料庫中是否已經有此領退料單
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.TC001, a.TC002";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", LTRIM(RTRIM(a.COMPANY)) COMPANY, LTRIM(RTRIM(a.MODIFIER)) MODIFIER, LTRIM(RTRIM(a.USR_GROUP)) USR_GROUP, LTRIM(RTRIM(a.MODI_DATE)) MODI_DATE
                                , LTRIM(RTRIM(a.FLAG)) FLAG, LTRIM(RTRIM(a.MODI_TIME)) MODI_TIME, LTRIM(RTRIM(a.TC009)) TC009
                                , LTRIM(RTRIM(a.TC010)) TC010, LTRIM(RTRIM(a.TC015)) TC015, LTRIM(RTRIM(a.TC016)) TC016, LTRIM(RTRIM(a.TC017)) TC017, LTRIM(RTRIM(a.TC018)) TC018
                                , LTRIM(RTRIM(a.TC020)) TC020, LTRIM(RTRIM(a.TC021)) TC021, LTRIM(RTRIM(a.TC022)) TC022, LTRIM(RTRIM(a.TC023)) TC023, LTRIM(RTRIM(a.UDF06)) UDF06
                                , LTRIM(RTRIM(a.UDF07)) UDF07, LTRIM(RTRIM(a.UDF08)) UDF08, LTRIM(RTRIM(a.UDF09)) UDF09, LTRIM(RTRIM(a.UDF10)) UDF10";
                            sqlQuery.mainTables =
                                @"FROM MOCTC a";
                            sqlQuery.auxTables = "";
                            queryCondition = @"AND a.TC001 = @TC001 AND a.TC002 = @TC002";
                            dynamicParameters.Add("TC001", materialRequisitions[0].MrErpPrefix);
                            dynamicParameters.Add("TC002", materialRequisitions[0].MrErpNo);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            moctcs = BaseHelper.SqlQuery<MOCTC>(sqlConnection2, dynamicParameters, sqlQuery);
                            #endregion

                            #region //查詢廠別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB001)) MB001 FROM CMSMB";
                            var CMSMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMBResult.Count() <= 0) throw new SystemException("找不到廠別!!");
                            if (CMSMBResult.Count() > 1) throw new SystemException("廠別數有多個，請與資訊人員確認!!");

                            string TC004 = "";
                            foreach (var item in CMSMBResult)
                            {
                                TC004 = item.MB001;
                            }
                            #endregion

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            DateTime erpDateTime = new DateTime();
                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(materialRequisitions[0].MrDocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + materialRequisitions[0].MrDocDate + ")之單據!!");
                            }
                            #endregion

                            if (moctcs.Count() > 0)
                            {
                                #region //UPDATE ERP TABLE
                                #region //MOCTC 領料單單頭
                                foreach (var item in moctcs)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MOCTC SET
                                            COMPANY = @COMPANY,
                                            MODIFIER = @MODIFIER,
                                            USR_GROUP = @USR_GROUP,
                                            MODI_DATE = @MODI_DATE,
                                            FLAG = @FLAG,
                                            MODI_TIME = @MODI_TIME,
                                            TC001 = @TC001,
                                            TC002 = @TC002,
                                            TC003 = @TC003,
                                            TC004 = @TC004,
                                            TC005 = @TC005,
                                            TC006 = @TC006,
                                            TC007 = @TC007,
                                            TC008 = @TC008,
                                            TC009 = @TC009,
                                            TC010 = @TC010,
                                            TC011 = @TC011,
                                            TC012 = @TC012,
                                            TC013 = @TC013,
                                            TC014 = @TC014,
                                            TC015 = @TC015,
                                            TC016 = @TC016,
                                            TC017 = @TC017,
                                            TC018 = @TC018,
                                            TC019 = @TC019,
                                            TC020 = @TC020,
                                            TC021 = @TC021,
                                            TC022 = @TC022,
                                            TC023 = @TC023,
                                            UDF06 = @UDF06,
                                            UDF07 = @UDF07,
                                            UDF08 = @UDF08,
                                            UDF09 = @UDF09,
                                            UDF10 = @UDF10
                                            WHERE TC001 = @TC001
                                            AND TC002 = @TC002";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            COMPANY = ErpNo,
                                            item.MODIFIER,
                                            USR_GROUP,
                                            item.MODI_DATE,
                                            FLAG = "3",
                                            item.MODI_TIME,
                                            item.TC001,
                                            item.TC002,
                                            TC003 = materialRequisitions[0].MrDate,
                                            TC004,
                                            TC005 = materialRequisitions[0].ProductionLine,
                                            TC006 = materialRequisitions[0].ContractManufacturer,
                                            TC007 = materialRequisitions[0].Remark,
                                            TC008 = materialRequisitions[0].DocType,
                                            item.TC009,
                                            item.TC010,
                                            TC011 = materialRequisitions[0].JournalStatus,
                                            TC012 = materialRequisitions[0].PriorityType,
                                            TC013 = materialRequisitions[0].NegativeStatus,
                                            TC014 = materialRequisitions[0].DocDate,
                                            item.TC015,
                                            item.TC016,
                                            item.TC017,
                                            item.TC018,
                                            TC019 = materialRequisitions[0].SourceType,
                                            item.TC020,
                                            item.TC021,
                                            item.TC022,
                                            item.TC023,
                                            item.UDF06,
                                            item.UDF07,
                                            item.UDF08,
                                            item.UDF09,
                                            item.UDF10
                                        });

                                    rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                }
                                #endregion

                                #region //MOCTD 領料單單身設定
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE MOCTD
                                        WHERE TD001 = @TD001
                                        AND TD002 = @TD002";
                                dynamicParameters.Add("TD001", materialRequisitions[0].MrErpPrefix);
                                dynamicParameters.Add("TD002", materialRequisitions[0].MrErpNo);

                                rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);

                                List<string> MrWipOrderMoIdList = new List<string>();
                                int count = 0;
                                foreach (var item in mrWipOrders)
                                {
                                    #region //確認ERP工單(MOCTA)狀態
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT LTRIM(RTRIM(TA011)) Status
                                            , LTRIM(RTRIM(TA014)) FinishDate
                                            FROM MOCTA
                                            WHERE TA001 = @TA001
                                            AND TA002 = @TA002";
                                    dynamicParameters.Add("TA001", item.WoErpPrefix);
                                    dynamicParameters.Add("TA002", item.WoErpNo);
                                    var WoErpStatusReesult = sqlConnection2.Query(sql, dynamicParameters);

                                    foreach (var item2 in WoErpStatusReesult)
                                    {
                                        if (item2.Status == "Y" || item2.Status == "y")
                                        {
                                            #region //若最後完工日已關帳，不可再開立領料單
                                            string finishDate = item2.FinishDate;
                                            string erpYear = finishDate.Substring(0, 4);
                                            string erpMonth = finishDate.Substring(4, 2);
                                            string erpDay = finishDate.Substring(6, 2);
                                            string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                            DateTime moctaErpDateTime = Convert.ToDateTime(erpFullDate);

                                            int compare = moctaErpDateTime.CompareTo(erpDateTime);
                                            if (compare <= 0) throw new SystemException("製令狀態已完工，且最後入庫日已關帳，無法開立!!");
                                            #endregion
                                        }
                                    }
                                    #endregion

                                    if (MrWipOrderMoIdList.IndexOf(item.WoErpPrefix + "-" + item.WoErpNo) != -1)
                                    {
                                        #region //重複的製令，將此次套數加回上次MOCTD套數
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MOCTD SET
                                                TD006 = TD006 + @Quantity
                                                WHERE TD001 = @TD001
                                                AND TD002 = @TD002
                                                AND TD003 = @TD003
                                                AND TD004 = @TD004";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              item.Quantity,
                                              TD001 = materialRequisitions[0].MrErpPrefix,
                                              TD002 = materialRequisitions[0].MrErpNo,
                                              TD003 = item.WoErpPrefix,
                                              TD004 = item.WoErpNo
                                          });

                                        rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                    else
                                    {
                                        if (item.MrType == "4")
                                        {
                                            mrWipOrders[count].MrType = "1";
                                        }
                                        else if (item.MrType == "5")
                                        {
                                            mrWipOrders[count].MrType = "3";
                                        }

                                        MrWipOrderMoIdList.Add(item.WoErpPrefix + "-" + item.WoErpNo);

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MOCTD (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, CREATE_TIME
                                                , TD001, TD002, TD003, TD004, TD005, TD006, TD007, TD008, TD009, TD010, TD011, TD012, TD013
                                                , TD014, TD015, TD016, TD017, TD018, TD019, TD020, TD021, TD022, TD023, TD024, TD025, UDF06
                                                , UDF07, UDF08, UDF09, UDF10)
                                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @FLAG, @CREATE_TIME
                                                , @TD001, @TD002, @TD003, @TD004, @TD005, @TD006, @TD007, @TD008, @TD009, @TD010, @TD011, @TD012, @TD013
                                                , @TD014, @TD015, @TD016, @TD017, @TD018, @TD019, @TD020, @TD021, @TD022, @TD023, @TD024, @TD025, @UDF06
                                                , @UDF07, @UDF08, @UDF09, @UDF10)";

                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              COMPANY = ErpNo,
                                              CREATOR = materialRequisitions[0].CreateUserNo,
                                              USR_GROUP,
                                              CREATE_DATE = item.CreateDate,
                                              FLAG = "1",
                                              CREATE_TIME = item.CreateTime,
                                              TD001 = materialRequisitions[0].MrErpPrefix,
                                              TD002 = materialRequisitions[0].MrErpNo,
                                              TD003 = item.WoErpPrefix,
                                              TD004 = item.WoErpNo,
                                              TD005 = mrWipOrders[count].MrType,
                                              TD006 = item.Quantity,
                                              TD007 = item.InventoryNo,
                                              TD008 = item.RequisitionCode,
                                              TD009 = "",
                                              TD010 = "",
                                              TD011 = "",
                                              TD012 = "",
                                              TD013 = "N",
                                              TD014 = item.Remark,
                                              TD015 = item.MaterialCategory,
                                              TD016 = "",
                                              TD017 = item.SubinventoryType,
                                              TD018 = "",
                                              TD019 = "",
                                              TD020 = "",
                                              TD021 = "",
                                              TD022 = "",
                                              TD023 = item.LineSeq,
                                              TD024 = 0.000000,
                                              TD025 = 0.000000,
                                              UDF06 = 0.000000,
                                              UDF07 = 0.000000,
                                              UDF08 = 0.000000,
                                              UDF09 = 0.000000,
                                              UDF10 = 0.000000,
                                          });
                                        var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();
                                    }

                                    count++;
                                }
                                #endregion

                                #region //MOCTE 領料單單身
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE MOCTE
                                        WHERE TE001 = @TE001
                                        AND TE002 = @TE002";
                                dynamicParameters.Add("TE001", materialRequisitions[0].MrErpPrefix);
                                dynamicParameters.Add("TE002", materialRequisitions[0].MrErpNo);

                                rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);

                                foreach (var item in mrDetails)
                                {
                                    if (MQ010 < 0)
                                    {
                                        DetailDesc = erpHelper.GetDetailDesc(item.MtlItemNo, item.InventoryNo, MrErpPrefix, MrErpNo, MrId, (int)item.MtlItemId, (int)item.InventoryId, (double)item.Quantity, (int)item.MrDetailId
                                            , sqlConnection, sqlConnection2);
                                    }
                                    else
                                    {
                                        DetailDesc = item.DetailDesc;
                                    }

                                    string TE024 = "";
                                    #region //查詢此料號在製令單身的替代料欄位
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT b.Substitute
                                            FROM MES.MoMtlSetting a 
                                            INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                            WHERE a.MoId = @MoId
                                            AND b.MtlItemId = @MtlItemId";
                                    dynamicParameters.Add("MoId", item.MoId);
                                    dynamicParameters.Add("MtlItemId", item.MtlItemId);

                                    var SubstituteResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (SubstituteResult.Count() > 0)
                                    {
                                        foreach (var item2 in SubstituteResult)
                                        {
                                            TE024 = item2.Substitute;
                                        }
                                    }
                                    #endregion

                                    #region //確認ERP品號相關資料是否正確
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT LTRIM(RTRIM(MB004)) MB004
                                            , LTRIM(RTRIM(MB030)) MB030
                                            , LTRIM(RTRIM(MB031)) MB031
                                            FROM INVMB
                                            WHERE MB001 = @MB001";
                                    dynamicParameters.Add("MB001", item.MtlItemNo);

                                    var INVMBResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (INVMBResult.Count() <= 0) throw new SystemException("ERP品號基本資料錯誤!!");

                                    foreach (var item2 in INVMBResult)
                                    {
                                        #region //比對單位與ERP品號基本資料單位是否相同
                                        if (item2.MB004 != item.UomNo) throw new SystemException("物料單位(" + item.UomNo + ")與ERP品號庫存單位(" + item2.MB004 + ")不同!!");
                                        #endregion

                                        if (EffectiveFlag == "N")
                                        {
                                            #region //判斷ERP品號生效日與失效日
                                            if (item2.MB030 != "" && item2.MB030 != null)
                                            {
                                                #region //判斷單據日期需大於或等於生效日
                                                string EffectiveDate = item2.MB030;
                                                string effYear = EffectiveDate.Substring(0, 4);
                                                string effMonth = EffectiveDate.Substring(4, 2);
                                                string effDay = EffectiveDate.Substring(6, 2);
                                                DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                                int effresult = DateTime.Compare(materialRequisitions[0].MrDocDate, effFullDate);
                                                if (effresult < 0) throw new SystemException("此品號尚未生效，無法使用!!");
                                                #endregion
                                            }

                                            if (item2.MB031 != "" && item2.MB031 != null)
                                            {
                                                #region //判斷日期需小於或等於失效日
                                                string ExpirationDate = item2.MB031;
                                                string effYear = ExpirationDate.Substring(0, 4);
                                                string effMonth = ExpirationDate.Substring(4, 2);
                                                string effDay = ExpirationDate.Substring(6, 2);
                                                DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                                int effresult = DateTime.Compare(materialRequisitions[0].MrDocDate, effFullDate);
                                                if (effresult > 0) throw new SystemException("此品號已失效，無法使用!!");
                                                #endregion
                                            }
                                            #endregion
                                        }
                                    }
                                    #endregion

                                    #region //INSERT MOCTE
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MOCTE (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, CREATE_TIME
                                            , TE001, TE002, TE003, TE004, TE005, TE006, TE007, TE008, TE009, TE010, TE011, TE012, TE013
                                            , TE014, TE015, TE016, TE017, TE018, TE019, TE020, TE021, TE022, TE023, TE024, TE025, TE026
                                            , TE027, TE028, TE029, TE030, TE031, TE032, TE033, TE034, TE035, TE036, TE037
                                            , UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @FLAG, @CREATE_TIME
                                            , @TE001, @TE002, @TE003, @TE004, @TE005, @TE006, @TE007, @TE008, @TE009, @TE010, @TE011, @TE012, @TE013
                                            , @TE014, @TE015, @TE016, @TE017, @TE018, @TE019, @TE020, @TE021, @TE022, @TE023, @TE024, @TE025, @TE026
                                            , @TE027, @TE028, @TE029, @TE030, @TE031, @TE032, @TE033, @TE034, @TE035, @TE036, @TE037
                                            , @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";

                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          COMPANY = ErpNo,
                                          CREATOR = materialRequisitions[0].CreateUserNo,
                                          USR_GROUP,
                                          CREATE_DATE = materialRequisitions[0].CreateDate,
                                          FLAG = "1",
                                          CREATE_TIME = item.CreateTime,
                                          TE001 = materialRequisitions[0].MrErpPrefix,
                                          TE002 = materialRequisitions[0].MrErpNo,
                                          TE003 = item.MrSequence,
                                          TE004 = item.MtlItemNo,
                                          TE005 = item.Quantity,
                                          TE006 = item.Unit,
                                          TE007 = "",
                                          TE008 = item.SubInventoryCode,
                                          TE009 = item.ProcessCode,
                                          TE010 = item.LotNumber,
                                          TE011 = item.WoErpPrefix,
                                          TE012 = item.WoErpNo,
                                          TE013 = DetailDesc,
                                          TE014 = item.Remark,
                                          TE015 = "",
                                          TE016 = item.MaterialCategory,
                                          TE017 = item.MtlItemName,
                                          TE018 = item.MtlItemSpec,
                                          TE019 = item.ConfirmStatus,
                                          TE020 = item.ProjectCode,
                                          TE021 = 0.000,
                                          TE022 = "",
                                          TE023 = item.BondedStatus,
                                          TE024,
                                          TE025 = 0,
                                          TE026 = "2",
                                          TE027 = item.SubstitutionMtlItemNo,
                                          TE028 = item.SubstituteProcessCode,
                                          TE029 = item.StorageLocation,
                                          TE030 = item.SubstituteQty, //取替代數量
                                          TE031 = 0.000,
                                          TE032 = item.SubstituteRate,
                                          TE033 = 0.000,
                                          TE034 = "",
                                          TE035 = "",
                                          TE036 = 0.000000,
                                          TE037 = 0.000000,
                                          UDF06 = 0.000000,
                                          UDF07 = 0.000000,
                                          UDF08 = 0.000000,
                                          UDF09 = 0.000000,
                                          UDF10 = 0.000000,
                                      });
                                    var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion

                                    #region //UPDATE MES.MrDetail DetailDesc
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.MrDetail SET
                                            DetailDesc = @DetailDesc,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE MrDetailId = @MrDetailId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          DetailDesc,
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          item.MrDetailId
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion
                                #endregion
                            }
                            else
                            {
                                referenceTime = DateTime.ParseExact(materialRequisitions[0].DocDate, "yyyyMMdd", CultureInfo.InvariantCulture);

                                #region //單據設定
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MQ004, a.MQ005, a.MQ006, a.MQ044
                                        FROM CMSMQ a
                                        WHERE a.COMPANY = @CompanyNo
                                        AND a.MQ001 = @ErpPrefix";
                                dynamicParameters.Add("CompanyNo", ErpNo);
                                dynamicParameters.Add("ErpPrefix", materialRequisitions[0].MrErpPrefix);

                                var resultDocSetting = sqlConnection2.Query(sql, dynamicParameters);
                                if (resultDocSetting.Count() <= 0) throw new SystemException("ERP單據設定資料不存在!");

                                foreach (var item in resultDocSetting)
                                {
                                    encode = item.MQ004; //編碼方式
                                    yearLength = Convert.ToInt32(item.MQ005); //年碼數
                                    lineLength = Convert.ToInt32(item.MQ006); //流水號碼數
                                }
                                #endregion

                                #region //單號取號
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TC002))), '" + new string('0', lineLength) + @"'), " + lineLength + @")) + 1 CurrentNum
                                        FROM MOCTC
                                        WHERE TC001 = @ErpPrefix";
                                dynamicParameters.Add("ErpPrefix", materialRequisitions[0].MrErpPrefix);

                                #region //編碼方式
                                string dateFormat = "";
                                switch (encode)
                                {
                                    case "1": //日編
                                        dateFormat = new string('y', yearLength) + "MMdd";
                                        sql += @" AND RTRIM(LTRIM(TC002)) LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                        dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                        MrErpNo = referenceTime.ToString(dateFormat);
                                        break;
                                    case "2": //月編
                                        dateFormat = new string('y', yearLength) + "MM";
                                        sql += @" AND RTRIM(LTRIM(TC002)) LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                        dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                        MrErpNo = referenceTime.ToString(dateFormat);
                                        break;
                                    case "3": //流水號
                                        break;
                                    case "4": //手動編號
                                        break;
                                    default:
                                        throw new SystemException("編碼方式錯誤!");
                                }
                                #endregion

                                currentNum = sqlConnection2.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                                MrErpNo += string.Format("{0:" + new string('0', lineLength) + "}", currentNum);
                                materialRequisitions[0].MrErpNo = MrErpNo;
                                #endregion

                                #region //找單據開立日期退領料單數
                                //dynamicParameters = new DynamicParameters();
                                //sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TC002))), '000'), 3)) + 1 CurrentNum
                                //        FROM MOCTC
                                //        WHERE TC001 = @TC001
                                //        AND TC002 LIKE '%" + materialRequisitions[0].DocDate + "%'";
                                //dynamicParameters.Add("TC001", materialRequisitions[0].MrErpPrefix);

                                //var result5 = sqlConnection2.Query(sql, dynamicParameters);
                                //int CurrentNum = 0;
                                //foreach (var item in result5)
                                //{
                                //    CurrentNum = item.CurrentNum;
                                //}

                                //string seq = CurrentNum.ToString().PadLeft(3, '0');
                                //MrErpNo = materialRequisitions[0].DocDate + seq;
                                //materialRequisitions[0].MrErpNo = MrErpNo;
                                #endregion

                                #region //INSERT MOCTC 領退料單單頭
                                foreach (var item in materialRequisitions)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MOCTC (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TC001, TC002, TC003, TC004, TC005, TC006, TC007, TC008, TC009, TC010, TC011, TC012, TC013
                                            , TC014, TC015, TC016, TC017, TC018, TC019, TC020, TC021, TC022, TC023, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TC001, @TC002, @TC003, @TC004, @TC005, @TC006, @TC007, @TC008, @TC009, @TC010, @TC011, @TC012, @TC013
                                            , @TC014, @TC015, @TC016, @TC017, @TC018, @TC019, @TC020, @TC021, @TC022, @TC023, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";

                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          COMPANY = ErpNo,
                                          CREATOR = materialRequisitions[0].CreateUserNo,
                                          USR_GROUP,
                                          CREATE_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                          MODIFIER = "",
                                          MODI_DATE = "",
                                          FLAG = "1",
                                          CREATE_TIME = item.CreateTime,
                                          CREATE_AP = "ERP-API",
                                          CREATE_PRID = "BM",
                                          MODI_TIME = "",
                                          MODI_AP = "",
                                          MODI_PRID = "",
                                          TC001 = item.MrErpPrefix,
                                          TC002 = MrErpNo,
                                          TC003 = item.MrDate,
                                          TC004,
                                          TC005 = item.ProductionLine,
                                          TC006 = materialRequisitions[0].ContractManufacturer,
                                          TC007 = item.Remark,
                                          TC008 = item.DocType,
                                          TC009 = "N",
                                          TC010 = "0",
                                          TC011 = item.JournalStatus,
                                          TC012 = item.PriorityType,
                                          TC013 = item.NegativeStatus,
                                          TC014 = item.DocDate,
                                          TC015 = "",
                                          TC016 = item.ConfirmStatus,
                                          TC017 = "0",
                                          TC018 = "0",
                                          TC019 = "0",
                                          TC020 = "",
                                          TC021 = "",
                                          TC022 = 0.000000,
                                          TC023 = 0.000000,
                                          UDF06 = 0.000000,
                                          UDF07 = 0.000000,
                                          UDF08 = 0.000000,
                                          UDF09 = 0.000000,
                                          UDF10 = 0.000000,
                                      });
                                    var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                }
                                #endregion

                                #region //INSERT MOCTD 領料單單身設定

                                List<string> MrWipOrderMoIdList = new List<string>();
                                int count = 0;
                                foreach (var item in mrWipOrders)
                                {
                                    #region //確認ERP工單(MOCTA)狀態
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT LTRIM(RTRIM(TA011)) Status
                                            , LTRIM(RTRIM(TA014)) FinishDate
                                            FROM MOCTA
                                            WHERE TA001 = @TA001
                                            AND TA002 = @TA002";
                                    dynamicParameters.Add("TA001", item.WoErpPrefix);
                                    dynamicParameters.Add("TA002", item.WoErpNo);
                                    var WoErpStatusReesult = sqlConnection2.Query(sql, dynamicParameters);

                                    foreach (var item2 in WoErpStatusReesult)
                                    {
                                        if (item2.Status == "Y" || item2.Status == "y")
                                        {
                                            #region //若最後完工日已關帳，不可再開立領料單
                                            string finishDate = item2.FinishDate;
                                            string erpYear = finishDate.Substring(0, 4);
                                            string erpMonth = finishDate.Substring(4, 2);
                                            string erpDay = finishDate.Substring(6, 2);
                                            string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                            DateTime moctaErpDateTime = Convert.ToDateTime(erpFullDate);

                                            int compare = moctaErpDateTime.CompareTo(erpDateTime);
                                            if (compare <= 0) throw new SystemException("製令狀態已完工，且最後入庫日已關帳，無法開立!!");
                                            #endregion
                                        }
                                    }
                                    #endregion

                                    if (MrWipOrderMoIdList.IndexOf(item.WoErpPrefix + "-" + item.WoErpNo) != -1)
                                    {
                                        #region //重複的製令，將此次套數加回上次MOCTD套數
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MOCTD SET
                                                TD006 = TD006 + @Quantity
                                                WHERE TD001 = @TD001
                                                AND TD002 = @TD002
                                                AND TD003 = @TD003
                                                AND TD004 = @TD004";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              item.Quantity,
                                              TD001 = materialRequisitions[0].MrErpPrefix,
                                              TD002 = materialRequisitions[0].MrErpNo,
                                              TD003 = item.WoErpPrefix,
                                              TD004 = item.WoErpNo
                                          });

                                        rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                    else
                                    {
                                        MrWipOrderMoIdList.Add(item.WoErpPrefix + "-" + item.WoErpNo);

                                        if (item.MrType == "4")
                                        {
                                            mrWipOrders[count].MrType = "1";
                                        }
                                        else if (item.MrType == "5")
                                        {
                                            mrWipOrders[count].MrType = "3";
                                        }

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MOCTD (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, CREATE_TIME
                                                , TD001, TD002, TD003, TD004, TD005, TD006, TD007, TD008, TD009, TD010, TD011, TD012, TD013
                                                , TD014, TD015, TD016, TD017, TD018, TD019, TD020, TD021, TD022, TD023, TD024, TD025, UDF06
                                                , UDF07, UDF08, UDF09, UDF10)
                                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @FLAG, @CREATE_TIME
                                                , @TD001, @TD002, @TD003, @TD004, @TD005, @TD006, @TD007, @TD008, @TD009, @TD010, @TD011, @TD012, @TD013
                                                , @TD014, @TD015, @TD016, @TD017, @TD018, @TD019, @TD020, @TD021, @TD022, @TD023, @TD024, @TD025, @UDF06
                                                , @UDF07, @UDF08, @UDF09, @UDF10)";

                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              COMPANY = ErpNo,
                                              CREATOR = materialRequisitions[0].CreateUserNo,
                                              USR_GROUP,
                                              CREATE_DATE = item.CreateDate,
                                              FLAG = "1",
                                              CREATE_TIME = item.CreateTime,
                                              TD001 = materialRequisitions[0].MrErpPrefix,
                                              TD002 = materialRequisitions[0].MrErpNo,
                                              TD003 = item.WoErpPrefix,
                                              TD004 = item.WoErpNo,
                                              TD005 = mrWipOrders[count].MrType,
                                              TD006 = item.Quantity,
                                              TD007 = item.InventoryNo,
                                              TD008 = item.RequisitionCode,
                                              TD009 = "",
                                              TD010 = "",
                                              TD011 = "",
                                              TD012 = "",
                                              TD013 = "N",
                                              TD014 = item.Remark,
                                              TD015 = item.MaterialCategory,
                                              TD016 = "",
                                              TD017 = item.SubinventoryType,
                                              TD018 = "",
                                              TD019 = "",
                                              TD020 = "",
                                              TD021 = "",
                                              TD022 = "",
                                              TD023 = item.LineSeq,
                                              TD024 = 0.000000,
                                              TD025 = 0.000000,
                                              UDF06 = 0.000000,
                                              UDF07 = 0.000000,
                                              UDF08 = 0.000000,
                                              UDF09 = 0.000000,
                                              UDF10 = 0.000000,
                                          });
                                        var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();
                                    }
                                    count++;
                                }
                                #endregion

                                #region //INSERT MOCTE 領料單單身
                                foreach (var item in mrDetails)
                                {
                                    if (MQ010 < 0)
                                    {
                                        DetailDesc = erpHelper.GetDetailDesc(item.MtlItemNo, item.InventoryNo, MrErpPrefix, MrErpNo, MrId, (int)item.MtlItemId, (int)item.InventoryId, (double)item.Quantity, (int)item.MrDetailId
                                            , sqlConnection, sqlConnection2);
                                    }
                                    else
                                    {
                                        DetailDesc = item.DetailDesc;
                                    }

                                    string TE024 = "";
                                    #region //查詢此料號在製令單身的替代料欄位
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT b.Substitute
                                            FROM MES.MoMtlSetting a 
                                            INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                            WHERE a.MoId = @MoId
                                            AND b.MtlItemId = @MtlItemId";
                                    dynamicParameters.Add("MoId", item.MoId);
                                    dynamicParameters.Add("MtlItemId", item.MtlItemId);

                                    var SubstituteResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (SubstituteResult.Count() > 0)
                                    {
                                        foreach (var item2 in SubstituteResult)
                                        {
                                            TE024 = item2.Substitute;
                                        }
                                    }
                                    #endregion

                                    #region //INSERT MOCTE
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MOCTE (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TE001, TE002, TE003, TE004, TE005, TE006, TE007, TE008, TE009, TE010, TE011, TE012, TE013, TE014, TE015, TE016, TE017, TE018, TE019
                                            , TE020, TE021, TE022, TE023, TE024, TE025, TE026, TE027, TE028, TE029, TE030, TE031, TE032, TE033, TE034, TE035, TE036, TE037, TE038
                                            , TE039, TE040, TE500, TE501, TE502, UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES(@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TE001, @TE002, @TE003, @TE004, @TE005, @TE006, @TE007, @TE008, @TE009, @TE010, @TE011, @TE012, @TE013, @TE014, @TE015, @TE016, @TE017, @TE018, @TE019
                                            , @TE020, @TE021, @TE022, @TE023, @TE024, @TE025, @TE026, @TE027, @TE028, @TE029, @TE030, @TE031, @TE032, @TE033, @TE034, @TE035, @TE036, @TE037, @TE038
                                            , @TE039, @TE040, @TE500, @TE501, @TE502, @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";

                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          COMPANY = ErpNo,
                                          CREATOR = materialRequisitions[0].CreateUserNo,
                                          USR_GROUP,
                                          CREATE_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                          MODIFIER = "",
                                          MODI_DATE = "",
                                          FLAG = "1",
                                          CREATE_TIME = item.CreateTime,
                                          CREATE_AP = "ERP-API",
                                          CREATE_PRID = "BM",
                                          MODI_TIME = "",
                                          MODI_AP = "",
                                          MODI_PRID = "",
                                          TE001 = materialRequisitions[0].MrErpPrefix,
                                          TE002 = materialRequisitions[0].MrErpNo,
                                          TE003 = item.MrSequence,
                                          TE004 = item.MtlItemNo,
                                          TE005 = item.Quantity,
                                          TE006 = item.Unit,
                                          TE007 = "",
                                          TE008 = item.SubInventoryCode,
                                          TE009 = item.ProcessCode,
                                          TE010 = item.LotNumber,
                                          TE011 = item.WoErpPrefix,
                                          TE012 = item.WoErpNo,
                                          TE013 = DetailDesc,
                                          TE014 = item.Remark,
                                          TE015 = "",
                                          TE016 = item.MaterialCategory,
                                          TE017 = item.MtlItemName,
                                          TE018 = item.MtlItemSpec,
                                          TE019 = item.ConfirmStatus,
                                          TE020 = item.ProjectCode,
                                          TE021 = 0,
                                          TE022 = "",
                                          TE023 = item.BondedStatus,
                                          TE024,
                                          TE025 = 0,
                                          TE026 = "2",
                                          TE027 = item.SubstitutionMtlItemNo,
                                          TE028 = item.SubstituteProcessCode,
                                          TE029 = item.StorageLocation,
                                          TE030 = item.SubstituteQty, //取替代數量
                                          TE031 = 0,
                                          TE032 = item.SubstituteRate,
                                          TE033 = 0,
                                          TE034 = "",
                                          TE035 = "",
                                          TE036 = 0,
                                          TE037 = 0,
                                          TE038 = "",
                                          TE039 = "",
                                          TE040 = "",
                                          TE500 = "",
                                          TE501 = "",
                                          TE502 = "",
                                          UDF01 = "",
                                          UDF02 = "",
                                          UDF03 = "",
                                          UDF04 = "",
                                          UDF05 = "",
                                          UDF06 = 0,
                                          UDF07 = 0,
                                          UDF08 = 0,
                                          UDF09 = 0,
                                          UDF10 = 0,
                                      });
                                    var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion

                                    #region //UPDATE MES.MrDetail DetailDesc
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.MrDetail SET
                                            DetailDesc = @DetailDesc,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE MrDetailId = @MrDetailId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          DetailDesc,
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          item.MrDetailId
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion
                            }

                            #region //將ERP單據資料寫回MES
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    MrErpNo = @MrErpNo,
                                    TransferStatus = 'Y',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  materialRequisitions[0].MrErpNo,
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //ConfirmMaterialRequisition -- 核准領退料單據 -- Ann 2023-01-07
        public string ConfirmMaterialRequisition(int MrId)
        {
            try
            {
                AddUserOperateLog(MrId);

                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string timeNow = DateTime.Now.ToString("HH:mm:ss");

                string ErpDbName = "";
                string ErpNo = "";
                int rowsAffected = 0;
                int UserId = CreateBy;
                List<MrWipOrder> mrWipOrders = new List<MrWipOrder>();
                List<MrDetail> mrDetails = new List<MrDetail>();

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (BaseHelper.CheckUserAuthority(UserId, CurrentCompany, "A", "MaterialRequisition", "confirm", sqlConnection).Equals("N")) throw new SystemException("人員權限檢核有異常，請嘗試重新登入!");

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //自行處理領料單確認單

                            #region //確認領退料單資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.CompanyId, a.MrErpPrefix, a.MrErpNo, a.TransferStatus, a.ConfirmStatus, FORMAT(a.MrDate, 'yyyyMMdd') MrDate
                                    , FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate
                                    , FORMAT(a.DocDate, 'yyyyMMdd') ErpDocDate
                                    FROM MES.MaterialRequisition a
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var materialRequisitionResult = sqlConnection.Query(sql, dynamicParameters);

                            if (materialRequisitionResult.Count() <= 0) throw new SystemException("【領退料單】資料錯誤!");

                            string MrErpPrefix = "";
                            string MrErpNo = "";
                            string MrDate = "";
                            string DocDate = "";
                            string ErpDocDate = "";
                            foreach (var item in materialRequisitionResult)
                            {
                                if (item.CompanyId != CurrentCompany) throw new SystemException("使用者公司別與單據公司別不同，請嘗試重新登入!!");
                                if (item.TransferStatus == "N") throw new SystemException("領退料單尚未拋轉ERP，無法核單!!");
                                if (item.TransferStatus == "R") throw new SystemException("領退料單資料有異動，請重新拋轉後再進行核單!!");
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單狀態無法核單!");
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                                MrDate = item.MrDate;
                                DocDate = item.DocDate;
                                ErpDocDate = item.ErpDocDate;
                            }
                            #endregion

                            #region //取得單據性質設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.MQ054)) MQ054, LTRIM(RTRIM(a.MQ040)) MQ040
                                    FROM CMSMQ a
                                    WHERE a.MQ001 = @MQ001";
                            dynamicParameters.Add("MQ001", MrErpPrefix);
                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP尚未維護此領料單單別(" + MrErpPrefix + ")!!");

                            string ExcessFlag = "";
                            string EffectiveFlag = "";
                            foreach (var item2 in CMSMQResult)
                            {
                                ExcessFlag = item2.MQ054;
                                EffectiveFlag = item2.MQ040;
                            }
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "MaterialRequisition");
                            dynamicParameters.Add("DetailCode", "confirm");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            #region //查詢廠別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB001)) MB001 FROM CMSMB";
                            var CMSMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMBResult.Count() <= 0) throw new SystemException("找不到廠別!!");
                            if (CMSMBResult.Count() > 1) throw new SystemException("廠別數有多個，請與資訊人員確認!!");

                            string TC004 = "";
                            foreach (var item in CMSMBResult)
                            {
                                TC004 = item.MB001;
                            }
                            #endregion

                            #region //審核ERP權限
                            string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "", "");
                            #endregion

                            #region //取得MES.MrWipOrder資料(MOCTD)
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.MrId, a.MoId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.WoErpPrefix, a.WoErpNo, a.MrType, a.Quantity, a.InventoryId, a.SubInventoryCode, a.RequisitionCode, a.NegativeStatus, a.Remark
                                , a.MaterialCategory, a.SubinventoryType, a.LineSeq, FORMAT(a.CreateDate, 'yyyyMMdd') CreateDate, FORMAT(a.CreateDate, 'HH:mm:dd') CreateTime
                                , b.InventoryNo
                                , c.UserNo CreateUserNo
                                , d.WoId";
                            sqlQuery.mainTables =
                                @"FROM MES.MrWipOrder a
                                INNER JOIN SCM.Inventory b ON a.InventoryId = b.InventoryId
                                INNER JOIN BAS.[User] c ON a.CreateBy = c.UserId
                                INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId";
                            sqlQuery.auxTables = "";
                            string queryCondition = @"AND a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            mrWipOrders = BaseHelper.SqlQuery<MrWipOrder>(sqlConnection, dynamicParameters, sqlQuery);
                            //if (mrWipOrders.Count() <= 0 && ExcessFlag != "N") throw new SystemException("領退料單設定資料有誤!");

                            foreach (var item in mrWipOrders)
                            {
                                #region //確認ERP工單(MOCTA)狀態
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(TA011)) Status
                                        FROM MOCTA
                                        WHERE TA001 = @TA001
                                        AND TA002 = @TA002";
                                dynamicParameters.Add("TA001", item.WoErpPrefix);
                                dynamicParameters.Add("TA002", item.WoErpNo);
                                var WoErpStatusReesult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item2 in WoErpStatusReesult)
                                {
                                    if (item2.Status == "V") throw new SystemException("ERP製令狀態無法進行領料!!");
                                }
                                #endregion
                            }
                            #endregion

                            #region //取得MES.MrDetail資料(MOCTE)
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MrDetailId, a.MrSequence, a.MtlItemId, a.Quantity, a.ActualQuantity, a.Unit, a.SubInventoryCode, a.ProcessCode, a.LotNumber, a.MoId, a.WoErpPrefix, a.WoErpNo, a.DetailDesc, a.Remark
                                    , a.MaterialCategory, a.ConfirmStatus, a.ProjectCode, a.BondedStatus, a.SubstituteStatus, a.OfficialItemStatus, a.SubstitutionId, a.SubstitutionMtlItemNo
                                    , a.SubstituteProcessCode, a.SubstituteQty, a.SubstituteRate, FORMAT(a.CreateDate, 'yyyyMMdd') CreateDate, FORMAT(a.CreateDate, 'HH:mm:dd') CreateTime
                                    , a.InventoryId, a.UomId
                                    , b.UserNo CreateUserNo
                                    , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                                    , d.WoId
                                    , e.InventoryNo
                                    , f.UomNo
                                    , g.WoId, g.WoErpPrefix, g.WoErpNo
                                    , h.MtlItemNo MoMtlItemNo
                                    , j.BarcodeCtrl 
                                    , k.MtlItemId BomMtlItemId
                                    FROM MES.MrDetail a 
                                    INNER JOIN BAS.[User] b ON a.CreateBy = b.UserId
                                    INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
                                    INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                                    INNER JOIN SCM.Inventory e ON a.InventoryId = e.InventoryId
                                    INNER JOIN PDM.UnitOfMeasure f ON a.UomId = f.UomId
                                    INNER JOIN MES.WipOrder g ON d.WoId = g.WoId
                                    INNER JOIN PDM.MtlItem h ON g.MtlItemId = h.MtlItemId
                                    LEFT JOIN MES.WoDetail i ON g.WoId = i.WoId AND i.MtlItemId = a.MtlItemId
                                    LEFT JOIN MES.MoMtlSetting j ON i.WoDetailId = j.WoDetailId
                                    LEFT JOIN PDM.MtlItem k ON k.MtlItemId = i.MtlItemId
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            mrDetails = sqlConnection.Query<MrDetail>(sql, dynamicParameters).ToList();

                            if (mrDetails.Count() <= 0) throw new SystemException("領退料單詳細資料有誤!");

                            foreach (var item in mrDetails)
                            {
                                #region //確認ERP工單(MOCTA)狀態
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(TA011)) Status
                                        FROM MOCTA
                                        WHERE TA001 = @TA001
                                        AND TA002 = @TA002";
                                dynamicParameters.Add("TA001", item.WoErpPrefix);
                                dynamicParameters.Add("TA002", item.WoErpNo);
                                var WoErpStatusReesult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item2 in WoErpStatusReesult)
                                {
                                    if (item2.Status == "V") throw new SystemException("ERP製令狀態無法進行領料!!");
                                }
                                #endregion

                                #region //若此物料為條碼控管，則檢查實際領退料數量需與實際領退料數量一致
                                string BarcodeCtrl = item.BarcodeCtrl;
                                if (BarcodeCtrl == null)
                                {
                                    #region //檢查是否為替代料，若為替代料則以原元件設定去卡控
                                    if (item.MtlItemNo != item.SubstitutionMtlItemNo)
                                    {
                                        #region //取得原元件製令用料設定
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeCtrl
                                                FROM MES.MoMtlSetting a 
                                                INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                                WHERE a.MoId = @MoId
                                                AND b.MtlItemId = @BomMtlItemId";
                                        dynamicParameters.Add("MoId", item.MoId);
                                        dynamicParameters.Add("BomMtlItemId", item.SubstitutionId);

                                        var BomMtlSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (BomMtlSettingResult.Count() <= 0) throw new SystemException("原元件製令用料設定錯誤!!");

                                        foreach (var item2 in BomMtlSettingResult)
                                        {
                                            BarcodeCtrl = item2.BarcodeCtrl;
                                        }
                                        #endregion
                                    }
                                    #endregion
                                }

                                if (BarcodeCtrl == "Y")
                                {
                                    if (item.Quantity != item.ActualQuantity)
                                    {
                                        throw new SystemException("料號【" + item.MtlItemNo + "】為條碼控管模式，實際與預計領料量需一致!!");
                                    }
                                }
                                #endregion

                                #region //確認ERP品號相關資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MB004)) MB004
                                        , LTRIM(RTRIM(MB030)) MB030
                                        , LTRIM(RTRIM(MB031)) MB031
                                        FROM INVMB
                                        WHERE MB001 = @MB001";
                                dynamicParameters.Add("MB001", item.MtlItemNo);

                                var INVMBResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (INVMBResult.Count() <= 0) throw new SystemException("ERP品號基本資料錯誤!!");

                                foreach (var item2 in INVMBResult)
                                {
                                    if (EffectiveFlag == "N")
                                    {
                                        #region //判斷ERP品號生效日與失效日
                                        if (item2.MB030 != "" && item2.MB030 != null)
                                        {
                                            #region //判斷日期需大於或等於生效日
                                            string EffectiveDate = item2.MB030;
                                            string effYear = EffectiveDate.Substring(0, 4);
                                            string effMonth = EffectiveDate.Substring(4, 2);
                                            string effDay = EffectiveDate.Substring(6, 2);
                                            DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                            DateTime DateItmeDocDate = Convert.ToDateTime(DocDate);
                                            int effresult = DateTime.Compare(DateItmeDocDate, effFullDate);
                                            if (effresult < 0) throw new SystemException("此品號尚未生效，無法使用!!");
                                            #endregion
                                        }

                                        if (item2.MB031 != "" && item2.MB031 != null)
                                        {
                                            #region //判斷日期需小於或等於失效日
                                            string ExpirationDate = item2.MB031;
                                            string effYear = ExpirationDate.Substring(0, 4);
                                            string effMonth = ExpirationDate.Substring(4, 2);
                                            string effDay = ExpirationDate.Substring(6, 2);
                                            DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                            DateTime DateItmeDocDate = Convert.ToDateTime(DocDate);
                                            int effresult = DateTime.Compare(DateItmeDocDate, effFullDate);
                                            if (effresult > 0) throw new SystemException("此品號已失效，無法使用!!");
                                            #endregion
                                        }
                                        #endregion
                                    }
                                }
                                #endregion

                                if (ExcessFlag == "N")
                                {
                                    #region //確認物料是否有進行NG拆盤
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TrayMtlItemNgId, a.NgQty, a.AlreadyQty
                                            FROM MES.TrayMtlItemNg a 
                                            INNER JOIN PDM.BomDetail b ON a.BomDetailId = b.BomDetailId
                                            WHERE a.MoId = @MoId
                                            AND b.MtlItemId = @MtlItemId";
                                    dynamicParameters.Add("MoId", item.MoId);
                                    dynamicParameters.Add("MtlItemId", item.MtlItemId);

                                    var TrayMtlItemNgResult = sqlConnection.Query(sql, dynamicParameters);

                                    int TrayMtlItemNgId = -1;
                                    foreach (var item2 in TrayMtlItemNgResult)
                                    {
                                        //if ((Convert.ToDouble(item.Quantity) + Convert.ToDouble(item2.AlreadyQty)) > item2.NgQty) throw new SystemException("此用料【" + item.MtlItemNo + "】已進行NG拆盤。<br>剩餘可超領數量為【" + (item2.NgQty - item2.AlreadyQty) + "】!!");
                                        TrayMtlItemNgId = item2.TrayMtlItemNgId;
                                    }
                                    #endregion

                                    if (TrayMtlItemNgId > 0)
                                    {
                                        #region //Update MES.TrayMtlItemNg AlreadyQty
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.TrayMtlItemNg SET
                                                AlreadyQty = AlreadyQty + @Quantity,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE TrayMtlItemNgId = @TrayMtlItemNgId";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              item.Quantity,
                                              LastModifiedDate,
                                              LastModifiedBy = UserId,
                                              TrayMtlItemNgId
                                          });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //Insert MES.TrayMtlItemNgLog
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.TrayMtlItemNgLog (TrayMtlItemNgId, MrDetailId, [Action], Quantity
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                VALUES (@TrayMtlItemNgId, @MrDetailId, @Action, @Quantity
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                TrayMtlItemNgId,
                                                item.MrDetailId,
                                                Action = "Y",
                                                Quantity = Convert.ToInt32(item.Quantity),
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                            }
                            #endregion

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(DocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + DocDate + ")之單據!!");
                            }
                            #endregion

                            #region //ERP核單
                            #region //找出小數位數換算
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MF003
                                      FROM CMSMF
                                     WHERE MF001 = (SELECT MA003 FROM CMSMA)";
                            var MF003Result = sqlConnection2.Query(sql, dynamicParameters);
                            if (MF003Result.Count() <= 0) throw new SystemException("找不到幣別小數位設定!!!");
                            int MF003 = Convert.ToInt32(sqlConnection2.QueryFirstOrDefault(sql, dynamicParameters).MF003);
                            #endregion

                            #region //取出ERP單據資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TE001 AS D_A1,TE002 AS D_A2,TE003 AS D_A3,TC003 AS D_A4,
                                           TE004 AS D_B1,TE006 AS D_B2,MB022 AS D_B3 , 
                                           LTRIM(RTRIM(TE011)) AS WoErpPrefix,LTRIM(RTRIM(TE012)) AS WoErpNo,
                                           LTRIM(RTRIM(TE004)) AS MtlItemNo,TE005 AS Quantity,
                                           MB065,ISNULL(NULLIF(MB064, 0), 1) MB064,
                                           --MB065,NULLIF(MB064, 0) MB064,
	                                       --ROUND(ISNULL(MB065/NULLIF(MB064, 0), 0), @MF003)) AS D_B4,
	                                       CONVERT(varchar(12),DATEADD(d,MB023, convert(datetime, TC003)), 112) AS D_B5,
	                                       TE005 AS D_D1,ISNULL( MD004/MD003,1) AS D_D3,TE008 AS D_D4 ,
	                                       ISNULL(TE010, '') AS D_D5 ,TE014 AS D_D6,TE021 AS D_D7,
	                                       ISNULL(TE029, '') AS D_D8,TE011 AS D_O1,TE012 AS D_O2,MQ019 AS D_O3,MQ054 AS D_O4,
	                                       MQ010 AS D_O5,MQ008 AS D_O6,MQ011 AS D_O7,MQ019 AS D_O8,
                                           MC004, TE027 AS BomMtlItemNo, TE030 AS BomMtlItemQty, TE032 AS SubRate,
                                           TE017 MtlItemName, TE018 MtlItemSpec, ISNULL(LTRIM(RTRIM(TE029)), '') TE029,
                                           ISNULL(TD006, 0) TD006, LTRIM(RTRIM(MC009)) MC009, LTRIM(RTRIM(TE008)) TE008
                                      FROM MOCTE
                                           INNER JOIN MOCTC ON TC001 = TE001 AND TC002 = TE002
                                           INNER JOIN INVMB ON MB001 = TE004
                                           INNER JOIN CMSMQ ON MQ001 = TE001
                                           INNER JOIN CMSMC ON MC001 = TE008
                                           LEFT JOIN INVMD ON MD001=TE006
                                           LEFT JOIN MOCTD ON TD001 = TE001 AND TD002 = TE002 AND TD003 = TE011 AND TD004 = TE012
                                     WHERE TE001 = @MrErpPrefix
                                       AND TE002 = @MrErpNo";
                            dynamicParameters.Add("MrErpPrefix", MrErpPrefix);
                            dynamicParameters.Add("MrErpNo", MrErpNo);
                            dynamicParameters.Add("MF003", MF003);
                            var ErpMrResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (ErpMrResult.Count() <= 0) throw new SystemException("找不到ERP領料單據!");
                            #endregion

                            #region //先更新單據-->U, 確認中
                            //更新單頭確認碼=U
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTC
                                           SET TC009 = 'U'
                                         WHERE TC001 = @MrErpPrefix
                                           AND TC002 = @MrErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MrErpPrefix,
                                MrErpNo
                            });

                            rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTE
                                           SET TE019 = 'U'
                                         WHERE TE001 = @MrErpPrefix
                                           AND TE002 = @MrErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MrErpPrefix,
                                MrErpNo
                            });

                            rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);
                            #endregion

                            #region //領料單身確認
                            foreach (var item in ErpMrResult)
                            {
                                #region //取出SQL欄位置到變數
                                string D_A1 = item.D_A1;
                                string D_A2 = item.D_A2;
                                string D_A3 = item.D_A3;
                                string D_A4 = item.D_A4;
                                string D_B1 = item.D_B1;
                                string D_B2 = item.D_B2;
                                string D_B3 = item.D_B3;
                                double D_B4 = Convert.ToDouble(Math.Round(item.MB065 / item.MB064, MF003));
                                string D_B5 = item.D_B5;
                                double D_D1 = Convert.ToDouble(item.D_D1);
                                double D_D3 = Convert.ToDouble(item.D_D3);
                                string D_D4 = item.D_D4;
                                string D_D5 = item.D_D5;
                                string D_D6 = item.D_D6;
                                int D_D7 = Convert.ToInt32(item.D_D7);
                                string D_D8 = item.D_D8;
                                string D_B8 = item.D_B8;
                                string D_O1 = item.D_O1;
                                string D_O2 = item.D_O2;
                                string D_O3 = item.D_O3;
                                string D_O4 = item.D_O4;
                                int D_O5 = Convert.ToInt32(item.D_O5);
                                string D_O6 = item.D_O6;
                                string D_O7 = item.D_O7;
                                string D_O8 = item.D_O8;
                                string MC004 = item.MC004;
                                string TE029 = item.TE029;
                                string LocationFlag = item.MC009;
                                double TD006 = Convert.ToDouble(item.TD006);
                                string TE008 = item.TE008;
                                double Quantity = Convert.ToDouble(item.Quantity);
                                #endregion

                                #region //Data Validation
                                erpHelper.CheckInvmcYn(D_B1, D_D4,
                                             UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);

                                if (!erpHelper.CheckLotYn(D_B3, D_D5).Equals("Y"))
                                {
                                    throw new SystemException("品號【" + D_B1 + "】需做批號管理,請補入正確批號");
                                }
                                else
                                {
                                    if (!erpHelper.CheckLotQty(D_B1, D_D5, D_D4, D_D1 * D_O5, D_D7 * D_O5, sqlConnection2).Equals("Y") && D_B3.Equals("T") && D_O5 < 0)
                                    {
                                        throw new SystemException("品號【" + D_B1 + "】批號庫存數量(或包裝數)不足");
                                    }
                                }

                                if (LocationFlag == "Y" && !erpHelper.CheckLocationQty(D_B1, TE008, D_D8, Quantity, sqlConnection2).Equals("Y"))
                                {
                                    throw new SystemException("品號【" + D_B1 + "】庫別【" + TE008 + "】儲位【" + D_D8 + "】庫存數量(或包裝數)不足");
                                }

                                if (!erpHelper.CheckStoQty(D_B1, D_D4, D_D1 * D_O5, D_D7 * D_O5, sqlConnection2, D_O5).Equals("Y") && D_O5 < 0)
                                {
                                    throw new SystemException("品號【" + D_B1 + "】庫別庫存數量(或包裝數)不足");
                                }
                                else if (!erpHelper.CheckMocYn("MOCTI", D_O3, D_O1, D_O2, sqlConnection2).Equals("Y"))
                                {
                                    throw new SystemException("製令單號空白,請補入製令單號");
                                }
                                else if (!erpHelper.CheckMocQty(D_B1, D_O1, D_O2, D_D1, D_O4, sqlConnection2, item.BomMtlItemNo, item.BomMtlItemQty, D_A1, D_A2, D_O5, TD006).Equals("Y"))
                                {
                                    throw new SystemException("領退料品號【" + item.D_B1 + "】序號【" + item.D_A3 + "】超領/超退，請檢查領退料套數或數量是否異常!!");
                                }
                                #endregion

                                #region //處理替代料問題

                                #region //確認MES替代料領料資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MtlItemId, a.InventoryId, a.UomId, a.SubstitutionId, a.MoId
                                        , c.WoId 
                                        FROM MES.MrDetail a 
                                        INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                        INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                        INNER JOIN PDM.MtlItem d ON a.MtlItemId = d.MtlItemId
                                        WHERE a.MrId = @MrId
                                        AND d.MtlItemNo = @MtlItemNo
                                        AND c.WoErpPrefix = @WoErpPrefix
                                        AND c.WoErpNo = @WoErpNo
                                        AND a.MrSequence = @MrSequence";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                                dynamicParameters.Add("WoErpPrefix", item.WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", item.WoErpNo);
                                dynamicParameters.Add("MrSequence", D_A3);

                                var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MrDetailResult.Count() <= 0) throw new SystemException("找不到ERP領料單身!");

                                foreach (var item2 in MrDetailResult)
                                {
                                    int WoId = item2.WoId;
                                    int MtlItemId = item2.MtlItemId;
                                    int InventoryId = item2.InventoryId;
                                    int UomId = item2.UomId;
                                    int? SubstitutionId = item2.SubstitutionId;
                                    int MoId = item2.MoId;

                                    #region //先確認此料號是否存在MOCTB
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT LTRIM(RTRIM(a.TB003)) MtlItemNo, LTRIM(RTRIM(a.TB004)) RequiredQuantity
                                            , LTRIM(RTRIM(a.TB023)) BomMtlItemNo
                                            , LTRIM(RTRIM(a.TB027)) Source
                                            FROM MOCTB a 
                                            WHERE a.TB001 = @TB001
                                            AND a.TB002 = @TB002
                                            AND a.TB003 = @TB003";
                                    dynamicParameters.Add("TB001", item.WoErpPrefix);
                                    dynamicParameters.Add("TB002", item.WoErpNo);
                                    dynamicParameters.Add("TB003", item.MtlItemNo);

                                    var MOCTBResult2 = sqlConnection2.Query(sql, dynamicParameters);

                                    if (MOCTBResult2.Count() > 0)
                                    {
                                        foreach (var item3 in MOCTBResult2)
                                        {
                                            if (item.BomMtlItemNo != item.MtlItemNo && item3.MtlItemNo != item3.BomMtlItemNo)
                                            {
                                                #region //替代料流程
                                                #region //UPDATE MOCTB 取替代料 需領用量
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE MOCTB SET
                                                    TB004 = @TB004
                                                    WHERE TB001 = @WoErpPrefix
                                                    AND TB002 = @WoErpNo
                                                    AND TB003 = @MtlItemNo";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        TB004 = Convert.ToDecimal(item3.RequiredQuantity) + Convert.ToDecimal(item.Quantity),
                                                        item.WoErpPrefix,
                                                        item.WoErpNo,
                                                        item.MtlItemNo
                                                    });

                                                rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                                #endregion

                                                #region //UPDATE MES.WoDetail 取替代料 需領用量
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE MES.WoDetail SET
                                                    DemandRequisitionQty = @DemandRequisitionQty
                                                    WHERE WoId = @WoId
                                                    AND MtlItemId = @MtlItemId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        DemandRequisitionQty = Convert.ToDecimal(item3.RequiredQuantity) + Convert.ToDecimal(item.Quantity),
                                                        WoId,
                                                        MtlItemId
                                                    });

                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion

                                                #region //處理原元件相關資料
                                                #region //先查詢原元件需領用量、備註
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TB004, TB017
                                                    FROM MOCTB
                                                    WHERE TB001 = @WoErpPrefix
                                                    AND TB002 = @WoErpNo
                                                    AND TB003 = @BomMtlItemNo";
                                                dynamicParameters.Add("WoErpPrefix", item.WoErpPrefix);
                                                dynamicParameters.Add("WoErpNo", item.WoErpNo);
                                                dynamicParameters.Add("BomMtlItemNo", item.BomMtlItemNo);

                                                var BomMOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                                if (BomMOCTBResult.Count() <= 0) throw new SystemException("元件【" + item.BomMtlItemNo + "】資料錯誤!!");

                                                decimal? OriTB004 = 0;
                                                string TB017 = "";
                                                foreach (var item4 in BomMOCTBResult)
                                                {
                                                    OriTB004 = item4.TB004;
                                                    TB017 = item4.TB017;
                                                }
                                                #endregion

                                                #region //UPDATE MOCTB 原元件 需領用量、備註

                                                #region //先計算原元件需領用量
                                                decimal? BomQuantity = OriTB004 - item.BomMtlItemQty;
                                                if (BomQuantity < 0)
                                                {
                                                    if (ExcessFlag != "N")
                                                    {
                                                        throw new SystemException("料號【" + item.MtlItemNo + "】領料數量已超過原元件需領用量!!");
                                                    }
                                                    else
                                                    {
                                                        BomQuantity = 0;
                                                    }
                                                }
                                                #endregion

                                                #region //計算備註
                                                string Remark = TB017 + "[有取替代:需領用量-" + item.BomMtlItemQty.ToString() + "]";
                                                if (Remark.Length > 255)
                                                {
                                                    Remark = Remark.Substring(0, 255);
                                                }
                                                #endregion

                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE MOCTB SET
                                                    TB004 = @BomQuantity,
                                                    TB017 = @Remark
                                                    WHERE TB001 = @WoErpPrefix
                                                    AND TB002 = @WoErpNo
                                                    AND TB003 = @BomMtlItemNo";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BomQuantity,
                                                        Remark,
                                                        item.WoErpPrefix,
                                                        item.WoErpNo,
                                                        item.BomMtlItemNo
                                                    });

                                                rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                                #endregion

                                                #region //UPDATE MES.WoDetail 原元件 需領用量、備註
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE a
                                                    SET a.DemandRequisitionQty = @BomQuantity,
                                                    WipDetailRemark = @Remark
                                                    FROM MES.WoDetail a
                                                    INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                                    WHERE a.WoId = @WoId
                                                    AND b.MtlItemNo = @BomMtlItemNo";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BomQuantity,
                                                        Remark,
                                                        WoId,
                                                        item.BomMtlItemNo,
                                                    });

                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion
                                                #endregion
                                                #endregion
                                            }
                                        }
                                    }
                                    else
                                    {
                                        if (item.BomMtlItemNo != item.MtlItemNo && item.BomMtlItemQty != 0)
                                        {
                                            #region //替代料流程

                                            #region //先查詢原元件需領用量
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TB004, TB017, TB014
                                                FROM MOCTB
                                                WHERE TB001 = @WoErpPrefix
                                                AND TB002 = @WoErpNo
                                                AND TB003 = @BomMtlItemNo";
                                            dynamicParameters.Add("WoErpPrefix", item.WoErpPrefix);
                                            dynamicParameters.Add("WoErpNo", item.WoErpNo);
                                            dynamicParameters.Add("BomMtlItemNo", item.BomMtlItemNo);

                                            var BomMOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                            if (BomMOCTBResult.Count() <= 0) throw new SystemException("元件【" + item.BomMtlItemNo + "】資料錯誤!!");

                                            decimal? OriTB004 = 0;
                                            string TB017 = "";
                                            string TB014 = "";
                                            foreach (var item3 in BomMOCTBResult)
                                            {
                                                OriTB004 = item3.TB004;
                                                TB017 = item3.TB017;
                                                TB014 = item3.TB014;
                                            }
                                            #endregion

                                            #region //計算替代料需領用量、原元件需領用量
                                            decimal? BomQuantity = OriTB004 - item.BomMtlItemQty;
                                            decimal? SubRequiredQuantity = item.Quantity;
                                            if (OriTB004 < item.BomMtlItemQty)
                                            {
                                                if (ExcessFlag != "N")
                                                {
                                                    throw new SystemException("領料數量已超過原元件需領用量!!");
                                                }
                                                else
                                                {
                                                    SubRequiredQuantity = OriTB004 * Convert.ToDecimal(item.SubRate);
                                                    BomQuantity = 0;
                                                }
                                            }
                                            #endregion

                                            #region //INSERT MOCTB 取替代件
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MOCTB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID
                                                , TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB009, TB010, TB011, TB012, TB013, TB014, TB015, TB016, TB018
                                                , TB022, TB023, TB025, TB027)
                                                OUTPUT INSERTED.TB001
                                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID
                                                , @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, @TB007, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014, @TB015, @TB016, @TB018
                                                , @TB022, @TB023, @TB025, @TB027)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    COMPANY = TC004,
                                                    CREATOR = UserNo,
                                                    USR_GROUP,
                                                    CREATE_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                                    FLAG = 1,
                                                    CREATE_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                                    CREATE_AP = UserNo + "PC",
                                                    CREATE_PRID = "BM",
                                                    TB001 = item.WoErpPrefix,
                                                    TB002 = item.WoErpNo,
                                                    TB003 = item.MtlItemNo,
                                                    TB004 = SubRequiredQuantity,
                                                    TB005 = 0,
                                                    TB006 = "****",
                                                    TB007 = item.D_B2,
                                                    TB009 = item.D_D4,
                                                    TB010 = "*",
                                                    TB011 = "1",
                                                    TB012 = item.MtlItemName,
                                                    TB013 = item.MtlItemSpec,
                                                    TB014,
                                                    TB015 = DateTime.Now.ToString("yyyyMMdd"),
                                                    TB016 = (string)null,
                                                    TB018 = "Y",
                                                    TB022 = "2",
                                                    TB023 = item.BomMtlItemNo,
                                                    TB025 = "****",
                                                    TB027 = "2"
                                                });

                                            var insertResult2 = sqlConnection2.Query(sql, dynamicParameters);

                                            rowsAffected += insertResult2.Count();
                                            #endregion

                                            #region //INSERT MES.WoDetail 取替代件
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId
                                                , DemandRequisitionQty, RequisitionQty, SubstituteStatus, SubstituteMtlItemId
                                                , MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate, WipDetailRemark, ConfirmStatus
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.WoDetailId
                                                VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @DemandRequisitionQty, @RequisitionQty, @SubstituteStatus, @SubstituteMtlItemId
                                                , @MaterialProperties, @ExpectedRequisitionDate, @ActualRequisitionDate, @WipDetailRemark, @ConfirmStatus
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    WoId,
                                                    MtlItemId,
                                                    InventoryId,
                                                    UomId,
                                                    DemandRequisitionQty = SubRequiredQuantity,
                                                    RequisitionQty = 0,
                                                    SubstituteStatus = "Y",
                                                    SubstituteMtlItemId = SubstitutionId,
                                                    MaterialProperties = "1",
                                                    ExpectedRequisitionDate = DateTime.Now.ToString("yyyyMMdd"),
                                                    ActualRequisitionDate = (DateTime?)null,
                                                    WipDetailRemark = "",
                                                    ConfirmStatus = "Y",
                                                    CreateDate,
                                                    LastModifiedDate,
                                                    CreateBy,
                                                    LastModifiedBy
                                                });

                                            var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                            rowsAffected += insertResult3.Count();

                                            int SubWoDetailId = -1;
                                            foreach (var item3 in insertResult3)
                                            {
                                                SubWoDetailId = item3.WoDetailId;
                                            }

                                            if (SubWoDetailId <= 0) throw new SystemException("新增WoDetail失敗!!");
                                            #endregion

                                            #region //取得原元件MoMtlSetting資料
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT a.MoId, a.ProcessBinding, a.MoProcessId, a.BarcodeCtrl, a.MainBarcode, a.ControlType, a.DecompositionFlag
                                                , a.BindType
                                                FROM MES.MoMtlSetting a 
                                                INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                                WHERE a.MoId = @MoId
                                                AND b.MtlItemId = @SubstitutionId";
                                            dynamicParameters.Add("MoId", MoId);
                                            dynamicParameters.Add("SubstitutionId", SubstitutionId);

                                            var MoMtlSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                            foreach (var item3 in MoMtlSettingResult)
                                            {
                                                #region //INSERT MES.MoMtlSetting 替代料
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO MES.MoMtlSetting (MoId, WoDetailId, UomId, ProcessBinding, MoProcessId
                                                    , BarcodeCtrl, MainBarcode, ControlType, DecompositionFlag, BindType
                                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                    OUTPUT INSERTED.MoMtlSettingId
                                                    VALUES (@MoId, @WoDetailId, @UomId, @ProcessBinding, @MoProcessId
                                                    , @BarcodeCtrl, @MainBarcode, @ControlType, @DecompositionFlag, @BindType
                                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        MoId,
                                                        WoDetailId = SubWoDetailId,
                                                        UomId,
                                                        item3.ProcessBinding,
                                                        item3.MoProcessId,
                                                        item3.BarcodeCtrl,
                                                        item3.MainBarcode,
                                                        item3.ControlType,
                                                        item3.DecompositionFlag,
                                                        item3.BindType,
                                                        CreateDate,
                                                        LastModifiedDate,
                                                        CreateBy,
                                                        LastModifiedBy
                                                    });

                                                var insertResult4 = sqlConnection.Query(sql, dynamicParameters);

                                                rowsAffected += insertResult4.Count();
                                                #endregion
                                            }
                                            #endregion

                                            #region //處理原元件相關資料

                                            #region //計算備註
                                            string Remark = TB017 + "[有取替代:需領用量-" + item.BomMtlItemQty.ToString() + "]";
                                            if (Remark.Length > 255)
                                            {
                                                Remark = Remark.Substring(0, 255);
                                            }
                                            #endregion

                                            #region //UPDATE MOCTB 原元件 需領用量、備註
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MOCTB SET
                                                TB004 = @BomQuantity,
                                                TB017 = @Remark
                                                WHERE TB001 = @WoErpPrefix
                                                AND TB002 = @WoErpNo
                                                AND TB003 = @BomMtlItemNo";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    BomQuantity,
                                                    Remark,
                                                    item.WoErpPrefix,
                                                    item.WoErpNo,
                                                    item.BomMtlItemNo
                                                });

                                            rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                            #endregion

                                            #region //UPDATE MES.WoDetail 原元件 需領用量、備註
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE a
                                                SET DemandRequisitionQty = @BomQuantity,
                                                WipDetailRemark = @Remark
                                                FROM MES.WoDetail a
                                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                                WHERE a.WoId = @WoId
                                                AND b.MtlItemNo = @BomMtlItemNo";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    BomQuantity,
                                                    Remark,
                                                    WoId,
                                                    item.BomMtlItemNo,
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                            #endregion
                                            #endregion
                                        }
                                        else
                                        {
                                            #region //非替代料流程，且此情況只允許超領模式
                                            if (ExcessFlag == "N")
                                            {
                                                #region //INSERT MOCTB 超領料號
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO MOCTB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID
                                                    , TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB009, TB011, TB012, TB013, TB014, TB015, TB016, TB018
                                                    , TB022, TB023, TB025, TB027)
                                                    OUTPUT INSERTED.TB001
                                                    VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID
                                                    , @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, @TB007, @TB009, @TB011, @TB012, @TB013, @TB014, @TB015, @TB016, @TB018
                                                    , @TB022, @TB023, @TB025, @TB027)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        COMPANY = TC004,
                                                        CREATOR = UserNo,
                                                        USR_GROUP,
                                                        CREATE_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                                        FLAG = 1,
                                                        CREATE_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                                        CREATE_AP = UserNo + "PC",
                                                        CREATE_PRID = "BM",
                                                        TB001 = item.WoErpPrefix,
                                                        TB002 = item.WoErpNo,
                                                        TB003 = item.MtlItemNo,
                                                        TB004 = 0,
                                                        TB005 = 0,
                                                        TB006 = "****",
                                                        TB007 = item.D_B2,
                                                        TB009 = item.D_D4,
                                                        TB011 = "1",
                                                        TB012 = item.MtlItemName,
                                                        TB013 = item.MtlItemSpec,
                                                        TB014 = item.BomMtlItemNo,
                                                        TB015 = DateTime.Now.ToString("yyyyMMdd"),
                                                        TB016 = (string)null,
                                                        TB018 = "Y",
                                                        TB022 = "2",
                                                        TB023 = item.BomMtlItemNo,
                                                        TB025 = "****",
                                                        TB027 = "2"
                                                    });

                                                var insertResult2 = sqlConnection2.Query(sql, dynamicParameters);

                                                rowsAffected += insertResult2.Count();
                                                #endregion

                                                #region //INSERT MES.WoDetail 超領料號
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId
                                                    , DemandRequisitionQty, RequisitionQty, SubstituteStatus, SubstituteMtlItemId
                                                    , MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate, WipDetailRemark, ConfirmStatus
                                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                    OUTPUT INSERTED.WoDetailId, INSERTED.CompositionQuantity, INSERTED.Base, INSERTED.LossRate, INSERTED.BomSequence, INSERTED.Substitute, INSERTED.SubstituteMtlItemId
                                                    VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @DemandRequisitionQty, @RequisitionQty, @SubstituteStatus, @SubstituteMtlItemId
                                                    , @MaterialProperties, @ExpectedRequisitionDate, @ActualRequisitionDate, @WipDetailRemark, @ConfirmStatus
                                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        WoId,
                                                        MtlItemId,
                                                        InventoryId,
                                                        UomId,
                                                        DemandRequisitionQty = 0,
                                                        RequisitionQty = 0,
                                                        SubstituteStatus = "Y",
                                                        SubstituteMtlItemId = SubstitutionId,
                                                        MaterialProperties = "1",
                                                        ExpectedRequisitionDate = DateTime.Now.ToString("yyyyMMdd"),
                                                        ActualRequisitionDate = (DateTime?)null,
                                                        WipDetailRemark = "",
                                                        ConfirmStatus = "Y",
                                                        CreateDate,
                                                        LastModifiedDate,
                                                        CreateBy,
                                                        LastModifiedBy
                                                    });

                                                var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                                rowsAffected += insertResult3.Count();

                                                int WoDetailId = -1;
                                                double? CompositionQuantity = -1;
                                                double? Base = -1;
                                                double? LossRate = -1;
                                                double? BomSequence = -1;
                                                foreach (var item3 in insertResult3)
                                                {
                                                    WoDetailId = item3.WoDetailId;
                                                    CompositionQuantity = item3.CompositionQuantity;
                                                    Base = item3.Base;
                                                    LossRate = item3.LossRate;
                                                    BomSequence = item3.BomSequence;
                                                }

                                                if (WoDetailId <= 0) throw new SystemException("新增WoDetail失敗!!");
                                                #endregion

                                                #region //INSERT MES.MoMtlSetting
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO MES.MoMtlSetting (MoId, WoDetailId, UomId, CompositionQuantity, Base, LossRate, BomSequence, ProcessBinding, BarcodeCtrl, MainBarcode, ControlType
                                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                    OUTPUT INSERTED.MoMtlSettingId
                                                    VALUES (@MoId, @WoDetailId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence, @ProcessBinding, @BarcodeCtrl, @MainBarcode, @ControlType
                                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        MoId,
                                                        WoDetailId,
                                                        UomId,
                                                        CompositionQuantity,
                                                        Base,
                                                        LossRate,
                                                        BomSequence,
                                                        ProcessBinding = "N",
                                                        BarcodeCtrl = "N",
                                                        MainBarcode = "N",
                                                        ControlType = "2",
                                                        CreateDate,
                                                        LastModifiedDate,
                                                        CreateBy,
                                                        LastModifiedBy
                                                    });

                                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                                rowsAffected += insertResult.Count();
                                                #endregion
                                            }
                                            else
                                            {
                                                throw new SystemException("此領料單別無法領取非BOM階內的料號!!");
                                            }
                                            #endregion
                                        }
                                    }
                                    #endregion
                                }
                                #endregion
                                #endregion

                                #region //開始核單確認

                                #region //批號儲位異動明細
                                if (D_B3.Equals("Y") || D_B3.Equals("T") || LocationFlag.Equals("Y"))
                                {
                                    #region //品號批號資料單頭
                                    if (D_B3.Equals("Y") || D_B3.Equals("T"))
                                    {
                                        rowsAffected += erpHelper.InsertInvmef(D_B1, D_D5, D_A4, D_A1, D_A2, D_D6,
                                                                     D_B5, D_A3, D_D4, D_O5, D_O6, D_D1 * D_D3, D_O1, D_O2,
                                                                     UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);
                                    }
                                    #endregion

                                    rowsAffected += erpHelper.InsertInvlf(D_A1, D_A2, D_A3, D_B1, D_D4,
                                                                D_D8, D_D5, D_O5, D_A4, D_O6,
                                                                D_D1 * D_D3, D_D7, D_D6, D_O1, D_O2,
                                                                UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);
                                }
                                #endregion

                                #region //儲位與批號庫存檔
                                if (D_B3.Equals("Y") || D_B3.Equals("T") || LocationFlag == "Y")
                                {
                                    rowsAffected += erpHelper.InsertInvmm(D_B1, D_D4, D_D8, D_D5, D_D1 * D_O5 * D_D3,
                                                                D_D7, D_A4,
                                                                UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);
                                }
                                #endregion

                                #region //庫存異動檔
                                int rows = erpHelper.InsertInvla(D_B1, D_A4, D_O5, D_A1, D_A2,
                                                            D_A3, D_D4, D_O1 + "-" + D_O2 + D_D6, D_D1 * D_D3, D_B4,
                                                            Math.Round(D_D1 * D_D3 * D_B4, 0), D_O6, D_O7, D_D5, D_D7,
                                                            D_D8, D_O1, D_O2, "",
                                                            UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);

                                //檢核INVLA異動數量
                                if (rows <= 0)
                                {
                                    throw new SystemException("異動INVLA時錯誤，請重新執行!!");
                                }
                                else
                                {
                                    rowsAffected += rows;
                                }
                                #endregion

                                if (MC004.Equals("1"))
                                {
                                    rowsAffected += erpHelper.UpdateInvmb(D_B1, D_D1 * D_D3 * D_O5, D_D1 * D_D3 * D_B4 * D_O5,
                                                            UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);
                                }

                                rowsAffected += erpHelper.UpdateInvmc(D_B1, D_D1 * D_D3 * D_O5, D_D1 * D_D3 * D_B4 * D_O5, D_D4, ErpDocDate,
                                                            UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP, MrErpPrefix);

                                #region //更新製令領料套數, 單身已領數量
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MOCTB
                                           SET TB005 = TB005 + (@D_D1 * @D_O5 * -1),
                                               TB016 = @D_A4
                                         WHERE TB001 = @D_O1
                                           AND TB002 = @D_O2 
                                           AND TB003 = @D_B1";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    D_D1,
                                    D_O1,
                                    D_O2,
                                    D_O5,
                                    D_B1,
                                    D_A4
                                });

                                rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);

                                #endregion

                                #endregion
                            }
                            #endregion

                            #region //取得相關領料資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TD003 WoErpPrefix, TD004 WoErpNo
                                        , TD006 MoQty
                                        , MQ010
                                        , ISNULL(TC003,'') MrDocDate
                                        , LTRIM(RTRIM(TA011)) TA011
                                      FROM MOCTD 
                                           INNER JOIN CMSMQ ON TD001 = MQ001
                                           INNER JOIN MOCTC ON TD001 = TC001 AND TD002 = TC002
                                           INNER JOIN MOCTA ON TD003 = TA001 AND TD004 = TA002
                                     WHERE TD001 = @MrErpPrefix
                                       AND TD002 = @MrErpNo";
                            dynamicParameters.Add("MrErpPrefix", MrErpPrefix);
                            dynamicParameters.Add("MrErpNo", MrErpNo);
                            var MOCTResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (MOCTResult.Count() <= 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TE011 WoErpPrefix, a.TE012 WoErpNo
                                        , b.MQ010
                                        , 0 MoQty
                                        , ISNULL(c.TC003, '') MrDocDate
                                        , d.TA011
                                        FROM MOCTE a 
                                        INNER JOIN CMSMQ b ON a.TE001 = b.MQ001 
                                        INNER JOIN MOCTC c ON a.TE001 = c.TC001 AND a.TE002 = c.TC002
                                        INNER JOIN MOCTA d ON a.TE011 = d.TA001 AND a.TE012 = d.TA002
                                        WHERE a.TE001 = @MrErpPrefix
                                        AND a.TE002 = @MrErpNo
                                        GROUP BY a.TE011, a.TE012, b.MQ010, c.TC003, d.TA011";
                                dynamicParameters.Add("MrErpPrefix", MrErpPrefix);
                                dynamicParameters.Add("MrErpNo", MrErpNo);
                                MOCTResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (MOCTResult.Count() <= 0) throw new SystemException("查詢領料單相關資料時發生錯誤!!");
                            }

                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            int MQ010 = 0;
                            double MoQty = 0;
                            string MrDocDate = "";
                            string TA011 = "";
                            foreach (var item in MOCTResult)
                            {
                                WoErpPrefix = item.WoErpPrefix;
                                WoErpNo = item.WoErpNo;
                                MrDocDate = item.MrDocDate;
                                MoQty = Convert.ToDouble(item.MoQty);
                                MQ010 = Convert.ToInt32(item.MQ010);
                                TA011 = item.TA011;

                                #region //更新製令領料套數, 單身已領數量
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MOCTA
                                        SET MODIFIER =@MODIFIER,
                                            MODI_DATE= @MODI_DATE,
                                            MODI_TIME= @MODI_TIME,
                                            MODI_AP= @MODI_AP,
                                            MODI_PRID= @MODI_PRID,
                                            FLAG= FLAG + 1,
                                            TA016 = TA016 + (@TD006 * @MQ010 * -1),
                                            TA011 = @TA011
                                        WHERE TA001 = @TD003
                                        AND TA002 = @TD004";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = UserNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = BaseHelper.ClientComputer(),
                                    MODI_PRID = "BM",
                                    TD003 = WoErpPrefix,
                                    TD004 = WoErpNo,
                                    TD006 = MoQty,
                                    MQ010,
                                    TA011 = TA011 == "1" ? "2" : TA011
                                });

                                rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);
                                #endregion

                                #region //更新製令單頭狀態及開工日期
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MIN(b.TC003) TC003
                                        FROM MOCTE a
                                        INNER JOIN MOCTC b ON a.TE001 = b.TC001 AND a.TE002 = b.TC002
                                        WHERE a.TE011 = @TE011 AND a.TE012 = @TE012
                                        AND a.TE019 = 'Y'";
                                dynamicParameters.Add("TE011", WoErpPrefix);
                                dynamicParameters.Add("TE012", WoErpNo);

                                var MinMrDateResult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item2 in MinMrDateResult)
                                {
                                    if (item2.TC003 != null)
                                    {
                                        #region //比較此領料單領料日期是否有比目前最小日期還早
                                        string MinDateString = item2.TC003;
                                        string MinFullDateString = MinDateString.Substring(0, 4) + "-" + MinDateString.Substring(4, 2) + "-" + MinDateString.Substring(6, 2);
                                        DateTime MinDate = Convert.ToDateTime(MinFullDateString);

                                        string TC003FullString = MrDocDate.Substring(0, 4) + "-" + MrDocDate.Substring(4, 2) + "-" + MrDocDate.Substring(6, 2);
                                        DateTime TD003Date = Convert.ToDateTime(TC003FullString);

                                        int DateResult = DateTime.Compare(MinDate, TD003Date);
                                        if (DateResult < 0)
                                        {
                                            #region //更改此製令實際開工日
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MOCTA SET
                                                TA012 = @TA012
                                                WHERE TA001 = @TD003 AND TA002 = @TD004";
                                            dynamicParameters.AddDynamicParams(
                                              new
                                              {
                                                  TA012 = item2.TC003,
                                                  TD003 = WoErpPrefix,
                                                  TD004 = WoErpNo
                                              });

                                            rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                        else
                                        {
                                            #region //將實際開工日期改為此領料單領料日期
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MOCTA SET
                                                    TA012 = @TC003
                                                    WHERE TA001 = @TD003 AND TA002 = @TD004";
                                            dynamicParameters.AddDynamicParams(
                                              new
                                              {
                                                  TC003 = MrDocDate,
                                                  TD003 = WoErpPrefix,
                                                  TD004 = WoErpNo
                                              });

                                            rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        #region //將實際開工日期改為此領料單領料日期
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MOCTA SET
                                                TA012 = @TC003
                                                WHERE TA001 = @TD003 AND TA002 = @TD004";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              TC003 = MrDocDate,
                                              TD003 = WoErpPrefix,
                                              TD004 = WoErpNo
                                          });

                                        rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                                #endregion
                            }
                            #endregion

                            #region //先更新單據-->Y, 確認完成
                            //更新單頭確認碼Y, 確認者
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTC
                                           SET MODIFIER =@MODIFIER,
                                                MODI_DATE= @MODI_DATE,
                                                MODI_TIME= @MODI_TIME,
                                                MODI_AP= @MODI_AP,
                                                MODI_PRID= @MODI_PRID,
                                                FLAG= FLAG + 1,
                                                TC009 = 'Y',
                                               TC015 = @UserNo
                                         WHERE TC001 = @MrErpPrefix
                                           AND TC002 = @MrErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = UserNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = BaseHelper.ClientComputer(),
                                MODI_PRID = "BM",
                                UserNo,
                                MrErpPrefix,
                                MrErpNo
                            });

                            rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);

                            //更新單頭確認碼Y, 確認者
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTE
                                           SET MODIFIER =@MODIFIER,
                                                MODI_DATE= @MODI_DATE,
                                                MODI_TIME= @MODI_TIME,
                                                MODI_AP= @MODI_AP,
                                                MODI_PRID= @MODI_PRID,
                                                FLAG= FLAG + 1,
                                                TE019 = 'Y'
                                         WHERE TE001 = @MrErpPrefix
                                           AND TE002 = @MrErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = UserNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = BaseHelper.ClientComputer(),
                                MODI_PRID = "BM",
                                MrErpPrefix,
                                MrErpNo
                            });

                            rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);
                            #endregion
                            #endregion

                            #region //回寫MES確認狀態

                            #region //UPDATE MES.MaterialRequisition
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    SignupStatus = @SignupStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ConfirmStatus = "Y",
                                  ConfirmUserId = UserId,
                                  SignupStatus = "3",
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //UPDATE MES.MrDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MrDetail SET
                                    ConfirmStatus = @ConfirmStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ConfirmStatus = "Y",
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #endregion

                            #region //更新工單領料數量
                            foreach (var item in mrWipOrders)
                            {
                                #region //修改MES.WipOrder資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.WipOrder SET
                                        RequisitionSetQty = RequisitionSetQty + @Quantity,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE WoId = @WoId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      item.Quantity,
                                      LastModifiedDate,
                                      LastModifiedBy = UserId,
                                      item.WoId
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //更新MES製令已領料量
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.ManufactureOrder SET
                                        RequisitionSetQty = RequisitionSetQty + @Quantity,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      item.Quantity,
                                      LastModifiedDate,
                                      LastModifiedBy = UserId,
                                      item.MoId
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //更新回來MES工單資料
                            foreach (var item in mrDetails)
                            {
                                #region //更新MES.WoDetail資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE a
                                        SET a.RequisitionQty = RequisitionQty + @Quantity
                                        FROM MES.WoDetail a
                                        INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                        INNER JOIN MES.ManufactureOrder c ON b.WoId = c.WoId
                                        INNER JOIN MES.MrDetail d ON c.MoId = d.MoId AND d.MtlItemId = a.MtlItemId
                                        WHERE d.MrDetailId = @MrDetailId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      item.Quantity,
                                      LastModifiedDate,
                                      LastModifiedBy = UserId,
                                      item.MrDetailId
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrReConfirm -- 領退料單反確認 -- Ann 2022-08-31
        public string UpdateMrReConfirm(int MrId)
        {
            try
            {
                AddUserOperateLog(MrId);

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int UserId = CreateBy;
                    int rowsAffected = 0;
                    string ErpDbName = "";
                    string MrErpPrefix = "";
                    string MrErpNo = "";
                    string ErpNo = "";
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 ConfirmStatus, MrErpPrefix,  MrErpNo
                                    , FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate
                                    , FORMAT(a.DocDate, 'yyyyMMdd') ErpDocDate
                                    FROM MES.MaterialRequisition a
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料有誤!");

                            string DocDate = "";
                            string ErpDocDate = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "Y") throw new SystemException("領退料單非確認狀態!");
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                                DocDate = item.DocDate;
                                ErpDocDate = item.ErpDocDate;
                            }
                            #endregion

                            #region //確認此領料單是否為超領單別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.MQ054)) MQ054
                                    FROM CMSMQ a
                                    WHERE a.MQ001 = @MQ001";
                            dynamicParameters.Add("MQ001", MrErpPrefix);
                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMQResult.Count() <= 0) throw new SystemException("ERP尚未維護此領料單單別(" + MrErpPrefix + ")!!");

                            string ExcessFlag = "";
                            foreach (var item2 in CMSMQResult)
                            {
                                ExcessFlag = item2.MQ054;
                            }
                            #endregion

                            #region //取得領退料設定資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoId, a.Quantity
                                    , c.WoId
                                    FROM MES.MrWipOrder a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);
                            var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "MaterialRequisition");
                            dynamicParameters.Add("DetailCode", "reconfirm");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            #region //取得領退料單詳細資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MrDetailId, a.MtlItemId, a.Quantity, a.ActualQuantity, a.MoId, a.SubstitutionId, a.SubstitutionMtlItemNo BomMtlItemNo, a.SubstituteQty, a.SubstituteRate
                                    , b.Quantity MoQuantity
                                    , c.WoDetailId
                                    , d.MtlItemNo SubMtlItemNo
                                    , e.WoId, e.WoErpPrefix, e.WoErpNo
                                    , f.MtlItemNo BillMtlItemNo
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    LEFT JOIN MES.WoDetail c ON a.MtlItemId = c.MtlItemId AND b.WoId = c.WoId
                                    INNER JOIN PDM.MtlItem d ON a.MtlItemId = d.MtlItemId
                                    INNER JOIN MES.WipOrder e ON b.WoId = e.WoId
                                    INNER JOIN PDM.MtlItem f ON e.MtlItemId = f.MtlItemId
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);
                            if (MrDetailResult.Count() <= 0) throw new SystemException("領料單詳細資料資料有誤!");

                            foreach (var item in MrDetailResult)
                            {
                                if (ExcessFlag != "N" && item.WoDetailId == null)
                                {
                                    #region //判斷此品號是否為元件替代料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM BOMMB a 
                                            INNER JOIN INVMB b ON a.MB004 = b.MB001
                                            INNER JOIN INVMC c ON c.MC001 = a.MB004
                                            INNER JOIN INVMB d ON a.MB001 = d.MB001
                                            WHERE a.MB001 = @BomMtlItemNo
                                            AND a.MB002 = @BillMtlItemNo
                                            ANd a.MB004 = @SubMtlItemNo";
                                    dynamicParameters.Add("BomMtlItemNo", item.BomMtlItemNo);
                                    dynamicParameters.Add("BillMtlItemNo", item.BillMtlItemNo);
                                    dynamicParameters.Add("SubMtlItemNo", item.SubMtlItemNo);

                                    var BomResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (BomResult.Count() <= 0) throw new SystemException("製令用料資料有誤!!");
                                    #endregion
                                }

                                #region //超領單別相關檢核
                                if (ExcessFlag == "N")
                                {
                                    #region //確認物料是否有進行NG拆盤
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TrayMtlItemNgId, a.NgQty, a.AlreadyQty
                                            FROM MES.TrayMtlItemNg a 
                                            INNER JOIN PDM.BomDetail b ON a.BomDetailId = b.BomDetailId
                                            WHERE a.MoId = @MoId
                                            AND b.MtlItemId = @MtlItemId";
                                    dynamicParameters.Add("MoId", item.MoId);
                                    dynamicParameters.Add("MtlItemId", item.MtlItemId);

                                    var TrayMtlItemNgResult = sqlConnection.Query(sql, dynamicParameters);

                                    int TrayMtlItemNgId = -1;
                                    foreach (var item2 in TrayMtlItemNgResult)
                                    {
                                        //if (Convert.ToDouble(item2.AlreadyQty) - Convert.ToDouble(item.Quantity) < 0) throw new SystemException("此用料【" + item.SubMtlItemNo + "】已進行NG拆盤。<br>剩餘數量異常【" + (Convert.ToDouble(item2.AlreadyQty) - Convert.ToDouble(item.Quantity)) + "】!!");
                                        TrayMtlItemNgId = item2.TrayMtlItemNgId;
                                    }
                                    #endregion

                                    if (TrayMtlItemNgId > 0)
                                    {
                                        #region //Update MES.TrayMtlItemNg AlreadyQty
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.TrayMtlItemNg SET
                                                AlreadyQty = AlreadyQty - @Quantity,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE TrayMtlItemNgId = @TrayMtlItemNgId";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              item.Quantity,
                                              LastModifiedDate,
                                              LastModifiedBy = UserId,
                                              TrayMtlItemNgId
                                          });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //Insert MES.TrayMtlItemNgLog
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.TrayMtlItemNgLog (TrayMtlItemNgId, MrDetailId, [Action], Quantity
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                VALUES (@TrayMtlItemNgId, @MrDetailId, @Action, @Quantity
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                TrayMtlItemNgId,
                                                item.MrDetailId,
                                                Action = "N",
                                                Quantity = Convert.ToInt32(item.Quantity),
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                                #endregion
                            }
                            #endregion

                            #region //審核ERP權限
                            //string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "MOCI03", "RE-CONFIRM");
                            #endregion

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(DocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + DocDate + ")之單據!!");
                            }
                            #endregion

                            #region //查詢USR_GROUP
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.MF004)) USR_GROUP
                                    FROM ADMMF a
                                    WHERE MF001 = @MF001";
                            dynamicParameters.Add("MF001", UserNo);

                            var ADMMFResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (ADMMFResult.Count() <= 0) throw new SystemException("查無ERP帳號權限，無法進行拋轉及核單!");

                            string USR_GROUP = "";
                            foreach (var item in ADMMFResult)
                            {
                                USR_GROUP = item.USR_GROUP;
                            }
                            #endregion

                            #region //找出小數位數換算
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MF003
                                      FROM CMSMF
                                     WHERE MF001 = (SELECT MA003 FROM CMSMA)";
                            var MF003Result = sqlConnection2.Query(sql, dynamicParameters);
                            if (MF003Result.Count() <= 0) throw new SystemException("找不到幣別小數位設定!!!");
                            int MF003 = Convert.ToInt32(sqlConnection2.QueryFirstOrDefault(sql, dynamicParameters).MF003);
                            #endregion

                            #region //取出ERP單據資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TE001 AS D_A1,TE002 AS D_A2,TE003 AS D_A3,TC003 AS D_A4,
                                           TE004 AS D_B1,TE006 AS D_B2,MB022 AS D_B3, TE019, 
	                                       MB065,ISNULL(NULLIF(MB064, 0), 1) MB064,
	                                       CONVERT(varchar(12),DATEADD(d,MB023, convert(datetime, TC003)), 112) AS D_B5,
	                                       TE005 AS D_D1,ISNULL( MD004/MD003,1) AS D_D3,TE008 AS D_D4 ,
	                                       ISNULL(TE010, '') AS D_D5 ,TE014 AS D_D6,TE021 AS D_D7,
	                                       ISNULL(TE029, '') AS D_D8,TE011 AS D_O1,TE012 AS D_O2,MQ019 AS D_O3,MQ055 AS D_O4,
	                                       MQ010 AS D_O5,MQ008 AS D_O6,MQ011 AS D_O7,MQ019 AS D_O8,
                                           ISNULL(LTRIM(RTRIM(TE029)), '') TE029, LTRIM(RTRIM(MC009)) MC009,
                                           MC004, TB005, TB010, TE027, TB004, TB005, TA015
                                      FROM MOCTE
                                           INNER JOIN MOCTC ON TC001=TE001 AND TC002=TE002
                                           INNER JOIN INVMB ON MB001=TE004
                                           INNER JOIN CMSMQ ON MQ001=TE001
                                           INNER JOIN CMSMC ON MC001=TE008
                                           LEFT JOIN INVMD ON MD001=TE006
                                           INNER JOIN MOCTB ON TE011 = TB001 AND TE012 = TB002 AND TE004 = TB003 
                                           INNER JOIN MOCTA ON TB001 = TA001 AND TB002 = TA002
                                     WHERE TE001 = @MrErpPrefix
                                       AND TE002 = @MrErpNo";
                            dynamicParameters.Add("MrErpPrefix", MrErpPrefix);
                            dynamicParameters.Add("MrErpNo", MrErpNo);
                            var ErpMrResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (ErpMrResult.Count() <= 0) throw new SystemException("找不到ERP領料單據!");
                            #endregion

                            #region //更新單頭確認碼=U
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTC
                                           SET TC009 = 'U'
                                         WHERE TC001 = @MrErpPrefix
                                           AND TC002 = @MrErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MrErpPrefix,
                                MrErpNo
                            });

                            rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTE
                                           SET TE019 = 'U'
                                         WHERE TE001 = @MrErpPrefix
                                           AND TE002 = @MrErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MrErpPrefix,
                                MrErpNo
                            });

                            rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);
                            #endregion

                            #region //確認是否有條碼已開工
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrBarcodeRegister a 
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    INNER JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo AND b.MoId = c.MoId
                                    INNER JOIN MES.BarcodeProcess d ON c.BarcodeId = d.BarcodeId
                                    WHERE b.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            //if (BarcodeProcessResult.Count() > 0) throw new SystemException("領料單已有開工製令，無法進行反確認!!");
                            #endregion

                            #region //確認ERP製令狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"";
                            #endregion

                            foreach (var item in ErpMrResult)
                            {
                                if (item.TE019 != "Y") throw new SystemException("ERP單據目前非未核單狀態!");

                                #region //領料單反確認相關卡控
                                if (item.D_O5 < 0)
                                {
                                    #region //確認目前製令已領用量是否大於此次退料數量
                                    string mtlItemNo = item.D_B1;
                                    double materialRequisitionQty = Convert.ToDouble(item.D_D1);
                                    double issuedQty = Convert.ToDouble(item.TB005);
                                    if (materialRequisitionQty > issuedQty) throw new SystemException("料號【" + mtlItemNo + "】<br>此次退料量【" + materialRequisitionQty + "】已超過製令目前已領料量【" + issuedQty + "】!!");
                                    #endregion

                                    #region //反確認數量是否超過已入庫數量(入庫性質為為卡控缺入)
                                    #region //先計算總入庫數量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT ISNULL(SUM(a.TI019), 0) TotalQty
                                            FROM MOCTI a 
                                            INNER JOIN CMSMQ b ON a.TI001 = b.MQ001
                                            WHERE TI013 = @WoErpPrefix
                                            AND TI014 = @WoErpNo
                                            AND TI037 = 'Y'
                                            AND MQ055 = 'Y'";
                                    dynamicParameters.Add("WoErpPrefix", item.D_O1);
                                    dynamicParameters.Add("WoErpNo", item.D_O2);

                                    var MOCTIResult = sqlConnection2.Query(sql, dynamicParameters);

                                    double totalQty = 0;
                                    foreach (var item2 in MOCTIResult)
                                    {
                                        totalQty = Convert.ToDouble(item2.TotalQty);
                                    }
                                    #endregion

                                    #region //計算此物料比例來確認數量是否超過
                                    double unitRate = Convert.ToDouble(item.TB004 / item.TA015);
                                    double allowQty = Convert.ToDouble(item.TB005) - (totalQty * unitRate);
                                    if (Convert.ToDouble(item.D_D1) > allowQty) throw new SystemException($"序號【{item.D_A3}】數量已超過未入庫數量【{allowQty}】!!");
                                    #endregion
                                    #endregion
                                }
                                #endregion

                                #region //取出SQL欄位置到變數
                                string D_A1 = item.D_A1;
                                string D_A2 = item.D_A2;
                                string D_A3 = item.D_A3;
                                string D_A4 = item.D_A4;
                                string D_B1 = item.D_B1;
                                string D_B2 = item.D_B2;
                                string D_B3 = item.D_B3;
                                double D_B4 = Convert.ToDouble(Math.Round(item.MB065 / item.MB064, MF003));
                                string D_B5 = item.D_B5;
                                double D_D1 = Convert.ToDouble(item.D_D1);
                                double D_D3 = Convert.ToDouble(item.D_D3);
                                string D_D4 = item.D_D4;
                                string D_D5 = item.D_D5;
                                string D_D6 = item.D_D6;
                                int D_D7 = Convert.ToInt32(item.D_D7);
                                string D_D8 = item.D_D8;
                                string D_B8 = item.D_B8;
                                string D_O1 = item.D_O1;
                                string D_O2 = item.D_O2;
                                string D_O3 = item.D_O3;
                                string D_O4 = item.D_O4;
                                int D_O5 = Convert.ToInt32(item.D_O5);
                                string D_O6 = item.D_O6;
                                string D_O7 = item.D_O7;
                                string D_O8 = item.D_O8;
                                string MC004 = item.MC004;
                                string TE029 = item.TE029;
                                string LocationFlag = item.MC009;
                                string TE027 = item.TE027;
                                double TB004 = Convert.ToDouble(item.TB004);
                                double TB005 = Convert.ToDouble(item.TB005);
                                #endregion

                                #region //反確認
                                if (D_B3.Equals("Y") || D_B3.Equals("T")) //批號管理為Y才需處理
                                {
                                    //更新品號批號資料單頭單身
                                    rowsAffected += erpHelper.DelInvmef(D_B1, D_D5, D_A4, D_A1, D_A2, D_A3,
                                        UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);
                                    //刪除儲位批號異動明細資料檔
                                    rowsAffected += erpHelper.DelInvlf(D_A1, D_A2, D_A3, D_B1, D_D4,
                                                             D_D8, D_D5,
                                                             UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);
                                }

                                if (!D_B3.Equals("N") || LocationFlag == "Y")
                                {
                                    //更新品號庫別儲位批號檔
                                    rowsAffected += erpHelper.InsertInvmm(D_B1, D_D4, D_D8, D_D5, D_D1 * D_O5 * D_D3 * -1, D_D7 * -1, D_A4,
                                        UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);
                                }

                                //刪除異動明細資料檔
                                rowsAffected += erpHelper.DelInvla(D_B1, D_A4, D_O5, D_A1, D_A2, D_A3,
                                    UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);

                                if (MC004.Equals("1"))
                                {
                                    //更新品號
                                    rowsAffected += erpHelper.UpdateInvmb(D_B1, D_D1 * D_D3 * -1 * D_O5, D_D1 * D_D3 * D_B4 * -1 * D_O5,
                                        UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP);
                                }

                                //更新品號庫別檔
                                rowsAffected += erpHelper.UpdateInvmc(D_B1, D_D1 * D_D3 * -1 * D_O5, D_D1 * D_D3 * D_B4 * -1 * D_O5, D_D4, ErpDocDate,
                                    UserNo, "MOCTI", ErpNo, sqlConnection2, USR_GROUP, MrErpPrefix);

                                #region //取替代件處理
                                if (D_B1 != TE027)
                                {
                                    #region //查詢原元件備註
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TB017
                                            FROM MOCTB
                                            WHERE TB001 = @D_O1
                                            AND TB002 = @D_O2
                                            AND TB003 = @TE027";
                                    dynamicParameters.Add("D_O1", D_O1);
                                    dynamicParameters.Add("D_O2", D_O2);
                                    dynamicParameters.Add("TE027", TE027);

                                    var BomMOCTBResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (BomMOCTBResult.Count() <= 0) throw new SystemException("查詢替代料【" + D_B1 + "】原元件時錯誤!");

                                    string TB017 = "";
                                    foreach (var item2 in BomMOCTBResult)
                                    {
                                        TB017 = item2.TB017;
                                    }
                                    #endregion

                                    #region //計算備註
                                    string Remark = TB017 + "[有取替代:需領用量+" + D_D1.ToString() + "]";
                                    if (Remark.Length > 255)
                                    {
                                        Remark = Remark.Substring(0, 255);
                                    }
                                    #endregion

                                    #region //UPDATE MOCTB 原元件 需領用量、備註
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MOCTB SET
                                            TB004 = TB004 + @D_D1,
                                            TB017 = @Remark
                                            WHERE TB001 = @D_O1
                                            AND TB002 = @D_O2
                                            AND TB003 = @TE027";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            D_D1,
                                            Remark,
                                            D_O1,
                                            D_O2,
                                            TE027
                                        });

                                    int row = sqlConnection2.Execute(sql, dynamicParameters);
                                    if (row <= 0) throw new SystemException("更新替代料【" + D_B1 + "】原元件需領用量、備註時錯誤!");
                                    rowsAffected += row;
                                    #endregion

                                    #region //UPDATE MES.WoDetail
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE a 
                                            SET a.DemandRequisitionQty += @D_D1
                                            FROM MES.WoDetail a 
                                            INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                            INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
                                            WHERE b.WoErpPrefix = @D_O1
                                            AND b.WoErpNo = @D_O2
                                            AND c.MtlItemNo = @TE027";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          D_D1,
                                          D_O1,
                                          D_O2,
                                          TE027
                                      });

                                    row = sqlConnection.Execute(sql, dynamicParameters);
                                    if (row <= 0) throw new SystemException("更新MES替代料【" + D_B1 + "】原元件需領用量時錯誤!");
                                    rowsAffected += row;
                                    #endregion

                                    if (TB005 == D_D1)
                                    {
                                        #region //DELETE MOCTB 取替代料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE MOCTB
                                                WHERE TB001 = @D_O1
                                                AND TB002 = @D_O2
                                                AND TB003 = @D_B1
                                                AND TB027 = '2'";
                                        dynamicParameters.Add("D_O1", D_O1);
                                        dynamicParameters.Add("D_O2", D_O2);
                                        dynamicParameters.Add("D_B1", D_B1);

                                        row = sqlConnection2.Execute(sql, dynamicParameters);
                                        if (row <= 0) throw new SystemException("刪除替代料【" + D_B1 + "】時錯誤!");
                                        rowsAffected += row;
                                        #endregion

                                        #region //DELETE MES.MoMtlSetting
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE a
                                                FROM MES.MoMtlSetting a 
                                                INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                                INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                                INNER JOIN PDM.MtlItem d ON b.MtlItemId = d.MtlItemId
                                                WHERE c.WoErpPrefix = @D_O1
                                                AND c.WoErpNo = @D_O2
                                                AND d.MtlItemNo = @D_B1";
                                        dynamicParameters.Add("D_O1", D_O1);
                                        dynamicParameters.Add("D_O2", D_O2);
                                        dynamicParameters.Add("D_B1", D_B1);

                                        row = sqlConnection.Execute(sql, dynamicParameters);
                                        if (row <= 0) throw new SystemException("刪除MES替代料【" + D_B1 + "】時錯誤!");
                                        rowsAffected += row;
                                        #endregion

                                        #region //DELETE MES.WoDetail
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE a 
                                                FROM MES.WoDetail a 
                                                INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                                INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
                                                WHERE b.WoErpPrefix = @D_O1
                                                AND b.WoErpNo = @D_O2
                                                AND c.MtlItemNo = @D_B1";
                                        dynamicParameters.Add("D_O1", D_O1);
                                        dynamicParameters.Add("D_O2", D_O2);
                                        dynamicParameters.Add("D_B1", D_B1);

                                        row = sqlConnection.Execute(sql, dynamicParameters);
                                        if (row <= 0) throw new SystemException("刪除MES製令單身替代料【" + D_B1 + "】時錯誤!");
                                        rowsAffected += row;
                                        #endregion
                                    }
                                    else
                                    {
                                        #region //UPDATE MOCTB 取替代料 需領用量
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MOCTB SET
                                                TB004 = TB004 - @D_D1
                                                WHERE TB001 = @D_O1
                                                AND TB002 = @D_O2
                                                AND TB003 = @D_B1";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                D_D1,
                                                D_O1,
                                                D_O2,
                                                D_B1
                                            });

                                        row = sqlConnection2.Execute(sql, dynamicParameters);
                                        if (row <= 0) throw new SystemException("更新替代料【" + D_B1 + "】需領用量時錯誤!");
                                        rowsAffected += row;
                                        #endregion

                                        #region //UPDATE MES.WoDetail 取替代料 需領用量
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE a 
                                                SET a.DemandRequisitionQty -= @D_D1
                                                FROM MES.WoDetail a
                                                INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                                INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
                                                WHERE b.WoErpPrefix = @D_O1
                                                AND b.WoErpNo = @D_O2
                                                AND c.MtlItemNo = @D_B1";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                D_D1,
                                                D_O1,
                                                D_O2,
                                                D_B1
                                            });

                                        row = sqlConnection.Execute(sql, dynamicParameters);

                                        if (row <= 0) throw new SystemException("更新MES製令單身替代料【" + D_B1 + "】時錯誤!");
                                        rowsAffected += row;
                                        #endregion
                                    }
                                }
                                #endregion


                                #region //更新製令領料套數, 單身已領數量
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MOCTB
                                           SET TB005 = TB005 - (@D_D1 * @D_O5 * -1)
                                         WHERE TB001 = @D_O1
                                           AND TB002 = @D_O2 
                                           AND TB003 = @D_B1";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    D_D1,
                                    D_O1,
                                    D_O2,
                                    D_B1,
                                    D_O5
                                });

                                rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);

                                #endregion

                                #endregion
                            }

                            #region //更新製令領料套數
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TD003,TD004,TD006,MQ010
                                      FROM MOCTD
                                           INNER JOIN CMSMQ ON TD001 = MQ001
                                     WHERE TD001 = @MrErpPrefix
                                       AND TD002 = @MrErpNo";
                            dynamicParameters.Add("MrErpPrefix", MrErpPrefix);
                            dynamicParameters.Add("MrErpNo", MrErpNo);
                            var MOCTDResult = sqlConnection2.Query(sql, dynamicParameters);

                            List<string> WoErpFullNoList = new List<string>();

                            foreach (var item in MOCTDResult)
                            {
                                string TD003 = item.TD003;
                                string TD004 = item.TD004;

                                if (WoErpFullNoList.IndexOf(item.TD003 + "-" + item.TD004) == -1)
                                {
                                    WoErpFullNoList.Add(item.TD003 + "-" + item.TD004);
                                }

                                double TD006 = Convert.ToDouble(item.TD006);
                                int MQ010 = Convert.ToInt32(item.MQ010);
                                #region //更新製令領料套數, 單身已領數量
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MOCTA
                                           SET TA016 = TA016 - (@TD006 * @MQ010 * -1)
                                         WHERE TA001 = @TD003
                                           AND TA002 = @TD004";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    TD003,
                                    TD004,
                                    TD006,
                                    MQ010
                                });

                                rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);

                                #endregion
                            }
                            #endregion

                            #region //先更新單據-->Y, 確認完成
                            //更新單頭確認碼Y, 確認者
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTC
                                           SET MODIFIER =@MODIFIER,
                                                MODI_DATE= @MODI_DATE,
                                                MODI_TIME= @MODI_TIME,
                                                MODI_AP= @MODI_AP,
                                                MODI_PRID= @MODI_PRID,
                                                FLAG= FLAG + 1,
                                                TC009 = 'N',
                                               TC015 = @UserNo
                                         WHERE TC001 = @MrErpPrefix
                                           AND TC002 = @MrErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = UserNo,
                                MODI_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                MODI_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                MODI_AP = BaseHelper.ClientComputer(),
                                MODI_PRID = "BM",
                                UserNo,
                                MrErpPrefix,
                                MrErpNo
                            });

                            rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);

                            //更新單頭確認碼Y, 確認者
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTE
                                    SET MODIFIER =@MODIFIER,
                                        MODI_DATE= @MODI_DATE,
                                        MODI_TIME= @MODI_TIME,
                                        MODI_AP= @MODI_AP,
                                        MODI_PRID= @MODI_PRID,
                                        FLAG= FLAG + 1,
                                        TE019 = 'N'
                                    WHERE TE001 = @MrErpPrefix
                                    AND TE002 = @MrErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = UserNo,
                                MODI_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                MODI_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                MODI_AP = BaseHelper.ClientComputer(),
                                MODI_PRID = "BM",
                                MrErpPrefix,
                                MrErpNo
                            });

                            rowsAffected = sqlConnection2.Execute(sql, dynamicParameters);
                            #endregion

                            #region //找出製令是否有其他確認狀態之領料單
                            foreach (var item in WoErpFullNoList)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MIN(c.TC003) TC003
                                        FROM MOCTD a 
                                        INNER JOIN MOCTE b ON a.TD001 = b.TE001 AND a.TD002 = b.TE002
                                        INNER JOIN MOCTC c ON a.TD001 = c.TC001 AND a.TD002 = c.TC002
                                        WHERE a.TD003 + '-' + a.TD004 = @WoErpFullNo
                                        AND b.TE019 = 'Y'";
                                dynamicParameters.Add("WoErpFullNo", item);

                                var MinMrDateResult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item2 in MinMrDateResult)
                                {
                                    if (item2.TC003 != null)
                                    {
                                        #region //更改此製令實際開工日
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MOCTA SET
                                                TA012 = @TA012
                                                WHERE TA001 + '-' + TA002 = @WoErpFullNo";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              TA012 = item2.TC003,
                                              WoErpFullNo = item
                                          });

                                        rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                    else
                                    {
                                        #region //確認ERP工單資料是否正確
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TA011 OriTA011, TA012 OriTA012
                                                FROM MOCTA
                                                WHERE TA001 + '-' + TA002 = @WoErpFullNo";
                                        dynamicParameters.Add("WoErpFullNo", item);

                                        var MOCTAResult = sqlConnection2.Query(sql, dynamicParameters);

                                        string OriTA011 = "";
                                        string OriTA012 = "";
                                        foreach (var item3 in MOCTAResult)
                                        {
                                            OriTA011 = item3.OriTA011;
                                            OriTA012 = item3.OriTA012;
                                        }
                                        #endregion

                                        #region //將製令改為未生產且實際開工日改為空
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MOCTA SET
                                                TA011 = @TA011,
                                                TA012 = @TA012
                                                WHERE TA001 + '-' + TA002 = @WoErpFullNo";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              TA011 = OriTA011 != "y" ? "1" : OriTA011,
                                              TA012 = OriTA011 != "y" ? "" : OriTA012,
                                              WoErpFullNo = item
                                          });

                                        rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                            }
                            #endregion

                            #region //若成功則將相關資料寫回MES
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MaterialRequisition SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    SignupStatus = @SignupStatus,
                                    TransferStatus = 'R',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ConfirmStatus = "N",
                                  ConfirmUserId = UserId,
                                  SignupStatus = "0",
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  MrId
                              });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MrDetail SET
                                    ConfirmStatus = @ConfirmStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrId = @MrId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ConfirmStatus = "N",
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  MrId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            foreach (var item2 in MrWipOrderResult)
                            {
                                #region //修改MES.WipOrder資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.WipOrder SET
                                        RequisitionSetQty = RequisitionSetQty - @Quantity,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE WoId = @WoId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      item2.Quantity,
                                      LastModifiedDate,
                                      LastModifiedBy = UserId,
                                      item2.WoId
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //更新MES製令已領料量
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.ManufactureOrder SET
                                        RequisitionSetQty = RequisitionSetQty + @Quantity,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      item2.Quantity,
                                      LastModifiedDate,
                                      LastModifiedBy = UserId,
                                      item2.MoId
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }

                            foreach (var item2 in MrDetailResult)
                            {
                                #region //修改MES.WoDetail資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.WoDetail SET
                                        RequisitionQty = RequisitionQty - @Quantity,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE WoDetailId = @WoDetailId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      item2.Quantity,
                                      LastModifiedDate,
                                      LastModifiedBy = UserId,
                                      item2.WoDetailId
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrVoid -- 領退料單作廢 -- Ann 2022-09-02
        public string UpdateMrVoid(int MrId = -1)
        {
            try
            {
                AddUserOperateLog(MrId);

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int UserId = CreateBy;
                    string MrErpPrefix = "";
                    string MrErpNo = "";
                    string UserNo = "";
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //判斷領退料單資料是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ConfirmStatus, a.MrErpPrefix, a.MrErpNo
                                , b.UserNo ConfirmUserNo
                                FROM MES.MaterialRequisition a
                                LEFT JOIN BAS.[User] b ON a.ConfirmUserId = b.UserId
                                WHERE a.MrId = @MrId";
                        dynamicParameters.Add("MrId", MrId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("領退料單資料有誤!");

                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("領退料單狀態無法作廢!");
                            MrErpPrefix = item.MrErpPrefix;
                            MrErpNo = item.MrErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MaterialRequisition");
                        dynamicParameters.Add("DetailCode", "void");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        #region //檢查BARCODE是否已經過站
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Barcode a
                                INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                INNER JOIN MES.BarcodeProcess c ON a.BarcodeId = c.BarcodeId
                                INNER JOIN MES.MrDetail d ON b.MrDetailId = d.MrDetailId
                                WHERE d.MrId = @MrId";
                        dynamicParameters.Add("MrId", MrId);

                        var CheckBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (CheckBarcodeProcessResult.Count() > 0) throw new SystemException("條碼已有過站紀錄，無法作廢!!");
                        #endregion
                    }

                    #region //進行作廢
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //確認領料單ERP狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TC009
                                FROM MOCTC
                                WHERE TC001 = @TC001
                                AND TC002 = @TC002";
                        dynamicParameters.Add("TC001", MrErpPrefix);
                        dynamicParameters.Add("TC002", MrErpNo);

                        var MOCTCResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MOCTCResult.Count() <= 0) throw new SystemException("ERP查無此領料單!!");

                        foreach (var item in MOCTCResult)
                        {
                            if (item.TC009 != "N") throw new SystemException("此領料單ERP狀態無法作廢!!");
                        }
                        #endregion

                        #region //審核ERP權限
                        string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI03", "VOID");
                        #endregion

                        #region //進行作廢程序
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTC SET
                                TC009 = @TC009
                                WHERE TC001 = @TC001
                                AND TC002 = @TC002";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              TC009 = "V",
                              TC001 = MrErpPrefix,
                              TC002 = MrErpNo
                          });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTE SET
                                TE019 = @TE019
                                WHERE TE001 = @TE001
                                AND TE002 = @TE002";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              TE019 = "V",
                              TE001 = MrErpPrefix,
                              TE002 = MrErpNo
                          });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }
                    #endregion

                    #region //若成功則將相關資料寫回MES
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MaterialRequisition SET
                                ConfirmStatus = @ConfirmStatus,
                                ConfirmUserId = @ConfirmUserId,
                                SignupStatus = @SignupStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MrId = @MrId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ConfirmStatus = "V",
                              ConfirmUserId = UserId,
                              SignupStatus = "3",
                              LastModifiedDate,
                              LastModifiedBy = UserId,
                              MrId
                          });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MrDetail SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MrId = @MrId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ConfirmStatus = "V",
                              LastModifiedDate,
                              LastModifiedBy = UserId,
                              MrId
                          });

                        rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //若有條碼綁定，將條碼解除綁定
                        dynamicParameters = new DynamicParameters();
                        if (MrErpPrefix.IndexOf("56") == -1)
                        {
                            sql = @"SELECT a.MrDetailId
                                    , b.BarcodeNo
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.MrBarcodeRegister b ON a.MrDetailId = b.MrDetailId
                                    WHERE MrId = @MrId";
                        }
                        else
                        {
                            sql = @"SELECT a.MrDetailId
                                    , b.BarcodeNo
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.MrBarcodeReRegister b ON a.MrDetailId = b.MrDetailId
                                    WHERE MrId = @MrId";
                        }
                        dynamicParameters.Add("MrId", MrId);

                        var mrDetailIdResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in mrDetailIdResult)
                        {
                            #region //檢查此發料單單身是否有條碼轉移紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                    FROM MES.MrBarcodeTransferLog a
                                    WHERE a.MrDetailId = @MrDetailId
                                    ORDER BY a.CreateDate DESC";

                            dynamicParameters.Add("MrDetailId", item.MrDetailId);

                            var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TransferLogResult.Count() > 0)
                            {
                                foreach (var item2 in TransferLogResult)
                                {
                                    #region //UPDATE MES.Barcode回原先資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            MoId = @MoId,
                                            CurrentMoProcessId = @CurrentMoProcessId,
                                            NextMoProcessId = @NextMoProcessId,
                                            CurrentProdStatus = @CurrentProdStatus,
                                            BarcodeStatus = @BarcodeStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeNo = @BarcodeNo";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          item2.MoId,
                                          item2.CurrentMoProcessId,
                                          item2.NextMoProcessId,
                                          item2.CurrentProdStatus,
                                          item2.BarcodeStatus,
                                          LastModifiedDate,
                                          LastModifiedBy = UserId,
                                          item2.BarcodeNo
                                      });

                                    rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //將轉移LOG移除
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                            WHERE LogId = @LogId";
                                    dynamicParameters.Add("LogId", item2.LogId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //刪除MES.Barcode資料
                                dynamicParameters = new DynamicParameters();
                                if (MrErpPrefix.IndexOf("56") == -1)
                                {
                                    sql = @"DELETE a
                                            FROM MES.Barcode a
                                            INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                            INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                            WHERE c.MrId = @MrId";
                                }
                                else
                                {
                                    sql = @"DELETE a
                                            FROM MES.Barcode a
                                            INNER JOIN MES.MrBarcodeReRegister b ON a.BarcodeNo = b.BarcodeNo
                                            INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                            WHERE c.MrId = @MrId";
                                }
                                dynamicParameters.Add("MrId", MrId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }

                            #endregion

                            #region //刪除條碼綁定資料
                            dynamicParameters = new DynamicParameters();

                            if (MrErpPrefix.IndexOf("56") == -1)
                            {
                                sql = @"DELETE FROM MES.MrBarcodeRegister
                                        WHERE MrDetailId = @MrDetailId";
                            }
                            else
                            {
                                sql = @"DELETE FROM MES.MrBarcodeReRegister
                                        WHERE MrDetailId = @MrDetailId";
                            }
                            
                            dynamicParameters.Add("MrDetailId", item.MrDetailId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        #endregion

                        #region //將綁定製令與單身都刪除
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a 
                                FROM MES.MrWipOrder a 
                                WHERE a.MrId = @MrId";
                        dynamicParameters.Add("MrId", MrId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a 
                                FROM MES.MrDetail a 
                                WHERE a.MrId = @MrId";
                        dynamicParameters.Add("MrId", MrId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    #endregion
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMrBarcodeRegister -- 更新物料條碼控管資料 -- Ann 2022-09-05
        public string UpdateMrBarcodeRegister(int BarcodeRegisterId, int MrDetailId, string BarcodeNo)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【條碼代碼】不能為空!");
                if (BarcodeNo.Length > 32) throw new SystemException("【條碼代碼】長度錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷物料條碼控管資料是否有誤
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MrBarcodeRegister
                                WHERE BarcodeRegisterId = @BarcodeRegisterId";
                        dynamicParameters.Add("BarcodeRegisterId", BarcodeRegisterId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("物料條碼控管資料有誤!");
                        #endregion

                        #region //檢查領退料單詳細資料是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConfirmStatus
                                FROM MES.MrDetail
                                WHERE MrDetailId = @MrDetailId";
                        dynamicParameters.Add("MrDetailId", MrDetailId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("領退料單詳細資料有誤!");

                        foreach (var item in result2)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("領退料單已被確認，無法更改!");
                        }
                        #endregion

                        #region //判斷 領退料單詳細資料+條碼代碼 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MrBarcodeRegister
                                WHERE MrDetailId = @MrDetailId
                                AND BarcodeNo = @BarcodeNo
                                AND BarcodeRegisterId != @BarcodeRegisterId";
                        dynamicParameters.Add("MrDetailId", MrDetailId);
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("BarcodeRegisterId", BarcodeRegisterId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() > 0) throw new SystemException("【領退料單詳細資料 + 條碼代碼】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MrBarcodeRegister SET
                                MrDetailId = @MrDetailId,
                                BarcodeNo = @BarcodeNo,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeRegisterId = @BarcodeRegisterId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MrDetailId,
                                BarcodeNo,
                                LastModifiedDate,
                                LastModifiedBy,
                                BarcodeRegisterId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //ConfirmInventoryTransaction -- 拋轉+核准 庫存異動單據 -- Ann 2023-12-21
        public string ConfirmInventoryTransaction(int ItId)
        {
            try
            {
                AddUserOperateLog(ItId);

                int currentNum = 0, yearLength = 0, lineLength = 0, rowsAffected = 0;
                string encode = "", paymentTerm = "", factory = "";
                DateTime referenceTime = default(DateTime);

                string ErpDbName = "";
                string ErpNo = "";

                List<InventoryTransaction> inventoryTransactions = new List<InventoryTransaction>();
                List<ItDetail> itDetails = new List<ItDetail>();

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMinutes(2)))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (BaseHelper.CheckUserAuthority(CreateBy, CurrentCompany, "A", "InventoryTransaction", "update", sqlConnection).Equals("N")) throw new SystemException("人員權限檢核有異常，請嘗試重新登入!");

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //取得庫存異動單據 單頭資料
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.ItId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.CompanyId, a.ItErpPrefix, a.ItErpNo, FORMAT(a.ItDate, 'yyyy-MM-dd') ItDate
                                , FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate, a.DepartmentId, a.Remark, a.TotalQty, a.Amount
                                , a.ConfirmStatus, a.ConfirmUserId, a.TransferStatus, FORMAT(a.TransferDate, 'yyyy-MM-dd') TransferDate
                                , FORMAT(a.ItDate, 'yyyyMMdd') ErpItDate, FORMAT(a.DocDate, 'yyyyMMdd') ErpDocDate
                                , b.DepartmentNo, b.DepartmentName
                                , c.UserNo ConfirmUserNo, c.UserName ConfirmUserName";
                            sqlQuery.mainTables =
                                @"FROM SCM.InventoryTransaction a 
                                LEFT JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                                LEFT JOIN BAS.[User] c ON a.ConfirmUserId = c.UserId";
                            sqlQuery.auxTables = "";
                            string queryCondition = @"AND a.CompanyId = @CompanyId AND a.ItId = @ItId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("ItId", ItId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            inventoryTransactions = BaseHelper.SqlQuery<InventoryTransaction>(sqlConnection, dynamicParameters, sqlQuery);
                            #endregion

                            #region //取得庫存異動單據 單身資料
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.ItDetailId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.ItId, a.ItSequence, a.MtlItemId, a.ItMtlItemName, a.ItMtlItemSpec
                                , a.ItQty, a.UomId, a.InvQty, a.UnitCost, a.Amount, a.InventoryId, a.ToInventoryId
                                , a.StorageLocation, a.ToStorageLocation, a.ItRemark
                                , b.MtlItemNo
                                , c.UomNo, c.UomName
                                , d.InventoryNo, d.InventoryName
                                , ISNULL(e.InventoryNo, '') ToInventoryNo, ISNULL(e.InventoryName, '') InventoryName
                                , f.ItErpPrefix, f.ItErpNo";
                            sqlQuery.mainTables =
                                @"FROM SCM.ItDetail a 
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                INNER JOIN PDM.UnitOfMeasure c ON a.UomId = c.UomId
                                INNER JOIN SCM.Inventory d ON a.InventoryId = d.InventoryId
                                LEFT JOIN SCM.Inventory e ON a.ToInventoryId = e.InventoryId
                                INNER JOIN SCM.InventoryTransaction f ON a.ItId = f.ItId";
                            sqlQuery.auxTables = "";
                            queryCondition = @"AND a.ItId = @ItId";
                            dynamicParameters.Add("ItId", ItId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            itDetails = BaseHelper.SqlQuery<ItDetail>(sqlConnection, dynamicParameters, sqlQuery);
                            #endregion

                            #region //檢查此單據單頭是否已存在ERP，且狀態為未核單
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TA006)) TA006
                                    FROM INVTA 
                                    WHERE TA001 = @ItErpPrefix
                                    AND TA002 = @ItErpNo";
                            dynamicParameters.Add("ItErpPrefix", inventoryTransactions[0].ItErpPrefix);
                            dynamicParameters.Add("ItErpNo", inventoryTransactions[0].ItErpNo);

                            var INVTAResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVTAResult)
                            {
                                if (item.TA006 != "N") throw new SystemException("此單據目前非未確認狀態，無法拋轉或核單!!");
                            }
                            #endregion

                            #region //檢查此單據單身是否已存在ERP，且狀態為未核單
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TB018)) TB018
                                    FROM INVTB 
                                    WHERE TB001 = @ItErpPrefix
                                    AND TB002 = @ItErpNo";
                            dynamicParameters.Add("ItErpPrefix", inventoryTransactions[0].ItErpPrefix);
                            dynamicParameters.Add("ItErpNo", inventoryTransactions[0].ItErpNo);

                            var INVTBResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVTBResult)
                            {
                                if (item.TB018 != "N") throw new SystemException("此單據單身目前非未確認狀態，無法拋轉或核單!!");
                            }
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "InventoryTransaction");
                            dynamicParameters.Add("DetailCode", "confirm");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            #region //審核ERP權限
                            string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "COPI06", "CREATE");
                            #endregion

                            #region //查詢廠別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB001)) MB001 FROM CMSMB";
                            var CMSMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMBResult.Count() <= 0) throw new SystemException("找不到廠別!!");
                            if (CMSMBResult.Count() > 1) throw new SystemException("廠別數有多個，請與資訊人員確認!!");

                            string TC004 = "";
                            foreach (var item in CMSMBResult)
                            {
                                TC004 = item.MB001;
                            }
                            #endregion

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(inventoryTransactions[0].DocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + inventoryTransactions[0].DocDate + ")之單據!!");
                            }
                            #endregion

                            #region //取得本國幣別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 LTRIM(RTRIM(MA003)) MA003 FROM CMSMA";

                            var CMSMAResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMAResult.Count() <= 0) throw new SystemException("共用參數檔案資料錯誤!!");

                            string Currency = "";
                            foreach (var item in CMSMAResult)
                            {
                                Currency = item.MA003;
                            }
                            #endregion

                            #region //小數點後取位
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MF005, a.MF006
                                    FROM CMSMF a 
                                    WHERE a.MF001 = @Currency";
                            dynamicParameters.Add("Currency", Currency);

                            var CMSMFResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMFResult.Count() <= 0) throw new SystemException("金額小數點取位資料錯誤!!");

                            int unitDecimal = 0;
                            int amountDecimal = 0;
                            foreach (var item in CMSMFResult)
                            {
                                unitDecimal = Convert.ToInt32(item.MF005);
                                amountDecimal = Convert.ToInt32(item.MF006);
                            }
                            #endregion

                            #region //取得單據性質
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT RTRIM(LTRIM(MQ003)) MQ003
                                    FROM CMSMQ
                                    WHERE MQ001 = @ItErpPrefix";
                            dynamicParameters.Add("ItErpPrefix", inventoryTransactions[0].ItErpPrefix);

                            var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMQResult.Count() <= 0) throw new SystemException("單據性質資料錯誤!!");

                            string MQ003 = "";
                            string TA018 = "";
                            foreach (var item in CMSMQResult)
                            {
                                MQ003 = item.MQ003;
                                if (MQ003 == "11")
                                {
                                    TA018 = "0";
                                }
                            }
                            #endregion

                            #region //依據單據是否已拋轉ERP做不同更改流程
                            if (INVTAResult.Count() > 0)
                            {
                                #region //UPDATE INVTA 庫存異動單據 單頭
                                foreach (var item in inventoryTransactions)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE INVTA SET
                                            MODIFIER = @MODIFIER,
                                            MODI_DATE = @MODI_DATE,
                                            FLAG += 1,
                                            MODI_TIME = @MODI_TIME,
                                            MODI_AP = @MODI_AP,
                                            MODI_PRID = @MODI_PRID,
                                            TA003 = @ErpItDate,
                                            TA004 = @DepartmentNo,
                                            TA005 = @Remark,
                                            TA011 = @TotalQty,
                                            TA012 = @Amount,
                                            TA014 = @ErpDocDate
                                            WHERE TA001 = @ItErpPrefix
                                            AND TA002 = @ItErpNo";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MODIFIER = UserNo,
                                            MODI_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                            MODI_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                            MODI_AP = UserNo + "PC",
                                            MODI_PRID = UserNo + "BM",
                                            item.ErpItDate,
                                            item.DepartmentNo,
                                            item.Remark,
                                            item.TotalQty,
                                            Amount = Math.Round((double)item.Amount, amountDecimal),
                                            item.ErpDocDate,
                                            item.ItErpPrefix,
                                            item.ItErpNo
                                        });

                                    rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                }
                                #endregion

                                #region //先刪除原單身再新增
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE INVTB
                                        WHERE TB001 = @ItErpPrefix
                                        AND TB002 = @ItErpNo";
                                dynamicParameters.Add("ItErpPrefix", inventoryTransactions[0].ItErpPrefix);
                                dynamicParameters.Add("ItErpNo", inventoryTransactions[0].ItErpNo);

                                rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                #endregion

                                #region //INSERT INVTB 庫存異動單據 單身
                                foreach (var item in itDetails)
                                {
                                    #region //取得TB024相關資料
                                    string TB024 = "";
                                    /* INVTB.TB024單身保稅碼預帶方式 :
                                     *  11單別才需要判斷，若12則直接帶空值
                                        如果單頭保稅碼INVTA.TA018='0'(依品號設定)--> 參考INVMB.MB020 = Y或N
                                        如果單頭保稅碼INVTA.TA018='Y' --> 則INVTB.TB024 = 'Y'
                                        如果單頭保稅碼INVTA.TA018='N' --> 則INVTB.TB024 = 'N' */

                                    if (MQ003 == "11")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT MB020
                                                FROM INVMB
                                                WHERE MB001 = @MtlItemNo";
                                        dynamicParameters.Add("MtlItemNo", item.MtlItemNo);

                                        var INVMBResult = sqlConnection2.Query(sql, dynamicParameters);

                                        if (INVMBResult.Count() <= 0) throw new SystemException("品號資料錯誤!!");

                                        foreach (var item2 in INVMBResult)
                                        {
                                            TB024 = item2.MB020;
                                        }
                                    }
                                    #endregion

                                    #region //部門費用領料、轉撥單需檢查庫存量是否足夠
                                    if (item.ItErpPrefix == "1101" || item.ItErpPrefix == "1201")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT MC007
                                                FROM INVMC
                                                WHERE MC001 = @MtlItemNo
                                                AND MC002 = @InventoryNo";
                                        dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                                        dynamicParameters.Add("InventoryNo", item.InventoryNo);

                                        var INVMCResult = sqlConnection2.Query(sql, dynamicParameters);

                                        if (INVMCResult.Count() <= 0) throw new SystemException("品號【" + item.MtlItemNo + "】查無庫別【" + item.InventoryNo + "】相關資料!!");

                                        foreach (var item2 in INVMCResult)
                                        {
                                            if (item.ItQty > Convert.ToDouble(item2.MC007)) throw new SystemException("異動數量已超過庫別【" + item.InventoryNo + "】庫存量【" + item2.MC007 + "】!!");
                                        }
                                    }
                                    #endregion

                                    #region //INSERT INVTB
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO INVTB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID
                                            , TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB014
                                            , TB015, TB016, TB017, TB018, TB019, TB020, TB021, TB022, TB023, TB024, TB025, TB026, TB027)
                                            OUTPUT INSERTED.TB001, INSERTED.TB002, INSERTED.TB003
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID
                                            , @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014
                                            , @TB015, @TB016, @TB017, @TB018, @TB019, @TB020, @TB021, @TB022, @TB023, @TB024, @TB025, @TB026, @TB027)";

                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          COMPANY = ErpNo,
                                          CREATOR = UserNo,
                                          USR_GROUP,
                                          CREATE_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                          FLAG = 1,
                                          CREATE_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                          CREATE_AP = UserNo + "PC",
                                          CREATE_PRID = "BM",
                                          TB001 = item.ItErpPrefix,
                                          TB002 = item.ItErpNo,
                                          TB003 = item.ItSequence,
                                          TB004 = item.MtlItemNo,
                                          TB005 = item.ItMtlItemName,
                                          TB006 = item.ItMtlItemSpec,
                                          TB007 = item.ItQty,
                                          TB008 = item.UomNo,
                                          TB009 = item.InvQty,
                                          TB010 = Math.Round((double)item.UnitCost, unitDecimal),
                                          TB011 = Math.Round((double)item.Amount, amountDecimal),
                                          TB012 = item.InventoryNo,
                                          TB013 = item.ToInventoryNo,
                                          TB014 = "",
                                          TB015 = "",
                                          TB016 = "",
                                          TB017 = item.ItRemark,
                                          TB018 = "N",
                                          TB019 = inventoryTransactions[0].ErpItDate,
                                          TB020 = "",
                                          TB021 = "",
                                          TB022 = 0.000,
                                          TB023 = "",
                                          TB024,
                                          TB025 = 0.000,
                                          TB026 = item.StorageLocation,
                                          TB027 = item.ToStorageLocation
                                      });
                                    var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion
                                }
                                #endregion
                            }
                            else
                            {
                                #region //取得單號流程
                                string ItErpNo = "";
                                referenceTime = DateTime.ParseExact(inventoryTransactions[0].ErpDocDate, "yyyyMMdd", CultureInfo.InvariantCulture);

                                #region //查詢單據設定
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MQ004, a.MQ005, a.MQ006, a.MQ044
                                        FROM CMSMQ a
                                        WHERE a.COMPANY = @CompanyNo
                                        AND a.MQ001 = @ErpPrefix";
                                dynamicParameters.Add("CompanyNo", ErpNo);
                                dynamicParameters.Add("ErpPrefix", inventoryTransactions[0].ItErpPrefix);

                                var resultDocSetting = sqlConnection2.Query(sql, dynamicParameters);
                                if (resultDocSetting.Count() <= 0) throw new SystemException("ERP單據設定資料不存在!");

                                foreach (var item in resultDocSetting)
                                {
                                    encode = item.MQ004; //編碼方式
                                    yearLength = Convert.ToInt32(item.MQ005); //年碼數
                                    lineLength = Convert.ToInt32(item.MQ006); //流水號碼數
                                }
                                #endregion

                                #region //單號取號
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TA002))), '" + new string('0', lineLength) + @"'), " + lineLength + @")) + 1 CurrentNum
                                        FROM INVTA
                                        WHERE TA001 = @ErpPrefix";
                                dynamicParameters.Add("ErpPrefix", inventoryTransactions[0].ItErpPrefix);

                                #region //編碼方式
                                string dateFormat = "";
                                switch (encode)
                                {
                                    case "1": //日編
                                        dateFormat = new string('y', yearLength) + "MMdd";
                                        sql += @" AND RTRIM(LTRIM(TA002)) LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                        dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                        ItErpNo = referenceTime.ToString(dateFormat);
                                        break;
                                    case "2": //月編
                                        dateFormat = new string('y', yearLength) + "MM";
                                        sql += @" AND RTRIM(LTRIM(TA002)) LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                        dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                        ItErpNo = referenceTime.ToString(dateFormat);
                                        break;
                                    case "3": //流水號
                                        break;
                                    case "4": //手動編號
                                        break;
                                    default:
                                        throw new SystemException("編碼方式錯誤!");
                                }
                                #endregion

                                currentNum = sqlConnection2.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                                ItErpNo += string.Format("{0:" + new string('0', lineLength) + "}", currentNum);
                                inventoryTransactions[0].ItErpNo = ItErpNo;
                                #endregion
                                #endregion

                                #region //INSERT INVTA 庫存異動單據 單頭
                                foreach (var item in inventoryTransactions)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO INVTA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID
                                            , TA001, TA002, TA003, TA004, TA005, TA006, TA007, TA008, TA009, TA010, TA011, TA012, TA013, TA014, TA015, TA016, TA017
                                            , TA018, TA019, TA021, TA022, TA023)
                                            OUTPUT INSERTED.TA001, INSERTED.TA002
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID
                                            , @TA001, @TA002, @TA003, @TA004, @TA005, @TA006, @TA007, @TA008, @TA009, @TA010, @TA011, @TA012, @TA013, @TA014, @TA015, @TA016, @TA017
                                            , @TA018, @TA019, @TA021, @TA022, @TA023)";

                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          COMPANY = ErpNo,
                                          CREATOR = UserNo,
                                          USR_GROUP,
                                          CREATE_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                          FLAG = 1,
                                          CREATE_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                          CREATE_AP = UserNo + "PC",
                                          CREATE_PRID = "BM",
                                          TA001 = item.ItErpPrefix,
                                          TA002 = item.ItErpNo,
                                          TA003 = item.ErpItDate,
                                          TA004 = item.DepartmentNo,
                                          TA005 = item.Remark,
                                          TA006 = "N",
                                          TA007 = 0,
                                          TA008 = TC004,
                                          TA009 = item.ItErpPrefix.IndexOf("12") != -1 ? "12" : "11",
                                          TA010 = 0,
                                          TA011 = item.TotalQty,
                                          TA012 = Math.Round((double)item.Amount, amountDecimal),
                                          TA013 = "N",
                                          TA014 = item.ErpDocDate,
                                          TA015 = "",
                                          TA016 = 0.000,
                                          TA017 = "N",
                                          TA018,
                                          TA019 = 0,
                                          TA021 = "",
                                          TA022 = "",
                                          TA023 = 0.000000
                                      });
                                    var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                }
                                #endregion

                                #region //INSERT INVTB 庫存異動單據 單身
                                foreach (var item in itDetails)
                                {
                                    #region //取得TB024相關資料
                                    string TB024 = "";
                                    /* INVTB.TB024單身保稅碼預帶方式 :
                                     *  11單別才需要判斷，若12則直接帶空值
                                        如果單頭保稅碼INVTA.TA018='0'(依品號設定)--> 參考INVMB.MB020 = Y或N
                                        如果單頭保稅碼INVTA.TA018='Y' --> 則INVTB.TB024 = 'Y'
                                        如果單頭保稅碼INVTA.TA018='N' --> 則INVTB.TB024 = 'N' */

                                    if (MQ003 == "11")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT MB020
                                                FROM INVMB
                                                WHERE MB001 = @MtlItemNo";
                                        dynamicParameters.Add("MtlItemNo", item.MtlItemNo);

                                        var INVMBResult = sqlConnection2.Query(sql, dynamicParameters);

                                        if (INVMBResult.Count() <= 0) throw new SystemException("品號資料錯誤!!");

                                        foreach (var item2 in INVMBResult)
                                        {
                                            TB024 = item2.MB020;
                                        }
                                    }
                                    #endregion

                                    #region //部門費用領料、轉撥單需檢查庫存量是否足夠
                                    if (item.ItErpPrefix == "1101" || item.ItErpPrefix == "1201")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT MC007
                                                FROM INVMC
                                                WHERE MC001 = @MtlItemNo
                                                AND MC002 = @InventoryNo";
                                        dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                                        dynamicParameters.Add("InventoryNo", item.InventoryNo);

                                        var INVMCResult = sqlConnection2.Query(sql, dynamicParameters);

                                        if (INVMCResult.Count() <= 0) throw new SystemException("品號【" + item.MtlItemNo + "】查無庫別【" + item.InventoryNo + "】相關資料!!");

                                        foreach (var item2 in INVMCResult)
                                        {
                                            if (item.ItQty > Convert.ToDouble(item2.MC007)) throw new SystemException("異動數量已超過庫別【" + item.InventoryNo + "】庫存量【" + item2.MC007 + "】!!");
                                        }
                                    }
                                    #endregion

                                    #region //INSERT INVTB
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO INVTB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID
                                            , TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB014
                                            , TB015, TB016, TB017, TB018, TB019, TB020, TB021, TB022, TB023, TB024, TB025, TB026, TB027)
                                            OUTPUT INSERTED.TB001, INSERTED.TB002, INSERTED.TB003
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID
                                            , @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014
                                            , @TB015, @TB016, @TB017, @TB018, @TB019, @TB020, @TB021, @TB022, @TB023, @TB024, @TB025, @TB026, @TB027)";

                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          COMPANY = ErpNo,
                                          CREATOR = UserNo,
                                          USR_GROUP,
                                          CREATE_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                          FLAG = 1,
                                          CREATE_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                          CREATE_AP = UserNo + "PC",
                                          CREATE_PRID = "BM",
                                          TB001 = inventoryTransactions[0].ItErpPrefix,
                                          TB002 = inventoryTransactions[0].ItErpNo,
                                          TB003 = item.ItSequence,
                                          TB004 = item.MtlItemNo,
                                          TB005 = item.ItMtlItemName,
                                          TB006 = item.ItMtlItemSpec,
                                          TB007 = item.ItQty,
                                          TB008 = item.UomNo,
                                          TB009 = item.InvQty,
                                          TB010 = Math.Round((double)item.UnitCost, unitDecimal),
                                          TB011 = Math.Round((double)item.Amount, amountDecimal),
                                          TB012 = item.InventoryNo,
                                          TB013 = item.ToInventoryNo,
                                          TB014 = "",
                                          TB015 = "",
                                          TB016 = "",
                                          TB017 = item.ItRemark,
                                          TB018 = "N",
                                          TB019 = inventoryTransactions[0].ErpItDate,
                                          TB020 = "",
                                          TB021 = "",
                                          TB022 = 0.000,
                                          TB023 = "",
                                          TB024,
                                          TB025 = 0.000,
                                          TB026 = item.StorageLocation,
                                          TB027 = item.ToStorageLocation
                                      });
                                    var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion
                                }
                                #endregion
                            }
                            #endregion

                            #region //核准庫存異動單據
                            string confirmResult = ConfirmItAPI("Y", inventoryTransactions[0].ItErpPrefix, inventoryTransactions[0].ItErpNo, sqlConnection2, USR_GROUP, UserNo, ErpNo);
                            JObject confirmResultJson = JObject.Parse(confirmResult);
                            if (confirmResultJson["status"].ToString() != "success")
                            {
                                throw new SystemException(confirmResultJson["msg"].ToString());
                            }
                            #endregion

                            #region //將ERP相關資料回寫MES
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.InventoryTransaction SET
                                    ItErpNo = @ItErpNo,
                                    TransferStatus = 'Y',
                                    TransferDate = @TransferDate,
                                    ConfirmStatus = 'Y',
                                    ConfirmUserId = @ConfirmUserId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE ItId = @ItId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  inventoryTransactions[0].ItErpNo,
                                  TransferDate = LastModifiedDate,
                                  ConfirmUserId = CreateBy,
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  ItId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //ReConfirmInventoryTransaction -- 反確認庫存異動單據 -- Ann 2023-12-26
        public string ReConfirmInventoryTransaction(int ItId)
        {
            try
            {
                AddUserOperateLog(ItId);

                int currentNum = 0, yearLength = 0, lineLength = 0, rowsAffected = 0;
                string encode = "", paymentTerm = "", factory = "";
                DateTime referenceTime = default(DateTime);

                string ErpDbName = "";
                string ErpNo = "";

                List<InventoryTransaction> inventoryTransactions = new List<InventoryTransaction>();
                List<ItDetail> itDetails = new List<ItDetail>();

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMinutes(2)))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (BaseHelper.CheckUserAuthority(CreateBy, CurrentCompany, "A", "InventoryTransaction", "update", sqlConnection).Equals("N")) throw new SystemException("人員權限檢核有異常，請嘗試重新登入!");

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //取得庫存異動單據 單頭資料
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.ItId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.CompanyId, a.ItErpPrefix, a.ItErpNo, FORMAT(a.ItDate, 'yyyy-MM-dd') ItDate
                                , FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate, a.DepartmentId, a.Remark, a.TotalQty, a.Amount
                                , a.ConfirmStatus, a.ConfirmUserId, a.TransferStatus, FORMAT(a.TransferDate, 'yyyy-MM-dd') TransferDate
                                , FORMAT(a.ItDate, 'yyyyMMdd') ErpItDate, FORMAT(a.DocDate, 'yyyyMMdd') ErpDocDate
                                , b.DepartmentNo, b.DepartmentName
                                , c.UserNo ConfirmUserNo, c.UserName ConfirmUserName";
                            sqlQuery.mainTables =
                                @"FROM SCM.InventoryTransaction a 
                                LEFT JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                                LEFT JOIN BAS.[User] c ON a.ConfirmUserId = c.UserId";
                            sqlQuery.auxTables = "";
                            string queryCondition = @"AND a.CompanyId = @CompanyId AND a.ItId = @ItId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("ItId", ItId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            inventoryTransactions = BaseHelper.SqlQuery<InventoryTransaction>(sqlConnection, dynamicParameters, sqlQuery);
                            #endregion

                            #region //取得庫存異動單據 單身資料
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.ItDetailId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.ItId, a.ItSequence, a.MtlItemId, a.ItMtlItemName, a.ItMtlItemSpec
                                , a.ItQty, a.UomId, a.InvQty, a.UnitCost, a.Amount, a.InventoryId, a.ToInventoryId
                                , a.StorageLocation, a.ToStorageLocation, a.ItRemark
                                , b.MtlItemNo
                                , c.UomNo, c.UomName
                                , d.InventoryNo, d.InventoryName
                                , e.InventoryNo ToInventoryNo, e.InventoryName InventoryName
                                , f.ItErpPrefix, f.ItErpNo";
                            sqlQuery.mainTables =
                                @"FROM SCM.ItDetail a 
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                INNER JOIN PDM.UnitOfMeasure c ON a.UomId = c.UomId
                                INNER JOIN SCM.Inventory d ON a.InventoryId = d.InventoryId
                                LEFT JOIN SCM.Inventory e ON a.ToInventoryId = e.InventoryId
                                INNER JOIN SCM.InventoryTransaction f ON a.ItId = f.ItId";
                            sqlQuery.auxTables = "";
                            queryCondition = @"AND a.ItId = @ItId";
                            dynamicParameters.Add("ItId", ItId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            itDetails = BaseHelper.SqlQuery<ItDetail>(sqlConnection, dynamicParameters, sqlQuery);
                            #endregion

                            #region //檢查此單據單頭是否已存在ERP，且狀態為已核單
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TA006)) TA006
                                    FROM INVTA 
                                    WHERE TA001 = @ItErpPrefix
                                    AND TA002 = @ItErpNo";
                            dynamicParameters.Add("ItErpPrefix", inventoryTransactions[0].ItErpPrefix);
                            dynamicParameters.Add("ItErpNo", inventoryTransactions[0].ItErpNo);

                            var INVTAResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVTAResult)
                            {
                                if (item.TA006 != "Y") throw new SystemException("此單據目前非確認狀態，無法拋轉或核單!!");
                            }
                            #endregion

                            #region //檢查此單據單身是否已存在ERP，且狀態為已核單
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TB018)) TB018
                                    FROM INVTB 
                                    WHERE TB001 = @ItErpPrefix
                                    AND TB002 = @ItErpNo";
                            dynamicParameters.Add("ItErpPrefix", inventoryTransactions[0].ItErpPrefix);
                            dynamicParameters.Add("ItErpNo", inventoryTransactions[0].ItErpNo);

                            var INVTBResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVTBResult)
                            {
                                if (item.TB018 != "Y") throw new SystemException("此單據單身目前非確認狀態，無法拋轉或核單!!");
                            }
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "InventoryTransaction");
                            dynamicParameters.Add("DetailCode", "data-transfer");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            #region //審核ERP權限
                            string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "COPI06", "CREATE");
                            #endregion

                            #region //查詢廠別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB001)) MB001 FROM CMSMB";
                            var CMSMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMBResult.Count() <= 0) throw new SystemException("找不到廠別!!");
                            if (CMSMBResult.Count() > 1) throw new SystemException("廠別數有多個，請與資訊人員確認!!");

                            string TC004 = "";
                            foreach (var item in CMSMBResult)
                            {
                                TC004 = item.MB001;
                            }
                            #endregion

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(inventoryTransactions[0].DocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + inventoryTransactions[0].DocDate + ")之單據!!");
                            }
                            #endregion

                            #region //反確認庫存異動單據
                            string confirmResult = ConfirmItAPI("N", inventoryTransactions[0].ItErpPrefix, inventoryTransactions[0].ItErpNo, sqlConnection2, USR_GROUP, UserNo, ErpNo);
                            JObject confirmResultJson = JObject.Parse(confirmResult);
                            if (confirmResultJson["status"].ToString() != "success")
                            {
                                throw new SystemException(confirmResultJson["msg"].ToString());
                            }
                            #endregion

                            #region //將ERP相關資料回寫MES
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.InventoryTransaction SET
                                    ConfirmStatus = 'N',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE ItId = @ItId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  inventoryTransactions[0].ItErpNo,
                                  TransferDate = LastModifiedDate,
                                  ConfirmUserId = CreateBy,
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  ItId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //ConfirmItAPI 核准庫存異動單API(共用呼叫)
        public string ConfirmItAPI(string ConfirmType, string TransactionPrefix, string TransactionNo,
            SqlConnection sqlConnection, string USR_GROUP, string UserNo, string ErpNo)
        {
            try
            {
                int UserId = CreateBy;
                int rowsAffected = 0;
                //ConfirmType Y:Confirm, N:ReConfirm

                #region //找出小數位數換算
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT MF003
                            FROM CMSMF
                            WHERE MF001 = (SELECT MA003 FROM CMSMA)";
                var MF003Result = sqlConnection.Query(sql, dynamicParameters);
                if (MF003Result.Count() <= 0) throw new SystemException("找不到幣別小數位設定!!!");
                int MF003 = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MF003);
                #endregion

                #region //取出ERP單據資料
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT a.TA001 AS TransactionPrefix, a.TA002 AS TransactionNo, a.TA003 AS TransactionDate
                        , b.TB003 AS TransactionSeq, b.TB004 AS MtlItemNo, b.TB008 AS Uom, b.TB007 AS TransactionQty
                        , b.TB012 AS FromSubinventory, b.TB013 AS ToSubinventory, b.TB014 AS LotNumber, b.TB017 AS Remark
                        , b.TB022 AS PackageQty, b.TB026 AS FromLocator, b.TB027 AS ToLocator, b.TB021 AS ProjectCode
                        , c.MB022 AS LotControl, b.TB010 AS ItemCost, b.TB011 ItemAmount
                        , CONVERT(varchar(12),DATEADD(d,c.MB023, convert(datetime, a.TA003)), 112) AS AvailDate
                        , CONVERT(varchar(12),DATEADD(d,c.MB024, convert(datetime, a.TA003)), 112) AS ReCheckDate
                        , d.MQ019 AS CheckNotice
                        , d.MQ054 AS OverageCtrl --換制招領
                        , d.MQ055 AS ShortageCtrl --控制缺領
                        , d.MQ010 AS IncOrDec --增/減
                        , d.MQ008 AS TransactionType
                        , d.MQ011 AS CostIndicator
                        , e.MC009 AS LocationFlag --轉出庫別儲位管理
                        , ISNULL( f.MD004/f.MD003,1) AS QtyRate
                        , ISNULL(g.MC009, '') AS ToLocationFlag --轉入庫別儲位管理
                        FROM INVTA a
                        INNER JOIN INVTB b ON a.TA001 = b.TB001 AND a.TA002 = b.TB002
                        INNER JOIN INVMB c ON b.TB004 = c.MB001
                        INNER JOIN CMSMQ d ON d.MQ001 = a.TA001 AND d.MQ003 IN ('11','12')
                        INNER JOIN CMSMC e ON e.MC001 = b.TB012 
                        LEFT JOIN INVMD f ON f.MD001 = b.TB008 
                        LEFT JOIN CMSMC g ON g.MC001 = b.TB013
                        WHERE a.TA001 = @TransactionPrefix
                        AND a.TA002 = @TransactionNo";
                dynamicParameters.Add("TransactionPrefix", TransactionPrefix);
                dynamicParameters.Add("TransactionNo", TransactionNo);

                var TransactionResult = sqlConnection.Query(sql, dynamicParameters);
                if (TransactionResult.Count() <= 0) throw new SystemException("找不到ERP異動單據!");
                string TransactionDate = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TransactionDate;
                #endregion

                #region //比對ERP關帳日期
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                FROM CMSMA";
                var cmsmaResult = sqlConnection.Query(sql, dynamicParameters);
                if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                foreach (var item in cmsmaResult)
                {
                    string eprDate = item.MA013;
                    //string erpYear = eprDate.Substring(0, 4);
                    //string erpMonth = eprDate.Substring(4, 2);
                    //string erpDay = eprDate.Substring(6, 2);
                    //string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                    DateTime erpDateTime;//= Convert.ToDateTime(erpFullDate);
                    DateTime DocDateDateTime;//= DateTime.ParseExact(x.Date, "yyyyMMdd", null).ToString("yyyy-MM-dd");
                    DateTime.TryParseExact(eprDate, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out erpDateTime);
                    DateTime.TryParseExact(TransactionDate, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DocDateDateTime);
                    int compare = DocDateDateTime.CompareTo(erpDateTime);
                    if (compare <= 0) throw new SystemException("ERP已關帳(" + eprDate + ")，無法開立此日期(" + TransactionDate + ")之單據!!");
                }
                #endregion

                #region //更新單頭確認碼=U
                dynamicParameters = new DynamicParameters();
                sql = @"UPDATE INVTA
                            SET TA006 = 'U'
                            WHERE TA001 = @TransactionPrefix
                            AND TA002 = @TransactionNo";
                dynamicParameters.AddDynamicParams(
                new
                {
                    TransactionPrefix,
                    TransactionNo
                });

                rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                dynamicParameters = new DynamicParameters();
                sql = @"UPDATE INVTB
                            SET TB018 = 'U'
                            WHERE TB001 = @TransactionPrefix
                            AND TB002 = @TransactionNo";
                dynamicParameters.AddDynamicParams(
                new
                {
                    TransactionPrefix,
                    TransactionNo
                });

                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                #endregion

                foreach (var item in TransactionResult)
                {
                    //if (item.TE019 != "Y") throw new SystemException("ERP單據目前非未核單狀態!");

                    #region //取出SQL欄位置到變數
                    string TransactionSeq = item.TransactionSeq;
                    string MtlItemNo = item.MtlItemNo;
                    string Uom = item.Uom;
                    string LotControl = item.LotControl;
                    double ItemCost = Convert.ToDouble(item.ItemCost);
                    string AvailDate = item.AvailDate;
                    string ReCheckDate = item.ReCheckDate;
                    double TransactionQty = Convert.ToDouble(item.TransactionQty);
                    double QtyRate = Convert.ToDouble(item.QtyRate);
                    string FromSubinventory = item.FromSubinventory;
                    string ToSubinventory = item.ToSubinventory;
                    string LotNumber = item.LotNumber;
                    string Remark = item.Remark;
                    int PackageQty = Convert.ToInt32(item.PackageQty);
                    string FromLocator = item.FromLocator;
                    string ToLocator = item.ToLocator;
                    string CheckNotice = item.CheckNotice;
                    string OverageCtrl = item.OverageCtrl;
                    string ShortageCtrl = item.ShortageCtrl;
                    int IncOrDec = Convert.ToInt32(item.IncOrDec);
                    string TransactionType = item.TransactionType;
                    string CostIndicator = item.CostIndicator;
                    string ProjectCode = item.ProjectCode;
                    string LocationFlag = item.LocationFlag;
                    string ToLocationFlag = item.ToLocationFlag;
                    double ItemAmount = Convert.ToDouble(item.ItemAmount);
                    #endregion

                    #region //Data Validation
                    erpHelper.CheckInvmcYn(MtlItemNo, FromSubinventory, UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);

                    if (LotControl.Equals("Y"))
                    {
                        if (LotNumber.Equals("") || LotNumber.Equals("******************"))
                        {
                            throw new SystemException("品號需做批號管理,請補入正確批號");
                        }
                        else
                        {
                            if (ConfirmType.Equals("Y"))
                            {
                                if (!erpHelper.CheckLotQty(MtlItemNo, LotNumber, FromSubinventory, TransactionQty * IncOrDec,
                                    PackageQty * IncOrDec, sqlConnection).Equals("Y") && LotControl.Equals("Y") && IncOrDec < 0)
                                {
                                    throw new SystemException("品號【" + MtlItemNo + "】批號庫存數量(或包裝數)不足");
                                }
                            }
                            else
                            {
                                //如果調撥需檢查ToSubinventory庫存足不足夠反確認
                                if (ToSubinventory.Length > 0)
                                {
                                    if (!erpHelper.CheckLotQty(MtlItemNo, LotNumber, ToSubinventory, TransactionQty * IncOrDec,
                                                     PackageQty * IncOrDec, sqlConnection).Equals("Y") && LotControl.Equals("Y") && IncOrDec < 0)
                                    {
                                        throw new SystemException("品號【" + MtlItemNo + "】批號庫存數量(或包裝數)不足");
                                    }
                                }
                            }
                        }
                    }

                    #region //確認轉出庫儲位庫存
                    if (LocationFlag == "Y" && ConfirmType.Equals("Y"))
                    {
                        if (!erpHelper.CheckLocationQty(MtlItemNo, FromSubinventory, FromLocator, TransactionQty, sqlConnection).Equals("Y"))
                        {
                            throw new SystemException("品號【" + MtlItemNo + "】庫別【" + FromSubinventory + "】儲位【" + FromLocator + "】庫存數量(或包裝數)不足");
                        }
                    }
                    #endregion

                    if (ConfirmType.Equals("Y"))
                    {
                        if (!erpHelper.CheckStoQty(MtlItemNo, FromSubinventory, TransactionQty * IncOrDec, PackageQty * IncOrDec, sqlConnection, IncOrDec).Equals("Y") && IncOrDec < 0)
                        {
                            throw new SystemException("品號【" + MtlItemNo + "】庫別庫存數量(或包裝數)不足");
                        }
                    }
                    else
                    {
                        //如果調撥需檢查ToSubinventory庫存足不足夠反確認
                        if (ToSubinventory.Length > 0)
                        {
                            if (!erpHelper.CheckStoQty(MtlItemNo, ToSubinventory, TransactionQty * IncOrDec, PackageQty * IncOrDec, sqlConnection, IncOrDec).Equals("Y") && IncOrDec < 0)
                            {
                                throw new SystemException("品號【" + MtlItemNo + "】庫別庫存數量(或包裝數)不足");
                            }
                        }
                    }

                    #endregion

                    #region //資料庫異動(確認)
                    #region //批號儲位異動明細檔
                    if (LotControl.Equals("Y") || LotControl.Equals("T") || LocationFlag == "Y" || ToLocationFlag == "Y") //批號管理為Y、T 以及 庫別儲位管理為Y
                    {
                        if (ConfirmType.Equals("Y"))
                        {
                            #region //品號批號資料單頭
                            if (LotControl.Equals("Y") || LotControl.Equals("T"))
                            {
                                rowsAffected += erpHelper.InsertInvmef(MtlItemNo, LotNumber, TransactionDate, TransactionPrefix, TransactionNo, AvailDate,
                                                             ReCheckDate, TransactionSeq, FromSubinventory, IncOrDec, TransactionType, TransactionQty,
                                                             "", "",
                                                             UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion

                            #region //儲位批號異動明細資料
                            if (LotControl.Equals("Y") || LotControl.Equals("T") || LocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.InsertInvlf(TransactionPrefix, TransactionNo, TransactionSeq, MtlItemNo, FromSubinventory,
                                                            FromLocator, LotNumber, IncOrDec, TransactionDate, TransactionType,
                                                            TransactionQty, PackageQty, Remark, "", "",
                                                            UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion

                            #region //若轉入庫需儲位管理，也需要建立儲位批號異動明細資料
                            if (ToLocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.InsertInvlf(TransactionPrefix, TransactionNo, TransactionSeq, MtlItemNo, ToSubinventory,
                                                            ToLocator, LotNumber, IncOrDec * -1, TransactionDate, TransactionType,
                                                            TransactionQty, PackageQty, Remark, "", "",
                                                            UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion
                        }
                        else if (ConfirmType == "N")
                        {
                            #region //刪除品號批號資料單頭
                            if (LotControl.Equals("Y") || LotControl.Equals("T"))
                            {
                                rowsAffected += erpHelper.DelInvmef(MtlItemNo, LotNumber, TransactionDate, TransactionPrefix, TransactionNo, TransactionSeq,
                                                      UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion

                            #region //刪除儲位批號異動明細資料
                            if (LotControl.Equals("Y") || LotControl.Equals("T") || LocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.DelInvlf(TransactionPrefix, TransactionNo, TransactionSeq, MtlItemNo, FromSubinventory,
                                                         FromLocator, LotNumber,
                                                         UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion

                            #region //若轉入庫需儲位管理，也需要刪除儲位批號異動明細資料
                            if (ToLocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.DelInvlf(TransactionPrefix, TransactionNo, TransactionSeq, MtlItemNo, ToSubinventory,
                                                         ToLocator, LotNumber,
                                                         UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion
                        }
                        else
                        {
                            throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                        }
                    }
                    #endregion

                    #region //儲位與批號庫存檔
                    if (LotControl == "Y" || LotControl == "T" || LocationFlag == "Y" || ToLocationFlag == "Y")
                    {
                        if (ConfirmType == "Y")
                        {
                            #region //若批號管理或儲位管理任一項有開啟就需要塞入庫存檔
                            if (LotControl == "Y" || LotControl == "T" || LocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.InsertInvmm(MtlItemNo, FromSubinventory, FromLocator, LotNumber, TransactionQty * IncOrDec,
                                                            PackageQty * IncOrDec, TransactionDate,
                                                            UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion

                            #region //若轉入庫有設定儲位管理，也需要塞入庫存檔
                            if (ToLocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.InsertInvmm(MtlItemNo, ToSubinventory, ToLocator, LotNumber, TransactionQty * IncOrDec * -1,
                                                            PackageQty * IncOrDec * -1, TransactionDate,
                                                            UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion
                        }
                        else if (ConfirmType == "N")
                        {
                            #region //若批號管理或儲位管理任一項有開啟就需要塞入庫存檔
                            if (LotControl == "Y" || LotControl == "T" || LocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.InsertInvmm(MtlItemNo, FromSubinventory, FromLocator, LotNumber, TransactionQty * IncOrDec * -1,
                                                            PackageQty * IncOrDec, TransactionDate,
                                                            UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion

                            #region //若轉入庫有設定儲位管理，也需要塞入庫存檔
                            if (ToLocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.InsertInvmm(MtlItemNo, ToSubinventory, ToLocator, LotNumber, TransactionQty * IncOrDec,
                                                            PackageQty * IncOrDec * -1, TransactionDate,
                                                            UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion
                        }
                        else
                        {
                            throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                        }
                    }

                    #endregion

                    #region //專案代碼檔
                    if (!ProjectCode.Equals(""))
                    {
                        if (ConfirmType.Equals("Y"))
                        {
                            rowsAffected += InsertInvld(ProjectCode, MtlItemNo, TransactionDate, IncOrDec, TransactionPrefix,
                                                        TransactionNo, TransactionSeq, FromSubinventory, TransactionType, TransactionQty,
                                                        ItemCost, ItemAmount, Remark, PackageQty,
                                                        UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);

                            if (ToSubinventory.Length > 0)
                            {
                                rowsAffected += InsertInvld(ProjectCode, MtlItemNo, TransactionDate, IncOrDec * -1, TransactionPrefix,
                                                            TransactionNo, TransactionSeq, ToSubinventory, TransactionType, TransactionQty,
                                                            ItemCost, ItemAmount, Remark, PackageQty,
                                                            UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                        }
                        else if (ConfirmType == "N")
                        {
                            //反確認
                            rowsAffected += DelInvld(ProjectCode, MtlItemNo, TransactionDate, IncOrDec, TransactionPrefix,
                                                    TransactionNo, TransactionSeq,
                                                    UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);

                            if (ToSubinventory.Length > 0)
                            {
                                rowsAffected += DelInvld(ProjectCode, MtlItemNo, TransactionDate, IncOrDec * -1, TransactionPrefix,
                                                         TransactionNo, TransactionSeq,
                                                         UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                            }
                        }
                        else
                        {
                            throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                        }
                    }
                    #endregion

                    #region //庫存異動檔
                    if (ConfirmType.Equals("Y"))
                    {
                        rowsAffected += erpHelper.InsertInvla(MtlItemNo, TransactionDate, IncOrDec, TransactionPrefix, TransactionNo,
                                                    TransactionSeq, FromSubinventory, Remark, TransactionQty, ItemCost,
                                                    ItemAmount, TransactionType, CostIndicator, LotNumber, PackageQty,
                                                    FromLocator, "", "", "",
                                                    UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);

                        if (ToSubinventory.Length > 0) //調撥單轉入倉增加庫存
                        {
                            rowsAffected += erpHelper.InsertInvla(MtlItemNo, TransactionDate, IncOrDec * -1, TransactionPrefix, TransactionNo,
                                                        TransactionSeq, ToSubinventory, Remark, TransactionQty, ItemCost,
                                                        ItemAmount, TransactionType, CostIndicator, LotNumber, PackageQty,
                                                        ToLocator, "", "", "",
                                                        UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                        }
                    }
                    else if (ConfirmType == "N")
                    {
                        //反確認
                        rowsAffected += erpHelper.DelInvla(MtlItemNo, TransactionDate, IncOrDec, TransactionPrefix, TransactionNo, TransactionSeq,
                                                 UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                        if (ToSubinventory.Length > 0)
                        {
                            rowsAffected += erpHelper.DelInvla(MtlItemNo, TransactionDate, IncOrDec * -1, TransactionPrefix, TransactionNo, TransactionSeq,
                                                     UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                        }

                    }
                    else
                    {
                        throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                    }
                    #endregion

                    #region //更新品號庫存與金額
                    if (ToSubinventory.Length <= 0) //調撥單不需更新
                    {
                        if (ConfirmType.Equals("Y"))
                        {
                            rowsAffected += erpHelper.UpdateInvmb(MtlItemNo, TransactionQty * IncOrDec * QtyRate, TransactionQty * IncOrDec * QtyRate * ItemCost,
                                                        UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                        }
                        else if (ConfirmType == "N")
                        {
                            //反確認數量金額 * -1
                            rowsAffected += erpHelper.UpdateInvmb(MtlItemNo, TransactionQty * IncOrDec * QtyRate * -1, TransactionQty * IncOrDec * QtyRate * ItemCost * -1,
                                                        UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);
                        }
                        else
                        {
                            throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                        }
                    }
                    #endregion

                    #region //更新品號庫別檔
                    if (ConfirmType.Equals("Y"))
                    {
                        rowsAffected += erpHelper.UpdateInvmc(MtlItemNo, TransactionQty * IncOrDec * QtyRate, TransactionQty * IncOrDec * QtyRate * ItemCost, FromSubinventory, TransactionDate,
                            UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP, TransactionPrefix);

                        if (ToSubinventory.Length > 0) //調撥單需更新轉入庫資訊
                        {
                            rowsAffected += erpHelper.UpdateInvmc(MtlItemNo, TransactionQty * IncOrDec * QtyRate * -1, TransactionQty * IncOrDec * QtyRate * ItemCost * -1, ToSubinventory, TransactionDate,
                                                        UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP, TransactionPrefix);
                        }
                    }
                    else if (ConfirmType == "N")
                    {
                        rowsAffected += erpHelper.UpdateInvmc(MtlItemNo, TransactionQty * IncOrDec * QtyRate * -1, TransactionQty * IncOrDec * QtyRate * ItemCost * -1, FromSubinventory, TransactionDate,
                                                    UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP, TransactionPrefix);

                        if (ToSubinventory.Length > 0) //調撥單需更新轉入庫資訊
                        {
                            rowsAffected += erpHelper.UpdateInvmc(MtlItemNo, TransactionQty * IncOrDec * QtyRate, TransactionQty * IncOrDec * QtyRate * ItemCost, ToSubinventory, TransactionDate,
                                                        UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP, TransactionPrefix);
                        }
                    }
                    else
                    {
                        throw new SystemException("確認/反確認【品號庫別檔】碼錯誤!!");
                    }
                    #endregion
                    #endregion

                    #region //先更新單據-->Y, 確認完成
                    //更新單頭確認碼Y, 確認者
                    dynamicParameters = new DynamicParameters();
                    sql = @"UPDATE INVTB
                                SET TB018 = @ConfirmType
                                WHERE TB001 = @TransactionPrefix
                                AND TB002 = @TransactionNo
                                AND TB003 = @TransactionSeq";
                    dynamicParameters.AddDynamicParams(
                    new
                    {
                        ConfirmType,
                        TransactionPrefix,
                        TransactionNo,
                        TransactionSeq
                    });

                    rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                    #endregion
                }

                //更新單頭確認碼Y, 確認者
                #region
                dynamicParameters = new DynamicParameters();
                sql = @"UPDATE INVTA
                            SET TA006 = @ConfirmType,
                                TA015 = @UserNo
                            WHERE TA001 = @TransactionPrefix
                            AND TA002 = @TransactionNo";
                dynamicParameters.AddDynamicParams(
                new
                {
                    ConfirmType,
                    TransactionPrefix,
                    TransactionNo,
                    UserNo
                });

                rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                #endregion

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateItVoid -- 作廢庫存異動單據 -- Ann 2024-04-10
        public string UpdateItVoid(int ItId = -1)
        {
            try
            {
                AddUserOperateLog(ItId);

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int UserId = CreateBy;
                    string ItErpPrefix = "";
                    string ItErpNo = "";
                    string UserNo = "";
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //判斷庫存異動單資料是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ItErpPrefix, a.ItErpNo, a.ConfirmStatus
                                FROM SCM.InventoryTransaction a 
                                WHERE a.ItId = @ItId";
                        dynamicParameters.Add("ItId", ItId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("庫存異動單資料有誤!");

                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("庫存異動單狀態無法作廢!");
                            ItErpPrefix = item.ItErpPrefix;
                            ItErpNo = item.ItErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "InventoryTransaction");
                        dynamicParameters.Add("DetailCode", "void");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion
                    }

                    #region //進行作廢
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //確認領料單ERP狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(TA006)) TA006
                                FROM INVTA
                                WHERE TA001 = @ItErpPrefix
                                AND TA002 = @ItErpNo";
                        dynamicParameters.Add("ItErpPrefix", ItErpPrefix);
                        dynamicParameters.Add("ItErpNo", ItErpNo);

                        var INVTAResult = sqlConnection.Query(sql, dynamicParameters);

                        if (INVTAResult.Count() <= 0) throw new SystemException("ERP查無此庫存異動單!!");

                        foreach (var item in INVTAResult)
                        {
                            if (item.TA006 != "N") throw new SystemException("此庫存異動單ERP狀態無法作廢!!");
                        }
                        #endregion

                        #region //審核ERP權限
                        string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI03", "VOID");
                        #endregion

                        #region //進行作廢程序
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE INVTA SET
                                TA006 = @TA006
                                WHERE TA001 = @ItErpPrefix
                                AND TA002 = @ItErpNo";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              TA006 = "V",
                              ItErpPrefix,
                              ItErpNo
                          });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE INVTB SET
                                TB018 = @TB018
                                WHERE TB001 = @ItErpPrefix
                                AND TB002 = @ItErpNo";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              TB018 = "V",
                              ItErpPrefix,
                              ItErpNo
                          });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }
                    #endregion

                    #region //若成功則將相關資料寫回MES
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //Update MES.InventoryTransaction
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE SCM.InventoryTransaction SET
                                ConfirmStatus = @ConfirmStatus,
                                ConfirmUserId = @ConfirmUserId,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE ItId = @ItId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ConfirmStatus = "V",
                              ConfirmUserId = UserId,
                              LastModifiedDate,
                              LastModifiedBy = UserId,
                              ItId
                          });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    #endregion
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //ConfirmTempShippingNote -- 核准暫出單 -- Ann 2023-12-29
        public string ConfirmTempShippingNote(int TsnId)
        {
            try
            {
                AddUserOperateLog(TsnId);

                int rowsAffected = 0;

                string ErpDbName = "";
                string ErpNo = "";

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMinutes(2)))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (BaseHelper.CheckUserAuthority(CreateBy, CurrentCompany, "A", "TempShippingNote", "confirm", sqlConnection).Equals("N")) throw new SystemException("人員權限檢核有異常，請嘗試重新登入!");

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //確認暫出單據狀態是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TsnErpPrefix, a.TsnErpNo, a.TransferStatus, a.ConfirmStatus
                                    , FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate
                                    FROM SCM.TempShippingNote a
                                    WHERE a.TsnId = @TsnId
                                    AND a.CompanyId = @CompanyId";
                            dynamicParameters.Add("TsnId", TsnId);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var TempShippingNoteResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TempShippingNoteResult.Count() <= 0) throw new SystemException("暫出單資料錯誤!!");

                            string TsnErpPrefix = "";
                            string TsnErpNo = "";
                            string DocDate = "";
                            foreach (var item in TempShippingNoteResult)
                            {
                                if (item.TransferStatus != "Y") throw new SystemException("單據尚未拋轉，無法進行確認!!");
                                if (item.ConfirmStatus != "N") throw new SystemException("單據狀態異常，無法進行確認!!");

                                TsnErpPrefix = item.TsnErpPrefix;
                                TsnErpNo = item.TsnErpNo;
                                DocDate = item.DocDate.ToString();
                            }
                            #endregion

                            #region //檢查此單據單頭是否已存在ERP，且狀態為未核單
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TF020)) TF020
                                    FROM INVTF 
                                    WHERE TF001 = @TsnErpPrefix
                                    AND TF002 = @TsnErpNo";
                            dynamicParameters.Add("TsnErpPrefix", TsnErpPrefix);
                            dynamicParameters.Add("TsnErpNo", TsnErpNo);

                            var INVTFResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVTFResult)
                            {
                                if (item.TF020 != "N") throw new SystemException("此單據目前非未確認狀態，無法拋轉或核單!!");
                            }
                            #endregion

                            #region //檢查此單據單身是否已存在ERP，且狀態為未核單
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TG022)) TG022
                                    FROM INVTG 
                                    WHERE TG001 = @TsnErpPrefix
                                    AND TG002 = @TsnErpNo";
                            dynamicParameters.Add("TsnErpPrefix", TsnErpPrefix);
                            dynamicParameters.Add("TsnErpNo", TsnErpNo);

                            var INVTGResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVTGResult)
                            {
                                if (item.TG022 != "N") throw new SystemException("此單據單身目前非未確認狀態，無法拋轉或核單!!");
                            }
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "TempShippingNote");
                            dynamicParameters.Add("DetailCode", "confirm");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            #region //審核ERP權限
                            string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "COPB19", "CREATE");
                            #endregion

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(DocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + DocDate + ")之單據!!");
                            }
                            #endregion

                            #region //核准暫出單
                            string confirmResult = ConfirmTempShippingNote("Y", TsnErpPrefix, TsnErpNo, sqlConnection2, USR_GROUP, UserNo, ErpNo);
                            JObject confirmResultJson = JObject.Parse(confirmResult);
                            if (confirmResultJson["status"].ToString() != "success")
                            {
                                throw new SystemException(confirmResultJson["msg"].ToString());
                            }
                            #endregion

                            #region //將ERP相關資料回寫MES

                            #region //UPDATE SCM.TempShippingNote
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.TempShippingNote SET
                                    ConfirmStatus = 'Y',
                                    ConfirmUserId = @ConfirmUserId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TsnId = @TsnId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ConfirmUserId = CreateBy,
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  TsnId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //UPDATE SCM.TsnDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.TsnDetail SET
                                    ConfirmStatus = 'Y',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TsnId = @TsnId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  TsnId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //ReConfirmTempShippingNote -- 反確認暫出單 -- Ann 2023-12-29
        public string ReConfirmTempShippingNote(int TsnId)
        {
            try
            {
                AddUserOperateLog(TsnId);

                int rowsAffected = 0;

                string ErpDbName = "";
                string ErpNo = "";

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, TimeSpan.FromMinutes(2)))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (BaseHelper.CheckUserAuthority(CreateBy, CurrentCompany, "A", "TempShippingNote", "reconfirm", sqlConnection).Equals("N")) throw new SystemException("人員權限檢核有異常，請嘗試重新登入!");

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //確認暫出單據狀態是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TsnErpPrefix, a.TsnErpNo, a.TransferStatus, a.ConfirmStatus
                                    , FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate
                                    FROM SCM.TempShippingNote a
                                    WHERE a.TsnId = @TsnId
                                    AND a.CompanyId = @CompanyId";
                            dynamicParameters.Add("TsnId", TsnId);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var TempShippingNoteResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TempShippingNoteResult.Count() <= 0) throw new SystemException("暫出單資料錯誤!!");

                            string TsnErpPrefix = "";
                            string TsnErpNo = "";
                            string DocDate = "";
                            foreach (var item in TempShippingNoteResult)
                            {
                                if (item.TransferStatus != "Y") throw new SystemException("單據尚未拋轉，無法進行反確認!!");
                                if (item.ConfirmStatus != "Y") throw new SystemException("單據狀態異常，無法進行確認!!");

                                TsnErpPrefix = item.TsnErpPrefix;
                                TsnErpNo = item.TsnErpNo;
                                DocDate = item.DocDate.ToString();
                            }
                            #endregion

                            #region //檢查此單據單頭是否已存在ERP，且狀態為核單狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TF020)) TF020
                                    FROM INVTF 
                                    WHERE TF001 = @TsnErpPrefix
                                    AND TF002 = @TsnErpNo";
                            dynamicParameters.Add("TsnErpPrefix", TsnErpPrefix);
                            dynamicParameters.Add("TsnErpNo", TsnErpNo);

                            var INVTFResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVTFResult)
                            {
                                if (item.TF020 != "Y") throw new SystemException("此單據目前非確認狀態，無法拋轉或核單!!");
                            }
                            #endregion

                            #region //檢查此單據單身是否已存在ERP，且狀態為核單狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(TG022)) TG022
                                    FROM INVTG 
                                    WHERE TG001 = @TsnErpPrefix
                                    AND TG002 = @TsnErpNo";
                            dynamicParameters.Add("TsnErpPrefix", TsnErpPrefix);
                            dynamicParameters.Add("TsnErpNo", TsnErpNo);

                            var INVTGResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in INVTGResult)
                            {
                                if (item.TG022 != "Y") throw new SystemException("此單據單身目前非確認狀態，無法拋轉或核單!!");
                            }
                            #endregion

                            #region //使用者資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                            dynamicParameters.Add("UserId", CurrentUser);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("Status", "A");
                            dynamicParameters.Add("FunctionCode", "TempShippingNote");
                            dynamicParameters.Add("DetailCode", "reconfirm");

                            var resultUser = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            string UserNo = "";
                            foreach (var item in resultUser)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            #region //審核ERP權限
                            string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "COPB19", "CREATE");
                            #endregion

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                    FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(DocDate);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + DocDate + ")之單據!!");
                            }
                            #endregion

                            #region //反確認暫出單
                            string confirmResult = ConfirmTempShippingNote("N", TsnErpPrefix, TsnErpNo, sqlConnection2, USR_GROUP, UserNo, ErpNo);
                            JObject confirmResultJson = JObject.Parse(confirmResult);
                            if (confirmResultJson["status"].ToString() != "success")
                            {
                                throw new SystemException(confirmResultJson["msg"].ToString());
                            }
                            #endregion

                            #region //將ERP相關資料回寫MES

                            #region //UPDATE SCM.TempShippingNote
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.TempShippingNote SET
                                    ConfirmStatus = 'N',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TsnId = @TsnId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ConfirmUserId = CreateBy,
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  TsnId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //UPDATE SCM.TsnDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.TsnDetail SET
                                    ConfirmStatus = 'N',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TsnId = @TsnId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  TsnId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //ConfirmTempShippingNote 暫出單API(共用呼叫)
        public string ConfirmTempShippingNote(string ConfirmType, string TsnErpPrefix, string TsnErpNo,
            SqlConnection sqlConnection, string USR_GROUP, string UserNo, string ErpNo)
        {
            try
            {
                int UserId = CreateBy;
                int rowsAffected = 0;
                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                //ConfirmType Y:Confirm, N:ReConfirm

                #region //找出小數位數換算
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT MF003
                            FROM CMSMF
                            WHERE MF001 = (SELECT MA003 FROM CMSMA)";
                var MF003Result = sqlConnection.Query(sql, dynamicParameters);
                if (MF003Result.Count() <= 0) throw new SystemException("找不到幣別小數位設定!!!");
                int MF003 = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MF003);
                #endregion

                #region //取出ERP單據資料
                dynamicParameters = new DynamicParameters();
                sql = @"select a.TF001 AS TsnErpPrefix
	                           ,a.TF002 AS TsnErpNo
	                           ,a.TF003 AS TransactionDate
	                           ,b.TG003 AS TsnErpSeq
	                           ,c.MB001 AS MtlItemNo
	                           ,b.TG010 AS Uom
	                           ,(b.TG009 + b.TG044) AS TransactionQty
                               ,b.TG007 AS FromSubinventory
	                           ,b.TG008 AS ToSubinventory
	                           ,b.TG017 AS LotNumber
	                           ,b.TG019 AS Remark
                               ,b.TG028 AS PackageQty
	                           ,b.TG035 AS FromLocator
	                           ,b.TG036 AS ToLocator
	                           ,b.TG018 AS ProjectCode
                               ,c.MB022 AS LotControl, ISNULL(c.MB065/NULLIF(c.MB064, 0), 0) AS ItemCost
                               ,CONVERT(varchar(12),DATEADD(d,c.MB023, convert(datetime, a.TF003)), 112) AS AvailDate
                               ,CONVERT(varchar(12),DATEADD(d,c.MB024, convert(datetime, a.TF003)), 112) AS ReCheckDate
                               ,d.MQ019 AS CheckNotice
                               ,d.MQ054 AS OverageCtrl --換制招領
                               ,d.MQ055 AS ShortageCtrl --控制缺領
                               ,d.MQ010 AS IncOrDec --增/減
                               ,d.MQ008 AS TransactionType
                               ,d.MQ011 AS CostIndicator
                               ,e.MC009 AS LocationFlag --轉出庫別儲位管理
                               ,ISNULL(g.MD004/g.MD003,1) AS QtyRate
                               ,ISNULL(f.MC009, '') AS ToLocationFlag --轉入庫別儲位管理
                               ,b.TG014 AS SourcePrefix
                               ,b.TG015 AS SourceNo
                               ,b.TG016 AS SourceSeq
                          from INVTF a
                               INNER JOIN INVTG b ON a.TF001 = b.TG001 AND a.TF002 = b.TG002
	                           INNER JOIN INVMB c ON b.TG004 = c.MB001
	                           INNER JOIN CMSMQ d ON a.TF001 = d.MQ001
	                           INNER JOIN CMSMC e ON b.TG007 = e.MC001
	                           INNER JOIN CMSMC f ON b.TG008 = f.MC001
	                           LEFT JOIN INVMD g ON b.TG004 = g.MD001 AND b.TG010 = g.MD002
                         where a.TF001 = @TsnErpPrefix
                           and a.TF002 = @TsnErpNo";
                dynamicParameters.Add("TsnErpPrefix", TsnErpPrefix);
                dynamicParameters.Add("TsnErpNo", TsnErpNo);

                var TransactionResult = sqlConnection.Query(sql, dynamicParameters);
                if (TransactionResult.Count() <= 0) throw new SystemException("找不到ERP異動單據!");
                string TransactionDate = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TransactionDate;
                #endregion

                #region //比對ERP關帳日期
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                FROM CMSMA";
                var cmsmaResult = sqlConnection.Query(sql, dynamicParameters);
                if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                foreach (var item in cmsmaResult)
                {
                    string eprDate = item.MA013;
                    //string erpYear = eprDate.Substring(0, 4);
                    //string erpMonth = eprDate.Substring(4, 2);
                    //string erpDay = eprDate.Substring(6, 2);
                    //string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                    DateTime erpDateTime;//= Convert.ToDateTime(erpFullDate);
                    DateTime DocDateDateTime;//= DateTime.ParseExact(x.Date, "yyyyMMdd", null).ToString("yyyy-MM-dd");
                    DateTime.TryParseExact(eprDate, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out erpDateTime);
                    DateTime.TryParseExact(TransactionDate, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DocDateDateTime);
                    int compare = DocDateDateTime.CompareTo(erpDateTime);
                    if (compare <= 0) throw new SystemException("ERP已關帳(" + eprDate + ")，無法開立此日期(" + TransactionDate + ")之單據!!");
                }
                #endregion

                #region //更新單頭確認碼=U
                dynamicParameters = new DynamicParameters();
                sql = @"UPDATE INVTF
                            SET TF020 = 'U'
                            WHERE TF001 = @TsnErpPrefix
                            AND TF002 = @TsnErpNo";
                dynamicParameters.AddDynamicParams(
                new
                {
                    TsnErpPrefix,
                    TsnErpNo
                });

                rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                dynamicParameters = new DynamicParameters();
                sql = @"UPDATE INVTG
                            SET TG022 = 'U'
                            WHERE TG001 = @TsnErpPrefix
                            AND TG002 = @TsnErpNo";
                dynamicParameters.AddDynamicParams(
                new
                {
                    TsnErpPrefix,
                    TsnErpNo
                });

                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                #endregion

                foreach (var item in TransactionResult)
                {
                    //if (item.TE019 != "Y") throw new SystemException("ERP單據目前非未核單狀態!");

                    #region //取出SQL欄位置到變數
                    string TsnErpSeq = item.TsnErpSeq;
                    string MtlItemNo = item.MtlItemNo;
                    string Uom = item.Uom;
                    string LotControl = item.LotControl;
                    double ItemCost = Convert.ToDouble(item.ItemCost);
                    string AvailDate = item.AvailDate;
                    string ReCheckDate = item.ReCheckDate;
                    double TransactionQty = Convert.ToDouble(item.TransactionQty);
                    double QtyRate = Convert.ToDouble(item.QtyRate);
                    string FromSubinventory = item.FromSubinventory;
                    string ToSubinventory = item.ToSubinventory;
                    string LotNumber = item.LotNumber;
                    string Remark = item.Remark;
                    int PackageQty = Convert.ToInt32(item.PackageQty);
                    string FromLocator = item.FromLocator;
                    string ToLocator = item.ToLocator;
                    string CheckNotice = item.CheckNotice;
                    string OverageCtrl = item.OverageCtrl;
                    string ShortageCtrl = item.ShortageCtrl;
                    int IncOrDec = Convert.ToInt32(item.IncOrDec);
                    string TransactionType = item.TransactionType;
                    string CostIndicator = item.CostIndicator;
                    string ProjectCode = item.ProjectCode;
                    string LocationFlag = item.LocationFlag;
                    string ToLocationFlag = item.ToLocationFlag;
                    string SourcePrefix = item.SourcePrefix;
                    string SourceNo = item.SourceNo;
                    string SourceSeq = item.SourceSeq;
                    #endregion

                    #region //Data Validation
                    erpHelper.CheckInvmcYn(MtlItemNo, FromSubinventory, UserNo, "INVTA", ErpNo, sqlConnection, USR_GROUP);

                    if (!LotControl.Equals("N"))
                    {
                        if (LotNumber.Equals("") || LotNumber.Equals("******************"))
                        {
                            throw new SystemException("品號需做批號管理,請補入正確批號");
                        }
                        else
                        {
                            if (ConfirmType.Equals("Y"))
                            {
                                if (!erpHelper.CheckLotQty(MtlItemNo, LotNumber, FromSubinventory, TransactionQty * IncOrDec,
                                    PackageQty * IncOrDec, sqlConnection).Equals("Y") && LotControl.Equals("Y") && IncOrDec < 0)
                                {
                                    throw new SystemException("品號【" + MtlItemNo + "】批號庫存數量(或包裝數)不足");
                                }
                            }
                            else
                            {
                                //如果調撥需檢查ToSubinventory庫存足不足夠反確認
                                if (ToSubinventory.Length > 0)
                                {
                                    if (!erpHelper.CheckLotQty(MtlItemNo, LotNumber, ToSubinventory, TransactionQty * IncOrDec,
                                                     PackageQty * IncOrDec, sqlConnection).Equals("Y") && LotControl.Equals("Y") && IncOrDec < 0)
                                    {
                                        throw new SystemException("品號【" + MtlItemNo + "】批號庫存數量(或包裝數)不足");
                                    }
                                }
                            }
                        }
                    }

                    if (ConfirmType.Equals("Y"))
                    {
                        if (!erpHelper.CheckStoQty(MtlItemNo, FromSubinventory, TransactionQty * IncOrDec, PackageQty * IncOrDec, sqlConnection, IncOrDec).Equals("Y") && IncOrDec < 0)
                        {
                            throw new SystemException("品號【" + MtlItemNo + "】庫別庫存數量(或包裝數)不足");
                        }
                    }
                    else
                    {
                        //如果調撥需檢查ToSubinventory庫存足不足夠反確認
                        if (ToSubinventory.Length > 0)
                        {
                            if (!erpHelper.CheckStoQty(MtlItemNo, ToSubinventory, TransactionQty * IncOrDec, PackageQty * IncOrDec, sqlConnection, IncOrDec).Equals("Y") && IncOrDec < 0)
                            {
                                throw new SystemException("品號【" + MtlItemNo + "】庫別庫存數量(或包裝數)不足");
                            }
                        }
                    }

                    #endregion

                    #region //資料庫異動(確認)
                    #region //批號儲位異動明細檔
                    if (LotControl.Equals("Y") || LotControl.Equals("T") || LocationFlag == "Y" || ToLocationFlag == "Y") //批號管理為Y才需處理
                    {
                        //更新品號批號資料單頭單身
                        if (ConfirmType.Equals("Y"))
                        {
                            #region //品號批號資料單頭
                            if (LotControl.Equals("Y") || LotControl.Equals("T"))
                            {
                                rowsAffected += erpHelper.InsertInvmef(MtlItemNo, LotNumber, TransactionDate, TsnErpPrefix, TsnErpNo, AvailDate,
                                                         ReCheckDate, TsnErpSeq, FromSubinventory, IncOrDec, TransactionType, TransactionQty,
                                                         "", "",
                                                         UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                                if (ToSubinventory.Length > 0)
                                {
                                    rowsAffected += erpHelper.InsertInvmef(MtlItemNo, LotNumber, TransactionDate, TsnErpPrefix, TsnErpNo, AvailDate,
                                                         ReCheckDate, TsnErpSeq, ToSubinventory, IncOrDec * -1, TransactionType, TransactionQty,
                                                         "", "",
                                                         UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                                }
                            }
                            #endregion

                            #region //儲位批號異動明細資料
                            if (LotControl.Equals("Y") || LotControl.Equals("T") || LocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.InsertInvlf(TsnErpPrefix, TsnErpNo, TsnErpSeq, MtlItemNo, FromSubinventory,
                                                            FromLocator, LotNumber, IncOrDec, TransactionDate, TransactionType,
                                                            TransactionQty, PackageQty, Remark, "", "",
                                                            UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                                
                                if (ToSubinventory.Length > 0)
                                {
                                    rowsAffected += erpHelper.InsertInvlf(TsnErpPrefix, TsnErpNo, TsnErpSeq, MtlItemNo, ToSubinventory,
                                                            ToLocator, LotNumber, IncOrDec * -1, TransactionDate, TransactionType,
                                                            TransactionQty, PackageQty, Remark, "", "",
                                                            UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                                }
                            }
                            #endregion
                        }
                        else if (ConfirmType == "N")
                        {
                            #region //刪除品號批號資料單頭
                            if (LotControl.Equals("Y") || LotControl.Equals("T"))
                            {
                                rowsAffected += erpHelper.DelInvmef(MtlItemNo, LotNumber, TransactionDate, TsnErpPrefix, TsnErpNo, TsnErpSeq,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion

                            #region //刪除儲位批號異動明細資料
                            if (LotControl.Equals("Y") || LotControl.Equals("T") || LocationFlag == "Y")
                            {
                                rowsAffected += erpHelper.DelInvlf(TsnErpPrefix, TsnErpNo, TsnErpSeq, MtlItemNo, FromSubinventory,
                                                     FromLocator, LotNumber,
                                                     UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                                
                                if (ToSubinventory.Length > 0)
                                {
                                    rowsAffected += erpHelper.DelInvlf(TsnErpPrefix, TsnErpNo, TsnErpSeq, MtlItemNo, ToSubinventory,
                                                         ToLocator, LotNumber,
                                                         UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                                }
                            }
                            #endregion
                        }
                        else
                        {
                            throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                        }
                    }
                    #endregion

                    #region //儲位與批號庫存檔
                    if (LotControl != "N" || LocationFlag == "Y" || ToLocationFlag == "Y")
                    {
                        if (ConfirmType == "Y")
                        {
                            #region //若批號管理或儲位管理任一項有開啟就需要塞入庫存檔
                            rowsAffected += erpHelper.InsertInvmm(MtlItemNo, FromSubinventory, FromLocator, LotNumber, TransactionQty * IncOrDec,
                                                            PackageQty * IncOrDec, TransactionDate,
                                                            UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);

                            if (ToSubinventory.Length > 0)
                            {
                                rowsAffected += erpHelper.InsertInvmm(MtlItemNo, ToSubinventory, ToLocator, LotNumber, TransactionQty * IncOrDec * -1,
                                                        PackageQty * IncOrDec * -1, TransactionDate,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion
                        }
                        else if (ConfirmType == "N")
                        {
                            #region //若批號管理或儲位管理任一項有開啟就需要塞入庫存檔
                            rowsAffected += erpHelper.InsertInvmm(MtlItemNo, FromSubinventory, FromLocator, LotNumber, TransactionQty * IncOrDec * -1,
                                                            PackageQty * IncOrDec, TransactionDate,
                                                            UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                            if (ToSubinventory.Length > 0)
                            {
                                rowsAffected += erpHelper.InsertInvmm(MtlItemNo, ToSubinventory, ToLocator, LotNumber, TransactionQty * IncOrDec,
                                                        PackageQty * IncOrDec * -1, TransactionDate,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                            }
                            #endregion
                        }
                        else
                        {
                            throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                        }
                    }

                    #endregion

                    #region //專案代碼檔
                    if (!ProjectCode.Equals(""))
                    {
                        if (ConfirmType.Equals("Y"))
                        {
                            rowsAffected += erpHelper.InsertInvld(ProjectCode, MtlItemNo, TransactionDate, IncOrDec, TsnErpPrefix,
                                                        TsnErpNo, TsnErpSeq, FromSubinventory, TransactionType, TransactionQty,
                                                        ItemCost, TransactionQty * ItemCost, Remark, PackageQty,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);

                            if (ToSubinventory.Length > 0)
                            {
                                rowsAffected += erpHelper.InsertInvld(ProjectCode, MtlItemNo, TransactionDate, IncOrDec * -1, TsnErpPrefix,
                                                            TsnErpNo, TsnErpSeq, ToSubinventory, TransactionType, TransactionQty,
                                                            ItemCost, TransactionQty * ItemCost, Remark, PackageQty,
                                                            UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                            }
                        }
                        else if (ConfirmType == "N")
                        {
                            //反確認
                            rowsAffected += erpHelper.DelInvld(ProjectCode, MtlItemNo, TransactionDate, IncOrDec, TsnErpPrefix,
                                                    TsnErpNo, TsnErpSeq,
                                                    UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);

                            if (ToSubinventory.Length > 0)
                            {
                                rowsAffected += erpHelper.DelInvld(ProjectCode, MtlItemNo, TransactionDate, IncOrDec * -1, TsnErpPrefix,
                                                         TsnErpNo, TsnErpSeq,
                                                         UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                            }
                        }
                        else
                        {
                            throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                        }
                    }
                    #endregion

                    #region //庫存異動檔
                    if (ConfirmType.Equals("Y"))
                    {
                        rowsAffected += erpHelper.InsertInvla(MtlItemNo, TransactionDate, IncOrDec, TsnErpPrefix, TsnErpNo,
                                                    TsnErpSeq, FromSubinventory, Remark, TransactionQty, ItemCost,
                                                    TransactionQty * ItemCost, TransactionType, CostIndicator, LotNumber, PackageQty,
                                                    FromLocator, "", "", Remark,
                                                    UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);

                        if (ToSubinventory.Length > 0) //調撥單轉入倉增加庫存
                        {
                            rowsAffected += erpHelper.InsertInvla(MtlItemNo, TransactionDate, IncOrDec * -1, TsnErpPrefix, TsnErpNo,
                                                        TsnErpSeq, ToSubinventory, Remark, TransactionQty, ItemCost,
                                                        TransactionQty * ItemCost, TransactionType, CostIndicator, LotNumber, PackageQty,
                                                        ToLocator, "", "", Remark,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                        }
                    }
                    else if (ConfirmType == "N")
                    {
                        //反確認
                        rowsAffected += erpHelper.DelInvla(MtlItemNo, TransactionDate, IncOrDec, TsnErpPrefix, TsnErpNo, TsnErpSeq,
                                                 UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                        if (ToSubinventory.Length > 0)
                        {
                            rowsAffected += erpHelper.DelInvla(MtlItemNo, TransactionDate, IncOrDec * -1, TsnErpPrefix, TsnErpNo, TsnErpSeq,
                                                     UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                        }

                    }
                    else
                    {
                        throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                    }
                    #endregion

                    #region //更新品號庫存與金額
                    if (ToSubinventory.Length <= 0) //調撥單不需更新
                    {
                        if (ConfirmType.Equals("Y"))
                        {
                            rowsAffected += erpHelper.UpdateInvmb(MtlItemNo, TransactionQty * IncOrDec * QtyRate, TransactionQty * IncOrDec * QtyRate * ItemCost,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                        }
                        else if (ConfirmType == "N")
                        {
                            //反確認數量金額 * -1
                            rowsAffected += erpHelper.UpdateInvmb(MtlItemNo, TransactionQty * IncOrDec * QtyRate * -1, TransactionQty * IncOrDec * QtyRate * ItemCost * -1,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP);
                        }
                        else
                        {
                            throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                        }
                    }
                    #endregion

                    #region //更新品號庫別檔
                    if (ConfirmType.Equals("Y"))
                    {
                        rowsAffected += erpHelper.UpdateInvmc(MtlItemNo, TransactionQty * IncOrDec * QtyRate, TransactionQty * IncOrDec * QtyRate * ItemCost, FromSubinventory, TransactionDate,
                            UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP, TsnErpPrefix);

                        if (ToSubinventory.Length > 0) //調撥單需更新轉入庫資訊
                        {
                            rowsAffected += erpHelper.UpdateInvmc(MtlItemNo, TransactionQty * IncOrDec * QtyRate * -1, TransactionQty * IncOrDec * QtyRate * ItemCost * -1, ToSubinventory, TransactionDate,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP, TsnErpPrefix);
                        }
                    }
                    else if (ConfirmType == "N")
                    {
                        rowsAffected += erpHelper.UpdateInvmc(MtlItemNo, TransactionQty * IncOrDec * QtyRate * -1, TransactionQty * IncOrDec * QtyRate * ItemCost * -1, FromSubinventory, TransactionDate,
                                                    UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP, TsnErpPrefix);

                        if (ToSubinventory.Length > 0) //調撥單需更新轉入庫資訊
                        {
                            rowsAffected += erpHelper.UpdateInvmc(MtlItemNo, TransactionQty * IncOrDec * QtyRate, TransactionQty * IncOrDec * QtyRate * ItemCost, ToSubinventory, TransactionDate,
                                                        UserNo, "INVTF", ErpNo, sqlConnection, USR_GROUP, TsnErpPrefix);
                        }
                    }
                    else
                    {
                        throw new SystemException("確認/反確認【" + ConfirmType + "】碼錯誤!!");
                    }
                    #endregion
                    #endregion

                    #region //先更新單據-->Y, 確認完成
                    //更新單頭確認碼Y, 確認者
                    dynamicParameters = new DynamicParameters();
                    sql = @"UPDATE INVTG
                                SET 
                                MODIFIER =@MODIFIER,
                                MODI_DATE= @MODI_DATE,
                                MODI_TIME= @MODI_TIME,
                                MODI_AP= @MODI_AP,
                                MODI_PRID= @MODI_PRID,
                                FLAG= FLAG + 1,
                                TG022 = @ConfirmType
                                WHERE TG001 = @TsnErpPrefix
                                AND TG002 = @TsnErpNo
                                AND TG003 = @TsnErpSeq";
                    dynamicParameters.AddDynamicParams(
                    new
                    {
                        MODIFIER = UserNo,
                        MODI_DATE = dateNow,
                        MODI_TIME = timeNow,
                        MODI_AP = BaseHelper.ClientComputer(),
                        MODI_PRID = "BM",
                        ConfirmType,
                        TsnErpPrefix,
                        TsnErpNo,
                        TsnErpSeq
                    });

                    rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                    #endregion
                }

                //更新單頭確認碼Y, 確認者
                #region
                dynamicParameters = new DynamicParameters();
                sql = @"UPDATE INVTF
                            SET 
                                MODIFIER =@MODIFIER,
                                MODI_DATE= @MODI_DATE,
                                MODI_TIME= @MODI_TIME,
                                MODI_AP= @MODI_AP,
                                MODI_PRID= @MODI_PRID,
                                FLAG= FLAG + 1,
                                TF020 = @ConfirmType,
                                TF025 = @UserNo
                            WHERE TF001 = @TsnErpPrefix
                            AND TF002 = @TsnErpNo";
                dynamicParameters.AddDynamicParams(
                new
                {
                    MODIFIER = UserNo,
                    MODI_DATE = dateNow,
                    MODI_TIME = timeNow,
                    MODI_AP = BaseHelper.ClientComputer(),
                    MODI_PRID = "BM",
                    ConfirmType,
                    TsnErpPrefix,
                    TsnErpNo,
                    UserNo
                });

                rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                #endregion

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoWarehouseEnry -- 入庫單單頭資料更新 -- Ted 2022.09.06
        public string UpdateMoWarehouseEnry(int MweId, string Remark, string DocDate, string InvoiceDate, string InvoiceNo, string DepartmentNo, string DeductType
            , string SupplierSo, int RowCnt, string PaymentTerm, string AutoMaterialBilling, string SupplierPicking)
        {
            try
            {
                if (MweId <= 0) throw new SystemException("【單頭ID】不能為空!");
                if (DocDate.Length <= 0) throw new SystemException("【單據日】不能為空!");
                if (InvoiceDate.Length <= 0) InvoiceDate = null;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();


                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //判斷入庫單資料是否正確
                        sql = @"SELECT TOP 1 MweId, ReConfirmStatus, ConfirmStatus,TransferStatus
                                FROM MES.MoWarehouseEnry
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單單頭資料錯誤!");
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus == "Y") throw new SystemException("入庫單已經確認無法修改!");
                            if (item.ConfirmStatus == "V") throw new SystemException("該入庫單據已經作廢,不能新增單身");
                            if (item.ConfirmStatus == "Y") throw new SystemException("該入庫單據已經核單,不能新增單身");
                            if (item.TransferStatus == "Y" && item.ReConfirmStatus == "N") throw new SystemException("該入庫單據已經拋轉ERP,不能新增單身");
                        }
                        #endregion

                        #region //扣抵區分是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TypeNo FROM BAS.[Type] 
                                WHERE 1=1
                                AND TypeSchema = 'OspReceipt.DeductType'
                                AND TypeNo=@DeductType";
                        dynamicParameters.Add("DeductType", DeductType);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【扣抵區分】資料錯誤，請重新輸入!");
                        #endregion

                        #region //撈取目前最新驗收日帶入托外進貨日
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT FORMAT(MAX(a.AcceptanceDate), 'yyyy-MM-dd') MaxAcceptanceDate
                                FROM MES.MweDetail a
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        string MaxAcceptanceDate = "";
                        foreach (var item in result)
                        {
                            MaxAcceptanceDate = item.MaxAcceptanceDate;
                        }
                        if (MaxAcceptanceDate != null)
                        {
                            DateTime dateA = DateTime.Parse(DocDate);
                            DateTime dateB = DateTime.Parse(MaxAcceptanceDate);
                            if (dateA > dateB)
                            {
                                throw new SystemException("資料異常:單身驗收日不可以小於單據日!!");
                            }
                        }
                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        if (DepartmentNo.Length > 0)
                        {
                            #region //費用部門是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(ME001)) DepartmentNo
                                    FROM CMSME 
                                    WHERE 1=1
                                    AND ME001=@DepartmentNo";
                            dynamicParameters.Add("DepartmentNo", DepartmentNo);
                            var result1 = sqlConnection.Query(sql, dynamicParameters);
                            if (result1.Count() <= 0) throw new SystemException("【費用部門】資料錯誤，請重新輸入!");
                            #endregion
                        }

                        if (PaymentTerm.Length > 0)
                        {
                            #region //付款條件是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(NA002)) PaymentTermNo
                                    FROM CMSNA 
                                    WHERE 1=1
                                    AND NA002=@PaymentTerm";
                            dynamicParameters.Add("PaymentTerm", PaymentTerm);
                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("【付款條件】資料錯誤，請重新輸入!");
                            #endregion
                        }


                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoWarehouseEnry SET
                                DocDate = @DocDate,
                                Remark = @Remark,
                                InvoiceDate = @InvoiceDate,
                                InvoiceNo = @InvoiceNo,
                                DepartmentNo = @DepartmentNo,
                                DeductType = @DeductType,
                                SupplierSo = @SupplierSo,
                                RowCnt = @RowCnt,
                                PaymentTerm = @PaymentTerm,
                                AutoMaterialBilling = @AutoMaterialBilling,
                                SupplierPicking = @SupplierPicking,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                DocDate,
                                Remark,
                                InvoiceDate,
                                InvoiceNo,
                                DepartmentNo,
                                DeductType,
                                SupplierSo,
                                RowCnt,
                                PaymentTerm,
                                AutoMaterialBilling,
                                SupplierPicking,
                                LastModifiedDate,
                                LastModifiedBy,
                                MweId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        //#region //找單身入庫條碼
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT a.*, b.MweDetailId
                        //        FROM MES.MweBarcode a
                        //        INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                        //        INNER JOIN MES.MoWarehouseEnry c ON b.MweId = c.MweId
                        //        WHERE c.MweId = @MweId";
                        //dynamicParameters.Add("MweId", MweId);
                        //var mweBarcoderesult = sqlConnection.Query(sql, dynamicParameters);
                        //if (mweBarcoderesult.Count() > 0) {
                        //    foreach (var item in mweBarcoderesult) {
                        //        dynamicParameters = new DynamicParameters();
                        //        sql = @"UPDATE MES.MweBarcode SET
                        //        AmortizeTtype = @AmortizeTtype,
                        //        LastModifiedDate = @LastModifiedDate,
                        //        LastModifiedBy = @LastModifiedBy
                        //        WHERE MweDetailId = @MweDetailId";
                        //        dynamicParameters.AddDynamicParams(
                        //            new
                        //            {

                        //                AmortizeTtype = IsAmortize,
                        //                LastModifiedDate,
                        //                LastModifiedBy,
                        //                MweDetailId = item.MweDetailId
                        //            });

                        //        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //    }
                        //}
                        //#endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMweDetail -- 更新MES入庫單單身資料 -- Ted 2022.09.07
        public string UpdateMweDetail(int MweDetailId, int MweId, int InventoryId, string AcceptanceDate
            , int ReceiptQty, int AcceptQty, int AvailableQty, int ScriptQty, int ReturnQty
            , double OrigUnitPrice, double OrigAmount, double OrigDiscountAmt, double ReceiptExpense, string DiscountDescription, double OrigPreTaxAmt, double OrigTaxAmt
            , double PreTaxAmt, double TaxAmt, string Remark, string ProjectCode, string ProcessCode, string QcStatus, string Overdue, string ReserveTaxCode, string PaymentHold
            , string MoIdType, string BarcodeNoY, string BarcodeNoN, string ScrapRegister, string LotNumber
            , string BarcodeListAmortizeTtypeY, int AmortizeNewCount, string IsAmortize, string QaResult, int QcRecordId, string OverMsg
            )
        {
            try
            {
                if (MweDetailId <= 0) throw new SystemException("【入庫單單身ID】有問題!");
                if (MweId <= 0) throw new SystemException("【入庫單單頭ID】有問題!");
                if (InventoryId <= 0) throw new SystemException("【倉庫】不能為空!");
                if (ReceiptQty <= 0) throw new SystemException("【進貨數量】不能為空 或 0 或 負數!");
                if (ReceiptQty != (AcceptQty + ScriptQty + ReturnQty)) throw new SystemException("【進貨" +
                    "數量】!= 【驗收數量】+【報廢數量】+【驗退數量】,資料異常請重新確認!");
                if (AcceptQty < 0) throw new SystemException("【驗收數量】不能為空或負數!");
                if (AvailableQty < 0) throw new SystemException("【計價數量】不能為空或負數!");
                if (ScriptQty < 0) throw new SystemException("【報廢數量】不能為空或負數!");
                if (ReturnQty < 0) throw new SystemException("【驗退數量】不能為空或負數!");
                if (AcceptanceDate.Length <= 0) throw new SystemException("【驗收日期】不能為空!");


                string WoErpPrefix = "";
                string WoErpNo = "";
                string MweErpPrefix = "";

                string ReceiptDate = "";
                int rowsAffected = 0;
                int MoId = 0;
                int MtlItemId = 0;
                int ModeId = 0;
                double TaxRate = 0;
                double Exchange = 0;
                int? nullData = null;
                int QuantityExceeds = 0;
                int PlanQty = 0;
                int ReceiptQtyAllMes = 0;
                string NgToDisassembly = "";
                string NgToBarcode = "";
                string Source = "";
                string MeasureType = "";

                string ErpDbName = "";
                string ErpNo = "";

                List<string> caseNumList = new List<string>();
                var returnData = new Dictionary<string, object>();

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        List<string> BarcodeIdListY = new List<string>();
                        List<int> BarcodeIdListN = new List<int>();
                        List<int> BarcodeIdListNew = new List<int>();
                        List<int> ScriptBarcodeIdList = new List<int>();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷入庫單單頭資料是否正確 + 獲取營業稅+單頭進貨日期
                        sql = @"SELECT TOP 1 TaxRate ,FORMAT(DocDate, 'yyyy-MM-dd') DocDate ,FORMAT(ReceiptDate, 'yyyy-MM-dd') ReceiptDate, Exchange, MweErpPrefix, TransferStatus, ReConfirmStatus,ConfirmStatus
                                FROM MES.MoWarehouseEnry
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單單頭資料錯誤!");
                        string ReConfirmStatus = "";
                        string DocDate = "";
                        foreach (var item in result)
                        {
                            TaxRate = item.TaxRate;
                            ReceiptDate = item.ReceiptDate;
                            Exchange = item.Exchange;
                            MweErpPrefix = item.MweErpPrefix;
                            ReConfirmStatus = item.ReConfirmStatus;
                            DocDate = item.DocDate;
                            if (item.ConfirmStatus == "V") throw new SystemException("該入庫單據已經作廢,不能新增單身");
                            if (item.ConfirmStatus == "Y") throw new SystemException("該入庫單據已經核單,不能新增單身");
                            if (item.TransferStatus == "Y" && item.ReConfirmStatus == "N") throw new SystemException("該入庫單據已經拋轉ERP,不能新增單身");
                        }

                        if (ReConfirmStatus == "N") throw new SystemException("入庫單已經拋轉不可以更動,如欲更動請先點擊重新編輯按鈕");
                        #endregion

                        #region //判斷入庫單單身資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MweId,a.ConfirmStatus,a.LabelStatus,a.MoId,a.MtlItemId,a.UomId,a.AcceptQty,a.MtlItemId,
                                c.WoErpPrefix,c.WoErpNo
                                FROM MES.MweDetail a
                                INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                                INNER JOIN MES.WipOrder c on b.WoId = c.WoId
                                WHERE MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單資料錯誤!");
                        string ConfirmStatus = "";
                        int AcceptQtyBase = -1;
                        string LabelStatus = "";
                        foreach (var item in result)
                        {
                            ConfirmStatus = item.ConfirmStatus;
                            AcceptQtyBase = Convert.ToInt32(item.AcceptQty);
                            LabelStatus = item.LabelStatus;
                            MoId = item.MoId;
                            MtlItemId = item.MtlItemId;
                            WoErpPrefix = item.WoErpPrefix;
                            WoErpNo = item.WoErpNo;
                        }

                        if (ConfirmStatus == "Y") throw new SystemException("入庫單已經確認無法修改!");
                        if (LabelStatus == "A")
                        {
                            throw new SystemException("該入庫單已經印製出標籤，無法更改!");
                            //if (AcceptQtyBase != AcceptQty) throw new SystemException("該入庫單已經印製出標籤，無法更改!");
                        }
                        #endregion

                        #region //撈出所有5902託外入庫單據判斷當前可入庫數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT c.PlanQty - a.OspQty + ISNULL(x.SumAcceptQty,0) CurrentQty
                                ,'託外生產單:'+a1.OspNo + '-製令:' + c.WoErpPrefix + '-' + c.WoErpNo + '-製程' + a.ProcessCodeName + ' (尚有 ' +
                                CAST(a.OspQty - ISNULL(x.SumAcceptQty, 0) AS VARCHAR) + ' PCS,未做託外入庫單)' AS NotYetRemark
                                FROM MES.OspDetail a
                                INNER JOIN MES.OutsourcingProduction a1 on a.OspId = a1.OspId
                                INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                                INNER JOIN MES.WipOrder c on b.WoId = c.WoId
                                OUTER APPLY(
                                    SELECT SUM(x1.AcceptQty) SumAcceptQty 
                                    FROM MES.OspReceiptDetail x1
                                    WHERE x1.OspDetailId = a.OspDetailId
                                    AND x1.TransferStatus = 'Y'
                                ) x
                                WHERE 1=1
                                AND a.MoId = @MoId
                                AND (x.SumAcceptQty IS NULL OR a.OspQty != x.SumAcceptQty)
                                ";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        int CurrentQty = -1;
                        string NotYetRemark = "";
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                if (CurrentQty == -1)//第一次放入當前可入庫數量
                                {
                                    CurrentQty = item.CurrentQty;
                                }
                                else
                                {
                                    if (CurrentQty < item.CurrentQty) //取當前可入庫數量最小值
                                    {
                                        CurrentQty = item.CurrentQty;
                                    }
                                }
                                NotYetRemark += "<br>" + item.NotYetRemark;
                            }
                            if (ReceiptQty > CurrentQty)
                            {
                                NotYetRemark = $"當前只能入庫{CurrentQty}PCS<bt>" + NotYetRemark;
                                throw new SystemException(NotYetRemark);
                            }
                        }
                        #endregion

                        #region //判斷該入庫單的條碼是否有被移轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MoId,c.MoId FROM MES.MweBarcode a
                                INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                                WHERE b.MoId != c.MoId
                                AND b.MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        var resultTransfer = sqlConnection.Query(sql, dynamicParameters);
                        if (resultTransfer.Count() > 0)
                        {
                            throw new SystemException("入庫單的條碼已經有被移轉不可以修改");
                        }
                        #endregion

                        #region //判斷製令是否為全委外
                        string AllOutsourcing = "N";
                        if (MoIdType == "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                AllOutsourcing = "Y";
                            }
                        }
                        else if (MoIdType == "N")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcessTransaction a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                AllOutsourcing = "Y";
                            }
                        }
                        #endregion

                        #region //判斷製令資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MoId,a.Status,b.ScrapRegister,a.Quantity,a1.Source,a1.NgToBarcode,a.ModeId
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.MoSetting a1 on a.MoId = a1.MoId
                                INNER JOIN MES.ProdMode b on a.ModeId = b.ModeId
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令資料錯誤或不存在!");
                        string MoStatus = "";
                        string ScrapRegisterBase = "";
                        int MoQuantityBase = -1;
                        foreach (var item in result)
                        {
                            MoStatus = item.Status;
                            ScrapRegisterBase = item.ScrapRegister;
                            MoQuantityBase = Convert.ToInt32(item.Quantity);
                            NgToBarcode = item.NgToBarcode;
                            Source = item.Source;
                            ModeId = item.ModeId;
                        }

                        if (MweErpPrefix != "5903" && AllOutsourcing == "N")
                        {
                            if (MoStatus != "A" && MoStatus != "F") throw new SystemException("該製令未處與開工中狀態，不能做入庫");
                        }
                        if (ScrapRegisterBase != ScrapRegister) throw new SystemException("是否要入報廢倉判定,與資料庫資料不相符,請重新確認");
                        #endregion

                        #region //判斷製令是否有條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeCtrl,a.OutputBarcodeFlag, a.NgToDisassembly, a.NgToBarcode
                                FROM MES.MoSetting a
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        string BarcodeCtrl = "";
                        string OutputBarcodeFlag = "";
                        foreach (var item in result)
                        {
                            BarcodeCtrl = item.BarcodeCtrl;
                            OutputBarcodeFlag = item.OutputBarcodeFlag;
                            NgToDisassembly = item.NgToDisassembly;
                            NgToBarcode = item.NgToBarcode;
                        }

                        if (BarcodeCtrl == "Y")
                        {
                            if (BarcodeNoY == "") throw new SystemException("【入庫單】－條碼模式需選取條碼才能入庫，請重新確認");
                        }
                        else if (BarcodeCtrl == "N")
                        {
                            if (OutputBarcodeFlag == "Y")
                            {
                                if (BarcodeNoY == "") throw new SystemException("【入庫單】－數量入庫且有設定產新條碼的模式需選取條碼才能入庫，請重新確認");
                            }
                            else if (OutputBarcodeFlag == "N")
                            {
                                if (BarcodeNoY != "") throw new SystemException("【入庫單】－資料異常:數量入庫且有設定產新條碼的模式不需選取條碼");
                            }
                        }
                        else
                        {
                            throw new SystemException("【入庫單】－是否有產品條碼的狀態錯誤，請重新確認");
                        }
                        #endregion

                        #region //判斷庫別資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 InventoryId
                                FROM SCM.Inventory
                                WHERE InventoryId = @InventoryId";
                        dynamicParameters.Add("InventoryId", InventoryId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("庫別資料錯誤或不存在!");
                        #endregion

                        #region //判斷品號資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemId, LotManagement, MeasureType
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId
                                AND TransferStatus = 'Y'";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號資料錯誤或不存在!");
                        foreach (var item in result)
                        {
                            if (item.LotManagement != "N")
                            {
                                if (LotNumber == "") throw new SystemException("入庫品號需要做批號管理,批號欄位不可為空");
                            }
                            else
                            {
                                if (LotNumber != "") throw new SystemException("入庫品號不需要做批號管理,批號欄位不可填寫");
                            }
                            MeasureType = item.MeasureType;
                        }
                        #endregion

                        #region //撈取ERP工單資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.WoId,a.PlanQty
                                FROM MES.WipOrder a
                                INNER JOIN MES.ManufactureOrder b on a.WoId = b.WoId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        result = sqlConnection.Query(sql, dynamicParameters);

                        if (result.Count() <= 0) throw new SystemException("製令資料錯誤或不存在!");
                        int WoId = -1;
                        foreach (var item in result)
                        {
                            PlanQty = Convert.ToInt32(item.PlanQty);
                            WoId = Convert.ToInt32(item.WoId);
                        }
                        #endregion

                        #region //撈出該MES製令下領料單 領料套數
                        // int? MrQuantity = 0;
                        // dynamicParameters = new DynamicParameters();
                        // sql = @" SELECT SUM(a.Quantity) MrQuantity
                        //                      FROM MES.MrWipOrder a
                        //                      WHERE a.MoId = @MoId";
                        // dynamicParameters.Add("MoId", MoId);

                        // result = sqlConnection.Query(sql, dynamicParameters);
                        // if (result.Count() > 0)
                        // {
                        //     MrQuantity = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MrQuantity);
                        // }
                        // if (MrQuantity == null) throw new SystemException("該製令未領料");
                        #endregion

                        #region //數量入庫或是條碼入庫走向區分
                        int ScriptQtyTrue = 0;
                        int AcceptQtyTrue = 0;
                        if (MoIdType == "Y") //條碼入庫
                        {

                            if (ScrapRegister == "Y") //進報廢倉
                            {
                                #region //勾選-入庫條碼
                                if (BarcodeNoY != "")
                                {
                                    List<int> ArrBarcodeNoY = new List<int>();
                                    ArrBarcodeNoY = BarcodeNoY.Split(',').Select(int.Parse).ToList();
                                    string AberrantBarcodeList = "";
                                    int AberrantBarcodeNum = 0;
                                    foreach (var item in ArrBarcodeNoY)
                                    {
                                        sql = @"SELECT a.BarcodeId,a.BarcodeNo,a.CurrentProdStatus,a.BarcodeQty,a.BarcodeStatus
                                                FROM MES.Barcode a
                                                WHERE 1=1";
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND a.BarcodeId = @BarcodeId", item);
                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() <= 0) throw new SystemException("【入庫單】-條碼資料不存在!");


                                        foreach (var item1 in result)
                                        {
                                            #region //判斷條碼屬性過站歷程中是否有維護完整
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT x.MoProcessId
                                                    ,c.ItemNo,c.ItemValue
                                                    ,a.BarcodeId,a.BarcodeNo,a.CurrentProdStatus
                                                    ,z.Num
                                                    FROM MES.Barcode a
                                                    OUTER APPLY(
                                                          select x1.MoProcessId FROM MES.BarcodeProcess x1 where x1.BarcodeId = a.BarcodeId AND x1.MoId = a.MoId
                                                        ) x
                                                    INNER JOIN MES.MoProcessItem b on x.MoProcessId = b.MoProcessId 
                                                    LEFT JOIN MES.BarcodeAttribute c on b.ItemNo = c.ItemNo and a.BarcodeId = c.BarcodeId
                                                    OUTER APPLY(
                                                          select COUNT(z2.MoProcessItemId) Num FROM MES.BarcodeProcess z1 
                                                          INNER JOIN MES.MoProcessItem z2 on z1.MoProcessId = z2.MoProcessId
                                                          where z1.BarcodeId = a.BarcodeId  AND z1.MoId = a.MoId
                                                        ) z
                                                    WHERE a.BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                            var resultCheckAttribute = sqlConnection.Query(sql, dynamicParameters);
                                            foreach (var item2 in resultCheckAttribute)
                                            {
                                                if (item2.CurrentProdStatus != "S")
                                                {
                                                    if (item2.ItemNo != null)
                                                    {
                                                        if (item2.Num != resultCheckAttribute.Count())
                                                        {
                                                            if (AberrantBarcodeNum == 0)
                                                            {
                                                                AberrantBarcodeList += item1.BarcodeNo;
                                                            }
                                                            else
                                                            {
                                                                AberrantBarcodeList += "," + item1.BarcodeNo;
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        AberrantBarcodeList += "," + item1.BarcodeNo;
                                                    }
                                                }
                                            }
                                            #endregion

                                            #region //確認此條碼是否有刻字置換資料未確認(鍍鎳站除外)
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 a.OriBarcodeAttrId, a.NewBarcodeAttrId
                                            , b.[Status]
                                            , (
                                                SELECT TOP 1 1
                                                FROM MES.BarcodeProcess x 
                                                WHERE x.BarcodeId = @BarcodeId
                                                AND x.FinishDate IS NULL
                                            ) CheckBarcodeProcess
                                            FROM MES.BarcodeProcessAttributeLog a 
                                            LEFT JOIN MES.BpalDetail b ON a.ProcessAttrLogId = b.ProcessAttrLogId
                                            WHERE a.NewBarcodeId = @BarcodeId
                                            ORDER BY a.CreateDate DESC";
                                            dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                            var BarcodeProcessAtrLogResult = sqlConnection.Query(sql, dynamicParameters);

                                            foreach (var item2 in BarcodeProcessAtrLogResult)
                                            {
                                                if (item2.OriBarcodeAttrId != item2.NewBarcodeAttrId)
                                                {
                                                    if (item2.Status != "Y" && item2.CheckBarcodeProcess == null)
                                                    {
                                                        throw new SystemException("條碼【" + item1.BarcodeNo + "】已被置換，請實際執行重新刻字的動作後再進行後續過站!!");
                                                    }
                                                }
                                            }
                                            #endregion

                                            #region //判斷條碼是否結束流程
                                            if (item1.BarcodeStatus != "7")
                                            {
                                                if (item1.BarcodeStatus != "8")
                                                {
                                                    if (item1.BarcodeStatus != "1")
                                                    {
                                                        if (item1.BarcodeStatus == "0")
                                                        {
                                                            #region //判斷完工入庫的條碼必要過站是否都是PASS
                                                            dynamicParameters = new DynamicParameters();
                                                            sql = @"SELECT d.BarcodeNo,d.CurrentProdStatus, c.MoProcessId,c.ProcessAlias,e.ProdStatus
                                                            FROM MES.WipOrder a
                                                            LEFT JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
	                                                        LEFT JOIN MES.MoProcess c ON b.MoId = c.MoId
	                                                        LEFT JOIN MES.Barcode d ON b.MoId = d.MoId
	                                                        LEFT JOIN MES.BarcodeProcess e ON d.BarcodeId = e.BarcodeId AND c.MoProcessId = e.MoProcessId
                                                            OUTER APPLY(
                                                                SELECT y3.PrintStatus
                                                                FROM MES.BarcodeTransfer y1
                                                                INNER JOIN MES.Barcode y2 on y2.BarcodeId =  y1.ToBarcodeId
                                                                INNER JOIN MES.BarcodePrint y3 on y3.BarcodeNo =  d.BarcodeNo
                                                                WHERE y1.ToBarcodeId = d.BarcodeId
                                                            ) y
                                                            WHERE b.MoId = @MoId
                                                            AND d.BarcodeId = @BarcodeId
                                                            AND d.CurrentProdStatus in ('P','M','R')
                                                            AND c.NecessityStatus = 'Y'
                                                            AND e.ProdStatus is null";
                                                            dynamicParameters.Add("MoId", MoId);
                                                            dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                                            var barcodePassAll = sqlConnection.Query(sql, dynamicParameters);
                                                            if (barcodePassAll.Count() > 0)
                                                            {
                                                                string MoProcessNotPass = "";
                                                                string BarcodeNo = "";
                                                                int num = 0;
                                                                foreach (var item2 in barcodePassAll)
                                                                {
                                                                    if (item1.PrintStatus != "F")
                                                                    {
                                                                        if (num > 0)
                                                                        {
                                                                            MoProcessNotPass += ",【" + item2.ProcessAlias + "】";

                                                                        }
                                                                        else
                                                                        {
                                                                            MoProcessNotPass += "【" + item2.ProcessAlias + "】";
                                                                            BarcodeNo += item2.BarcodeNo;
                                                                        }
                                                                        num++;
                                                                        throw new SystemException("【條碼:" + BarcodeNo + "】過站異常，" + MoProcessNotPass + "為必要站,請完成過站程序!!!");
                                                                    }
                                                                }
                                                            }
                                                            #endregion
                                                        }
                                                    }
                                                    else
                                                    {
                                                        #region //判斷條碼最後一個必要過站是否完成
                                                        dynamicParameters = new DynamicParameters();
                                                        sql = @"SELECT TOP 1 1
                                                                FROM MES.Barcode a
                                                                OUTER APPLY (
                                                                    SELECT  TOP 1 x.MoProcessId FROM MES.MoProcess x
                                                                    WHERE x.MoId = a.MoId
                                                                    AND x.NecessityStatus = 'Y'
                                                                    ORDER BY SortNumber DESC
                                                                ) x1
                                                                WHERE a.MoId = @MoId
                                                                AND a.BarcodeId = @BarcodeId";
                                                        dynamicParameters.Add("MoId", MoId);
                                                        dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                                        var resultNecessityStatus = sqlConnection.Query(sql, dynamicParameters);
                                                        if (resultNecessityStatus.Count() <= 0) throw new SystemException("產品條碼" + item1.BarcodeNo + "未完工");
                                                        #endregion
                                                    }
                                                }
                                                else
                                                {
                                                    #region //判斷完工入庫的條碼必要過站是否都是PASS
                                                    // dynamicParameters = new DynamicParameters();
                                                    // sql = @"SELECT d.BarcodeNo,d.CurrentProdStatus, c.MoProcessId,c.ProcessAlias,e.ProdStatus
                                                    //         FROM MES.WipOrder a
                                                    //         LEFT JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                                                    //         LEFT JOIN MES.MoProcess c ON b.MoId = c.MoId
                                                    //         LEFT JOIN MES.Barcode d ON b.MoId = d.MoId
                                                    //         LEFT JOIN MES.BarcodeProcess e ON d.BarcodeId = e.BarcodeId AND c.MoProcessId = e.MoProcessId
                                                    //         WHERE b.MoId = @MoId
                                                    //         AND d.BarcodeId = @BarcodeId
                                                    //         AND d.CurrentProdStatus in ('P','M','R')
                                                    //         AND c.NecessityStatus = 'Y'
                                                    //         AND e.ProdStatus is null";
                                                    // dynamicParameters.Add("MoId", MoId);
                                                    // dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                                    // var barcodePassAll = sqlConnection.Query(sql, dynamicParameters);
                                                    // if (barcodePassAll.Count() > 0)
                                                    // {
                                                    //     string MoProcessNotPass = "";
                                                    //     string BarcodeNo = "";
                                                    //     int num = 0;
                                                    //     foreach (var item2 in barcodePassAll)
                                                    //     {
                                                    //         if (num > 0)
                                                    //         {
                                                    //             MoProcessNotPass += ",【" + item2.ProcessAlias + "】";

                                                    //         }
                                                    //         else
                                                    //         {
                                                    //             MoProcessNotPass += "【" + item2.ProcessAlias + "】";
                                                    //             BarcodeNo += item2.BarcodeNo;
                                                    //         }
                                                    //         num++;
                                                    //     }
                                                    //     //throw new SystemException("【條碼:" + BarcodeNo + "】過站異常，" + MoProcessNotPass + "為必要站,請完成過站程序!!!");
                                                    // }
                                                    #endregion
                                                }
                                            }
                                            #endregion
                                        }
                                    }

                                    if (AberrantBarcodeList != "")
                                    {
                                        throw new SystemException("產品條碼【" + AberrantBarcodeList + "】屬性沒有維護完整,請重新確認");
                                    }

                                    foreach (var item in ArrBarcodeNoY) //入庫單是拋轉過的條碼要排除
                                    {
                                        sql = @"SELECT a.BarcodeId,b.CurrentProdStatus,b.BarcodeQty,b.BarcodeStatus
                                                FROM MES.MweBarcode a
                                                INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                                WHERE 1=1
                                                AND NOT EXISTS(SELECT 1
												                FROM MES.MweDetail c
														            INNER JOIN MES.MoWarehouseEnry d ON c.MweId = d.MweId
													            WHERE c.MweDetailId = a.MweDetailId
													            AND d.TransferStatus = 'Y'  AND d.ConfirmStatus = 'Y')";
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND a.BarcodeId = @BarcodeId", item);
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND b.MoId = @MoId", MoId);
                                        result = sqlConnection.Query(sql, dynamicParameters);

                                        if (result.Count() <= 0)  //沒有在入庫單身中的條碼就收納進去
                                        {
                                            BarcodeIdListNew.Add(item);
                                        }
                                    }
                                    string res = string.Join(",", BarcodeIdListNew);

                                    if (res != "")
                                    {
                                        dynamicParameters = new DynamicParameters();

                                        sql = @"SELECT BarcodeId,BarcodeNo,CurrentProdStatus,BarcodeStatus,BarcodeQty,NextMoProcessId,BarcodeStatus
                                                FROM MES.Barcode
                                                WHERE 1=1";
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND BarcodeId IN @BarcodeId", res.Split(','));

                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() <= 0) throw new SystemException("條碼資料有問題");

                                        foreach (var item in result)
                                        {
                                            string CurrentProdStatus = item.CurrentProdStatus;
                                            if (CurrentProdStatus == "S")
                                            {
                                                if (CurrentProdStatus == "S" && NgToDisassembly == "Y") throw new SystemException("【MES製令設定：NG品可拆解】只能入庫良品條碼!!請重新確認");

                                                #region //判斷系統自動生產的報廢條碼是否有入庫過
                                                if (CurrentProdStatus == "S" && NgToBarcode == "N" && Source == "BP")
                                                {
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT TOP 1 1
                                                            FROM MES.MweBarcode a
                                                            WHERE a.BarcodeId = @BarcodeId";
                                                    dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                                    result = sqlConnection.Query(sql, dynamicParameters);
                                                    if (result.Count() > 0) throw new SystemException("報廢條碼【" + item.BarcodeNo + "】已經入庫過了,請重新確認!!!");
                                                }
                                                #endregion

                                                switch (CurrentCompany)
                                                {
                                                    case 2:
                                                        if (InventoryId != 12)
                                                        {
                                                            throw new SystemException("該條碼為報廢品，請入【待報廢倉】");
                                                        }
                                                        break;
                                                    case 3:
                                                        if (InventoryId != 129)
                                                        {
                                                            throw new SystemException("該條碼為報廢品，請入【待報廢倉】");
                                                        }
                                                        break;
                                                    case 4:
                                                        if (InventoryId != 46)
                                                        {
                                                            throw new SystemException("該條碼為報廢品，請入【待報廢倉】");
                                                        }
                                                        break;
                                                    case 5:
                                                        if (InventoryId != 115)
                                                        {
                                                            throw new SystemException("該條碼為報廢品，請入【待報廢倉】");
                                                        }
                                                        break;
                                                    default:
                                                        throw new SystemException("公司資料錯誤");
                                                        break;
                                                }
                                            }
                                            else
                                            {
                                                switch (CurrentCompany)
                                                {
                                                    case 2:
                                                        if (InventoryId == 12)
                                                        {
                                                            throw new SystemException("該條碼為良品，不可以【待報廢倉】");
                                                        }
                                                        break;
                                                    case 3:
                                                        if (InventoryId == 129)
                                                        {
                                                            throw new SystemException("該條碼為良品，不可以【待報廢倉】");
                                                        }
                                                        break;
                                                    case 4:
                                                        if (InventoryId == 46)
                                                        {
                                                            throw new SystemException("該條碼為良品，不可以【待報廢倉】");
                                                        }
                                                        break;
                                                    case 5:
                                                        if (InventoryId == 115)
                                                        {
                                                            throw new SystemException("該條碼為良品，不可以【待報廢倉】");
                                                        }
                                                        break;
                                                    default:
                                                        throw new SystemException("公司資料錯誤");
                                                        break;
                                                }
                                            }
                                            BarcodeIdListY.Add(item.BarcodeId + "❤" + item.BarcodeQty + "❤" + item.NextMoProcessId + "❤" + item.BarcodeStatus);
                                        }

                                        #region //入庫條碼寫入資料庫
                                        var insertResult2 = "";
                                        foreach (var item in BarcodeIdListY)
                                        {

                                            var amortizeList = BarcodeListAmortizeTtypeY.Split(',');
                                            var amortizetype = "";
                                            int itemindex = Array.IndexOf(amortizeList, item);

                                            if (amortizeList.Contains(item.Split('❤')[0]))
                                            {
                                                amortizetype = "Y";
                                            }
                                            else
                                            {
                                                amortizetype = "N";
                                            }

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.MweBarcode (MweDetailId, BarcodeId, MweBarcodeQty,SourceType, NextMoProcessId, BarcodeStatus, CreateDate, LastModifiedDate, CreateBy,LastModifiedBy, AmortizeTtype)
                                                    OUTPUT INSERTED.MweBarcodeId
                                                    VALUES (@MweDetailId, @BarcodeId, @MweBarcodeQty, @SourceType, @NextMoProcessId, @BarcodeStatus, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy, @AmortizeTtype)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MweDetailId,
                                                    BarcodeId = Convert.ToInt32(item.Split('❤')[0]),
                                                    MweBarcodeQty = Convert.ToInt32(item.Split('❤')[1]),
                                                    NextMoProcessId = Convert.ToInt32(item.Split('❤')[2]),
                                                    BarcodeStatus = Convert.ToInt32(item.Split('❤')[3]),
                                                    SourceType = "MA",
                                                    CreateDate,
                                                    LastModifiedDate,
                                                    CreateBy,
                                                    LastModifiedBy,
                                                    AmortizeTtype = amortizetype
                                                });

                                            insertResult2 += sqlConnection.Query(sql, dynamicParameters);

                                            #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改8
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1
                                                    FROM MES.BarcodeComponent a 
                                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                                    WHERE a.AssemblyBarcodeId = @BarcodeId
                                                    AND b.MoId = @MoId";
                                            dynamicParameters.Add("BarcodeId", Convert.ToInt32(item.Split('❤')[0]));
                                            dynamicParameters.Add("MoId", MoId);
                                            var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultComponent.Count() > 0)
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"update MES.Barcode  SET  
                                                        BarcodeStatus = @BarcodeStatus,
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        FROM  MES.Barcode a 
                                                        INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                                        WHERE b.AssemblyBarcodeId = @BarcodeId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BarcodeStatus = "8",
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        BarcodeId = Convert.ToInt32(item.Split('❤')[0])
                                                    });
                                                insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                            }
                                            #endregion

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    BarcodeStatus = @BarcodeStatus,
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    BarcodeStatus = "8",
                                                    LastModifiedDate,
                                                    LastModifiedBy,
                                                    BarcodeId = Convert.ToInt32(item.Split('❤')[0])
                                                });
                                            insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                        }

                                        #endregion
                                    }
                                }
                                #endregion

                                #region //未勾選-入庫條碼
                                if (BarcodeNoN != "")
                                {
                                    #region //判斷入庫單單身綁定的條碼是否存在
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeId,b.BarcodeNo, a.BarcodeStatus,a.NextMoProcessId,b.CurrentProdStatus
                                            FROM MES.MweBarcode a
                                            INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                            WHERE a.MweDetailId = @MweDetailId";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);
                                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND b.BarcodeId IN @BarcodeId", BarcodeNoN.Split(','));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0)
                                    {
                                        var insertResult2 = "";
                                        #region //刪除-入庫條碼
                                        foreach (var item in result)
                                        {
                                            #region //條碼狀態更新 - 強制結束
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    BarcodeStatus = @BarcodeStatus,
                                                    NextMoProcessId = @NextMoProcessId,
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    BarcodeStatus = item.BarcodeStatus,
                                                    NextMoProcessId = item.NextMoProcessId,
                                                    LastModifiedDate,
                                                    LastModifiedBy,
                                                    BarcodeId = item.BarcodeId
                                                });
                                            insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                            #endregion

                                            #region //刪除 -入庫單單身綁定該筆條碼資料
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"DELETE FROM MES.MweBarcode
                                                    WHERE MweDetailId = @MweDetailId
                                                    AND BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("MweDetailId", MweDetailId);
                                            dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND BarcodeId = @BarcodeId", item);

                                            insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                            #endregion

                                            #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改4
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1
                                                    FROM MES.BarcodeComponent a 
                                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                                    WHERE a.AssemblyBarcodeId = @BarcodeId
                                                    AND b.MoId = @MoId";
                                            dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                            dynamicParameters.Add("MoId", MoId);
                                            var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultComponent.Count() > 0)
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"update MES.Barcode  SET  
                                                        BarcodeStatus = @BarcodeStatus,
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        FROM  MES.Barcode a 
                                                        INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                                        WHERE b.AssemblyBarcodeId = @BarcodeId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BarcodeStatus = "4",
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        BarcodeId = item.BarcodeId
                                                    });
                                                insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                            }
                                            #endregion
                                        }
                                        #endregion
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //判斷入庫單單身是否有綁定條碼
                                int bindBarcode = 1;

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT BarcodeId
                                        FROM MES.MweBarcode
                                        WHERE MweDetailId = @MweDetailId";
                                dynamicParameters.Add("MweDetailId", MweDetailId);

                                result = sqlConnection.Query(sql, dynamicParameters);
                                var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                                if (result.Count() <= 0)
                                {
                                    #region //無綁定條碼刪除入庫單單身
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.MweDetail
                                                    WHERE MweDetailId = @MweDetailId";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);

                                    rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                    insertResult1 = sqlConnection.Query(sql, dynamicParameters);
                                    bindBarcode = 0;
                                    #endregion

                                    #region //Response
                                    jsonResponse = JObject.FromObject(new
                                    {
                                        status = "success",
                                        msg = "(" + rowsAffected + " rows affected)",
                                        data = bindBarcode,
                                    });
                                    #endregion
                                }
                                else
                                {
                                    #region //目前該單身最新的PASS數量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT SUM(b.BarcodeQty) BarcodeQtyPassTotal
                                                FROM MES.MweBarcode a
                                                INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                                WHERE a.MweDetailId = @MweDetailId
                                                AND b.CurrentProdStatus IN ('P','M','R')";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    int? BarcodeQtyPassTotal = -1;
                                    foreach (var item in result)
                                    {
                                        BarcodeQtyPassTotal = item.BarcodeQtyPassTotal;
                                    }
                                    if (BarcodeQtyPassTotal == null) BarcodeQtyPassTotal = 0;
                                    #endregion

                                    #region //目前該單身最新的scrap數量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT SUM(b.BarcodeQty) BarcodeQtyScrapTotal
                                            FROM MES.MweBarcode a
                                            INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                            WHERE a.MweDetailId = @MweDetailId
                                            AND b.CurrentProdStatus = 'S'";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    int? BarcodeQtyScrapTotal = -1;
                                    foreach (var item in result)
                                    {
                                        BarcodeQtyScrapTotal = item.BarcodeQtyScrapTotal;
                                    }
                                    if (BarcodeQtyScrapTotal == null) BarcodeQtyScrapTotal = 0;
                                    #endregion

                                    ScriptQtyTrue += Convert.ToInt32(BarcodeQtyScrapTotal);
                                    AcceptQtyTrue += Convert.ToInt32(BarcodeQtyPassTotal);

                                    #region //判斷頁面欄位與後端計算數量是否相符
                                    if (ScrapRegister == "Y")
                                    {
                                        switch (CurrentCompany)
                                        {
                                            case 2:
                                                if (InventoryId == 12)
                                                {
                                                    if (ScriptQtyTrue != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                                    if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                                }
                                                break;
                                            case 3:
                                                if (InventoryId == 129)
                                                {
                                                    if (ScriptQtyTrue != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                                    if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                                }
                                                break;
                                            case 4:
                                                if (InventoryId == 46)
                                                {
                                                    if (ScriptQtyTrue != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                                    if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                                }
                                                break;
                                            case 5:
                                                if (InventoryId == 115)
                                                {
                                                    if (ScriptQtyTrue != AcceptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                                    if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                                }
                                                break;
                                            default:
                                                throw new SystemException("公司資料錯誤");
                                                break;
                                        }
                                    }
                                    else
                                    {
                                        int MweBarcodeQtyS = 0;
                                        #region //判斷報廢條碼是否有被使用過

                                        foreach (var item1 in ScriptBarcodeIdList)
                                        {
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT a.BarcodeId,a.MweBarcodeQty
                                                    FROM MES.MweBarcode a
                                                    INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                                                    WHERE b.MoId = @MoId
                                                    AND a.BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("MoId", MoId);
                                            dynamicParameters.Add("BarcodeId", item1);

                                            var resultMwe = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultMwe.Count() > 0)
                                            {
                                                int MweBarcodeQty = -1;
                                                foreach (var item in resultMwe)
                                                {
                                                    MweBarcodeQty = Convert.ToInt32(item.TotalScrapQty);
                                                }
                                                MweBarcodeQtyS += MweBarcodeQty;
                                            }
                                        }
                                        #endregion

                                        if ((ScriptQtyTrue + AmortizeNewCount) != ScriptQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                        if ((AcceptQtyTrue - ScriptQty) != AcceptQty) throw new SystemException("資料錯誤,驗收數欄位輸入的數據於後端計算不相符");
                                        if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");

                                    }
                                    #endregion

                                    #region //判斷目前該MES製令全部入庫數量是否超過MES製令預計產量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT SUM( b.ReceiptQty) ReceiptQtyAll
                                            FROM MES.ManufactureOrder a
                                            INNER JOIN MES.MweDetail b on a.MoId = b.MoId
                                            WHERE a.MoId = @MoId
                                            AND b.MweDetailId !=@MweDetailId";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("MweDetailId", MweDetailId);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0)
                                    {
                                        int? ReceiptQtyAll = -1;
                                        foreach (var item in result)
                                        {
                                            ReceiptQtyAll = Convert.ToInt32(item.ReceiptQtyAll);
                                        }
                                        if (ReceiptQtyAll + ReceiptQty > MoQuantityBase)
                                        {
                                            QuantityExceeds = 1;
                                            //throw new SystemException("【入庫單】－ 全部入庫數量超過MES製令預計產量!請重新確認!!");
                                        }
                                    }
                                    #endregion

                                    #region //金額計算
                                    double OrigAmountBackstage = AvailableQty * OrigUnitPrice; //加工金額
                                    double OrigPreTaxAmtBackstage = AvailableQty * OrigUnitPrice - OrigDiscountAmt; //原幣未稅金額
                                    double OrigTaxAmtBackstage = (AvailableQty * OrigUnitPrice - OrigDiscountAmt) * TaxRate; //原幣稅金額
                                    double PreTaxAmtBackstage = (AvailableQty * OrigUnitPrice - OrigDiscountAmt) * Exchange; //本幣未稅額
                                    double TaxAmtBackstage = (AvailableQty * OrigUnitPrice - OrigDiscountAmt) * Exchange * TaxRate; //本幣稅額
                                    if (OrigAmountBackstage != OrigAmount) throw new SystemException("【加工金額】前後端計算結果不相符，資料有問題請重新確認");
                                    if (OrigPreTaxAmtBackstage != OrigPreTaxAmt) throw new SystemException("【原幣未稅金額】前後端計算結果不相符，資料有問題請重新確認");
                                    if (OrigTaxAmtBackstage != OrigTaxAmt) throw new SystemException("【原幣稅金額】前後端計算結果不相符，資料有問題請重新確認");
                                    if (PreTaxAmtBackstage != PreTaxAmt) throw new SystemException("【本幣未稅額】前後端計算結果不相符，資料有問題請重新確認");
                                    if (TaxAmtBackstage != TaxAmt) throw new SystemException("【本幣稅額】前後端計算結果不相符，資料有問題請重新確認");


                                    if (MeasureType != "0")
                                    {
                                        if (ReceiptQty != AcceptQty && QcStatus != "3") throw new SystemException("【檢驗類別】檢驗類別應為不良，資料有問題請重新確認");
                                        if (ReceiptQty == AcceptQty && QcStatus != "2") throw new SystemException("【檢驗類別】檢驗類別應為合格，資料有問題請重新確認");
                                    }
                                    else
                                    {
                                        if (QcStatus != "0") throw new SystemException("【檢驗類別】品號檢驗方式為免檢，故檢驗類別因為免檢，資料有問題請重新確認");
                                    }
                                    //string QcStatusBackstage = "";
                                    //if (QcStatus != "0")
                                    //{
                                    //    if (ScriptQty > 0 || ReturnQty > 0)
                                    //    {
                                    //        QcStatusBackstage = "3";
                                    //    }
                                    //    else if (AcceptQty > 0 && ScriptQty == 0 && ReturnQty == 0)
                                    //    {
                                    //        QcStatusBackstage = "2";
                                    //    }
                                    //    else if (AcceptQty == 0 && ScriptQty == 0 && ReturnQty == 0)
                                    //    {
                                    //        QcStatusBackstage = "1";
                                    //    }
                                    //}
                                    //if (QcStatusBackstage != QcStatus) throw new SystemException("【檢驗類別】前後端計算結果不相符，資料有問題請重新確認");
                                    #endregion

                                    #region //單身資料更新
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.MweDetail SET
                                            InventoryId = @InventoryId,
                                            AcceptanceDate = @AcceptanceDate,
                                            ReceiptQty = @ReceiptQty,
                                            AcceptQty = @AcceptQty,
                                            AvailableQty = @AvailableQty,
                                            ScriptQty = @ScriptQty,
                                            ReturnQty = @ReturnQty,
                                            OrigUnitPrice = @OrigUnitPrice,
                                            OrigAmount = @OrigAmount,
                                            OrigDiscountAmt = @OrigDiscountAmt,
                                            ReceiptExpense = @ReceiptExpense,
                                            DiscountDescription = @DiscountDescription,
                                            OrigPreTaxAmt = @OrigPreTaxAmt,
                                            OrigTaxAmt = @OrigTaxAmt,
                                            PreTaxAmt = @PreTaxAmt,
                                            TaxAmt = @TaxAmt,
                                            Remark = @Remark,
                                            LotNumber = @LotNumber,
                                            ProjectCode = @ProjectCode,
                                            ProcessCode = @ProcessCode,
                                            QcStatus = @QcStatus,
                                            Overdue = @Overdue,
                                            ReserveTaxCode = @ReserveTaxCode,
                                            PaymentHold = @PaymentHold,
                                            QcRecordId = @QcRecordId,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy,
                                            IsAmortize = @IsAmortize
                                            WHERE MweId = @MweId
                                            AND MweDetailId = @MweDetailId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            InventoryId,
                                            AcceptanceDate,
                                            ReceiptQty,
                                            AcceptQty,
                                            AvailableQty,
                                            ScriptQty,
                                            ReturnQty,
                                            OrigUnitPrice,
                                            OrigAmount,
                                            OrigDiscountAmt,
                                            ReceiptExpense,
                                            DiscountDescription,
                                            OrigPreTaxAmt,
                                            OrigTaxAmt,
                                            PreTaxAmt,
                                            TaxAmt,
                                            Remark,
                                            LotNumber,
                                            ProjectCode,
                                            ProcessCode = ProcessCode.Length > 0 ? ProcessCode : "****",
                                            QcStatus,
                                            Overdue,
                                            ReserveTaxCode,
                                            PaymentHold,
                                            QcRecordId,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            IsAmortize,
                                            MweId,
                                            MweDetailId,
                                        });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);


                                    #region //Response
                                    jsonResponse = JObject.FromObject(new
                                    {
                                        status = "success",
                                        msg = "(" + rowsAffected + " rows affected)",
                                        data = insertResult
                                    });
                                    #endregion

                                    #endregion

                                }
                                #endregion

                            }
                            else if (ScrapRegister == "N") //不用進報廢倉 
                            {
                                #region //勾選-入庫條碼
                                if (BarcodeNoY != "")
                                {
                                    List<int> ArrBarcodeNoY = new List<int>();
                                    ArrBarcodeNoY = BarcodeNoY.Split(',').Select(int.Parse).ToList();
                                    string AberrantBarcodeList = "";
                                    int AberrantBarcodeNum = 0;

                                    dynamicParameters = new DynamicParameters();
                                    foreach (var item in ArrBarcodeNoY)
                                    {
                                        sql = @"SELECT a.BarcodeId,a.BarcodeNo,a.CurrentProdStatus,a.BarcodeQty,a.BarcodeStatus
                                                FROM MES.Barcode a
                                                WHERE 1=1";
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND a.BarcodeId = @BarcodeId", item);
                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() <= 0) throw new SystemException("【入庫單】-條碼資料不存在!");

                                        foreach (var item1 in result)
                                        {
                                            #region //判斷條碼屬性過站歷程中是否有維護完整
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT x.MoProcessId
                                                    ,c.ItemNo,c.ItemValue
                                                    ,a.BarcodeId,a.BarcodeNo,a.CurrentProdStatus

                                                    ,z.Num
                                                    FROM MES.Barcode a
                                                    OUTER APPLY(
                                                          select x1.MoProcessId FROM MES.BarcodeProcess x1 where x1.BarcodeId = a.BarcodeId AND x1.MoId = a.MoId
                                                        ) x
                                                    INNER JOIN MES.MoProcessItem b on x.MoProcessId = b.MoProcessId 
                                                    LEFT JOIN MES.BarcodeAttribute c on b.ItemNo = c.ItemNo and a.BarcodeId = c.BarcodeId
                                                    OUTER APPLY(
                                                          select COUNT(z2.MoProcessItemId) Num FROM MES.BarcodeProcess z1 
                                                          INNER JOIN MES.MoProcessItem z2 on z1.MoProcessId = z2.MoProcessId
                                                          where z1.BarcodeId = a.BarcodeId  AND z1.MoId = a.MoId
                                                        ) z
                                                    WHERE a.BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                            var resultCheckAttribute = sqlConnection.Query(sql, dynamicParameters);
                                            foreach (var item2 in resultCheckAttribute)
                                            {
                                                if (item2.CurrentProdStatus != "S")
                                                {
                                                    if (item2.ItemNo != null)
                                                    {
                                                        if (item2.Num != resultCheckAttribute.Count())
                                                        {
                                                            if (AberrantBarcodeNum == 0)
                                                            {
                                                                AberrantBarcodeList += item1.BarcodeNo;
                                                            }
                                                            else
                                                            {
                                                                AberrantBarcodeList += "," + item1.BarcodeNo;
                                                            }
                                                        }
                                                    }
                                                    else
                                                    {
                                                        AberrantBarcodeList += "," + item1.BarcodeNo;
                                                    }
                                                }
                                            }
                                            #endregion

                                            #region //確認此條碼是否有刻字置換資料未確認(鍍鎳站除外)
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 a.OriBarcodeAttrId, a.NewBarcodeAttrId
                                            , b.[Status]
                                            , (
                                                SELECT TOP 1 1
                                                FROM MES.BarcodeProcess x 
                                                WHERE x.BarcodeId = @BarcodeId
                                                AND x.FinishDate IS NULL
                                            ) CheckBarcodeProcess
                                            FROM MES.BarcodeProcessAttributeLog a 
                                            LEFT JOIN MES.BpalDetail b ON a.ProcessAttrLogId = b.ProcessAttrLogId
                                            WHERE a.NewBarcodeId = @BarcodeId
                                            ORDER BY a.CreateDate DESC";
                                            dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                            var BarcodeProcessAtrLogResult = sqlConnection.Query(sql, dynamicParameters);

                                            foreach (var item2 in BarcodeProcessAtrLogResult)
                                            {
                                                if (item2.OriBarcodeAttrId != item2.NewBarcodeAttrId)
                                                {
                                                    if (item2.Status != "Y" && item2.CheckBarcodeProcess == null)
                                                    {
                                                        throw new SystemException("條碼【" + item1.BarcodeNo + "】已被置換，請實際執行重新刻字的動作後再進行後續過站!!");
                                                    }
                                                }
                                            }
                                            #endregion

                                            #region //判斷條碼是否結束流程
                                            if (item1.BarcodeStatus != "8")
                                            {
                                                if (item1.BarcodeStatus != "7")
                                                {
                                                    if (item1.BarcodeStatus != "1")
                                                    {
                                                        if (item1.BarcodeStatus == "0")
                                                        {
                                                            #region //判斷完工入庫的條碼必要過站是否都是PASS
                                                            dynamicParameters = new DynamicParameters();
                                                            sql = @"SELECT d.BarcodeNo,d.CurrentProdStatus, c.MoProcessId,c.ProcessAlias,e.ProdStatus,y.PrintStatus
                                                                    FROM MES.WipOrder a
                                                                    LEFT JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
	                                                                LEFT JOIN MES.MoProcess c ON b.MoId = c.MoId
	                                                                LEFT JOIN MES.Barcode d ON b.MoId = d.MoId
	                                                                LEFT JOIN MES.BarcodeProcess e ON d.BarcodeId = e.BarcodeId AND c.MoProcessId = e.MoProcessId
                                                                    OUTER APPLY(
                                                                        SELECT y3.PrintStatus
                                                                        FROM MES.BarcodeTransfer y1
                                                                        INNER JOIN MES.Barcode y2 on y2.BarcodeId =  y1.ToBarcodeId
                                                                        INNER JOIN MES.BarcodePrint y3 on y3.BarcodeNo =  d.BarcodeNo
                                                                        WHERE y1.ToBarcodeId = d.BarcodeId
                                                                    ) y
                                                                    WHERE b.MoId = @MoId
                                                                    AND d.BarcodeId = @BarcodeId
                                                                    AND d.CurrentProdStatus in ('P','M','R')
                                                                    AND c.NecessityStatus = 'Y'
                                                                    AND e.ProdStatus is null";
                                                            dynamicParameters.Add("MoId", MoId);
                                                            dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                                            var barcodePassAll = sqlConnection.Query(sql, dynamicParameters);
                                                            if (barcodePassAll.Count() > 0)
                                                            {
                                                                string MoProcessNotPass = "";
                                                                string BarcodeNo = "";
                                                                int num = 0;
                                                                foreach (var item2 in barcodePassAll)
                                                                {
                                                                    if (item2.PrintStatus != "F")
                                                                    {
                                                                        if (num > 0)
                                                                        {
                                                                            MoProcessNotPass += ",【" + item2.ProcessAlias + "】";

                                                                        }
                                                                        else
                                                                        {
                                                                            MoProcessNotPass += "【" + item2.ProcessAlias + "】";
                                                                            BarcodeNo += item2.BarcodeNo;
                                                                        }
                                                                        num++;
                                                                        throw new SystemException("【條碼:" + BarcodeNo + "】過站異常，" + MoProcessNotPass + "為必要站,請完成過站程序!!!");
                                                                    }
                                                                }
                                                            }
                                                            #endregion
                                                        }
                                                    }
                                                    else
                                                    {
                                                        #region //判斷條碼最後一個必要過站是否完成
                                                        dynamicParameters = new DynamicParameters();
                                                        sql = @"SELECT TOP 1 1
                                                                FROM MES.Barcode a
                                                                OUTER APPLY (
                                                                    SELECT  TOP 1 x.MoProcessId FROM MES.MoProcess x
                                                                    WHERE x.MoId = a.MoId
                                                                    AND x.NecessityStatus = 'Y'
                                                                    ORDER BY SortNumber DESC
                                                                ) x1
                                                                WHERE a.MoId = @MoId
                                                                AND a.BarcodeId = @BarcodeId";
                                                        dynamicParameters.Add("MoId", MoId);
                                                        dynamicParameters.Add("BarcodeId", item1.BarcodeId);

                                                        var resultNecessityStatus = sqlConnection.Query(sql, dynamicParameters);
                                                        if (resultNecessityStatus.Count() <= 0) throw new SystemException("產品條碼" + item1.BarcodeNo + "未完工");

                                                        #endregion

                                                    }
                                                }
                                            }
                                            #endregion
                                        }

                                    }

                                    if (AberrantBarcodeList != "")
                                    {
                                        throw new SystemException("產品條碼【" + AberrantBarcodeList + "】屬性沒有維護完整,請重新確認");
                                    }

                                    foreach (var item in ArrBarcodeNoY)
                                    {
                                        sql = @"SELECT a.BarcodeId,c.CurrentProdStatus,c.BarcodeQty
                                                FROM MES.MweBarcode a
                                                INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                                INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                                                WHERE 1=1
                                                AND NOT EXISTS(SELECT 1
												                FROM MES.MweDetail c
														            INNER JOIN MES.MoWarehouseEnry d ON c.MweId = d.MweId
													            WHERE c.MweDetailId = a.MweDetailId
													            AND d.TransferStatus = 'Y' AND d.ConfirmStatus = 'Y')";
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND a.BarcodeId = @BarcodeId", item);
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND b.MoId = @MoId", MoId);

                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() <= 0)  //沒有在入庫單身中的條碼就收納進去
                                        {
                                            BarcodeIdListNew.Add(item);
                                        }
                                    }

                                    string res = string.Join(",", BarcodeIdListNew);

                                    if (res != "")
                                    {
                                        dynamicParameters = new DynamicParameters();

                                        sql = @"SELECT BarcodeId,BarcodeNo,CurrentProdStatus,BarcodeStatus,BarcodeQty,NextMoProcessId,BarcodeStatus
                                                FROM MES.Barcode
                                                WHERE 1=1";
                                        if (res.Length > 0) BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND BarcodeId IN @BarcodeId", res.Split(','));

                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() <= 0) throw new SystemException("條碼資料有問題");

                                        foreach (var item in result)
                                        {
                                            BarcodeIdListY.Add(item.BarcodeId + "❤" + item.BarcodeQty + "❤" + item.NextMoProcessId + "❤" + item.BarcodeStatus);
                                        }

                                        #region //入庫條碼寫入資料庫
                                        var insertResult2 = "";
                                        foreach (var item in BarcodeIdListY)
                                        {
                                            #region //撈取條碼數量
                                            int BarcodeQty = 0;
                                            string CurrentProdStatus = "";
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT a.BarcodeQty,a.CurrentProdStatus
                                                    FROM MES.Barcode a
                                                    WHERE a.BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("BarcodeId", item.Split('❤')[0]);
                                            var resultBarcodeQty = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultBarcodeQty.Count() > 0)
                                            {
                                                foreach (var item1 in resultBarcodeQty)
                                                {
                                                    BarcodeQty = Convert.ToInt32(item1.BarcodeQty);
                                                    CurrentProdStatus = item1.CurrentProdStatus;
                                                }
                                            }
                                            #endregion

                                            var amortizeList = BarcodeListAmortizeTtypeY.Split(',');
                                            var amortizetype = "";
                                            int itemindex = Array.IndexOf(amortizeList, item);

                                            if (amortizeList.Contains(item.Split('❤')[0]))
                                            {
                                                amortizetype = "Y";
                                            }
                                            else
                                            {
                                                amortizetype = "N";
                                            }


                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.MweBarcode (MweDetailId, BarcodeId, MweBarcodeQty, SourceType, NextMoProcessId, BarcodeStatus, QaResult, CreateDate, LastModifiedDate, CreateBy,LastModifiedBy, AmortizeTtype)
                                                    OUTPUT INSERTED.MweBarcodeId
                                                    VALUES (@MweDetailId, @BarcodeId, @MweBarcodeQty, @SourceType, @NextMoProcessId, @BarcodeStatus, @QaResult, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy, @AmortizeTtype)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MweDetailId,
                                                    BarcodeId = Convert.ToInt32(item.Split('❤')[0]),
                                                    MweBarcodeQty = Convert.ToInt32(item.Split('❤')[1]),
                                                    NextMoProcessId = Convert.ToInt32(item.Split('❤')[2]),
                                                    BarcodeStatus = Convert.ToInt32(item.Split('❤')[3]),
                                                    SourceType = "MA",
                                                    QaResult = QaResult == "Y" && CurrentProdStatus == "P" ? "Y" : "N",
                                                    CreateDate,
                                                    LastModifiedDate,
                                                    CreateBy,
                                                    LastModifiedBy,
                                                    AmortizeTtype = amortizetype
                                                });

                                            insertResult2 += sqlConnection.Query(sql, dynamicParameters);

                                            #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改8
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1
                                                    FROM MES.BarcodeComponent a 
                                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                                    WHERE a.AssemblyBarcodeId = @BarcodeId
                                                    AND b.MoId = @MoId";
                                            dynamicParameters.Add("BarcodeId", Convert.ToInt32(item.Split('❤')[0]));
                                            dynamicParameters.Add("MoId", MoId);
                                            var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultComponent.Count() > 0)
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"update MES.Barcode  SET  
                                                        BarcodeStatus = @BarcodeStatus,
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        FROM  MES.Barcode a 
                                                        INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                                        WHERE b.AssemblyBarcodeId = @BarcodeId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BarcodeStatus = "8",
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        BarcodeId = Convert.ToInt32(item.Split('❤')[0])
                                                    });
                                                insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                            }
                                            #endregion

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    BarcodeStatus = @BarcodeStatus,
                                                    CurrentProdStatus = @CurrentProdStatus,
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    BarcodeStatus = "8",
                                                    CurrentProdStatus = QaResult == "Y" ? "S" : CurrentProdStatus,
                                                    LastModifiedDate,
                                                    LastModifiedBy,
                                                    BarcodeId = Convert.ToInt32(item.Split('❤')[0])
                                                });
                                            insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                        }

                                        #endregion
                                    }
                                }
                                #endregion

                                #region //刪除已入庫的條碼
                                if (BarcodeNoN != "")
                                {
                                    #region //判斷入庫單單身綁定的條碼是否存在
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MweBarcodeId,a.BarcodeId,b.BarcodeNo,a.BarcodeStatus,a.NextMoProcessId,b.CurrentProdStatus,a.QaResult
                                            FROM MES.MweBarcode a
                                            INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                            WHERE a.MweDetailId = @MweDetailId";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);
                                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND b.BarcodeId IN @BarcodeId", BarcodeNoN.Split(','));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0)
                                    {
                                        foreach (var item in result)
                                        {
                                            BarcodeIdListN.Add(item.BarcodeId);
                                        }
                                        var insertResult2 = "";
                                        foreach (var item in result)
                                        {
                                            #region //判斷條碼是良品還是報廢品
                                            if (item.CurrentProdStatus == "S")
                                            {
                                                #region //條碼狀態更新 - 完工入庫
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE MES.Barcode SET
                                                        BarcodeStatus = @BarcodeStatus,
                                                        CurrentProdStatus = @CurrentProdStatus,
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        WHERE BarcodeId = @BarcodeId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BarcodeStatus = "0",
                                                        CurrentProdStatus = item.QaResult == "Y" ? "P" : item.CurrentProdStatus,
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        BarcodeId = item.BarcodeId
                                                    });
                                                insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                                #endregion
                                            }
                                            else
                                            {
                                                #region //撈取入庫前的狀態回寫
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT a.BarcodeId,a.BarcodeStatus,a.NextMoProcessId
                                                        FROM MES.MweBarcode a
                                                        WHERE a.MweBarcodeId = @MweBarcodeId";
                                                dynamicParameters.Add("MweBarcodeId", item.MweBarcodeId);
                                                result = sqlConnection.Query(sql, dynamicParameters);
                                                if (result.Count() > 0)
                                                {
                                                    #region //條碼狀態更新
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"UPDATE MES.Barcode SET
                                                            NextMoProcessId = @NextMoProcessId,
                                                            BarcodeStatus = @BarcodeStatus,
                                                            LastModifiedDate = @LastModifiedDate,
                                                            LastModifiedBy = @LastModifiedBy
                                                            WHERE BarcodeId = @BarcodeId";
                                                    dynamicParameters.AddDynamicParams(
                                                        new
                                                        {
                                                            BarcodeStatus = item.BarcodeStatus,
                                                            NextMoProcessId = item.NextMoProcessId,
                                                            LastModifiedDate,
                                                            LastModifiedBy,
                                                            BarcodeId = item.BarcodeId
                                                        });
                                                    insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                                    #endregion
                                                }
                                                #endregion
                                            }
                                            #endregion

                                            #region //刪除 -入庫單單身
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"DELETE FROM MES.MweBarcode
                                                    WHERE MweDetailId = @MweDetailId
                                                    AND BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("MweDetailId", MweDetailId);
                                            dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND BarcodeId = @BarcodeId", item);

                                            insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                            #endregion

                                            #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改4
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1
                                                    FROM MES.BarcodeComponent a 
                                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                                    WHERE a.AssemblyBarcodeId = @BarcodeId
                                                    AND b.MoId = @MoId";
                                            dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                            dynamicParameters.Add("MoId", MoId);
                                            var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultComponent.Count() > 0)
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"update MES.Barcode  SET  
                                                        BarcodeStatus = @BarcodeStatus,
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        FROM  MES.Barcode a 
                                                        INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                                        WHERE b.AssemblyBarcodeId = @BarcodeId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BarcodeStatus = "4",
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        BarcodeId = item.BarcodeId
                                                    });
                                                insertResult2 += sqlConnection.Query(sql, dynamicParameters);
                                            }
                                            #endregion
                                        }
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //判斷入庫單單身是否有綁定條碼
                                int bindBarcode = 1;

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT BarcodeId
                                                FROM MES.MweBarcode
                                                WHERE MweDetailId = @MweDetailId";
                                dynamicParameters.Add("MweDetailId", MweDetailId);

                                result = sqlConnection.Query(sql, dynamicParameters);
                                var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                                if (result.Count() <= 0)
                                {
                                    #region //無綁定條碼刪除入庫單單身
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.MweDetail
                                            WHERE MweDetailId = @MweDetailId";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);

                                    rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                    insertResult1 = sqlConnection.Query(sql, dynamicParameters);
                                    bindBarcode = 0;
                                    #endregion

                                    #region //Response
                                    jsonResponse = JObject.FromObject(new
                                    {
                                        status = "success",
                                        msg = "(" + rowsAffected + " rows affected)",
                                        data = bindBarcode,
                                    });
                                    #endregion
                                }
                                else
                                {
                                    #region //目前該單身最新的PASS數量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT SUM(b.BarcodeQty) BarcodeQtyPassTotal
                                            FROM MES.MweBarcode a
                                            INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                            WHERE a.MweDetailId = @MweDetailId
                                            AND b.CurrentProdStatus IN ('P','M','R')";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    int? BarcodeQtyPassTotal = -1;
                                    foreach (var item in result)
                                    {
                                        BarcodeQtyPassTotal = Convert.ToInt32(item.BarcodeQtyPassTotal);
                                    }
                                    if (BarcodeQtyPassTotal == null) BarcodeQtyPassTotal = 0;

                                    #endregion

                                    #region //目前該單身最新的scrap數量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT SUM(b.BarcodeQty) BarcodeQtyScrapTotal
                                            FROM MES.MweBarcode a
                                            INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                            WHERE a.MweDetailId = @MweDetailId
                                            AND b.CurrentProdStatus = 'S'";
                                    dynamicParameters.Add("MweDetailId", MweDetailId);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    int? BarcodeQtyScrapTotal = -1;
                                    foreach (var item in result)
                                    {
                                        BarcodeQtyScrapTotal = Convert.ToInt32(item.BarcodeQtyScrapTotal);
                                    }
                                    if (BarcodeQtyScrapTotal == null) BarcodeQtyScrapTotal = 0;

                                    #endregion

                                    ScriptQtyTrue += Convert.ToInt32(BarcodeQtyScrapTotal);
                                    AcceptQtyTrue += Convert.ToInt32(BarcodeQtyPassTotal);

                                    #region //判斷頁面欄位與後端計算數量是否相符
                                    if ((ScriptQtyTrue + AmortizeNewCount) != (QaResult != "Y" ? ScriptQty : ScriptQty + AcceptQty)) throw new SystemException("資料錯誤,報廢數欄位輸入的數據於後端計算不相符");
                                    if (AcceptQtyTrue != (QaResult != "Y" ? AcceptQty : 0)) throw new SystemException("資料錯誤,驗收數欄位輸入的數據於後端計算不相符");
                                    if (ScriptQtyTrue + AcceptQtyTrue != ReceiptQty) throw new SystemException("資料錯誤,進貨數欄位輸入的數據於後端計算不相符");
                                    #endregion

                                    #region //判斷目前該MES製令全部入庫數量是否超過MES製令預計產量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT SUM( b.ReceiptQty) ReceiptQtyAll
                                            FROM MES.ManufactureOrder a
                                            INNER JOIN MES.MweDetail b on a.MoId = b.MoId
                                            WHERE a.MoId = @MoId
                                            AND b.MweDetailId !=@MweDetailId";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("MweDetailId", MweDetailId);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0)
                                    {
                                        int? ReceiptQtyAll = -1;
                                        foreach (var item in result)
                                        {
                                            ReceiptQtyAll = Convert.ToInt32(item.ReceiptQtyAll);
                                        }
                                        if (ReceiptQtyAll + ReceiptQty > MoQuantityBase)
                                        {
                                            QuantityExceeds = 1;
                                            //throw new SystemException("【入庫單】－ 全部入庫數量超過MES製令預計產量!請重新確認!!");
                                        }
                                    }
                                    #endregion

                                    #region //金額計算
                                    double OrigAmountBackstage = AvailableQty * OrigUnitPrice; //加工金額
                                    double OrigPreTaxAmtBackstage = AvailableQty * OrigUnitPrice - OrigDiscountAmt; //原幣未稅金額
                                    double OrigTaxAmtBackstage = (AvailableQty * OrigUnitPrice - OrigDiscountAmt) * TaxRate; //原幣稅金額
                                    double PreTaxAmtBackstage = AvailableQty * OrigUnitPrice - OrigDiscountAmt; //本幣未稅額
                                    double TaxAmtBackstage = (AvailableQty * OrigUnitPrice - OrigDiscountAmt) * TaxRate; //本幣稅額
                                    if (OrigAmountBackstage != OrigAmount) throw new SystemException("【加工金額】前後端計算結果不相符，資料有問題請重新確認");
                                    if (OrigPreTaxAmtBackstage != OrigPreTaxAmt) throw new SystemException("【原幣未稅金額】前後端計算結果不相符，資料有問題請重新確認");
                                    if (OrigTaxAmtBackstage != OrigTaxAmt) throw new SystemException("【原幣稅金額】前後端計算結果不相符，資料有問題請重新確認");
                                    if (PreTaxAmtBackstage != PreTaxAmt) throw new SystemException("【本幣未稅額】前後端計算結果不相符，資料有問題請重新確認");
                                    if (TaxAmtBackstage != TaxAmt) throw new SystemException("【本幣稅額】前後端計算結果不相符，資料有問題請重新確認");


                                    if (MeasureType != "0")
                                    {
                                        if (ReceiptQty != AcceptQty && QcStatus != "3") throw new SystemException("【檢驗類別】檢驗類別應為不良，資料有問題請重新確認");
                                        if (ReceiptQty == AcceptQty && QcStatus != "2") throw new SystemException("【檢驗類別】檢驗類別應為合格，資料有問題請重新確認");
                                    }
                                    else
                                    {
                                        if (QcStatus != "0") throw new SystemException("【檢驗類別】品號檢驗方式為免檢，故檢驗類別因為免檢，資料有問題請重新確認");
                                    }
                                    //string QcStatusBackstage = "";
                                    //if (QcStatus != "0")
                                    //{
                                    //    if (ScriptQty > 0 || ReturnQty > 0)
                                    //    {
                                    //        QcStatusBackstage = "3";
                                    //    }
                                    //    else if (AcceptQty > 0 && ScriptQty == 0 && ReturnQty == 0)
                                    //    {
                                    //        QcStatusBackstage = "2";
                                    //    }
                                    //    else if (AcceptQty == 0 && ScriptQty == 0 && ReturnQty == 0)
                                    //    {
                                    //        QcStatusBackstage = "1";
                                    //    }
                                    //}
                                    //if (QcStatusBackstage != QcStatus) throw new SystemException("【檢驗類別】前後端計算結果不相符，資料有問題請重新確認");
                                    #endregion


                                    #region //單身資料更新
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.MweDetail SET
                                            InventoryId = @InventoryId,
                                            AcceptanceDate = @AcceptanceDate,
                                            ReceiptQty = @ReceiptQty,
                                            AcceptQty = @AcceptQty,
                                            AvailableQty = @AvailableQty,
                                            ScriptQty = @ScriptQty,
                                            ReturnQty = @ReturnQty,
                                            OrigUnitPrice = @OrigUnitPrice,
                                            OrigAmount = @OrigAmount,
                                            OrigDiscountAmt = @OrigDiscountAmt,
                                            ReceiptExpense = @ReceiptExpense,
                                            DiscountDescription = @DiscountDescription,
                                            OrigPreTaxAmt = @OrigPreTaxAmt,
                                            OrigTaxAmt = @OrigTaxAmt,
                                            PreTaxAmt = @PreTaxAmt,
                                            TaxAmt = @TaxAmt,
                                            Remark = @Remark,
                                            LotNumber = @LotNumber,
                                            ProjectCode = @ProjectCode,
                                            ProcessCode = @ProcessCode,
                                            QcStatus = @QcStatus,
                                            Overdue = @Overdue,
                                            ReserveTaxCode = @ReserveTaxCode,
                                            PaymentHold = @PaymentHold,
                                            QcRecordId = @QcRecordId,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE MweId = @MweId
                                            AND MweDetailId = @MweDetailId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            InventoryId,
                                            AcceptanceDate,
                                            ReceiptQty,
                                            AcceptQty = QaResult != "Y" ? AcceptQty : 0,
                                            AvailableQty,
                                            ScriptQty = QaResult != "Y" ? ScriptQty : ScriptQty + AcceptQty,
                                            ReturnQty,
                                            OrigUnitPrice,
                                            OrigAmount,
                                            OrigDiscountAmt,
                                            ReceiptExpense,
                                            DiscountDescription,
                                            OrigPreTaxAmt,
                                            OrigTaxAmt,
                                            PreTaxAmt,
                                            TaxAmt,
                                            Remark,
                                            LotNumber,
                                            ProjectCode,
                                            ProcessCode = ProcessCode.Length > 0 ? ProcessCode : "****",
                                            QcStatus,
                                            Overdue,
                                            ReserveTaxCode,
                                            PaymentHold,
                                            QcRecordId,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            MweId,
                                            MweDetailId,
                                        });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    #region //mwebarcode update
                                    foreach (var item in BarcodeNoY.Split(','))
                                    {
                                        var amortizeList = BarcodeListAmortizeTtypeY.Split(',');
                                        var amortizetype = "";
                                        int itemindex = Array.IndexOf(amortizeList, item);

                                        if (amortizeList.Contains(item.ToString()))
                                        {
                                            amortizetype = "Y";
                                        }
                                        else
                                        {
                                            amortizetype = "N";
                                        }

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"update MES.MweBarcode  SET  
                                                        AmortizeTtype = @AmortizeTtype,
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        WHERE BarcodeId = @BarcodeId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                AmortizeTtype = amortizetype,
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                BarcodeId = Convert.ToInt32(item)
                                            });
                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        var MweBarcodeupdateResult = sqlConnection.Query(sql, dynamicParameters);

                                    }

                                    #endregion


                                    #region //Response
                                    jsonResponse = JObject.FromObject(new
                                    {
                                        status = "success",
                                        msg = "(" + rowsAffected + " rows affected)",
                                        data = insertResult
                                    });
                                    #endregion

                                    #endregion

                                }
                                #endregion
                            }
                        }
                        else if (MoIdType == "N") //數量入庫
                        {
                            int EnterMweQty = 0;
                            int EnterPassQty = 0;
                            int EnterScrapQty = 0;

                            #region //撈出該製令下MES入庫數量
                            dynamicParameters = new DynamicParameters();
                            sql = @" SELECT SUM(a.ReceiptQty) ReceiptQty,SUM(a.AcceptQty) AcceptQty,SUM(a.ScriptQty) ScriptQty
                                     FROM MES.MweDetail a
                                     WHERE a.MoId = @MoId
                                     AND a.ConfirmStatus != 'V'
                                     AND a.MweDetailId != @MweDetailId";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("MweDetailId", MweDetailId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item in result)
                                {
                                    EnterMweQty = Convert.ToInt32(item.ReceiptQty);
                                    EnterPassQty = Convert.ToInt32(item.AcceptQty);
                                    EnterScrapQty = Convert.ToInt32(item.ScriptQty);
                                }
                            }
                            #endregion
                            if (MweErpPrefix != "5903" && AllOutsourcing == "N")
                            {
                                #region //撈出該製令下最後一個必要過站
                                dynamicParameters = new DynamicParameters();
                                sql = @" SELECT MAX(c.SortNumber) SortNumber
                                         FROM MES.ManufactureOrder a
                                         INNER JOIN MES.ProdMode b on a.ModeId = b.ModeId
                                         INNER JOIN MES.MoProcess c ON a.MoId = c.MoId
                                         WHERE a.MoId = @MoId
                                         AND c.NecessityStatus = 'Y'";
                                dynamicParameters.Add("MoId", MoId);

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到製令下最後一個必要過站");
                                int? SortNumberMax = -1;
                                foreach (var item in result)
                                {
                                    SortNumberMax = Convert.ToInt32(item.SortNumber);
                                }
                                #endregion

                                #region //撈出該製令下已經產品完工數量(數量過站)
                                dynamicParameters = new DynamicParameters();
                                sql = @" SELECT TOP 1 c.SortNumber,c.TotalInputQty,c.TotalScrapQty,c.TotalPassQty
                                         FROM MES.ManufactureOrder a
                                         INNER JOIN MES.ProdMode b on a.ModeId = b.ModeId
                                         INNER JOIN MES.MoProcess c ON a.MoId = c.MoId
                                         INNER JOIN MES.MoProcessTransaction d ON c.MoProcessId = d.MoProcessId
                                         WHERE a.MoId = @MoId
                                         AND c.NecessityStatus = 'Y'
                                         AND d.ProdStatus = 'P'
                                         Order By c.SortNumber DESC";
                                dynamicParameters.Add("MoId", MoId);

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("資料錯誤,找不到完工數量");
                                int? SortNumber = -1;
                                int? TotalPassQty = -1;
                                foreach (var item in result)
                                {
                                    SortNumber = Convert.ToInt32(item.SortNumber);
                                    TotalPassQty = Convert.ToInt32(item.TotalPassQty);
                                }
                                if (SortNumberMax != SortNumber) throw new SystemException("該製令最後一站未生產產品");
                                #endregion

                                #region //撈出該製令下產品報廢數量
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT SUM(a.Quantity) TotalScrapQty
                                        FROM MES.MoProcessTransaction a
                                        WHERE MoId = @MoId
                                        AND ProdStatus = 'S' ";
                                dynamicParameters.Add("MoId", MoId);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                int? TotalScrapQty = -1;
                                foreach (var item in result)
                                {
                                    TotalScrapQty = Convert.ToInt32(item.TotalScrapQty);
                                }
                                #endregion

                                //欲入庫的數量 不可以大於 產品全部完工數量-已經入庫數量

                                //正式上線切換
                                if (ModeId != 17) //生產模式:鏡片模造 不卡控
                                {
                                    if (AcceptQty > TotalPassQty - EnterPassQty) throw new SystemException("資料錯誤,驗收數欄位輸入的數據不可以大於資料庫紀錄數據");
                                    if (ScriptQty > TotalScrapQty - EnterScrapQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據不可以大於資料庫紀錄數據");
                                }

                                //if (AcceptQty > TotalPassQty - EnterPassQty) throw new SystemException("資料錯誤,驗收數欄位輸入的數據不可以大於資料庫紀錄數據");
                                //if (ScriptQty > TotalScrapQty - EnterScrapQty) throw new SystemException("資料錯誤,報廢數欄位輸入的數據不可以大於資料庫紀錄數據");


                                ScriptQtyTrue += ScriptQty;
                                AcceptQtyTrue += AcceptQty;
                            }



                            #region //判斷入庫數量是否超過製令預計產量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT SUM( c.ReceiptQty) ReceiptQtyAll
                                    FROM MES.WipOrder a
                                    INNER JOIN MES.ManufactureOrder b on a.WoId = b.WoId
                                    INNER JOIN MES.MweDetail c on b.MoId = c.MoId
                                    WHERE a.WoId = @WoId
                                    AND c.MweDetailId !=@MweDetailId
                                    AND c.ConfirmStatus != 'V'";
                            dynamicParameters.Add("WoId", WoId);
                            dynamicParameters.Add("MweDetailId", MweDetailId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                int? ReceiptQtyAll = -1;
                                foreach (var item in result)
                                {
                                    ReceiptQtyAll = Convert.ToInt32(item.ReceiptQtyAll);
                                }
                                if (ReceiptQtyAll + ReceiptQty > PlanQty)
                                {
                                    QuantityExceeds = 1;
                                    //throw new SystemException("總入庫數量已經超過ERP工單預計產量了!請重新確認");
                                }

                            }
                            #endregion

                            #region //金額計算
                            double OrigAmountBackstage = Math.Round(AvailableQty * OrigUnitPrice, 2); //加工金額
                            double OrigPreTaxAmtBackstage = Math.Round(AvailableQty * OrigUnitPrice - OrigDiscountAmt, 2); //原幣未稅金額
                            double OrigTaxAmtBackstage = Math.Round((AvailableQty * OrigUnitPrice - OrigDiscountAmt) * TaxRate, 2); //原幣稅金額
                            double PreTaxAmtBackstage = Math.Round(AvailableQty * OrigUnitPrice - OrigDiscountAmt, 2); //本幣未稅額
                            double TaxAmtBackstage = Math.Round((AvailableQty * OrigUnitPrice - OrigDiscountAmt) * TaxRate, 2); //本幣稅額
                            if (OrigAmountBackstage != OrigAmount) throw new SystemException("【加工金額】前後端計算結果不相符，資料有問題請重新確認");
                            if (OrigPreTaxAmtBackstage != OrigPreTaxAmt) throw new SystemException("【原幣未稅金額】前後端計算結果不相符，資料有問題請重新確認");
                            if (OrigTaxAmtBackstage != OrigTaxAmt) throw new SystemException("【原幣稅金額】前後端計算結果不相符，資料有問題請重新確認");
                            if (PreTaxAmtBackstage != PreTaxAmt) throw new SystemException("【本幣未稅額】前後端計算結果不相符，資料有問題請重新確認");
                            if (TaxAmtBackstage != TaxAmt) throw new SystemException("【本幣稅額】前後端計算結果不相符，資料有問題請重新確認");


                            if (MeasureType != "0")
                            {
                                if (ReceiptQty != AcceptQty && QcStatus != "3") throw new SystemException("【檢驗類別】檢驗類別應為不良，資料有問題請重新確認");
                                if (ReceiptQty == AcceptQty && QcStatus != "2") throw new SystemException("【檢驗類別】檢驗類別應為合格，資料有問題請重新確認");
                            }
                            else
                            {
                                if (QcStatus != "0") throw new SystemException("【檢驗類別】品號檢驗方式為免檢，故檢驗類別因為免檢，資料有問題請重新確認");
                            }
                            //string QcStatusBackstage = "";
                            //if (QcStatus != "0")
                            //{
                            //    if (ScriptQty > 0 || ReturnQty > 0)
                            //    {
                            //        QcStatusBackstage = "3";
                            //    }
                            //    else if (AcceptQty > 0 && ScriptQty == 0 && ReturnQty == 0)
                            //    {
                            //        QcStatusBackstage = "2";
                            //    }
                            //    else if (AcceptQty == 0 && ScriptQty == 0 && ReturnQty == 0)
                            //    {
                            //        QcStatusBackstage = "1";
                            //    }
                            //}
                            //if (QcStatusBackstage != QcStatus) throw new SystemException("【檢驗類別】前後端計算結果不相符，資料有問題請重新確認");
                            #endregion

                            #region //單身資料更新
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MweDetail SET
                                    InventoryId = @InventoryId,
                                    AcceptanceDate = @AcceptanceDate,
                                    ReceiptQty = @ReceiptQty,
                                    AcceptQty = @AcceptQty,
                                    AvailableQty = @AvailableQty,
                                    ScriptQty = @ScriptQty,
                                    ReturnQty = @ReturnQty,
                                    OrigUnitPrice = @OrigUnitPrice,
                                    OrigAmount = @OrigAmount,
                                    OrigDiscountAmt = @OrigDiscountAmt,
                                    ReceiptExpense = @ReceiptExpense,
                                    DiscountDescription = @DiscountDescription,
                                    OrigPreTaxAmt = @OrigPreTaxAmt,
                                    OrigTaxAmt = @OrigTaxAmt,
                                    PreTaxAmt = @PreTaxAmt,
                                    TaxAmt = @TaxAmt,
                                    Remark = @Remark,
                                    LotNumber = @LotNumber,
                                    ProjectCode = @ProjectCode,
                                    ProcessCode = @ProcessCode,
                                    QcStatus = @QcStatus,
                                    Overdue = @Overdue,
                                    ReserveTaxCode = @ReserveTaxCode,
                                    PaymentHold = @PaymentHold,
                                    QcRecordId = @QcRecordId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MweId = @MweId
                                    AND MweDetailId = @MweDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    InventoryId,
                                    AcceptanceDate,
                                    ReceiptQty,
                                    AcceptQty = QaResult != "Y" ? AcceptQty : 0,
                                    AvailableQty,
                                    ScriptQty = QaResult != "Y" ? ScriptQty : ScriptQty + AcceptQty,
                                    ReturnQty,
                                    OrigUnitPrice,
                                    OrigAmount,
                                    OrigDiscountAmt,
                                    ReceiptExpense,
                                    DiscountDescription,
                                    OrigPreTaxAmt,
                                    OrigTaxAmt,
                                    PreTaxAmt,
                                    TaxAmt,
                                    Remark,
                                    LotNumber,
                                    ProjectCode,
                                    ProcessCode = ProcessCode.Length > 0 ? ProcessCode : "****",
                                    QcStatus,
                                    Overdue,
                                    ReserveTaxCode,
                                    PaymentHold,
                                    QcRecordId,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MweId,
                                    MweDetailId,
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            #region //mwebarcode update
                            if (BarcodeNoY.Length > 0)
                            {
                                foreach (var item in BarcodeNoY.Split(','))
                                {
                                    var amortizeList = BarcodeListAmortizeTtypeY.Split(',');
                                    var amortizetype = "";
                                    int itemindex = Array.IndexOf(amortizeList, item);

                                    if (amortizeList.Contains(item.ToString()))
                                    {
                                        amortizetype = "Y";
                                    }
                                    else
                                    {
                                        amortizetype = "N";
                                    }

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"update MES.MweBarcode  SET  
                                                        AmortizeTtype = @AmortizeTtype,
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            AmortizeTtype = amortizetype,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            BarcodeId = Convert.ToInt32(item)
                                        });
                                    var MweBarcodeupdateResult = sqlConnection.Query(sql, dynamicParameters);

                                }

                            }

                            #endregion


                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)",
                                data = insertResult
                            });
                            #endregion

                            #endregion

                        }
                        else
                        {
                            throw new SystemException("製令是否為條碼入庫的狀態有問題,請重新確認");
                        }
                        #endregion

                        #region //取得製令目前入庫總數
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT SUM(a.ReceiptQty) ReceiptQtyAllMes 
                                            FROM MES.MweDetail a
                                            INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                                            WHERE b.MoId = @MoId
                                            AND a.ConfirmStatus != 'V'";
                        dynamicParameters.Add("MoId", MoId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                ReceiptQtyAllMes = item.ReceiptQtyAllMes;
                            }
                        }
                        else
                        {
                            ReceiptQtyAllMes = 0;
                        }
                        #endregion

                        #region //目前該入庫單的總金額計畫
                        double? OrigAmountAll = 0;
                        double? OrigDiscountAmtAll = 0;
                        double? ReceiptExpenseAll = 0;
                        double? OrigPreTaxAmtAll = 0;
                        double? OrigTaxAmtAll = 0;
                        double? PreTaxAmtAll = 0;
                        double? TaxAmtAll = 0;
                        double? AcceptQtyAllBase = 0;
                        double? ReceiptQtyAllBase = 0;
                        dynamicParameters = new DynamicParameters();
                        sql = @" SELECT SUM(a.OrigAmount) OrigAmountAll, SUM(a.OrigDiscountAmt) OrigDiscountAmtAll, SUM(a.ReceiptExpense) ReceiptExpenseAll
                                 ,SUM(a.OrigPreTaxAmt) OrigPreTaxAmtAll,                                                                                                                                                                                                                       SUM(a.OrigTaxAmt) OrigTaxAmtAll
                                 ,SUM(a.PreTaxAmt) PreTaxAmtAll, SUM(a.TaxAmt) TaxAmtAll, SUM(a.ReceiptQty) ReceiptQtyAll, SUM(a.AcceptQty) AcceptQtyAll
                                 FROM MES.MweDetail a 
                                 WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                OrigAmountAll = item.OrigAmountAll;
                                OrigDiscountAmtAll = item.OrigDiscountAmtAll;
                                ReceiptExpenseAll = item.ReceiptExpenseAll;
                                OrigPreTaxAmtAll = item.OrigPreTaxAmtAll;
                                OrigTaxAmtAll = item.OrigTaxAmtAll;
                                PreTaxAmtAll = item.PreTaxAmtAll;
                                TaxAmtAll = item.TaxAmtAll;
                                AcceptQtyAllBase = item.AcceptQtyAll;
                                ReceiptQtyAllBase = item.ReceiptQtyAll;
                            }
                        }
                        #endregion

                        #region //撈取目前最新驗收日帶入托外進貨日
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT FORMAT(MAX(a.AcceptanceDate), 'yyyy-MM-dd') MaxAcceptanceDate
                                FROM MES.MweDetail a
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單資料錯誤!");
                        string MaxAcceptanceDate = "";
                        foreach (var item in result)
                        {
                            MaxAcceptanceDate = item.MaxAcceptanceDate;
                        }

                        DateTime dateA = DateTime.Parse(DocDate);
                        DateTime dateB = DateTime.Parse(MaxAcceptanceDate);
                        if (dateA > dateB)
                        {
                            throw new SystemException("資料異常:單身驗收日不可以小於單據日!!");
                        }
                        #endregion

                        #region //將金額回寫單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoWarehouseEnry SET
                                ReceiptDate = @ReceiptDate,
                                OrigAmount = @OrigAmountAll,
                                OrigPreTaxAmount = @OrigPreTaxAmtAll,
                                DeductAmount = @OrigDiscountAmtAll,
                                OrigTax = @OrigTaxAmtAll,
                                ReceiptAmount = @ReceiptExpenseAll,
                                PretaxAmount = @PreTaxAmtAll,
                                TaxAmount = @TaxAmtAll,
                                Quantity = @AcceptQtyAllBase,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ReceiptDate = MaxAcceptanceDate,
                                OrigAmountAll = OrigAmountAll != null ? OrigAmountAll : 0,
                                OrigPreTaxAmtAll = OrigPreTaxAmtAll != null ? OrigPreTaxAmtAll : 0,
                                OrigDiscountAmtAll = OrigDiscountAmtAll != null ? OrigDiscountAmtAll : 0,
                                OrigTaxAmtAll = OrigTaxAmtAll != null ? OrigTaxAmtAll : 0,
                                ReceiptExpenseAll = ReceiptExpenseAll != null ? ReceiptExpenseAll : 0,
                                PreTaxAmtAll = PreTaxAmtAll != null ? PreTaxAmtAll : 0,
                                TaxAmtAll = TaxAmtAll != null ? TaxAmtAll : 0,
                                AcceptQtyAllBase = AcceptQtyAllBase != null ? AcceptQtyAllBase : 0,
                                LastModifiedDate,
                                LastModifiedBy,
                                MweId
                            });
                        var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //入庫單條碼更新
                        if (BarcodeNoY.Length > 0)
                        {
                            foreach (var item in BarcodeNoY.Split(','))
                            {
                                var amortizeList = BarcodeListAmortizeTtypeY.Split(',');
                                var amortizetype = "";
                                int itemindex = Array.IndexOf(amortizeList, item);

                                if (amortizeList.Contains(item.ToString()))
                                {
                                    amortizetype = "Y";
                                }
                                else
                                {
                                    amortizetype = "N";
                                }

                                dynamicParameters = new DynamicParameters();
                                sql = @"update MES.MweBarcode  SET  
                                        AmortizeTtype = @AmortizeTtype,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AmortizeTtype = amortizetype,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        BarcodeId = Convert.ToInt32(item)
                                    });
                                var MweBarcodeupdateResult = sqlConnection.Query(sql, dynamicParameters);

                            }
                        }
                        #endregion
                    }


                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷ERP製令是否已經完工
                        string WoStatus = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TA011
                                FROM MOCTA a
                                WHERE TA001 = @WoErpPrefix
                                AND TA002 = @WoErpNo";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);

                        var moctaResult = sqlConnection.Query(sql, dynamicParameters);

                        if (moctaResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in moctaResult)
                        {
                            WoStatus = item.TA011;
                        }
                        #endregion

                        #region //判斷生產數量是否超過領料單可生產數量

                        #region //撈取單據缺領設定
                        string PickingListOutSet = "";
                        string PickingListInSet = "";
                        string WarnMessage = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MQ055,MQ056
                                FROM CMSMQ 
                                WHERE MQ001=@MweErpPrefix";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        var resultSetting1 = sqlConnection.Query(sql, dynamicParameters);
                        if (resultSetting1.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                        foreach (var item1 in resultSetting1)
                        {
                            PickingListOutSet = item1.MQ055;
                            PickingListInSet = item1.MQ056;
                        }
                        #endregion

                        #region //撈出該製令下材料領料單全部領料數並計算出目前可入庫的最大產品套數
                        dynamicParameters = new DynamicParameters();
                        Double MakeNum = 0;
                        int num = 0;

                        #region //獲取ERP單據的材料和須領用量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(TB003)) TB003,SUM(TB004) TB004
                                FROM MOCTB 
                                WHERE TB001=@WoErpPrefix
                                AND TB002 =@WoErpNo
                                AND TB018 ='Y'
                                AND TB011 !=3
                                AND TB011 !=4
                                AND TB004 !=0
                                GROUP BY TB003";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                        foreach (var item in result)
                        {
                            string caseArr = Convert.ToString(item.TB004) + "," + item.TB003;
                            caseNumList.Add(caseArr);
                        }
                        #endregion

                        foreach (var item in caseNumList)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TE027,sum(a.TE005*b.MQ010*-1) NumSet
                                    FROM MOCTE a
                                    INNER JOIN CMSMQ b on a.TE001 =b.MQ001 
                                    WHERE a.TE011=@WoErpPrefix
                                    AND a.TE012 =@WoErpNo
                                    AND a.TE027 =@MtlItemNo
                                    AND a.TE019 ='Y'
                                    Group by a.TE027";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);
                            dynamicParameters.Add("MtlItemNo", item.Split(',')[1]);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                Double NumSet = 0;
                                foreach (var item1 in result)
                                {
                                    NumSet = Convert.ToDouble(item1.NumSet);
                                }
                                Double MaterialMtlItemNoNum = Convert.ToDouble(item.Split(',')[0]);
                                Double RatioOfMaterials = Math.Round(Convert.ToDouble(PlanQty / (MaterialMtlItemNoNum / NumSet)), 2);
                                RatioOfMaterials = RatioOfMaterials > 0 ? Math.Floor(RatioOfMaterials) : Math.Ceiling(RatioOfMaterials);
                                if (num == 0)
                                {
                                    MakeNum = RatioOfMaterials;
                                }
                                else
                                {
                                    //這段意思是 如果該品號是多種材料組成的 會以 可領的最小套數當最大套數
                                    if (MakeNum > RatioOfMaterials)
                                    {
                                        MakeNum = RatioOfMaterials;
                                    }
                                }
                                num++;
                            }
                            else
                            {
                                #region //判斷入庫數是否有超過領料套數
                                switch (PickingListOutSet)
                                {
                                    case "Y":
                                        WarnMessage += "【入庫單】－材料:" + item.Split(',')[1] + "未領取,不能入庫<br>";
                                        break;
                                }
                                #endregion
                            }

                        }
                        if (WarnMessage != "") throw new SystemException(WarnMessage);

                        #endregion

                        #region //ERP撈出該製令下已入庫產品數量(核單)
                        int ReceiptQtyAllERP = 0;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(sum(TI007),0) ReceiptQtyAllERP,ISNULL(sum(TI019),0) TINUM1, ISNULL(sum(TI021),0) TINUM2
                                FROM MOCTI 
                                WHERE TI013=@WoErpPrefix
                                AND TI014 =@WoErpNo
                                AND TI001 != '5902'
                                AND TI037 !='V'";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);
                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                        if (result1.Count() <= 0) throw new SystemException("找不到該製令入庫的單身!");
                        foreach (var item in result1)
                        {
                            ReceiptQtyAllERP = Convert.ToInt32(item.ReceiptQtyAllERP);
                        }
                        #endregion

                        #region //判斷入庫數是否有超過領料套數
                        switch (PickingListOutSet)
                        {
                            case "Y":
                                if (ReceiptQtyAllMes > MakeNum) throw new SystemException("【單據設定控制缺領】入庫數量超過領料單可生產數量,領料不足!!!!!!!!");

                                break;
                            case "N":
                                if (MakeNum < ReceiptQtyAllMes) WarnMessage = "【單據設定不控制缺領】生產數量超過領料單可生產數量,領料不足!!!!!!!!";
                                break;
                            case "W":
                                if (MakeNum < ReceiptQtyAllMes) WarnMessage = "【單據設定警告缺領】生產數量超過領料單可生產數量,領料不足!";
                                break;
                        }
                        switch (PickingListInSet)
                        {
                            case "Y":
                                if (WoStatus == "Y") throw new SystemException("ERP製令已經完工了!請重新確認!!");

                                //throw new SystemException("【入庫單】－目前單據單別不可以超入!!");
                                break;
                            case "N":
                                WarnMessage = "【單據設定不控制超入】生產數量超過製令預計產量!!!!!!!!";
                                break;
                            case "W":
                                WarnMessage = "【單據設定警告超入】生產數量超過製令預計產量!!!!";
                                break;
                        }
                        #endregion

                        #endregion

                        #region //判斷是否有超入
                        if (PlanQty < ReceiptQtyAllMes)
                        {
                            switch (PickingListInSet)
                            {
                                case "Y":
                                    if (WoStatus == "Y") throw new SystemException("ERP製令已經完工了!請重新確認!!");
                                    OverMsg = "P";

                                    //throw new SystemException("【入庫單】－目前單據單別不可以超入!!");
                                    break;
                                case "N":
                                    WarnMessage = "【單據設定不控制超入】生產數量超過製令預計產量!!!!!!!!";
                                    if (OverMsg != "P")
                                    {
                                        OverMsg = "N";
                                    }
                                    break;
                                case "W":
                                    WarnMessage = "【單據設定警告超入】生產數量超過製令預計產量!!!!";
                                    if (OverMsg != "P")
                                    {
                                        OverMsg = "N";
                                    }
                                    break;
                            }

                        }
                        else
                        {
                            OverMsg = "P";
                        }

                        returnData["OverMsg"] = OverMsg;
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = returnData
                        });
                        #endregion


                    }

                    if (OverMsg == "P")
                    {
                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #region //UpdateBarcodeQty -- 更新入庫單批量條碼數量 -- Shintokuro 2023.01.11
        public string UpdateBarcodeQty(int MweDetailId, string BarcodeListOre, string BarcodeListAdd, int BarcodeAllQty)
        {
            try
            {

                if (BarcodeListOre.Length <= 0) throw new SystemException("【驗收日期】不能為空!");


                int rowsAffected = 0;
                int MoId = -1;
                int? BarcodeAllQtyQre = -1;
                int? nullDate = null;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        List<string> barcodeListOri = new List<string>();
                        List<string> barcodeListAdd = new List<string>();

                        barcodeListOri = BarcodeListOre.Split(',').ToList();
                        if (BarcodeListAdd.Length > 0)
                        {
                            barcodeListAdd = BarcodeListAdd.Split(',').ToList();
                        }

                        #region //判定 - 條碼是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT SUM(BarcodeQty) BarcodeAllQtyQre
                                FROM MES.MweDetail a
                                INNER JOIN MES.MweBarcode b on a.MweDetailId = b.MweDetailId
                                INNER JOIN MES.Barcode c on b.BarcodeId = c.BarcodeId
                                WHERE a.MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in result)
                        {
                            BarcodeAllQtyQre = Convert.ToInt32(item.BarcodeAllQtyQre);
                        }
                        if (BarcodeAllQtyQre == null) throw new SystemException("【入庫單-條碼數量更改】,資料有問題");
                        #endregion


                        if (BarcodeAllQty != BarcodeAllQtyQre) throw new SystemException("【入庫單-條碼數量更改】條碼更新數量總數,與入庫單入庫總數不相同!!");


                        #region //判斷原入庫條碼是否正確
                        if (BarcodeListOre.Length > 0)
                        {
                            foreach (var item in barcodeListOri)
                            {

                                int BarcodeId = Convert.ToInt32(item.Split('+')[0]);
                                int BarcodeQty = Convert.ToInt32(item.Split('+')[1]);

                                if (BarcodeId > 0 && BarcodeQty <= 0)
                                {
                                    #region //刪除入庫單上的條碼
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.MweBarcode
                                            WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", BarcodeId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //刪除Barcode資料表上的條碼
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.Barcode
                                            WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", BarcodeId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                else
                                {
                                    #region //判定 - 條碼是否存在
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 MoId,b.MweDetailId
                                        FROM MES.Barcode a
                                        INNER JOIN MES.MweBarcode b on a.BarcodeId = b.BarcodeId
                                        WHERE a.BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", item.Split('+')[0]);
                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【入庫單-條碼數量更改】找不到條碼,資料有問題");
                                    foreach (var item1 in result)
                                    {
                                        MoId = Convert.ToInt32(item1.MoId);
                                    }
                                    #endregion

                                    #region //判定 - 條碼是否存在
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT SUM(BarcodeQty) BarcodeAllQtyQre
                                        FROM MES.Barcode a
                                        INNER JOIN MES.MweBarcode b on a.BarcodeId = b.BarcodeId
                                        WHERE a.BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", item.Split('+')[0]);
                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item1 in result)
                                    {
                                        BarcodeAllQtyQre = Convert.ToInt32(item1.BarcodeAllQtyQre);
                                    }
                                    if (BarcodeAllQtyQre == null) throw new SystemException("【入庫單-條碼數量更改】,資料有問題");
                                    #endregion

                                    #region //更新 - 條碼數量
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                        BarcodeQty = @BarcodeQty,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeQty,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            BarcodeId,
                                        });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                        }
                        #endregion

                        #region //新增入庫條碼
                        if (BarcodeListAdd.Length > 0)
                        {
                            #region //判定 - 製令是否存在 + 撈取最大值
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 2 BarcodeNo
                                    FROM MES.Barcode a
                                    WHERE MoId = @MoId
                                    ORDER BY BarcodeId DESC";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【入庫單-條碼數量更改】找不到製令,資料有問題");
                            string BarcodeNoMax = "";
                            string BarcodeNoMaxSecond = "";

                            int firetNum = 0;
                            foreach (var item in result)
                            {
                                if (firetNum == 0)
                                {
                                    BarcodeNoMax = item.BarcodeNo;
                                }
                                else
                                {
                                    BarcodeNoMaxSecond = item.BarcodeNo;
                                }
                                firetNum++;
                            }

                            string writeModel = "";
                            int placeFirst = -1;
                            int placeLast = -1;
                            string BarcodeNoMaxSerial = "";
                            string BarcodePrefix = "";
                            string BarcodePostfix = "";
                            string BarcodeNoMaxSerialSecond = "";
                            string BarcodePrefixSecond = "";

                            string[] splitStr = { "*/*" }; //自行設定切割字串
                            string[] splitStr1 = { "-" }; //自行設定切割字串

                            int count = BarcodeNoMax.Split(splitStr, StringSplitOptions.RemoveEmptyEntries).Length - 1;
                            if (count == 2)
                            {
                                placeFirst = BarcodeNoMax.IndexOf("*/*");
                                placeLast = BarcodeNoMax.LastIndexOf("*/*");
                            }
                            else if (count == 1)
                            {
                                placeFirst = BarcodeNoMax.IndexOf("*/*");
                            }

                            if (placeFirst > 0 && placeLast > 0)
                            {
                                BarcodeNoMaxSerial = BarcodeNoMax.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[1];
                                BarcodePrefix = BarcodeNoMax.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[0];
                                BarcodePostfix = BarcodeNoMax.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[2];
                                writeModel = "A";
                            }
                            else if (placeFirst > 0 && placeLast <= 0)
                            {
                                BarcodePrefix = BarcodeNoMax.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[0];
                                BarcodeNoMaxSerial = BarcodeNoMax.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[1];
                                BarcodePrefixSecond = BarcodeNoMaxSecond.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[0];
                                BarcodeNoMaxSerialSecond = BarcodeNoMaxSecond.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[1];

                                if (BarcodePrefix == BarcodePrefixSecond)
                                {
                                    writeModel = "B";
                                }
                                else
                                {
                                    writeModel = "C";
                                }

                            }
                            else if (placeFirst <= 0 && placeLast <= 0)
                            {
                                BarcodeNoMaxSerial = BarcodeNoMax.Split(splitStr1, StringSplitOptions.RemoveEmptyEntries)[1];
                                writeModel = "D";
                            }
                            int serialLength = BarcodeNoMaxSerial.Length;


                            #endregion


                            foreach (var item in barcodeListAdd)
                            {
                                string BarcodeNo = "";

                                int BarcodeQty = Convert.ToInt32(item);
                                if (BarcodeQty > 0)
                                {
                                    switch (writeModel)
                                    {
                                        case "A":
                                            BarcodeNo = BarcodePrefix + "*/*" + (Convert.ToInt32(BarcodeNoMaxSerial) + 1).ToString().PadLeft(serialLength, '0') + "*/*" + BarcodePostfix;
                                            BarcodeNoMaxSerial = (Convert.ToInt32(BarcodeNoMaxSerial) + 1).ToString();

                                            break;
                                        case "B":
                                            BarcodeNo = BarcodePrefix + "*/*" + (Convert.ToInt32(BarcodeNoMaxSerial) + 1).ToString().PadLeft(serialLength, '0');
                                            BarcodeNoMaxSerial = (Convert.ToInt32(BarcodeNoMaxSerial) + 1).ToString();

                                            break;
                                        case "C":
                                            BarcodeNo = (Convert.ToInt32(BarcodePrefix) + 1).ToString().PadLeft(serialLength, '0') + "*/*" + BarcodeNoMaxSerial;
                                            BarcodePrefix = (Convert.ToInt32(BarcodePrefix) + 1).ToString();

                                            break;
                                        case "D":
                                            BarcodeNo = "MWE-" + (Convert.ToInt32(BarcodeNoMaxSerial) + 1).ToString().PadLeft(serialLength, '0');
                                            BarcodeNoMaxSerial = (Convert.ToInt32(BarcodeNoMaxSerial) + 1).ToString();

                                            break;
                                        default:
                                            break;
                                    }

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, ParentBarcode
                                        , BarcodeProcessId, Memo, CurrentProdStatus, BarcodeStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeId
                                        VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @ParentBarcode
                                        , @BarcodeProcessId, @Memo, @CurrentProdStatus, @BarcodeStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeNo,
                                            CurrentMoProcessId = -1,
                                            NextMoProcessId = -1,
                                            MoId,
                                            BarcodeQty,
                                            ParentBarcode = nullDate,
                                            BarcodeProcessId = -1,
                                            Memo = nullDate,
                                            CurrentProdStatus = "P",
                                            BarcodeStatus = "8",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    int BarcodeId = 0;
                                    foreach (var item1 in insertResult)
                                    {
                                        BarcodeId = Convert.ToInt32(item1.BarcodeId);
                                    }


                                    dynamicParameters = new DynamicParameters(); // 待測試
                                    sql = @"INSERT INTO MES.MweBarcode (MweDetailId, BarcodeId, BarcodeQty, SourceType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MweDetailId, @BarcodeId, @BarcodeQty, @SourceType 
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MweDetailId,
                                            BarcodeId,
                                            BarcodeQty,
                                            SourceType = "MP",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                }
                            }
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMweERPConfirm -- 更新MES入庫單確認單據 -- Ted 2022-09-07
        public string UpdateMweERPConfirm(int MweId, int ConfirmModel)
        {
            try
            {
                List<MOCTH> mocths = new List<MOCTH>();
                List<MOCTI> moctis = new List<MOCTI>();

                List<string> seqList = new List<string>();

                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string dateNowMonth = DateTime.Now.ToString("yyyyMM");

                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                string UserNo = "";
                int Quantity = 0;

                int TotalScrapQty = 0;

                string MweErpPrefix = "";
                string MweErpNo = "";
                string DocDate = "";
                string ReceiptDate = "";
                DateTime ReceiptDateBase = default(DateTime);

                int rowsAffected = 0;
                var ErpNo = "";
                string ErpDbName = "";
                string USR_GROUP = "";
                int UserId = CreateBy;
                int CompanyIdBase = -1;
                string PickingListSet = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //撈取使用者No
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MoWarehouseEnryManagment");
                        if (ConfirmModel == 1)
                        {
                            dynamicParameters.Add("DetailCode", "confirm");
                        }
                        else if (ConfirmModel == 2)
                        {
                            dynamicParameters.Add("DetailCode", "confirm2");
                        }


                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        #region /撈取單頭資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MweErpPrefix,a.MweErpNo, ConfirmStatus, a.ReceiptDate ReceiptDateBase
                                ,FORMAT(ReceiptDate, 'yyyyMMdd') ReceiptDate
                                ,FORMAT(DocDate, 'yyyyMMdd') DocDate
                                FROM MES.MoWarehouseEnry a
                                WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var MweResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in MweResult)
                        {
                            if (item.ConfirmStatus == "Y") throw new SystemException("該入庫單據已經核單,不能確認");
                            if (item.ConfirmStatus == "V") throw new SystemException("該入庫單據已經作廢,不能確認");
                            MweErpPrefix = item.MweErpPrefix;
                            MweErpNo = item.MweErpNo;
                            DocDate = item.DocDate;
                            ReceiptDate = item.ReceiptDate;
                            ReceiptDateBase = item.ReceiptDateBase;
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //審核ERP權限
                        USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI06", "CONFIRM");
                        #endregion

                        #region //判斷開立日期是否超過結帳日
                        string CloseDateBase = "";
                        string DocDateBase = ReceiptDate;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MA013
                                FROM CMSMA ";
                        var resultCloseDate = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultCloseDate)
                        {
                            CloseDateBase = item.MA013;
                        }

                        DateTime docDateBase;
                        DateTime closeDateBase;

                        if (DateTime.TryParseExact(DocDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out docDateBase) &&
                            DateTime.TryParseExact(CloseDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out closeDateBase))
                        {
                            int resultDate = DateTime.Compare(docDateBase, closeDateBase);

                            if (resultDate <= 0)
                            {
                                throw new SystemException("【入庫單】ERP已經結帳,不可以在新增【" + CloseDateBase + "】之前的單據");
                            }
                        }
                        else
                        {
                            throw new SystemException("日期字符串无效，无法比较");
                        }
                        #endregion

                        #region //取出ERP托外入庫單據資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TH023,b.TI013,b.TI014 
                                FROM MOCTH a
                                INNER JOIN MOCTI b on a.TH001 = b.TI001 AND a.TH002 = b.TI002
                                WHERE a.TH001 = @MweErpPrefix
                                AND a.TH002 = @MweErpNo";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        dynamicParameters.Add("MweErpNo", MweErpNo);
                        var ErpMweResult1 = sqlConnection.Query(sql, dynamicParameters);
                        if (ErpMweResult1.Count() <= 0) throw new SystemException("找不到ERP入庫單據!");
                        foreach (var item in ErpMweResult1)
                        {
                            if (item.TH023 == "Y" || item.TH023 == "V") throw new SystemException("該入庫單據已經核單或作廢,不能確認");

                            #region //判斷入庫製令數量是否會超過該製令計畫數量
                            int ReceiptQtyAllERP = 0;
                            int PlanQtyErp = 0;
                            string OverGet = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT sum(TI007) ReceiptQtyAllERP,x.TA015,y.MQ056
                                    FROM MOCTI a
                                    OUTER APPLY(
                                        SELECT TA015 
                                        FROM MOCTA x1
                                        WHERE 1=1
                                        AND x1.TA001 = a.TI013
                                        AND x1.TA002 = a.TI014
                                    ) x
                                    OUTER APPLY
                                    (
                                        SELECT x1.MQ056
                                        FROM CMSMQ x1
                                        WHERE x1.MQ001=a.TI001
                                    ) y
                                    WHERE a.TI013 = @TI013
                                    AND a.TI014 = @TI014
                                    AND a.TI001 != '5902'
                                    AND a.TI037 !='V'
                                    GROUP BY x.TA015,y.MQ056";
                            dynamicParameters.Add("TI013", item.TI013);
                            dynamicParameters.Add("TI014", item.TI014);
                            var result1 = sqlConnection.Query(sql, dynamicParameters);

                            if (result1.Count() > 0)
                            {
                                foreach (var item1 in result1)
                                {
                                    ReceiptQtyAllERP = Convert.ToInt32(item1.ReceiptQtyAllERP);
                                    PlanQtyErp = Convert.ToInt32(item1.TA015);
                                    OverGet = item1.MQ056;
                                }
                                if (OverGet == "Y")
                                {
                                    if (ReceiptQtyAllERP > PlanQtyErp) throw new SystemException($"當前ERP入庫數量已經超入(含未確認),製令:{item.TI013}-{item.TI014}");
                                }
                            }
                            #endregion
                        }
                        #endregion

                        #region //撈取單據設定
                        string QuantityExceeds = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MQ056
                                    FROM CMSMQ 
                                    WHERE MQ001=@MweErpPrefix";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        var resultSetting = sqlConnection.Query(sql, dynamicParameters);
                        if (resultSetting.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                        foreach (var item in resultSetting)
                        {
                            PickingListSet = item.MQ056;
                        }
                        #endregion

                        #region //格尚核單邏輯
                        if (ConfirmModel == 2)
                        {
                            #region //ERP核單
                            #region //找出小數位數換算
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MF003
                                      FROM CMSMF
                                     WHERE MF001 = (SELECT MA003 FROM CMSMA)";
                            var resultMF003 = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMF003.Count() <= 0) throw new SystemException("找不到幣別小數位設定!!!");
                            int? MF003 = -1;
                            foreach (var item in resultMF003)
                            {
                                MF003 = Convert.ToInt32(item.MF003);
                            }
                            #endregion

                            #region //取出ERP托外入庫單據資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"
                                     SELECT TH001 AS D_A1
                                            ,TH002 AS D_A2
                                            ,TI003 AS D_A3 
                                            ,TH003 AS D_A4 
                                            ,TI004 AS D_B1 
                                            ,TI006 AS D_B2
                                            ,MB022 AS D_B3 
                                            ,ROUND(CAST(ISNULL(MB065/NULLIF(MB064, 0), 0) AS FLOAT), @MF003) AS D_B4
                                            ,CONVERT(varchar(12) ,DATEADD(d,MB023, convert(datetime, TH003)), 112) AS D_B5
                                            ,TI019*MQ010 AS D_D1 
                                            ,ROUND(CAST(ISNULL(MD004/MD003,1)AS FLOAT) ,@MF003) AS D_D3
                                            ,TI009 AS D_D4 
                                            ,TI010 AS D_D5 
                                            ,TI014 AS D_D6 
                                            ,TI017 AS D_D7 
                                            ,TI057 AS D_D8 
                                            ,TI012 AS D_O1
                                            ,MQ019 AS D_O3 
                                            ,MQ055 AS D_O4 
                                            ,MQ010 AS D_O5 
                                            ,MQ008 AS D_O6 
                                            ,MQ011 AS D_O7 
                                            ,MQ019 AS D_O8
                                            ,TI011 AS JMO_1
                                            ,TI040 AS JMO_2
                                            ,TI017 AS JMO_3
                                            ,TI013 AS JMO_4
                                            ,MQ054 AS JMO_5
                                            ,TH005 AS JMO_6
                                            ,TI018 AS JMO_7
                                            ,TI032 AS D_O9
                                            ,ROUND(CAST(ISNULL(y.LB010, 0 ) AS FLOAT), 0) AS LB010
                                    FROM MOCTH
                                    INNER JOIN MOCTI ON TH001=TI001 AND TH002=TI002
                                    INNER JOIN INVMB ON MB001=TI004
                                    INNER JOIN CMSMQ ON MQ001=TI001
                                    INNER JOIN CMSMC ON MC001=TI009
                                    LEFT JOIN INVMD ON MD001=TI008
                                    OUTER APPLY(
                                        SELECT TOP 1 LB010
                                        FROM INVLB 
                                        WHERE LB001 = TI004
                                        ORDER BY LB002 DESC
                                    ) y
                                    WHERE TH001 = @MweErpPrefix
                                      AND TH002 = @MweErpNo";
                            dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                            dynamicParameters.Add("MweErpNo", MweErpNo);
                            dynamicParameters.Add("MF003", MF003);
                            var ErpMweResult = sqlConnection.Query(sql, dynamicParameters);
                            if (ErpMweResult.Count() <= 0) throw new SystemException("找不到ERP入庫單據!");
                            #endregion

                            #region //先更新單據-->U, 確認中
                            //更新單頭確認碼=U
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTH
                                    SET TH023 = 'U'
                                    WHERE TH001 = @MweErpPrefix
                                    AND TH002 = @MweErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MweErpPrefix,
                                MweErpNo
                            });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTI
                                    SET TI037 = 'U'
                                    WHERE TI001 = @MweErpPrefix
                                    AND TI002 = @MweErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MweErpPrefix,
                                MweErpNo
                            });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //入庫相關欄位驗證+資料表新增異動 Confirm
                            foreach (var item in ErpMweResult)
                            {
                                #region //取出SQL欄位置到變數
                                string D_A1 = item.D_A1; //入庫單單別
                                string D_A2 = item.D_A2; //入庫單單號
                                string D_A3 = item.D_A3; //入庫單單身序號
                                string D_A4 = item.D_A4; //進貨日期
                                string D_B1 = item.D_B1; //品號
                                string D_B2 = item.D_B2; //規格
                                string D_B3 = item.D_B3; //批號管理
                                double D_B4 = Convert.ToDouble(item.D_B4);
                                string D_B5 = item.D_B5;
                                double D_D1 = Convert.ToDouble(item.D_D1);
                                double D_D3 = Convert.ToDouble(item.D_D3);
                                string D_D4 = item.D_D4; //進貨庫別
                                string D_D5 = item.D_D5 != null ? item.D_D5 : ""; //批號
                                string D_D6 = item.D_D6; //製令單號
                                int D_D7 = Convert.ToInt32(item.D_D7); //驗收包裝數量
                                string D_D8 = item.D_D8 != "" ? item.D_D8 : "##########"; //儲位
                                string D_O1 = item.D_O1; //複檢日期
                                string D_O3 = item.D_O3; //核對採購/製令/訂單/託工
                                string D_O4 = item.D_O4; //控制缺領
                                int D_O5 = Convert.ToInt32(item.D_O5); //庫存影響
                                string D_O6 = item.D_O6; //異動類別
                                string D_O7 = item.D_O7; //影響成本
                                string D_O8 = item.D_O8; //核對採購/製令/訂單/託工
                                string D_O9 = item.D_O9; //專案代號
                                string JMO_1 = item.JMO_1; //有效日期
                                string JMO_2 = item.JMO_2; //備註
                                double JMO_3 = Convert.ToDouble(item.JMO_3); //驗收包裝數量
                                string JMO_4 = item.JMO_4; //製令單別
                                string JMO_5 = item.JMO_5; //控制超領
                                string JMO_6 = item.JMO_6; //加工廠商
                                string JMO_7 = item.JMO_7; //驗收日
                                double LB010 = Convert.ToDouble(item.LB010); //單位成本
                                if (D_B3 != "N" && D_D5 == "") throw new SystemException($"入庫單({D_A1}-{D_A2}-{D_A3})缺少批號,請重新確認!");
                                #endregion

                                #region //判斷生產數量是否超過領料單可生產數量

                                #region //撈取單據缺領設定
                                string PickingListOutSet = "";
                                string PickingListInSet = "";
                                string WarnMessage = "";
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MQ055,MQ056
                                        FROM CMSMQ 
                                        WHERE MQ001=@MweErpPrefix";
                                dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                                var resultSetting1 = sqlConnection.Query(sql, dynamicParameters);
                                if (resultSetting1.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                                foreach (var item1 in resultSetting1)
                                {
                                    PickingListOutSet = item1.MQ055;
                                    PickingListInSet = item1.MQ056;
                                }
                                #endregion

                                #region //撈出該製令下材料領料單全部領料數並計算出目前可入庫的最大產品套數
                                List<string> caseNumList = new List<string>();
                                Double MakeNum = 0;
                                int num = 0;

                                #region //獲取ERP單據的材料和須領用量
                                int PlanQty = -1;
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(TB003)) TB003,SUM(TB004) TB004,TA015
                                        FROM MOCTB 
                                        INNER JOIN MOCTA on TA001 = TB001 AND TA002 = TB002
                                        WHERE TB001=@WoErpPrefix
                                        AND TB002 =@WoErpNo
                                        AND TB018 ='Y'
                                        AND TB011 !=3
                                        AND TB011 !=4
                                        AND TB004 !=0
                                        GROUP BY TB003,TA015";
                                dynamicParameters.Add("WoErpPrefix", JMO_4);
                                dynamicParameters.Add("WoErpNo", D_D6);
                                var result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                                foreach (var item1 in result)
                                {
                                    string caseArr = Convert.ToString(item1.TB004) + "," + item1.TB003;
                                    caseNumList.Add(caseArr);
                                    PlanQty = Convert.ToInt32(item1.TA015);
                                }
                                #endregion

                                foreach (var item1 in caseNumList)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TE027,sum(a.TE005*b.MQ010*-1) NumSet
                                            FROM MOCTE a
                                            INNER JOIN CMSMQ b on a.TE001 =b.MQ001 
                                            WHERE a.TE011=@WoErpPrefix
                                            AND a.TE012 =@WoErpNo
                                            AND a.TE027 =@MtlItemNo
                                            AND a.TE019 ='Y'
                                            Group by a.TE027";
                                    dynamicParameters.Add("WoErpPrefix", JMO_4);
                                    dynamicParameters.Add("WoErpNo", D_D6);
                                    dynamicParameters.Add("MtlItemNo", item1.Split(',')[1]);
                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0)
                                    {
                                        Double NumSet = 0;
                                        foreach (var item2 in result)
                                        {
                                            NumSet = Convert.ToDouble(item2.NumSet);
                                        }
                                        Double MaterialMtlItemNoNum = Convert.ToDouble(item1.Split(',')[0]);
                                        Double RatioOfMaterials = Math.Round(Convert.ToDouble(PlanQty / (MaterialMtlItemNoNum / NumSet)), 2);
                                        RatioOfMaterials = RatioOfMaterials > 0 ? Math.Floor(RatioOfMaterials) : Math.Ceiling(RatioOfMaterials);
                                        if (num == 0)
                                        {
                                            MakeNum = RatioOfMaterials;
                                        }
                                        else
                                        {
                                            //這段意思是 如果該品號是多種材料組成的 會以 可領的最小套數當最大套數
                                            if (MakeNum > RatioOfMaterials)
                                            {
                                                MakeNum = RatioOfMaterials;
                                            }
                                        }
                                        num++;
                                    }
                                    else
                                    {
                                        #region //判斷入庫數是否有超過領料套數
                                        switch (PickingListOutSet)
                                        {
                                            case "Y":
                                                WarnMessage += "【入庫單】－材料:" + item1.Split(',')[1] + "未領取,不能入庫<br>";
                                                break;
                                        }
                                        #endregion
                                    }

                                }
                                if (WarnMessage != "") throw new SystemException(WarnMessage);
                                #endregion

                                #region //ERP撈出該製令下已入庫產品數量(核單)
                                int EnterNum = 0;
                                int PassNum = 0;
                                int NgQtyErp = 0;
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(sum(TI007),0) ReceiptQtyAllERP,ISNULL(sum(TI019),0) TINUM1, ISNULL(sum(TI021),0) TINUM2
                                        FROM MOCTI 
                                        WHERE TI013=@WoErpPrefix
                                        AND TI014 =@WoErpNo
                                        AND TI001 != '5902'
                                        AND TI037 ='Y'";
                                dynamicParameters.Add("WoErpPrefix", JMO_4);
                                dynamicParameters.Add("WoErpNo", D_D6);
                                var result1 = sqlConnection.Query(sql, dynamicParameters);
                                if (result1.Count() <= 0) throw new SystemException("工單製令有問題!");
                                foreach (var item1 in result1)
                                {
                                    EnterNum = Convert.ToInt32(item1.TINUM);
                                    PassNum = Convert.ToInt32(item1.TINUM1);
                                    NgQtyErp = Convert.ToInt32(item1.TINUM2);
                                }
                                #endregion

                                #region //判斷入庫數是否有超過領料套數
                                switch (PickingListOutSet)
                                {
                                    case "Y":
                                        if (MakeNum < D_D1 * D_D3) throw new SystemException("【入庫單】－請確認該製令是否有料未領取!!!或是領料單據有核單了嗎?");
                                        break;
                                    case "N":
                                        if (MakeNum < D_D1 * D_D3) WarnMessage = "【單據設定不控制缺領】生產數量超過領料單可生產數量,領料不足!!!!!!!!";
                                        break;
                                    case "W":
                                        if (MakeNum < D_D1 * D_D3) WarnMessage = "【單據設定警告缺領】生產數量超過領料單可生產數量,領料不足!";
                                        break;
                                }
                                #endregion

                                #endregion


                                dynamicParameters = new DynamicParameters();
                                string Supplier = "";
                                sql = @"SELECT MA002 FROM PURMA 
                                        WHERE MA001 = @JMO_6";
                                dynamicParameters.Add("JMO_6", JMO_6);
                                var PURMAResult = sqlConnection.Query(sql, dynamicParameters);
                                if (PURMAResult.Count() <= 0) throw new SystemException("找不到加工廠商!");
                                foreach (var item3 in PURMAResult)
                                {
                                    Supplier = item3.MA002;
                                }

                                //check_invmc_yn(D_B1, D_D4)
                                CheckInvmcYn(D_B1, D_D4,
                                             UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP);
                                #region //Data Validation
                                if (!CheckLotYn(D_B3, D_D5).Equals("Y"))
                                {
                                    throw new SystemException("品號需做批號管理,請補入正確批號");
                                }
                                else if (!CheckLotQty(D_B1, D_D5, D_D4, D_D1, D_D7, sqlConnection, "MOCTH").Equals("Y") && D_B3.Equals("Y"))
                                {
                                    throw new SystemException("批號庫存數量(或包裝數)不足");
                                }
                                else if (!CheckStoQty(D_B1, D_D4, D_D1, D_D7, sqlConnection, D_O5).Equals("Y"))
                                {
                                    throw new SystemException("庫別庫存數量(或包裝數)不足");
                                }
                                else if (!CheckMocYn("MOCTH", D_O3, JMO_4, D_D6, sqlConnection).Equals("Y"))
                                {
                                    throw new SystemException("製令單號空白,請補入製令單號");
                                }
                                //else if (!CheckMocQty(D_B1, JMO_4, D_D6, D_D1, JMO_5, sqlConnection, "", -1, -1, sqlConnection).Equals("Y"))
                                //{
                                //    throw new SystemException("製令超領!");
                                //}
                                else
                                {

                                    if (!D_B3.Equals("N"))
                                    {
                                        #region //新增庫存批號檔
                                        rowsAffected += InsertInvmef(D_B1, D_D5, JMO_7, D_A1, D_A2, JMO_1,
                                                                     D_O1, D_A3, D_D4, D_O5, D_O6, D_D1 * D_D3, JMO_4, D_D6,
                                                                     UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK
                                        rowsAffected += InsertInvlf(D_A1, D_A2, D_A3, D_B1, D_D4,
                                                                    D_D8, D_D5, D_O5, JMO_7, D_O6,
                                                                    D_D1 * D_D3, D_D7, D_D6, JMO_4, D_D6,
                                                                    UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK
                                        rowsAffected += InsertInvmm(D_B1, D_D4, D_D8, D_D5, D_D1 * D_D3,
                                                                    Convert.ToDouble(JMO_3), JMO_7,
                                                                    UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //問題待確認
                                        #endregion
                                    }

                                    if (D_O9 != null && D_O9 != "")
                                    {
                                        #region //新增品號專案管理檔
                                        rowsAffected += InsertInvld(D_O9, D_B1, D_A4, D_O5, D_A1,
                                                                     D_A2, D_A3, D_D4, D_O6, D_D1, LB010,
                                                                     Math.Round(D_D1 * D_D3 * LB010, 0), D_D6, D_D7,
                                                                     UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK
                                        #endregion
                                    }

                                    rowsAffected += InsertInvla(D_B1, JMO_7, D_O5, D_A1, D_A2,
                                                                    D_A3, D_D4, JMO_2, D_D1 * D_D3, D_D1 * D_D3 * LB010,
                                                                    Math.Round(D_D1 * D_D3 * LB010, 0), D_O6, D_O7, D_D5, D_D7,
                                                                    "", JMO_4, D_D6, Supplier,
                                                                    UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK
                                    rowsAffected += UpdateInvmb(D_B1, D_D1 * D_D3, D_D1 * D_D3 * LB010,
                                                        UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK

                                    rowsAffected += UpdateInvmc(D_B1, D_D1 * D_D3, D_D1 * D_D3 * LB010, D_D4, D_A4,
                                                        UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK

                                    #region //更新製令入庫數量 OK
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE a
                                            SET a.MODIFIER = @MODIFIER,
                                                a.MODI_DATE = @MODI_DATE,
                                                a.MODI_TIME = @MODI_TIME,
                                                a.MODI_AP = @MODI_AP,
                                                a.MODI_PRID = @MODI_PRID,
                                                a.FLAG = a1.FLAG + 1,
                                                a.TA017 = a1.TA017 + b.TI019 * 1,
                                                a.TA018 = a1.TA018 + b.TI021 * 1
                                            FROM MOCTA a
                                            INNER JOIN MOCTA a1 ON a.TA001 = a1.TA001
                                                               AND a.TA002 = a1.TA002 
                                            INNER JOIN MOCTI b ON b.TI013 = a1.TA001 
                                                               AND b.TI014 = a1.TA002 
                                                               AND b.TI001 = @D_A1 
                                                               AND b.TI002 = @D_A2 
                                                               AND b.TI003 = @D_A3;
                                        ";
                                    dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MODIFIER = UserNo,
                                        MODI_DATE = dateNow,
                                        MODI_TIME = timeNow,
                                        MODI_AP = BaseHelper.ClientComputer(),
                                        MODI_PRID = "BM",
                                        D_A1,
                                        D_A2,
                                        D_A3
                                    });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //判斷是否製令是否已經完工
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TA011,TA014,TA015,TA017,TA018
                                            FROM MOCTA
                                            INNER JOIN MOCTI on TI013 = TA001  AND TI014=TA002 AND TI001= @D_A1 AND TI002= @D_A2 AND  TI003 = @D_A3
                                            ";
                                    dynamicParameters.Add("D_A1", D_A1);
                                    dynamicParameters.Add("D_A2", D_A2);
                                    dynamicParameters.Add("D_A3", D_A3);
                                    var MOCTAResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (MOCTAResult.Count() <= 0) throw new SystemException("找不到ERP入庫單據!");
                                    foreach (var item3 in MOCTAResult)
                                    {
                                        if (item3.TA011 == "Y" || item3.TA011 == "y") throw new SystemException("製令已經結案不可以再入庫!");
                                        int resultDate = -1;
                                        if (item3.TA014 != "")
                                        {
                                            DateTime BaseCompletionDay = DateTime.ParseExact(item3.TA014, "yyyyMMdd", null);
                                            DateTime CompletionDay = DateTime.ParseExact(D_A4, "yyyyMMdd", null);
                                            resultDate = DateTime.Compare(BaseCompletionDay, CompletionDay);

                                        }

                                        if (item3.TA015 <= (item3.TA017 + item3.TA018))
                                        {
                                            #region //更新實際完工日 製令完工
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MOCTA
                                                       SET TA011 = @TA011,
                                                           TA014 = @D_A4
                                                      FROM MOCTA
                                                     INNER JOIN MOCTI on TI013 = TA001  AND TI014=TA002 AND TI001= @D_A1 AND TI002= @D_A2 AND TI003 = @D_A3
                                            ";
                                            dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                TA011 = item3.TA011 != "y" ? "Y" : "y",
                                                D_A1,
                                                D_A2,
                                                D_A3,
                                                D_A4 = resultDate < 0 ? D_A4 : item3.TA014
                                            });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                        else
                                        {
                                            #region //更新實際完工日 製令生產中
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MOCTA
                                                       SET TA011 = '3',
                                                           TA014 = @D_A4
                                                      FROM MOCTA
                                                     INNER JOIN MOCTI on TI013 = TA001  AND TI014=TA002 AND TI001= @D_A1 AND TI002= @D_A2 AND TI003 = @D_A3
                                            ";
                                            dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                TA011 = item.TA011 != "y" ? "3" : "y",
                                                D_A1,
                                                D_A2,
                                                D_A3,
                                                D_A4 = resultDate < 0 ? D_A4 : item3.TA014
                                            });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                    }
                                    #endregion

                                    #region //更新-入庫單身核單
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MOCTI
                                               SET MODIFIER =@MODIFIER,
                                                   MODI_DATE= @MODI_DATE,
                                                   MODI_TIME= @MODI_TIME,
                                                   MODI_AP= @MODI_AP,
                                                   MODI_PRID= @MODI_PRID,
                                                   FLAG= FLAG + 1,
                                                   TI037 = 'Y',
                                                   TI043 = @TI043
                                            WHERE TI001 =@D_A1 
                                            AND TI002 =@D_A2 
                                            AND TI003 =@D_A3 
                                            ";
                                    dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MODIFIER = UserNo,
                                        MODI_DATE = dateNow,
                                        MODI_TIME = timeNow,
                                        MODI_AP = BaseHelper.ClientComputer(),
                                        MODI_PRID = "BM",
                                        TI043 = UserNo,
                                        D_A1,
                                        D_A2,
                                        D_A3
                                    });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                }
                                #endregion
                            }
                            #endregion

                            #region //更新-入庫單據核單
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTH
                                       SET MODIFIER =@MODIFIER,
                                           MODI_DATE= @MODI_DATE,
                                           MODI_TIME= @MODI_TIME,
                                           MODI_AP= @MODI_AP,
                                           MODI_PRID= @MODI_PRID,
                                           FLAG= FLAG + 1,
                                           TH023 = 'Y'
                                     WHERE TH001 =@MweErpPrefix 
                                       AND TH002 =@MweErpNo 
                                            ";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = UserNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = BaseHelper.ClientComputer(),
                                MODI_PRID = "BM",
                                MweErpPrefix,
                                MweErpNo
                            });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                            #endregion
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //取得入庫單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MweDetailId,a.MoId,a.MtlItemId,a.InventoryId
                                ,a.MweSeq,a.LotNumber,a.AcceptQty CompleteQty,a.ScriptQty
                                ,a1.LotManagement
                                FROM MES.MweDetail a
                                INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);
                        var resultMweDetail = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //更新ManufactureOrder CompleteQty & ScrapQty,新增批號資料
                        foreach (var item in resultMweDetail)
                        {
                            int MweDetailId = Convert.ToInt32(item.MweDetailId);
                            int MoId = Convert.ToInt32(item.MoId);
                            int MtlItemId = Convert.ToInt32(item.MtlItemId);
                            int InventoryId = Convert.ToInt32(item.InventoryId);
                            int ScrapQty = Convert.ToInt32(item.ScriptQty);
                            int CompleteQty = Convert.ToInt32(item.CompleteQty);
                            string MweSeq = item.MweSeq;
                            string LotManagement = item.LotManagement;
                            string LotNumber = item.LotNumber;

                            #region //批號資料相關
                            if (LotManagement != "N")
                            {
                                #region //確認此品號是否已存在此批號
                                int LotNumberId = -1;

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 LotNumberId
                                    FROM SCM.LotNumber a 
                                    WHERE a.MtlItemId = @MtlItemId
                                    AND a.LotNumberNo = @LotNumberNo";
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                dynamicParameters.Add("LotNumberNo", LotNumber);

                                var LotNumberResult = sqlConnection.Query(sql, dynamicParameters);

                                if (LotNumberResult.Count() <= 0)
                                {
                                    #region //INSERT 批號單頭
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO SCM.LotNumber (MtlItemId, LotNumberNo, FirstRecriptDate, FromErpPrefix, FromErpNo
                                            , CloseStatus, Remark, TransferStatus, TransferDate
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.LotNumberId
                                            VALUES (@MtlItemId, @LotNumberNo, @FirstRecriptDate, @FromErpPrefix, @FromErpNo
                                            , @CloseStatus, @Remark, @TransferStatus, @TransferDate
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemId,
                                            LotNumberNo = LotNumber,
                                            FirstRecriptDate = ReceiptDateBase,
                                            FromErpPrefix = MweErpPrefix,
                                            FromErpNo = MweErpNo,
                                            CloseStatus = "N",
                                            Remark = "",
                                            TransferStatus = "Y",
                                            TransferDate = CreateDate,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion

                                    foreach (var item1 in insertResult)
                                    {
                                        LotNumberId = item1.LotNumberId;
                                    }

                                    #region //INSERT 批號單身
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO SCM.LnDetail (LotNumberId, TransactionDate, FromErpPrefix,FromErpNo,FromSeq
                                    ,InventoryId,TransactionType,DocType,Quantity,Remark
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@LotNumberId, @TransactionDate, @FromErpPrefix,@FromErpNo,@FromSeq
                                    ,@InventoryId,@TransactionType,@DocType,@Quantity,@Remark
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            LotNumberId,
                                            TransactionDate = ReceiptDateBase,
                                            FromErpPrefix = MweErpPrefix,
                                            FromErpNo = MweErpNo,
                                            FromSeq = MweSeq,
                                            InventoryId,
                                            TransactionType = 1,
                                            DocType = 1,
                                            Quantity = CompleteQty,
                                            Remark = "",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion
                                }
                                else
                                {
                                    foreach (var item1 in LotNumberResult)
                                    {
                                        LotNumberId = item1.LotNumberId;
                                    }

                                    #region //INSERT 批號單身
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO SCM.LnDetail (LotNumberId, TransactionDate, FromErpPrefix,FromErpNo,FromSeq
                                    ,InventoryId,TransactionType,DocType,Quantity,Remark
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@LotNumberId, @TransactionDate, @FromErpPrefix,@FromErpNo,@FromSeq
                                    ,@InventoryId,@TransactionType,@DocType,@Quantity,@Remark
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            LotNumberId,
                                            TransactionDate = ReceiptDateBase,
                                            FromErpPrefix = MweErpPrefix,
                                            FromErpNo = MweErpNo,
                                            FromSeq = MweSeq,
                                            InventoryId,
                                            TransactionType = 1,
                                            DocType = 1,
                                            Quantity = CompleteQty,
                                            Remark = "",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult1.Count();
                                    #endregion
                                }
                                #endregion

                                #region //取得入庫條碼綁定批號
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a1.BarcodeNo
                                        FROM MES.MweBarcode a
                                        INNER JOIN MES.Barcode a1 on a.BarcodeId = a1.BarcodeId
                                        WHERE a.MweDetailId = @MweDetailId";
                                dynamicParameters.Add("MweDetailId", MweDetailId);
                                var resultMweBarcode = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item1 in resultMweBarcode)
                                {
                                    #region //條碼綁定批號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO SCM.LnBarcode (LotNumberId,BarcodeNo
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.LnBarcodeId
                                        VALUES (@LotNumberId, @BarcodeNo
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            LotNumberId,
                                            BarcodeNo = item1.BarcodeNo,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion

                            }
                            #endregion

                            #region //更新ManufactureOrder CompleteQty
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.ManufactureOrder SET
                                    CompleteQty =CompleteQty + @CompleteQty
                                    WHERE MoId = @MoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    CompleteQty,
                                    MoId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //更新 MoProcess.WipQty
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TotalInputQty,a.MoProcessId 
                                    FROM MES.MoProcess a
                                    WHERE a.SortNumber = (SELECT MAX(x.SortNumber) SortNumber FROM MES.MoProcess x WHERE  x.MoId = @MoId) 
                                    AND  a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            int? TotalInputQty = -1;
                            int? MoProcessId = -1;
                            foreach (var item2 in result3)
                            {
                                TotalInputQty = Convert.ToInt32(item2.TotalInputQty);
                                MoProcessId = Convert.ToInt32(item2.MoProcessId);
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT sum(ReceiptQty) nowReceiptQty 
                                    FROM MES.MweDetail 
                                    WHERE MoId = @MoId
                                    AND ConfirmStatus != 'V'";
                            dynamicParameters.Add("MoId", MoId);
                            result3 = sqlConnection.Query(sql, dynamicParameters);
                            int? nowReceiptQty = -1;
                            foreach (var item2 in result3)
                            {
                                nowReceiptQty = Convert.ToInt32(item2.nowReceiptQty);
                            }
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ScrapQty 
                                    FROM MES.ManufactureOrder 
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            var totScraptResult = sqlConnection.Query(sql, dynamicParameters);
                            if (totScraptResult.Count() <= 0) throw new SystemException("入庫更新在製時找不到制令-Error!!!");
                            foreach (var item2 in totScraptResult)
                            {
                                TotalScrapQty = Convert.ToInt32(item2.ScrapQty);
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoProcess SET
                                    WipQty = @nowReceiptQty - WipQty - @TotalScrapQty
                                    WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    nowReceiptQty,
                                    TotalScrapQty,
                                    MoProcessId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //判斷入庫數量是否超過製令預計產量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT SUM( b.ReceiptQty) ReceiptQtyAll,a.Quantity,a.[Status] 
                                    FROM MES.ManufactureOrder a
                                    INNER JOIN MES.MweDetail b on a.MoId = b.MoId
                                    INNER JOIN MES.MoWarehouseEnry b1 on b.MweId = b1.MweId
                                    WHERE a.MoId =@MoId
                                    AND b1.ConfirmStatus !='V'
                                    GROUP BY a.Quantity,a.[Status] ";
                            dynamicParameters.Add("MoId", MoId);

                            var resultCompleteQty = sqlConnection.Query(sql, dynamicParameters);
                            if (resultCompleteQty.Count() > 0)
                            {
                                int ReceiptQtyAll = -1;
                                int MoIdQuantityBase = -1;
                                string MoIdStatusBase = "";
                                foreach (var item2 in resultCompleteQty)
                                {
                                    ReceiptQtyAll = Convert.ToInt32(item2.ReceiptQtyAll);
                                    MoIdQuantityBase = Convert.ToInt32(item2.Quantity);
                                    MoIdStatusBase = item2.Status;
                                }

                                if (ReceiptQtyAll > MoIdQuantityBase)
                                {
                                    if (PickingListSet == "Y") throw new SystemException("總入庫數量已經超過MES製令產量了!請重新確認");
                                }
                                else if (ReceiptQtyAll == MoIdQuantityBase)
                                {
                                    #region //入庫數量跟預計產量相等 就將MES製令狀態改完工
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.ManufactureOrder SET
                                                        [Status] = 'F',
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        WHERE MoId = @MoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            LastModifiedDate,
                                            LastModifiedBy = UserId,
                                            MoId
                                        });
                                    var MoStatusFinish = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion
                                }
                                else if (ReceiptQtyAll < MoIdQuantityBase)
                                {
                                    #region //入庫數量小於預計產量 就將MES製令狀態改加工中
                                    if (MoIdStatusBase == "F")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.ManufactureOrder SET
                                                            [Status] = 'A',
                                                            LastModifiedDate = @LastModifiedDate,
                                                            LastModifiedBy = @LastModifiedBy
                                                            WHERE MoId = @MoId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                LastModifiedDate,
                                                LastModifiedBy = UserId,
                                                MoId
                                            });
                                        var MoStatusFinish = sqlConnection.Query(sql, dynamicParameters);
                                    }
                                    #endregion
                                }
                            }
                            #endregion

                        }
                        #endregion

                        #region //鼎薪核單API
                        if (ConfirmModel == 1)
                        {
                            #region //取得MES.MoWarehouseEnry(MOCTH)
                            dynamicParameters = new DynamicParameters();
                            sqlQuery.mainKey = "a.MweId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.MweErpPrefix TH001, a.MweErpNo TH002, FORMAT(a.DocDate, 'yyyyMMdd') TH029, FORMAT(a.ReceiptDate, 'yyyyMMdd') TH003 , a.FactoryCode TH004
                              , a.SupplierId, a.SupplierSo TH006, a.Remark TH010, a.Quantity TH022, a.PackageQuantity TH034, a.SupplierPicking TH035, a.ReserveTaxCode TH037, a.QcFlag TH061, a.FlowStatus
                              , a.ConfirmStatus TH023, FORMAT(a.TransferDate, 'yyyyMMdd') TransferDate, a.Quantity TH022, a.TransferStatus, a.CompanyId
                              , b.SupplierNo TH005
                              , c.UserNo CreateUserNo";
                            sqlQuery.mainTables =
                                @"FROM MES.MoWarehouseEnry a
                              INNER JOIN SCM.Supplier b ON a.SupplierId = b.SupplierId
                              INNER JOIN BAS.[User] c ON a.CreateBy = c.UserId";
                            sqlQuery.auxTables = "";
                            string queryCondition = @"AND a.MweId = @MweId";
                            dynamicParameters.Add("MweId", MweId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            mocths = BaseHelper.SqlQuery<MOCTH>(sqlConnection, dynamicParameters, sqlQuery);
                            if (mocths.Count() <= 0) throw new SystemException("入庫單資料有誤!");
                            foreach (var item in mocths)
                            {
                                MweErpPrefix = item.TH001;
                                MweErpNo = item.TH002;
                                CompanyIdBase = item.CompanyId;
                            }
                            if (CompanyIdBase != CurrentCompany) throw new SystemException("使用者公司別與單據公司別不同，請嘗試重新登入!!");
                            #endregion

                            #region //取得MES.MweDetail(MOCTI)
                            dynamicParameters = new DynamicParameters();

                            sqlQuery.mainKey = "a.MweDetailId";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.MweId, a.MtlItemId, a.UomId, a.InventoryId, a.MweSeq TI003,
                              FORMAT(a.AvailableDate, 'yyyyMMdd') TI011, FORMAT(a.ReCheckDate, 'yyyyMMdd') TI012, a.MoId,
                              FORMAT(a.AcceptanceDate, 'yyyyMMdd') TI018,
                              a.ReceiptQty TI007, a.AcceptQty TI019, a.AvailableQty TI020, a.ScriptQty TI021, a.ReturnQty TI022, a.OrigUnitPrice TI024, a.OrigAmount TI025,
                              a.OrigDiscountAmt TI026, a.ReceiptExpense TI027, a.OrigPreTaxAmt TI044, a.OrigTaxAmt TI045, a.PreTaxAmt TI046, a.TaxAmt TI047, a.DiscountDescription TI028,
                              a.Remark TI040, a.LotNumber TI010, a.ProjectCode TI032, a.ProcessCode TI015, a.QcStatus TI035, a.Overdue TI034, a.ReserveTaxCode TI052, a.PaymentHold TI033,
                              a.TransferStatus TI054, a.ReturnCode TI036, a.ConfirmStatus TI037, a.CloseStatus TI038, a.ReNewStatus TI039, a.CostEntry TI041, a.ExpenseEntry TI042, a.ApproveStatus TI053,
                              a.ReceiptPackageQty TI016, a.AcceptancePackageQty TI017, 
                              b.MweErpPrefix TI001,b.MweErpNo TI002,
                              c.MtlItemNo TI004,c.MtlItemName TI005,c.MtlItemSpec TI006,
                              d.UomNo TI008,
                              e.InventoryNo TI009,
                              g.WoErpPrefix TI013,g.WoErpNo TI014";
                            sqlQuery.mainTables =
                                @"FROM MES.MweDetail a
                              INNER JOIN MES.MoWarehouseEnry b ON a.MweId = b.MweId
                              INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
                              INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                              INNER JOIN SCM.Inventory e ON a.InventoryId = e.InventoryId
                              INNER JOIN MES.ManufactureOrder f ON a.MoId = f.MoId
                              INNER JOIN MES.WipOrder g ON f.WoId = g.WoId";
                            sqlQuery.auxTables = "";
                            queryCondition = @"AND a.MweId = @MweId";
                            dynamicParameters.Add("MweId", MweId);
                            sqlQuery.conditions = queryCondition;
                            sqlQuery.orderBy = "";

                            moctis = BaseHelper.SqlQuery<MOCTI>(sqlConnection, dynamicParameters, sqlQuery);
                            if (moctis.Count() <= 0) throw new SystemException("入庫單單身資料有誤!");
                            #endregion

                            string COMPANY = ErpDbName;

                            string TYPE = "MOCI06";
                            string DOC = MweErpPrefix;
                            string DOC_NO = MweErpNo;
                            string TRANS = "1";
                            //string USER = "TESTER";
                            string USER = UserNo;
                            string DATE = DateTime.Now.ToString("yyyyMMdd");
                            //COMPANY = "ZY01";
                            //USER = "TESTER";

                            var result = BaseHelper.TransferErpAPI(COMPANY, TYPE, DOC, DOC_NO, TRANS, USER, DATE);

                            #region //若成功則將相關資料寫回MES
                            var resultJson = JToken.Parse(result);
                            string CODE = resultJson["CODE"].ToString();
                            string ERROR_CODE = resultJson["ERROR_CODE"].ToString(); //錯誤代碼
                            if (CODE == "200")
                            {
                                #region //查詢UserNo
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.UserId
                                FROM BAS.[User] a
                                WHERE a.UserNo = @UserNo";
                                dynamicParameters.Add("UserNo", UserNo);

                                var userMESResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in userMESResult)
                                {
                                    UserId = Convert.ToInt32(item.UserId);
                                }
                                #endregion

                                #region //入庫單單頭確認
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MoWarehouseEnry SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    TransferStatus = @TransferStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MweId = @MweId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      ConfirmStatus = "Y",
                                      ConfirmUserId = UserId,
                                      TransferStatus = "Y",
                                      LastModifiedDate,
                                      LastModifiedBy = UserId,
                                      MweId
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //入庫單單身確認
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MweDetail SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MweId = @MweId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ConfirmStatus = "Y",
                                        ConfirmUserId = UserId,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        MweId,
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //Response
                                jsonResponse = JObject.FromObject(new
                                {
                                    status = "success",
                                    msg = "拋轉成功!"
                                });
                                #endregion
                            }
                            else
                            {
                                //逐一檢查核單失敗可能原因
                                using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                                {
                                    #region //1.產品製令單領料不足
                                    foreach (var item in moctis)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT LTRIM(RTRIM(SUM(a.TE005))) TENUM
                                                        FROM MOCTE a
                                                        WHERE a.TE011 = @TE011
                                                        AND a.TE012 = @TE012";
                                        dynamicParameters.Add("TE011", item.TI013);
                                        dynamicParameters.Add("TE012", item.TI014);

                                        var result3 = sqlConnection2.Query(sql, dynamicParameters);
                                        double? TENUM = -1;
                                        foreach (var item2 in result3)
                                        {
                                            TENUM = Convert.ToDouble(item2.TENUM);
                                        }

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT LTRIM(RTRIM(SUM(a.TI007))) TINUM
                                                        FROM MOCTI a
                                                        WHERE a.TI013 = @TI013
                                                        AND a.TI014 = @TI014
                                                        AND TI001 != '5902'
                                                        ";
                                        dynamicParameters.Add("TI013", item.TI013);
                                        dynamicParameters.Add("TI014", item.TI014);

                                        result3 = sqlConnection2.Query(sql, dynamicParameters);
                                        double? TINUM = -1;
                                        foreach (var item2 in result3)
                                        {
                                            TINUM = Convert.ToDouble(item2.TINUM);
                                        }
                                        if (Convert.ToDouble(TINUM) > Convert.ToDouble(TENUM))
                                        {
                                            throw new SystemException("確認失敗，此產品製令單領料不足【" + item.TI013 + "-" + item.TI014 + "】庫存不足!");
                                        }

                                    }
                                    #endregion

                                    #region //2.驗收數量未驗收完
                                    foreach (var item in moctis)
                                    {
                                        if (Convert.ToDouble(item.TI007) > Convert.ToDouble(item.TI019 + item.TI021 + item.TI022))
                                        {
                                            throw new SystemException("確認失敗，有單身數量未驗收完!");

                                        }
                                    }

                                    #endregion

                                    #region //3.已關帳
                                    string CloseStatus = "";
                                    foreach (var item in moctis)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT LTRIM(RTRIM(a.TI038)) TI038
                                                        FROM MOCTI a
                                                        WHERE a.TI001 = @TI001
                                                        AND a.TI002 = @TI002";
                                        dynamicParameters.Add("TI001", item.TI001);
                                        dynamicParameters.Add("TI002", item.TI002);
                                        #endregion
                                        CloseStatus = sqlConnection2.QueryFirstOrDefault(sql, dynamicParameters).TI038;
                                    }
                                    if (CloseStatus == "Y")
                                    {
                                        throw new SystemException("確認失敗，請聯繫資訊人員進行問題排解!");

                                    }

                                    throw new SystemException("確認失敗，請聯繫資訊人員進行問題排解!");
                                }
                            }
                            #endregion
                        }
                        else if (ConfirmModel == 2)
                        {

                            #region //入庫單單頭確認
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoWarehouseEnry SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    TransferStatus = @TransferStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MweId = @MweId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ConfirmStatus = "Y",
                                  ConfirmUserId = CurrentUser,
                                  TransferStatus = "Y",
                                  LastModifiedDate,
                                  LastModifiedBy = CurrentUser,
                                  MweId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //入庫單單身確認
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MweDetail SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MweId = @MweId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "Y",
                                    ConfirmUserId = CurrentUser,
                                    LastModifiedDate,
                                    LastModifiedBy = CurrentUser,
                                    MweId,
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "核單成功!"
                            });
                            #endregion
                        }
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();

        }
        #endregion

        #region //UpdateMweReconfirm --入庫單反確認 -- Ted 2022-09-07
        public string UpdateMweReconfirm(int MweId, int ConfirmModel)
        {
            try
            {
                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string dateNowMonth = DateTime.Now.ToString("yyyyMM");
                string timeNow = DateTime.Now.ToString("HH:mm:ss");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    string MweErpPrefix = "";
                    string MweErpNo = "";
                    string ReceiptDate = "";
                    int rowsAffected = 0;
                    int? nulldata = null;

                    var ErpNo = "";
                    string ErpDbName = "";
                    string USR_GROUP = "";
                    string UserNo = "";
                    int CompanyIdBase = -1;
                    int QuantityExceeds = -1;

                    //int ConfirmModel = 1; //入庫單反核單方式 1.鼎新 2.格尚


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //撈取使用者No
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MoWarehouseEnryManagment");
                        if (ConfirmModel == 1)
                        {
                            dynamicParameters.Add("DetailCode", "reconfirm");
                        }
                        else if (ConfirmModel == 2)
                        {
                            dynamicParameters.Add("DetailCode", "reconfirm2");
                        }

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        #region //判斷入庫單單頭是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.ConfirmStatus, a.MweErpPrefix, a.MweErpNo, a.CompanyId,FORMAT(ReceiptDate, 'yyyyMMdd') ReceiptDate
                                FROM MES.MoWarehouseEnry a
                                WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單資料有誤!");

                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "Y") throw new SystemException("入庫單非確認狀態!");
                            MweErpPrefix = item.MweErpPrefix;
                            MweErpNo = item.MweErpNo;
                            CompanyIdBase = item.CompanyId;
                            ReceiptDate = item.ReceiptDate;
                        }
                        if (CompanyIdBase != CurrentCompany) throw new SystemException("使用者公司別與單據公司別不同，請嘗試重新登入!!");

                        #endregion

                        #region //判斷入庫單單身是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ConfirmStatus,a.MoId,a.MweDetailId
                                FROM MES.MweDetail a
                                WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("找不到入庫單單身，請重新確認！！!");
                        foreach (var item in result)
                        {
                            #region //判斷該入庫單的條碼是否有被移轉
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MoId,c.MoId FROM MES.MweBarcode a
                                    INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                    INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                                    WHERE b.MoId != c.MoId
                                    AND b.MweDetailId = @MweDetailId";
                            dynamicParameters.Add("MweDetailId", item.MweDetailId);
                            var resultTransfer = sqlConnection.Query(sql, dynamicParameters);
                            if (resultTransfer.Count() > 0)
                            {
                                throw new SystemException("入庫單的條碼已經有被移轉不可以反確認");
                            }
                            #endregion

                            #region //判斷該入庫單的條碼是否有做入庫後拆併盤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT x.MergeFrom,y.MergeTo FROM MES.MweBarcode a
                                    INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                    OUTER APPLY(
                                        SELECT TOP 1 1 MergeFrom FROM MES.BarcodeMergeLog x1
                                        WHERE x1.FromBarcodeId = a.BarcodeId
                                        AND x1.FromMoId = b.MoId
                                    ) x
                                    OUTER APPLY(
                                        SELECT TOP 1 1 MergeTo FROM MES.BarcodeMergeLog y1
                                        WHERE y1.FromBarcodeId = a.BarcodeId
                                        AND y1.FromMoId = b.MoId
                                    ) y
                                    WHERE b.MweDetailId =  @MweDetailId";
                            dynamicParameters.Add("MweDetailId", item.MweDetailId);
                            var resultMerge = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMerge.Count() > 0)
                            {
                                foreach (var item1 in resultMerge)
                                {
                                    if (item1.MergeFrom != null && item1.MergeTo != null) throw new SystemException("入庫單已經有做過拆併盤動作不可以反確認");
                                }
                            }
                            #endregion
                        }
                        #endregion

                        if (ConfirmModel == 1)
                        {
                            #region //更新ManufactureOrder CompleteQty & ScrapQty

                            #region //取得入庫單單身
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MweDetailId
                                        FROM MES.MweDetail a
                                        WHERE a.MweId = @MweId";
                            dynamicParameters.Add("MweId", MweId);
                            var resultMweDetail = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            foreach (var item in resultMweDetail)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.AcceptQty CompleteQty,a.ScriptQty,a.ReceiptQty,a.MoId
                                            FROM MES.MweDetail a
                                            WHERE a.MweDetailId = @MweDetailId";
                                dynamicParameters.Add("MweDetailId", item.MweDetailId);
                                var MoQuantityResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MoQuantityResult.Count() > 0)
                                {
                                    int MoId = 0;
                                    int CompleteQty = 0;
                                    int ScrapQty = 0;
                                    int ReceiptQty = 0;
                                    foreach (var item1 in MoQuantityResult)
                                    {
                                        MoId = Convert.ToInt32(item1.MoId);
                                        CompleteQty = Convert.ToInt32(item1.CompleteQty);
                                        ScrapQty = Convert.ToInt32(item1.ScriptQty);
                                        ReceiptQty = Convert.ToInt32(item1.ReceiptQty);

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.ManufactureOrder SET
                                                CompleteQty =CompleteQty - @CompleteQty
                                                WHERE MoId = @MoId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                CompleteQty,
                                                MoId
                                            });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                        #region //更新 MoProcess.WipQty
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.MoProcessId 
                                            FROM MES.MoProcess a
                                            WHERE a.SortNumber = (SELECT MAX(x.SortNumber) SortNumber FROM MES.MoProcess x WHERE  x.MoId = @MoId) 
                                            AND  a.MoId = @MoId";
                                        dynamicParameters.Add("MoId", MoId);
                                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                                        int? MoProcessId = -1;
                                        foreach (var item3 in result3)
                                        {
                                            MoProcessId = Convert.ToInt32(item3.MoProcessId);
                                        }
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.MoProcess SET
                                                WipQty = @CompleteQty + WipQty
                                                WHERE MoProcessId = @MoProcessId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                CompleteQty,
                                                MoProcessId
                                            });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //判斷入庫數量是否超過製令預計產量
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT SUM( b.ReceiptQty) ReceiptQtyAll,a.Quantity,a.[Status] 
                                                FROM MES.ManufactureOrder a
                                                LEFT JOIN MES.MweDetail b on a.MoId = b.MoId
                                                WHERE a.MoId =@MoId
                                                AND b.ConfirmStatus = 'Y'
                                                GROUP BY a.Quantity,a.[Status] ";
                                        dynamicParameters.Add("MoId", MoId);

                                        var resultCompleteQty = sqlConnection.Query(sql, dynamicParameters);
                                        if (resultCompleteQty.Count() > 0)
                                        {
                                            int? ReceiptQtyAll = -1;
                                            int? MoIdQuantityBase = -1;
                                            string MoIdStatusBase = "";
                                            foreach (var item2 in resultCompleteQty)
                                            {
                                                ReceiptQtyAll = Convert.ToInt32(item2.ReceiptQtyAll);
                                                MoIdQuantityBase = Convert.ToInt32(item2.Quantity);
                                                MoIdStatusBase = item2.Status;
                                            }
                                            if (ReceiptQtyAll > MoIdQuantityBase)
                                            {
                                                QuantityExceeds = 1;
                                                //throw new SystemException("總入庫數量已經超過MES製令產量了!請重新確認");
                                            }
                                            else if (ReceiptQtyAll == MoIdQuantityBase)
                                            {
                                                #region //入庫數量跟預計產量相等 就將MES製令狀態改完工
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE MES.ManufactureOrder SET
                                                        [Status] = 'F',
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        WHERE MoId = @MoId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        MoId
                                                    });
                                                var MoStatusFinish = sqlConnection.Query(sql, dynamicParameters);
                                                #endregion
                                            }
                                            else if (ReceiptQtyAll < MoIdQuantityBase)
                                            {
                                                #region //入庫數量小於預計產量 就將MES製令狀態改加工中
                                                if (MoIdStatusBase == "F")
                                                {
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"UPDATE MES.ManufactureOrder SET
                                                            [Status] = 'A',
                                                            LastModifiedDate = @LastModifiedDate,
                                                            LastModifiedBy = @LastModifiedBy
                                                            WHERE MoId = @MoId";
                                                    dynamicParameters.AddDynamicParams(
                                                        new
                                                        {
                                                            LastModifiedDate,
                                                            LastModifiedBy,
                                                            MoId
                                                        });
                                                    var MoStatusFinish = sqlConnection.Query(sql, dynamicParameters);
                                                }
                                                #endregion
                                            }
                                        }
                                        else
                                        {
                                            #region //入庫數量小於預計產量 就將MES製令狀態改加工中
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.ManufactureOrder SET
                                                    [Status] = 'A',
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE MoId = @MoId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    LastModifiedDate,
                                                    LastModifiedBy,
                                                    MoId
                                                });
                                            var MoStatusFinish = sqlConnection.Query(sql, dynamicParameters);
                                            #endregion
                                        }
                                        #endregion
                                    }
                                }
                            }
                            #endregion
                        }
                        else if (ConfirmModel == 2)
                        {

                        }
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷開立日期是否超過結帳日
                        string CloseDateBase = "";
                        string DocDateBase = ReceiptDate;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MA013
                                FROM CMSMA ";
                        var resultCloseDate = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultCloseDate)
                        {
                            CloseDateBase = item.MA013;
                        }

                        DateTime docDateBase;
                        DateTime closeDateBase;

                        if (DateTime.TryParseExact(DocDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out docDateBase) &&
                            DateTime.TryParseExact(CloseDateBase, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out closeDateBase))
                        {
                            int resultDate = DateTime.Compare(docDateBase, closeDateBase);

                            if (resultDate <= 0)
                            {
                                throw new SystemException("【入庫單】ERP已經結帳,不可以在新增【" + CloseDateBase + "】之前的單據");
                            }
                        }
                        else
                        {
                            throw new SystemException("日期字符串无效，无法比较");
                        }
                        #endregion


                        #region //結帳碼判定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TI038
                                FROM MOCTI 
                                WHERE TI001=@MweErpPrefix
                                AND TI002=@MweErpNo";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        dynamicParameters.Add("MweErpNo", MweErpNo);
                        var resultCloseStatus = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultCloseStatus)
                        {
                            if (item.TI038 == "Y") throw new SystemException("【入庫單】－單據目前已經結帳不可以異動!!!");
                        }
                        #endregion

                        #region //撈取單據設定
                        if (QuantityExceeds == 1)
                        {
                            string PickingListSet = "";
                            string WarnMessage = "成功";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MQ056
                                    FROM CMSMQ 
                                    WHERE MQ001=@MweErpPrefix";
                            dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                            var resultSetting = sqlConnection.Query(sql, dynamicParameters);
                            if (resultSetting.Count() <= 0) throw new SystemException("【入庫單】－ERP製令單據有問題");
                            foreach (var item in resultSetting)
                            {
                                PickingListSet = item.MQ056;
                            }
                            switch (PickingListSet)
                            {
                                case "Y":
                                    if (QuantityExceeds == 1) throw new SystemException("總入庫數量已經製令產量了!請重新確認!!");
                                    break;
                                case "N":
                                    WarnMessage = "【單據設定不控制超入】生產數量超過製令預計產量!!!!!!!!";
                                    break;
                                case "W":
                                    WarnMessage = "【單據設定警告超入】生產數量超過製令預計產量!!!!";
                                    break;
                            }
                        }
                        #endregion


                        if (ConfirmModel == 2)
                        {
                            //if (ConfirmModel == 2) throw new SystemException("格尚核單邏輯尚未開放,請找系統開發室人員確認!!!");

                            #region //找出小數位數換算
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MF003
                                    FROM CMSMF
                                    WHERE MF001 = (SELECT MA003 FROM CMSMA)";
                            var resultMF003 = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMF003.Count() <= 0) throw new SystemException("找不到幣別小數位設定!!!");
                            int? MF003 = -1;
                            foreach (var item in resultMF003)
                            {
                                MF003 = Convert.ToInt32(item.MF003);
                            }
                            #endregion

                            #region //取出ERP托外入庫單據資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"
                                    SELECT TH001 AS D_A1
                                        ,TH002 AS D_A2
                                        ,TI003 AS D_A3 
                                        ,TH003 AS D_A4 
                                        ,TI004 AS D_B1 
                                        ,TI006 AS D_B2
                                        ,MB022 AS D_B3 
                                        ,ROUND(CAST(ISNULL(MB065/NULLIF(MB064, 0), 0) AS FLOAT), @MF003) AS D_B4
                                        ,CONVERT(varchar(12) ,DATEADD(d,MB023, convert(datetime, TH003)), 112) AS D_B5
                                        ,TI019*MQ010 AS D_D1 
                                        ,ROUND(CAST(ISNULL(MD004/MD003,1)AS FLOAT) ,@MF003) AS D_D3
                                        ,TI009 AS D_D4 
                                        ,TI010 AS D_D5 
                                        ,TI014 AS D_D6 
                                        ,TI017 AS D_D7 
                                        ,TI057 AS D_D8 
                                        ,TI012 AS D_O1
                                        ,MQ019 AS D_O3 
                                        ,MQ055 AS D_O4 
                                        ,MQ010 AS D_O5 
                                        ,MQ008 AS D_O6 
                                        ,MQ011 AS D_O7 
                                        ,MQ019 AS D_O8
                                        ,TI011 AS JMO_1
                                        ,TI040 AS JMO_2
                                        ,TI017 AS JMO_3
                                        ,TI013 AS JMO_4
                                        ,TI018 AS JMO_5
                                        ,ROUND(CAST(ISNULL(y.LB010, 0 ) AS FLOAT), 0) LB010
                                FROM MOCTH
                                INNER JOIN MOCTI ON TH001=TI001 AND TH002=TI002
                                INNER JOIN INVMB ON MB001=TI004
                                INNER JOIN CMSMQ ON MQ001=TI001
                                INNER JOIN CMSMC ON MC001=TI009
                                LEFT JOIN INVMD ON MD001=TI008
                                OUTER APPLY(
                                    SELECT TOP 1 LB010
                                    FROM INVLB 
                                    WHERE LB001 = TI004
                                    ORDER BY LB002 DESC
                                ) y
                                WHERE TH001 = @MweErpPrefix
                                    AND TH002 = @MweErpNo";
                            dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                            dynamicParameters.Add("MweErpNo", MweErpNo);
                            dynamicParameters.Add("MF003", MF003);
                            var ErpMweResult = sqlConnection.Query(sql, dynamicParameters);
                            if (ErpMweResult.Count() <= 0) throw new SystemException("找不到ERP入庫單據!");
                            #endregion

                            #region //先更新單據-->U, 確認中
                            //更新單頭確認碼=U
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTH
                                    SET TH023 = 'U'
                                    WHERE TH001 = @MweErpPrefix
                                    AND TH002 = @MweErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MweErpPrefix,
                                MweErpNo
                            });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTI
                                    SET TI037 = 'U'
                                    WHERE TI001 = @MweErpPrefix
                                    AND TI002 = @MweErpNo";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MweErpPrefix,
                                MweErpNo
                            });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //入庫單身確認 ReConfirm
                            foreach (var item in ErpMweResult)
                            {
                                #region //取出SQL欄位置到變數
                                string D_A1 = item.D_A1;
                                string D_A2 = item.D_A2;
                                string D_A3 = item.D_A3;
                                string D_A4 = item.D_A4;
                                string D_B1 = item.D_B1;
                                string D_B2 = item.D_B2;
                                string D_B3 = item.D_B3;
                                double D_B4 = Convert.ToDouble(item.D_B4);
                                string D_B5 = item.D_B5;
                                double D_D1 = Convert.ToDouble(item.D_D1);
                                double D_D3 = Convert.ToDouble(item.D_D3);
                                string D_D4 = item.D_D4;
                                string D_D5 = item.D_D5 != null ? item.D_D5 : "";
                                string D_D6 = item.D_D6;
                                int D_D7 = Convert.ToInt32(item.D_D7);
                                string D_D8 = item.D_D8;
                                string D_O1 = item.D_O1;
                                string D_O3 = item.D_O3;
                                string D_O4 = item.D_O4;
                                int D_O5 = Convert.ToInt32(item.D_O5);
                                string D_O6 = item.D_O6;
                                string D_O7 = item.D_O7;
                                string D_O8 = item.D_O8;
                                string JMO_1 = item.JMO_1;
                                string JMO_2 = item.JMO_2;
                                double JMO_3 = Convert.ToDouble(item.JMO_3);
                                string JMO_4 = item.JMO_4;
                                string JMO_5 = item.JMO_5; //驗收日
                                double LB010 = Convert.ToDouble(item.LB010); //單位成本
                                #endregion

                                if (!D_B3.Equals("N"))
                                {
                                    #region //批號相關Table異動
                                    rowsAffected += DelInvmef(D_B1, D_D5, JMO_5, D_A1, D_A2,
                                                                D_A3,
                                                                UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK
                                    rowsAffected += DelInvlf(D_A1, D_A2, D_A3, D_B1, D_D4,
                                                                D_D8, D_D5,
                                                                UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK
                                    rowsAffected += InsertInvmm(D_B1, D_D4, D_D8, D_D5, D_D1 * D_D3 * -1,
                                                                Convert.ToDouble(JMO_3) * -1, JMO_5,
                                                                UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //問題待確認
                                    #endregion
                                }

                                #region //判斷該品號庫存是否足夠
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MC007
                                        FROM INVMC a
                                        WHERE a.MC001 = @MC001
                                        AND a.MC002 = @MC002
                                        ";
                                dynamicParameters.Add("MC001", D_B1);
                                dynamicParameters.Add("MC002", D_D4);
                                var INVMCResult = sqlConnection.Query(sql, dynamicParameters);
                                if (INVMCResult.Count() > 0)
                                {
                                    foreach (var item1 in INVMCResult)
                                    {
                                        if (Convert.ToInt32(item1.MC007) < D_D1 * D_D3) throw new SystemException("庫存不足不能執行反確認,請重新確認");
                                    }
                                }
                                else
                                {
                                    throw new SystemException("庫存不足不能執行反確認,請重新確認");
                                }
                                #endregion

                                rowsAffected += DelInvla(D_B1, JMO_5, D_O5, D_A1, D_A2,
                                                            D_A3,
                                                            UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK
                                rowsAffected += UpdateInvmb(D_B1, D_D1 * D_D3 * -1, D_D1 * D_D3 * LB010 * -1,
                                                    UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK

                                rowsAffected += UpdateInvmc(D_B1, D_D1 * D_D3 * -1, D_D1 * D_D3 * LB010 * -1, D_D4, "",
                                                    UserNo, "MOCTH", ErpNo, sqlConnection, USR_GROUP); //OK


                                #region //更新製令入庫數量 OK
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE a
                                            SET a.MODIFIER = @MODIFIER,
                                                a.MODI_DATE = @MODI_DATE,
                                                a.MODI_TIME = @MODI_TIME,
                                                a.MODI_AP = @MODI_AP,
                                                a.MODI_PRID = @MODI_PRID,
                                                a.FLAG = a1.FLAG + 1,
                                                a.TA017 = a1.TA017 + b.TI019 * -1,
                                                a.TA018 = a1.TA018 + b.TI021 * -1
                                            FROM MOCTA a
                                            INNER JOIN MOCTA a1 ON a.TA001 = a1.TA001
                                                               AND a.TA002 = a1.TA002 
                                            INNER JOIN MOCTI b ON b.TI013 = a1.TA001 
                                                               AND b.TI014 = a1.TA002 
                                                               AND b.TI001 = @D_A1 
                                                               AND b.TI002 = @D_A2 
                                                               AND b.TI003 = @D_A3;
                                        ";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = UserNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = BaseHelper.ClientComputer(),
                                    MODI_PRID = "BM",
                                    D_A1,
                                    D_A2,
                                    D_A3
                                });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //判斷製令是否指定結案
                                var TA011 = "";
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TA011
                                                FROM MOCTA 
                                                INNER JOIN MOCTI on TI013 = TA001  AND TI014=TA002 AND TI001= @D_A1 AND TI002= @D_A2 AND TI003 = @D_A3
                                        ";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    D_A1,
                                    D_A2,
                                    D_A3,
                                });
                                var TA011Result = sqlConnection.Query(sql, dynamicParameters);
                                foreach (var item4 in TA011Result)
                                {
                                    TA011 = item4.TA011;
                                }
                                #endregion


                                #region //判斷是否製令是否已經完工
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 b.TH003
                                        FROM MOCTI a
                                        INNER JOIN MOCTH b on a.TI001 = b.TH001 AND a.TI002 = b.TH002
                                        WHERE a.TI013 = @JMO_4
                                        AND a.TI014 = @D_D6
                                        AND b.TH023 = 'Y'
                                        ORDER BY b.TH003 DESC
                                        ";
                                dynamicParameters.Add("JMO_4", JMO_4);
                                dynamicParameters.Add("D_D6", D_D6);
                                var MOCTAResult = sqlConnection.Query(sql, dynamicParameters);
                                if (MOCTAResult.Count() > 0) //存在其他入庫單
                                {

                                    foreach (var item3 in MOCTAResult)
                                    {
                                        #region //更新實際完工日
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MOCTA
                                                  SET TA011 = @TA011,
                                                      TA014 = @D_A4
                                                FROM MOCTA 
                                                INNER JOIN MOCTI on TI013 = TA001  AND TI014=TA002 AND TI001= @D_A1 AND TI002= @D_A2 AND TI003 = @D_A3
                                        ";
                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            TA011 = TA011 != "y" ? "3" : "y",
                                            D_A1,
                                            D_A2,
                                            D_A3,
                                            D_A4 = item3.TH003
                                        });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                                else //沒有其他入庫單
                                {
                                    #region //更新實際完工日
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MOCTA
                                            SET TA011 = @TA011,
                                                TA014 = @D_A4
                                            FROM MOCTA 
                                            INNER JOIN MOCTI on TI013 = TA001  AND TI014=TA002 AND TI001= @D_A1 AND TI002= @D_A2 AND TI003 = @D_A3
                                        ";
                                    dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        TA011 = TA011 != "y" ? "2" : "y",
                                        D_A1,
                                        D_A2,
                                        D_A3,
                                        D_A4 = ""
                                    });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion

                                #region //更新-入庫單身核單
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MOCTI
                                        SET MODIFIER =@MODIFIER,
                                            MODI_DATE= @MODI_DATE,
                                            MODI_TIME= @MODI_TIME,
                                            MODI_AP= @MODI_AP,
                                            MODI_PRID= @MODI_PRID,
                                            FLAG= FLAG + 1,
                                            TI037 = 'N'
                                            WHERE TI001 =@D_A1 
                                            AND TI002 =@D_A2 
                                            AND TI003 =@D_A3 
                                            ";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = UserNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = BaseHelper.ClientComputer(),
                                    MODI_PRID = "BM",
                                    D_A1,
                                    D_A2,
                                    D_A3,
                                });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //更新-入庫單據核單
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTH
                                       SET MODIFIER =@MODIFIER,
                                           MODI_DATE= @MODI_DATE,
                                           MODI_TIME= @MODI_TIME,
                                           MODI_AP= @MODI_AP,
                                           MODI_PRID= @MODI_PRID,
                                           FLAG= FLAG + 1,
                                           TH023 = 'N'
                                     WHERE TH001 =@MweErpPrefix 
                                       AND TH002 =@MweErpNo 
                                            ";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = UserNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = BaseHelper.ClientComputer(),
                                MODI_PRID = "BM",
                                MweErpPrefix,
                                MweErpNo
                            });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                        }
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        if (ConfirmModel == 1)
                        {
                            #region //進行反確認
                            string postUrl = "http://192.168.20.50/WEBAPI_8200441589/DOTRANS";
                            JObject postDataJson = new JObject();
                            postDataJson = JObject.FromObject(new
                            {
                                COMPANY = ErpDbName,
                                TYPE = "MOCI06",
                                DOC = MweErpPrefix,
                                DOC_NO = MweErpNo,
                                TRANS = "2",
                                //USER = "TESTER",
                                USER = UserNo,
                                DATE = DateTime.Now.ToString("yyyyMMdd")
                            });
                            string postData = postDataJson.ToString();
                            UTF8Encoding uTF8 = new UTF8Encoding();
                            var result2 = BaseHelper.PostWebRequest(postUrl, postData, uTF8);
                            #endregion

                            #region //若成功則將相關資料寫回MES
                            var resultJson = JToken.Parse(result2);
                            string CODE = resultJson["CODE"].ToString();
                            string ERROR_CODE = resultJson["ERROR_CODE"].ToString(); //錯誤代碼
                            if (CODE == "200")
                            {
                                #region //更新 - 入庫單單頭
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MoWarehouseEnry SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ReConfirmStatus = @ReConfirmStatus,
                                    TransferStatus = @TransferStatus,
                                    TransferDate = @TransferDate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MweId = @MweId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      ConfirmStatus = "N",
                                      ReConfirmStatus = "Y",
                                      TransferStatus = "Y",
                                      TransferDate = nulldata,
                                      LastModifiedDate,
                                      LastModifiedBy,
                                      MweId
                                  });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //更新 - 入庫單單身
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MweDetail SET
                                    TransferStatus = 'Y',
                                    ConfirmStatus = @ConfirmStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MweId = @MweId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      ConfirmStatus = "N",
                                      LastModifiedDate,
                                      LastModifiedBy,
                                      MweId
                                  });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                            }
                            else
                            {
                                throw new SystemException("反確認失敗!錯誤代碼:" + ERROR_CODE + "");
                            }
                            #endregion
                        }
                        else if (ConfirmModel == 2)
                        {

                            #region //若成功則將相關資料寫回MES
                            #region //更新 - 入庫單單頭
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoWarehouseEnry SET
                                ConfirmStatus = @ConfirmStatus,
                                ReConfirmStatus = @ReConfirmStatus,
                                TransferStatus = @TransferStatus,
                                TransferDate = @TransferDate,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "N",
                                    ReConfirmStatus = "Y",
                                    TransferStatus = "Y",
                                    TransferDate = nulldata,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MweId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //更新 - 入庫單單身
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MweDetail SET
                                TransferStatus = 'Y',
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "N",
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MweId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion



                            #region //取得入庫單單身
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MweDetailId,a.MoId,a.MtlItemId,a.InventoryId
                                ,a.MweSeq,a.LotNumber,a.AcceptQty CompleteQty,a.ScriptQty
                                ,a1.LotManagement
                                FROM MES.MweDetail a
                                INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                WHERE a.MweId = @MweId";
                            dynamicParameters.Add("MweId", MweId);
                            var resultMweDetail = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //更新ManufactureOrder CompleteQty & ScrapQty
                            foreach (var item in resultMweDetail)
                            {
                                int MweDetailId = Convert.ToInt32(item.MweDetailId);
                                int MoId = Convert.ToInt32(item.MoId);
                                int MtlItemId = Convert.ToInt32(item.MtlItemId);
                                int InventoryId = Convert.ToInt32(item.InventoryId);
                                int ScrapQty = Convert.ToInt32(item.ScriptQty);
                                int CompleteQty = Convert.ToInt32(item.CompleteQty);
                                string MweSeq = item.MweSeq;
                                string LotManagement = item.LotManagement;
                                string LotNumber = item.LotNumber;

                                #region //批號資料相關
                                if (LotManagement != "N")
                                {
                                    #region //確認此品號是否已存在此批號
                                    int LotNumberId = -1;

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 LotNumberId
                                            FROM SCM.LotNumber a 
                                            WHERE a.MtlItemId = @MtlItemId
                                            AND a.LotNumberNo = @LotNumberNo";
                                    dynamicParameters.Add("MtlItemId", MtlItemId);
                                    dynamicParameters.Add("LotNumberNo", LotNumber);

                                    var LotNumberResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (LotNumberResult.Count() > 0)
                                    {
                                        foreach (var item1 in LotNumberResult)
                                        {
                                            LotNumberId = item1.LotNumberId;
                                        }

                                        #region //DELETE 批號單頭
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE SCM.LnDetail 
                                                WHERE LotNumberId = @LotNumberId";
                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            LotNumberId
                                        });
                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //DELETE 批號單頭
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE SCM.LnBarcode 
                                                WHERE LotNumberId = @LotNumberId";
                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            LotNumberId
                                        });
                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 LotNumberId
                                            FROM SCM.LnDetail a 
                                            WHERE a.LotNumberId = @LotNumberId";
                                        dynamicParameters.Add("LotNumberId", LotNumberId);

                                        var LnDetailResult = sqlConnection.Query(sql, dynamicParameters);
                                        if (LnDetailResult.Count() <= 0)
                                        {
                                            #region //DELETE 批號單頭
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"DELETE SCM.LotNumber 
                                                    WHERE LotNumberId = @LotNumberId";
                                            dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                LotNumberId
                                            });
                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //更新ManufactureOrder CompleteQty
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.ManufactureOrder SET
                                            CompleteQty =CompleteQty - @CompleteQty
                                            WHERE MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        CompleteQty,
                                        MoId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //更新 MoProcess.WipQty
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoProcessId 
                                        FROM MES.MoProcess a
                                        WHERE a.SortNumber = (SELECT MAX(x.SortNumber) SortNumber FROM MES.MoProcess x WHERE  x.MoId = @MoId) 
                                        AND  a.MoId = @MoId";
                                dynamicParameters.Add("MoId", MoId);
                                var result3 = sqlConnection.Query(sql, dynamicParameters);
                                int? MoProcessId = -1;
                                foreach (var item3 in result3)
                                {
                                    MoProcessId = Convert.ToInt32(item3.MoProcessId);
                                }

                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MoProcess SET
                                            WipQty = @CompleteQty + WipQty
                                            WHERE MoProcessId = @MoProcessId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        CompleteQty,
                                        MoProcessId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //判斷入庫數量是否超過製令預計產量
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT SUM( b.ReceiptQty) ReceiptQtyAll,a.Quantity,a.[Status] 
                                            FROM MES.ManufactureOrder a
                                            LEFT JOIN MES.MweDetail b on a.MoId = b.MoId
                                            WHERE a.MoId =@MoId
                                            AND b.ConfirmStatus = 'Y'
                                            GROUP BY a.Quantity,a.[Status] ";
                                dynamicParameters.Add("MoId", MoId);

                                var resultCompleteQty = sqlConnection.Query(sql, dynamicParameters);
                                if (resultCompleteQty.Count() > 0)
                                {
                                    int? ReceiptQtyAll = -1;
                                    int? MoIdQuantityBase = -1;
                                    string MoIdStatusBase = "";
                                    foreach (var item2 in resultCompleteQty)
                                    {
                                        ReceiptQtyAll = Convert.ToInt32(item2.ReceiptQtyAll);
                                        MoIdQuantityBase = Convert.ToInt32(item2.Quantity);
                                        MoIdStatusBase = item2.Status;
                                    }
                                    if (ReceiptQtyAll > MoIdQuantityBase)
                                    {
                                        throw new SystemException("總入庫數量已經超過MES製令產量了!請重新確認");
                                    }
                                    else if (ReceiptQtyAll == MoIdQuantityBase)
                                    {
                                        #region //入庫數量跟預計產量相等 就將MES製令狀態改完工
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.ManufactureOrder SET
                                                    [Status] = 'F',
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE MoId = @MoId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                MoId
                                            });
                                        var MoStatusFinish = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion
                                    }
                                    else if (ReceiptQtyAll < MoIdQuantityBase)
                                    {
                                        #region //入庫數量小於預計產量 就將MES製令狀態改加工中
                                        if (MoIdStatusBase == "F")
                                        {
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.ManufactureOrder SET
                                                        [Status] = 'A',
                                                        LastModifiedDate = @LastModifiedDate,
                                                        LastModifiedBy = @LastModifiedBy
                                                        WHERE MoId = @MoId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    LastModifiedDate,
                                                    LastModifiedBy,
                                                    MoId
                                                });
                                            var MoStatusFinish = sqlConnection.Query(sql, dynamicParameters);
                                        }
                                        #endregion
                                    }
                                }
                                else
                                {
                                    #region //入庫數量小於預計產量 就將MES製令狀態改加工中
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.ManufactureOrder SET
                                                [Status] = 'A',
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE MoId = @MoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            MoId
                                        });
                                    var MoStatusFinish = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion
                            }
                            #endregion
                            #endregion

                        }
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "反確認成功"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateReConfirmStatus --入庫單重新編輯 -- Ted 2023-03-10
        public string UpdateReConfirmStatus(int MweId = -1)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷入庫單單頭是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.ReConfirmStatus
                                FROM MES.MoWarehouseEnry a
                                WHERE a.MweId = @MweId
                                AND a.CompanyId = @CompanyId";
                        dynamicParameters.Add("MweId", MweId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單資料有誤!");

                        foreach (var item in result)
                        {
                            if (item.ReConfirmStatus != "N") throw new SystemException("【入庫單重新編輯功能】該單據位必須曾經有反確認過並且重新拋轉後才能使用");
                        }
                        #endregion

                        #region //更新 - 入庫單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoWarehouseEnry SET
                                ReConfirmStatus = @ReConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId
                                AND CompanyId = @CompanyId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ReConfirmStatus = "Y",
                              LastModifiedDate,
                              LastModifiedBy,
                              MweId,
                              CompanyId = CurrentCompany
                          });
                        var rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "入庫單可以重新編輯了!"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMweVoid --入庫單作廢-- Shintokuro 2023-09-13
        public string UpdateMweVoid(int MweId, int OperateUserId, int OperateCompanyId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");

                    string ErpNo = "";
                    string ErpDbName = "";
                    string UserNo = "";
                    string USR_GROUP = "";

                    string MweErpPrefix = "";
                    string MweErpNo = "";
                    int rowsAffected = 0;
                    int MoIdBase = 0;



                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        List<int> MweBarcodeIdList = new List<int>();


                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //撈取使用者No
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", OperateUserId);
                        dynamicParameters.Add("CompanyId", OperateCompanyId);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MoWarehouseEnryManagment");
                        dynamicParameters.Add("DetailCode", "void");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        #region //判斷入庫單單頭是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.ConfirmStatus, a.MweErpPrefix, a.MweErpNo
                                FROM MES.MoWarehouseEnry a
                                WHERE a.MweId = @MweId
                                AND a.CompanyId = @CompanyId";
                        dynamicParameters.Add("MweId", MweId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單資料有誤!");

                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus == "Y")
                            {
                                string jsonString = UpdateMweReconfirm(MweId, 2);
                                dynamic jsonObject = JsonConvert.DeserializeObject(jsonString);

                                string status = jsonObject.status;
                                string message = jsonObject.msg;
                                if (status == "errorForDA")
                                {
                                    throw new SystemException("【反確認失敗】：" + message + "無法執行作廢功能!");
                                }
                                else
                                {
                                    Console.WriteLine("Other Status");
                                }
                            }
                            else if (item.ConfirmStatus == "V")
                            {
                                throw new SystemException("【入庫單作廢功能】該單據位已經做廢了！");
                            }
                            MweErpPrefix = item.MweErpPrefix;
                            MweErpNo = item.MweErpNo;
                        }
                        #endregion

                        #region //找出入庫單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MweDetailId,a.MoId,LabelStatus
                                FROM MES.MweDetail a
                                WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);
                        var resultMweDetail = sqlConnection.Query(sql, dynamicParameters);
                        if (resultMweDetail.Count() <= 0) throw new SystemException("入庫單資料有誤!");
                        foreach (var item in resultMweDetail)
                        {
                            MoIdBase = item.MoId;
                        }
                        #endregion

                        foreach (var item in resultMweDetail)
                        {
                            if (item.LabelStatus == "A") throw new SystemException("該入庫單有單身已經印製出標籤，無法刪除!");

                            #region //判斷該入庫單的條碼是否有被移轉
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MoId,c.MoId FROM MES.MweBarcode a
                                            INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                            INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                                            WHERE b.MoId != c.MoId
                                            AND b.MweDetailId = @MweDetailId";
                            dynamicParameters.Add("MweDetailId", item.MweDetailId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                throw new SystemException("入庫單的條碼已經有被移轉不可以作廢");
                            }
                            #endregion

                            #region //判斷入庫單單身是否有綁定產品條碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId,b.BarcodeNo
                                    FROM MES.MweBarcode a
                                    INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                    WHERE a.MweDetailId = @MweDetailId";
                            dynamicParameters.Add("MweDetailId", item.MweDetailId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item2 in result)
                                {
                                    MweBarcodeIdList.Add(item2.BarcodeId);
                                }

                                #region //刪除入庫單單身綁定的條碼
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE FROM MES.MweBarcode
                                        WHERE MweDetailId = @MweDetailId";
                                dynamicParameters.Add("MweDetailId", item.MweDetailId);
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                foreach (var MweBarcodeId in MweBarcodeIdList)
                                {


                                    #region //判斷條碼是屬於加工結束還是強制結束
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT d.BarcodeNo,d.CurrentProdStatus, c.MoProcessId,c.ProcessAlias,e.ProdStatus
                                            FROM MES.WipOrder a
                                            LEFT JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
	                                        LEFT JOIN MES.MoProcess c ON b.MoId = c.MoId
	                                        LEFT JOIN MES.Barcode d ON b.MoId = d.MoId
	                                        LEFT JOIN MES.BarcodeProcess e ON d.BarcodeId = e.BarcodeId AND c.MoProcessId = e.MoProcessId
                                            WHERE b.MoId = @MoId
                                            AND d.BarcodeId = @BarcodeId
                                            AND d.CurrentProdStatus in ('P','M','R','RW')
                                            AND c.NecessityStatus = 'Y'
                                            AND e.ProdStatus is null";
                                    dynamicParameters.Add("MoId", MoIdBase);
                                    dynamicParameters.Add("BarcodeId", MweBarcodeId);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0)
                                    {
                                        #region //條碼狀態更新 - 強制結束
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode SET
                                                BarcodeStatus = @BarcodeStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BarcodeId = @BarcodeId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BarcodeStatus = "7",
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                BarcodeId = MweBarcodeId
                                            });
                                        var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion
                                    }
                                    else
                                    {
                                        #region //條碼狀態更新 - 加工結束
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode SET
                                                BarcodeStatus = @BarcodeStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BarcodeId = @BarcodeId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BarcodeStatus = "0",
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                BarcodeId = MweBarcodeId
                                            });
                                        var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion
                                    }
                                    #endregion

                                    #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改8
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponent a 
                                            INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                            WHERE a.AssemblyBarcodeId = @BarcodeId
                                            AND b.MoId = @MoId";
                                    dynamicParameters.Add("BarcodeId", MweBarcodeId);
                                    dynamicParameters.Add("MoId", MoIdBase);
                                    var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultComponent.Count() > 0)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"update MES.Barcode  SET  
                                                BarcodeStatus = @BarcodeStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                FROM  MES.Barcode a 
                                                INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                                WHERE b.AssemblyBarcodeId = @BarcodeId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BarcodeStatus = "4",
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                BarcodeId = MweBarcodeId
                                            });
                                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                                    }
                                    #endregion
                                }
                            }
                            #endregion
                        }


                        #region //更新 - 入庫單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoWarehouseEnry SET
                                ConfirmUserId = @ConfirmUserId,
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId
                                AND CompanyId = @CompanyId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ConfirmUserId = CreateBy,
                              ConfirmStatus = "V",
                              LastModifiedDate,
                              LastModifiedBy,
                              MweId,
                              CompanyId = CurrentCompany
                          });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新 - 入庫單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MweDetail SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ConfirmStatus = "V",
                              LastModifiedDate,
                              LastModifiedBy,
                              MweId
                          });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //審核ERP權限
                        USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI06", "CONFIRM");
                        #endregion

                        #region //取出ERP托外入庫單據資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TH023 
                                FROM MOCTH
                                WHERE TH001 = @MweErpPrefix
                                AND TH002 = @MweErpNo";
                        dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                        dynamicParameters.Add("MweErpNo", MweErpNo);
                        var ErpMweResult1 = sqlConnection.Query(sql, dynamicParameters);
                        if (ErpMweResult1.Count() <= 0) throw new SystemException("找不到ERP入庫單據!");
                        foreach (var item in ErpMweResult1)
                        {
                            if (item.TH023 == "Y") throw new SystemException("該入庫單據在ERP已經核單,不能操作");
                            if (item.TH023 == "V") throw new SystemException("該入庫單據在ERP已經作廢,不能操作");
                        }
                        #endregion

                        #region //入庫單單頭確認
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTH 
                                SET MODIFIER =@MODIFIER,
                                MODI_DATE= @MODI_DATE,
                                MODI_TIME= @MODI_TIME,
                                MODI_AP= @MODI_AP,
                                MODI_PRID= @MODI_PRID,
                                FLAG= FLAG + 1,
                                TH023 = 'V'
                                WHERE TH001 = @MweErpPrefix
                                AND TH002 = @MweErpNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = UserNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = BaseHelper.ClientComputer(),
                                MODI_PRID = "BM",
                                UserNo,
                                MweErpPrefix,
                                MweErpNo
                            });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //入庫單單身確認
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTI 
                                SET MODIFIER =@MODIFIER,
                                MODI_DATE= @MODI_DATE,
                                MODI_TIME= @MODI_TIME,
                                MODI_AP= @MODI_AP,
                                MODI_PRID= @MODI_PRID,
                                FLAG= FLAG + 1,
                                TI037 = 'V',
                                TI043 = @UserNo
                                WHERE TI001 = @MweErpPrefix
                                AND TI002 = @MweErpNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = UserNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = BaseHelper.ClientComputer(),
                                MODI_PRID = "BM",
                                UserNo,
                                MweErpPrefix,
                                MweErpNo
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "入庫單已經作廢成功!"
                    });
                    #endregion

                    if (OperateCompanyId != CurrentCompany) throw new SystemException("系統發生異常！！！前後端公司別不相同，請重新登入！!");
                    if (OperateUserId != CurrentUser) throw new SystemException("系統發生異常！！！前後端操作使用者不相同，請重新登入！!");

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //SplitMergeBarcodePrint //拆併盤條碼 --GPai 20230508
        public string SplitMergeBarcodePrint(string FirstBarcode, string SecondBarcode, int Qty)
        {
            try
            {

                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        //string[] RoutingProcessSortArray = RoutingProcessSort.Split(','); //變動製程順序(全)
                        if (FirstBarcode == SecondBarcode) throw new SystemException("兩者為相同條碼!");
                        if (Qty <= 0) throw new SystemException("數量輸入錯誤!");

                        #region //取得兩條碼資訊

                        //左條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId,a.BarcodeNo,b.MoSettingId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus,b.MoId,b.LotStatus,b.LotQty,e.MtlItemNo ,(d.WoErpPrefix + '-' + d.WoErpNo)WoErpNo
                                FROM MES.Barcode a
                                INNER JOIN MES.MoSetting b ON b.MoId = a.MoId
                                INNER JOIN MES.ManufactureOrder c ON c.MoId = b.MoId
                                INNER JOIN MES.WipOrder d ON d.WoId = c.WoId
                                INNER JOIN PDM.MtlItem e ON e.MtlItemId = d.MtlItemId
                                WHERE a.BarcodeNo = @FirstBarcode
                                ";
                        dynamicParameters.Add("FirstBarcode", FirstBarcode);
                        var firstBarcodeData = sqlConnection.Query(sql, dynamicParameters);

                        //右條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId,a.BarcodeNo,b.MoSettingId,a.BarcodeQty,a.CurrentProdStatus,a.BarcodeStatus,b.MoId,b.LotStatus,b.LotQty,e.MtlItemNo ,(d.WoErpPrefix + '-' + d.WoErpNo)WoErpNo
                                FROM MES.Barcode a
                                INNER JOIN MES.MoSetting b ON b.MoId = a.MoId
                                INNER JOIN MES.ManufactureOrder c ON c.MoId = b.MoId
                                INNER JOIN MES.WipOrder d ON d.WoId = c.WoId
                                INNER JOIN PDM.MtlItem e ON e.MtlItemId = d.MtlItemId
                                WHERE a.BarcodeNo = @SecondBarcode
                                ";
                        dynamicParameters.Add("SecondBarcode", SecondBarcode);
                        var secondBarcodeData = sqlConnection.Query(sql, dynamicParameters);

                        if (firstBarcodeData.Count() <= 0) throw new SystemException("查無資料! " + FirstBarcode);
                        if (secondBarcodeData.Count() <= 0) throw new SystemException("查無資料! " + SecondBarcode);
                        if (firstBarcodeData.First().LotStatus != "Y") throw new SystemException("欲拆併之產品條碼不是批量條碼，請重新輸入 " + FirstBarcode);
                        if (firstBarcodeData.First().LotStatus != "Y") throw new SystemException("欲拆併之產品條碼不是批量條碼，請重新輸入 " + FirstBarcode);
                        if (secondBarcodeData.First().LotStatus != "Y") throw new SystemException("拆併之產品條碼不是批量條碼，請重新輸入 " + SecondBarcode);
                        if (firstBarcodeData.First().BarcodeStatus != "8") throw new SystemException("欲拆併之產品條碼製令未完工入庫，請重新輸入 " + FirstBarcode);
                        if (secondBarcodeData.First().BarcodeStatus != "8") throw new SystemException("拆併之產品條碼製令未完工入庫，請重新輸入 " + SecondBarcode);
                        if (secondBarcodeData.First().MtlItemNo != firstBarcodeData.First().MtlItemNo) throw new SystemException("分屬品號不同，請重新輸入 " + SecondBarcode);
                        if (secondBarcodeData.First().CurrentProdStatus != firstBarcodeData.First().CurrentProdStatus) throw new SystemException("兩者產品狀態不同!");

                        int firstBarcodeId = firstBarcodeData.First().BarcodeId;
                        int secondBarcodeId = secondBarcodeData.First().BarcodeId;

                        #region //MWE入庫單
                        //MWE
                        //左
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId,b.MweBarcodeId,c.MweDetailId,d.ConfirmStatus,c.MoId,a.MoId FROM MES.Barcode a
                                INNER JOIN MES.MweBarcode b on a.BarcodeId =b.BarcodeId
                                INNER JOIN MES.MweDetail c on b.MweDetailId = c.MweDetailId
                                INNER JOIN MES.MoWarehouseEnry d on c.MweId = d.MweId
                                WHERE a.BarcodeId = @BarcodeId
                                AND a.MoId = c.MoId
                                ";
                        dynamicParameters.Add("BarcodeId", firstBarcodeId);
                        var firstBarcodeMweData = sqlConnection.Query(sql, dynamicParameters);

                        //右
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId,b.MweBarcodeId,c.MweDetailId,d.ConfirmStatus,c.MoId,a.MoId FROM MES.Barcode a
                                INNER JOIN MES.MweBarcode b on a.BarcodeId =b.BarcodeId
                                INNER JOIN MES.MweDetail c on b.MweDetailId = c.MweDetailId
                                INNER JOIN MES.MoWarehouseEnry d on c.MweId = d.MweId
                                WHERE a.BarcodeId = @BarcodeId
                                AND a.MoId = c.MoId
                                ";
                        dynamicParameters.Add("BarcodeId", secondBarcodeId);
                        var secondBarcodeMweData = sqlConnection.Query(sql, dynamicParameters);

                        if (firstBarcodeMweData.Count() <= 0) throw new SystemException("查無入庫單資料! " + FirstBarcode);
                        //if (firstBarcodeMweData.First().TransferStatus == "Y") throw new SystemException("入庫單已拋轉未核單! " + FirstBarcode);
                        if (firstBarcodeMweData.First().ConfirmStatus != "Y") throw new SystemException("入庫單未核單! " + FirstBarcode);

                        int UserId = CreateBy;
                        int mweDetailId = firstBarcodeMweData.First().MweDetailId;



                        if (secondBarcodeMweData.Count() <= 0)//FOR新增空條碼
                        {
                            #region //MES.MweBarcode紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MweBarcode (MweDetailId, BarcodeId, MweBarcodeQty, SourceType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MweDetailId,INSERTED.BarcodeId
                                VALUES (@MweDetailId, @BarcodeId, @MweBarcodeQty, @SourceType
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";

                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MweDetailId = mweDetailId,
                                    BarcodeId = secondBarcodeId,
                                    MweBarcodeQty = 0, //*
                                    SourceType = "MG",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });
                            var insertResult1 = sqlConnection.Query(sql, dynamicParameters);
                            rowsAffected += insertResult1.Count();
                            #endregion
                        }
                        else
                        {
                            //if (secondBarcodeMweData.First().TransferStatus == "Y") throw new SystemException("入庫單已拋轉未核單! " + SecondBarcode);
                            if (secondBarcodeMweData.First().ConfirmStatus != "Y") throw new SystemException("入庫單未核單! " + SecondBarcode);
                        }

                        #endregion


                        int firstMoId = firstBarcodeData.First().MoId;
                        int secondMoid = secondBarcodeData.First().MoId;

                        int firstLotQty = firstBarcodeData.First().LotQty;
                        int secondLotQty = secondBarcodeData.First().LotQty;
                        int firstQty = firstBarcodeData.First().BarcodeQty;
                        int secondQty = secondBarcodeData.First().BarcodeQty;

                        int secondQTY2 = secondQty + Qty;
                        if (Qty > firstQty) throw new SystemException("數量超過欲拆併之產品條碼產品數!");
                        if (secondQTY2 > secondLotQty) throw new SystemException("拆併後數量超過拆併之產品條碼限制!");
                        int firstQty2 = firstQty - Qty;
                        #endregion

                        #region //更新第一條碼數
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                    BarcodeQty = @firstQty2,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeNo = @FirstBarcode";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                firstQty2,
                                LastModifiedDate,
                                LastModifiedBy,
                                FirstBarcode
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新第二條碼數
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                    BarcodeQty = @secondQTY2,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeNo = @SecondBarcode";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                secondQTY2,
                                LastModifiedDate,
                                LastModifiedBy,
                                SecondBarcode
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        AddMergeData(firstBarcodeId, secondBarcodeId, firstMoId, secondMoid, Qty);
                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();


        }
        #endregion
        #endregion

        #region //Delete
        #region //DeleteMaterialRequisition -- 刪除領退料單資料 -- Ann 2022-08-22
        public string DeleteMaterialRequisition(int MrId)
        {
            try
            {
                string ErpNo = "";
                int rowsAffected = -1;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MrErpPrefix, a.MrErpNo, a.ConfirmStatus, a.ConfirmUserId, FORMAT(a.DocDate, 'yyyyMMdd') DocDate
                                    , b.UserNo
                                    FROM MES.MaterialRequisition a
                                    LEFT JOIN BAS.[User] b ON a.ConfirmUserId = b.UserId
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料錯誤!");

                            string MrErpPrefix = "";
                            string MrErpNo = "";
                            string DocDate = "";
                            string UserNo = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N" || item.UserNo != null) throw new SystemException("領退料單已有核單紀錄，無法刪除!");
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                                DocDate = item.DocDate;
                                UserNo = item.UserNo;
                            }
                            #endregion

                            string ErpFullNo = MrErpPrefix + "-" + MrErpNo;
                            AddUserOperateLog(MrId, ErpFullNo);

                            #region //核對領料單目前狀態是否可以刪除
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MOCTC
                                    WHERE TC001 = @TC001
                                    AND TC002 = @TC002";
                            dynamicParameters.Add("TC001", MrErpPrefix);
                            dynamicParameters.Add("TC002", MrErpNo);

                            var MOCTCResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (MOCTCResult.Count() > 0) throw new SystemException("此領料單已拋轉到ERP，無法刪除!!");
                            #endregion

                            #region //檢查領料單BARCODE是否已經過站
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.MrBarcodeRegister b ON a.MrDetailId = b.MrDetailId
                                    INNER JOIN MES.Barcode c ON b.BarcodeNo = c.BarcodeNo
                                    INNER JOIN MES.BarcodeProcess d ON c.BarcodeId = d.BarcodeId AND d.MoId = a.MoId
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var CheckBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (CheckBarcodeProcessResult.Count() > 0) throw new SystemException("此領料單已有條碼已過站，無法刪除!");
                            #endregion

                            #region //檢查此發料單單身是否有條碼轉移紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                    , c.BarcodeStatus CurrentBarcodeStatus
                                    , d.StatusName
                                    FROM MES.MrBarcodeTransferLog a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    INNER JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo
                                    INNER JOIN BAS.[Status] d ON c.BarcodeStatus = d.StatusNo AND d.StatusSchema = 'Barcode.BarcodeStatus'
                                    WHERE b.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TransferLogResult.Count() > 0)
                            {
                                foreach (var item2 in TransferLogResult)
                                {
                                    if (item2.CurrentBarcodeStatus != "1" && item2.CurrentBarcodeStatus != "3")
                                    {
                                        throw new SystemException("此條碼【" + item2.BarcodeNo + "】狀態【" + item2.StatusName + "】無法刪除，請先進行退料或解除綁定!");
                                    }

                                    #region //UPDATE MES.Barcode回原先資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            MoId = @MoId,
                                            CurrentMoProcessId = @CurrentMoProcessId,
                                            NextMoProcessId = @NextMoProcessId,
                                            CurrentProdStatus = @CurrentProdStatus,
                                            BarcodeStatus = @BarcodeStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeNo = @BarcodeNo";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          item2.MoId,
                                          item2.CurrentMoProcessId,
                                          item2.NextMoProcessId,
                                          item2.CurrentProdStatus,
                                          item2.BarcodeStatus,
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          item2.BarcodeNo
                                      });

                                    rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //將轉移LOG移除
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                            WHERE LogId = @LogId";
                                    dynamicParameters.Add("LogId", item2.LogId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //刪除MES.Barcode資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE a
                                        FROM MES.Barcode a
                                        INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                        INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                        WHERE c.MrId = @MrId";
                                dynamicParameters.Add("MrId", MrId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //刪除MES單據
                            #region //先刪除關聯Table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrBarcodeRegister a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrBarcodeReRegister a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM MES.MrWipOrder
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM MES.MrDetail
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除主要table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.MaterialRequisition
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMrWipOrder -- 刪除領退料單設定資料 -- Ann 2022-08-23
        public string DeleteMrWipOrder(int MrId, int MoId)
        {
            int rowsAffected = 0;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單資料是否正確
                            sql = @"SELECT a.MrErpPrefix, a.MrErpNo, a.ConfirmStatus, a.ConfirmUserId   
                                    , b.UserNo
                                    FROM MES.MaterialRequisition a
                                    LEFT JOIN BAS.[User] b ON a.ConfirmUserId = b.UserId
                                    WHERE a.MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單資料錯誤!");

                            string MrErpPrefix = "";
                            string MrErpNo = "";
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("領退料單已確認，無法刪除!");
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                            }
                            #endregion

                            #region //核對領料單目前狀態是否可以刪除
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TC009
                                    FROM MOCTC
                                    WHERE TC001 = @TC001
                                    AND TC002 = @TC002";
                            dynamicParameters.Add("TC001", MrErpPrefix);
                            dynamicParameters.Add("TC002", MrErpNo);

                            var MOCTCResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in MOCTCResult)
                            {
                                if (item.TC009 != "N") throw new SystemException("此領料ERP狀態無法刪除!!");
                            }
                            #endregion

                            #region //判斷領退料單設定資料是否正確
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrWipOrder
                                    WHERE MrId = @MrId
                                    AND MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("領退料單設定資料錯誤!");
                            #endregion

                            #region //檢查領料單BARCODE是否已經過站
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrBarcodeRegister a 
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    INNER JOIN MES.MrWipOrder c ON b.MrId = c.MrId AND b.MoId = c.MoId
                                    INNER JOIN MES.Barcode d ON a.BarcodeNo = d.BarcodeNo
                                    INNER JOIN MES.BarcodeProcess e ON d.BarcodeId = e.BarcodeId
                                    WHERE b.MrId = @MrId
                                    AND b.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            var CheckBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (CheckBarcodeProcessResult.Count() > 0) throw new SystemException("此領料單已有條碼已過站，無法刪除!");
                            #endregion

                            #region //檢查此發料單單身是否有條碼轉移紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                    , c.BarcodeStatus CurrentBarcodeStatus
                                    , d.StatusName
                                    FROM MES.MrBarcodeTransferLog a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    INNER JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo
                                    INNER JOIN BAS.[Status] d ON c.BarcodeStatus = d.StatusNo AND d.StatusSchema = 'Barcode.BarcodeStatus'
                                    WHERE b.MrId = @MrId
                                    AND b.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TransferLogResult.Count() > 0)
                            {
                                foreach (var item2 in TransferLogResult)
                                {
                                    if (item2.CurrentBarcodeStatus != "1" && item2.CurrentBarcodeStatus != "3" && item2.CurrentBarcodeStatus != "10")
                                    {
                                        throw new SystemException("此條碼【" + item2.BarcodeNo + "】狀態【" + item2.StatusName + "】無法刪除，請先進行退料或解除綁定!");
                                    }

                                    #region //UPDATE MES.Barcode回原先資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            MoId = @MoId,
                                            CurrentMoProcessId = @CurrentMoProcessId,
                                            NextMoProcessId = @NextMoProcessId,
                                            CurrentProdStatus = @CurrentProdStatus,
                                            BarcodeStatus = @BarcodeStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeNo = @BarcodeNo";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          item2.MoId,
                                          item2.CurrentMoProcessId,
                                          item2.NextMoProcessId,
                                          item2.CurrentProdStatus,
                                          item2.BarcodeStatus,
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          item2.BarcodeNo
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //將轉移LOG移除
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                            WHERE LogId = @LogId";
                                    dynamicParameters.Add("LogId", item2.LogId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //刪除MES.Barcode資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE a
                                        FROM MES.Barcode a
                                        INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                        INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                        WHERE c.MrId = @MrId AND c.MoId = @MoId";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MoId", MoId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //先刪除關聯Table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrBarcodeRegister a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrId = @MrId AND b.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrBarcodeReRegister a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrId = @MrId AND b.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM MES.MrDetail
                                    WHERE MrId = @MrId
                                    AND MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除主要table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.MrWipOrder
                                    WHERE MrId = @MrId
                                    AND MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //重新排序MrWipOrder
                            dynamicParameters = new DynamicParameters();
                            sql = @"With UpdateSort As
                                    (
                                      SELECT LineSeq,
                                      ROW_NUMBER() OVER(ORDER BY LineSeq) NewMrWipOrderSort
                                      FROM MES.MrWipOrder
                                      WHERE MrId = @MrId
                                    )
                                    UPDATE MES.MrWipOrder 
                                    SET LineSeq = RIGHT(REPLICATE('0', 4) + CAST(NewMrWipOrderSort as NVARCHAR), 4)
                                    FROM MES.MrWipOrder
                                    INNER JOIN UpdateSort ON MES.MrWipOrder.LineSeq = UpdateSort.LineSeq
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //重新排序MrDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"With UpdateSort As
                                    (
                                      SELECT MrSequence,
                                      ROW_NUMBER() OVER(ORDER BY MrSequence) NewMrDetailSort
                                      FROM MES.MrDetail
                                      WHERE MrId = @MrId
                                    )
                                    UPDATE MES.MrDetail 
                                    SET MrSequence = RIGHT(REPLICATE('0', 4) + CAST(NewMrDetailSort as NVARCHAR), 4)
                                    FROM MES.MrDetail
                                    INNER JOIN UpdateSort ON MES.MrDetail.MrSequence = UpdateSort.MrSequence
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //確認此製令其他領料紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrWipOrder a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    WHERE a.MoId = @MoId
                                    AND b.ConfirmStatus = 'Y'";
                            dynamicParameters.Add("MoId", MoId);

                            var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1 
                                    FROM MES.MrDetail a 
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    WHERE a.MoId = @MoId
                                    AND b.ConfirmStatus = 'Y'";
                            dynamicParameters.Add("MoId", MoId);

                            var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrWipOrderResult.Count() <= 0 && MrDetailResult.Count() <= 0)
                            {
                                #region //UPDATE MES.WipOrder WoStatus
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE a 
                                        SET a.WoStatus = @WoStatus,
                                        a.LastModifiedDate = @LastModifiedDate,
                                        a.LastModifiedBy = @LastModifiedBy
                                        FROM MES.WipOrder a 
                                        INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                                        WHERE b.MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        WoStatus = "1",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MoId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMrDetail -- 刪除領退料單詳細資料 -- Ann 2022-08-23
        public string DeleteMrDetail(int MrDetailId)
        {
            int rowsAffected = 0;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷領退料單詳細資料是否正確
                            sql = @"SELECT a.MrId, a.ConfirmStatus, a.MoId
                                    , b.MrErpPrefix, b.MrErpNo
                                    , c.UserNo
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    LEFT JOIN BAS.[User] c ON b.ConfirmUserId = c.UserId
                                    WHERE a.MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("領退料單詳細資料錯誤!");

                            int MrId = -1;
                            string MrErpPrefix = "";
                            string MrErpNo = "";
                            int MoId = -1;
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("狀態已確認，無法刪除!");
                                MrId = item.MrId;
                                MrErpPrefix = item.MrErpPrefix;
                                MrErpNo = item.MrErpNo;
                                MoId = item.MoId;
                            }
                            #endregion

                            #region //製令自動帶出狀況下，刪除領料單單身相關卡控
                            #region //先計算此製令在領料單身下剩餘筆數
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECt COUNT(1) Count
                                    FROM MES.MrDetail a 
                                    WHERE a.MrId = @MrId
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("MrId", MrId);
                            dynamicParameters.Add("MoId", MoId);

                            var MrDetailCountResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in MrDetailCountResult)
                            {
                                if (item.Count <= 1)
                                {
                                    #region //確認是否有製令自動帶出相關資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.MrWipOrder a
                                            WHERE a.MrId = @MrId
                                            AND a.MoId = @MoId ";
                                    dynamicParameters.Add("MrId", MrId);
                                    dynamicParameters.Add("MoId", MoId);

                                    var MrWipOrderResult2 = sqlConnection.Query(sql, dynamicParameters);

                                    if (MrWipOrderResult2.Count() > 0) throw new SystemException("若需完整刪除單身，請從製令自動帶出來進行刪除!!");
                                    #endregion
                                }
                            }
                            #endregion
                            #endregion

                            #region //核對領料單目前狀態是否可以刪除
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TC009
                                    FROM MOCTC
                                    WHERE TC001 = @TC001
                                    AND TC002 = @TC002";
                            dynamicParameters.Add("TC001", MrErpPrefix);
                            dynamicParameters.Add("TC002", MrErpNo);

                            var MOCTCResult = sqlConnection2.Query(sql, dynamicParameters);

                            foreach (var item in MOCTCResult)
                            {
                                if (item.TC009 != "N") throw new SystemException("此領料ERP狀態無法刪除!!");
                            }
                            #endregion

                            #region //檢查領料單BARCODE是否已經過站
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.MrBarcodeRegister b ON a.MrDetailId = b.MrDetailId
                                    INNER JOIN MES.Barcode c ON b.BarcodeNo = c.BarcodeNo
                                    INNER JOIN MES.BarcodeProcess d ON c.BarcodeId = d.BarcodeId AND d.MoId = a.MoId
                                    WHERE a.MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            var CheckBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (CheckBarcodeProcessResult.Count() > 0) throw new SystemException("此領料單已有條碼已過站，無法刪除!");
                            #endregion

                            #region //檢查此發料單單身是否有條碼轉移紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                    , b.BarcodeStatus CurrentBarcodeStatus
                                    , c.StatusName
                                    FROM MES.MrBarcodeTransferLog a
                                    INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                    INNER JOIN BAS.[Status] c ON b.BarcodeStatus = c.StatusNo AND c.StatusSchema = 'Barcode.BarcodeStatus'
                                    WHERE a.MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TransferLogResult.Count() > 0)
                            {
                                foreach (var item2 in TransferLogResult)
                                {
                                    if (item2.CurrentBarcodeStatus != "1" && item2.CurrentBarcodeStatus != "3")
                                    {
                                        throw new SystemException("此條碼【" + item2.BarcodeNo + "】狀態【" + item2.StatusName + "】無法刪除，請先進行退料或解除綁定!");
                                    }

                                    #region //UPDATE MES.Barcode回原先資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            MoId = @MoId,
                                            CurrentMoProcessId = @CurrentMoProcessId,
                                            NextMoProcessId = @NextMoProcessId,
                                            CurrentProdStatus = @CurrentProdStatus,
                                            BarcodeStatus = @BarcodeStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeNo = @BarcodeNo";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          item2.MoId,
                                          item2.CurrentMoProcessId,
                                          item2.NextMoProcessId,
                                          item2.CurrentProdStatus,
                                          item2.BarcodeStatus,
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          item2.BarcodeNo
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //將轉移LOG移除
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                            WHERE LogId = @LogId";
                                    dynamicParameters.Add("LogId", item2.LogId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                            else
                            {
                                #region //刪除MES.Barcode資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE a
                                        FROM MES.Barcode a
                                        INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                        WHERE b.MrDetailId = @MrDetailId";
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //先刪除關聯Table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrBarcodeRegister a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MrBarcodeReRegister a
                                    INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                    WHERE b.MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除主要table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.MrDetail
                                    WHERE MrDetailId = @MrDetailId";
                            dynamicParameters.Add("MrDetailId", MrDetailId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //重新排序MrDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"With UpdateSort As
                                    (
                                      SELECT MrSequence,
                                      ROW_NUMBER() OVER(ORDER BY MrSequence) NewMrDetailSort
                                      FROM MES.MrDetail
                                      WHERE MrId = @MrId
                                    )
                                    UPDATE MES.MrDetail 
                                    SET MrSequence = RIGHT(REPLICATE('0', 4) + CAST(NewMrDetailSort as NVARCHAR), 4)
                                    FROM MES.MrDetail
                                    INNER JOIN UpdateSort ON MES.MrDetail.MrSequence = UpdateSort.MrSequence
                                    WHERE MrId = @MrId";
                            dynamicParameters.Add("MrId", MrId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //確認此製令其他領料紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrWipOrder a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    WHERE a.MoId = @MoId
                                    AND b.ConfirmStatus = 'Y'";
                            dynamicParameters.Add("MoId", MoId);

                            var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1 
                                    FROM MES.MrDetail a 
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    WHERE a.MoId = @MoId
                                    AND b.ConfirmStatus = 'Y'";
                            dynamicParameters.Add("MoId", MoId);

                            var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrWipOrderResult.Count() <= 0 && MrDetailResult.Count() <= 0)
                            {
                                #region //UPDATE MES.WipOrder WoStatus
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE a 
                                        SET a.WoStatus = @WoStatus,
                                        a.LastModifiedDate = @LastModifiedDate,
                                        a.LastModifiedBy = @LastModifiedBy
                                        FROM MES.WipOrder a 
                                        INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                                        WHERE b.MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        WoStatus = "1",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MoId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //BatchDeleteMrDetail -- 批量刪除領退料單詳細資料 -- Ann 2024-09-06
        public string BatchDeleteMrDetail(string MrDetailList)
        {
            try
            {
                if (MrDetailList.Length <= 0) throw new SystemException("領退料單身清單不能為空!!");

                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            string[] MrDetailIdList = MrDetailList.Split(',');
                            foreach (var MrDetailId in MrDetailIdList)
                            {
                                #region //判斷領退料單詳細資料是否正確
                                sql = @"SELECT a.MrId, a.ConfirmStatus, a.MoId, a.MrSequence
                                        , b.MrErpPrefix, b.MrErpNo
                                        , c.UserNo
                                        FROM MES.MrDetail a
                                        INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                        LEFT JOIN BAS.[User] c ON b.ConfirmUserId = c.UserId
                                        WHERE a.MrDetailId = @MrDetailId";
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                var result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("領退料單詳細資料錯誤!");

                                int MrId = -1;
                                string MrErpPrefix = "";
                                string MrErpNo = "";
                                int MoId = -1;
                                string MrSequence = "";
                                foreach (var item in result)
                                {
                                    if (item.ConfirmStatus != "N") throw new SystemException("狀態已確認，無法刪除!");
                                    MrId = item.MrId;
                                    MrErpPrefix = item.MrErpPrefix;
                                    MrErpNo = item.MrErpNo;
                                    MoId = item.MoId;
                                    MrSequence = item.MrSequence;
                                }
                                #endregion

                                #region //製令自動帶出狀況下，刪除領料單單身相關卡控
                                #region //先計算此製令在領料單身下剩餘筆數
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECt COUNT(1) Count
                                        FROM MES.MrDetail a 
                                        WHERE a.MrId = @MrId
                                        AND a.MoId = @MoId";
                                dynamicParameters.Add("MrId", MrId);
                                dynamicParameters.Add("MoId", MoId);

                                var MrDetailCountResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in MrDetailCountResult)
                                {
                                    if (item.Count <= 1)
                                    {
                                        #region //確認是否有製令自動帶出相關資料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                                FROM MES.MrWipOrder a
                                                WHERE a.MrId = @MrId
                                                AND a.MoId = @MoId ";
                                        dynamicParameters.Add("MrId", MrId);
                                        dynamicParameters.Add("MoId", MoId);

                                        var MrWipOrderResult2 = sqlConnection.Query(sql, dynamicParameters);

                                        if (MrWipOrderResult2.Count() > 0) throw new SystemException("若需完整刪除單身，請從製令自動帶出來進行刪除!!");
                                        #endregion
                                    }
                                }
                                #endregion
                                #endregion

                                #region //核對領料單目前狀態是否可以刪除
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TC009
                                        FROM MOCTC
                                        WHERE TC001 = @TC001
                                        AND TC002 = @TC002";
                                dynamicParameters.Add("TC001", MrErpPrefix);
                                dynamicParameters.Add("TC002", MrErpNo);

                                var MOCTCResult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item in MOCTCResult)
                                {
                                    if (item.TC009 != "N") throw new SystemException("領退料序號【" + MrSequence + "】<br>ERP狀態無法刪除!!");
                                }
                                #endregion

                                #region //檢查領料單BARCODE是否已經過站
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.MrDetail a
                                        INNER JOIN MES.MrBarcodeRegister b ON a.MrDetailId = b.MrDetailId
                                        INNER JOIN MES.Barcode c ON b.BarcodeNo = c.BarcodeNo
                                        INNER JOIN MES.BarcodeProcess d ON c.BarcodeId = d.BarcodeId AND d.MoId = a.MoId
                                        WHERE a.MrDetailId = @MrDetailId";
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                var CheckBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                if (CheckBarcodeProcessResult.Count() > 0) throw new SystemException("領退料序號【" + MrSequence + "】<br>此領料單已有條碼已過站，無法刪除!");
                                #endregion

                                #region //檢查此發料單單身是否有條碼轉移紀錄
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                        , b.BarcodeStatus CurrentBarcodeStatus
                                        , c.StatusName
                                        FROM MES.MrBarcodeTransferLog a
                                        INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                        INNER JOIN BAS.[Status] c ON b.BarcodeStatus = c.StatusNo AND c.StatusSchema = 'Barcode.BarcodeStatus'
                                        WHERE a.MrDetailId = @MrDetailId";
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                                if (TransferLogResult.Count() > 0)
                                {
                                    foreach (var item2 in TransferLogResult)
                                    {
                                        if (item2.CurrentBarcodeStatus != "1" && item2.CurrentBarcodeStatus != "3")
                                        {
                                            throw new SystemException("領退料序號【" + MrSequence + "】<br>此條碼【" + item2.BarcodeNo + "】狀態【" + item2.StatusName + "】無法刪除，請先進行退料或解除綁定!");
                                        }

                                        #region //UPDATE MES.Barcode回原先資料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode SET
                                            MoId = @MoId,
                                            CurrentMoProcessId = @CurrentMoProcessId,
                                            NextMoProcessId = @NextMoProcessId,
                                            CurrentProdStatus = @CurrentProdStatus,
                                            BarcodeStatus = @BarcodeStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeNo = @BarcodeNo";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              item2.MoId,
                                              item2.CurrentMoProcessId,
                                              item2.NextMoProcessId,
                                              item2.CurrentProdStatus,
                                              item2.BarcodeStatus,
                                              LastModifiedDate,
                                              LastModifiedBy,
                                              item2.BarcodeNo
                                          });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //將轉移LOG移除
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                            WHERE LogId = @LogId";
                                        dynamicParameters.Add("LogId", item2.LogId);

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                                else
                                {
                                    #region //刪除MES.Barcode資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE a
                                        FROM MES.Barcode a
                                        INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                        WHERE b.MrDetailId = @MrDetailId";
                                    dynamicParameters.Add("MrDetailId", MrDetailId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion

                                #region //先刪除關聯Table
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE a 
                                        FROM MES.MrBarcodeRegister a
                                        INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                        WHERE b.MrDetailId = @MrDetailId";
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE a 
                                        FROM MES.MrBarcodeReRegister a
                                        INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                        WHERE b.MrDetailId = @MrDetailId";
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //刪除主要table
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE MES.MrDetail
                                        WHERE MrDetailId = @MrDetailId";
                                dynamicParameters.Add("MrDetailId", MrDetailId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //重新排序MrDetail
                                dynamicParameters = new DynamicParameters();
                                sql = @"With UpdateSort As
                                        (
                                          SELECT MrSequence,
                                          ROW_NUMBER() OVER(ORDER BY MrSequence) NewMrDetailSort
                                          FROM MES.MrDetail
                                          WHERE MrId = @MrId
                                        )
                                        UPDATE MES.MrDetail 
                                        SET MrSequence = RIGHT(REPLICATE('0', 4) + CAST(NewMrDetailSort as NVARCHAR), 4)
                                        FROM MES.MrDetail
                                        INNER JOIN UpdateSort ON MES.MrDetail.MrSequence = UpdateSort.MrSequence
                                        WHERE MrId = @MrId";
                                dynamicParameters.Add("MrId", MrId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //確認此製令其他領料紀錄
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.MrWipOrder a
                                        INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                        WHERE a.MoId = @MoId
                                        AND b.ConfirmStatus = 'Y'";
                                dynamicParameters.Add("MoId", MoId);

                                var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1 
                                        FROM MES.MrDetail a 
                                        INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                        WHERE a.MoId = @MoId
                                        AND b.ConfirmStatus = 'Y'";
                                dynamicParameters.Add("MoId", MoId);

                                var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MrWipOrderResult.Count() <= 0 && MrDetailResult.Count() <= 0)
                                {
                                    #region //UPDATE MES.WipOrder WoStatus
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE a 
                                            SET a.WoStatus = @WoStatus,
                                            a.LastModifiedDate = @LastModifiedDate,
                                            a.LastModifiedBy = @LastModifiedBy
                                            FROM MES.WipOrder a 
                                            INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                                            WHERE b.MoId = @MoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            WoStatus = "1",
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            MoId
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion
                            }

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMrBarcodeRegister -- 刪除物料條碼控管資料 -- Ann 2022-09-05
        public string DeleteMrBarcodeRegister(int BarcodeRegisterId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        #region //判斷物料條碼控管資料是否正確
                        sql = @"SELECT a.BarcodeNo, a.CreateDate
                                , b.MrDetailId, b.ActualQuantity, b.Unit, b.MoId
                                , c.ConfirmStatus, c.MrId
                                , d.BarcodeId, d.BarcodeQty
                                , e.BarcodeProcessId
                                FROM MES.MrBarcodeRegister a
                                INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                INNER JOIN MES.MaterialRequisition c ON b.MrId = c.MrId
                                LEFT JOIN MES.Barcode d ON a.BarcodeNo = d.BarcodeNo
                                LEFT JOIN MES.BarcodeProcess e ON d.BarcodeId = e.BarcodeId
                                WHERE BarcodeRegisterId = @BarcodeRegisterId";
                        dynamicParameters.Add("BarcodeRegisterId", BarcodeRegisterId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("物料條碼控管資料錯誤!");

                        string BarcodeNo = "";
                        int MrDetailId = -1;
                        double? ActualQuantity = -1;
                        int? BarcodeId = -1;
                        double? BarcodeQty = -1;
                        int rowsAffected = 0;
                        string Unit = "";
                        int MoId = -1;
                        int MrId = -1;
                        DateTime BarcodeCreateDate = new DateTime();
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("領退料單已確認，無法更改!");
                            if (item.ActualQuantity < 0) throw new SystemException("領取套數錯誤!");
                            BarcodeNo = item.BarcodeNo;
                            MrDetailId = item.MrDetailId;
                            ActualQuantity = item.ActualQuantity;
                            BarcodeId = item.BarcodeId != null ? item.BarcodeId : (int?)null;
                            BarcodeQty = item.BarcodeQty != null ? item.BarcodeQty : (double?)null;
                            Unit = item.Unit;
                            MoId = item.MoId;
                            MrId = item.MrId;
                            BarcodeCreateDate = item.CreateDate;
                        }
                        #endregion

                        AddUserOperateLog(MrDetailId);

                        if (BarcodeId != null) ActualQuantity -= BarcodeQty;
                        else ActualQuantity -= 1;

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MrBarcodeRegister
                                WHERE BarcodeRegisterId = @BarcodeRegisterId";
                        dynamicParameters.Add("BarcodeRegisterId", BarcodeRegisterId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //檢查此BARCODE是否已經過站
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 b.FinishDate
                                FROM MES.Barcode a
                                INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId
                                WHERE a.BarcodeNo = @BarcodeNo
                                AND b.MoId = @MoId
                                ORDER BY FinishDate DESC";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("MoId", MoId);

                        var CheckBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (CheckBarcodeProcessResult.Count() > 0)
                        {
                            foreach (var item in CheckBarcodeProcessResult)
                            {
                                DateTime BarcodeProcessDate = item.FinishDate;
                                int dateResult = DateTime.Compare(BarcodeProcessDate, BarcodeCreateDate);
                                if (dateResult > 0) throw new SystemException("條碼【" + BarcodeNo + "】已有過站紀錄，無法刪除!!");
                            }
                        }
                        #endregion

                        #region //檢查此發料單單身是否有條碼轉移紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                , b.BarcodeStatus CurrentBarcodeStatus
                                , c.StatusName
                                FROM MES.MrBarcodeTransferLog a
                                INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                INNER JOIN BAS.[Status] c ON b.BarcodeStatus = c.StatusNo AND c.StatusSchema = 'Barcode.BarcodeStatus'
                                WHERE a.MrDetailId = @MrDetailId
                                AND a.BarcodeNo = @BarcodeNo
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("MrDetailId", MrDetailId);
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                        if (TransferLogResult.Count() > 0)
                        {
                            foreach (var item2 in TransferLogResult)
                            {
                                if (item2.CurrentBarcodeStatus != "1" && item2.CurrentBarcodeStatus != "3")
                                {
                                    throw new SystemException("此條碼【" + item2.BarcodeNo + "】狀態【" + item2.StatusName + "】無法刪除，請先進行退料或解除綁定!");
                                }

                                #region //UPDATE MES.Barcode回原先資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        MoId = @MoId,
                                        CurrentMoProcessId = @CurrentMoProcessId,
                                        NextMoProcessId = @NextMoProcessId,
                                        CurrentProdStatus = @CurrentProdStatus,
                                        BarcodeStatus = @BarcodeStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      item2.MoId,
                                      item2.CurrentMoProcessId,
                                      item2.NextMoProcessId,
                                      item2.CurrentProdStatus,
                                      item2.BarcodeStatus,
                                      LastModifiedDate,
                                      LastModifiedBy,
                                      BarcodeNo
                                  });

                                rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //將轉移LOG移除
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                        WHERE LogId = @LogId";
                                dynamicParameters.Add("LogId", item2.LogId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                        }
                        else
                        {
                            #region //刪除MES.Barcode資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.Barcode
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        #endregion

                        #region //判斷此料號是否為可切割料號
                        string DecompositionFlag = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT d.DecompositionFlag
                                FROM MES.MrDetail a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                INNER JOIN MES.WoDetail c ON a.MtlItemId = c.MtlItemId AND c.WoId = b.WoId
                                INNER JOIN MES.MoMtlSetting d ON c.WoDetailId = d.WoDetailId
                                WHERE a.MrDetailId = @MrDetailId";
                        dynamicParameters.Add("MrDetailId", MrDetailId);

                        var MainBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item3 in MainBarcodeResult)
                        {
                            DecompositionFlag = item3.DecompositionFlag;
                        }
                        #endregion

                        if (Unit == "PCS" && (DecompositionFlag == "N" || DecompositionFlag == ""))
                        {
                            #region //更新MrDetail領取套數
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MrDetail SET
                                    ActualQuantity = @ActualQuantity,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MrDetailId = @MrDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ActualQuantity,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MrDetailId
                                });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMrBarcodeReRegister -- 刪除物料退料條碼控管資料 -- Ann 2022-12-09
        public string DeleteMrBarcodeReRegister(int BarcodeReRegisterId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        #region //判斷物料條碼控管資料是否正確
                        sql = @"SELECT a.BarcodeNo
                                , b.MrDetailId, b.Quantity, b.ActualQuantity
                                , c.ConfirmStatus, c.TransferStatus
                                , d.BarcodeId, d.BarcodeQty, d.BarcodeStatus
                                , g.DecompositionFlag
                                FROM MES.MrBarcodeReRegister a
                                INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                INNER JOIN MES.MaterialRequisition c ON b.MrId = c.MrId
                                LEFT JOIN MES.Barcode d ON a.BarcodeNo = d.BarcodeNo
                                INNER JOIN MES.ManufactureOrder e ON b.MoId = e.MoId
                                INNER JOIN MES.WoDetail f ON e.WoId = f.WoId AND f.MtlItemId = b.MtlItemId
                                INNER JOIN MES.MoMtlSetting g ON f.WoDetailId = g.WoDetailId
                                WHERE BarcodeReRegisterId = @BarcodeReRegisterId";
                        dynamicParameters.Add("BarcodeReRegisterId", BarcodeReRegisterId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("物料條碼控管資料錯誤!");

                        string BarcodeNo = "";
                        int MrDetailId = -1;
                        double? ActualQuantity = -1;
                        int? BarcodeId = -1;
                        double? BarcodeQty = -1;
                        int rowsAffected = 0;
                        string TransferStatus = "";
                        string DecompositionFlag = "";
                        foreach (var item in result)
                        {
                            BarcodeQty = item.BarcodeQty != null ? item.BarcodeQty : 1;
                            if (item.DecompositionFlag == "Y") BarcodeQty = 0;
                            if (item.ConfirmStatus != "N") throw new SystemException("領退料單已確認，無法更改!");
                            if (item.ActualQuantity <= 0) throw new SystemException("領取套數錯誤!");
                            BarcodeNo = item.BarcodeNo;
                            MrDetailId = item.MrDetailId;
                            ActualQuantity = item.ActualQuantity;
                            BarcodeId = item.BarcodeId != null ? item.BarcodeId : (int?)null;
                            TransferStatus = item.TransferStatus;
                            DecompositionFlag = item.DecompositionFlag;
                        }
                        #endregion

                        if (BarcodeId != null) ActualQuantity -= BarcodeQty;
                        else throw new SystemException("查無此條碼資訊!");

                        #region //檢查此發料單單身是否有條碼轉移紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.LogId, a.MoId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                , b.BarcodeStatus CurrentBarcodeStatus
                                , c.StatusName
                                FROM MES.MrBarcodeTransferLog a
                                INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                INNER JOIN BAS.[Status] c ON b.BarcodeStatus = c.StatusNo AND c.StatusSchema = 'Barcode.BarcodeStatus'
                                WHERE a.MrDetailId = @MrDetailId
                                AND a.BarcodeNo = @BarcodeNo
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("MrDetailId", MrDetailId);
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var TransferLogResult = sqlConnection.Query(sql, dynamicParameters);

                        if (TransferLogResult.Count() > 0)
                        {
                            foreach (var item2 in TransferLogResult)
                            {
                                if (item2.CurrentBarcodeStatus != "8")
                                {
                                    throw new SystemException("此條碼【" + item2.BarcodeNo + "】狀態【" + item2.StatusName + "】無法退料!!");
                                }

                                #region //UPDATE MES.Barcode回原先資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        MoId = @MoId,
                                        CurrentMoProcessId = @CurrentMoProcessId,
                                        NextMoProcessId = @NextMoProcessId,
                                        CurrentProdStatus = @CurrentProdStatus,
                                        BarcodeStatus = @BarcodeStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      item2.MoId,
                                      item2.CurrentMoProcessId,
                                      item2.NextMoProcessId,
                                      item2.CurrentProdStatus,
                                      item2.BarcodeStatus,
                                      LastModifiedDate,
                                      LastModifiedBy,
                                      BarcodeNo
                                  });

                                rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //將轉移LOG移除
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE FROM MES.MrBarcodeTransferLog
                                        WHERE LogId = @LogId";
                                dynamicParameters.Add("LogId", item2.LogId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                        }
                        else
                        {
                            //throw new SystemException("此條碼【" + BarcodeNo + "】查無紀錄LOG，請聯繫系統開發室!!");
                        }
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MrBarcodeReRegister
                                WHERE BarcodeReRegisterId = @BarcodeReRegisterId";
                        dynamicParameters.Add("BarcodeReRegisterId", BarcodeReRegisterId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新MrDetail領取套數
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MrDetail SET
                                ActualQuantity = @ActualQuantity,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MrDetailId = @MrDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ActualQuantity,
                                LastModifiedDate,
                                LastModifiedBy,
                                MrDetailId
                            });

                        rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMoWarehouseEnry -- 刪除入庫單 -- Ted 2022-09-06
        public string DeleteMoWarehouseEnry(int MweId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                    }
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;

                        #region //判斷入庫單資料是否正確
                        sql = @"SELECT TOP 1 ConfirmStatus,TransferStatus
                                FROM MES.MoWarehouseEnry
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單單頭資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("入庫單單頭已確認，無法刪除!");
                            if (item.TransferStatus != "N") throw new SystemException("入庫單單頭已拋轉，無法刪除!");
                        }
                        #endregion

                        #region //判斷入庫單單身資料是否正確
                        dynamicParameters = new DynamicParameters();

                        sql = @"SELECT a.MweDetailId,a.ConfirmStatus,a.LabelStatus
                                ,b.MoId,b1.BarcodeCtrl
                                FROM MES.MweDetail a
                                INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                                INNER JOIN MES.ProdMode b1 on b.ModeId = b1.ModeId
                                WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);

                        if (result.Count() > 0) throw new SystemException("請先刪除入庫單單身!!");

                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("入庫單單身已確認，無法刪除!");
                                if (item.LabelStatus == "A") throw new SystemException("該入庫單有單身已經印製出標籤，無法刪除!");

                                if (item.BarcodeCtrl == "Y")
                                {
                                    #region //撈取入庫單身底下的條碼
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MweDetailId,b.BarcodeId,b1.BarcodeNo 
                                            FROM MES.MweDetail a
							                INNER JOIN MES.MweBarcode b on a.MweDetailId = b.MweDetailId
							                INNER JOIN MES.Barcode b1 on b.BarcodeId = b1.BarcodeId
							                WHERE a.MweDetailId = @MweDetailId";
                                    dynamicParameters.Add("MweDetailId", item.MweDetailId);
                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion

                                    #region //更新條碼狀態為完工狀態
                                    if (result.Count() > 0)
                                    {
                                        foreach (var itemIn in result)
                                        {
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    BarcodeStatus = @BarcodeStatus,
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BarcodeStatus = "0",
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        BarcodeId = itemIn.BarcodeId
                                                    });
                                            var insertResult = sqlConnection.Query(sql, dynamicParameters);
                                        }

                                        #region //刪除單身綁定條碼
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE a FROM MES.MweBarcode a
                                                INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                                INNER JOIN MES.MoWarehouseEnry c on b.MweId = c.MweId
                                                WHERE c.MweId = @MweId";
                                        dynamicParameters.Add("MweId", MweId);

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                    #endregion
                                }
                                else if (item.BarcodeCtrl == "N")
                                {
                                    #region //撈取單身綁定條碼
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeId,b.MoId,c.BarcodeNo
                                            FROM MES.MweBarcode a
                                            INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                            INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                                            WHERE a.MweDetailId = @MweDetailId";
                                    dynamicParameters.Add("MweDetailId", item.MweDetailId);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion

                                    if (result.Count() > 0)
                                    {
                                        #region //刪除單身綁定條碼
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE a FROM MES.MweBarcode a
                                                INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                                INNER JOIN MES.MoWarehouseEnry c on b.MweId = c.MweId
                                                WHERE c.MweId = @MweId";
                                        dynamicParameters.Add("MweId", MweId);

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        foreach (var itemIn in result)
                                        {
                                            #region //判斷條碼是否還在原製令且為入庫狀態
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT a.BarcodeId 
                                                    FROM MES.Barcode a
                                                    WHERE BarcodeId = @BarcodeId
                                                    AND a.BarcodeStatus = '8'
                                                    AND a.MoId = @MoId";
                                            dynamicParameters.Add("BarcodeId", itemIn.BarcodeId);
                                            dynamicParameters.Add("MoId", itemIn.MoId);

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            #endregion

                                            if (result.Count() > 0)
                                            {
                                                #region //刪除條碼
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"DELETE FROM MES.Barcode
                                                        WHERE BarcodeId = @BarcodeId";
                                                dynamicParameters.Add("BarcodeId", itemIn.BarcodeId);

                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion
                                            }
                                            else
                                            {
                                                throw new SystemException("不可以刪除,條碼:" + itemIn.BarcodeNo + "已經不再原先製令或是處於非入庫狀態");
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            //throw new SystemException("資料有誤!找不到該製令生產模式");
                        }

                        #endregion

                        #region //先刪除關聯Table


                        #region //刪除單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MweDetail
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoWarehouseEnry
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMweDetail -- 刪除入庫單單身 -- Ted 2022-09-07
        public string DeleteMweDetail(int MweId, int MweDetailId)
        {
            try
            {
                string ErpDbName = "";
                string ErpNo = "";
                string MESCompanyNo = "";
                string MweErpPrefix = "";
                string MweErpNo = "";
                string TransferStatus = "";
                string UserNo = "";
                int rowsAffected = 0;
                string DocDate = "";
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        var companyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");
                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                            MESCompanyNo = item.ErpNo;
                        }
                        #endregion

                        #region //撈取使用者No
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MoWarehouseEnryManagment");
                        dynamicParameters.Add("DetailCode", "delete");
                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        #region //判斷入庫單單頭資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MweErpPrefix, a.MweErpNo, a.ConfirmStatus, a.TransferStatus, a.ReConfirmStatus, FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate, x.DetailCount
                                FROM MES.MoWarehouseEnry a
                                OUTER APPLY(
                                    SELECT COUNT(x1.MweId) DetailCount FROM MES.MweDetail x1
                                    WHERE x1.MweId = a.MweId
                                ) x
                                WHERE a.MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單單頭資料錯誤!");
                        foreach (var item in result)
                        {
                            MweErpPrefix = item.MweErpPrefix;
                            MweErpNo = item.MweErpNo;
                            TransferStatus = item.TransferStatus;
                            DocDate = item.DocDate;
                            if (TransferStatus == "Y" && item.DetailCount == 1)
                            {
                                throw new SystemException("單據已拋轉過ERP單身不可全空,如欲更換單身請先加入新單身在刪舊單身,或是採用做廢流程!!!");
                            }
                            if (item.ConfirmStatus != "N") throw new SystemException("入庫單單頭已確認，無法刪除!");

                            if (item.ReConfirmStatus != null)
                            {
                                if (item.ReConfirmStatus != "Y") throw new SystemException("入庫單目前不處於可編輯的狀態，無法刪除!");
                            }
                        }
                        #endregion

                        #region //判斷入庫單單身資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConfirmStatus,MoId,LabelStatus
                                FROM MES.MweDetail
                                WHERE MweId = @MweId
                                AND MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweId", MweId);
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        int MoId = -1;
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("入庫單單身已確認，無法刪除!");
                            if (item.LabelStatus == "A") throw new SystemException("該入庫單單身已經印製出標籤，無法刪除!");
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //撈取MES製令資料
                        dynamicParameters = new DynamicParameters();
                        sql = @" SELECT b.BarcodeCtrl,b.OutputBarcodeFlag,a.Status,c.PlanQty
                                 FROM MES.ManufactureOrder a
                                 INNER JOIN MES.MoSetting b on a.MoId = b.MoId
                                 INNER JOIN MES.WipOrder c on a.WoId = c.WoId
                                 WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("資料有誤!找不到該製令");
                        string BarcodeCtrl = "";
                        string OutputBarcodeFlag = "";
                        string MoStatus = "";
                        int PlanQty = -1;
                        foreach (var item in result)
                        {
                            BarcodeCtrl = item.BarcodeCtrl;
                            OutputBarcodeFlag = item.OutputBarcodeFlag;
                            MoStatus = item.MoStatus;
                            PlanQty = item.PlanQty;
                        }
                        #endregion

                        #region //判斷製令是否有條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT COUNT(a.MoId) num
                            FROM MES.BarcodeProcess a
                            WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        string MoIdType = "";
                        int MesBarcode = -1;
                        foreach (var item in result)
                        {
                            MesBarcode = item.num;
                        }
                        if (MesBarcode > 0)
                        {
                            MoIdType = "Y";
                        }
                        else
                        {
                            MoIdType = "N";
                        }
                        #endregion

                        #region //判斷製令是否為全委外
                        string AllOutsourcing = "N";
                        if (MoIdType == "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                AllOutsourcing = "Y";
                            }
                        }
                        else if (MoIdType == "N")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcessTransaction a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                AllOutsourcing = "Y";
                            }
                        }
                        #endregion

                        #region //判斷該入庫單的條碼是否有被移轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MoId,c.MoId FROM MES.MweBarcode a
                                            INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                            INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                                            WHERE b.MoId != c.MoId
                                            AND b.MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            throw new SystemException("入庫單的條碼已經有被移轉不可以刪除");
                        }
                        #endregion

                        //#region //判斷該入庫單的條碼是否有被移轉
                        //if (BarcodeCtrl == "Y" || (BarcodeCtrl == "N" && OutputBarcodeFlag == "Y"))
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT a.BarcodeId FROM MES.MweBarcode  a
                        //        INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                        //        INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                        //        WHERE EXISTS(
                        //         SELECT TOP 1 BarcodeId FROM MES.Barcode x
                        //         WHERE a.BarcodeId = x.BarcodeId
                        //         AND b.MoId != x.MoId
                        //        )   
                        //        AND a.MweDetailId = @MweDetailId
                        //        AND c.CurrentProdStatus != 'S'";
                        //    dynamicParameters.Add("MweDetailId", MweDetailId);
                        //    result = sqlConnection.Query(sql, dynamicParameters);
                        //    if (result.Count() <= 0)
                        //    {
                        //        dynamicParameters = new DynamicParameters();
                        //        sql = @"SELECT a.BarcodeId FROM MES.MweBarcode  a
                        //                INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                        //                INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                        //                WHERE a.MweDetailId = @MweDetailId
                        //                AND c.CurrentProdStatus = 'S'";
                        //        dynamicParameters.Add("MweDetailId", MweDetailId);
                        //        result = sqlConnection.Query(sql, dynamicParameters);
                        //        //if (result.Count() <= 0) throw new SystemException("入庫單的條碼已經有被移轉不可以刪除");
                        //    }
                        //    else
                        //    {
                        //        throw new SystemException("入庫單的條碼已經有被移轉不可以刪除");
                        //    }
                        //}
                        //#endregion

                        if (MweErpPrefix == "5903" && AllOutsourcing == "Y")
                        {
                            string NoCheck = "單別為5903且為全委外製成不用檢核";
                        }
                        else
                        {
                            if (BarcodeCtrl == "Y" || (BarcodeCtrl == "N" && OutputBarcodeFlag == "Y"))
                            {
                                #region //撈取單身綁定條碼
                                string QaResult = "";
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeId, a.BarcodeStatus, a.NextMoProcessId,a.QaResult
                                        FROM MES.MweBarcode a
                                        WHERE MweDetailId = @MweDetailId";
                                dynamicParameters.Add("MweDetailId", MweDetailId);
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("資料有誤,找不到入庫單身所綁定條碼");

                                #endregion

                                #region //刪除單身綁定條碼
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE FROM MES.MweBarcode
                                        WHERE MweDetailId = @MweDetailId";
                                dynamicParameters.Add("MweDetailId", MweDetailId);
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //刪除單身綁定條碼後同步更新條碼狀態
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MweDetail SET
                                        LabelStatus = @LabelStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MweDetailId = @MweDetailId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      LabelStatus = "S",
                                      LastModifiedDate,
                                      LastModifiedBy,
                                      MweDetailId
                                  });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //更新條碼狀態
                                foreach (var item in result)
                                {
                                    string CurrentProdStatusChange = "";
                                    if (item.QaResult == "Y")
                                    {
                                        CurrentProdStatusChange = "CurrentProdStatus = 'P',";
                                    }
                                    #region //條碼狀態更新
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                                NextMoProcessId = @NextMoProcessId,
                                                " + CurrentProdStatusChange + @"
                                                BarcodeStatus = @BarcodeStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeStatus = item.BarcodeStatus,
                                            NextMoProcessId = item.NextMoProcessId,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            BarcodeId = item.BarcodeId
                                        });
                                    var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion

                                    #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改8
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponent a 
                                            INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                            WHERE a.AssemblyBarcodeId = @BarcodeId
                                            AND b.MoId = @MoId";
                                    dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                    dynamicParameters.Add("MoId", MoId);
                                    var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultComponent.Count() > 0)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"update MES.Barcode  SET  
                                                BarcodeStatus = @BarcodeStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                FROM  MES.Barcode a 
                                                INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                                WHERE b.AssemblyBarcodeId = @BarcodeId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BarcodeStatus = "4",
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                BarcodeId = item.BarcodeId
                                            });
                                        var insertResult4 = sqlConnection.Query(sql, dynamicParameters);
                                    }
                                    #endregion
                                }
                                #endregion
                            }
                            else if (BarcodeCtrl == "N")
                            {
                                #region //撈取單身綁定條碼(入庫條碼)
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeId, a.BarcodeStatus, a.NextMoProcessId,b.MoId,c.BarcodeNo
                                        FROM MES.MweBarcode a
                                        INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                        INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                                        WHERE a.MweDetailId = @MweDetailId";
                                dynamicParameters.Add("MweDetailId", MweDetailId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                result = sqlConnection.Query(sql, dynamicParameters);

                                if (result.Count() > 0)
                                {
                                    foreach (var item in result)
                                    {
                                        #region //判斷條碼是否為入庫狀態
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeId 
                                                FROM MES.Barcode a
                                                WHERE BarcodeId = @BarcodeId
                                                AND a.BarcodeStatus = '8'
                                                AND a.MoId = @MoId";
                                        dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                        dynamicParameters.Add("MoId", item.MoId);

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() > 0)
                                        {
                                            #region //刪除單身綁定條碼
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"DELETE FROM MES.MweBarcode
                                                    WHERE BarcodeId = @BarcodeId";

                                            dynamicParameters.Add("BarcodeId", item.BarcodeId);

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion

                                            #region //刪除單身綁定條碼後同步更新條碼狀態
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.MweDetail SET
                                                    LabelStatus = 'S',
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE MweDetailId = @MweDetailId";
                                            dynamicParameters.AddDynamicParams(
                                              new
                                              {
                                                  LabelStatus = "S",
                                                  LastModifiedDate,
                                                  LastModifiedBy,
                                                  MweDetailId
                                              });
                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion

                                            #region //刪除條碼
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"DELETE FROM MES.Barcode
                                                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("BarcodeId", item.BarcodeId);

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion

                                            #region //條碼狀態更新
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                NextMoProcessId = @NextMoProcessId,
                                                BarcodeStatus = @BarcodeStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    BarcodeStatus = item.BarcodeStatus,
                                                    NextMoProcessId = item.NextMoProcessId,
                                                    LastModifiedDate,
                                                    LastModifiedBy,
                                                    BarcodeId = item.BarcodeId
                                                });
                                            var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                                            #endregion

                                            #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改8
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponent a 
                                            INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                            WHERE a.AssemblyBarcodeId = @BarcodeId
                                            AND b.MoId = @MoId";
                                            dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                            dynamicParameters.Add("MoId", MoId);
                                            var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultComponent.Count() > 0)
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"update MES.Barcode  SET  
                                                BarcodeStatus = @BarcodeStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                FROM  MES.Barcode a 
                                                INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                                WHERE b.AssemblyBarcodeId = @BarcodeId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        BarcodeStatus = "4",
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        BarcodeId = item.BarcodeId
                                                    });
                                                var insertResult4 = sqlConnection.Query(sql, dynamicParameters);
                                            }
                                            #endregion
                                        }
                                        else
                                        {
                                            throw new SystemException("不可以刪除,條碼:" + item.BarcodeNo + "已經不再原先製令或是處於非入庫狀態");
                                        }
                                        #endregion
                                    }
                                }
                                #endregion
                            }
                        }


                        #region //刪除單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MweDetail
                                WHERE MweId = @MweId
                                AND MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweId", MweId);
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //判斷入庫數量是否超過製令預計產量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT SUM( b.ReceiptQty) ReceiptQtyAll
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.MweDetail b on a.MoId = b.MoId
                                WHERE a.MoId = @MoId
                                AND b.ConfirmStatus != 'V'";
                        dynamicParameters.Add("MoId", MoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            int ReceiptQtyAll = -1;
                            foreach (var item in result)
                            {
                                ReceiptQtyAll = Convert.ToInt32(item.ReceiptQtyAll);
                            }
                            if (ReceiptQtyAll > PlanQty)
                            {
                                throw new SystemException("總入庫數量已經超過ERP工單預計產量了!請重新確認");
                            }

                        }
                        #endregion

                        #region //目前該入庫單的總金額計畫
                        double? OrigAmountAll = 0;
                        double? OrigDiscountAmtAll = 0;
                        double? ReceiptExpenseAll = 0;
                        double? OrigPreTaxAmtAll = 0;
                        double? OrigTaxAmtAll = 0;
                        double? PreTaxAmtAll = 0;
                        double? TaxAmtAll = 0;
                        double? AcceptQtyAllBase = 0;
                        dynamicParameters = new DynamicParameters();
                        sql = @" SELECT SUM(a.OrigAmount) OrigAmountAll, SUM(a.OrigDiscountAmt) OrigDiscountAmtAll, SUM(a.ReceiptExpense) ReceiptExpenseAll
                                 ,SUM(a.OrigPreTaxAmt) OrigPreTaxAmtAll,                                                                                                                                                                                                                       SUM(a.OrigTaxAmt) OrigTaxAmtAll
                                 ,SUM(a.PreTaxAmt) PreTaxAmtAll, SUM(a.TaxAmt) TaxAmtAll, SUM(a.AcceptQty) AcceptQtyAll
                                 FROM MES.MweDetail a 
                                 WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                OrigAmountAll = item.OrigAmountAll;
                                OrigDiscountAmtAll = item.OrigDiscountAmtAll;
                                ReceiptExpenseAll = item.ReceiptExpenseAll;
                                OrigPreTaxAmtAll = item.OrigPreTaxAmtAll;
                                OrigTaxAmtAll = item.OrigTaxAmtAll;
                                PreTaxAmtAll = item.PreTaxAmtAll;
                                TaxAmtAll = item.TaxAmtAll;
                                AcceptQtyAllBase = item.AcceptQtyAll;
                            }
                        }
                        #endregion

                        #region //撈取目前最新驗收日帶入托外進貨日
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT FORMAT(MAX(a.AcceptanceDate), 'yyyy-MM-dd') MaxAcceptanceDate
                                FROM MES.MweDetail a
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單資料錯誤!");
                        string MaxAcceptanceDate = "";
                        foreach (var item in result)
                        {
                            MaxAcceptanceDate = item.MaxAcceptanceDate;
                        }

                        if (MaxAcceptanceDate != null)
                        {
                            DateTime dateA = DateTime.Parse(DocDate);
                            DateTime dateB = DateTime.Parse(MaxAcceptanceDate);
                            if (dateA > dateB)
                            {
                                throw new SystemException("資料異常:單身驗收日不可以小於單據日!!");
                            }
                        }
                        else
                        {
                            MaxAcceptanceDate = DocDate;
                        }
                        #endregion

                        #region //將金額回寫單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoWarehouseEnry SET
                                ReceiptDate = @ReceiptDate,
                                OrigAmount = @OrigAmountAll,
                                OrigPreTaxAmount = @OrigPreTaxAmtAll,
                                DeductAmount = @OrigDiscountAmtAll,
                                OrigTax = @OrigTaxAmtAll,
                                ReceiptAmount = @ReceiptExpenseAll,
                                PretaxAmount = @PreTaxAmtAll,
                                TaxAmount = @TaxAmtAll,
                                Quantity = @AcceptQtyAllBase,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ReceiptDate = MaxAcceptanceDate,
                                OrigAmountAll = OrigAmountAll != null ? OrigAmountAll : 0,
                                OrigPreTaxAmtAll = OrigPreTaxAmtAll != null ? OrigPreTaxAmtAll : 0,
                                OrigDiscountAmtAll = OrigDiscountAmtAll != null ? OrigDiscountAmtAll : 0,
                                OrigTaxAmtAll = OrigTaxAmtAll != null ? OrigTaxAmtAll : 0,
                                ReceiptExpenseAll = ReceiptExpenseAll != null ? ReceiptExpenseAll : 0,
                                PreTaxAmtAll = PreTaxAmtAll != null ? PreTaxAmtAll : 0,
                                TaxAmtAll = TaxAmtAll != null ? TaxAmtAll : 0,
                                AcceptQtyAllBase = AcceptQtyAllBase != null ? AcceptQtyAllBase : 0,
                                LastModifiedDate,
                                LastModifiedBy,
                                MweId
                            });
                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }

                    if (TransferStatus == "Y")
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            DynamicParameters dynamicParameters = new DynamicParameters();

                            #region //ERP公司代碼取得
                            string ERPCompanyNo = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 ML001  
                                            FROM CMSML";
                            var resultCompanyNo = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in resultCompanyNo)
                            {
                                ERPCompanyNo = item.ML001;
                            }
                            if (MESCompanyNo != ERPCompanyNo) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                            #endregion

                            #region //檢核ERP入庫單單頭確認碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 TH023  
                                    FROM MOCTH
                                    WHERE TH001 = @TH001
                                    AND TH002 = @TH002";
                            dynamicParameters.Add("TH001", MweErpPrefix);
                            dynamicParameters.Add("TH002", MweErpNo);
                            var resultMOCTH = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMOCTH.Count() > 0)
                            {
                                foreach (var item in resultMOCTH)
                                {
                                    if (item.TH023 == "Y") throw new SystemException("該入庫單再ERP已經處於核單狀態,不能刪除!!");
                                }
                            }
                            else
                            {
                                throw new SystemException("ERP找不到該筆入庫單請重新確認");
                            }
                            #endregion

                            #region //檢核ERP入庫單單身確認碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TI004,TI037
                                    FROM MOCTI
                                    WHERE TI001 = @TH001
                                    AND TI002 = @TH002";
                            dynamicParameters.Add("TH001", MweErpPrefix);
                            dynamicParameters.Add("TH002", MweErpNo);
                            var resultMOCTI = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMOCTI.Count() > 0)
                            {
                                foreach (var item in resultMOCTI)
                                {
                                    if (item.TI037 == "Y") throw new SystemException("入庫單品號為【" + item.TI004 + "】的單身，再ERP已經處於核單狀態,不能刪除!!");
                                }
                            }
                            else
                            {
                                throw new SystemException("ERP找不到該筆入庫單請重新確認");
                            }
                            #endregion
                        }
                    }

                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #region //DeleteBarcodeAll -- 刪除入庫單單身綁定的條碼(全部) -- Ted 2022-09-16
        public string DeleteBarcodeAll(int MweId, int MweDetailId, string BarcodeId)
        {
            try
            {
                string ErpDbName = "";
                string ErpNo = "";
                string MESCompanyNo = "";
                string MweErpPrefix = "";
                string MweErpNo = "";
                string TransferStatus = "";
                string UserNo = "";
                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        List<int> MweBarcodeIdList = new List<int>();
                        int MoIdBase = 0;

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        var companyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");
                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                            MESCompanyNo = item.ErpNo;
                        }
                        #endregion

                        #region //撈取使用者No
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MoWarehouseEnryManagment");
                        dynamicParameters.Add("DetailCode", "delete");
                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        #region //判斷入庫單單頭資料是否正確
                        sql = @"SELECT TOP 1 a.ConfirmStatus,a.TransferStatus,a.ReConfirmStatus
                                ,a.MweErpPrefix ,a.MweErpNo,x.DetailCount
                                FROM MES.MoWarehouseEnry a
                                OUTER APPLY(
                                    SELECT COUNT(x1.MweId) DetailCount FROM MES.MweDetail x1
                                    WHERE x1.MweId = a.MweId
                                ) x
                                WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單單頭資料錯誤!");

                        foreach (var item in result)
                        {
                            TransferStatus = item.TransferStatus;
                            MweErpPrefix = item.MweErpPrefix;
                            MweErpNo = item.MweErpNo;
                            if (TransferStatus == "Y" && item.DetailCount == 1)
                            {
                                throw new SystemException("單據已拋轉過ERP單身不可全空,如欲更換單身請先加入新單身在刪舊單身,或是採用做廢流程!!!");
                            }
                            if (item.ConfirmStatus != "N") throw new SystemException("入庫單單頭已確認，無法刪除!");
                            if (item.ReConfirmStatus != null)
                            {
                                if (item.ReConfirmStatus != "Y")
                                {
                                    throw new SystemException("入庫單目前不處於可編輯的狀態，無法刪除!");
                                }
                            }
                        }
                        #endregion

                        #region //判斷入庫單單身資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConfirmStatus,MoId
                                FROM MES.MweDetail
                                WHERE MweId = @MweId
                                AND MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweId", MweId);
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        result = sqlConnection.Query(sql, dynamicParameters);

                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                if (item.ConfirmStatus != "N") throw new SystemException("入庫單單身已確認，無法刪除!");
                                MoIdBase = Convert.ToInt32(item.MoId);
                            }
                        }
                        else
                        {
                            throw new SystemException("找不到入庫單資料請重新確認!");
                        }
                        #endregion

                        #region //判斷入庫單單身是否有綁定產品條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MweBarcodeId,a.BarcodeId,b.BarcodeNo
                                FROM MES.MweBarcode a
                                INNER JOIN MES.Barcode b on a.BarcodeId = b.BarcodeId
                                WHERE a.MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("該單身沒有綁定條碼!!!");
                        foreach (var item in result)
                        {
                            MweBarcodeIdList.Add(item.MweBarcodeId);
                        }
                        #endregion

                        #region //判斷該入庫單的條碼是否有被移轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MoId,c.MoId FROM MES.MweBarcode a
                                            INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                            INNER JOIN MES.Barcode c on a.BarcodeId = c.BarcodeId
                                            WHERE b.MoId != c.MoId
                                            AND b.MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            throw new SystemException("入庫單的條碼已經有被移轉不可以刪除");
                        }
                        #endregion

                        foreach (var MweBarcodeId in MweBarcodeIdList)
                        {
                            #region //判斷條碼是屬於加工結束還是強制結束
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId,a.BarcodeStatus,a.NextMoProcessId
                                    FROM MES.MweBarcode a
                                    WHERE a.MweBarcodeId = @MweBarcodeId";
                            dynamicParameters.Add("MweBarcodeId", MweBarcodeId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item in result)
                                {
                                    #region //條碼狀態更新 - 強制結束
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            NextMoProcessId = @NextMoProcessId,
                                            BarcodeStatus = @BarcodeStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeStatus = item.BarcodeStatus,
                                            NextMoProcessId = item.NextMoProcessId,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            BarcodeId = item.BarcodeId
                                        });
                                    var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion

                                    #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改8
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeComponent a 
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    WHERE a.AssemblyBarcodeId = @BarcodeId
                                    AND b.MoId = @MoId";
                                    dynamicParameters.Add("BarcodeId", item.BarcodeId);
                                    dynamicParameters.Add("MoId", MoIdBase);
                                    var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultComponent.Count() > 0)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"update MES.Barcode  SET  
                                        BarcodeStatus = @BarcodeStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        FROM  MES.Barcode a 
                                        INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                        WHERE b.AssemblyBarcodeId = @BarcodeId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BarcodeStatus = "4",
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                BarcodeId = item.BarcodeId
                                            });
                                        var insertResult4 = sqlConnection.Query(sql, dynamicParameters);
                                    }
                                    #endregion
                                }


                            }

                            #endregion


                        }

                        #region //刪除入庫單單身綁定的條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MweBarcode
                                WHERE MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除入庫單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MweDetail
                                WHERE MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //目前該入庫單的總金額計畫
                        double? OrigAmountAll = 0;
                        double? OrigDiscountAmtAll = 0;
                        double? ReceiptExpenseAll = 0;
                        double? OrigPreTaxAmtAll = 0;
                        double? OrigTaxAmtAll = 0;
                        double? PreTaxAmtAll = 0;
                        double? TaxAmtAll = 0;
                        double? AcceptQtyAllBase = 0;
                        dynamicParameters = new DynamicParameters();
                        sql = @" SELECT SUM(a.OrigAmount) OrigAmountAll, SUM(a.OrigDiscountAmt) OrigDiscountAmtAll, SUM(a.ReceiptExpense) ReceiptExpenseAll
                                 ,SUM(a.OrigPreTaxAmt) OrigPreTaxAmtAll,                                                                                                                                                                                                                       SUM(a.OrigTaxAmt) OrigTaxAmtAll
                                 ,SUM(a.PreTaxAmt) PreTaxAmtAll, SUM(a.TaxAmt) TaxAmtAll, SUM(a.AcceptQty) AcceptQtyAll
                                 FROM MES.MweDetail a 
                                 WHERE MweId = @MweId";
                        dynamicParameters.Add("MweId", MweId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                OrigAmountAll = item.OrigAmountAll;
                                OrigDiscountAmtAll = item.OrigDiscountAmtAll;
                                ReceiptExpenseAll = item.ReceiptExpenseAll;
                                OrigPreTaxAmtAll = item.OrigPreTaxAmtAll;
                                OrigTaxAmtAll = item.OrigTaxAmtAll;
                                PreTaxAmtAll = item.PreTaxAmtAll;
                                TaxAmtAll = item.TaxAmtAll;
                                AcceptQtyAllBase = item.AcceptQtyAll;
                            }
                        }
                        #endregion

                        #region //將金額回寫單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoWarehouseEnry SET
                                OrigAmount = @OrigAmountAll,
                                OrigPreTaxAmount = @OrigPreTaxAmtAll,
                                DeductAmount = @OrigDiscountAmtAll,
                                OrigTax = @OrigTaxAmtAll,
                                ReceiptAmount = @ReceiptExpenseAll,
                                PretaxAmount = @PreTaxAmtAll,
                                TaxAmount = @TaxAmtAll,
                                Quantity = @AcceptQtyAllBase,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweId = @MweId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                OrigAmountAll = OrigAmountAll != null ? OrigAmountAll : 0,
                                OrigPreTaxAmtAll = OrigPreTaxAmtAll != null ? OrigPreTaxAmtAll : 0,
                                OrigDiscountAmtAll = OrigDiscountAmtAll != null ? OrigDiscountAmtAll : 0,
                                OrigTaxAmtAll = OrigTaxAmtAll != null ? OrigTaxAmtAll : 0,
                                ReceiptExpenseAll = ReceiptExpenseAll != null ? ReceiptExpenseAll : 0,
                                PreTaxAmtAll = PreTaxAmtAll != null ? PreTaxAmtAll : 0,
                                TaxAmtAll = TaxAmtAll != null ? TaxAmtAll : 0,
                                AcceptQtyAllBase = AcceptQtyAllBase != null ? AcceptQtyAllBase : 0,
                                LastModifiedDate,
                                LastModifiedBy,
                                MweId
                            });
                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        foreach (var MweBarcodeId in MweBarcodeIdList)
                        {
                            #region //判斷條碼是屬於加工結束還是強制結束
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT d.BarcodeNo,d.CurrentProdStatus, c.MoProcessId,c.ProcessAlias,e.ProdStatus
                                    FROM MES.WipOrder a
                                    LEFT JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
	                                LEFT JOIN MES.MoProcess c ON b.MoId = c.MoId
	                                LEFT JOIN MES.Barcode d ON b.MoId = d.MoId
	                                LEFT JOIN MES.BarcodeProcess e ON d.BarcodeId = e.BarcodeId AND c.MoProcessId = e.MoProcessId
                                    WHERE b.MoId = @MoId
                                    AND d.BarcodeId = @BarcodeId
                                    AND d.CurrentProdStatus in ('P','M','R','RW')
                                    AND c.NecessityStatus = 'Y'
                                    AND e.ProdStatus is null";
                            dynamicParameters.Add("MoId", MoIdBase);
                            dynamicParameters.Add("BarcodeId", MweBarcodeId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                #region //條碼狀態更新 - 強制結束
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        BarcodeStatus = @BarcodeStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeStatus = "7",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        BarcodeId = MweBarcodeId
                                    });
                                var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                                #endregion
                            }
                            else
                            {
                                #region //條碼狀態更新 - 加工結束
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                                            BarcodeStatus = @BarcodeStatus,
                                                            LastModifiedDate = @LastModifiedDate,
                                                            LastModifiedBy = @LastModifiedBy
                                                            WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeStatus = "0",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        BarcodeId = MweBarcodeId
                                    });
                                var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //判斷主條碼中的元件條碼 是否存在 存在就將元件條碼狀態修改8
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeComponent a 
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    WHERE a.AssemblyBarcodeId = @BarcodeId
                                    AND b.MoId = @MoId";
                            dynamicParameters.Add("BarcodeId", MweBarcodeId);
                            dynamicParameters.Add("MoId", MoIdBase);
                            var resultComponent = sqlConnection.Query(sql, dynamicParameters);
                            if (resultComponent.Count() > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"update MES.Barcode  SET  
                                        BarcodeStatus = @BarcodeStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        FROM  MES.Barcode a 
                                        INNER JOIN MES.BarcodeComponent b on a.BarcodeId = b.ComponentBarcodeId
                                        WHERE b.AssemblyBarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeStatus = "4",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        BarcodeId = MweBarcodeId
                                    });
                                var insertResult4 = sqlConnection.Query(sql, dynamicParameters);
                            }
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = result
                        });
                        #endregion
                    }
                    if (TransferStatus == "Y")
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            DynamicParameters dynamicParameters = new DynamicParameters();

                            #region //ERP公司代碼取得
                            string ERPCompanyNo = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 ML001  
                                            FROM CMSML";
                            var resultCompanyNo = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in resultCompanyNo)
                            {
                                ERPCompanyNo = item.ML001;
                            }
                            if (MESCompanyNo != ERPCompanyNo) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                            #endregion

                            #region //檢核ERP入庫單單頭確認碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 TH023  
                                    FROM MOCTH
                                    WHERE TH001 = @TH001
                                    AND TH002 = @TH002";
                            dynamicParameters.Add("TH001", MweErpPrefix);
                            dynamicParameters.Add("TH002", MweErpNo);
                            var resultMOCTH = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMOCTH.Count() > 0)
                            {
                                foreach (var item in resultMOCTH)
                                {
                                    if (item.TH023 == "Y") throw new SystemException("該入庫單再ERP已經處於核單狀態,不能刪除!!");
                                }
                            }
                            else
                            {
                                throw new SystemException("ERP找不到該筆入庫單請重新確認");
                            }
                            #endregion

                            #region //檢核ERP入庫單單身確認碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TI004,TI037
                                    FROM MOCTI
                                    WHERE TI001 = @TH001
                                    AND TI002 = @TH002";
                            dynamicParameters.Add("TH001", MweErpPrefix);
                            dynamicParameters.Add("TH002", MweErpNo);
                            var resultMOCTI = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMOCTI.Count() > 0)
                            {
                                foreach (var item in resultMOCTH)
                                {
                                    if (item.TI037 == "Y") throw new SystemException("入庫單品號為【" + item.TI004 + "】的單身，再ERP已經處於核單狀態,不能刪除!!");
                                }
                            }
                            else
                            {
                                throw new SystemException("ERP找不到該筆入庫單請重新確認");
                            }
                            #endregion
                        }
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMweBarcodePrint -- 刪除數量入庫單身的批量條碼 -- Shintokuro 2022-11-29
        public string DeleteMweBarcodePrint(int MweBarcodeId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷入庫單單頭資料是否正確
                        sql = @"SELECT a.MweDetailId,a.BarcodeId,c.TransferStatus,c.ConfirmStatus
                                FROM MES.MweBarcode a
                                INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                INNER JOIN MES.MoWarehouseEnry c on b.MweId = c.MweId
                                WHERE a.MweBarcodeId = @MweBarcodeId";
                        dynamicParameters.Add("MweBarcodeId", MweBarcodeId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單單身資料錯誤!");
                        foreach (var item in result)
                        {
                            if (item.TransferStatus == "Y") throw new SystemException("入庫單已經拋轉無法，不可以刪除!");
                        }
                        #endregion

                        #region //刪除入庫單單身綁定的條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MweBarcode
                                WHERE MweBarcodeId = @MweBarcodeId";

                        dynamicParameters.Add("MweBarcodeId", MweBarcodeId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除Barcode資料
                        foreach (var item in result)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM MES.Barcode
                                WHERE BarcodeId = @BarcodeId";

                            dynamicParameters.Add("BarcodeId", item.BarcodeId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMweBarcodePrintAll -- 刪除數量入庫單身的批量條碼(全部) -- Shintokuro 2022-11-29
        public string DeleteMweBarcodePrintAll(int MweDetailId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷入庫單單頭資料是否正確
                        sql = @"SELECT a.MweDetailId,a.BarcodeId,c.TransferStatus,c.ConfirmStatus,c.ReConfirmStatus,b.MoId
                                FROM MES.MweBarcode a
                                INNER JOIN MES.MweDetail b on a.MweDetailId = b.MweDetailId
                                INNER JOIN MES.MoWarehouseEnry c on b.MweId = c.MweId
                                WHERE b.MweDetailId = @MweDetailId";
                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("入庫單單身資料錯誤!");
                        string TransferStatus = "";
                        string ConfirmStatus = "";
                        string ReConfirmStatus = "";
                        int MoId = -1;
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus == "Y") throw new SystemException("入庫單已經確認，不可以刪除!");
                            if (item.ReConfirmStatus == "N") throw new SystemException("入庫單目前不處於可編輯狀態，不可以刪除!");
                            TransferStatus = item.TransferStatus;
                            ConfirmStatus = item.ConfirmStatus;
                            ReConfirmStatus = item.ReConfirmStatus;
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //判斷條碼有沒有被使用
                        foreach (var item in result)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.CurrentMoProcessId,a.NextMoProcessId,a.MoId,a.CurrentProdStatus,a.BarcodeStatus 
                                    FROM MES.Barcode a
                                    WHERE MoId =@MoId
                                    AND BarcodeId =@BarcodeId";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("BarcodeId", item.BarcodeId);
                            var resultBarcode = sqlConnection.Query(sql, dynamicParameters);
                            //if (ConfirmStatus == "Y") throw new SystemException("入庫單已經確認，不可以刪除!");
                            if (resultBarcode.Count() <= 0) throw new SystemException("該入庫單生產的條碼已經有被轉移,不可以刪除");

                            foreach (var item1 in resultBarcode)
                            {
                                var CurrentMoProcessId = item1.CurrentMoProcessId;
                                if (CurrentMoProcessId != -1) throw new SystemException("該入庫單生產的條碼已經被使用,不可以刪除");

                                var NextMoProcessId = item1.NextMoProcessId;
                                if (NextMoProcessId != -1) throw new SystemException("該入庫單生產的條碼已經被使用,不可以刪除");

                                var MoIdresultBarcode = item1.MoId;
                                if (MoIdresultBarcode != MoId) throw new SystemException("該入庫單生產的條碼已經被使用,不可以刪除");

                                var CurrentProdStatus = item1.CurrentProdStatus;
                                if (CurrentProdStatus != "P") throw new SystemException("該入庫單生產的條碼已經被使用,不可以刪除");

                                var BarcodeStatus = item1.BarcodeStatus;
                                if (BarcodeStatus != "8") throw new SystemException("該入庫單生產的條碼已經被使用,不可以刪除");
                            }
                        }
                        #endregion

                        #region //刪除入庫單單身綁定的條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MweBarcode
                                WHERE MweDetailId = @MweDetailId";

                        dynamicParameters.Add("MweDetailId", MweDetailId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除單身綁定條碼後同步更新該入庫單條碼印製狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MweDetail SET
                                LabelStatus = 'S',
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MweDetailId = @MweDetailId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              LabelStatus = "S",
                              LastModifiedDate,
                              LastModifiedBy,
                              MweDetailId
                          });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除Barcode資料
                        foreach (var item in result)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM MES.Barcode
                                WHERE BarcodeId = @BarcodeId";

                            dynamicParameters.Add("BarcodeId", item.BarcodeId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion

        #region //Function 確認段需用的共用檢核

        #region ///檢核品號是否有庫別庫存
        public int CheckInvmcYn(string p1, string p2,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;
            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");

            #region //搜尋該品號是否有庫別庫存
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT TOP 1 1
                      FROM INVMC
                      WHERE MC001 = @p1
                        AND MC002 = @p2";
            dynamicParameters.Add("p1", p1);
            dynamicParameters.Add("p2", p2);
            var Result = sqlConnection.Query(sql, dynamicParameters);
            if (Result.Count() <= 0)
            {
                #region //新增INVMC 
                dynamicParameters = new DynamicParameters();
                sql = @"INSERT INTO INVMC (COMPANY, CREATOR, USR_GROUP, 
                                           CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                           UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                           MC001, MC002)
                                   VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                           @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                           '','','','','',0,0,0,0,0,
                                           @p1 , @p2)";
                dynamicParameters.AddDynamicParams(
                    new
                    {
                        COMPANY = ErpNo,
                        CREATOR = UserNo,
                        USR_GROUP,
                        CREATE_DATE = dateNow,
                        MODIFIER = "",
                        MODI_DATE = "",
                        FLAG = 1,
                        CREATE_TIME = timeNow,
                        CREATE_AP = BaseHelper.ClientComputer(),
                        CREATE_PRID = "BM",
                        p1,
                        p2
                    });
                rows += sqlConnection.Execute(sql, dynamicParameters);
                #endregion
            }
            #endregion

            return rows;
        }
        #endregion

        #region ///檢核批號管理
        public string CheckLotYn(string t1, string t2)
        {
            string CheckLotFlag = "N";
            if (!t1.Equals("N") && t2.Equals("******************"))
            {
                CheckLotFlag = "N";
            }
            else
            {

                CheckLotFlag = "Y";
            }
            return CheckLotFlag;
        }
        #endregion

        #region// 檢核批號庫存
        public string CheckLotQty(string T1, string T2, string T3, double T4, double T5, SqlConnection sqlConnection, string FunctionName)
        {
            string CheckLotQtyFlag = "N";

            dynamicParameters = new DynamicParameters();
            sql = @"SELECT SUM(a.MF008*a.MF010)  AS P_QTY, SUM(a.MF008*a.MF014) AS K_QTY,b.ME007
                      FROM INVMF a
                     INNER JOIN INVME b on a.MF001 = b.ME001 AND a.MF002 = b.ME002
                     WHERE a.MF001 = @T1 
                       AND a.MF002 = @T2 
                       AND a.MF007 = @T3 
                       GROUP BY b.ME007
                        ";
            dynamicParameters.Add("T1", T1);
            dynamicParameters.Add("T2", T2);
            dynamicParameters.Add("T3", T3);

            var CheckLotResult = sqlConnection.Query(sql, dynamicParameters);
            if (FunctionName != "MOCTH")
                if (CheckLotResult.Count() <= 0) throw new SystemException("找不到庫存資訊!!!");
            double P_QTY = 0;
            double K_QTY = 0;
            foreach (var item in CheckLotResult)
            {
                if (item.ME007 != "N") throw new SystemException("品號:" + T1 + "批號:" + T2 + "已經結案了!!!");
                P_QTY = Convert.ToDouble(item.P_QTY);
                K_QTY = Convert.ToDouble(item.K_QTY);
            }
            //double P_QTY = Convert.ToDouble(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).P_QTY);
            //double K_QTY = Convert.ToDouble(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).K_QTY);
            if (P_QTY + T4 >= 0 && K_QTY + T5 >= 0)
            {
                CheckLotQtyFlag = "Y";
            }
            else
            {
                CheckLotQtyFlag = "N";
            }

            return CheckLotQtyFlag;
        }
        #endregion

        #region //檢查庫別庫存
        public string CheckStoQty(string T1, string T2, double T3, double T4, SqlConnection sqlConnection, int D_O5)
        {
            string CheckStoFlag = "N";

            if (D_O5 > 0) return "Y";

            //CMSMA.MA024 1代表沒啟用包裝單位
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT MA024
                      FROM CMSMA";
            var CMSResult = sqlConnection.Query(sql, dynamicParameters);
            if (CMSResult.Count() <= 0) throw new SystemException("找不到共用參數檔!");
            string MA024 = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MA024;

            dynamicParameters = new DynamicParameters();
            sql = @"SELECT MC007  AS S_QTY, MC014  AS K_QTY 
                      FROM INVMC
                     WHERE MC001 = @T1 
                       AND MC002 = @T2 ";
            dynamicParameters.Add("T1", T1);
            dynamicParameters.Add("T2", T2);

            var CheckStoResult = sqlConnection.Query(sql, dynamicParameters);
            if (CheckStoResult.Count() <= 0) throw new SystemException("找不到品號【" + T1 + "】庫別【" + T2 + "】庫存資訊!!!");
            double S_QTY = Convert.ToDouble(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).S_QTY);
            double K_QTY = Convert.ToDouble(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).K_QTY);
            if (!MA024.Equals("1"))
            {
                if (S_QTY + T3 >= 0 && K_QTY + T4 >= 0)
                {
                    CheckStoFlag = "Y";
                }
                else
                {
                    CheckStoFlag = "N";
                }
            }
            else
            {
                if (S_QTY + T3 >= 0)
                {
                    CheckStoFlag = "Y";
                }
                else
                {
                    CheckStoFlag = "N";
                }
            }


            return CheckStoFlag;
        }
        #endregion

        #region //核對製令
        public string CheckMocYn(string FunctionName, string T1, string T2, string T3, SqlConnection sqlConnection)
        {
            string CheckMocFlag = "N";


            if (T1.Equals("Y"))
            {
                switch (FunctionName)
                {
                    case "MOCTI":
                    case "MOCTH":
                        #region //判斷庫別是否為存貨倉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 
                                FROM MOCTA
                                WHERE TA001 = @T2
                                AND TA002 = @T3";
                        dynamicParameters.Add("T2", T2);
                        dynamicParameters.Add("T3", T3);
                        var MOCTAResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MOCTAResult.Count() <= 0)
                        {
                            CheckMocFlag = "N";
                        }
                        else
                        {
                            CheckMocFlag = "Y";
                        }
                        #endregion
                        break;
                }

            }
            else
            {
                CheckMocFlag = "Y";
            }

            return CheckMocFlag;
        }
        #endregion

        #region //核對製令超領
        public string CheckMocQty(string T1, string T2, string T3, double T4, string T5, SqlConnection sqlConnection, string BomMtlItemNo, decimal BomMtlItemQty, string D_A1, string D_A2, int D_O5, double TD006)
        {
            //T5 = 控制超領
            //D_O5 = 庫存影響 1:增 -1:減
            //T4 = 此筆單身領料數量
            //TD006 = 領退料單套數
            string CheckMocFlag = "N";

            if (T5.Equals("Y"))
            {
                if (D_O5 < 0)
                {
                    #region //檢核領料單是否超領
                    #region //檢查此料號是否為替代料，若是則改以原元件檢查是否超領
                    if (BomMtlItemNo != T1 && BomMtlItemQty != 0)
                    {
                        #region //確認此製令單身是否有其他此原元件替代料，並加總計算已領用量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TE030
                                FROM MOCTE 
                                WHERE TE011 = @T2
                                AND TE012 = @T3
                                AND TE027 = @BomMtlItemNo
                                AND TE004 != @BomMtlItemNo
                                AND TE019 = 'Y'";
                        dynamicParameters.Add("T2", T2);
                        dynamicParameters.Add("T3", T3);
                        dynamicParameters.Add("BomMtlItemNo", BomMtlItemNo);

                        var MOCTEResult = sqlConnection.Query(sql, dynamicParameters);

                        decimal sumBomQty = 0;
                        foreach (var item in MOCTEResult)
                        {
                            sumBomQty += item.TE030;
                        }
                        #endregion

                        #region //檢核原元件是否超領
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TB004, TB005
                                FROM MOCTB 
                                WHERE TB003 = @BomMtlItemNo
                                AND TB001 = @T2
                                AND TB002 = @T3";
                        dynamicParameters.Add("BomMtlItemNo", BomMtlItemNo);
                        dynamicParameters.Add("T2", T2);
                        dynamicParameters.Add("T3", T3);

                        var BomMtlItemMOCTBResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in BomMtlItemMOCTBResult)
                        {
                            if (BomMtlItemQty > item.TB004)
                            {
                                throw new SystemException("料號【" + T1 + "】超過原元件需領用量，請確認!!");
                            }
                            else
                            {
                                CheckMocFlag = "Y";
                                return CheckMocFlag;
                            }
                        }
                        #endregion
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TB004-TB005 AS MOCQTY 
                        FROM MOCTB
                        WHERE TB001 = @T2 
                        AND TB002 = @T3 
                        AND TB003 = @T1 ";
                    dynamicParameters.Add("T1", T1);
                    dynamicParameters.Add("T2", T2);
                    dynamicParameters.Add("T3", T3);

                    var CheckStoResult = sqlConnection.Query(sql, dynamicParameters);
                    if (CheckStoResult.Count() <= 0) throw new SystemException("找不到製令領料資訊!!!");
                    decimal MOCQTY = Convert.ToDecimal(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MOCQTY);
                    if (MOCQTY >= Convert.ToDecimal(T4))
                    {
                        CheckMocFlag = "Y";
                    }
                    else
                    {
                        CheckMocFlag = "N";
                    }
                    #endregion

                }
                else
                {
                    double allowQty = 0;

                    #region //取得製令相關資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TB004, a.TB005
                            , b.TA015, b.TA016, b.TA017, b.TA018
                            FROM MOCTB a 
                            INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                            WHERE a.TB001 = @T2 
                            AND a.TB002 = @T3 
                            AND a.TB003 = @T1";
                    dynamicParameters.Add("T1", T1);
                    dynamicParameters.Add("T2", T2);
                    dynamicParameters.Add("T3", T3);

                    var MOCTBResult = sqlConnection.Query(sql, dynamicParameters);

                    if (MOCTBResult.Count() <= 0) throw new SystemException("查詢製令相關資料時錯誤!!");

                    double TB004 = 0; //需領用量
                    double TB005 = 0; //已領用量
                    double TA015 = 0; //預計生產量
                    double TA016 = 0; //已領套數
                    double TA017 = 0; //已生產量
                    double TA018 = 0; //報廢數量
                    foreach (var item in MOCTBResult)
                    {
                        TB004 = Convert.ToDouble(item.TB004);
                        TB005 = Convert.ToDouble(item.TB005);
                        TA015 = Convert.ToDouble(item.TA015);
                        TA016 = Convert.ToDouble(item.TA016);
                        TA017 = Convert.ToDouble(item.TA017);
                        TA018 = Convert.ToDouble(item.TA018);
                    }
                    #endregion
                    #region //檢核退料單套數是否超退
                    //超退套數檢核公式: 本次退套數 MOCTD.TD006 > 已領套數 MOCTA.TA016 - ( 已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018)

                    //計算可退數量(套數)
                    allowQty = TA016 - (TA017 + TA018);

                    #region //檢核退料單單身數量是否超退
                    //超退檢核公式: 本次退料量 MOCTE.TE005 > 已領用量 MOCTB.TB005 - (需領用量MOCTB.TB004 * (已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018) / 預計產量MOCTA.TA015))

                    //計算可超退數量
                    allowQty = TB005 - (TB004 * (TA017 + TA018) / TA015);

                    if (T4 > allowQty)
                    {
                        CheckMocFlag = "N";
                    }
                    else
                    {
                        CheckMocFlag = "Y";
                    }
                    #endregion

                    //if (TA016 > 0 && TD006 > allowQty)
                    //{
                    //    CheckMocFlag = "N";
                    //}
                    //else
                    //{
                    //    #region //檢核退料單單身數量是否超退
                    //    //超退檢核公式: 本次退料量 MOCTE.TE005 > 已領用量 MOCTB.TB005 - (需領用量MOCTB.TB004 * (已生產量MOCTA.TA017 + 報廢數量MOCTA.TA018) / 預計產量MOCTA.TA015))

                    //    //計算可超退數量
                    //    allowQty = TB005 - (TB004 * (TA017 + TA018) / TA015);

                    //    if (T4 > allowQty)
                    //    {
                    //        CheckMocFlag = "N";
                    //    }
                    //    else
                    //    {
                    //        CheckMocFlag = "Y";
                    //    }
                    //    #endregion
                    //}
                    #endregion
                }
            }
            else
            {
                CheckMocFlag = "Y";
            }


            return CheckMocFlag;
        }
        #endregion

        #region //新增庫存批號檔INVME or INVMF
        public int InsertInvmef(string p1, string p2, string p3, string p4, string p5, string p6,
                                string p7, string p8, string p9, int p10, string p11, double p12, string WoErpPrefix, string WoErpNo,
                                string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;
            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");


            dynamicParameters = new DynamicParameters();
            sql = @"SELECT ME001 
                      FROM INVME 
                     WHERE ME001 = @p1 
                       AND ME002 = @p2";
            dynamicParameters.Add("p1", p1);
            dynamicParameters.Add("p2", p2);
            var InvmeResult = sqlConnection.Query(sql, dynamicParameters);

            dynamicParameters = new DynamicParameters();
            if (InvmeResult.Count() > 0)
            {
                #region //新增INVMF
                sql = @"INSERT INTO INVMF (COMPANY, CREATOR, USR_GROUP, 
                                           CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                           UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                           MF001, MF002, MF003, MF004, MF005,
                                           MF006, MF007, MF008, MF009, MF010, MF013)
                                   VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                           @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                           '','','','','',0,0,0,0,0,
                                           @p1, @p2, @p3, @p4, @p5, 
                                           @p8, @p9, @p10, @p11, @p12, @MF013)";
                dynamicParameters.AddDynamicParams(
                    new
                    {
                        COMPANY = ErpNo,
                        CREATOR = UserNo,
                        USR_GROUP,
                        CREATE_DATE = dateNow,
                        MODIFIER = "",
                        MODI_DATE = "",
                        FLAG = 1,
                        CREATE_TIME = timeNow,
                        CREATE_AP = BaseHelper.ClientComputer(),
                        CREATE_PRID = "BM",
                        p1,
                        p2,
                        p3,
                        p4,
                        p5,
                        p8,
                        p9,
                        p10,
                        p11,
                        p12,
                        MF013 = WoErpPrefix + WoErpNo
                    });
                var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                #endregion
            }
            else
            {
                #region //新增INVME
                sql = @"INSERT INTO INVME (COMPANY, CREATOR, USR_GROUP, 
                                           CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                           UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                           ME001, ME002, ME003, ME005, ME006, 
                                           ME007, ME008, ME009, ME010)
                                   VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                           @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                           '','','','','',0,0,0,0,0,
                                           @p1, @p2, @p3, @p4, @p5,
                                           'N', @ME008, @p6, @p7)";
                dynamicParameters.AddDynamicParams(
                    new
                    {
                        COMPANY = ErpNo,
                        CREATOR = UserNo,
                        USR_GROUP,
                        CREATE_DATE = dateNow,
                        MODIFIER = "",
                        MODI_DATE = "",
                        FLAG = 1,
                        CREATE_TIME = timeNow,
                        CREATE_AP = BaseHelper.ClientComputer(),
                        CREATE_PRID = "BM",
                        p1,
                        p2,
                        p3,
                        p4,
                        p5,
                        ME008 = WoErpPrefix + WoErpNo,
                        p6,
                        p7
                    });
                #endregion
                var insertResult1 = sqlConnection.Query(sql, dynamicParameters);


                #region //新增INVMF
                sql = @"INSERT INTO INVMF (COMPANY, CREATOR, USR_GROUP, 
                                           CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                           UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                           MF001, MF002, MF003, MF004, MF005,
                                           MF006, MF007, MF008, MF009, MF010, MF013)
                                   VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                           @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                           '','','','','',0,0,0,0,0,
                                           @p1, @p2, @p3, @p4, @p5, 
                                           @p8, @p9, @p10, @p11, @p12, @MF013)";
                dynamicParameters.AddDynamicParams(
                    new
                    {
                        COMPANY = ErpNo,
                        CREATOR = UserNo,
                        USR_GROUP,
                        CREATE_DATE = dateNow,
                        MODIFIER = "",
                        MODI_DATE = "",
                        FLAG = 1,
                        CREATE_TIME = timeNow,
                        CREATE_AP = BaseHelper.ClientComputer(),
                        CREATE_PRID = "BM",
                        p1,
                        p2,
                        p3,
                        p4,
                        p5,
                        p8,
                        p9,
                        p10,
                        p11,
                        p12,
                        MF013 = WoErpPrefix + WoErpNo
                    });
                var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                #endregion
            }
            return rows;
        }
        #endregion

        #region //新增庫存庫存異動檔INVLA
        public int InsertInvla(string p1, string p2, int p3, string p4, string p5,
                               string p6, string p7, string p8, double p9, double p10,
                               double p11, string p12, string p13, string p14, double p15,
                               string p16, string WoErpPrefix, string WoErpNo, string Supplier,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;
            string p8Date = "";

            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");

            string MA014 = "";
            double LA012 = 0;
            double LA013 = 0;
            double LA017 = 0;
            double LA018 = 0;
            double LA019 = 0;
            double LA020 = 0;

            #region //判斷成本碼
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT b1.TA006,b1.MQ003 WMQ003,a.MQ010,a.MQ003,a.MQ011,y.MA014
                    FROM CMSMQ a
                    OUTER APPLY(
                        SELECT x.MQ003,x1.TA006,x1.TA001 FROM CMSMQ x
                        INNER JOIN MOCTA x1 on x.MQ001 = x1.TA001
                        WHERE x1.TA001 = @WoErpPrefix AND x1.TA002 = @WoErpNo
                    ) b1
                    OUTER APPLY(
                      SELECT MA014 FROM CMSMA
                    ) y
                    WHERE a.MQ001 = @p4";
            //AND a.TE004 = b.TA006
            //AND c.MQ003 = '52'";
            dynamicParameters.Add("p4", p4);
            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
            dynamicParameters.Add("WoErpNo", WoErpNo);
            var LA015Result = sqlConnection.Query(sql, dynamicParameters);
            if (LA015Result.Count() > 0)
            {
                string TA006 = "";
                string WMQ003 = "";
                string MQ003 = "";
                string MQ011 = "";
                foreach (var la in LA015Result)
                {
                    TA006 = la.TA006;
                    WMQ003 = la.WMQ003;
                    MQ003 = la.MQ003;
                    MQ011 = la.MQ011;
                    MA014 = la.MA014;
                }
                if (MQ003.Equals("54") || MQ003.Equals("55") || MQ003.Equals("56") || MQ003.Equals("57"))
                {
                    if (p1.Equals(TA006))
                    {
                        p13 = "r";
                    }
                    else
                    {
                        p13 = MQ011;
                    }
                }
                else if (MQ003.Equals("59") || MQ003.Equals("5A"))
                {
                    if (WMQ003.Equals("52"))
                    {
                        p13 = "R";
                    }
                    else
                    {
                        p13 = MQ011;
                    }
                }
                else
                {
                    //之後挪料單為5C 待確認邏輯
                    p13 = MQ011;
                }
            }
            else
            {
                throw new SystemException("核單邏輯異常, 請通知系統開發室!");
            }
            #endregion

            #region //判斷庫別是否為存貨倉
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT MC004 
                      FROM CMSMC
                     WHERE MC001 = @p7
                       AND MC004 != '1'";
            dynamicParameters.Add("p7", p7);
            var CMSMCResult = sqlConnection.Query(sql, dynamicParameters);
            if (CMSMCResult.Count() > 0)
            {
                p10 = 0;
                p11 = 0;
            }
            #endregion

            if (FunctionName == "MOCTH")
            {
                p8Date = WoErpPrefix + "-" + WoErpNo + " " + Supplier;
            }
            else if (FunctionName.Equals("INVTF"))
            {
                p8Date = Supplier;
            }
            else
            {
                p8Date = WoErpPrefix + "-" + WoErpNo;
            }

            #region //取得本國幣別
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT TOP 1 LTRIM(RTRIM(MA003)) MA003 FROM CMSMA";

            var CMSMAResult = sqlConnection.Query(sql, dynamicParameters);

            if (CMSMAResult.Count() <= 0) throw new SystemException("共用參數檔案資料錯誤!!");

            string Currency = "";
            foreach (var item in CMSMAResult)
            {
                Currency = item.MA003;
            }
            #endregion

            #region //小數點後取位
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT a.MF005, a.MF006
                    FROM CMSMF a 
                    WHERE a.MF001 = @Currency";
            dynamicParameters.Add("Currency", Currency);

            var CMSMFResult = sqlConnection.Query(sql, dynamicParameters);

            if (CMSMFResult.Count() <= 0) throw new SystemException("金額小數點取位資料錯誤!!");

            int unitDecimal = 0;
            int amountDecimal = 0;
            foreach (var item in CMSMFResult)
            {
                unitDecimal = Convert.ToInt32(item.MF005);
                amountDecimal = Convert.ToInt32(item.MF006);
            }
            #endregion


            if (MA014 == "2")
            {
                #region //撈取成本金額資料
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT TOP 1  LB010,LB011,LB012,LB013,LB014
                        FROM INVLB 
                        WHERE LB001 = @LB001
                        ORDER BY LB002 DESC";
                dynamicParameters.Add("LB001", p1);

                var INVLCResult = sqlConnection.Query(sql, dynamicParameters);

                if (INVLCResult.Count() > 0)
                {
                    foreach (var item in INVLCResult)
                    {
                        LA012 = Convert.ToDouble(item.LB010);
                        LA017 = Convert.ToDouble(item.LB011);
                        LA018 = Convert.ToDouble(item.LB012);
                        LA019 = Convert.ToDouble(item.LB013);
                        LA020 = Convert.ToDouble(item.LB014);
                    }
                    LA017 = Math.Round(LA017 * p9, amountDecimal, MidpointRounding.AwayFromZero);
                    LA018 = Math.Round(LA018 * p9, amountDecimal, MidpointRounding.AwayFromZero);
                    LA019 = Math.Round(LA019 * p9, amountDecimal, MidpointRounding.AwayFromZero);
                    LA020 = Math.Round(LA020 * p9, amountDecimal, MidpointRounding.AwayFromZero);
                }
                #endregion
            }
            else
            {
                throw new SystemException("『進銷存參數設定作業』的【成本計價方式】為”標準成本”,尚未規劃,請回報系統開發室!!");
            }


            #region //新增INVLA
            dynamicParameters = new DynamicParameters();
            sql = @"INSERT INTO INVLA (COMPANY, CREATOR, USR_GROUP, 
                                       CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                       UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                       LA001, LA004, LA005, LA006, LA007,
                                       LA008, LA009, LA010, LA011, LA012,
                                       LA013, LA014, LA015, LA016, LA017,
                                       LA018, LA019, LA020, LA021, LA022
                                       )
                                OUTPUT INSERTED.LA001
                               VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                       @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                       '','','','','',0,0,0,0,0,
                                       @LA001, @LA004, @LA005, @LA006, @LA007,
                                       @LA008, @LA009, @LA010, @LA011, @LA012,
                                       @LA013, @LA014, @LA015, @LA016, @LA017,
                                       @LA018, @LA019, @LA020, @LA021, @LA022
                                        )";
            dynamicParameters.AddDynamicParams(
                new
                {
                    COMPANY = ErpNo,
                    CREATOR = UserNo,
                    USR_GROUP,
                    CREATE_DATE = dateNow,
                    MODIFIER = "",
                    MODI_DATE = "",
                    FLAG = 1,
                    CREATE_TIME = timeNow,
                    CREATE_AP = BaseHelper.ClientComputer(),
                    CREATE_PRID = "BM",
                    LA001 = p1,
                    LA004 = p2,
                    LA005 = p3,
                    LA006 = p4,
                    LA007 = p5,
                    LA008 = p6,
                    LA009 = p7,
                    LA010 = p8 = p8Date,
                    LA011 = p9,
                    LA012 = LA012,
                    LA013 = p10,
                    LA014 = p12,
                    LA015 = p13,
                    LA016 = p14,
                    LA017,
                    LA018,
                    LA019,
                    LA020,
                    LA021 = p15,
                    LA022 = p16
                });
            #endregion

            var insertResult = sqlConnection.Query(sql, dynamicParameters);
            rows = insertResult.Count();

            if (rows <= 0) throw new SystemException("執行確認新增【庫存庫存異動檔】時發生錯誤!! 方法名稱:【InsertInvla】");

            return rows;
        }
        #endregion

        #region //品號專案管理檔INVLD
        public int InsertInvld(string p1, string p2, string p3, int p4, string p5,
                               string p6, string p7, string p8, string p9, double p10,
                               double p11, double p12, string p13, double p14,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;
            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");

            #region //新增INVLD
            dynamicParameters = new DynamicParameters();
            sql = @"INSERT INTO INVLD (COMPANY, CREATOR, USR_GROUP, 
                                       CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                       UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                       LD001, LD002, LD003, LD004, LD005,
                                       LD006, LD007, LD008, LD009, LD010,
                                       LD011, LD012, LD013, LD014)
                               VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                       @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                       '','','','','',0,0,0,0,0,
                                       @p1, @p2, @p3, @p4, @p5,
                                       @p6, @p7, @p8, @p9, @p10,
                                       @p11, @p12, @p13, @p14)";
            dynamicParameters.AddDynamicParams(
                new
                {
                    COMPANY = ErpNo,
                    CREATOR = UserNo,
                    USR_GROUP,
                    CREATE_DATE = dateNow,
                    MODIFIER = "",
                    MODI_DATE = "",
                    FLAG = 1,
                    CREATE_TIME = timeNow,
                    CREATE_AP = BaseHelper.ClientComputer(),
                    CREATE_PRID = "BM",
                    p1,
                    p2,
                    p3,
                    p4,
                    p5,
                    p6,
                    p7,
                    p8,
                    p9,
                    p10,
                    p11,
                    p12,
                    p13,
                    p14
                });

            var insertResult = sqlConnection.Execute(sql, dynamicParameters);

            if (insertResult <= 0) throw new SystemException("執行確認新增【庫存庫存異動檔】時發生錯誤!! 方法名稱:【InsertInvla】");
            #endregion
            return rows;
        }
        #endregion

        #region //更新品號基本檔INVMB
        public int UpdateInvmb(string p1, double p2, double p3,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;
            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");

            #region //取得本國幣別
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT TOP 1 LTRIM(RTRIM(MA003)) MA003 FROM CMSMA";

            var CMSMAResult = sqlConnection.Query(sql, dynamicParameters);

            if (CMSMAResult.Count() <= 0) throw new SystemException("共用參數檔案資料錯誤!!");

            string Currency = "";
            foreach (var item in CMSMAResult)
            {
                Currency = item.MA003;
            }
            #endregion

            #region //小數點後取位
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT a.MF005, a.MF006
                    FROM CMSMF a 
                    WHERE a.MF001 = @Currency";
            dynamicParameters.Add("Currency", Currency);

            var CMSMFResult = sqlConnection.Query(sql, dynamicParameters);

            if (CMSMFResult.Count() <= 0) throw new SystemException("金額小數點取位資料錯誤!!");

            int unitDecimal = 0;
            int amountDecimal = 0;
            foreach (var item in CMSMFResult)
            {
                unitDecimal = Convert.ToInt32(item.MF005);
                amountDecimal = Convert.ToInt32(item.MF006);
            }
            #endregion

            #region //取得品號Flag
            int Flag = -1;
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT FLAG
                    FROM INVMB a 
                    WHERE a.MB001 = @MB001";
            dynamicParameters.Add("MB001", p1);

            var resultFlag = sqlConnection.Query(sql, dynamicParameters);

            if (CMSMFResult.Count() <= 0) throw new SystemException("金額小數點取位資料錯誤!!");

            foreach (var item in resultFlag)
            {
                Flag = Convert.ToInt32(item.FLAG);

                if (Flag == 999)
                {
                    Flag = 1;
                }
                else
                {
                    Flag += 1;
                }
            }
            #endregion

            #region //更新INVMB
            dynamicParameters = new DynamicParameters();
            sql = @"UPDATE INVMB
                       SET MODIFIER =@MODIFIER,
                           MODI_DATE= @MODI_DATE,
                           MODI_TIME= @MODI_TIME,
                           MODI_AP= @MODI_AP,
                           MODI_PRID= @MODI_PRID,
                           FLAG= @FLAG,
                           MB064 = MB064 + @p2,
                           MB065 = MB065 + @p3
                     WHERE MB001 = @p1";
            dynamicParameters.AddDynamicParams(
            new
            {
                MODIFIER = UserNo,
                MODI_DATE = dateNow,
                MODI_TIME = timeNow,
                MODI_AP = BaseHelper.ClientComputer(),
                MODI_PRID = "BM",
                FLAG = Flag.ToString(),
                p1,
                p2 = Math.Round(p2, unitDecimal),
                p3 = Math.Round(p3, amountDecimal)
            });

            rows = sqlConnection.Execute(sql, dynamicParameters);

            if (rows <= 0) throw new SystemException("執行確認更新【品號基本檔】時發生錯誤!! 方法名稱:【UpdateInvmb】");
            #endregion
            return rows;
        }
        #endregion

        #region //更新庫別檔INVMC
        public int UpdateInvmc(string p1, double p2, double p3, string p4, string ReceiptDate,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            double a = Math.Round(p3, 6);
            int rows = 0;
            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");
            string MC012 = "";
            //領料缺 最近出庫日 MC013
            //入庫可能缺 最近入庫日 MC0112
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT MC012 FROM INVMC
                     WHERE MC001 = @p1
                       AND MC002 = @p4";
            dynamicParameters.Add("p1", p1);
            dynamicParameters.Add("p4", p4);
            var result = sqlConnection.Query(sql, dynamicParameters);
            foreach (var item in result)
            {
                MC012 = item.MC012;
            }
            if (FunctionName == "MOCTH" && ReceiptDate != "")
            {
                if (MC012 == "")
                {
                    MC012 = ReceiptDate;
                }
                if (Convert.ToInt32(ReceiptDate) > Convert.ToInt32(MC012))
                {
                    MC012 = ReceiptDate;
                }
            }

            #region //取得本國幣別
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT TOP 1 LTRIM(RTRIM(MA003)) MA003 FROM CMSMA";

            var CMSMAResult = sqlConnection.Query(sql, dynamicParameters);

            if (CMSMAResult.Count() <= 0) throw new SystemException("共用參數檔案資料錯誤!!");

            string Currency = "";
            foreach (var item in CMSMAResult)
            {
                Currency = item.MA003;
            }
            #endregion

            #region //小數點後取位
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT a.MF005, a.MF006
                    FROM CMSMF a 
                    WHERE a.MF001 = @Currency";
            dynamicParameters.Add("Currency", Currency);

            var CMSMFResult = sqlConnection.Query(sql, dynamicParameters);

            if (CMSMFResult.Count() <= 0) throw new SystemException("金額小數點取位資料錯誤!!");

            int unitDecimal = 0;
            int amountDecimal = 0;
            foreach (var item in CMSMFResult)
            {
                unitDecimal = Convert.ToInt32(item.MF005);
                amountDecimal = Convert.ToInt32(item.MF006);
            }
            #endregion

            if (result.Count() > 0)
            {
                #region //UPDATE INVMC 
                dynamicParameters = new DynamicParameters();
                sql = @"UPDATE INVMC
                       SET MODIFIER =@MODIFIER,
                           MODI_DATE= @MODI_DATE,
                           MODI_TIME= @MODI_TIME,
                           MODI_AP= @MODI_AP,
                           MODI_PRID= @MODI_PRID,
                           FLAG= FLAG + 1,
                           MC007 = MC007 + @p2,
                           MC008 = MC008 + @p3,
                           MC012 = @MC012
                     WHERE MC001 = @p1
                       AND MC002 = @p4";
                dynamicParameters.AddDynamicParams(
                new
                {
                    MODIFIER = UserNo,
                    MODI_DATE = dateNow,
                    MODI_TIME = timeNow,
                    MODI_AP = BaseHelper.ClientComputer(),
                    MODI_PRID = "BM",
                    p1,
                    p2,
                    p3 = Math.Round(p3, amountDecimal),
                    p4,
                    MC012
                });

                rows = sqlConnection.Execute(sql, dynamicParameters);
                #endregion
            }
            else
            {
                #region //INSERT INVMC
                dynamicParameters = new DynamicParameters();
                sql = @"INSERT INTO INVMC (COMPANY, CREATOR, USR_GROUP, 
                                CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                MC001, MC002, MC003, MC004, MC005, MC006, MC007, MC008, MC009, MC010, MC011,
                                MC012, MC013, MC014, MC015)
                        VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                @MC001, @MC002, @MC003, @MC004, @MC005, @MC006, @MC007, @MC008, @MC009, @MC010, @MC011,
                                @MC012, @MC013, @MC014, @MC015)";
                dynamicParameters.AddDynamicParams(
                    new
                    {
                        COMPANY = ErpNo,
                        CREATOR = UserNo,
                        USR_GROUP,
                        CREATE_DATE = dateNow,
                        MODIFIER = "",
                        MODI_DATE = "",
                        FLAG = 1,
                        CREATE_TIME = timeNow,
                        CREATE_AP = BaseHelper.ClientComputer(),
                        CREATE_PRID = "BM",
                        MC001 = p1,
                        MC002 = p4,
                        MC003 = "",
                        MC004 = 0.000,
                        MC005 = 0.000,
                        MC006 = 0.000,
                        MC007 = p2,
                        MC008 = Math.Round(p3, amountDecimal),
                        MC009 = 0.000,
                        MC010 = 0.00000,
                        MC011 = "",
                        MC012,
                        MC013 = "",
                        MC014 = 0.000,
                        MC015 = ""
                    });
                var insertResult = sqlConnection.Query(sql, dynamicParameters);
                rows += insertResult.Count();
                #endregion
            }

            if (rows <= 0) throw new SystemException("執行確認更新【品號基本檔】時發生錯誤!! 方法名稱:【UpdateInvmb】");

            return rows;
        }
        #endregion

        #region //新增儲位批號異動明細資料INVLF
        public int InsertInvlf(string p1, string p2, string p3, string p4, string p5,
                               string p6, string p7, int p8, string p9, string p10,
                               double p11, double p12, string p13, string p14, string p15,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;
            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");

            #region //新增INVLF
            dynamicParameters = new DynamicParameters();
            sql = @"INSERT INTO INVLF (COMPANY, CREATOR, USR_GROUP, 
                                       CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                       UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                       LF001, LF002, LF003, LF004, LF005,
                                       LF006, LF007, LF008, LF009, LF010,
                                       LF011, LF012, LF013)
                               VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                       @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                       '','','','','',0,0,0,0,0,
                                       @p1, @p2, @p3, @p4, @p5,
                                       @p6, @p7, @p8, @p9, @p10,
                                       @p11, @p12 , @p13)";
            dynamicParameters.AddDynamicParams(
                new
                {
                    COMPANY = ErpNo,
                    CREATOR = UserNo,
                    USR_GROUP,
                    CREATE_DATE = dateNow,
                    MODIFIER = "",
                    MODI_DATE = "",
                    FLAG = 1,
                    CREATE_TIME = timeNow,
                    CREATE_AP = BaseHelper.ClientComputer(),
                    CREATE_PRID = "BM",
                    p1,
                    p2,
                    p3,
                    p4,
                    p5,
                    p6 = p6.Length <= 0 ? "##########" : p6,
                    p7 = p7.Length <= 0 ? "####################" : p7,
                    p8,
                    p9,
                    p10,
                    p11,
                    p12,
                    p13 = p14 + p15
                });
            #endregion
            var insertResult = sqlConnection.Execute(sql, dynamicParameters);

            if (insertResult <= 0) throw new SystemException("執行確認新增【儲位批號異動明細】時發生錯誤!! 方法名稱:【InsertInvlf】");
            return rows;
        }
        #endregion

        #region //更新品號庫別儲位批號檔(INVMM)
        public int InsertInvmm(string p1, string p2, string p3, string p4, double p5,
                               double p6, string p7,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;
            string LastTradeDate = "";
            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");


            if (FunctionName == "MOCTH")
            {
                LastTradeDate = "MM008";
            }
            else
            {
                LastTradeDate = "MM009";
            }

            //CMSMA.MA024 1代表沒啟用包裝單位
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT MA024
                      FROM CMSMA";
            var CMSResult = sqlConnection.Query(sql, dynamicParameters);
            if (CMSResult.Count() <= 0) throw new SystemException("找不到共用參數檔!");
            string MA024 = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MA024;

            dynamicParameters = new DynamicParameters();
            sql = @"SELECT MM001 
                      FROM INVMM 
                     WHERE MM001 = @p1
                       AND MM002 = @p2
                       AND MM003 = @p3 
                       AND MM004 = @p4";
            dynamicParameters.Add("p1", p1);
            dynamicParameters.Add("p2", p2);
            dynamicParameters.Add("p3", p3.Length > 0 ? p3 : "##########");
            dynamicParameters.Add("p4", p4.Length > 0 ? p4 : "####################");
            var chkInvmmResult = sqlConnection.Query(sql, dynamicParameters);

            if (chkInvmmResult.Count() > 0)
            {
                dynamicParameters = new DynamicParameters();
                sql = @"UPDATE INVMM
                           SET MODIFIER =@MODIFIER,
                               MODI_DATE= @MODI_DATE,
                               MODI_TIME= @MODI_TIME,
                               MODI_AP= @MODI_AP,
                               MODI_PRID= @MODI_PRID,
                               FLAG= FLAG + 1,
                               MM005 = MM005 + @p5,
                               MM006 = MM006 + @p6
                         WHERE MM001 = @p1
                           AND MM002 = @p2
                           AND MM003 = @p3
                           AND MM004 = @p4";
                dynamicParameters.AddDynamicParams(
                new
                {
                    MODIFIER = UserNo,
                    MODI_DATE = dateNow,
                    MODI_TIME = timeNow,
                    MODI_AP = BaseHelper.ClientComputer(),
                    MODI_PRID = "BM",
                    p1,
                    p2,
                    p3 = p3.Length > 0 ? p3 : "##########",
                    p4 = p4.Length > 0 ? p4 : "####################",
                    p5,
                    p6
                });

                rows = sqlConnection.Execute(sql, dynamicParameters);
            }
            else
            {

                dynamicParameters = new DynamicParameters();
                sql = @"INSERT INTO INVMM (COMPANY, CREATOR, USR_GROUP, 
                                           CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                           UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                           MM001, MM002, MM003, MM004, MM005,
                                           MM006, " + LastTradeDate + @")
                                   VALUES (@COMPANY, @CREATOR, @USR_GROUP,
                                           @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                           '','','','','',0,0,0,0,0,
                                           @p1 , @p2 , @p3 , @p4 , @p5 , 
                                           @p6 , @p7)";
                dynamicParameters.AddDynamicParams(
                    new
                    {
                        COMPANY = ErpNo,
                        CREATOR = UserNo,
                        USR_GROUP,
                        CREATE_DATE = dateNow,
                        MODIFIER = "",
                        MODI_DATE = "",
                        FLAG = 1,
                        CREATE_TIME = timeNow,
                        CREATE_AP = BaseHelper.ClientComputer(),
                        CREATE_PRID = "BM",
                        p1,
                        p2,
                        p3 = p3.Length > 0 ? p3 : "##########",
                        p4 = p4.Length > 0 ? p4 : "####################",
                        p5,
                        p6,
                        p7
                    });

                rows = sqlConnection.Execute(sql, dynamicParameters);
            }

            if (rows <= 0) throw new SystemException("執行確認新增【品號庫別儲位批號檔】時發生錯誤!! 方法名稱:【InsertInvmm】");

            return rows;
        }
        #endregion

        #region //新增品號批號單頭(INVME)
        public int InsertInvme(string p1, string p2, string p3, string p4, string p5,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;
            string dateNow = DateTime.Now.ToString("yyyyMMdd");
            string timeNow = DateTime.Now.ToString("HH:mm:ss");

            dynamicParameters = new DynamicParameters();
            sql = @"SELECT ME001 
                      FROM INVME 
                     WHERE ME001 = @p1
                       AND ME002 = @p2";
            dynamicParameters.Add("p1", p1);
            dynamicParameters.Add("p2", p2);
            var chkInvmmResult = sqlConnection.Query(sql, dynamicParameters);

            if (chkInvmmResult.Count() <= 0)
            {
                dynamicParameters = new DynamicParameters();
                sql = @"INSERT INTO INVME (COMPANY, CREATOR, USR_GROUP, 
                                       CREATE_DATE,MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID,
                                       UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                       ME001, ME002, ME005, ME006, ME007, 
                                       MM009)
                                VALUES(@COMPANY, @CREATOR, @USR_GROUP,
                                       @CREATE_DATE,@MODIFIER,@MODI_DATE,@FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID,
                                       '','','','','',0,0,0,0,0,
                                       @p1 , @p2 , @p3 , @p4 , 'N',
                                       @p5 )";
                dynamicParameters.AddDynamicParams(
                    new
                    {
                        COMPANY = ErpNo,
                        CREATOR = UserNo,
                        USR_GROUP,
                        CREATE_DATE = dateNow,
                        MODIFIER = "",
                        MODI_DATE = "",
                        FLAG = 1,
                        CREATE_TIME = timeNow,
                        CREATE_AP = BaseHelper.ClientComputer(),
                        CREATE_PRID = "BM",
                        p1,
                        p2,
                        p3,
                        p4,
                        p5
                    });

                rows = sqlConnection.Execute(sql, dynamicParameters);
            }

            if (rows <= 0) throw new SystemException("執行確認新增【品號批號單頭】時發生錯誤!! 方法名稱:【InsertInvme】");

            return rows;
        }
        #endregion

        #region //新增品號批號單身(INVMF)
        public int InsertInvmf(string p1, string p2, string p3, string p4, string p5,
                               string p6, string p7, string p8, string p9, double p10,
                               double p11,
                               string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;

            dynamicParameters = new DynamicParameters();
            sql = @"INSERT INTO INVLA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE,
                                       MODIFIER, MODI_DATE, FLAG, UDF01, UDF02,
                                       UDF03, UDF04, UDF05, UDF06, UDF07,
                                       UDF08, UDF09, UDF10,
                                       MF001, MF002, MF003, MF004, MF005, 
                                       MF006, MF007, MF008, MF009, MF010, 
                                       MF014)
                                VALUES(@COMPANY, @CREATOR, @USR_GROUP,
                                       CONVERT(varchar(100),GETDATE(),112),@CREATOR,CONVERT(varchar(100),GETDATE(),112),0,
                                       '','','','','',0,0,0,0,0,
                                       @p1 , @p2 , @p3 , @p4 , @p5,
                                       @p6 , @p7 , @p8 , @p9 , @p10,
                                       @p11)";
            dynamicParameters.AddDynamicParams(
                new
                {
                    COMPANY = ErpNo,
                    CREATOR = UserNo,
                    USR_GROUP,
                    p1,
                    p2,
                    p3,
                    p4,
                    p5,
                    p6,
                    p7,
                    p8,
                    p9,
                    p10,
                    p11
                });

            rows = sqlConnection.Execute(sql, dynamicParameters);

            if (rows <= 0) throw new SystemException("執行確認新增【品號批號單身】時發生錯誤!! 方法名稱:【InsertInvmf】");

            return rows;
        }
        #endregion

        #region //反確認刪除批號檔INVME INVMF
        public int DelInvmef(string p1, string p2, string p3, string p4, string p5,
                             string p6,
                             string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;

            dynamicParameters = new DynamicParameters();
            sql = @"DELETE INVMF
                     WHERE MF001 = @p1
                       AND MF002 = @p2
                       AND MF003 = @p3
                       AND MF004 = @p4
                       AND MF005 = @p5
                       AND MF006 = @p6";
            dynamicParameters.AddDynamicParams(
            new
            {
                p1,
                p2,
                p3,
                p4,
                p5,
                p6
            });

            rows = sqlConnection.Execute(sql, dynamicParameters);

            dynamicParameters = new DynamicParameters();
            sql = @"SELECT TOP 1 1  
                      FROM INVMF 
                     WHERE MF001 = @p1
                       AND MF002 = @p2";
            dynamicParameters.Add("p1", p1);
            dynamicParameters.Add("p2", p2);
            var chkInvmfResult = sqlConnection.Query(sql, dynamicParameters);
            if (chkInvmfResult.Count() <= 0)
            {
                dynamicParameters = new DynamicParameters();
                sql = @"DELETE INVME
                        WHERE 1=1
                        AND ME001 = @p1
                        AND ME002 = @p2
                       ";
                dynamicParameters.AddDynamicParams(
                new
                {
                    p1,
                    p2,
                });

                rows += sqlConnection.Execute(sql, dynamicParameters);
            }

            if (rows <= 0) throw new SystemException("執行反確認刪除【批號檔】時發生錯誤!! 方法名稱:【DelInvmef】");

            return rows;
        }
        #endregion

        #region //反確認刪除庫存異動檔INVLA
        public int DelInvla(string p1, string p2, int p3, string p4, string p5,
                            string p6,
                            string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;

            dynamicParameters = new DynamicParameters();
            sql = @"DELETE INVLA
                     WHERE LA001 = @p1
                       AND LA004 = @p2
                       AND LA005 = @p3
                       AND LA006 = @p4
                       AND LA007 = @p5
                       AND LA008 = @p6";
            dynamicParameters.AddDynamicParams(
            new
            {
                p1,
                p2,
                p3,
                p4,
                p5,
                p6
            });

            rows = sqlConnection.Execute(sql, dynamicParameters);

            if (rows <= 0) throw new SystemException("執行反確認刪除【庫存異動檔】時發生錯誤!! 方法名稱:【DelInvla】");

            return rows;
        }
        #endregion

        #region //反確認刪除批號異動明細資料INVLF
        public int DelInvlf(string p1, string p2, string p3, string p4, string p5,
                            string p6, string p7,
                            string UserNo, string FunctionName, string ErpNo, SqlConnection erpSqlConnection, string USR_GROUP)
        {
            int rows = 0;

            dynamicParameters = new DynamicParameters();
            sql = @"DELETE INVLF
                     WHERE LF001 = @p1
                       AND LF002 = @p2
                       AND LF003 = @p3
                       AND LF004 = @p4
                       AND LF005 = @p5
                       AND LF006 = @p6
                       AND LF007 = @p7";
            dynamicParameters.AddDynamicParams(
            new
            {
                p1,
                p2,
                p3,
                p4,
                p5,
                p6 = p6.Length <= 0 ? "##########" : p6,
                p7 = p7.Length <= 0 ? "####################" : p7,
            });

            rows = erpSqlConnection.Execute(sql, dynamicParameters);

            if (rows <= 0) throw new SystemException("執行反確認刪除【批號異動明細資料】時發生錯誤!! 方法名稱:【DelInvlf】");

            return rows;
        }
        #endregion

        #region //反確認刪除品號專案管理檔INVLD
        public int DelInvld(string ProjectCode, string MtlItemNo, string TransactionDate, int IncOrDec, string TransactionPrefix,
                            string TransactionNo, string TransactionSeq,
                            string UserNo, string FunctionName, string ErpNo, SqlConnection sqlConnection, string USR_GROUP)
        {
            int rows = 0;

            dynamicParameters = new DynamicParameters();
            sql = @"DELETE INVLD
                     WHERE LD001 = @ProjectCode
                       AND LD002 = @MtlITemNo
                       AND LD003 = @TransactionDate
                       AND LD004 = @IncOrDec
                       AND LD005 = @TransactionPrefix
                       AND LD006 = @TransactionNo
                       AND LD007 = @TransactionSeq";
            dynamicParameters.AddDynamicParams(
            new
            {
                ProjectCode,
                MtlItemNo,
                TransactionDate,
                IncOrDec,
                TransactionPrefix,
                TransactionNo,
                TransactionSeq
            });

            rows = sqlConnection.Execute(sql, dynamicParameters);

            if (rows <= 0) throw new SystemException("執行反確認刪除【品號專案管理檔】時發生錯誤!! 方法名稱:【DelInvld】");

            return rows;
        }
        #endregion

        #endregion
    }
}
