using Dapper;
using Helpers;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using NLog;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Text.RegularExpressions;
using System.Transactions;
using System.Web;

namespace MESDA
{
    public class ProductionDA
    {
        public string MainConnectionStrings = "";
        public string ErpConnectionStrings = "";
        public string HrmConnectionStrings = "";
        public string BpmDbConnectionStrings = "";

        public string BpmServerPath = "";
        public string BpmAccount = "";
        public string BpmPassword = "";

        public int CurrentCompany = -1;
        public int CurrentUser = -1;
        public int CreateBy = -1;
        public int LastModifiedBy = -1;
        public string UserLock = "";
        public string UserNo = "";
        public DateTime CreateDate = default(DateTime);
        public DateTime LastModifiedDate = default(DateTime);

        public string sql = "";
        public JObject jsonResponse = new JObject();
        public Logger logger = LogManager.GetCurrentClassLogger();
        public DynamicParameters dynamicParameters = new DynamicParameters();
        public SqlQuery sqlQuery = new SqlQuery();
        public MamoHelper mamoHelper = new MamoHelper();

        public ProductionDA()
        {
            MainConnectionStrings = ConfigurationManager.AppSettings["MainDb"];
            HrmConnectionStrings = ConfigurationManager.AppSettings["HrmDb"];
            BpmDbConnectionStrings = ConfigurationManager.AppSettings["BpmDb"];

            BpmServerPath = ConfigurationManager.AppSettings["BpmServerPath"];
            BpmAccount = ConfigurationManager.AppSettings["BpmAccount"];
            BpmPassword = ConfigurationManager.AppSettings["BpmPassword"];

            GetUserInfo();

            CreateDate = DateTime.Now;
            LastModifiedDate = DateTime.Now;

            dynamicParameters = new DynamicParameters();
            sqlQuery = new SqlQuery();
        }

        #region //GetUserInfo 取得使用者資訊
        private void GetUserInfo()
        {
            try
            {
                CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["UserCompany"]);
                CurrentUser = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                CreateBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                LastModifiedBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                UserLock = Convert.ToString(HttpContext.Current.Session["UserLock"]);
                UserNo = Convert.ToString(HttpContext.Current.Session["UserNo"]);

                if (HttpContext.Current.Session["CompanySwitch"] != null)
                {
                    if (HttpContext.Current.Session["CompanySwitch"].ToString() == "manual")
                    {
                        CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["CompanyId"]);
                    }
                }

                if (CreateBy <= 0 || LastModifiedBy <= 0) throw new SystemException("使用者編號資料錯誤，請重新整理頁面!!");
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }
        }
        #endregion

        #region //INSERT UserOperateLog 紀錄使用者操作流程
        private void AddUserOperateLog(int DocId = -1)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string FullFunctionName = HttpContext.Current.Request.Path;
                        string IpAddress = BaseHelper.ClientIP();
                        dynamicParameters = new DynamicParameters();

                        sql = @"INSERT INTO BAS.UserOperateLog (DocId, FullFunctionName, IpAddress
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@DocId, @FullFunctionName, @IpAddress
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                DocId,
                                FullFunctionName,
                                IpAddress,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }
        }
        #endregion

        #region //Get
        #region //GetWipOrder -- 取得ERP製令資料 -- Ted 2022.07.22
        public string GetWipOrder(int WoId, string WoErpPrefix, string WoErpFullNo, string MtlItemNo, string DocDate
            , string StartDate, string EndDate, string ConfirmStatus, string WoStatus, string TransferStatus, string SearchKey, string ErpWoTemporaryList,string SoErpNo
            , int WoCnt
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sqlQuery.mainKey = "a.WoId";
                    sqlQuery.auxKey = ", a.CompanyId, a.WoErpPrefix, a.WoErpNo";
                    sqlQuery.columns =
                        @", a.WoErpNo, (a.WoErpPrefix + '-' + a.WoErpNo) WoErpFullNo, a.UserId, a.Version, FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate
                        , a.MtlItemId, a.InventoryId, a.UomId, a.PlanQty, a.RequisitionSetQty, a.StockInQty, a.ScrapQty
                        , ISNULL(FORMAT(a.ExpectedStart, 'yyyy-MM-dd'), '') ExpectedStart, ISNULL(FORMAT(a.ExpectedEnd, 'yyyy-MM-dd'), '') ExpectedEnd
                        , FORMAT(a.ActualStart, 'yyyy-MM-dd') ActualStart, FORMAT(a.ActualEnd, 'yyyy-MM-dd') ActualEnd
                        , FORMAT(a.BomDate, 'yyyy-MM-dd') BomDate, a.BomVersion, a.UrgentMtl, a.Property
                        , a.SoDetailId, a.Project, a.ProductionLine, a.Processor, a.CurrencyCode, a.Exchange
                        , a.TaxCode,a.TaxType, a.TaxRate,a.PricingTerm, a.PaymentTerm,a.RecipientAddress
                        , a.WoRemark,a.LossRateStatus
                        , a.ConfirmStatus, a.ConfirmUserId
                        , FORMAT(a.ConfirmDate, 'yyyy-MM-dd') ConfirmDate, a.WoStatus, a.TransferStatus, a.TransferDate
                        , b.MtlItemNo, b.MtlItemName, b.MtlItemSpec
                        , c.InventoryNo, c.InventoryName
                        , d.UomNo, d.UomName
                        , g.UserName ConfirmUserName, g1.UserName DocUserName
                        , i.WoCnt, i.MrCnt";
                    sqlQuery.mainTables =
                        @"FROM MES.WipOrder a
                        INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                        INNER JOIN SCM.Inventory c ON a.InventoryId = c.InventoryId
                        INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                        LEFT JOIN BAS.[User] g on a.ConfirmUserId = g.UserId
                        LEFT JOIN BAS.[User] g1 on a.CreateBy = g1.UserId
                        LEFT JOIN SCM.SoDetail h ON h.SoDetailId=a.SoDetailId
                        LEFT JOIN SCM.SaleOrder h1 ON h1.SoId=h.SoId
                        LEFT JOIN (
                            SELECT a1.WoId,
                            (
                                SELECT COUNT(1)
                                FROM MES.ManufactureOrder z1
                                WHERE a1.WoId=z1.WoId ) WoCnt,
                            (
                                SELECT COUNT(1) 
                                FROM MES.ManufactureOrder x1
                                INNER JOIN MES.MrDetail y1 ON x1.MoId=y1.MoId AND x1.WoId=a1.WoId )MrCnt
                                FROM MES.WipOrder a1
                        )i ON i.WoId=a.WoId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoId", @" AND a.WoId = @WoId", WoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpPrefix", @" AND a.WoErpPrefix = @WoErpPrefix", WoErpPrefix);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (a.WoErpPrefix + '-' + a.WoErpNo) LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND b.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ConfirmStatus", @" AND a.ConfirmStatus = @ConfirmStatus", ConfirmStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferStatus", @" AND a.TransferStatus = @TransferStatus", TransferStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.DocDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.DocDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SearchKey", @" AND (b.MtlItemNo LIKE '%' + @SearchKey + '%' OR b.MtlItemName LIKE '%' + @SearchKey + '%')", SearchKey);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SoErpNo", @" AND h1.SoErpPrefix+'-'+h1.SoErpNo+'-'+h.SoSequence LIKE '%'+@SoErpNo+'%'", SoErpNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoCnt", @" AND  i.WoCnt < @WoCnt ", WoCnt);
                    if (WoStatus.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoStatus", @" AND a.WoStatus IN @WoStatus", WoStatus.Split(','));

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.WoId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWoDetail -- 取得ERP製令單身資料 -- Ted 2022.08.01
        public string GetWoDetail(int WoId, int WoDetailId, string MtlItemNo, string MtlItemName, string WoErpFullNo, string SubstituteStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sqlQuery.mainKey = "a.WoDetailId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.WoId,a.WoDetailId, CONVERT(NVARCHAR(50),CONVERT(NVARCHAR(50),CONVERT(FLOAT,a.DemandRequisitionQty))) DemandRequisitionQty, a.RequisitionQty, a.Substitute, a.SubstituteStatus
                        ,a.WipDetailRemark, a.CompositionQuantity, a.Base, a.LossRate, a.BomSequence, a.ConfirmStatus, a.MaterialProperties
                        , FORMAT(a.ExpectedRequisitionDate, 'yyyy-MM-dd') ExpectedRequisitionDate
                        , FORMAT(a.ActualRequisitionDate, 'yyyy-MM-dd') ActualRequisitionDate
                        , b.MtlItemId, b.MtlItemNo, b.MtlItemName, b.MtlItemSpec
                        , c.MtlItemId SubstituteMtlItemId, c.MtlItemNo SubstituteMtlItemNo, c.MtlItemName SubstituteMtlItemName, c.MtlItemSpec SubstituteMtlSpec
                        , d.InventoryId, d.InventoryNo, d.InventoryName
                        , e.UomId, e.UomNo
                        , f.WoErpPrefix, f.WoErpNo
                        , f.MtlItemId MainMtlItemId
                        , x.Substitute
                        ";
                    sqlQuery.mainTables =
                        @"FROM MES.WoDetail a
                        INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                        INNER JOIN PDM.MtlItem c on a.SubstituteMtlItemId = c.MtlItemId
                        INNER JOIN SCM.Inventory d on a.InventoryId = d.InventoryId
                        INNER JOIN PDM.UnitOfMeasure e on a.UomId = e.UomId
                        INNER JOIN MES.WipOrder f on a.WoId = f.WoId
                        OUTER APPLY  (
                            SELECT TOP 1 1 Substitute FROM PDM.BomSubstitution x1
                            INNER JOIN PDM.BomDetail x2 on x1.BomDetailId =x2.BomDetailId
                            INNER JOIN PDM.BillOfMaterials x3 on x2.BomId =x3.BomId
                            WHERE x3.MtlItemId = f.MtlItemId
                            AND x2.MtlItemId = a.MtlItemId
                        ) x
                        ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND f.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoId", @" AND a.WoId = @WoId", WoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoDetailId", @" AND a.WoDetailId = @WoDetailId", WoDetailId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND b.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND b.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (f.WoErpPrefix + '-' + f.WoErpNo) LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    if (SubstituteStatus.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SubstituteStatus", @" AND a.SubstituteStatus IN @SubstituteStatus", SubstituteStatus.Split(','));

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.WoDetailId ASC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomSubstitution -- 取得單身元件的替代料-- Shintokuro 2023.10.02
        public string GetBomSubstitution(int MtlItemId, int BomDetailMtlItemId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    string CurrentDay = CreateDate.ToString("yyyy-MM-dd");
                    sqlQuery.mainKey = "a.SubstitutionId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",a.SubstituteStatus,a.SortNumber,a.Quantity,a.TransferStatus,a.EffectiveDate,a.ExpirationDate
                          ,a1.MtlItemId BomSubstitutionMtlItemId,a1.MtlItemNo BomSubstitutionMtlItemNo,a1.MtlItemName BomSubstitutionMtlItemName,a1.MtlItemSpec BomSubstitutionMtlItemSpec
                          ,a2.InventoryNo,a2.InventoryName
                          ,b.MtlItemId BomDetailMtlItemId,b1.MtlItemNo BomDetailMtlItemNo
                        ";
                    sqlQuery.mainTables =
                        @"FROM PDM.BomSubstitution a
                        INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                        INNER JOIN SCM.Inventory a2 on a1.InventoryId = a2.InventoryId
                        INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                        INNER JOIN PDM.MtlItem b1 on b.MtlItemId = b1.MtlItemId
                        INNER JOIN PDM.BillOfMaterials d on b.BomId = d.BomId
                        INNER JOIN PDM.MtlItem d1 on d.MtlItemId = d1.MtlItemId
                        OUTER APPLY(
                            SELECT 
                            (CASE WHEN x.EffectiveDate is not null 
                                        THEN (
                                            case when CONVERT(varchar(10),x.EffectiveDate, 120)  <= @CurrentDay
                                            THEN 1
                                            ELSE 2
                                            END ) 
                                        ELSE 3
                                        END) as EffectiveDateStatus
                                    ,(CASE WHEN x.ExpirationDate is not null 
                                        THEN (
                                            case when CONVERT(varchar(10),x.ExpirationDate, 120)  >= @CurrentDay
                                            THEN 1 
                                            ELSE 2 
                                            END ) 
                                        ELSE 3
                                        END) as ExpirationDateStatus
                            FROM PDM.BomSubstitution x
                            WHERE x.SubstitutionId = a.SubstitutionId
                        ) x
                        ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND d1.CompanyId = @CompanyId AND x.EffectiveDateStatus !=2 AND x.ExpirationDateStatus !=2";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("CurrentDay", CurrentDay);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemId", @" AND d.MtlItemId = @MtlItemId", MtlItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BomDetailMtlItemId", @" AND b.MtlItemId = @BomDetailMtlItemId", BomDetailMtlItemId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.SortNumber ASC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckMtlItemDate -- 檢查品號生效日失效日 -- Ted 2022.09.02
        public string GetCheckMtlItemDate(int MtlItemId, string DocDate)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT MtlItemId, (CASE WHEN EffectiveDate is not null 
		                            THEN (
			                            case when EffectiveDate  <= @DocDate
			                            THEN 1
			                            ELSE 2
			                            END ) 
		                            ELSE 3
		                            END) as EffectiveDate
	                            ,(CASE WHEN ExpirationDate is not null 
		                            THEN (
			                            case when ExpirationDate  >= @DocDate
			                            THEN 1 
			                            ELSE 2 
			                            END ) 
		                            ELSE 3
		                            END) as ExpirationDate
                            FROM PDM.MtlItem
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("DocDate", DocDate);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemId", @" AND MtlItemId = @MtlItemId", MtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    int EffectiveDateStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).EffectiveDate;
                    int ExpirationDateStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ExpirationDate;
                    if (EffectiveDateStatus != 2)
                    { if (ExpirationDateStatus == 2) { throw new SystemException("該品號已經失效不可以使用!"); } }
                    else { throw new SystemException("該品號已經失效不可以使用!"); }
                    //生效日和失效日檢查後狀態: 1可以使用 ,2不可以使用 ,3沒有資料

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProperty -- 取得單別性質 -- Shintokuro 2023-11-10
        public string GetProperty(string WoErpPrefix)
        {
            try
            {
                var ErpNo = "";


                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //撈取單別性質
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT MQ017
                            FROM CMSMQ 
                            WHERE (MQ003 = '51' OR MQ003 = '52')
                            AND MQ001 = @MQ001";
                    dynamicParameters.Add("MQ001", WoErpPrefix);

                    var MQ017Result = sqlConnection.Query(sql, dynamicParameters);
                    if (MQ017Result.Count() <= 0) throw new SystemException("ERP找不到單別資料請重新確認");
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = MQ017Result
                    });
                    #endregion

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcessor -- 取得加工廠商資訊 -- Shintokuro 2023-11-10
        public string GetProcessor(string Processor)
        {
            try
            {
                var ErpNo = "";


                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //撈取單別性質
                    //MA021=交易幣別 MA026價格條件 MA044課稅別 MA053稅額 MA055付款條件代號 MA076稅別碼
                    dynamicParameters = new DynamicParameters();
                    sql = @" SELECT a.MA021 CurrencyCode, a.MA024, a.MA025, a.MA026 PricingTerm, a.MA044 TaxType, a.MA055 PaymentTerm, a.MA076 TaxCode,x.MG003 Exchange
                            ,x2.MA004 TaxRate
                            FROM PURMA a
                            OUTER APPLY(
                                SELECT TOP 1  MG003 FROM CMSMG 
                                WHERE MG001 = a.MA021
                                ORDER BY MG002 DESC
                            ) x
                            OUTER APPLY(
                                SELECT MA004 FROM CMSMA 
                                WHERE COMPANY =@ErpNo
                            ) x2
                            WHERE a.MA001 = @MA001";
                    dynamicParameters.Add("MA001", Processor);
                    dynamicParameters.Add("ErpNo", ErpNo);

                    var MQ017Result = sqlConnection.Query(sql, dynamicParameters);
                    if (MQ017Result.Count() <= 0) throw new SystemException("ERP找不到單別資料請重新確認");
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = MQ017Result
                    });
                    #endregion

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCurrencyCode -- 取得匯率 -- Shintokuro 2023-11-14
        public string GetCurrencyCode(string CurrencyCode)
        {
            try
            {
                var ErpNo = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //撈取單別性質
                    //MA021=交易幣別 MA026價格條件 MA044課稅別 MA053稅額 MA055付款條件代號 MA076稅別碼
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 MG003 Exchange FROM CMSMG 
                            WHERE MG001 = @MG001
                            ORDER BY MG002 DESC";
                    dynamicParameters.Add("MG001", CurrencyCode);

                    var MG003Result = sqlConnection.Query(sql, dynamicParameters);
                    if (MG003Result.Count() <= 0) throw new SystemException("ERP找不到匯率資料請重新確認");
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = MG003Result
                    });
                    #endregion

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetStorehouseAvailableQty -- 取得ERP品號的庫存數量 -- Ann 2022-08-11
        public string GetStorehouseAvailableQty(string MtlItemNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                var ErpNo = "";


                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //取得ERP品號的庫存數量
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MC001, a.MC002";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MC002 InventoryNo ,a.MC007 ,b.MC002 InventoryName
                            ";
                    sqlQuery.mainTables =
                        @"FROM INVMC a
                          INNER JOIN CMSMC b on a.MC002 = b.MC001";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.MC001 = @MtlItemNo";
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MC002 ASC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);


                    //sql = @"SELECT MC002,MC007 
                    //        FROM INVMC 
                    //        WHERE　MC001 = @MtlItemNo";
                    //dynamicParameters.Add("MtlItemNo", MtlItemNo);

                    //var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion

                    #endregion

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMfgOrder -- 取得MES製令資料 -- William 2022-06-29
        public string GetMfgOrder(int MfgOrderId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.MfgOrderId, a.WipOrderId, a.CompanyId, a.WipSeq, 
                                   a.Quantity, a.InputQty, a.CompleteQty, 
                                   a.ModeId, a.RoutingId, a.Status
                              FROM MES.MfgOrder a
                             WHERE 1=1";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MfgOrderId", @" AND a.MfgOrderId = @MfgOrderId", MfgOrderId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineByDevice -- 取得機台資料By裝置 -- William 2022-07-12
        public string GetMachineByDevice(int ShopId, string DeviceIdentifierCode)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.MachineId,a.MachineNo,a.MachineName,a.MachineDesc,c.DeviceIdentifierCode
                              FROM MES.Machine a
                                   LEFT JOIN MES.DeviceMachine b ON a.MachineId = b.MachineId
	                               LEFT JOIN MES.Device c ON b.DeviceId = c.DeviceId
                             WHERE 1 = 1
                               AND a.[Status] = 'A'";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ShopId", @" AND a.ShopId = @ShopId", ShopId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "DeviceIdentifierCode", @" AND c.DeviceIdentifierCode = @DeviceIdentifierCode", DeviceIdentifierCode);

                    var result = sqlConnection.Query(sql, dynamicParameters);


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetManufactureOrder02 -- 取得MES製令資料 -- Ann 2024-06-28
        public string GetManufactureOrder02(int MoId, int ModeId, string WoErpPrefix, string WoErpNo, string MtlItemNo, string MtlItemName, int Quantity, string Status, int WoId, string WoErpFullNo, string OtherInfo, string ProjectNo, string WoErpFullNoAndSeq, int WoSeq
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<ManufactureOrder> manufactureOrders = new List<ManufactureOrder>();
                int TotalCount = 0;
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //檢查資料來源
                        if (OtherInfo.Length > 0)
                        {
                            #region //檢查來源是否為WoErpNo
                            if (OtherInfo.IndexOf("-") != -1)
                            {
                                if (OtherInfo.IndexOf("(") == -1) throw new SystemException("請連製令序號一起輸入! EX:5101-20220929001(1)");
                                else
                                {
                                    string otherWoErpPrefix = OtherInfo.Split('-')[0];
                                    string tempOtherWoErpNo = OtherInfo.Split('-')[1];
                                    string otherWoErpNo = tempOtherWoErpNo.Split('(')[0];
                                    string woSeq = tempOtherWoErpNo.Split('(')[1].Split(')')[0];

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT b.MoId
                                            FROM MES.WipOrder a
                                            INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                                            WHERE a.WoErpPrefix = @WoErpPrefix AND a.WoErpNo = @WoErpNo
                                            AND b.WoSeq = @WoSeq";
                                    dynamicParameters.Add("WoErpPrefix", otherWoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", otherWoErpNo);
                                    dynamicParameters.Add("WoSeq", woSeq);

                                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                                    if (result2.Count() <= 0) throw new SystemException("查無對應製令資料!");
                                    foreach (var item in result2)
                                    {
                                        MoId = item.MoId;
                                    }
                                }
                            }
                            #endregion

                            if (MoId == -1) MoId = Convert.ToInt32(OtherInfo);
                        }

                        if (WoErpFullNoAndSeq.Length > 0 && WoErpFullNoAndSeq.IndexOf("(") == -1)
                        {
                            throw new SystemException("請連製令序號一起輸入! EX:5101-20220929001(1)");
                        }
                        else if (WoErpFullNoAndSeq.Length > 0)
                        {
                            WoErpFullNo = WoErpFullNoAndSeq.Split('(')[0];
                            WoSeq = Convert.ToInt32(WoErpFullNoAndSeq.Split('(')[1].Split(')')[0]);
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId, a.WoSeq, a.Quantity, a.InputQty, a.CompleteQty, a.ScrapQty, a.[Status], a.DeliveryProcess, a.ProjectNo, a.ModeId,ISNULL(a.Remark,'') Remark
                                , b.WoId, b.CompanyId, b.WoErpPrefix, b.WoErpNo, b.PlanQty, b.InventoryId, b.RequisitionSetQty, b.StockInQty, b.ExpectedEnd, b.WoRemark
                                , c.MtlItemId, c.MtlItemNo, c.MtlItemName, c.Version, c.MtlItemSpec, c.InventoryUomId
                                , ISNULL(d.ModeNo, '') ModeNo, ISNULL(d.ModeName, '') ModeName
                                , e.MoSettingId, e.LotStatus
                                , f.StatusNo, f.StatusName, f.StatusDesc
                                , h.BarcodeNo
                                , i.UserNo, i.UserName
                                , j.CompanyName
                                , ISNULL(g.TypeName, '') DeliveryProcessName
                                ,(
                                    SELECT x.MoRoutingId
                                    FROM MES.MoRouting x
                                    WHERE x.MoId = a.MoId
                                    FOR JSON PATH, ROOT('data')
                                ) MoRoutingId
                                ,(
                                    SELECT x.ItemNo, x.ChkUnique
                                    FROM MES.MoProcessItem x
                                    INNER JOIN MES.MoProcess xa ON x.MoProcessId = xa.MoProcessId
                                    WHERE xa.MoId = a.MoId
                                     AND x.ItemNo = 'Lettering'
                                    FOR JSON PATH, ROOT('data')
                                ) LetteringInfo
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                LEFT JOIN MES.ProdMode d ON a.ModeId = d.ModeId
                                INNER JOIN MES.MoSetting e ON a.MoId = e.MoId
                                INNER JOIN BAS.[Status] f ON a.[Status] = f.StatusNo AND f.StatusSchema = 'ManufactureOrder.Status'
                                LEFT JOIN BAS.[Type] g ON a.DeliveryProcess = g.TypeNo AND g.TypeSchema = 'ManufactureOrder.DeliveryProcess'
                                LEFT JOIN MES.Barcode h ON a.MoId = h.MoId AND h.BarcodeNo = @BarcodeNo
                                INNER JOIN BAS.[User] i ON a.CreateBy = i.UserId
                                INNER JOIN BAS.Company j ON j.CompanyId = b.CompanyId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("BarcodeNo", OtherInfo);

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ModeId", @" AND d.ModeId = @ModeId", ModeId);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpPrefix", @" AND b.WoErpPrefix LIKE '%' + @WoErpPrefix + '%'", WoErpPrefix);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpNo", @" AND b.WoErpNo LIKE '%' + @WoErpNo + '%'", WoErpNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND c.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemName", @" AND c.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Quantity", @" AND a.Quantity = @Quantity", Quantity);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoId", @" AND b.WoId = @WoId", WoId);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND (b.WoErpPrefix + '-' + b.WoErpNo +  '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProjectNo", @" AND a.ProjectNo LIKE '%' + @ProjectNo + '%'", ProjectNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoSeq", @" AND a.WoSeq = @WoSeq", WoSeq);
                        if (Status.Length > 0) BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND a.Status IN @Status", Status.Split(','));

                        #region //總筆數計算
                        string sqlCount = @"SELECT COUNT(1) AS TotalCount
                                FROM ("+ sql + ") AS TotalQuery";

                        var TotalCountResult = sqlConnection.Query(sqlCount, dynamicParameters);

                        foreach (var item in TotalCountResult)
                        {
                            TotalCount = item.TotalCount;
                        }
                        #endregion

                        sql += @" ORDER BY a.MoId DESC";

                        if (PageSize > 0 && PageIndex > 0)
                        {
                            sql += @" OFFSET @PageSize * (@PageIndex - 1) ROWS
                                        FETCH NEXT @PageSize ROWS ONLY;";
                            dynamicParameters.Add("PageSize", PageSize);
                            dynamicParameters.Add("PageIndex", PageIndex);
                        }

                        manufactureOrders = sqlConnection.Query<ManufactureOrder>(sql, dynamicParameters).ToList();

                        #region //MES與EPR比對資料
                        int i = 0;
                        var ErpQuantity = 0;
                        foreach (var item in manufactureOrders)
                        {
                            #region //計算領退料單數量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MrErpPrefix, b.MrErpNo
                                    , d.WoErpPrefix, d.WoErpNo
                                    FROM MES.MrWipOrder a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                    INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", item.MoId);

                            var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            ErpQuantity = 0;
                            foreach (var item2 in MrWipOrderResult)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TD006 Quantity
                                        , b.MQ010
                                        , (
                                            SELECT TOP 1 1
                                            FROM MOCTE x
                                            WHERE x.TE001 = a.TD001
                                            AND x.TE002 = a.TD002
                                            AND x.TE019 = 'Y'
                                        ) CheckConfirm
                                        FROM MOCTD a
                                        INNER JOIN CMSMQ b ON a.TD001 = b.MQ001
                                        WHERE a.TD001 = @MrErpPrefix
                                        AND a.TD002 = @MrErpNo
                                        AND a.TD003 = @WoErpPrefix
                                        AND a.TD004 = @WoErpNo";
                                dynamicParameters.Add("MrErpPrefix", item2.MrErpPrefix);
                                dynamicParameters.Add("MrErpNo", item2.MrErpNo);
                                dynamicParameters.Add("WoErpPrefix", item2.WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", item2.WoErpNo);

                                var ErpMrWipOrderResult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item3 in ErpMrWipOrderResult)
                                {
                                    if (item3.CheckConfirm != null)
                                    {
                                        if (item3.MQ010 > 0)
                                        {
                                            ErpQuantity -= item3.Quantity;
                                        }
                                        else
                                        {
                                            ErpQuantity += item3.Quantity;
                                        }
                                    }
                                }
                            }
                            manufactureOrders[i].RequisitionSetQty = ErpQuantity;
                            #endregion

                            #region //搜尋此製令所有已核單入庫單，計算已生產數量及已報廢數量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MweErpPrefix, b.MweErpNo
                                    FROM MES.MweDetail a 
                                    INNER JOIN MES.MoWarehouseEnry b ON a.MweId = b.MweId
                                    WHERE a.MoId = @MoId
                                    AND a.ConfirmStatus = 'Y'
                                    GROUP BY b.MweErpPrefix, b.MweErpNo";
                            dynamicParameters.Add("MoId", item.MoId);

                            var MweDetailResult = sqlConnection.Query(sql, dynamicParameters);

                            double ProductionQty = 0;
                            double MoScrapQty = 0;
                            foreach (var item2 in MweDetailResult)
                            {
                                string MweErpPrefix = item2.MweErpPrefix;
                                string MweErpNo = item2.MweErpNo;

                                #region //查詢ERP入庫單資料並計算
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TI020 Quantity, a.TI021 ScrapQty
                                        FROM MOCTI a 
                                        WHERE a.TI001 = @MweErpPrefix AND a.TI002 = @MweErpNo
                                        AND a.TI013 = @WoErpPrefix AND a.TI014 = @WoErpNo
                                        AND a.TI037 = 'Y'";
                                dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                                dynamicParameters.Add("MweErpNo", MweErpNo);
                                dynamicParameters.Add("WoErpPrefix", item.WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", item.WoErpNo);

                                var MOCTIResult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item3 in MOCTIResult)
                                {
                                    ProductionQty += Convert.ToDouble(item3.Quantity);
                                    MoScrapQty += Convert.ToDouble(item3.ScrapQty);
                                }
                                #endregion
                            }

                            manufactureOrders[i].ProductionQty = ProductionQty;
                            manufactureOrders[i].MoScrapQty = MoScrapQty;
                            #endregion

                            if (CurrentCompany == 4)
                            {
                                #region//撈取製令綁定的客戶簡稱
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(c.MA002,'') AS CustomerShortName,a.TA001,a.TA002
                                     FROM MOCTA a
                                     LEFT JOIN COPTC b ON a.TA026=b.TC001 AND a.TA027=b.TC002
                                     LEFT JOIN COPMA c ON c.MA001=b.TC004
                                     WHERE a.TA001 = @WoErpPrefix AND a.TA002=@WoErpNo";
                                dynamicParameters.Add("WoErpPrefix", item.WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", item.WoErpNo);
                                var CustShortResult = sqlConnection2.Query(sql, dynamicParameters);
                                foreach (var item4 in CustShortResult)
                                {
                                    manufactureOrders[i].CustomerShortName = item4.CustomerShortName;
                                }
                                #endregion
                            }

                            i++;
                        }
                        #endregion
                    }
                }
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    result = manufactureOrders,
                    TotalCount,
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetManufactureOrder -- 取得MES製令資料 -- Ann 2022-07-27
        public string GetManufactureOrder(int MoId, int ModeId, string WoErpPrefix, string WoErpNo, string MtlItemNo, string MtlItemName, int Quantity, string Status, int WoId, string WoErpFullNo, string OtherInfo, string ProjectNo, string WoErpFullNoAndSeq, int WoSeq
            , string QcTypeStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<ManufactureOrder> manufactureOrders = new List<ManufactureOrder>();
                int qcNoticeId = -1;
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        if (OtherInfo.Length > 0)
                        {
                            #region //檢查來源是否為通知單No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoId
                                FROM QMS.QcNotice a
                                WHERE QcNoticeNo = @QcNoticeNo";
                            dynamicParameters.Add("QcNoticeNo", OtherInfo);

                            var qcNoticeResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in qcNoticeResult)
                            {
                                MoId = item.MoId;
                            }
                            #endregion

                            #region //檢查來源是否為WoErpNo
                            if (OtherInfo.IndexOf("-") != -1)
                            {
                                if (OtherInfo.IndexOf("(") == -1) throw new SystemException("請連製令序號一起輸入! EX:5101-20220929001(1)");
                                else
                                {
                                    string otherWoErpPrefix = OtherInfo.Split('-')[0];
                                    string tempOtherWoErpNo = OtherInfo.Split('-')[1];
                                    string otherWoErpNo = tempOtherWoErpNo.Split('(')[0];
                                    string woSeq = tempOtherWoErpNo.Split('(')[1].Split(')')[0];

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT b.MoId
                                            FROM MES.WipOrder a
                                            INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                                            WHERE a.WoErpPrefix = @WoErpPrefix AND a.WoErpNo = @WoErpNo
                                            AND b.WoSeq = @WoSeq
                                            AND a.CompanyId = @CompanyId";
                                    dynamicParameters.Add("WoErpPrefix", otherWoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", otherWoErpNo);
                                    dynamicParameters.Add("WoSeq", woSeq);
                                    dynamicParameters.Add("CompanyId", CurrentCompany);

                                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                                    if (result2.Count() <= 0) throw new SystemException("查無對應製令資料!");
                                    foreach (var item in result2)
                                    {
                                        MoId = item.MoId;
                                    }
                                }
                            }
                            #endregion

                            if (MoId == -1) MoId = Convert.ToInt32(OtherInfo);
                        }

                        if (WoErpFullNoAndSeq.Length > 0 && WoErpFullNoAndSeq.IndexOf("(") == -1)
                        {
                            throw new SystemException("請連製令序號一起輸入! EX:5101-20220929001(1)");
                        }
                        else if (WoErpFullNoAndSeq.Length > 0)
                        {
                            WoErpFullNo = WoErpFullNoAndSeq.Split('(')[0];
                            WoSeq = Convert.ToInt32(WoErpFullNoAndSeq.Split('(')[1].Split(')')[0]);
                        }

                        sqlQuery.mainKey = "a.MoId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.WoSeq, a.Quantity, a.InputQty, a.CompleteQty, a.ScrapQty, a.[Status], a.DeliveryProcess, a.ProjectNo, a.ModeId,ISNULL(a.Remark,'') Remark
                            , b.WoId, b.CompanyId, b.WoErpPrefix, b.WoErpNo, b.PlanQty, b.InventoryId, b.RequisitionSetQty, b.StockInQty,b.WoRemark,b.ExpectedEnd,b.WoRemark,b.ExpectedEnd
                            , c.MtlItemId, c.MtlItemNo, c.MtlItemName, c.Version, c.MtlItemSpec,c.InventoryUomId
                            , ISNULL(d.ModeNo, '') ModeNo, ISNULL(d.ModeName, '') ModeName
                            , e.MoSettingId, e.LotStatus,e.BarcodeCtrl
                            , f.StatusNo, f.StatusName, f.StatusDesc
                            ,(
                                SELECT ga.MoRoutingId
                                FROM MES.MoRouting ga
                                WHERE ga.MoId = a.MoId
                                FOR JSON PATH, ROOT('data')
                            ) MoRoutingId
                            , ISNULL(h.TypeName, '') DeliveryProcessName
                            ,(
                                SELECT ia.ItemNo, ia.ChkUnique
                                FROM MES.MoProcessItem ia
                                INNER JOIN MES.MoProcess ib ON ia.MoProcessId = ib.MoProcessId
                                WHERE ib.MoId = a.MoId AND ia.ItemNo = 'Lettering'
                                FOR JSON PATH, ROOT('data')
                            ) LetteringInfo
                            , i.QcNoticeId, i.QcNoticeType
                            , j.BarcodeNo
                            , k.UserNo, k.UserName
                            ,l.CompanyName
                            ,CASE 
                                WHEN x.QcTypeId IS NULL THEN 'N'
                                ELSE  'Y'
                            END QcTypeStatus
                            ";
                        sqlQuery.mainTables =
                            @"FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                            INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                            LEFT JOIN MES.ProdMode d ON a.ModeId = d.ModeId
                            INNER JOIN MES.MoSetting e ON a.MoId = e.MoId
                            INNER JOIN BAS.[Status] f ON a.[Status] = f.StatusNo AND f.StatusSchema = 'ManufactureOrder.Status'
                            LEFT JOIN BAS.[Type] h ON a.DeliveryProcess = h.TypeNo AND h.TypeSchema = 'ManufactureOrder.DeliveryProcess'
                            LEFT JOIN QMS.QcNotice i ON a.MoId = i.MoId AND i.QcNoticeNo = @QcNoticeNo
                            LEFT JOIN MES.Barcode j ON a.MoId = j.MoId AND j.BarcodeNo = @BarcodeNo
                            INNER JOIN BAS.[User] k ON a.CreateBy = k.UserId
                            INNER JOIN BAS.Company l ON l.CompanyId = b.CompanyId
                            OUTER APPLY(
                                SELECT 
                                    x1.QcTypeId
                                FROM QMS.QcType x1 
                                WHERE x1.ModeId = a.ModeId
                                AND x1.QcTypeNo = 'IPQC' 
                            ) x
                            ";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("QcNoticeNo", OtherInfo);
                        dynamicParameters.Add("BarcodeNo", OtherInfo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ModeId", @" AND d.ModeId = @ModeId", ModeId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpPrefix", @" AND b.WoErpPrefix LIKE '%' + @WoErpPrefix + '%'", WoErpPrefix);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpNo", @" AND b.WoErpNo LIKE '%' + @WoErpNo + '%'", WoErpNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND c.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND c.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Quantity", @" AND a.Quantity = @Quantity", Quantity);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoId", @" AND b.WoId = @WoId", WoId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (b.WoErpPrefix + '-' + b.WoErpNo +  '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProjectNo", @" AND a.ProjectNo LIKE '%' + @ProjectNo + '%'", ProjectNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoSeq", @" AND a.WoSeq = @WoSeq", WoSeq);
                        if (QcTypeStatus == "Y") BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcTypeStatus", @" AND x.QcTypeId IS NOT NULL", QcTypeStatus);
                        if (Status.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.Status IN @Status", Status.Split(','));
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoId DESC";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        manufactureOrders = BaseHelper.SqlQuery<ManufactureOrder>(sqlConnection, dynamicParameters, sqlQuery);

                        #region //MES與EPR比對資料
                        int i = 0;
                        var ErpQuantity = 0;
                        foreach (var item in manufactureOrders)
                        {
                            #region //計算領退料單數量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MrErpPrefix, b.MrErpNo
                                    , d.WoErpPrefix, d.WoErpNo
                                    FROM MES.MrWipOrder a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                    INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", item.MoId);

                            var MrWipOrderResult = sqlConnection.Query(sql, dynamicParameters);

                            ErpQuantity = 0;
                            foreach (var item2 in MrWipOrderResult)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TD006 Quantity
                                        , b.MQ010
                                        , (
                                            SELECT TOP 1 1
                                            FROM MOCTE x
                                            WHERE x.TE001 = a.TD001
                                            AND x.TE002 = a.TD002
                                            AND x.TE019 = 'Y'
                                        ) CheckConfirm
                                        FROM MOCTD a
                                        INNER JOIN CMSMQ b ON a.TD001 = b.MQ001
                                        WHERE a.TD001 = @MrErpPrefix
                                        AND a.TD002 = @MrErpNo
                                        AND a.TD003 = @WoErpPrefix
                                        AND a.TD004 = @WoErpNo";
                                dynamicParameters.Add("MrErpPrefix", item2.MrErpPrefix);
                                dynamicParameters.Add("MrErpNo", item2.MrErpNo);
                                dynamicParameters.Add("WoErpPrefix", item2.WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", item2.WoErpNo);

                                var ErpMrWipOrderResult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item3 in ErpMrWipOrderResult)
                                {
                                    if (item3.CheckConfirm != null)
                                    {
                                        if (item3.MQ010 > 0)
                                        {
                                            ErpQuantity -= item3.Quantity;
                                        }
                                        else
                                        {
                                            ErpQuantity += item3.Quantity;
                                        }
                                    }
                                }
                            }
                            manufactureOrders[i].RequisitionSetQty = ErpQuantity;
                            #endregion

                            #region //搜尋此製令所有已核單入庫單，計算已生產數量及已報廢數量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MweErpPrefix, b.MweErpNo
                                    FROM MES.MweDetail a 
                                    INNER JOIN MES.MoWarehouseEnry b ON a.MweId = b.MweId
                                    WHERE a.MoId = @MoId
                                    AND a.ConfirmStatus = 'Y'
                                    GROUP BY b.MweErpPrefix, b.MweErpNo";
                            dynamicParameters.Add("MoId", item.MoId);

                            var MweDetailResult = sqlConnection.Query(sql, dynamicParameters);

                            double ProductionQty = 0;
                            double MoScrapQty = 0;
                            foreach (var item2 in MweDetailResult)
                            {
                                string MweErpPrefix = item2.MweErpPrefix;
                                string MweErpNo = item2.MweErpNo;

                                #region //查詢ERP入庫單資料並計算
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TI020 Quantity, a.TI021 ScrapQty
                                        FROM MOCTI a 
                                        WHERE a.TI001 = @MweErpPrefix AND a.TI002 = @MweErpNo
                                        AND a.TI013 = @WoErpPrefix AND a.TI014 = @WoErpNo
                                        AND a.TI037 = 'Y'";
                                dynamicParameters.Add("MweErpPrefix", MweErpPrefix);
                                dynamicParameters.Add("MweErpNo", MweErpNo);
                                dynamicParameters.Add("WoErpPrefix", item.WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", item.WoErpNo);

                                var MOCTIResult = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item3 in MOCTIResult)
                                {
                                    ProductionQty += Convert.ToDouble(item3.Quantity);
                                    MoScrapQty += Convert.ToDouble(item3.ScrapQty);
                                }
                                #endregion
                            }

                            manufactureOrders[i].ProductionQty = ProductionQty;
                            manufactureOrders[i].MoScrapQty = MoScrapQty;
                            #endregion

                            if (CurrentCompany == 4)
                            {
                                #region//撈取製令綁定的客戶簡稱
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(c.MA002,'') AS CustomerShortName,a.TA001,a.TA002
                                     FROM MOCTA a
                                     LEFT JOIN COPTC b ON a.TA026=b.TC001 AND a.TA027=b.TC002
                                     LEFT JOIN COPMA c ON c.MA001=b.TC004
                                     WHERE a.TA001 = @WoErpPrefix AND a.TA002=@WoErpNo";
                                dynamicParameters.Add("WoErpPrefix", item.WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", item.WoErpNo);
                                var CustShortResult = sqlConnection2.Query(sql, dynamicParameters);
                                foreach (var item4 in CustShortResult)
                                {
                                    manufactureOrders[i].CustomerShortName = item4.CustomerShortName;
                                }
                                #endregion
                            }

                            i++;
                        }
                        #endregion
                    }
                }
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    data = manufactureOrders,
                    QcNoticeId = qcNoticeId,
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWoSeq -- 取得ERP製令在MES中的數量 -- Ann 2022-07-27
        public string GetWoSeq(int WoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT ISNULL(MAX(a.WoSeq), 0) WoSeq
                            FROM MES.ManufactureOrder a
                            WHERE a.WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcess -- 取得MES製令製程 -- Ann 2022-07-28
        public string GetMoProcess(int MoProcessId, int MoId, string ManufactureOrder
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MoProcessId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MoId, a.MoRoutingId, a.RoutingProcessId, a.ProcessId, a.SortNumber, a.ProcessAlias, a.RoutingItemProcessDesc, a.Remark
                        , a.DisplayStatus, a.NecessityStatus, a.OspFlag, a.ProcessCheckStatus, a.ProcessCheckType, a.PackageFlag
                        , b.ProcessNo, b.ProcessName
                        , (
                            SELECT TOP 1 1
                            FROM MES.BarcodeProcess d
                            WHERE d.MoProcessId = a.MoProcessId
                        ) BarcodeProcess
                        , d.ModeId";
                    sqlQuery.mainTables =
                        @"FROM MES.MoProcess a
                        INNER JOIN MES.Process b ON a.ProcessId = b.ProcessId
                        LEFT JOIN MES.MoRouting c ON a.MoRoutingId = c.MoRoutingId
                        INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                        INNER JOIN MES.WipOrder e ON d.WoId = e.WoId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ManufactureOrder", @" AND ((e.WoErpPrefix + '-' + e.WoErpNo +  '(' + CONVERT(VARCHAR(10), d.WoSeq) + ')') = @ManufactureOrder OR a.MoId = @ManufactureOrder)", ManufactureOrder);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.SortNumber";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessForOspList -- 取得MES製令製程(For委外預排製程) -- Ann 2025-06-06
        public string GetMoProcessForOspList(int MoProcessId, int MoId, string WoErpFullNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql += @"SELECT a.MoProcessId, a.ProcessAlias, a.SortNumber
                            , b.ProcessNo
                            , c.MoId, c.WoSeq, c.Quantity
                            , d.WoErpPrefix, d.WoErpNo
                            , e.MtlItemId, e.MtlItemNo, e.MtlItemName, e.MtlItemSpec
                            , f.DepartmentId
                            , g.DepartmentNo, g.DepartmentName
                            FROM MES.MoProcess a 
                            INNER JOIN MES.Process b ON a.ProcessId = b.ProcessId
                            INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                            INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                            INNER JOIN PDM.MtlItem e ON d.MtlItemId = e.MtlItemId
                            LEFT JOIN BAS.[User] f ON f.UserId = @UserId
                            LEFT JOIN BAS.Department g ON f.DepartmentId = g.DepartmentId
                            WHERE b.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("UserId", CurrentUser);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND (d.WoErpPrefix + '-' + d.WoErpNo +  '(' + CONVERT(VARCHAR(10), c.WoSeq) + ')' = @WoErpFullNo)", WoErpFullNo);

                    sql += @" ORDER BY a.SortNumber";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoMtlSetting -- 取得MES製令用料設定 -- Ann 2022-07-29
        public string GetMoMtlSetting(int MoMtlSettingId, int MoId, string MtlItemNo, string BomSequence, int MoProcessId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MoMtlSettingId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MoId, a.WoDetailId
                        , a.UomId, a.CompositionQuantity, a.Base, a.LossRate, a.BomSequence, a.ProcessBinding
                        , a.MoProcessId, a.BarcodeCtrl, a.MainBarcode, a.ControlType, a.DecompositionFlag, a.BindType
                        , b.UomNo, b.UomName, b.UomType
                        , c.TypeNo, c.TypeName, c.TypeDesc
                        , d.ProcessId, d.ProcessAlias, d.SortNumber
                        , e.MtlItemId, e.WoId
                        , f.MtlItemNo, f.MtlItemName, f.MtlItemSpec";
                    sqlQuery.mainTables =
                        @"FROM MES.MoMtlSetting a
                        INNER JOIN PDM.UnitOfMeasure b ON a.UomId = b.UomId
                        INNER JOIN BAS.[Type] c ON a.ControlType = c.TypeNo AND c.TypeSchema = 'MoMtlSetting.ControlType'
                        LEFT JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                        INNER JOIN MES.WoDetail e ON a.WoDetailId = e.WoDetailId
                        INNER JOIN PDM.MtlItem f ON e.MtlItemId = f.MtlItemId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoMtlSettingId", @" AND a.MoMtlSettingId = @MoMtlSettingId", MoMtlSettingId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND f.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BomSequence", @" AND a.BomSequence LIKE '%' + @BomSequence + '%'", BomSequence);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoMtlSettingId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoSetting -- 取得MES製令設定 -- Ann 2022-07-29
        public string GetMoSetting(int MoId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MoSettingId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MoId, a.LotStatus, a.LotQty, a.BarcodePrefix, a.SequenceLen, a.BarcodePostfix, a.NgToBarcode
                        , a.MtlControl, a.Source, a.PVTQCFlag, a.OQcCheckType, a.BarcodeCtrl, a.TrayBarcode, a.MrType
                        , a.OutputBarcodeFlag, a.NgToDisassembly, a.VehicleFlag, a.FullPassQcFlag
                        , b.WoId, b.Quantity, b.DeliveryProcess
                        , c.MtlItemId, c.WoErpPrefix, c.WoErpNo
                        , d.ModeId, d.ModeNo, d.ModeName
                        , e.MtlItemNo, e.MtlItemName";
                    sqlQuery.mainTables =
                        @"FROM MES.MoSetting a
                        INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                        INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                        LEFT JOIN MES.ProdMode d ON b.ModeId = d.ModeId
                        INNER JOIN PDM.MtlItem e ON c.MtlItemId = e.MtlItemId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoSettingId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodePrint -- 取得批量條碼資料 -- Ann 2022-08-03
        public string GetBarcodePrint(int PrintId, int MoId, string No
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                string[] NoList = No.Split(',');
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.PrintId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.BarcodeNo, a.BarcodeQty, a.MoSettingId, a.ParentBarcode, a.PrintCnt, a.PrintStatus
                        , b.LotQty
                        , c.ModeId, c.Quantity
                        , d.WoErpPrefix, d.WoErpNo
                        , e.MtlItemNo
                        , f.ModeNo, f.ModeName";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodePrint a
                        INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                        INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
                        INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                        INNER JOIN PDM.MtlItem e ON d.MtlItemId = e.MtlItemId
                        INNER JOIN MES.ProdMode f ON c.ModeId = f.ModeId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND d.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PrintId", @" AND a.PrintId = @PrintId", PrintId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND b.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NoFirst", @" AND a.BarcodeNo BETWEEN @NoFirst", NoList.First());
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NoLast", @" AND @NoLast", NoList.Last());
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.PrintId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion 

        #region //GetMoRouting -- 取得MES製令途程資料 -- Ann 2022-08-05
        public string GetMoRouting(int MoId, string RoutingName, int ModeId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MoRoutingId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MoId, a.RoutingItemId, a.SortNumber
                        , b.ControlId, b.MtlItemId, b.RoutingItemConfirm
                        , c.RoutingId, c.RoutingConfirm, c.ModeId, c.RoutingName
                        , d.ModeNo, d.ModeName
                        , e.Cad2DFile, e.DesignDate, e.Edition, e.[Version], e.Cad2DFileAbsolutePath
                        , f.[FileName], f.FileExtension";
                    sqlQuery.mainTables =
                        @"FROM MES.MoRouting a
                        INNER JOIN MES.RoutingItem b ON a.RoutingItemId = b.RoutingItemId
                        INNER JOIN MES.Routing c ON b.RoutingId = c.RoutingId
                        INNER JOIN MES.ProdMode d ON c.ModeId = d.ModeId
                        LEFT JOIN PDM.RdDesignControl e ON b.ControlId = e.ControlId
                        LEFT JOIN BAS.[File] f ON e.Cad2DFile = f.FileId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "RoutingName", @" AND c.RoutingName LIKE '%' + @RoutingName + '%'", RoutingName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ModeId", @" AND c.ModeId = @ModeId", ModeId);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.SortNumber";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetLetteringHistory -- 取得歷程刻字資料 -- Ann 2023-07-11
        public string GetLetteringHistory(string WoErpFullNo, string Lettering, string MtlItemNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (WoErpFullNo.Length <= 0 && Lettering.Length <= 0 && MtlItemNo.Length <= 0) throw new SystemException("至少需輸入一項條件來進行搜尋!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeAttrId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.ItemValue, FORMAT(a.CreateDate, 'yyyy-MM-dd') CreateDate
                        , b.WoSeq
                        , c.WoErpPrefix, c.WoErpNo
                        , d.BarcodeNo";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodeAttribute a 
                        INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                        INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                        INNER JOIN MES.Barcode d ON a.BarcodeId = d.BarcodeId
                        INNER JOIN PDM.MtlItem e ON c.MtlItemId = e.MtlItemId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.CompanyId = @CompanyId AND a.ItemNo = 'Lettering'";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (c.WoErpPrefix + '-' + c.WoErpNo +  '(' + CONVERT(VARCHAR(10), b.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Lettering", @" AND a.ItemValue LIKE '%' + @Lettering + '%'", Lettering);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND e.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoId, a.ItemSeq";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomSequence -- 取得ERP工單單身序號 -- Ann 2022-08-11
        public string GetBomSequence(int WoDetailId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sqlQuery.mainKey = "a.WoDetailId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", CASE WHEN(COUNT(a.WoDetailId) != 0)
                        THEN COUNT(a.WoDetailId)
                        ELSE 1 END Count";
                    sqlQuery.mainTables =
                        @"FROM MES.WoDetail a";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.WoDetailId = @WoDetailId";
                    dynamicParameters.Add("WoDetailId", WoDetailId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.groupBy = "GROUP BY a.WoDetailId";

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoMtlSettingAttribute -- 取得MES製令用料屬性檔 -- Ann 2022-08-11
        public string GetMoMtlSettingAttribute(int MoMtlSettingAttrId, int MoMtlSettingId, string ItemNo, string ItemName
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MoMtlSettingAttrId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MoMtlSettingId, a.ItemNo
                        , a.ItemName, a.ItemDesc, a.ChkUnique, a.ChkRange
                        , b.TypeNo, b.TypeName, b.TypeDesc";
                    sqlQuery.mainTables =
                        @"FROM MES.MoMtlSettingAttribute a
                        INNER JOIN BAS.[Type] b ON a.ItemNo = b.TypeNo AND b.TypeSchema = 'MoMtlSettingAttribute.ItemNo'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND 1=1";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoMtlSettingAttrId", @" AND a.MoMtlSettingAttrId = @MoMtlSettingAttrId", MoMtlSettingAttrId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoMtlSettingId", @" AND a.MoMtlSettingId = @MoMtlSettingId", MoMtlSettingId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ItemNo", @" AND a.ItemNo LIKE '%' + @ItemNo + '%'", ItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ItemName", @" AND a.ItemName LIKE '%' + @ItemName + '%'", ItemName);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoMtlSettingAttrId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBindMoProcess -- 取得物料製令製程資料 -- Ann 2024-05-31
        public string GetBindMoProcess(int MoMtlSettingId)
        {
            try
            {
                if (MoMtlSettingId <= 0) throw new SystemException("物料ID錯誤!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoProcessId
                            FROM MES.MoMtlSetting a 
                            WHERE a.MoMtlSettingId = @MoMtlSettingId";
                    dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoItemPart -- 取得製令刻字號資料 -- Ann 2022-10-22
        public string GetMoItemPart(int MoId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MoItemPartId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MoItemPartPrefix, a.MoItemPartSortNumber, a.MoItemPartNo, a.MoId ,FORMAT(a.CreateDate, 'yyyy-MM-dd') CreateDate";
                    sqlQuery.mainTables =
                        @"FROM MES.MoItemPart a";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND 1=1";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoItemPartId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessItem -- 取得製令製程屬性檔 -- Ann 2022-11-09
        public string GetMoProcessItem(int MoProcessItemId, int MoProcessId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MoProcessItemId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MoProcessId, a.ItemNo, a.ChkUnique
                        , b.TypeNo, b.TypeName, b.TypeDesc";
                    sqlQuery.mainTables =
                        @"FROM MES.MoProcessItem a
                        INNER JOIN BAS.[Type] b ON a.ItemNo = b.TypeNo AND b.TypeSchema = 'RoutingProcessItem.ItemNo'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND 1=1";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoProcessItemId", @" AND a.MoProcessItemId = @MoProcessItemId", MoProcessItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoProcessItemId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProjectNo -- 取得製令專案代碼資料 -- Ann 2022-11-15
        public string GetProjectNo()
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT a.ProjectNo
                            FROM MES.ManufactureOrder a
                            WHERE a.ProjectNo IS NOT NULL";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcode -- 取得條碼資訊 -- Ann 2022-11-22
        public string GetBarcode(string BarcodeNo, int MoId, int MoProcessId, string ItemValue
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "c.BarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", c.BarcodeNo, c.BarcodeQty
                        , d.StatusNo, d.StatusName
                        , e.TypeNo CurrentProdStatusNo, e.TypeName CurrentProdStatusName
                        , (
                            SELECT xa.TypeName + ':' + x.ItemValue 'ItemValue', xa.TypeNo
                            FROM MES.BarcodeAttribute x
                            INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE x.BarcodeId = c.BarcodeId
                            FOR JSON PATH, ROOT('data')
                        ) ItemValue";
                    sqlQuery.mainTables =
                        @"FROM MES.WipOrder a
                        INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                        LEFT JOIN MES.Barcode c ON b.MoId = c.MoId
                        INNER JOIN BAS.[Status] d ON c.BarcodeStatus = d.StatusNo AND d.StatusSchema = 'Barcode.BarcodeStatus'
                        INNER JOIN BAS.[Type] e ON c.CurrentProdStatus = e.TypeNo AND e.TypeSchema = 'Barcode.CurrentProdStatus'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND c.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND c.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ItemValue",
                        @" AND EXISTS (
	                        SELECT TOP 1 1
	                        FROM MES.BarcodeAttribute aa
	                        WHERE aa.BarcodeId = c.BarcodeId
	                        AND aa.MoId = b.MoId
	                        AND aa.ItemValue = @ItemValue
                        )", ItemValue);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoProcessId",
                        @" AND EXISTS (
	                        SELECT TOP 1 1
	                        FROM MES.BarcodeProcess aa
	                        WHERE aa.MoId = b.MoId
	                        AND aa.BarcodeId = c.BarcodeId
                            AND aa.MoProcessId = @MoProcessId
                        )
                        ", MoProcessId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "c.BarcodeId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSumPlanQty -- 取得所有指定之MES製令預計生產量 -- Ann 2023-04-20
        public string GetSumPlanQty(int WoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ISNULL(SUM(a.Quantity), 0) Quantity
                            FROM MES.ManufactureOrder a
                            WHERE a.WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoItemPart -- 取得刻字條碼設定資料 -- Ann 2023-07-11
        public string GetMoItemPart(string MoItemPartNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoItemPartId, a.MoItemPartPrefix, a.MoItemPartSortNumber, a.MoItemPartNo, a.MoId
                            FROM MES.MoItemPart a 
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoItemPartNo", @" AND a.MoItemPartNo = @MoItemPartNo", MoItemPartNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeAttribute02 -- 取得刻字條碼資料 -- Ann 2023-07-11
        public string GetBarcodeAttribute02(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeAttrId, a.MoId, a.BarcodeId, a.ItemNo, a.ItemValue, a.ItemSeq
                            FROM MES.BarcodeAttribute a 
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND b.BarcodeNo = @BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessChange -- 取得製令途程變更單 -- Shintokuro 2022.10.27
        public string GetMoProcessChange(int MpcId, int MoId, string MoNo, string StartDocDate, string EndDocDate, string Status
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MpcId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",a.MpcNo, a.MoId, a.MpcUserId,FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate, a.Remark, a.Status
                           ,(b1.WoErpPrefix + '-' + b1.WoErpNo + '(' + CONVERT ( Varchar , b.WoSeq ) + ')') MoNo
                          ,b2.MtlItemNo ,b2.MtlItemName
                          ,b3.LotStatus
                          ,c.UserName MpcUserName
                          ";
                    sqlQuery.mainTables =
                        @"FROM MES.MoProcessChange a
                          INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                          INNER JOIN MES.WipOrder b1 on b.WoId = b1.WoId
                          INNER JOIN PDM.MtlItem b2 on b1.MtlItemId = b2.MtlItemId
                          INNER JOIN MES.MoSetting b3 on b.MoId = b3.MoId
                          INNER JOIN BAS.[User] c on a.MpcUserId = c.UserId
                         ";
                    string queryTable = "";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @"AND a.CompanyId=@CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MpcId", @" AND a.MpcId = @MpcId", MpcId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoNo", @" AND (b1.WoErpPrefix + '-' + b1.WoErpNo + '(' + CONVERT ( Varchar , b.WoSeq ) + ')') = @MoNo", MoNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDocDate", @" AND a.DocDate >= @StartDocDate ", StartDocDate.Length > 0 ? Convert.ToDateTime(StartDocDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDocDate", @" AND a.DocDate <= @EndDocDate ", EndDocDate.Length > 0 ? Convert.ToDateTime(EndDocDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    if (Status.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.Status IN @Status", Status.Split(','));

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MpcId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMpcRoutingProcess -- 取得途程製程資料 -- Shintokuro 2022-10-31
        public string GetMpcRoutingProcess(int MpcRoutingProcessId, int MpcId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MpcRoutingProcessId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MpcId, a.MoProcessId, a.SortNumber, a.ProcessAlias, a.DisplayStatus
                        , a.NecessityStatus
                        , b.Status
                        , d.TypeName NecessityStatusName";
                    sqlQuery.mainTables =
                        @"FROM MES.MpcRoutingProcess a
                        INNER JOIN MES.MoProcessChange b ON a.MpcId = b.MpcId
                        INNER JOIN MES.MoProcess c ON a.MoProcessId = c.MoProcessId
                        INNER JOIN BAS.[Type] d ON a.NecessityStatus = d.TypeNo AND d.TypeSchema = 'RoutingProcess.NecessityStatus'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MpcRoutingProcessId", @" AND a.MpcRoutingProcessId = @MpcRoutingProcessId", MpcRoutingProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MpcId", @" AND a.MpcId = @MpcId", MpcId);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.SortNumber";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMpcBarcode -- 取得途程變更單綁定條碼 -- Shintokuro 2022-11-01
        public string GetMpcBarcode(int MpcId, int MpcBarcodeId, string BarcodeNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MpcBarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MpcId, a.BarcodeNo";
                    sqlQuery.mainTables =
                        @"FROM MES.MpcBarcode a";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND 1=1";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MpcId", @" AND a.MpcId = @MpcId", MpcId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MpcBarcodeId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMpcBarcodeRouting -- 取得途程製程資料 -- Shintokru 2022-11-04
        public string GetMpcBarcodeRouting(int MpcBarcodeId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MpcBarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.RoutingId, a.ProcessId, a.SortNumber, a.ProcessAlias, a.DisplayStatus
                        , a.NecessityStatus
                        , b.RoutingName, b.RoutingType, b.RoutingConfirm
                        , c.ProcessNo, c.ProcessName
                        , d.TypeName NecessityStatusName";
                    sqlQuery.mainTables =
                        @"FROM MES.RoutingProcess a
                        INNER JOIN MES.Routing b ON a.RoutingId = b.RoutingId
                        INNER JOIN MES.Process c ON a.ProcessId = c.ProcessId
                        INNER JOIN BAS.[Type] d ON a.NecessityStatus = d.TypeNo AND d.TypeSchema = 'RoutingProcess.NecessityStatus'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MpcBarcodeId", @" AND a.MpcBarcodeId = @MpcBarcodeId", MpcBarcodeId);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.SortNumber";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetFlowCardPdf -- 取得流程卡資料 -- Shintokuro - 20222-11-04
        public string GetFlowCardPdf(int MoId)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT CONCAT(b.WoErpPrefix,'-',b.WoErpNo,'(', a.WoSeq ,')') MoNo,a.MoId,a.Quantity,a.ModeId
                            ,b.PlanQty,ISNULL(FORMAT(b.ExpectedEnd, 'yyyy/MM/dd'), '') ExpectedEnd
                            ,b2.MtlItemNo,b2.MtlItemName,b2.MtlItemSpec
                            ,b3.InventoryName
                            ,c.ProcessAlias,c.RoutingItemProcessDesc,c.Remark,c.SortNumber,c.ProcessCheckStatus
                            ,d.UserName,d1.UserName 'RountUserName'
                            ,e.LotStatus ,e.BarcodeCtrl, e.LotQty
                            ,f2.Edition,f5.CustomerDwgNo
                            ,f6.Remark RoutingRemark
                            ,a1.ModeNo,e.BarcodeCtrl,e.OQcCheckType ,a.Remark MoRemark,b.WoRemark
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.ProdMode a1 on a.ModeId = a1.ModeId
                            INNER JOIN MES.WipOrder b on a.WoId = b.WoId
                            INNER JOIN PDM.MtlItem b2 on b.MtlItemId = b2.MtlItemId
                            INNER JOIN SCM.Inventory b3 on b.InventoryId = b3.InventoryId
                            INNER JOIN MES.MoProcess c on a.MoId = c.MoId
                            INNER JOIN BAS.[User] d on d.UserId = a.CreateBy
                            INNER JOIN MES.MoSetting e on a.MoId = e.MoId
                            LEFT JOIN MES.MoRouting f on c.MoRoutingId = f.MoRoutingId
                            LEFT JOIN MES.RoutingItem f1 on f.RoutingItemId = f1.RoutingItemId
                            LEFT JOIN PDM.RdDesignControl f2 on f1.ControlId = f2.ControlId
                            LEFT JOIN PDM.RdDesign f3 on f2.DesignId = f3.DesignId
                            LEFT JOIN PDM.CustomerCadControl f4 on f3.CustomerCadControlId = f4.ControlId
                            LEFT JOIN PDM.CustomerCad f5 on f4.CadId = f5.CadId
                            LEFT JOIN MES.RoutingItemProcess f6 on c.RoutingProcessId = f6.RoutingProcessId AND f1.RoutingItemId = f6.RoutingItemId
                            LEFT JOIN BAS.[User] d1 ON d1.UserId=f1.CreateBy
                            WHERE a.MoId = @MoId
                            AND c.DisplayStatus ='Y'
                            ORDER BY c.SortNumber";
                    dynamicParameters.Add("@MoId", MoId);
                    dynamicParameters.Add("@CreateBy", CreateBy);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodePrintData -- 取得流程卡標籤條碼資料 -- Shintokuro - 2024-08-06
        public string GetBarcodePrintData(string MoIdList)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT a.MoId,a.Quantity
                            ,CONCAT(a1.WoErpPrefix,'-',a1.WoErpNo,'(', a.WoSeq ,')') MoNo
                            ,b.MtlItemNo,b.MtlItemName,b.MtlItemSpec,a2.BarcodeCtrl,a2.LotStatus
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder a1 on a.WoId = a1.WoId
                            INNER JOIN MES.MoSetting a2 on a.MoId = a2.MoId
                            INNER JOIN PDM.MtlItem b on a1.MtlItemId = b.MtlItemId
                            WHERE a2.BarcodeCtrl = 'Y'
                            AND a2.LotStatus = 'N'
                            AND a.MoId in ( " + MoIdList + @" )";
                    dynamicParameters.Add("@MoIdList", MoIdList);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion


        #region //GetCallSlipPdf -- 領料卡(倉庫) -- Shintokru 2022.12.06
        public string GetCallSlipPdf(int MoId)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT CONCAT(b.WoErpPrefix,'-',b.WoErpNo,'(', a.WoSeq ,')') MoNo,a.MoId,a.Quantity
                            ,b.PlanQty,ISNULL(FORMAT(b.ExpectedEnd, 'yyyy/MM/dd'), '') ExpectedEnd
                            ,b2.MtlItemNo,b2.MtlItemName,b2.MtlItemSpec
                            ,b3.InventoryNo,b3.InventoryName
                            ,c.DemandRequisitionQty,c.SubstituteStatus
                            ,c1.MtlItemNo MtlItemNoDetail,c1.MtlItemName MtlItemNameDetail
                            ,c2.InventoryNo InventoryNoDetail ,c2.InventoryName InventoryNameDetail
                            ,d.UserName
                            ,e1.ProductionLine
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b on a.WoId = b.WoId
                            INNER JOIN PDM.MtlItem b2 on b.MtlItemId = b2.MtlItemId
                            INNER JOIN SCM.Inventory b3 on b.InventoryId = b3.InventoryId
                            INNER JOIN MES.WoDetail c on b.WoId = c.WoId
                            INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
                            INNER JOIN SCM.Inventory c2 on c1.InventoryId = c2.InventoryId
                            INNER JOIN BAS.[User] d on d.UserId = @CreateBy
                            INNER JOIN MES.MrWipOrder e on a.MoId = e.MoId
                            INNER JOIN MES.MaterialRequisition e1 on e.MrId = e1.MrId
                            WHERE a.MoId = @MoId";
                    dynamicParameters.Add("@MoId", MoId);
                    dynamicParameters.Add("@CreateBy", CreateBy);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProductionLine-- 取得線別名稱(ERP) -- Shintokru 2022.12.06
        public string GetProductionLine(string ProductionLine)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    string Plant = "";
                    switch (CurrentCompany)
                    {
                        case 2:
                            Plant = "ZY01";
                            break;
                        case 4:
                            Plant = "001";
                            break;
                        case 5:
                            Plant = "JQ001";
                            break;
                    }

                    sql = @"SELECT LTRIM(RTRIM(MD001)) ProduceLineNo, LTRIM(RTRIM(MD002)) ProduceLineName
                            FROM CMSMD
                            LEFT JOIN CMSMB ON MB001=MD003
                            WHERE MD003=@Plant
                            AND MD001=@ProductionLine";
                    dynamicParameters.Add("@Plant", Plant);
                    dynamicParameters.Add("@ProductionLine", ProductionLine);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetInventoryQty-- 取得庫存數量(ERP) -- Shintokru 2022.12.06
        public string GetInventoryQty(string MtlItemNo, string InventoryNo)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    sql = @"SELECT LTRIM(RTRIM(MC007)) InventoryQty
                            FROM INVMC
                            WHERE MC001=@MtlItemNo
                            AND MC002=@InventoryNo";
                    dynamicParameters.Add("@MtlItemNo", MtlItemNo);
                    dynamicParameters.Add("@InventoryNo", InventoryNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeLetteringPdf -- 刻字條碼列印 -- Shintokru 2022.12.05
        public string GetBarcodeLetteringPdf(int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT a.MoItemPartId,a.MoItemPartNo  ,CONCAT(c.WoErpPrefix,'-',c.WoErpNo,'(', b.WoSeq ,')') MoNo
                            FROM MES.MoItemPart a
                            INNER JOIN MES.ManufactureOrder b on a.MoId = b.MoId
                            INNER JOIN MES.WipOrder c on b.WoId = c.WoId
                            WHERE a.MoId =@MoId
                            ORDER BY a.MoItemPartSortNumber";
                    dynamicParameters.Add("@MoId", MoId);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodePrintPdf -- 批量條碼列印 -- Shintokru 2023.03.08
        public string GetBarcodePrintPdf(int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT a.BarcodeNo
                            FROM MES.BarcodePrint a
                            INNER JOIN MES.MoSetting b on a.MoSettingId = b.MoSettingId
                            INNER JOIN MES.ManufactureOrder c on b.MoId = c.MoId
                            WHERE c.MoId =@MoId
                            ORDER BY a.PrintId";
                    dynamicParameters.Add("@MoId", MoId);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCallSlipStatus -- 取得製令是否有領料 -- Shintokru 2022.12.09
        public string GetCallSlipStatus(int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT b.ConfirmStatus
                            FROM MES.MrWipOrder a
                            INNER JOIN MES.MaterialRequisition b on a.MrId = b.MrId
                            WHERE b.ConfirmStatus = 'Y'
                            AND a.MoId = @MoId";
                    dynamicParameters.Add("@MoId", MoId);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //ExcelMoTemporary -- 製令彙整檔匯出Excel -- Shintokru 2022.12.09
        public string ExcelMoTemporary(string MesMoTemporaryList, int ModeId, string MtlItemNo, string MtlItemName, string WoErpFullNo, string ProjectNo, string Status, int Quantity)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (ModeId <= 0 && MtlItemNo.Length <= 0 && MtlItemName.Length <= 0 && WoErpFullNo.Length <= 0 && ProjectNo.Length <= 0 && Quantity <= 0) throw new SystemException("搜尋視窗的專案代碼條件不能為空，不能列印!");

                    int testNum = Status.Split(',').Count();
                    sql = @"SELECT a.MoId, a.WoSeq, a.ProjectNo, a.MoId, a.MoId, a.MoId, a.Quantity,
                            b.WoErpPrefix, b.WoErpNo, FORMAT(b.DocDate, 'yyyy-MM-dd') DocDate, 
                            c.MtlItemNo, c.MtlItemName
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b on a.WoId = b.WoId
                            INNER JOIN PDM.MtlItem c on b.MtlItemId = c.MtlItemId
                            LEFT JOIN MES.ProdMode d ON a.ModeId = d.ModeId
                            WHERE 1=1";
                    //dynamicParameters.Add("@MoId", MesMoTemporaryList.Split(','));
                    if (ModeId > 0) { sql += "  AND d.ModeId = @ModeId"; dynamicParameters.Add("@ModeId", ModeId); };
                    if (ProjectNo.Length > 0) { sql += "  AND a.ProjectNo = @ProjectNo"; dynamicParameters.Add("@ProjectNo", ProjectNo); };
                    if (MtlItemNo.Length > 0) { sql += "  AND c.MtlItemNo LIKE '%' + @MtlItemNo + '%'"; dynamicParameters.Add("@MtlItemNo", MtlItemNo); };
                    if (MtlItemName.Length > 0) { sql += "  AND c.MtlItemName LIKE '%' + @MtlItemName + '%'"; dynamicParameters.Add("@MtlItemName", MtlItemName); };
                    if (WoErpFullNo.Length > 0) { sql += "  AND (b.WoErpPrefix + '-' + b.WoErpNo) LIKE '%' + @WoErpFullNo + '%'"; dynamicParameters.Add("@WoErpFullNo", WoErpFullNo); };
                    if (Status.Length > 0) { sql += " AND a.Status IN @Status"; dynamicParameters.Add("@Status", Status.Split(',')); };
                    if (Quantity > 0) { sql += " AND a.Quantity = @Quantity"; dynamicParameters.Add("@Quantity", Quantity); };
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPrintImitationLabel -- 取得模造道具標籤內容資訊查詢 -- Shintokru 2023.03.31
        public string GetPrintImitationLabel(int MoId, string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT b.BarcodeId,e.MtlItemNo, e.MtlItemName, a.ItemValue, b.BarcodeNo, b.MoId,a.ItemSeq
                            FROM MES.BarcodeAttribute a
                                INNER JOIN MES.Barcode b ON a.BarcodeId=b.BarcodeId
                                INNER JOIN MES.ManufactureOrder c ON b.MoId=c.MoId
                                INNER JOIN MES.WipOrder d ON c.WoId=d.WoId
                                INNER JOIN PDM.MtlItem e ON d.MtlItemId=e.MtlItemId
                            WHERE a.ItemNo='Lettering'  ";
                    if (MoId > 0)
                    {
                        sql += @" AND b.MoId = @MoId";
                    }
                    if (BarcodeNo.Length > 0)
                    {
                        sql += @" AND b.MoId = @MoId AND ( b.BarcodeNo = @BarcodeNo or a.ItemValue = @BarcodeNo ) ";
                    }
                    dynamicParameters.Add("@MoId", MoId);
                    dynamicParameters.Add("@BarcodeNo", BarcodeNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetLotBarcodeForLabel -- 標籤機取得批量條碼或包裝條碼 -- Shintokru 2023.05.23
        public string GetLotBarcodeForLabel(string MoId, string BarcodeNo, string BarcodeType, string PrintCnt, int IntervalFirst, int IntervalLast)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoId.IndexOf('-') != -1)
                    {
                        if (MoId.IndexOf('(') == -1)
                        {
                            throw new SystemException("請連製令序號一起輸入! EX:5101-20220929001(1)");
                        }
                        else
                        {
                            string otherWoErpPrefix = MoId.Split('-')[0];
                            string tempOtherWoErpNo = MoId.Split('-')[1];
                            string otherWoErpNo = tempOtherWoErpNo.Split('(')[0];
                            string woSeq = tempOtherWoErpNo.Split('(')[1].Split(')')[0];

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MoId
                                    FROM MES.WipOrder a
                                    INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
                                    WHERE a.WoErpPrefix = @WoErpPrefix AND a.WoErpNo = @WoErpNo
                                    AND b.WoSeq = @WoSeq";
                            dynamicParameters.Add("WoErpPrefix", otherWoErpPrefix);
                            dynamicParameters.Add("WoErpNo", otherWoErpNo);
                            dynamicParameters.Add("WoSeq", woSeq);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);

                            if (result2.Count() <= 0) throw new SystemException("查無對應製令資料!");
                            foreach (var item in result2)
                            {
                                MoId = item.MoId.ToString();
                            }
                        }
                    }
                    if (Convert.ToInt32(BarcodeType) == 0)
                    {
                        sql = @"SELECT b.PrintId LabBarcodeId,b.BarcodeNo,b.BarcodeQty,d.ItemValue,x.OrderNo
                                FROM MES.MoSetting a
                                INNER JOIN MES.BarcodePrint b on a.MoSettingId = b.MoSettingId
                                LEFT JOIN MES.Barcode c on b.BarcodeNo = c.BarcodeNo
                                LEFT JOIN MES.BarcodeAttribute d on c.BarcodeId = d.BarcodeId
                                OUTER APPLY(
                                  SELECT ROW_NUMBER() OVER (ORDER BY x1.PrintId) AS OrderNo,x1.BarcodeNo
                                  FROM MES.BarcodePrint x1
                                  WHERE x1.MoSettingId = a.MoSettingId
                                ) as x
                                WHERE 1=1
                                 AND (d.ItemNo = 'Cavity' or d.ItemNo is null)";
                        if (MoId.Length > 0)
                        {
                            sql += @" AND a.MoId = @MoId
                                      AND b.BarcodeNo = x.BarcodeNo
                                     ";
                        }
                        if (BarcodeNo.Length > 0)
                        {
                            sql += @" AND b.BarcodeNo = @BarcodeNo";
                        }
                        switch (PrintCnt)
                        {
                            case "Y":
                                sql += @" AND b.PrintCnt > 0";
                                break;
                            case "N":
                                sql += @" AND b.PrintCnt = 0";
                                break;
                            case "Interval":
                                if (IntervalFirst <= 0) throw new SystemException("區間設定錯誤，開始位置不可以小於0");
                                if (IntervalLast <= 0) throw new SystemException("區間設定錯誤，結束位置不可以小於0");
                                if (IntervalFirst > IntervalLast) throw new SystemException("區間設定錯誤，開始位置不可以大於結束位置");
                                sql += @"
                                      AND x.OrderNo BETWEEN @IntervalFirst
                                      AND  @IntervalLast
                                     ";
                                dynamicParameters.Add("@IntervalFirst", IntervalFirst);
                                dynamicParameters.Add("@IntervalLast", IntervalLast);
                                break;
                            case "":
                                break;
                        }
                        sql += @" ORDER BY LabBarcodeId";

                    }
                    else if (Convert.ToInt32(BarcodeType) == 1)
                    {
                        if (BarcodeNo == "") throw new SystemException("如果要撈取Tray條碼,條碼不可以為空!");
                        sql = @"SELECT a.TrayNo BarcodeNo FROM MES.Tray a
                                LEFT JOIN MES.Barcode b on a.BarcodeNo = b.BarcodeNo
                                WHERE 1=1
                                AND a.TrayNo = @BarcodeNo";
                    }
                    else if (Convert.ToInt32(BarcodeType) == 2)
                    {
                        sql = @"SELECT  a.PackageBarcodeId LabBarcodeId, a.PackageBarcodeNo BarcodeNo,c.total
                                FROM MES.PackageBarcode a
                                INNER JOIN MES.MoProcess b on a.MoProcessId = b.MoProcessId
                                OUTER  APPLY(
	                                SELECT COUNT(x.PbrId) total from MES.PackageBarcodeReference x
	                                WHERE a.PackageBarcodeId = x.PackageBarcodeId
                                ) c
                                WHERE 1=1";
                        if (MoId.Length > 0)
                        {
                            sql += @" AND b.MoId = @MoId";
                        }
                        if (BarcodeNo.Length > 0)
                        {
                            sql += @" AND a.PackageBarcodeNo = @BarcodeNo";
                        }
                    }

                    dynamicParameters.Add("@MoId", MoId);
                    dynamicParameters.Add("@BarcodeNo", BarcodeNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetMoRoutingItemProcess 取得製令【刻字站】加工細項
        public string GetMoRoutingItemProcess(int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT DISTINCT d.MoId,c.ProcessNo,a.RoutingItemProcessDesc,a.Remark,a.AttrSetting
                             FROM MES.RoutingItemProcess a
                             INNER JOIN MES.RoutingProcess b ON a.RoutingProcessId=b.RoutingProcessId
                             INNER JOIN MES.Process c ON b.ProcessId=c.ProcessId
                             INNER JOIN MES.MoRouting d ON d.RoutingItemId=a.RoutingItemId 
                             WHERE  c.ProcessNo='JMO-IE-0011'
                             AND d.MoId = @MoId";
                    dynamicParameters.Add("@MoId", MoId);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeProcessAttribute -- 取得置換歷程 -- Yi 2023-04-19
        public string GetBarcodeProcessAttribute(int ProcessAttrLogId, int BarcodeId, string OriWoErpFullNo, string NewWoErpFullNo, string MtlItemName, string BarcodeNo, string OriItemValue
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.ProcessAttrLogId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", (c.WoErpPrefix + '-' + c.WoErpNo) OriWoErpFullNo
                        , (g.WoErpPrefix + '-' + g.WoErpNo) NewWoErpFullNo
                        , d.MtlItemName, e.TypeName, a.NewBarcodeId, a1.BarcodeNo, a.OriItemValue, a.NewItemValue
                        , FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm') ReplacementDate, a.Remark";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodeProcessAttributeLog a
                        LEFT JOIN MES.Barcode a1 ON a1.BarcodeId = a.OriBarcodeId
                        LEFT JOIN MES.ManufactureOrder b ON b.MoId = a.OriMoId
                        LEFT JOIN MES.WipOrder c ON c.WoId = b.WoId
                        LEFT JOIN PDM.MtlItem d ON d.MtlItemId = c.MtlItemId
                        LEFT JOIN BAS.[Type] e ON e.TypeNo = a.OriItemNo AND e.TypeSchema = 'RoutingProcessItem.ItemNo'
                        LEFT JOIN MES.ManufactureOrder f ON f.MoId = a.NewMoId
                        LEFT JOIN MES.WipOrder g ON g.WoId = f.WoId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OriWoErpFullNo", @" AND (c.WoErpPrefix + '-' + c.WoErpNo) LIKE '%' + @OriWoErpFullNo + '%'", OriWoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NewWoErpFullNo", @" AND (g.WoErpPrefix + '-' + g.WoErpNo) LIKE '%' + @NewWoErpFullNo + '%'", NewWoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND d.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND a1.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OriItemValue", @" AND a.OriItemValue LIKE '%' + @OriItemValue + '%'", OriItemValue);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.ProcessAttrLogId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeAttribute  -- 取得刻字屬性置換資訊 -- Yi 2023-04-20
        public string GetBarcodeAttribute(int BarcodeAttrId, int BarcodeId, int MoId, string BarcodeNo, string ItemNo, string ItemValue
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    //刻號
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeAttrId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", d.CompanyId, a.ItemNo, a.ItemValue, f.TypeName, b.MoId
                        , b.BarcodeId, b.BarcodeNo, b.BarcodeStatus
                        , c.MoId, (d.WoErpPrefix + '-' +  d.WoErpNo) WoErpFullNo
                        , e.MtlItemNo, e.MtlItemName";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodeAttribute a
                        LEFT JOIN MES.Barcode b ON b.BarcodeId = a.BarcodeId
                        LEFT JOIN MES.ManufactureOrder c ON c.MoId = b.MoId
                        LEFT JOIN MES.WipOrder d ON d.WoId = c.WoId
                        LEFT JOIN PDM.MtlItem e ON e.MtlItemId = d.MtlItemId
                        LEFT JOIN BAS.[Type] f ON f.TypeNo = a.ItemNo AND f.TypeSchema = 'RoutingProcessItem.ItemNo'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.ItemNo = @ItemNo
                                            AND (b.BarcodeNo = @BarcodeNo OR a.ItemValue = @BarcodeNo)
                                            AND d.CompanyId = @CompanyId";
                    dynamicParameters.Add("ItemNo", ItemNo);
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                    dynamicParameters.Add("ItemValue", ItemValue);
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND b.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ItemValue", @" AND a.ItemValue = @ItemValue", ItemValue);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.BarcodeAttrId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeBindItem --取得該批量條碼屬性 --GPai 23230607
        public string GetBarcodeBindItem(int PrintId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT c.BarcodeAttrId, c.ItemValue
                            FROM MES.Barcode a
                            INNER JOIN MES.BarcodePrint b ON a.BarcodeNo = b.BarcodeNo
                            LEFT JOIN MES.BarcodeAttribute c ON c.BarcodeId = a.BarcodeId
                            WHERE  b.PrintId = @PrintId";
                    dynamicParameters.Add("PrintId", PrintId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetInputStatusContent -- 取得輸入框內容狀態類別資料 -- Shinotkuro 2023-08-08
        public string GetInputStatusContent(string Type, string StatusSchema)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (Type.Length <= 0) throw new SystemException("資料錯誤");
                    if (StatusSchema.Length <= 0) throw new SystemException("資料錯誤");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    switch (Type)
                    {
                        case "S":
                            sql = @"SELECT a.StatusNo,a.StatusName 
                                    FROM BAS.[Status] a
                                    WHERE a.StatusSchema = @StatusSchema";
                            dynamicParameters.Add("StatusSchema", StatusSchema);
                            break;
                        case "T":
                            sql = @"SELECT a.TypeNo,a.TypeName 
                                    FROM BAS.[Type] a 
                                    WHERE TypeSchema = @TypeSchema";
                            dynamicParameters.Add("TypeSchema", StatusSchema);
                            break;
                    }

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        
        #region //GetDepSecondmentRecord -- 取得借調部門記錄 -- WuTC 2024-03-13
        public string GetDepSecondmentRecord(int DsId, int UserId, int DepartmentId, string Status, string StartDate, string EndDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.DsId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm') StartDate, FORMAT(a.EndDate, 'yyyy-MM-dd HH:mm') EndDate, a.[Status], ISNULL(a.Remark, '') Remark, a.UserId
                            , b.UserName, b.UserNo
                            , c.DepartmentName as BelongDepartmentName, c.DepartmentId as BelongDepartmentId, c.DepartmentNo as BelongDepartmentNo
                            , e.DepartmentName as SecondmentDepartmentName, e.DepartmentId as SecondmentDepartmentId, e.DepartmentNo as SecondmentDepartmentNo";
                    sqlQuery.mainTables =
                        @"FROM MES.DepartmentalSecondment a
                            INNER JOIN BAS.[User] b ON a.UserId = b.UserId
                            INNER JOIN BAS.Department c ON b.DepartmentId = c.DepartmentId
                            INNER JOIN BAS.Company d ON c.CompanyId = d.CompanyId
                            INNER JOIN BAS.Department e on a.DepartmentId = e.DepartmentId"; //e.DepartmentId 借調部門，c.DepartmentId 所屬部門
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND 1=1";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DsId", @" AND a.DsId = @DsId", DsId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserId", @" AND a.UserId = @UserId", UserId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.Status = @Status", Status);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DepartmentId", @" AND c.DepartmentId = @DepartmentId", DepartmentId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.StartDate >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.EndDate <= @EndDate", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.DsId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetOspList -- 取得委外預排製程資料 -- Ann 2025-06-04
        public string GetOspList(int OspListId, string WoErpFullNo, int DepartmentId, int ProcessId, int SupplierId
            , string MtlItemNo, string MtlItemName, int CreateUserId, string Status, List<int> OspListIds, int PoUserId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.OspListId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.DepartmentId, a.MoProcessId, FORMAT(a.OspDate, 'yyyy-MM-dd') OspDate
                        , a.SupplierId, a.Quantity, ISNULL(a.ProcessCode, '') ProcessCode, ISNULL(a.ProcessCodeName, '') ProcessCodeName
                        , FORMAT(a.ExpectedDate, 'yyyy-MM-dd') ExpectedDate
                        , a.ProcessCheckStatus, a.ProcessCheckType, a.[Status], ISNULL(a.Remark, '') Remark
                        , b.DepartmentNo, b.DepartmentName
                        , c.ProcessAlias, c.MoId, c.RoutingItemProcessDesc
                        , ISNULL(d.SupplierNo, '') SupplierNo, ISNULL(d.SupplierShortName, '') SupplierShortName
                        , e.WoSeq
                        , f.WoErpPrefix, f.WoErpNo
                        , g.MtlItemNo, g.MtlItemName, g.MtlItemSpec
                        , h.ProcessNo
                        , i.UserNo CreateUserNo, i.UserName CreateUserName
                        , ISNULL(j.UserNo, '') PoUserNo, ISNULL(j.UserName, '') PoUserName";
                    sqlQuery.mainTables =
                        @"FROM MES.OspList a 
                        INNER JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                        INNER JOIN MES.MoProcess c ON a.MoProcessId = c.MoProcessId
                        LEFT JOIN SCM.Supplier d ON a.SupplierId = d.SupplierId
                        INNER JOIN MES.ManufactureOrder e ON c.MoId = e.MoId
                        INNER JOIN MES.WipOrder f ON e.WoId = f.WoId
                        INNER JOIN PDM.MtlItem g ON f.MtlItemId = g.MtlItemId
                        INNER JOIN MES.Process h ON c.ProcessId = h.ProcessId
                        INNER JOIN BAS.[User] i ON a.CreateBy = i.UserId
                        LEFT JOIN BAS.[User] j ON a.PoUserId = j.UserId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspListId", @" AND a.OspListId = @OspListId", OspListId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (f.WoErpPrefix + '-' + f.WoErpNo +  '(' + CONVERT(VARCHAR(10), e.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DepartmentId", @" AND a.DepartmentId = @DepartmentId", DepartmentId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessId", @" AND c.ProcessId = @ProcessId", ProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SupplierId", @" AND a.SupplierId = @SupplierId", SupplierId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND g.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND g.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CreateUserId", @" AND a.CreateBy = @CreateUserId", CreateUserId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.Status = @Status", Status);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PoUserId", @" AND a.PoUserId = @PoUserId", PoUserId);

                    if (OspListIds != null)
                    {
                        queryCondition += @" AND a.OspListId IN @OspListIds";
                        dynamicParameters.Add("OspListIds", OspListIds);
                    }

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcess -- 取得製程資料 -- Ann 2025-06-05
        public string GetProcess(int ProcessId, int CompanyId, string ProcessNo, string ProcessName, string Status
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.ProcessId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.CompanyId, a.DepartmentId, a.ProcessNo, a.ProcessName, a.ProcessDesc, a.[Status]
                        , a.ProcessNo + '-' + a.ProcessName ProcessFullNo";
                    sqlQuery.mainTables =
                        @"FROM MES.Process a";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessId", @" AND a.ProcessId = @ProcessId", ProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CompanyId", @" AND a.CompanyId = @CompanyId", CompanyId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessNo", @" AND a.ProcessNo LIKE '%' + @ProcessNo + '%'", ProcessNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessName", @" AND a.ProcessName LIKE '%' + @ProcessName + '%'", ProcessName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.Status = @Status", Status);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.ProcessId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWoErpFullNo -- 取得製令單號 -- Ann 2025-06-10
        public string GetWoErpFullNo()
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.WoErpPrefix + '-' + a.WoErpNo WoErpFullNo
                            FROM MES.WipOrder a 
                            WHERE a.CompanyId = @CompanyId
                            AND a.ConfirmStatus = 'Y'";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetOutsourcingProductionAnonymous -- 取得托外生產單資料(無權限版本) -- Ann 2025-06-17
        public string GetOutsourcingProductionAnonymous(int OspId)
        {
            try
            {
                if (OspId <= 0) throw new SystemException("資料ID錯誤!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.OspDetailId, a.MoProcessId, a.OspQty, FORMAT(a.ExpectedDate, 'yyyy-MM-dd') ExpectedDate
                            , b.OspId, b.DepartmentId, b.OspNo, FORMAT(b.OspDate, 'yyyy-MM-dd') OspDate, b.SupplierId
                            , b.OspStatus, b.OspDesc, b.[Status], b.TransferBpmDate
                            , c.DepartmentNo, c.DepartmentName
                            , d.SupplierNo, d.SupplierName
                            , e.WoSeq
                            , f.WoErpPrefix, f.WoErpNo
                            , g.MtlItemId, g.MtlItemNo, g.MtlItemName, g.MtlItemSpec
                            , h.ProcessAlias
                            , i.ProcessNo
                            FROM MES.OspDetail a 
                            INNER JOIN MES.OutsourcingProduction b ON a.OspId = b.OspId
                            INNER JOIN BAS.Department c ON b.DepartmentId = c.DepartmentId
                            LEFT JOIN SCM.Supplier d ON b.SupplierId = d.SupplierId
                            INNER JOIN MES.ManufactureOrder e ON a.MoId = e.MoId
                            INNER JOIN MES.WipOrder f ON e.WoId = f.WoId
                            INNER JOIN PDM.MtlItem g ON f.MtlItemId = g.MtlItemId
                            INNER JOIN MES.MoProcess h ON a.MoProcessId = h.MoProcessId
                            INNER JOIN MES.Process i ON h.ProcessId = i.ProcessId
                            WHERE a.OspId = @OspId";
                    dynamicParameters.Add("OspId", OspId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSupplierAnonymous -- 取得供應商資料(無權限版本) -- Ann 2025-06-17
        public string GetSupplierAnonymous(int OspId)
        {
            try
            {
                if (OspId <= 0) throw new SystemException("資料ID錯誤!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.CompanyId
                            FROM MES.OutsourcingProduction a 
                            WHERE a.OspId = @OspId";
                    dynamicParameters.Add("OspId", OspId);

                    var OutsourcingProductionResult = sqlConnection.Query(sql, dynamicParameters);

                    if (OutsourcingProductionResult.Count() <= 0) throw new SystemException("託外生產單資料錯誤!!");

                    int CompanyId = OutsourcingProductionResult.FirstOrDefault().CompanyId;
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.SupplierId, a.SupplierNo + ' ' + a.SupplierName SupplierFullNo
                            FROM SCM.Supplier a 
                            WHERE a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CompanyId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcessCodeAnonymous -- 取得供應商製程代碼資料(無權限版本) -- Ann 2025-06-17
        public string GetProcessCodeAnonymous(int SupplierId)
        {
            try
            {
                if (SupplierId <= 0) throw new SystemException("供應商ID錯誤!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認供應商資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.CompanyId, a.SupplierNo
                            FROM SCM.Supplier a 
                            WHERE a.SupplierId = @SupplierId";
                    dynamicParameters.Add("SupplierId", SupplierId);

                    var SupplierResult = sqlConnection.Query(sql, dynamicParameters);

                    if (SupplierResult.Count() <= 0) throw new SystemException("查無供應商資料!!");

                    int CompanyId = SupplierResult.FirstOrDefault().CompanyId;
                    string SupplierNo = SupplierResult.FirstOrDefault().SupplierNo;
                    #endregion

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CompanyId);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(MW001)) ProcessCode, LTRIM(RTRIM(MW002)) ProcessName
                                FROM CMSMW a
                                WHERE a.MW005 = @SupplierNo";
                        dynamicParameters.Add("SupplierNo", SupplierNo);

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //CheckOspDetailSupplierAnonymous -- 確認託外生產單詳細資料是否已維護好供應商相關資料(無權限版本) -- Ann 2025-06-18
        public string CheckOspDetailSupplierAnonymous(int OspId)
        {
            try
            {
                if (OspId <= 0) throw new SystemException("資料ID錯誤!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1
                            FROM MES.OspDetail a
                            INNER JOIN MES.OutsourcingProduction b ON a.OspId = b.OspId 
                            WHERE a.OspId = @OspId
                            AND (a.ProcessCode IS NULL OR a.ExpectedDate IS NULL OR b.SupplierId IS NULL)";
                    dynamicParameters.Add("OspId", OspId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    bool dataCheck = true;
                    if (result.Count() > 0)
                    {
                        dataCheck = false;
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        dataCheck
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //Add
        #region //AddWipOrder -- 工單單頭資料新增 -- Ted 2022.08.04
        public string AddWipOrder(int WoId, string DocDate, string WoErpPrefix, int MtlItemId, int UomId, int? SoDetailId, int InventoryId
            , int PlanQty, string ExpectedStart, string ExpectedEnd, int UserId, string WoRemark, string Project, int ViewCompanyId, string LossRateStatus
            , string Property, string ProductionLine, string Processor, string CurrencyCode, double Exchange
            , string TaxCode, string TaxType, string TaxRate, string PricingTerm, string PaymentTerm)
        {
            try
            {
                if (ViewCompanyId != CurrentCompany) throw new SystemException("頁面公司別與系統後台公司別相同,請重新登入系統");
                if (DocDate.Length <= 0) throw new SystemException("【單據日期】不能為空!");
                if (WoErpPrefix.Length <= 0) throw new SystemException("【製令單別】不能為空!");
                if (MtlItemId <= 0) throw new SystemException("【產品品號】不能為空!");
                if (InventoryId <= 0) throw new SystemException("【入庫庫別】不能為空!");
                if (ViewCompanyId == 2 && WoErpPrefix != "5301")
                {
                    if (PlanQty <= 0) throw new SystemException("【預計產量】須大於零!");
                }
                else
                {
                    if (PlanQty < 0) throw new SystemException("【預計產量】不能為負數!");
                }
                if (CurrencyCode.Length <= 0) throw new SystemException("【幣別】不能為空!");
                if (ExpectedStart.Length <= 0) throw new SystemException("【預計開工日期】不能為空!");
                if (Exchange <= 0) throw new SystemException("【匯率】不能為空!");
                DateTime date1 = DateTime.Parse(ExpectedStart);
                DateTime date2 = DateTime.Parse(ExpectedEnd);
                if (date2 < date1) throw new SystemException("【預計完工日期】不可以小於【預計開工日期】");

                if (SoDetailId <= 0)
                {
                    SoDetailId = null;
                }

                if (Property == "1")
                {
                    Processor = "";
                    TaxCode = "";
                    TaxRate = "";
                    PricingTerm = "";
                    PaymentTerm = "";
                    Processor = "";
                }
                else if (Property == "2")
                {
                    ProductionLine = "";
                }
                else
                {
                    throw new SystemException("【單據性值】資料有問題請重新確認!");
                }

                string ErpNo = "";
                string ErpDbName = "";
                string WoErpNo = "";
                string MtlItemNo = "";
                string BomVersion = "";
                int rowsAffected = 0;
                string nullDate = null; //null日期
                int? nullData = null; //null資料
                int newWoId = -1;
                string WoStatus = "";
                string ActualStart = "";
                string ActualEnd = "";
                List<string> MtlItemNoList = new List<string>();

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //撈取使用者No
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "WipOrderManagement");
                        dynamicParameters.Add("DetailCode", "confirm");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        #region //判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemId ,a.MtlItemNo
                                FROM PDM.MtlItem a
                                WHERE a.MtlItemId =@MtlItemId
                                AND a.CompanyId =@CompanyId
                                AND TransferStatus = 'Y'";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【工單新增】－主件品號ID【" + MtlItemId + "】在MES不存在或是未拋轉，請重新確認");
                        foreach (var item in result)
                        {
                            MtlItemNo = item.MtlItemNo;
                        }
                        #endregion

                        #region //單別5101必須有維護BOM判斷品號是否存在BOM表中
                        if (WoErpPrefix == "5101")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BomId,x.BomDetailQty FROM PDM.BillOfMaterials a
                                    INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                    OUTER APPLY(
                                      select COUNT(x1.BomId) BomDetailQty FROM PDM.BomDetail x1 WHERE a.BomId = x1.BomId
                                    ) x
                                     WHERE a.MtlItemId = @MtlItemId
                                     AND b.CompanyId = @CompanyId
                                     AND a.ConfirmStatus = 'Y'";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var resultBomCheck = sqlConnection.Query(sql, dynamicParameters);
                            if (resultBomCheck.Count() <= 0) throw new SystemException("【工單新增】－目前開立的單別為5101,其主件品號ID【" + MtlItemId + "】,BOM表未維護或是未拋轉ERP,請重新確認");
                            foreach (var item in resultBomCheck)
                            {
                                if (item.BomDetailQty <= 0) throw new SystemException("【工單新增】－目前開立的單別為5101,其主件品號ID【" + MtlItemId + "】,BOM表未維護或是未拋轉ERP,請重新確認");
                            }
                        }
                        #endregion

                        if (ViewCompanyId == 2 && WoErpPrefix == "5301")
                        {
                            WoStatus = "3";
                            ActualStart = ExpectedStart;
                            ActualEnd = nullDate;
                            //throw new SystemException("【工單單身新增】5301開頭的單別,不能開立單身(晶彩流程)");
                        }
                        else
                        {
                            WoStatus = "1";
                            ActualStart = nullDate;
                            ActualEnd = nullDate;
                        }

                        //品號暫時給亂碼
                        WoErpNo = BaseHelper.RandomCode(11);

                        #region //判斷單別+單號是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.WipOrder
                                WHERE WoErpPrefix = @WoErpPrefix
                                AND WoErpNo = @WoErpNo
                                AND CompanyId = @CompanyId";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【工單新增】－【單別+單號】重複，請重新輸入!");
                        #endregion

                        #region //判斷庫別是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT InventoryId
                                FROM SCM.Inventory
                                WHERE InventoryId = @InventoryId
                                AND CompanyId = @CompanyId";
                        dynamicParameters.Add("InventoryId", InventoryId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("庫別不存在");
                        #endregion

                        #region //判斷單位資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 UomId
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @UomId";
                        dynamicParameters.Add("UomId", UomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("單位資料錯誤或不存在!");
                        #endregion

                        #region //判斷訂單是否相同品號
                        if (SoDetailId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MtlItemId
                                FROM  SCM.SoDetail
                                WHERE SoDetailId = @SoDetailId";
                            dynamicParameters.Add("SoDetailId", SoDetailId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【工單新增】－訂單不存在");
                            int SoMtlItemId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MtlItemId;
                            if (SoMtlItemId != MtlItemId) throw new SystemException("【工單新增】－訂單品號與產品品號不同，不可以綁定!!!!!");
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //審核ERP權限
                        var USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI02", "CREATE");
                        #endregion

                        #region //ERP判斷主件品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                FROM INVMB a
                                WHERE MB001 = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        var invmbResult = sqlConnection.Query(sql, dynamicParameters);
                        if (invmbResult.Count() <= 0) throw new SystemException("【工單新增】－ERP系統找不到主件品號【" + MtlItemNo + "】，請確認該品號是否有拋轉ERP");
                        #endregion

                        #region //ERP判斷幣別是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 
                                FROM CMSMF 
                                WHERE MF001 = @MF001";
                        dynamicParameters.Add("MF001", CurrencyCode);
                        var cmsmfbResult = sqlConnection.Query(sql, dynamicParameters);
                        if (cmsmfbResult.Count() <= 0) throw new SystemException("RP系統找不到幣別【" + CurrencyCode + "】，請重新確認");
                        #endregion

                        #region //撈取BOM版次
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MC009
                                FROM BOMMC a
                                WHERE MC001 = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        var bommcResult = sqlConnection.Query(sql, dynamicParameters);
                        if (bommcResult.Count() > 0)
                        {
                            foreach (var item in bommcResult)
                            {
                                BomVersion = item.MC009;
                            }
                        }
                        else
                        {
                            BomVersion = "0000";
                        }
                        #endregion

                        #region //ERP判斷縣別是否存在
                        if (ProductionLine.Length > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MD001)) ProduceLineNo, LTRIM(RTRIM(MD002)) ProduceLineName
                                    FROM CMSMD
                                    LEFT JOIN CMSMB ON MB001=MD003
                                    WHERE 1=1
                                    AND MD001 = @ProductionLine";
                            dynamicParameters.Add("ProductionLine", ProductionLine);

                            invmbResult = sqlConnection.Query(sql, dynamicParameters);
                            if (invmbResult.Count() <= 0) throw new SystemException("【工單單頭更新】－【" + ProductionLine + "】該縣別在ERP不存在，請重新確認資料");

                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //新增ERP工單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.WipOrder (CompanyId, UserId, WoErpPrefix, WoErpNo, Version, DocDate, MtlItemId, InventoryId, UomId, 
                                PlanQty, RequisitionSetQty, StockInQty, ScrapQty, ExpectedStart, ExpectedEnd, ActualStart, ActualEnd, BomDate, 
                                BomVersion, UrgentMtl, Property, ProductionLine, Processor, CurrencyCode, Exchange, TaxCode, TaxType, TaxRate, PricingTerm, PaymentTerm,
                                SoDetailId, Project, WoRemark, ConfirmStatus, ConfirmUserId, 
                                ConfirmDate, WoStatus, LossRateStatus, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, 
                                LastModifiedBy)
                                OUTPUT INSERTED.WoId, INSERTED.WoErpNo, INSERTED.Version, INSERTED.BomDate, INSERTED.BomVersion
                                VALUES (@CompanyId, @UserId, @WoErpPrefix, @WoErpNo, @Version, @DocDate, @MtlItemId, @InventoryId, @UomId, 
                                @PlanQty, @RequisitionSetQty, @StockInQty, @ScrapQty, @ExpectedStart, @ExpectedEnd, @ActualStart, @ActualEnd, @BomDate, 
                                @BomVersion, @UrgentMtl, @Property, @ProductionLine, @Processor, @CurrencyCode, @Exchange, @TaxCode, @TaxType, @TaxRate, @PricingTerm, @PaymentTerm,
                                @SoDetailId, @Project, @WoRemark, @ConfirmStatus, @ConfirmUserId, 
                                @ConfirmDate, @WoStatus, @LossRateStatus, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, 
                                @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                UserId = CurrentUser,
                                WoErpPrefix,
                                WoErpNo,
                                Version = "0000",
                                DocDate,
                                MtlItemId,
                                InventoryId,
                                UomId,
                                PlanQty,
                                RequisitionSetQty = 0,
                                StockInQty = 0,
                                ScrapQty = 0,
                                ExpectedStart,
                                ExpectedEnd,
                                ActualStart,
                                ActualEnd,
                                BomDate = CreateDate,
                                BomVersion,
                                UrgentMtl = "N",
                                SoDetailId,
                                Project,
                                Property,
                                ProductionLine,
                                Processor,
                                CurrencyCode,
                                Exchange,
                                TaxCode,
                                TaxType,
                                TaxRate,
                                PricingTerm,
                                PaymentTerm,
                                WoRemark,
                                ConfirmStatus = "N",
                                ConfirmUserId = "",
                                ConfirmDate = nullDate,
                                WoStatus,
                                LossRateStatus,
                                TransferStatus = "N",
                                TransferDate = nullDate,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResultWipOrder = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in insertResultWipOrder)
                        {
                            WoId = item.WoId;
                            AddUserOperateLog(WoId);
                        }

                        #region //判斷新建製令單頭是否有單身
                        sql = @"SELECT TOP 1 1
                                FROM MES.WoDetail a
                                WHERE 1=1
                                AND WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);
                        var reulteWipOrder = sqlConnection.Query(sql, dynamicParameters);
                        if (reulteWipOrder.Count() > 0) throw new SystemException("【工單新增】－資料異常請重新操作");
                        #endregion


                        #region //判斷新建製令單頭是否有單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.WipOrderLog (TransactionType,ErpDb,ErpNo,TransactionUserId,TransactionDate,
                                        WoId, CompanyId, UserId, WoErpPrefix, WoErpNo, Version, DocDate, MtlItemId, InventoryId, UomId, 
                                        PlanQty, RequisitionSetQty, StockInQty, ScrapQty, ExpectedStart, ExpectedEnd, ActualStart, ActualEnd, BomDate, 
                                        BomVersion, UrgentMtl, Property, SoDetailId, Project, WoRemark, ConfirmStatus, ConfirmUserId, 
                                        ConfirmDate, WoStatus, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, 
                                        LastModifiedBy)
                                        VALUES (@TransactionType,@ErpDb,@ErpNo,@TransactionUserId,@TransactionDate,
                                        @WoId, @CompanyId, @UserId, @WoErpPrefix, @WoErpNo, @Version, @DocDate, @MtlItemId, @InventoryId, @UomId, 
                                        @PlanQty, @RequisitionSetQty, @StockInQty, @ScrapQty, @ExpectedStart, @ExpectedEnd, @ActualStart, @ActualEnd, @BomDate, 
                                        @BomVersion, @UrgentMtl, @Property, @SoDetailId, @Project, @WoRemark, @ConfirmStatus, @ConfirmUserId, 
                                        @ConfirmDate, @WoStatus, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, 
                                        @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionType = "A",
                                ErpDb = nullDate,
                                ErpNo = nullDate,
                                TransactionUserId = CurrentUser,
                                TransactionDate = CreateDate,
                                WoId = WoId,
                                CompanyId = CurrentCompany,
                                UserId = CurrentUser,
                                WoErpPrefix,
                                WoErpNo,
                                Version = "0000",
                                DocDate,
                                MtlItemId,
                                InventoryId,
                                UomId,
                                PlanQty,
                                RequisitionSetQty = 0,
                                StockInQty = 0,
                                ScrapQty = 0,
                                ExpectedStart,
                                ExpectedEnd,
                                ActualStart = nullDate,
                                ActualEnd = nullDate,
                                BomDate = CreateDate,
                                BomVersion,
                                UrgentMtl = "N",
                                Property = 2,
                                SoDetailId,
                                Project,
                                WoRemark,
                                ConfirmStatus = "N",
                                ConfirmUserId = "",
                                ConfirmDate = nullDate,
                                WoStatus = 1,
                                TransferStatus = "N",
                                TransferDate = nullDate,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var reulteWipOrderLog = sqlConnection.Query(sql, dynamicParameters);

                        #endregion

                        #endregion

                        #region //自動套用BOM相關
                        if (WoErpPrefix == "5116" || WoErpPrefix == "5301")
                        {
                            //throw new SystemException("【工單單身新增】5301開頭的單別,不能開立單身");
                        }
                        else
                        {
                            #region //撈取BOM資料
                            dynamicParameters = new DynamicParameters();
                            if (WoErpPrefix.Contains("52")) //返修製令單別
                            {
                                #region //撈取品號相關資料
                                sql = @"SELECT MtlItemId, MtlItemNo, InventoryId, InventoryUomId,MtlItemRemark,1 CompositionQuantity
                                        FROM PDM.MtlItem a
                                        WHERE 1=1
                                        AND MtlItemId = @MtlItemId
                                        AND TransferStatus = 'Y'";
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                var reulte = sqlConnection.Query(sql, dynamicParameters);
                                if (reulte.Count() <= 0) throw new SystemException("【工單新增】－MES系統找不到 主見品號ID【" + MtlItemId + "】，請確認品號是否有拋轉ERP");
                                #endregion

                                #region //自己單身建立
                                foreach (var item in reulte)
                                {
                                    int bomUomId = item.InventoryUomId;
                                    MtlItemNoList.Add(item.MtlItemNo);

                                    Double DemandRequisitionQty = 0;
                                    if (bomUomId == 1) { DemandRequisitionQty = PlanQty * 1 / Convert.ToDouble(1 * 1000); }
                                    else { DemandRequisitionQty = PlanQty * 1 / Convert.ToDouble(1); }
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId, CompositionQuantity, Base, LossRate, BomSequence
                                        , DemandRequisitionQty, RequisitionQty, Substitute, SubstituteStatus
                                        , SubstituteMtlItemId, MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate
                                        , WipDetailRemark, ConfirmStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.WoDetailId
                                        VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence
                                        , @DemandRequisitionQty, @RequisitionQty, @Substitute, @SubstituteStatus
                                        , @SubstituteMtlItemId, @MaterialProperties, @ExpectedRequisitionDate, @ActualRequisitionDate
                                        , @WipDetailRemark, @ConfirmStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            WoId,
                                            item.MtlItemId,
                                            item.InventoryId,
                                            UomId = item.InventoryUomId,
                                            CompositionQuantity = 1,
                                            Base = 1,
                                            LossRate = 1,
                                            BomSequence = nullData,
                                            DemandRequisitionQty,
                                            RequisitionQty = 0,
                                            Substitute = "",
                                            SubstituteStatus = "N",
                                            SubstituteMtlItemId = item.MtlItemId,
                                            MaterialProperties = "1",
                                            ExpectedRequisitionDate = ExpectedStart,
                                            ActualRequisitionDate = nullData,
                                            WipDetailRemark = item.MtlItemRemark,
                                            ConfirmStatus = "N",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();

                                    #region //製令工單單身LOG新增
                                    int WoDetailId = -1;
                                    foreach (var item1 in insertResult)
                                    {
                                        WoDetailId = item1.WoDetailId;
                                    }

                                    int MtlItemIdLog = item.MtlItemId;
                                    int InventoryIdLog = item.InventoryId;
                                    int InventoryUomIdLog = item.InventoryUomId;
                                    double CompositionQuantityLog = 1;
                                    double BaseLog = 1;
                                    double LossRateLog = 1;
                                    string BomSequenceLog = null;
                                    string MaterialPropertiesLog = "1";
                                    string MtlItemRemarkLog = item.MtlItemRemark;

                                    AddWoDetailLog("B0", "", "", CreateBy, CreateDate
                                        , CurrentCompany, WoId, WoDetailId, MtlItemId, WoErpPrefix, WoErpNo, MtlItemIdLog, InventoryIdLog, InventoryUomIdLog
                                        , CompositionQuantityLog, BaseLog, LossRateLog, BomSequenceLog, DemandRequisitionQty, 0, "", "N"
                                        , MtlItemIdLog, MaterialPropertiesLog, null, null
                                        , MtlItemRemarkLog, "N", CreateDate, LastModifiedDate, CreateBy, LastModifiedBy, sqlConnection);
                                    #endregion
                                }
                                #endregion
                            }
                            else
                            {
                                #region //撈取BOM資料
                                sql = @"SELECT test.* FROM(
							            SELECT  a.ConfirmStatus,b.MtlItemNo as ManMtlItemNo,b.MtlItemId as ManMtlItemId
							            ,c.MtlItemId,c.EffectiveDate,c.ExpirationDate,c.CompositionQuantity,c.Base,c.BomSequence,c.LossRate,c.MaterialProperties
							            ,d.MtlItemNo as BomDetailMtlItemNo ,d.InventoryId, d.InventoryUomId,d.MtlItemRemark
							            , ROW_NUMBER() OVER(ORDER BY c.BomSequence) seq 
							            ,(CASE WHEN c.EffectiveDate is not null 
		                                        THEN (
			                                        case when CONVERT(varchar(10),c.EffectiveDate, 120)  <= @DocDate
			                                        THEN 1
			                                        ELSE 2
			                                        END ) 
		                                        ELSE 3
		                                        END) as EffectiveDateStatus
	                                        ,(CASE WHEN c.ExpirationDate is not null 
		                                        THEN (
			                                        case when CONVERT(varchar(10),c.ExpirationDate, 120)  > @DocDate
			                                        THEN 1 
			                                        ELSE 2 
			                                        END ) 
		                                        ELSE 3
		                                        END) as ExpirationDateStatus
							            FROM PDM.BillOfMaterials a
							            INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
							            INNER JOIN PDM.BomDetail c on a.BomId = c.BomId
							            INNER JOIN PDM.MtlItem d on c.MtlItemId = d.MtlItemId) test
							            WHERE test.ManMtlItemId = @MtlItemId
                                        AND test.ConfirmStatus = 'Y'
                                        AND test.EffectiveDateStatus !=2
							            AND test.ExpirationDateStatus !=2
                                        Order By seq DESC";
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                dynamicParameters.Add("DocDate", DocDate);
                                var bomData = sqlConnection.Query(sql, dynamicParameters);
                                if (bomData.Count() <= 0) throw new SystemException("沒有BOM材料清單!或是重新確認BOM表是否有拋轉ERP確認");
                                #endregion

                                #region //查詢是否有套用過BOM資料
                                foreach (var item in bomData)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MtlItemId
                                            FROM MES.WoDetail
                                            WHERE WoId =@WoId
                                            AND MtlItemId =@bomMtlItemId";
                                    dynamicParameters.Add("WoId", WoId);
                                    dynamicParameters.Add("bomMtlItemId", item.MtlItemId);
                                    var resultBom = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultBom.Count() > 0) throw new SystemException("已經有BOM資料了!");
                                }
                                #endregion

                                #region //BOM有資料新增MES工單單身
                                if (bomData.Count() > 0)
                                {
                                    #region //製令工單單身 新增
                                    foreach (var item in bomData)
                                    {


                                        if (item.MaterialProperties == null || item.MaterialProperties == "")
                                        {
                                            throw new SystemException("材料品號ID:【" + item.BomDetailMtlItemNo + "】的材料型態沒有維護,請重新確認!!");
                                        }

                                        MtlItemNoList.Add(item.BomDetailMtlItemNo);

                                        var bomUomId = item.InventoryUomId;
                                        Double DemandRequisitionQty = 0;
                                        Double CompositionQuantity = item.CompositionQuantity;
                                        Double Base = item.Base;
                                        Double LossRate = item.LossRate;
                                        if (LossRateStatus == "N")
                                        {
                                            LossRate = 0;
                                        }
                                        if (Base == 0) Base = 1;

                                        if (bomUomId == 1)
                                        {
                                            DemandRequisitionQty = PlanQty * CompositionQuantity / (Base * 1000) * (1 + LossRate);
                                        }
                                        else
                                        {
                                            DemandRequisitionQty = PlanQty * CompositionQuantity / Base * (1 + LossRate);
                                        }

                                        if (double.IsNaN(DemandRequisitionQty))
                                        {
                                            //此处判断a为NaN
                                            DemandRequisitionQty = 0;

                                        }

                                        DemandRequisitionQty = Math.Round(DemandRequisitionQty, 3); // 保留小數第三位並四捨五入

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId, CompositionQuantity, Base, LossRate, BomSequence
                                                , DemandRequisitionQty, RequisitionQty, Substitute, SubstituteStatus
                                                , SubstituteMtlItemId, MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate
                                                , WipDetailRemark, ConfirmStatus
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.WoDetailId
                                                VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence
                                                , @DemandRequisitionQty, @RequisitionQty, @Substitute, @SubstituteStatus
                                                , @SubstituteMtlItemId, @MaterialProperties, @ExpectedRequisitionDate, @ActualRequisitionDate
                                                , @WipDetailRemark, @ConfirmStatus
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                WoId,
                                                item.MtlItemId,
                                                item.InventoryId,
                                                UomId = item.InventoryUomId,
                                                CompositionQuantity = item.CompositionQuantity,
                                                Base = item.Base,
                                                LossRate = item.LossRate,
                                                BomSequence = item.BomSequence,
                                                DemandRequisitionQty,
                                                RequisitionQty = 0,
                                                Substitute = "",
                                                SubstituteStatus = "N",
                                                SubstituteMtlItemId = item.MtlItemId,
                                                MaterialProperties = item.MaterialProperties,
                                                ExpectedRequisitionDate = ExpectedStart,
                                                ActualRequisitionDate = nullData,
                                                WipDetailRemark = item.MtlItemRemark,
                                                ConfirmStatus = "N",
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });
                                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();

                                        #region //製令工單單身LOG新增
                                        int WoDetailId = -1;
                                        foreach (var item1 in insertResult)
                                        {
                                            WoDetailId = item1.WoDetailId;
                                        }

                                        int MtlItemIdLog = item.MtlItemId;
                                        int InventoryIdLog = item.InventoryId;
                                        int InventoryUomIdLog = item.InventoryUomId;
                                        double CompositionQuantityLog = item.CompositionQuantity;
                                        double BaseLog = item.Base;
                                        double LossRateLog = item.LossRate;
                                        string BomSequenceLog = item.BomSequence;
                                        string MaterialPropertiesLog = item.MaterialProperties;
                                        string MtlItemRemarkLog = item.MtlItemRemark;

                                        AddWoDetailLog("A0", "", "", CreateBy, CreateDate
                                            , CurrentCompany, WoId, WoDetailId, MtlItemId, WoErpPrefix, WoErpNo, MtlItemIdLog, InventoryIdLog, InventoryUomIdLog
                                            , CompositionQuantityLog, BaseLog, LossRateLog, BomSequenceLog, DemandRequisitionQty, 0, "", "N"
                                            , MtlItemIdLog, MaterialPropertiesLog, ExpectedStart, null
                                            , MtlItemRemarkLog, "N", CreateDate, LastModifiedDate, CreateBy, LastModifiedBy, sqlConnection);
                                        #endregion
                                    }
                                    #endregion

                                    #region //Response
                                    jsonResponse = JObject.FromObject(new
                                    {
                                        status = "success",
                                        msg = "(" + rowsAffected + " rows affected)",
                                    });
                                    #endregion


                                }
                                #endregion
                            }
                            #endregion
                        }
                        #endregion

                        //if (PlanQty > 0) throw new SystemException("【預計產量】不能為空!");

                        rowsAffected += insertResultWipOrder.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResultWipOrder
                        });
                        #endregion
                    }
                    if (ViewCompanyId == 2 && WoErpPrefix == "5301")
                    {
                        //略過不執行
                    }
                    else
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            DynamicParameters dynamicParameters = new DynamicParameters();

                            #region //ERP判斷元件品號是否存在
                            string notSeeMtlItemNo = "";

                            foreach (var item in MtlItemNoList)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MB001
                                    FROM INVMB a
                                    WHERE MB001 = @MtlItemNo";
                                dynamicParameters.Add("MtlItemNo", item);
                                var invmbResult = sqlConnection.Query(sql, dynamicParameters);
                                if (invmbResult.Count() <= 0)
                                {
                                    if (notSeeMtlItemNo != "")
                                    {
                                        notSeeMtlItemNo += "," + item;
                                    }
                                    else
                                    {
                                        notSeeMtlItemNo += item;
                                    }
                                }
                            }
                            if (notSeeMtlItemNo != "")
                            {
                                throw new SystemException("【工單新增】－ERP系統找不到元件品號【" + notSeeMtlItemNo + "】，請確認品號是否有拋轉ERP");
                            }
                            #endregion
                        }

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddWoDetail -- 工單單身資料新增 -- Ted 2022.08.08
        public string AddWoDetail(int WoId, int MtlItemId, int InventoryId, int UomId, double DemandRequisitionQty
          , string SubstituteStatus, string ExpectedRequisitionDate, string WipDetailRemark, string MaterialProperties)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【產品品號】不能為空!");
                if (InventoryId <= 0) throw new SystemException("【入庫庫別】不能為空!");
                if (UomId <= 0) throw new SystemException("【單位】不能為空!");
                if (DemandRequisitionQty <= 0) throw new SystemException("【需領用量】不能為空!");
                if (ExpectedRequisitionDate.Length <= 0) throw new SystemException("【預計領料日】不能為空!");
                if (SubstituteStatus.Length <= 0) throw new SystemException("【是否替代料】不能為空!");
                if (MaterialProperties.Length <= 0) throw new SystemException("【材料型態】不能為空!");

                string ErpNo = "";
                string ErpDbName = "";
                string MtlItemNo = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int? nullData = null;

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        var bomSubstitutionMtlItemId = 0;

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷單頭是否存在 + 撈取單頭產品品號 + BOM日期
                        int woIdMtlItemId = -1;
                        string WoErpPrefix = "";
                        string BomDateBase = "";
                        string ExpectedStart = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT WoErpPrefix,MtlItemId as woIdMtlItemId , FORMAT(BomDate, 'yyyy-MM-dd') BomDate,FORMAT(ExpectedStart, 'yyyy-MM-dd') ExpectedStart
                                FROM MES.WipOrder
                                WHERE WoId =@WoId";
                        dynamicParameters.Add("WoId", WoId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES工單單頭有問題!");
                        foreach (var item in result)
                        {
                            WoErpPrefix = item.WoErpPrefix;
                            woIdMtlItemId = item.woIdMtlItemId;
                            BomDateBase = item.BomDate;
                            ExpectedStart = item.ExpectedStart;
                        }
                        if (!WoErpPrefix.Contains("52"))
                        {
                            if (woIdMtlItemId == MtlItemId) throw new SystemException("【工單單身新增】非52開頭的單別,不能領與主件相同的材料!!");
                        }
                        if (CurrentCompany == 2 && WoErpPrefix == "5301")
                        {
                            throw new SystemException("【工單單身新增】5301開頭的單別,不能開立單身");
                        }
                        #endregion


                        #region //判斷該材料品號是否存在+生效日是否過期
                        string EffectiveDateBase = "";
                        string ExpirationDateBase = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemNo ,FORMAT(EffectiveDate, 'yyyy-MM-dd') EffectiveDate , FORMAT(ExpirationDate, 'yyyy-MM-dd') ExpirationDate 	
                                FROM PDM.MtlItem
                                WHERE MtlItemId =@MtlItemId
                                AND TransferStatus = 'Y'";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【工單單身新增】－該品號在MES不存在或是未拋轉，請重新確認");
                        foreach (var item in result)
                        {
                            MtlItemNo = item.MtlItemNo;
                            EffectiveDateBase = item.EffectiveDateBase;
                            ExpirationDateBase = item.ExpirationDateBase;
                        }

                        //DateTime BomDate = DateTime.Parse(BomDateBase);
                        //DateTime EffectiveDate = DateTime.Parse(EffectiveDateBase);
                        //DateTime ExpirationDate = DateTime.Parse(ExpirationDateBase);

                        //int effectiveDateCompare = BomDate.CompareTo(EffectiveDate);
                        //int expirationDateCompare = BomDate.CompareTo(ExpirationDateBase);
                        //if(effectiveDateCompare < 0) throw new SystemException("材料未生效");
                        //if(expirationDateCompare > 0) throw new SystemException("材料已經失效");
                        #endregion

                        #region //查詢是否有套用過相同的材料品號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemId,b.MtlItemId woIdMtlItemId
                                FROM MES.WoDetail a
                                INNER JOIN MES.WipOrder b on a.WoId = b.WoId
                                WHERE a.WoId =@WoId
                                AND a.MtlItemId =@MtlItemId";
                        dynamicParameters.Add("WoId", WoId);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("已經有該筆材料單身資料了!");
                        #endregion

                        #region //查詢是否是替代料
                        dynamicParameters = new DynamicParameters();
                        if (SubstituteStatus == "Y")
                        {
                            sql = @"SELECT TOP 1 a.MtlItemId SubstituteMtlItemId,a.Quantity,a.Remark MtlItemRemark, ROW_NUMBER() OVER(ORDER BY a.SortNumber) seq 
                                    ,a1.MtlItemNo,a1.MtlItemName,a1.MtlItemSpec,a1.InventoryId,a1.InventoryUomId
                                    ,b.MtlItemId BomDetailMtlItemId
                                    ,c.MtlItemId
                                    FROM PDM.BomSubstitution a
                                    INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                    INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                    INNER JOIN PDM.MtlItem b1 on b.MtlItemId = b1.MtlItemId
                                    INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                    INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
                                    WHERE 1=1 
                                    AND a.SubstituteStatus = '3' 
                                    AND (a.EffectiveDate <= FORMAT(GETDATE(), 'yyyyMMdd') OR a.EffectiveDate = '' OR a.EffectiveDate is NULL) 
                                    AND (a.ExpirationDate >= FORMAT(GETDATE(), 'yyyyMMdd') OR a.ExpirationDate = '' OR a.ExpirationDate is NULL)
                                    AND c1.MtlItemId = @woIdMtlItemId
                                    Order By seq";
                            dynamicParameters.Add("woIdMtlItemId", woIdMtlItemId);
                            var bomSubstitutionData = sqlConnection.Query(sql, dynamicParameters);
                            if (bomSubstitutionData.Count() <= 0) throw new SystemException("該產品無替代料!替代料設定狀態錯誤!");
                            bomSubstitutionMtlItemId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SubstituteMtlItemId;
                            if (bomSubstitutionMtlItemId != MtlItemId) throw new SystemException("該材料品號非該產品替代料!替代料設定狀態錯誤!");
                        }
                        #endregion

                        #region //撈取 組成用量,底數,損耗率
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT a.CompositionQuantity,a.Base,a.LossRate
                        //        FROM PDM.BomDetail a
                        //        WHERE a.MtlItemId =@MtlItemId";
                        //dynamicParameters.Add("MtlItemId", MtlItemId);
                        //result = sqlConnection.Query(sql, dynamicParameters);
                        //if (result.Count() <= 0) throw new SystemException("資料有問題,撈取不到Bom相關資料");
                        //Double CompositionQuantity = 0;
                        //Double Base = 0;
                        //Double LossRate = 0;
                        //foreach (var item in result)
                        //{
                        //    CompositionQuantity = Convert.ToDouble(item.CompositionQuantity);
                        //    Base = Convert.ToDouble(item.Base);
                        //    LossRate = Convert.ToDouble(item.LossRate);
                        //}
                        #endregion

                        if (ExpectedRequisitionDate == "")
                        {
                            ExpectedRequisitionDate = null;
                        }

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId, CompositionQuantity, Base, LossRate
                                , BomSequence, DemandRequisitionQty, RequisitionQty, Substitute, SubstituteStatus, SubstituteMtlItemId, MaterialProperties
                                , ExpectedRequisitionDate, ActualRequisitionDate, WipDetailRemark, ConfirmStatus, CreateDate
                                , LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence
                                , @DemandRequisitionQty, @RequisitionQty, @Substitute, @SubstituteStatus, @SubstituteMtlItemId, @MaterialProperties
                                , @ExpectedRequisitionDate, @ActualRequisitionDate, @WipDetailRemark, @ConfirmStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                WoId,
                                MtlItemId,
                                InventoryId,
                                UomId,
                                CompositionQuantity = 1,
                                Base = 1,
                                LossRate = 1,
                                BomSequence = nullData,
                                DemandRequisitionQty,
                                RequisitionQty = 0,
                                Substitute = "",
                                SubstituteStatus,
                                SubstituteMtlItemId = bomSubstitutionMtlItemId != 0 ? bomSubstitutionMtlItemId : MtlItemId,
                                MaterialProperties,
                                ExpectedRequisitionDate = ExpectedRequisitionDate != null ? ExpectedRequisitionDate : ExpectedStart,
                                ActualRequisitionDate = nullData,
                                WipDetailRemark,
                                ConfirmStatus = "N",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //ERP判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                FROM INVMB a
                                WHERE MB001 = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);

                        var invmbResult = sqlConnection.Query(sql, dynamicParameters);
                        if (invmbResult.Count() <= 0) throw new SystemException("【工單單身新增】－【" + MtlItemNo + "】該品號在ERP不存在，請確認品號是否有拋轉");
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBom -- 製令BOM材料套用新增 -- Ted 2022.08.11
        public string AddBom(int WoId)
        {
            try
            {
                if (WoId <= 0) throw new SystemException("【ERP工單製令ID】不能為空!");

                List<WoDetail> woDetails = new List<WoDetail>();
                List<string> MtlItemNoList = new List<string>();

                string ErpDbName = "";
                string ErpNo = "";
                string WoErpPrefix = "";
                int MtlItemId = 0;
                int PlanQty = 0;
                int CompanyId = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //撈取工單開單日
                        string DocDate = "";
                        string ExpectedStart = "";
                        string WoErpNo = "";
                        string LossRateStatus = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT CompanyId,WoErpPrefix,WoErpNo,MtlItemId,PlanQty,FORMAT(DocDate, 'yyyy-MM-dd') DocDate,FORMAT(ExpectedStart, 'yyyy-MM-dd') ExpectedStart,LossRateStatus
                            FROM MES.WipOrder
                            WHERE WoId =@WoId";
                        dynamicParameters.Add("WoId", WoId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() < 0) throw new SystemException("找不到工單資料,請重新確認!!!");
                        foreach (var item in result)
                        {
                            DocDate = item.DocDate;
                            ExpectedStart = item.ExpectedStart;
                            MtlItemId = item.MtlItemId;
                            WoErpPrefix = item.WoErpPrefix;
                            WoErpNo = item.WoErpNo;
                            PlanQty = item.PlanQty;
                            LossRateStatus = item.LossRateStatus;
                            CompanyId = item.CompanyId;
                            if (WoErpPrefix == "5116" || WoErpPrefix == "5301")
                            {
                                throw new SystemException("【工單單身新增】5116,5301開頭的單別,不能開立單身");
                            }
                        }
                        #endregion

                        #region //撈取BOM資料
                        dynamicParameters = new DynamicParameters();
                        AddUserOperateLog(WoId);

                        if (WoErpPrefix.Contains("52"))
                        {
                            sql = @"SELECT MtlItemId, MtlItemNo, InventoryId, InventoryUomId,MtlItemRemark,1 CompositionQuantity
                            FROM PDM.MtlItem a
                            WHERE 1=1
                            AND MtlItemId = @MtlItemId";

                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var reulte = sqlConnection.Query(sql, dynamicParameters);
                            if (reulte.Count() <= 0) throw new SystemException("【BOM材料套用】－該品號在ERP不存在，請確認品號是否有拋轉");

                            int? nullData = null;
                            int rowsAffected = 0;

                            #region //查詢是否有套用過BOM資料
                            foreach (var item in reulte)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MtlItemId
                                    FROM MES.WoDetail
                                    WHERE WoId =@WoId
                                    AND MtlItemId =@bomMtlItemId";
                                dynamicParameters.Add("WoId", WoId);
                                dynamicParameters.Add("bomMtlItemId", item.MtlItemId);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() > 0) throw new SystemException("已經有BOM資料了!");
                            }
                            #endregion

                            #region //自己單身建立
                            foreach (var item in reulte)
                            {
                                var bomUomId = item.InventoryUomId;
                                MtlItemNoList.Add(item.MtlItemNo);

                                Double DemandRequisitionQty = 0;
                                if (bomUomId == 1) { DemandRequisitionQty = PlanQty * 1 / Convert.ToDouble(1 * 1000); }
                                else { DemandRequisitionQty = PlanQty * 1 / Convert.ToDouble(1); }
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId, CompositionQuantity, Base, LossRate, BomSequence
                                        , DemandRequisitionQty, RequisitionQty, Substitute, SubstituteStatus
                                        , SubstituteMtlItemId, MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate
                                        , WipDetailRemark, ConfirmStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.WoDetailId
                                        VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence
                                        , @DemandRequisitionQty, @RequisitionQty, @Substitute, @SubstituteStatus
                                        , @SubstituteMtlItemId, @MaterialProperties, @ExpectedRequisitionDate, @ActualRequisitionDate
                                        , @WipDetailRemark, @ConfirmStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        WoId,
                                        item.MtlItemId,
                                        item.InventoryId,
                                        UomId = item.InventoryUomId,
                                        CompositionQuantity = 1,
                                        Base = 1,
                                        LossRate = 1,
                                        BomSequence = nullData,
                                        DemandRequisitionQty,
                                        //DemandRequisitionQty = PlanQty * (bom.CompositionQuantity),
                                        RequisitionQty = 0,
                                        Substitute = "",
                                        SubstituteStatus = "N",
                                        SubstituteMtlItemId = item.MtlItemId,
                                        MaterialProperties = '1',
                                        ExpectedRequisitionDate = nullData,
                                        ActualRequisitionDate = nullData,
                                        WipDetailRemark = item.MtlItemRemark,
                                        ConfirmStatus = "N",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();

                                #region //製令工單單身LOG新增
                                int WoDetailId = -1;
                                foreach (var item1 in insertResult)
                                {
                                    WoDetailId = item1.WoDetailId;
                                }

                                int MtlItemIdLog = item.MtlItemId;
                                int InventoryIdLog = item.InventoryId;
                                int InventoryUomIdLog = item.InventoryUomId;
                                double CompositionQuantityLog = 1;
                                double BaseLog = 1;
                                double LossRateLog = 1;
                                string BomSequenceLog = null;
                                string MaterialPropertiesLog = "1";
                                string MtlItemRemarkLog = item.MtlItemRemark;

                                AddWoDetailLog("B2", "", "", CreateBy, CreateDate
                                    , CurrentCompany, WoId, WoDetailId, MtlItemId, WoErpPrefix, WoErpNo, MtlItemIdLog, InventoryIdLog, InventoryUomIdLog
                                    , CompositionQuantityLog, BaseLog, LossRateLog, BomSequenceLog, DemandRequisitionQty, 0, "", "N"
                                    , MtlItemIdLog, MaterialPropertiesLog, null, null
                                    , MtlItemRemarkLog, "N", CreateDate, LastModifiedDate, CreateBy, LastModifiedBy, sqlConnection);
                                #endregion

                            }
                            #endregion

                        }
                        else
                        {
                            #region //撈取BOM資料
                            sql = @"SELECT test.* FROM(
							SELECT  a.ConfirmStatus,b.MtlItemNo as ManMtlItemNo,b.MtlItemId as ManMtlItemId
							,c.MtlItemId,c.EffectiveDate,c.ExpirationDate,c.CompositionQuantity,c.Base,c.BomSequence,c.LossRate,c.MaterialProperties
							,d.MtlItemNo as BomDetailMtlItemNo ,d.InventoryId, d.InventoryUomId,d.MtlItemRemark
							, ROW_NUMBER() OVER(ORDER BY c.BomSequence) seq 
							,(CASE WHEN c.EffectiveDate is not null 
		                            THEN (
			                            case when CONVERT(varchar(10),c.EffectiveDate, 120)  <= @DocDate
			                            THEN 1
			                            ELSE 2
			                            END ) 
		                            ELSE 3
		                            END) as EffectiveDateStatus
	                            ,(CASE WHEN c.ExpirationDate is not null 
		                            THEN (
			                            case when CONVERT(varchar(10),c.ExpirationDate, 120)  > @DocDate
			                            THEN 1 
			                            ELSE 2 
			                            END ) 
		                            ELSE 3
		                            END) as ExpirationDateStatus
							FROM PDM.BillOfMaterials a
							INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
							INNER JOIN PDM.BomDetail c on a.BomId = c.BomId
							INNER JOIN PDM.MtlItem d on c.MtlItemId = d.MtlItemId) test
							WHERE test.ManMtlItemId = @MtlItemId
                            AND test.ConfirmStatus = 'Y'
                            AND test.EffectiveDateStatus !=2
							AND test.ExpirationDateStatus !=2
                            Order By seq DESC";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            dynamicParameters.Add("DocDate", DocDate);

                            var bomData = sqlConnection.Query(sql, dynamicParameters);
                            if (bomData.Count() <= 0) throw new SystemException("沒有BOM材料清單!或是重新確認BOM表是否有拋轉ERP確認");

                            #endregion

                            #region //查詢是否有套用過BOM資料
                            foreach (var item in bomData)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MtlItemId
                                    FROM MES.WoDetail
                                    WHERE WoId =@WoId
                                    AND MtlItemId =@bomMtlItemId";
                                dynamicParameters.Add("WoId", WoId);
                                dynamicParameters.Add("bomMtlItemId", item.MtlItemId);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() > 0) throw new SystemException("已經有BOM資料了!");
                            }
                            #endregion

                            #region //BOM有資料新增MES工單單身
                            if (bomData.Count() > 0)
                            {
                                int? nullData = null;
                                int rowsAffected = 0;
                                #region //製令工單單身 新增
                                foreach (var item in bomData)
                                {
                                    if (item.MaterialProperties == null || item.MaterialProperties == "")
                                    {
                                        throw new SystemException("材料品號ID:【" + item.BomDetailMtlItemNo + "】的材料型態沒有維護,請重新確認!!");
                                    }

                                    MtlItemNoList.Add(item.BomDetailMtlItemNo);

                                    var bomUomId = item.InventoryUomId;
                                    Double DemandRequisitionQty = 0;
                                    Double CompositionQuantity = item.CompositionQuantity;
                                    Double Base = item.Base;
                                    Double LossRate = item.LossRate;
                                    if (LossRateStatus == "N")
                                    {
                                        LossRate = 0;
                                    }
                                    if (Base == 0) Base = 1;

                                    if (bomUomId == 1)
                                    {
                                        DemandRequisitionQty = PlanQty * CompositionQuantity / (Base * 1000) * (1 + LossRate);
                                        if (double.IsNaN(DemandRequisitionQty))
                                        {
                                            //此处判断a为NaN
                                            DemandRequisitionQty = 0;
                                        }
                                    }
                                    else
                                    {
                                        DemandRequisitionQty = PlanQty * CompositionQuantity / Base * (1 + LossRate);
                                        if (double.IsNaN(DemandRequisitionQty))
                                        {
                                            //此处判断a为NaN
                                            DemandRequisitionQty = 0;
                                        }
                                    }

                                    DemandRequisitionQty = Math.Round(DemandRequisitionQty, 3); // 保留小數第三位並四捨五入


                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId, CompositionQuantity, Base, LossRate, BomSequence
                                    , DemandRequisitionQty, RequisitionQty, Substitute, SubstituteStatus
                                    , SubstituteMtlItemId, MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate
                                    , WipDetailRemark, ConfirmStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.WoDetailId
                                    VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence
                                    , @DemandRequisitionQty, @RequisitionQty, @Substitute, @SubstituteStatus
                                    , @SubstituteMtlItemId, @MaterialProperties, @ExpectedRequisitionDate, @ActualRequisitionDate
                                    , @WipDetailRemark, @ConfirmStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            WoId,
                                            item.MtlItemId,
                                            item.InventoryId,
                                            UomId = item.InventoryUomId,
                                            CompositionQuantity = item.CompositionQuantity,
                                            Base = item.Base,
                                            LossRate = item.LossRate,
                                            BomSequence = item.BomSequence,
                                            DemandRequisitionQty,
                                            //DemandRequisitionQty = PlanQty * (bom.CompositionQuantity),
                                            RequisitionQty = 0,
                                            Substitute = "",
                                            SubstituteStatus = "N",
                                            SubstituteMtlItemId = item.MtlItemId,
                                            MaterialProperties = item.MaterialProperties,
                                            ExpectedRequisitionDate = ExpectedStart,
                                            ActualRequisitionDate = nullData,
                                            WipDetailRemark = item.MtlItemRemark,
                                            ConfirmStatus = "N",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();

                                    #region //製令工單單身LOG新增
                                    int WoDetailId = -1;
                                    foreach (var item1 in insertResult)
                                    {
                                        WoDetailId = item1.WoDetailId;
                                    }

                                    int MtlItemIdLog = item.MtlItemId;
                                    int InventoryIdLog = item.InventoryId;
                                    int InventoryUomIdLog = item.InventoryUomId;
                                    double CompositionQuantityLog = item.CompositionQuantity;
                                    double BaseLog = item.Base;
                                    double LossRateLog = item.LossRate;
                                    string BomSequenceLog = item.BomSequence;
                                    string MaterialPropertiesLog = item.MaterialProperties;
                                    string MtlItemRemarkLog = item.MtlItemRemark;

                                    AddWoDetailLog("A2", "", "", CreateBy, CreateDate
                                        , CurrentCompany, WoId, WoDetailId, MtlItemId, WoErpPrefix, WoErpNo, MtlItemIdLog, InventoryIdLog, InventoryUomIdLog
                                        , CompositionQuantityLog, BaseLog, LossRateLog, BomSequenceLog, DemandRequisitionQty, 0, "", "N"
                                        , MtlItemIdLog, MaterialPropertiesLog, ExpectedStart, null
                                        , MtlItemRemarkLog, "N", CreateDate, LastModifiedDate, CreateBy, LastModifiedBy, sqlConnection);
                                    #endregion


                                }
                                #endregion

                                #region //Response
                                jsonResponse = JObject.FromObject(new
                                {
                                    status = "success",
                                    msg = "(" + rowsAffected + " rows affected)",
                                });
                                #endregion


                            }
                            #endregion

                        }
                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //ERP判斷品號是否存在
                        if (MtlItemNoList.Count() > 0)
                        {
                            foreach (var MtlItemNo in MtlItemNoList)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MB001
                                FROM INVMB a
                                WHERE MB001 = @MtlItemNo";
                                dynamicParameters.Add("MtlItemNo", MtlItemNo);

                                var invmbResult = sqlConnection.Query(sql, dynamicParameters);
                                if (invmbResult.Count() <= 0) throw new SystemException("【BOM材料套用】－【" + MtlItemNo + "】該品號在ERP不存在，請確認品號是否有拋轉");
                            }
                        }
                        #endregion
                    }

                    if (CompanyId != CurrentCompany) throw new SystemException("公司別異常,請重新整理頁面!!");

                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBomSubstitution -- 製令替代料套用新增 -- Ted 2022.08.15
        public string AddBomSubstitution(int WoId, int MtlItemId, int PlanQty)
        {
            try
            {
                int testIng = 99;
                if (testIng == 99) throw new SystemException("自動套用替代料功能測試中~~請耐心等候");

                if (MtlItemId <= 0) throw new SystemException("【產品品號】不能為空!");
                if (PlanQty <= 0) throw new SystemException("【預計產量】不能為空!");

                List<WoDetail> woDetails = new List<WoDetail>();
                List<string> MtlItemNoList = new List<string>();

                string ErpDbName = "";
                string ErpNo = "";
                int rowsAffected = 0;
                int? nullData = null;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷製令是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.WoErpPrefix,a.CompanyId
                                FROM MES.WipOrder a
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var resultWoId = sqlConnection.Query(sql, dynamicParameters);

                        if (resultWoId.Count() <= 0) throw new SystemException("製令不存在!請重新確認");

                        foreach (var item in resultWoId)
                        {
                            if (item.CompanyId == 2 || item.WoErpPrefix == "5301")
                            {
                                throw new SystemException("【工單單身新增】5301開頭的單別,不能開立單身");
                            }
                        }
                        #endregion

                        #region //撈取替代料資料
                        dynamicParameters = new DynamicParameters();

                        sql = @"SELECT a.MtlItemId SubstituteMtlItemId,a.Quantity,a.Remark MtlItemRemark, ROW_NUMBER() OVER(ORDER BY a.SortNumber) seq 
                                ,a1.MtlItemNo,a1.MtlItemName,a1.MtlItemSpec,a1.InventoryId,a1.InventoryUomId
                                ,b.MtlItemId BomDetailMtlItemId,b1.MaterialProperties
                                ,c.MtlItemId
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                INNER JOIN PDM.MtlItem b1 on b.MtlItemId = b1.MtlItemId
                                INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
                                WHERE 1=1 
                                AND a.SubstituteStatus = '3' 
                                AND a.TransferStatus = 'Y'
                                AND (a.EffectiveDate <= FORMAT(GETDATE(), 'yyyyMMdd') OR a.EffectiveDate = '' OR a.EffectiveDate is NULL) 
                                AND (a.ExpirationDate >= FORMAT(GETDATE(), 'yyyyMMdd') OR a.ExpirationDate = '' OR a.ExpirationDate is NULL)
                                AND c1.MtlItemId = @MtlItemId
                                Order By seq";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var bomSubstitutionData = sqlConnection.Query(sql, dynamicParameters);
                        if (bomSubstitutionData.Count() <= 0) throw new SystemException("無替代料!或是重新確認替代料BOM是否有拋轉");
                        foreach (var item in bomSubstitutionData)
                        {
                            #region //查詢是否有套用過替代料資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemId
                                FROM MES.WoDetail
                                WHERE WoId =@WoId
                                AND MtlItemId =@SubstituteMtlItemId
                                AND SubstituteMtlItemId =@BomDetailMtlItemId";
                            dynamicParameters.Add("WoId", WoId);
                            dynamicParameters.Add("SubstituteMtlItemId", item.SubstituteMtlItemId);
                            dynamicParameters.Add("BomDetailMtlItemId", item.BomDetailMtlItemId);
                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0)
                            {
                                #region //撈取 組成用量,底數,損耗率
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MtlItemId,a.CompositionQuantity,a.Base,a.LossRate
                                FROM PDM.BomDetail a
                                INNER JOIN PDM.BillOfMaterials b on a.BomId = b.BomId
                                WHERE a.MtlItemId =@BomDetailMtlItemId
                                AND b.MtlItemId =@MtlItemId";
                                dynamicParameters.Add("BomDetailMtlItemId", item.BomDetailMtlItemId);
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("資料有問題,撈取不到Bom相關資料");
                                Double CompositionQuantity = 0;
                                Double Base = 0;
                                Double LossRate = 0;
                                foreach (var item1 in result)
                                {
                                    //ElementMtlItemId = Convert.ToDouble(item.MtlItemId);
                                    CompositionQuantity = Convert.ToDouble(item1.CompositionQuantity);
                                    Base = Convert.ToDouble(item1.Base);
                                    LossRate = Convert.ToDouble(item1.LossRate);
                                }
                                #endregion

                                #region //製令工單單身 新增
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId, CompositionQuantity, Base, LossRate, BomSequence
                                        , DemandRequisitionQty, RequisitionQty, Substitute, SubstituteStatus
                                        , SubstituteMtlItemId, MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate
                                        , WipDetailRemark, ConfirmStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence
                                        , @DemandRequisitionQty, @RequisitionQty, @Substitute, @SubstituteStatus
                                        , @SubstituteMtlItemId, @MaterialProperties, @ExpectedRequisitionDate, @ActualRequisitionDate
                                        , @WipDetailRemark, @ConfirmStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        WoId,
                                        MtlItemId = item.SubstituteMtlItemId,
                                        item.InventoryId,
                                        UomId = item.InventoryUomId,
                                        CompositionQuantity = CompositionQuantity * item.Quantity,
                                        Base,
                                        LossRate,
                                        BomSequence = nullData,
                                        DemandRequisitionQty = PlanQty * CompositionQuantity * item.Quantity,
                                        RequisitionQty = 0,
                                        Substitute = "",
                                        SubstituteStatus = "Y",
                                        SubstituteMtlItemId = item.BomDetailMtlItemId,
                                        MaterialProperties = item.MaterialProperties,
                                        ExpectedRequisitionDate = nullData,
                                        ActualRequisitionDate = nullData,
                                        WipDetailRemark = item.MtlItemRemark,
                                        ConfirmStatus = "N",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                #endregion
                            }
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion
                        #endregion
                    }
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //ERP判斷品號是否存在
                        if (MtlItemNoList.Count() > 0)
                        {
                            foreach (var MtlItemNo in MtlItemNoList)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MB001
                                FROM INVMB a
                                WHERE MB001 = @MtlItemNo";
                                dynamicParameters.Add("MtlItemNo", MtlItemNo);

                                var invmbResult = sqlConnection.Query(sql, dynamicParameters);
                                if (invmbResult.Count() <= 0) throw new SystemException("【替代料套用】－【" + MtlItemNo + "】該品號在ERP不存在，請確認品號是否有拋轉");
                            }
                        }
                        #endregion
                    }

                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //AddManufactureOrder -- 新增MES製令資料(含製令設定+物料管理) -- Ann 2022-07-27
        public string AddManufactureOrder(int WoId, int WoSeq, int Quantity, int InputQty, int CompleteQty
            , int ScrapQty, string Status, string ProjectNo,string Remark)
        {
            try
            {
                if (WoSeq <= 0) throw new SystemException("【MES製令序號】不能為空!");
                if (Quantity < 1) throw new SystemException("【MES製令數量】不能為空!");
                if (InputQty < 0) throw new SystemException("【已投入數量】不能為空!");
                if (CompleteQty < 0) throw new SystemException("【完工數量】不能為空!");
                if (ScrapQty < 0) throw new SystemException("【報廢數量】不能為空!");
                if (!Regex.IsMatch(Status, "^(A|F|N)$", RegexOptions.IgnoreCase)) throw new SystemException("【製令狀態】錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷ERP製令是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.WoErpPrefix, a.PlanQty, a.ConfirmStatus
                                , b.MtlItemNo, b.MtlItemName
                                FROM MES.WipOrder a
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("ERP製令資料錯誤!");

                        int planQty = 0;
                        string MtlItemNo = "";
                        string MtlItemName = "";
                        foreach (var item in result)
                        {
                            if (item.WoErpPrefix == "5306" || item.WoErpPrefix == "5116") throw new SystemException("單別【5306】及【5116】無法開立MES製令!!");
                            if (item.ConfirmStatus != "Y") throw new SystemException("ERP製令尚未核單，無法新增!");
                            planQty = item.PlanQty;
                            MtlItemNo = item.MtlItemNo;
                            MtlItemName = item.MtlItemName;
                        }

                        //判斷MES製令數量是否異常
                        if (Quantity > planQty) throw new SystemException("MES製令數量不能大於ERP預計生產數量!");
                        #endregion

                        #region //判斷 ERP製令+MES製令數量 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder
                                WHERE WoId = @WoId
                                AND WoSeq = @WoSeq";
                        dynamicParameters.Add("WoId", WoId);
                        dynamicParameters.Add("WoSeq", WoSeq);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() > 0) throw new SystemException("【ERP製令 + MES製令序號】重複，請重新輸入!");
                        #endregion

                        #region //判斷MES製令預計產量總加總是否已大於ERP製令預計生產量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT Quantity
                                FROM MES.ManufactureOrder
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);

                        int CurrentQty = 0;
                        foreach (var item in result4)
                        {
                            CurrentQty += item.Quantity;
                        }

                        if ((CurrentQty + Quantity) > planQty)
                        {
                            int remainingQty = planQty - CurrentQty;
                            throw new SystemException("生產數量超過剩餘可生產數量(" + remainingQty + ")!");
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                    FROM BAS.FunctionDetail a
                                    INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                    OUTER APPLY (
                                        SELECT ISNULL((
                                            SELECT TOP 1 1
                                            FROM BAS.RoleFunctionDetail ca
                                            WHERE ca.DetailId = a.DetailId
                                            AND ca.RoleId IN (
                                                SELECT caa.RoleId
                                                FROM BAS.UserRole caa
                                                INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                                WHERE caa.UserId = @UserId
                                                AND cab.CompanyId = @CompanyId
                                            )
                                        ), 0) Authority
                                    ) c
                                    OUTER APPLY (
                                        SELECT da.UserNo, da.UserName, db.DepartmentNo
                                        FROM BAS.[User] da
                                        INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                        WHERE da.UserId = @UserId
                                    ) d
                                    WHERE a.[Status] = @Status
                                    AND b.[Status] = @Status
                                    AND b.FunctionCode = @FunctionCode
                                    AND a.DetailCode = @DetailCode
                                    AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MfgOrderManagement");
                        dynamicParameters.Add("DetailCode", "add");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");
                        #endregion

                        #region //INSERT MES.ManufactureOrder
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.ManufactureOrder (WoId, WoSeq, Quantity, InputQty, CompleteQty, ScrapQty, Status, ProjectNo,Remark
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MoId
                                VALUES (@WoId, @WoSeq, @Quantity, @InputQty, @CompleteQty, @ScrapQty, @Status, @ProjectNo,@Remark
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                WoId,
                                WoSeq,
                                Quantity,
                                InputQty,
                                CompleteQty,
                                ScrapQty,
                                Status,
                                ProjectNo,
                                Remark,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = CurrentUser,
                                LastModifiedBy = CurrentUser
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        int MoId = 0;
                        foreach (var item in insertResult)
                        {
                            MoId = Convert.ToInt32(item.MoId);
                        }
                        #endregion

                        #region //新增MES製令設定

                        #region //取得Barcode前置碼
                        string BarcodePrefix = "";
                        if (MtlItemName.IndexOf(" ") > 0)
                        {
                            BarcodePrefix = MtlItemName.Split(' ')[1];
                        }
                        #endregion

                        #region //取得機種最大滿盤數
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BatchCount TrayCount 
                                FROM MES.ItemTrayCount a 
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                INNER JOIN MES.WipOrder c ON b.MtlItemId = c.MtlItemId
                                WHERE c.WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var ItemTrayCountResult = sqlConnection.Query(sql, dynamicParameters);

                        int LotQty = 1;
                        foreach (var item in ItemTrayCountResult)
                        {
                            LotQty = item.TrayCount;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MoSetting (MoId, LotStatus, LotQty, MtlControl, OutputBarcodeFlag, Source, PVTQCFlag, OQcCheckType
                                , BarcodePrefix, SequenceLen, BarcodePostfix
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MoSettingId
                                VALUES (@MoId, @LotStatus, @LotQty, @MtlControl, @OutputBarcodeFlag, @Source, @PVTQCFlag, @OQcCheckType
                                , @BarcodePrefix, @SequenceLen, @BarcodePostfix
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoId,
                                LotStatus = "N",
                                LotQty,
                                MtlControl = "Y",
                                OutputBarcodeFlag = "N",
                                Source = "MR",
                                PVTQCFlag = "N",
                                OQcCheckType = "Y",
                                BarcodePrefix,
                                SequenceLen = 4,
                                BarcodePostfix = "-" + MoId.ToString(), 
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = CurrentUser,
                                LastModifiedBy = CurrentUser
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //新增製令用料設定檔
                        #region //查詢此ERP工單下所需物料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.WoDetailId, a.UomId, a.CompositionQuantity, a.Base, a.LossRate, a.BomSequence
                                , d.ComponentType
                                FROM MES.WoDetail a 
                                INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                LEFT JOIN PDM.BillOfMaterials c ON b.MtlItemId = c.MtlItemId
                                LEFT JOIN PDM.BomDetail d ON c.BomId = d.BomId 
								AND d.MtlItemId = a.MtlItemId 
                                AND GETDATE() >= ISNULL(d.EffectiveDate, GETDATE())
								AND GETDATE() <= ISNULL(d.ExpirationDate, GETDATE())
                                WHERE a.WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var result5 = sqlConnection.Query(sql, dynamicParameters);

                        Boolean checkbool = false;

                        if (result5.Count() > 1) checkbool = true;

                        foreach (var item in result5)
                        {
                            string bindType = item.ComponentType != "" && item.ComponentType != null ? item.ComponentType : "N";
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MoMtlSetting (MoId, WoDetailId, UomId, CompositionQuantity, Base, LossRate, BomSequence, ProcessBinding, BarcodeCtrl, MainBarcode, ControlType, BindType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MoMtlSettingId
                                    VALUES (@MoId, @WoDetailId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence, @ProcessBinding, @BarcodeCtrl, @MainBarcode, @ControlType, @BindType
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoId,
                                    item.WoDetailId,
                                    item.UomId,
                                    CompositionQuantity = item.CompositionQuantity > 0 ? (double?)item.CompositionQuantity : null,
                                    Base = item.Base > 0 ? (double?)item.Base : null,
                                    item.LossRate,
                                    item.BomSequence,
                                    ProcessBinding = bindType != "N" ? "Y" : "N",
                                    BarcodeCtrl = "Y",
                                    MainBarcode = "Y",
                                    ControlType = "2",
                                    BindType = bindType,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = CurrentUser,
                                    LastModifiedBy = CurrentUser
                                });

                            insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult2.Count();
                        }
                        #endregion
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMoRouting -- 新增MES製令途程資料 -- Ann 2022-07-28
        public string AddMoRouting(string MoRoutingData)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        var moRoutingJson = JObject.Parse(MoRoutingData);
                        if (moRoutingJson["moRoutingInfo"].Count() <= 0) throw new SystemException("【途程資料】錯誤!");

                        int rowsAffected = 0;
                        foreach (var item in moRoutingJson["moRoutingInfo"])
                        {
                            #region //判斷MES製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ModeId
                                    FROM MES.ManufactureOrder
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", Convert.ToInt32(item["MoId"]));

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");

                            int? MoModeId = -1;
                            foreach (var item2 in result)
                            {
                                MoModeId = item2.ModeId;
                            }
                            #endregion

                            #region //判斷途程品號資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.RoutingId, a.ControlId, a.MtlItemId, a.RoutingItemConfirm
                                    , b.ModeId, b.RoutingConfirm, b.Status, b.RoutingName
                                    , c.OQcCheckType
                                    FROM MES.RoutingItem a
                                    INNER JOIN MES.Routing b ON a.RoutingId = b.RoutingId
                                    INNER JOIN MES.ProdMode c ON b.ModeId = c.ModeId
                                    WHERE RoutingItemId = @RoutingItemId";
                            dynamicParameters.Add("RoutingItemId", Convert.ToInt32(item["RoutingItemId"]));

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("途程品號資料錯誤!");

                            int RoutingId = 0;
                            int ControlId = 0;
                            int MtlItemId = 0;
                            int ModeId = 0;
                            string OQcCheckType = "";
                            foreach (var item5 in result2)
                            {
                                if (item5.RoutingItemConfirm != "Y") throw new SystemException("此途程【" + item5.RoutingName + "】品號尚未確認!!");
                                if (item5.RoutingConfirm != "Y") throw new SystemException("此途程【" + item5.RoutingName + "】製程尚未確認!!");
                                if (item5.Status != "A") throw new SystemException("此途程【" + item5.RoutingName + "】尚未啟用!!");
                                RoutingId = item5.RoutingId;
                                ControlId = item5.ControlId != null ? item5.ControlId : -1;
                                MtlItemId = item5.MtlItemId;
                                ModeId = item5.ModeId;
                                OQcCheckType = item5.OQcCheckType;
                            }
                            if (ModeId == 1 && ControlId <= 0) throw new SystemException("此途程品號尚未綁定研發設計圖，無法綁定!");
                            //if (ControlId <= 0) throw new SystemException("此途程品號尚未綁定研發設計圖，無法綁定!");
                            #endregion

                            #region //檢查是否有綁定其他途程，並檢查生產模式是否一樣
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT c.ModeId
                                    FROM MES.MoRouting a
                                    INNER JOIN MES.RoutingItem b ON a.RoutingItemId = b.RoutingItemId
                                    INNER JOIN MES.Routing c ON b.RoutingId = c.RoutingId
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", Convert.ToInt32(item["MoId"]));

                            var RoutingResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in RoutingResult)
                            {
                                if (ModeId != item2.ModeId) throw new SystemException("此張製令已綁定其他生產類別之途程!");
                            }
                            #endregion

                            #region //判斷 MES製令+途程品號 是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoRouting
                                    WHERE MoId = @MoId
                                    AND RoutingItemId = @RoutingItemId";
                            dynamicParameters.Add("MoId", Convert.ToInt32(item["MoId"]));
                            dynamicParameters.Add("RoutingItemId", Convert.ToInt32(item["RoutingItemId"]));

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() > 0) throw new SystemException("【MES製令 + 途程品號】重複，請重新輸入!");
                            #endregion

                            #region //判斷 MES製令+途程順序 是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoRouting
                                    WHERE MoId = @MoId
                                    AND SortNumber = @SortNumber";
                            dynamicParameters.Add("MoId", Convert.ToInt32(item["MoId"]));
                            dynamicParameters.Add("SortNumber", Convert.ToInt32(item["SortNumber"]));

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() > 0) throw new SystemException("【MES製令 + 途程順序】重複，請重新輸入!");
                            #endregion

                            #region //新增資料至MES.MoRouting
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MoRouting (MoId, RoutingItemId, SortNumber
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MoRoutingId
                                    VALUES (@MoId, @RoutingItemId, @SortNumber
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoId = Convert.ToInt32(item["MoId"]),
                                    RoutingItemId = Convert.ToInt32(item["RoutingItemId"]),
                                    SortNumber = Convert.ToInt32(item["SortNumber"]),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();

                            int MoRoutingId = 0;
                            foreach (var item2 in insertResult)
                            {
                                MoRoutingId = item2.MoRoutingId;
                            }
                            #endregion

                            #region //新增資料至MES.MoProcess
                            #region //查詢此MES製令是否已經有綁定過途程 => 若有則將第二張途程順序加上原本順序
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(MAX(a.SortNumber), 0) SortNumber
                                    FROM MES.MoProcess a
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", Convert.ToInt32(item["MoId"]));

                            var result6 = sqlConnection.Query(sql, dynamicParameters);

                            int SortNumber = 0;
                            int NewFirstSortNumber = 0;
                            foreach (var item3 in result6)
                            {
                                SortNumber = item3.SortNumber;
                                NewFirstSortNumber = item3.SortNumber + 1;
                            }
                            #endregion

                            #region //取得途程製程資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.RoutingProcessId, b.ProcessId, b.SortNumber, b.ProcessAlias, b.NecessityStatus, b.ProcessCheckStatus, b.ProcessCheckType, b.PackageFlag, b.ConsumeFlag
                                    , b.DisplayStatus
                                    , c.ItemProcessId, c.RoutingItemProcessDesc,c.Remark
                                    , d.ProcessName, d.ProcessName
                                    FROM MES.RoutingItem a
                                    INNER JOIN MES.RoutingProcess b ON a.RoutingId = b.RoutingId
                                    LEFT JOIN MES.RoutingItemProcess c ON a.RoutingItemId = c.RoutingItemId AND c.RoutingProcessId = b.RoutingProcessId
                                    INNER JOIN MES.Process d ON d.ProcessId = b.ProcessId
                                    WHERE a.RoutingItemId = @RoutingItemId
                                    ORDER BY b.SortNumber";
                            dynamicParameters.Add("RoutingItemId", Convert.ToInt32(item["RoutingItemId"]));

                            var result7 = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //INSERT MES.MoProcess
                            int count = 1;
                            string finalProcessName = "";
                            foreach (var item4 in result7)
                            {
                                if (count == result7.Count())
                                {
                                    finalProcessName = item4.ProcessName;
                                }
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MoProcess (MoId, MoRoutingId, RoutingProcessId, ProcessId, SortNumber, ProcessAlias, RoutingItemProcessDesc, Remark, DisplayStatus, NecessityStatus, OspFlag, ProcessCheckStatus, ProcessCheckType, PackageFlag, ConsumeFlag
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MoProcessId
                                        VALUES (@MoId, @MoRoutingId, @RoutingProcessId, @ProcessId, @SortNumber, @ProcessAlias, @RoutingItemProcessDesc, @Remark, @DisplayStatus, @NecessityStatus, @OspFlag, @ProcessCheckStatus, @ProcessCheckType, @PackageFlag, @ConsumeFlag
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MoId = Convert.ToInt32(item["MoId"]),
                                        MoRoutingId,
                                        item4.RoutingProcessId,
                                        item4.ProcessId,
                                        SortNumber = Convert.ToInt32(item4.SortNumber) + SortNumber,
                                        item4.ProcessAlias,
                                        item4.RoutingItemProcessDesc,
                                        item4.Remark,
                                        item4.DisplayStatus,
                                        item4.NecessityStatus,
                                        OspFlag = "N",
                                        item4.ProcessCheckStatus,
                                        item4.ProcessCheckType,
                                        item4.PackageFlag,
                                        item4.ConsumeFlag,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                count++;

                                int MoProcessId = -1;
                                foreach (var item5 in insertResult)
                                {
                                    MoProcessId = item5.MoProcessId;
                                }

                                #region //新增資料至MES.MoProcessItem

                                #region //取得RoutingProcessItem資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.ItemNo, a.ChkUnique
                                        FROM MES.RoutingProcessItem a
                                        WHERE a.RoutingProcessId = @RoutingProcessId";
                                dynamicParameters.Add("RoutingProcessId", item4.RoutingProcessId);

                                var routingProcessItemResult = sqlConnection.Query(sql, dynamicParameters);
                                #endregion

                                if (routingProcessItemResult.Count() <= 0)
                                {
                                    #region //檢查是否為刻字站，若為刻字站則自動帶入刻字屬性
                                    if (item4.ProcessName == "刻字")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.MoProcessItem (MoProcessId, ItemNo, ChkUnique
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.MoProcessId
                                                VALUES (@MoProcessId, @ItemNo, @ChkUnique
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MoProcessId,
                                                ItemNo = "Lettering",
                                                ChkUnique = "Y",
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });

                                        insertResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();
                                    }
                                    #endregion
                                }
                                else
                                {
                                    foreach (var item5 in routingProcessItemResult)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.MoProcessItem (MoProcessId, ItemNo, ChkUnique
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.MoProcessId
                                                VALUES (@MoProcessId, @ItemNo, @ChkUnique
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MoProcessId,
                                                item5.ItemNo,
                                                item5.ChkUnique,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });

                                        insertResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();
                                    }
                                }
                                #endregion

                                #region //確認途程是否有設定量測項目
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.RoutingItemQcItemId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance, a.Remark
                                        FROM MES.RoutingItemQcItem a 
                                        INNER JOIN MES.RoutingItemProcess b ON a.ItemProcessId = b.ItemProcessId
                                        WHERE a.RoutingItemId = @RoutingItemId
                                        AND b.RoutingProcessId = @RoutingProcessId";
                                dynamicParameters.Add("RoutingItemId", Convert.ToInt32(item["RoutingItemId"]));
                                dynamicParameters.Add("RoutingProcessId", item4.RoutingProcessId);

                                var RoutingItemQcItemResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item2 in RoutingItemQcItemResult)
                                {
                                    #region //Insert MES.MoProcessQcItem
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.MoProcessQcItem (MoProcessId, QcItemId, QcItemDesc, DesignValue, UpperTolerance, LowerTolerance, Remark
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            VALUES (@MoProcessId, @QcItemId, @QcItemDesc, @DesignValue, @UpperTolerance, @LowerTolerance, @Remark
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MoProcessId,
                                            item2.QcItemId,
                                            item2.QcItemDesc,
                                            item2.DesignValue,
                                            item2.UpperTolerance,
                                            item2.LowerTolerance,
                                            item2.Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion

                                SortNumber++;
                            }
                            #endregion
                            #endregion

                            #region //取得出貨工程
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TypeNo, a.TypeName
                                    FROM BAS.[Type] a
                                    WHERE a.TypeSchema = 'ManufactureOrder.DeliveryProcess'";

                            var result8 = sqlConnection.Query(sql, dynamicParameters);

                            string DeliveryProcess = "";
                            foreach (var item2 in result8)
                            {
                                string typeName = item2.TypeName;
                                if (finalProcessName.Contains("精D"))
                                {
                                    DeliveryProcess = "8";
                                }
                                else if (finalProcessName.Contains("拋光"))
                                {
                                    DeliveryProcess = "7";
                                }
                                else if (typeName.Contains(finalProcessName))
                                {
                                    DeliveryProcess = item2.TypeNo;
                                }
                                else
                                {
                                    DeliveryProcess = "1";
                                }
                            }
                            #endregion

                            #region //自動填入生產模式、出貨工程、出貨檢參數
                            if (MoModeId == null)
                            {
                                if (CurrentCompany != 2) OQcCheckType = "Y"; //目前只有中揚上量測系統，待其他公司上了再改

                                #region //UPDATE MES.ManufactureOrder ModeId
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.ManufactureOrder SET
                                        ModeId = @ModeId,
                                        DeliveryProcess = @DeliveryProcess,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ModeId,
                                        DeliveryProcess,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MoId = Convert.ToInt32(item["MoId"])
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //UPDATE MES.MoSetting 
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MoSetting SET
                                        OQcCheckType = @OQcCheckType,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        OQcCheckType = "Y",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MoId = Convert.ToInt32(item["MoId"])
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //依據生產別自動建立量測單據
                                if (OQcCheckType == "N")
                                {
                                    #region //取得預設SpreadsheetData
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.DefaultSpreadsheetData
                                            FROM MES.QcRecord a";

                                    var DefaultFileIdResult = sqlConnection.Query(sql, dynamicParameters);

                                    string DefaultSpreadsheetData = "";
                                    foreach (var item2 in DefaultFileIdResult)
                                    {
                                        DefaultSpreadsheetData = item2.DefaultSpreadsheetData;
                                    }
                                    #endregion

                                    #region //取得此生產模式下OQC資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.QcTypeId
                                            FROM QMS.QcType a 
                                            WHERE a.ModeId = @ModeId
                                            AND a.QcTypeNo = 'OQC'";
                                    dynamicParameters.Add("ModeId", ModeId);

                                    var QcTypeResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (QcTypeResult.Count() <= 0) throw new SystemException("此生產模式尚未設定量測類型，請通知系統開發室!!");

                                    int QcTypeId = -1;
                                    foreach (var item2 in QcTypeResult)
                                    {
                                        QcTypeId = item2.QcTypeId;
                                    }
                                    #endregion

                                    #region //INSERT MES.QcRecord
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.QcRecord (QcTypeId, InputType, MoId, MoProcessId, Remark, DefaultFileId, CurrentFileId, DefaultSpreadsheetData, CheckQcMeasureData
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.QcRecordId
                                            VALUES (@QcTypeId, @InputType, @MoId, @MoProcessId, @Remark, @DefaultFileId, @CurrentFileId, @DefaultSpreadsheetData, @CheckQcMeasureData
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            QcTypeId,
                                            InputType = "Lettering",
                                            MoId = Convert.ToInt32(item["MoId"]),
                                            MoProcessId = (int?)null,
                                            Remark = "",
                                            DefaultFileId = -1,
                                            CurrentFileId = -1,
                                            DefaultSpreadsheetData,
                                            CheckQcMeasureData = "N",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion
                                }
                                #endregion

                                #region //根據生產模式UPDATE MES.MoSetting
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeCtrl, a.OQcCheckType, a.Source, a.PVTQCFlag, a.NgToBarcode
                                        , a.TrayBarcode, a.LotStatus, a.OutputBarcodeFlag, a.MrType
                                        FROM MES.ProdMode a 
                                        WHERE a.ModeId = @ModeId";
                                dynamicParameters.Add("ModeId", ModeId);

                                var ProdModeResult = sqlConnection.Query(sql, dynamicParameters);

                                if (ProdModeResult.Count() <= 0) throw new SystemException("查無生產模式資料!!");

                                string BarcodeCtrl = "";
                                string Source = "";
                                foreach (var item2 in ProdModeResult)
                                {
                                    BarcodeCtrl = item2.BarcodeCtrl != null ? item2.BarcodeCtrl : "Y";
                                    Source = item2.Source != null ? item2.Source : "MR";

                                    #region //UPDATE MES.MoSetting
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.MoSetting SET
                                            LotStatus = @LotStatus,
                                            NgToBarcode = @NgToBarcode,
                                            OutputBarcodeFlag = @OutputBarcodeFlag,
                                            Source = @Source,
                                            PVTQCFlag = @PVTQCFlag,
                                            OQcCheckType = @OQcCheckType,
                                            BarcodeCtrl = @BarcodeCtrl,
                                            TrayBarcode = @TrayBarcode,
                                            MrType = @MrType,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE MoId = @MoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            LotStatus = item2.LotStatus != null ? item2.LotStatus : "N",
                                            NgToBarcode = item2.NgToBarcode != null ? item2.NgToBarcode : "N",
                                            OutputBarcodeFlag = item2.OutputBarcodeFlag != null ? item2.OutputBarcodeFlag : "N",
                                            Source = item2.Source != null ? item2.Source : "MR",
                                            PVTQCFlag = item2.PVTQCFlag != null ? item2.PVTQCFlag : "N",
                                            OQcCheckType = "Y", //暫時Y //item2.OQcCheckType != null ? item2.OQcCheckType : "Y",
                                            BarcodeCtrl = item2.BarcodeCtrl != null ? item2.BarcodeCtrl : "Y",
                                            TrayBarcode = item2.TrayBarcode != null ? item2.TrayBarcode : "N",
                                            MrType = item2.MrType != null ? item2.MrType : "Y",
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            MoId = Convert.ToInt32(item["MoId"])
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion

                                #region //根據是否條碼控管Update MES.MoMtlSetting
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MoMtlSetting SET
                                        BarcodeCtrl = @BarcodeCtrl,
                                        MainBarcode = @MainBarcode,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeCtrl = Source == "BP" ? "N" : "Y",
                                        MainBarcode = Source == "BP" ? "N" : "Y",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MoId = Convert.ToInt32(item["MoId"])
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //檢查是否有條碼為已完工且未入庫，若有則更改下製程

                            #region //先取得下製程MoProcessId
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MoProcessId
                                    FROM MES.MoProcess a
                                    WHERE MoId = @MoId
                                    AND SortNumber = @SortNumber";
                            dynamicParameters.Add("MoId", Convert.ToInt32(item["MoId"]));
                            dynamicParameters.Add("SortNumber", NewFirstSortNumber);

                            var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MoProcessResult.Count() <= 0) throw new SystemException("下製程資料錯誤!!");

                            int NewFirstMoProcessId = -1;
                            foreach (var item2 in MoProcessResult)
                            {
                                NewFirstMoProcessId = item2.MoProcessId;
                            }
                            #endregion

                            #region //檢核新製程ID是否與原MOID相同
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoId
                                    FROM MES.MoProcess a
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", NewFirstMoProcessId);

                            var NewMoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (NewMoProcessResult.Count() <= 0) throw new SystemException("下製程資料錯誤!!");

                            foreach (var item2 in NewMoProcessResult)
                            {
                                if (item2.MoId != Convert.ToInt32(item["MoId"])) throw new SystemException("下製程製令錯誤!!");
                            }
                            #endregion

                            #region //UPDATE MES.Barcode NextMoProcessId AND BarcodeStatus
                            dynamicParameters = new DynamicParameters();

                            sql = @"UPDATE MES.Barcode SET
                                    NextMoProcessId = @NextMoProcessId,
                                    BarcodeStatus = '1',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoId = @MoId
                                    AND NextMoProcessId = -1
                                    AND BarcodeStatus = '0'";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NextMoProcessId = NewFirstMoProcessId,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoId = Convert.ToInt32(item["MoId"])
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                            #endregion
                        }

                        #region //重新排序MES.MoRouting
                        dynamicParameters = new DynamicParameters();
                        sql = @"With UpdateSort As
                                (
                                  SELECT SortNumber,
                                  ROW_NUMBER() OVER(ORDER BY SortNumber) NewRoutingProcessSort
                                  FROM MES.MoRouting
                                  WHERE MoId = @MoId
                                )
                                UPDATE MES.MoRouting 
                                SET SortNumber = NewRoutingProcessSort
                                FROM MES.MoRouting
                                INNER JOIN UpdateSort ON MES.MoRouting.SortNumber = UpdateSort.SortNumber
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", Convert.ToInt32(moRoutingJson["moRoutingInfo"][0]["MoId"]));

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //重新排序MES.MoProcess
                        dynamicParameters = new DynamicParameters();
                        sql = @"With UpdateSort As
                                (
                                  SELECT SortNumber,
                                  ROW_NUMBER() OVER(ORDER BY SortNumber) NewRoutingProcessSort
                                  FROM MES.MoProcess
                                  WHERE MoId = @MoId
                                )
                                UPDATE MES.MoProcess 
                                SET SortNumber = NewRoutingProcessSort
                                FROM MES.MoProcess
                                INNER JOIN UpdateSort ON MES.MoProcess.SortNumber = UpdateSort.SortNumber
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", Convert.ToInt32(moRoutingJson["moRoutingInfo"][0]["MoId"]));

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMoMtlSetting -- 新增MES製令用料設定 -- Ann 2022-08-01
        public string AddMoMtlSetting(int MoId, int WoDetailId, int UomId, double CompositionQuantity
            , double Base, double LossRate, string BomSequence, string ProcessBinding, int MoProcessId
            , string BarcodeCtrl, string MainBarcode, string ControlType)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (BarcodeCtrl.Length < 0) throw new SystemException("【是否綁定條碼】不能為空!");
                        if (MainBarcode.Length < 0) throw new SystemException("【是否檢核條碼】不能為空!");
                        if (ProcessBinding.Length < 0) throw new SystemException("【物料需製程綁定】不能為空!");
                        if (ControlType.Length <= 0) throw new SystemException("【扣帳方式】不能為空!");

                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #region //判斷MES製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");
                        #endregion

                        #region //判斷ERP工單結構資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.WoDetail
                                WHERE WoDetailId = @WoDetailId";
                        dynamicParameters.Add("WoDetailId", WoDetailId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("ERP工單結構資料錯誤!");
                        #endregion

                        #region //判斷單位是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @UomId";
                        dynamicParameters.Add("UomId", UomId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() <= 0) throw new SystemException("單位資料錯誤!");
                        #endregion

                        #region //判斷MES製令製程資料是否正確
                        if (MoProcessId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                FROM MES.MoProcess
                                WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("MES製令製程資料錯誤!");
                        }
                        #endregion

                        #region //判斷 MES製令+ERP工單結構資料 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSetting
                                WHERE MoId = @MoId
                                AND WoDetailId = @WoDetailId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("WoDetailId", WoDetailId);

                        var result5 = sqlConnection.Query(sql, dynamicParameters);
                        if (result5.Count() > 0) throw new SystemException("【MES製令 + ERP工單結構資料】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MoMtlSetting (MoId, WoDetailId, UomId, CompositionQuantity, Base
                                , LossRate, BomSequence, ProcessBinding, MoProcessId, BarcodeCtrl, MainBarcode, ControlType
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MoMtlSettingId
                                VALUES (@MoId, @WoDetailId, @UomId, @CompositionQuantity, @Base
                                , @LossRate, @BomSequence, @ProcessBinding, @MoProcessId, @BarcodeCtrl, @MainBarcode, @ControlType
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoId,
                                WoDetailId,
                                UomId,
                                CompositionQuantity = CompositionQuantity > 0 ? (int?)CompositionQuantity : null,
                                Base = Base > 0 ? (int?)Base : null,
                                LossRate = LossRate > 0 ? (int?)LossRate : null,
                                BomSequence,
                                ProcessBinding,
                                MoProcessId = MoProcessId > 0 ? (int?)MoProcessId : null,
                                BarcodeCtrl,
                                MainBarcode,
                                ControlType,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBarcodePrint -- 新增批量條碼 -- Ann 2023-08-22
        public string AddBarcodePrint(int MoId, int CavityCount)
        {
            try
            {
                int rowsAffected = 0;
                string BarcodeNo = "";
                string seq = "";

                List<BarcodePrint> barcodePrints = new List<BarcodePrint>();
                List<Barcode> barcodes = new List<Barcode>();
                    
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            if (CavityCount <= 0) throw new SystemException("【穴號數】不能為0或小於0!!");

                            #region //確認製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.Quantity, a.[Status]
                                    , b.MoSettingId, b.BarcodePrefix, b.SequenceLen, b.BarcodePostfix, b.Source, b.LotQty, b.BarcodeCtrl
                                    , c.MoProcessId
                                    , (
                                        SELECT SUM(x.BarcodeQty) BarcodeQty
                                        FROM MES.BarcodePrint x 
                                        INNER JOIN MES.MoSetting xa ON x.MoSettingId = xa.MoSettingId
                                        WHERE xa.MoId = a.MoId
                                    ) CheckBarcodePrint
                                    FROM MES.ManufactureOrder a 
                                    INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                    INNER JOIN MES.MoProcess c ON a.MoId = c.MoId AND c.SortNumber = 1
                                    WHERE a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var MoResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MoResult.Count() <= 0) throw new SystemException("製令資料錯誤!!");

                            double Quantity = -1;
                            string BarcodePrefix = "";
                            int SequenceLen = -1;
                            string BarcodePostfix = "";
                            int MoProcessId = -1;
                            double LotQty = -1;
                            int MoSettingId = -1;
                            string BarcodeCtrl = "";
                            int? CheckBarcodePrint = -1;
                            foreach (var item in MoResult)
                            {
                                if (item.Status == "F" || item.Status == "y") throw new SystemException("製令已完工，無法新增!!");
                                if (item.Source != "BP") throw new SystemException("製令條碼來源設定錯誤，無法新增!!");

                                Quantity = item.Quantity;
                                BarcodePrefix = item.BarcodePrefix;
                                SequenceLen = item.SequenceLen;
                                BarcodePostfix = item.BarcodePostfix;
                                MoProcessId = item.MoProcessId;
                                LotQty = item.LotQty;
                                MoSettingId = item.MoSettingId;
                                BarcodeCtrl = item.BarcodeCtrl;
                                CheckBarcodePrint = item.CheckBarcodePrint;
                            }
                            #endregion

                            #region //查詢此製令所有超領單資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MrId, a.MrErpPrefix, a.MrErpNo, a.ConfirmStatus
                                    FROM MES.MaterialRequisition a 
                                    INNER JOIN MES.MrDetail b ON a.MrId = b.MrId
                                    WHERE b.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var MrResult = sqlConnection.Query(sql, dynamicParameters);

                            List<int> mrIdList = new List<int>();
                            foreach (var item in MrResult)
                            {
                                #region //確認此單別是否為超領單別
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MQ010, LTRIM(RTRIM(a.MQ054)) MQ054
                                        FROM CMSMQ a 
                                        WHERE MQ001 = @MrErpPrefix";
                                dynamicParameters.Add("MrErpPrefix", item.MrErpPrefix);

                                var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);
                                if (CMSMQResult.Count() <= 0) throw new SystemException("ERP單別資料有誤!!");

                                foreach (var item2 in CMSMQResult)
                                {
                                    if (item2.MQ010 < 0 && item2.MQ054 == "N" && item.ConfirmStatus == "Y")
                                    {
                                        if (mrIdList.IndexOf(item.MrId) == -1)
                                        {
                                            mrIdList.Add(item.MrId);
                                        }
                                    }
                                }
                                #endregion
                            }
                            #endregion

                            #region //將超領單別的數量加入總數量中
                            double excessQty = 0;
                            foreach (var mrId in mrIdList)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 a.ActualQuantity
                                        , f.CompositionQuantity, f.Base
                                        FROM MES.MrDetail a
                                        INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                        INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                        INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                        INNER JOIN PDM.BillOfMaterials e ON e.MtlItemId = d.MtlItemId
                                        INNER JOIN PDM.BomDetail f ON f.BomId = f.BomId AND f.MtlItemId = a.MtlItemId
                                        WHERE a.MoId = @MoId AND b.MrId = @MrId";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MrId", mrId);

                                var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in MrDetailResult)
                                {
                                    double currentQty = item.ActualQuantity;
                                    Quantity += currentQty;
                                    excessQty += currentQty;
                                }
                            }

                            if (CheckBarcodePrint != null)
                            {
                                if (Quantity < CheckBarcodePrint)
                                {
                                    throw new SystemException("批量條碼數量已超過製令預計生產量!!");
                                }

                                if (CheckBarcodePrint == Quantity)
                                {
                                    Quantity = excessQty;
                                }
                                else
                                {
                                    Quantity = Quantity - Convert.ToDouble(CheckBarcodePrint);
                                }
                            }
                            #endregion

                            #region //計算可以產出多少批量條碼
                            int totalLotCount = Convert.ToInt32(Math.Floor(Quantity / LotQty)); //整數盤數(盤)
                            int remainderCount = Convert.ToInt32(Quantity % LotQty); //尾數盤的數量(PCS)
                            int cavityLotCount = remainderCount / CavityCount; //尾數盤數分穴後的每盤數量(PCS)
                            int carityRemainderCount = remainderCount % CavityCount; //分穴後的尾數盤數量(PCS)

                            if (cavityLotCount < 1)
                            {
                                CavityCount = cavityLotCount > 0 ? 1 : 0;
                                cavityLotCount = remainderCount;
                                carityRemainderCount = 0;
                            }

                            if (totalLotCount == 0 && remainderCount == 0 && cavityLotCount == 0 && carityRemainderCount == 0)
                            {
                                throw new SystemException("已無剩餘數量可以產生批量條碼!!");
                            }
                            #endregion

                            #region //取得目前最大命名格式
                            seq = GetNewBarcodeNo(BarcodePrefix, SequenceLen, BarcodePostfix);
                            seq = seq.PadLeft(SequenceLen, '0');
                            BarcodeNo = BarcodePrefix + seq + BarcodePostfix;
                            #endregion

                            #region //INSERT 整數盤部分
                            for (int i=1; i<=totalLotCount; i++)
                            {
                                if (barcodePrints.Count() > 0)
                                {
                                    seq = (Convert.ToInt32(seq) + 1).ToString();
                                    seq = seq.PadLeft(SequenceLen, '0');
                                    BarcodeNo = BarcodePrefix + seq + BarcodePostfix;
                                }

                                //BarcodeNo = barcodePrints.Max(item => item.BarcodeNo);
                                //BarcodeNo = GetNewBarcodeNo(BarcodePrefix, SequenceLen, BarcodePostfix);
                                bool containsTraditionalChinese = Regex.IsMatch(BarcodeNo, @"\p{IsCJKUnifiedIdeographs}");
                                bool containsSimplifiedChinese = Regex.IsMatch(BarcodeNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]");
                                if (containsTraditionalChinese == true) throw new SystemException("【生產製令資料維護】-【批量條碼】不能包含繁簡體中文!");
                                if (containsSimplifiedChinese == true) throw new SystemException("【生產製令資料維護】-【批量條碼】不能包含繁簡體中文!");

                                //BarcodeNo 英文轉大寫
                                BarcodeNo = BarcodeNo.ToUpper();
                                //BarcodeNo 移除空格
                                BarcodeNo = Regex.Replace(BarcodeNo, @"\s+", String.Empty);

                                BarcodePrint barcodePrint = new BarcodePrint()
                                {
                                    BarcodeNo = BarcodeNo,
                                    BarcodeQty = LotQty,
                                    MoSettingId = MoSettingId,
                                    ParentBarcode = "",
                                    PrintCnt = 0,
                                    PrintStatus = "P",
                                    CreateDate = CreateDate,
                                    LastModifiedDate = LastModifiedDate,
                                    CreateBy = CreateBy,
                                    LastModifiedBy = LastModifiedBy
                                };

                                barcodePrints.Add(barcodePrint);

                                Barcode barcode = new Barcode()
                                {
                                    BarcodeNo = BarcodeNo,
                                    CurrentMoProcessId = MoProcessId,
                                    NextMoProcessId = MoProcessId,
                                    MoId = MoId,
                                    BarcodeQty = LotQty,
                                    CurrentProdStatus = "P",
                                    BarcodeStatus = "1",
                                    CreateDate = CreateDate,
                                    LastModifiedDate = LastModifiedDate,
                                    CreateBy = CreateBy,
                                    LastModifiedBy = LastModifiedBy
                                };
                                barcodes.Add(barcode);
                            }
                            #endregion

                            #region //INSERT 尾數盤部分
                            for (int i=1; i<= CavityCount; i++)
                            {
                                seq = (Convert.ToInt32(seq) + 1).ToString();
                                seq = seq.PadLeft(SequenceLen, '0');
                                BarcodeNo = BarcodePrefix + seq + BarcodePostfix;

                                bool containsTraditionalChinese = Regex.IsMatch(BarcodeNo, @"\p{IsCJKUnifiedIdeographs}");
                                bool containsSimplifiedChinese = Regex.IsMatch(BarcodeNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]");
                                if (containsTraditionalChinese == true) throw new SystemException("【生產製令資料維護】-【批量條碼】不能包含繁簡體中文!");
                                if (containsSimplifiedChinese == true) throw new SystemException("【生產製令資料維護】-【批量條碼】不能包含繁簡體中文!");


                                //BarcodeNo 英文轉大寫
                                BarcodeNo = BarcodeNo.ToUpper();
                                //BarcodeNo 移除空格
                                BarcodeNo = Regex.Replace(BarcodeNo, @"\s+", String.Empty);

                                BarcodePrint barcodePrint = new BarcodePrint()
                                {
                                    BarcodeNo = BarcodeNo,
                                    BarcodeQty = cavityLotCount,
                                    MoSettingId = MoSettingId,
                                    ParentBarcode = "",
                                    PrintCnt = 0,
                                    PrintStatus = "P",
                                    CreateDate = CreateDate,
                                    LastModifiedDate = LastModifiedDate,
                                    CreateBy = CreateBy,
                                    LastModifiedBy = LastModifiedBy
                                };

                                barcodePrints.Add(barcodePrint);

                                Barcode barcode = new Barcode()
                                {
                                    BarcodeNo = BarcodeNo,
                                    CurrentMoProcessId = MoProcessId,
                                    NextMoProcessId = MoProcessId,
                                    MoId = MoId,
                                    BarcodeQty = cavityLotCount,
                                    CurrentProdStatus = "P",
                                    BarcodeStatus = "1",
                                    CreateDate = CreateDate,
                                    LastModifiedDate = LastModifiedDate,
                                    CreateBy = CreateBy,
                                    LastModifiedBy = LastModifiedBy
                                };
                                barcodes.Add(barcode);
                            }
                            #endregion

                            #region //INSERT 分穴後尾數盤部分
                            if (carityRemainderCount > 0)
                            {
                                seq = (Convert.ToInt32(seq) + 1).ToString();
                                seq = seq.PadLeft(SequenceLen, '0');
                                BarcodeNo = BarcodePrefix + seq + BarcodePostfix;

                                bool containsTraditionalChinese = Regex.IsMatch(BarcodeNo, @"\p{IsCJKUnifiedIdeographs}");
                                bool containsSimplifiedChinese = Regex.IsMatch(BarcodeNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]");
                                if (containsTraditionalChinese == true) throw new SystemException("【生產製令資料維護】-【批量條碼】不能包含繁簡體中文!");
                                if (containsSimplifiedChinese == true) throw new SystemException("【生產製令資料維護】-【批量條碼】不能包含繁簡體中文!");


                                //BarcodeNo 英文轉大寫
                                BarcodeNo = BarcodeNo.ToUpper();
                                //BarcodeNo 移除空格
                                BarcodeNo = Regex.Replace(BarcodeNo, @"\s+", String.Empty);

                                BarcodePrint barcodePrint = new BarcodePrint()
                                {
                                    BarcodeNo = BarcodeNo,
                                    BarcodeQty = carityRemainderCount,
                                    MoSettingId = MoSettingId,
                                    ParentBarcode = "",
                                    PrintCnt = 0,
                                    PrintStatus = "P",
                                    CreateDate = CreateDate,
                                    LastModifiedDate = LastModifiedDate,
                                    CreateBy = CreateBy,
                                    LastModifiedBy = LastModifiedBy
                                };

                                barcodePrints.Add(barcodePrint);

                                Barcode barcode = new Barcode()
                                {
                                    BarcodeNo = BarcodeNo,
                                    CurrentMoProcessId = MoProcessId,
                                    NextMoProcessId = MoProcessId,
                                    MoId = MoId,
                                    BarcodeQty = carityRemainderCount,
                                    CurrentProdStatus = "P",
                                    BarcodeStatus = "1",
                                    CreateDate = CreateDate,
                                    LastModifiedDate = LastModifiedDate,
                                    CreateBy = CreateBy,
                                    LastModifiedBy = LastModifiedBy
                                };
                                barcodes.Add(barcode);
                            }
                            #endregion

                            #region //INSERT MES.BarcodePrint
                            sql = @"INSERT INTO MES.BarcodePrint (BarcodeNo, BarcodeQty, MoSettingId, ParentBarcode, PrintCnt, PrintStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.PrintId, INSERTED.BarcodeQty
                                    VALUES (@BarcodeNo, @BarcodeQty, @MoSettingId, @ParentBarcode, @PrintCnt, @PrintStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, barcodePrints);
                            #endregion

                            #region //INSERT MES.Barcode
                            sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, CurrentProdStatus, BarcodeStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeId
                                    VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @CurrentProdStatus, @BarcodeStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, barcodes);
                            #endregion

                            #region //取得最大序列號條碼
                            string GetNewBarcodeNo(string thisBarcodePrefix, int thisSequenceLen, string thisBarcodePostfix)
                            {
                                string NewBarcodeNo = "";
                                #region //找此BARCODE格式最大號
                                #region //組模糊查詢字串
                                string SearchLikeStrig = "";
                                for (int j = 1; j <= thisSequenceLen; j++)
                                {
                                    SearchLikeStrig += "_";
                                }
                                #endregion

                                string queryModal = "";
                                if (thisBarcodePrefix.IndexOf("[") != -1)
                                {
                                    char[] prefixList = thisBarcodePrefix.ToCharArray();
                                    
                                    for (int i=0; i<prefixList.Length; i++)
                                    {
                                        if (prefixList[i] == '[') queryModal += "|";
                                        queryModal += prefixList[i];
                                    }

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                            FROM MES.BarcodePrint
                                            WHERE BarcodeNo LIKE '%" + queryModal + SearchLikeStrig + thisBarcodePostfix + "%' ESCAPE '|'";
                                }
                                else if (thisBarcodePostfix.IndexOf("[") != -1)
                                {
                                    char[] postfixList = thisBarcodePostfix.ToCharArray();

                                    for (int i = 0; i < postfixList.Length; i++)
                                    {
                                        if (postfixList[i] == '[') queryModal += "|";
                                        queryModal += postfixList[i];
                                    }

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                            FROM MES.BarcodePrint
                                            WHERE BarcodeNo LIKE '%" + thisBarcodePrefix + SearchLikeStrig + queryModal + "%' ESCAPE '|'";
                                }
                                else
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                            FROM MES.BarcodePrint
                                            WHERE BarcodeNo LIKE '" + thisBarcodePrefix + SearchLikeStrig + thisBarcodePostfix + "%'";
                                }

                                var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in BarcodeResult)
                                {
                                    string MaxBarcodeNo = item.MaxBarcodeNo;
                                    if (item.MaxBarcodeNo == null)
                                    {
                                        seq = "1".PadLeft(SequenceLen, '0');
                                    }
                                    else
                                    {
                                        #region //拆解BarcodeNo順序
                                        string thisSeq = "";
                                        if (thisBarcodePostfix != "")
                                        {
                                            thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "").Replace(thisBarcodePostfix, "");
                                        }
                                        else
                                        {
                                            thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "");
                                        }
                                        seq = (Convert.ToInt32(thisSeq) + 1).ToString().PadLeft(SequenceLen, '0');
                                        #endregion
                                    }

                                    NewBarcodeNo = thisBarcodePrefix + seq + thisBarcodePostfix;
                                }
                                #endregion

                                return seq;
                            }
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMoMtlSettingAttribute -- 新增MES製令用料屬性檔 -- Ann 2022-08-11
        public string AddMoMtlSettingAttribute(int MoMtlSettingId, string ItemNo, string ItemName, string ItemDesc, string ChkUnique, string ChkRange)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (ItemName.Length <= 0) throw new SystemException("【項目名稱】不能為空!");
                        if (ItemName.Length > 30) throw new SystemException("【項目名稱】長度錯誤!");
                        if (ItemDesc.Length > 200) throw new SystemException("【項目描述】長度錯誤!");
                        if (ChkUnique.Length <= 0) throw new SystemException("【檢核重覆值】不能為空!");
                        if (ChkUnique.Length > 1) throw new SystemException("【檢核重覆值】長度錯誤!");

                        if (ChkUnique == "Y")
                        {
                            if (ChkRange.Length <= 0) throw new SystemException("【檢核範圍】不能為空!");
                            if (ChkRange.Length > 1) throw new SystemException("【檢核範圍】長度錯誤!");
                        }

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令物料控管資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSetting
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料控管資料錯誤!");
                        #endregion

                        #region //判斷類別資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM BAS.Type
                                WHERE TypeNo = @TypeNo";
                        dynamicParameters.Add("TypeNo", ItemNo);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("類別資料錯誤!");
                        #endregion

                        #region //判斷 MES製令物料控管+項目 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSettingAttribute
                                WHERE MoMtlSettingId = @MoMtlSettingId
                                AND ItemNo = @ItemNo";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);
                        dynamicParameters.Add("ItemNo", ItemNo);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() > 0) throw new SystemException("【MES製令 + 項目】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MoMtlSettingAttribute (MoMtlSettingId, ItemNo, ItemName, ItemDesc, ChkUnique, ChkRange
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@MoMtlSettingId, @ItemNo, @ItemName, @ItemDesc, @ChkUnique, @ChkRange
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoMtlSettingId,
                                ItemNo,
                                ItemName,
                                ItemDesc,
                                ChkUnique,
                                ChkRange = ChkRange.Length > 0 ? ChkRange : null,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddEmptyBarcodePrint -- 新增批量空條碼 -- Ann 2022-10-14 --GPai 20230508 
        public string AddEmptyBarcodePrint(int AddCount, int MoSettingId, string Status)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (AddCount <= 0) throw new SystemException("【分批數】不能為空!");

                        #region //判斷製令設定資料是否有誤
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.BarcodePrefix, a.SequenceLen, a.BarcodePostfix, a.Source
                                , b.Status
                                , c.MoProcessId
                                FROM MES.MoSetting a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                INNER JOIN MES.MoProcess c ON a.MoId = c.MoId AND c.SortNumber = 1
                                WHERE a.MoSettingId = @MoSettingId";
                        dynamicParameters.Add("MoSettingId", MoSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令設定資料有誤!");

                        string BarcodePrefix = "";
                        int SequenceLen = -1;
                        string BarcodePostfix = "";
                        int MoProcessId = -1;
                        foreach (var item in result)
                        {
                            if (item.Source != "BP") throw new SystemException("此製令發料方式非批量條碼!");
                            BarcodePrefix = item.BarcodePrefix;
                            SequenceLen = item.SequenceLen;
                            BarcodePostfix = item.BarcodePostfix;
                            MoProcessId = item.MoProcessId;
                        }
                        #endregion

                        #region //先取得最大批量條碼NUM
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MAX(BarcodeNo) BarcodeNo
                                FROM MES.BarcodePrint
                                WHERE BarcodeNo LIKE @BarcodePrefix + '%' + @BarcodePostfix";
                        dynamicParameters.Add("BarcodePrefix", BarcodePrefix);
                        dynamicParameters.Add("BarcodePostfix", BarcodePostfix);

                        var result22 = sqlConnection.Query(sql, dynamicParameters);
                        string maxBarcodeNo = result22.First().BarcodeNo;
                        var maxBarcodeNo2 = maxBarcodeNo.Substring(BarcodePrefix.Length, SequenceLen);
                        var maxBarcodeNum = int.Parse(maxBarcodeNo2) + 1;
                        #endregion

                        //#region //先取得原本批量條碼SEQ
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT COUNT(1) Count
                        //        FROM MES.BarcodePrint
                        //        WHERE MoSettingId = @MoSettingId";
                        //dynamicParameters.Add("MoSettingId", MoSettingId);

                        //var result2 = sqlConnection.Query(sql, dynamicParameters);

                        //int BarcodeSeq = -1;
                        //foreach (var item in result2)
                        //{
                        //    BarcodeSeq = item.Count + 1;
                        //}
                        //#endregion

                        int rowsAffected = 0;
                        for (int i = 1; i <= AddCount; i++)
                        {
                            string BarcodeNo = BarcodePrefix + maxBarcodeNum.ToString().PadLeft(SequenceLen, '0') + BarcodePostfix;
                            bool containsTraditionalChinese = Regex.IsMatch(BarcodeNo, @"\p{IsCJKUnifiedIdeographs}");
                            bool containsSimplifiedChinese = Regex.IsMatch(BarcodeNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]");
                            if (containsTraditionalChinese == true) throw new SystemException("【生產製令資料維護】-【空條碼】不能包含繁簡體中文!");
                            if (containsSimplifiedChinese == true) throw new SystemException("【生產製令資料維護】-【空條碼】不能包含繁簡體中文!");


                            //BarcodeNo 英文轉大寫
                            BarcodeNo = BarcodeNo.ToUpper();
                            //BarcodeNo 移除空格
                            BarcodeNo = Regex.Replace(BarcodeNo, @"\s+", String.Empty);

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodePrint (BarcodeNo, BarcodeQty, MoSettingId, ParentBarcode, PrintCnt, PrintStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@BarcodeNo, @BarcodeQty, @MoSettingId, @ParentBarcode, @PrintCnt, @PrintStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeNo,
                                    BarcodeQty = 0,
                                    MoSettingId,
                                    ParentBarcode = "",
                                    PrintCnt = 0,
                                    PrintStatus = Status,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();

                            maxBarcodeNum++;
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMoItemPart -- 新增製令刻號 -- Ann 2022-10-21
        public string AddMoItemPart(int MoId, string MoItemPartPrefix, int Seq, string LetteringType, int MoItemPartSortNumberSerial, string MoItemPartSortNumberJump, string ParticularNo)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        MoItemPartPrefix = MoItemPartPrefix.Trim();
                        if (MoItemPartPrefix.Length <= 0) throw new SystemException("【刻字前綴】不能為空!");
                        if (Seq <= 0) throw new SystemException("【刻字流水碼長度】不能為空!");
                        if (LetteringType.Length <= 0) throw new SystemException("【刻字型態】不能為空!");
                        if (LetteringType == "1" && MoItemPartSortNumberSerial <= 0) throw new SystemException("【起始流水號】不能為空!");
                        if (LetteringType == "2" && MoItemPartSortNumberJump.Length <= 0) throw new SystemException("【流水號設定】不能為空!");

                        #region //判斷製令資料是否有誤
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 Quantity
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令資料有誤!");

                        int Quantity = -1;
                        foreach (var item in result)
                        {
                            Quantity = item.Quantity;
                        }
                        #endregion

                        #region //檢查此張製令沒有設定過刻字號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoItemPart
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("此張製令已設定過刻字號!");
                        #endregion

                        int rowsAffected = 0;
                        //連號
                        if (LetteringType == "1")
                        {
                            for (var i = 1; i <= Quantity; i++)
                            {
                                string MoItemPartNo = "";
                                if (MoItemPartPrefix.IndexOf('+') != -1)
                                {
                                    MoItemPartNo = MoItemPartPrefix.Split('+')[0] + ParticularNo + MoItemPartSortNumberSerial.ToString().PadLeft(Seq, '0') + MoItemPartPrefix.Split('+')[1];
                                }
                                else
                                {
                                    MoItemPartNo = MoItemPartPrefix + ParticularNo + MoItemPartSortNumberSerial.ToString().PadLeft(Seq, '0');
                                }

                                #region //判斷刻字號是否重複
                                //dynamicParameters = new DynamicParameters();
                                //sql = @"SELECT TOP 1 1
                                //        FROM MES.MoItemPart a
                                //        WHERE a.MoItemPartNo = @MoItemPartNo";
                                //dynamicParameters.Add("MoItemPartNo", MoItemPartNo);

                                //var result3 = sqlConnection.Query(sql, dynamicParameters);
                                //if (result3.Count() > 0) throw new SystemException("【刻字號】重複!");
                                #endregion

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MoItemPart (MoItemPartPrefix, MoItemPartSortNumber, MoItemPartNo, MoId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MoItemPartId
                                        VALUES (@MoItemPartPrefix, @MoItemPartSortNumber, @MoItemPartNo, @MoId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MoItemPartPrefix,
                                        MoItemPartSortNumber = MoItemPartSortNumberSerial,
                                        MoItemPartNo,
                                        MoId,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                MoItemPartSortNumberSerial++;
                            }
                        }
                        else //跳號
                        {
                            string[] partNoList = MoItemPartSortNumberJump.Split(',');
                            if (partNoList.Length != Quantity) throw new SystemException("刻號數量與製令生產量不相符!");
                            for (var i = 0; i < partNoList.Length; i++)
                            {
                                string MoItemPartNo = "";
                                if (MoItemPartPrefix.IndexOf('+') != -1)
                                {
                                    MoItemPartNo = MoItemPartPrefix.Split('+')[0] + ParticularNo + partNoList[i].PadLeft(Seq, '0') + MoItemPartPrefix.Split('+')[1];
                                }
                                else
                                {
                                    MoItemPartNo = MoItemPartPrefix + ParticularNo + partNoList[i].PadLeft(Seq, '0');
                                }

                                #region //判斷刻字號是否重複
                                //dynamicParameters = new DynamicParameters();
                                //sql = @"SELECT TOP 1 1
                                //        FROM MES.MoItemPart a
                                //        WHERE a.MoItemPartNo = @MoItemPartNo";
                                //dynamicParameters.Add("MoItemPartNo", MoItemPartNo);

                                //var result3 = sqlConnection.Query(sql, dynamicParameters);
                                //if (result3.Count() > 0) throw new SystemException("【刻字號】重複!");
                                #endregion

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MoItemPart (MoItemPartPrefix, MoItemPartSortNumber, MoItemPartNo, MoId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MoItemPartId
                                        VALUES (@MoItemPartPrefix, @MoItemPartSortNumber, @MoItemPartNo, @MoId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MoItemPartPrefix,
                                        MoItemPartSortNumber = partNoList[i],
                                        MoItemPartNo,
                                        MoId,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                            }
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMoProcess-- 新增製令製程資料 -- Ann 2022-11-07
        public string AddMoProcess(int MoId, string ProcessData)
        {
            try
            {
                AddUserOperateLog(MoId);
                if (ProcessData.Length <= 0) throw new SystemException("【製程】不能為空!");

                bool checkbool = false;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷製令資料是否正確
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.Status
                                , b.MpcId
                                FROM MES.ManufactureOrder a
                                LEFT JOIN MES.MoProcessChange b ON a.MoId = b.MoId
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.Status == "F" || item.Status == "W") throw new SystemException("製令已完工或入庫，無法更改!");
                            if (item.MpcId != null) throw new SystemException("此製令已有變更單紀錄，無法新增站別!");
                        }
                        #endregion

                        var ProcessJson = JObject.Parse(ProcessData);
                        int rowsAffected = 0;
                        foreach (var item in ProcessJson["processInfo"])
                        {
                            #region //判斷製程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ProcessName
                                    , b.ProcessCheckStatus, b.ProcessCheckType
                                    FROM MES.Process a
                                    INNER JOIN MES.ProcessParameter b ON a.ProcessId = b.ProcessId
                                    WHERE a.ProcessId = @ProcessId";
                            dynamicParameters.Add("ProcessId", item["ProcessId"].ToString());

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("製程資料錯誤或未設定製程參數!");

                            string ProcessCheckStatus = "";
                            string ProcessCheckType = "";
                            string ProcessName = "";
                            foreach (var item2 in result3)
                            {
                                ProcessCheckStatus = item2.ProcessCheckStatus;
                                ProcessCheckType = item2.ProcessCheckType;
                                ProcessName = item2.ProcessName;
                            }
                            #endregion

                            if (Convert.ToInt32(item["ProcessId"]) == 312) checkbool = true;

                            #region //取得最大排序數
                            int maxSortNumber = 0;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(MAX(SortNumber), 0) MaxSortNumber
                                    FROM MES.MoProcess
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in result4)
                            {
                                maxSortNumber = Convert.ToInt32(item2.MaxSortNumber) + 1;
                            }
                            #endregion

                            #region //檢查此製令製程名稱是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcess a
                                    WHERE a.MoId = @MoId
                                    AND a.ProcessAlias = @ProcessAlias";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("ProcessAlias", item["ProcessName"].ToString());

                            var result5 = sqlConnection.Query(sql, dynamicParameters);

                            string newProcessAlias = item["ProcessName"].ToString();
                            if (result5.Count() > 0)
                            {
                                int count = 1;
                                while (true)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.MoProcess a
                                            WHERE a.MoId = @MoId
                                            AND a.ProcessAlias = @ProcessAlias";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("ProcessAlias", item["ProcessName"].ToString() + count.ToString());

                                    var result6 = sqlConnection.Query(sql, dynamicParameters);

                                    if (result6.Count() <= 0)
                                    {
                                        newProcessAlias = item["ProcessName"].ToString() + count.ToString();
                                        break;
                                    }

                                    count++;
                                }
                            }
                            #endregion

                            #region //INSERT MES.MoProcess
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MoProcess (MoId, ProcessId, SortNumber, ProcessAlias
                                    , DisplayStatus, NecessityStatus, OspFlag, ProcessCheckStatus, ProcessCheckType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MoProcessId
                                    VALUES (@MoId, @ProcessId, @SortNumber, @ProcessAlias
                                    , @DisplayStatus, @NecessityStatus, @OspFlag, @ProcessCheckStatus, @ProcessCheckType
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoId,
                                    ProcessId = Convert.ToInt32(item["ProcessId"]),
                                    SortNumber = maxSortNumber,
                                    ProcessAlias = newProcessAlias,
                                    DisplayStatus = "Y",
                                    NecessityStatus = "Y",
                                    OspFlag = "N",
                                    ProcessCheckStatus,
                                    ProcessCheckType,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion

                            int MoProcessId = -1;
                            foreach (var item2 in insertResult)
                            {
                                MoProcessId = item2.MoProcessId;
                            }

                            #region //檢查是否有刻字站，若有則自動綁定刻字屬性
                            if (ProcessName == "刻字")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MoProcessItem (MoProcessId, ItemNo, ChkUnique
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MoProcessId
                                        VALUES (@MoProcessId, @ItemNo, @ChkUnique
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MoProcessId,
                                        ItemNo = "Lettering",
                                        ChkUnique = "Y",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                            }
                            #endregion

                            #region //確認是否有Barcode已完工未入庫，若有則更改下製程
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    NextMoProcessId = @MoProcessId,
                                    BarcodeStatus = '1',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoId = @MoId
                                    AND NextMoProcessId = -1 AND BarcodeStatus = '0'";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoProcessId,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

                if (checkbool == true)
                {
                    using (TransactionScope transactionScope = new TransactionScope())
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                        {
                            #region //取得目前製程順序
                            DynamicParameters dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoProcessId, a.SortNumber, a.ProcessId
                                    , (
                                      SELECT TOP 1 1
                                      FROM MES.BarcodeProcess b
                                      WHERE b.MoProcessId = a.MoProcessId
                                    ) BarcodeProcess
                                    FROM MES.MoProcess a
                                    WHERE a.MoId = @MoId
                                    ORDER BY a.SortNumber";
                            dynamicParameters.Add("MoId", MoId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //先將有過站紀錄過的最大排序找出來
                            int NewMaxSortNumber = 0;
                            foreach (var item2 in result)
                            {
                                if (item2.BarcodeProcess != null)
                                {
                                    if (NewMaxSortNumber < item2.SortNumber) NewMaxSortNumber = item2.SortNumber;
                                }
                            }
                            #endregion

                            #region //將最大排序後面的製程排序先改為-1
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoProcess SET
                                    SortNumber = SortNumber * -1,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoId = @MoId
                                    AND SortNumber > @NewMaxSortNumber";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoId,
                                    NewMaxSortNumber
                                });

                            int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            #region //先將最大排序後的製程順序全部+1
                            foreach (var item2 in result)
                            {
                                dynamicParameters = new DynamicParameters();
                                if (item2.SortNumber > NewMaxSortNumber)
                                {
                                    sql = @"UPDATE MES.MoProcess SET
                                            SortNumber = @SortNumber,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE MoProcessId = @MoProcessId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            SortNumber = item2.SortNumber + 1,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            item2.MoProcessId
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                }
                            }
                            #endregion
                            #endregion

                            #region //新增退鎳站
                            #region //檢查退鎳名稱是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcess a
                                    WHERE a.MoId = @MoId
                                    AND a.ProcessAlias = @ProcessAlias";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("ProcessAlias", "退鎳");

                            var result2 = sqlConnection.Query(sql, dynamicParameters);

                            string newProcessAlias = "退鎳";
                            if (result2.Count() > 0)
                            {
                                int count = 1;
                                while (true)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.MoProcess a
                                            WHERE a.MoId = @MoId
                                            AND a.ProcessAlias = @ProcessAlias";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("ProcessAlias", "退鎳" + count.ToString());

                                    var result3 = sqlConnection.Query(sql, dynamicParameters);

                                    if (result3.Count() <= 0)
                                    {
                                        newProcessAlias = "退鎳" + count.ToString();
                                        break;
                                    }

                                    count++;
                                }
                            }
                            #endregion

                            //若退鎳站被排到順序1
                            if (NewMaxSortNumber + 1 == 1)
                            {
                                NewMaxSortNumber = 1;
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MoProcess SET
                                        SortNumber = 1,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MoId = @MoId
                                        AND SortNumber = 2";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MoId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MoProcess (MoId, ProcessId, SortNumber, ProcessAlias
                                    , DisplayStatus, NecessityStatus, OspFlag, ProcessCheckStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MoId, @ProcessId, @SortNumber, @ProcessAlias
                                    , @DisplayStatus, @NecessityStatus, @OspFlag, @ProcessCheckStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoId,
                                    ProcessId = 313,
                                    SortNumber = NewMaxSortNumber + 1,
                                    ProcessAlias = newProcessAlias,
                                    DisplayStatus = "N",
                                    NecessityStatus = "N",
                                    OspFlag = "N",
                                    ProcessCheckStatus = "N",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion
                        }
                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMoProcessItem-- 新增製令製程屬性檔 -- Ann 2022-11-09
        public string AddMoProcessItem(int MoProcessId, string ItemNo, string ChkUnique)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (ChkUnique.Length <= 0) throw new SystemException("【是否檢核重複值】不能為空!");

                        #region //判斷製令製程資料是否正確
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MoId
                                FROM MES.MoProcess a
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                        int MoId = 0;
                        foreach (var item in result)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //判斷類別資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM BAS.Type a
                                WHERE a.TypeNo = @TypeNo
                                AND a.TypeSchema = 'RoutingProcessItem.ItemNo'";
                        dynamicParameters.Add("TypeNo", ItemNo);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() <= 0) throw new SystemException("類別資料錯誤!");
                        #endregion

                        #region //判斷 製令製程+項目 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcessItem
                                WHERE MoProcessId = @MoProcessId
                                AND ItemNo = @ItemNo";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        dynamicParameters.Add("ItemNo", ItemNo);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        if (result4.Count() > 0) throw new SystemException("【製令製程 + 項目】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MoProcessItem (MoProcessId, ItemNo, ChkUnique
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@MoProcessId, @ItemNo, @ChkUnique
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoProcessId,
                                ItemNo,
                                ChkUnique,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddTerminateOfMfg-- 製令條碼指定結案 -- Ann 2022-11-22
        public string AddTerminateOfMfg(string BarcodeData, string Remark)
        {
            try
            {
                if (BarcodeData.Length <= 0) throw new SystemException("【條碼】不能為空!");
                if (Remark.Length <= 0) throw new SystemException("【備註】不能為空!");
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int LogId = -1;

                        var barcodeList = BarcodeData.Split(',');
                        int rowsAffected = 0;

                        int count = 0;
                        foreach (var item in barcodeList)
                        {
                            count++;
                            dynamicParameters = new DynamicParameters();
                            string BarcodeNo = item;
                            sql = @"SELECT BarcodeId, BarcodeStatus ,MoId, BarcodeQty, CurrentProdStatus
                                      FROM MES.Barcode
                                     WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var BarcodeStatusResult = sqlConnection.Query(sql, dynamicParameters);
                            if (BarcodeStatusResult.Count() <= 0) throw new SystemException("條碼［" + BarcodeNo + "］不存在");
                            string BarcodeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeStatus;
                            int BarcodeId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeId);
                            int MoId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoId);
                            int BarcodeQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeQty);
                            if (BarcodeStatus != "1" && BarcodeStatus != "0") throw new SystemException("非生產中狀態不可強制結束");
                            string CurrentProdStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentProdStatus;
                            if (CurrentProdStatus == "RW" ) throw new SystemException("條碼【" + BarcodeNo + "】為不良品, 需完成返修流程, 目前不可強制結束!!!");
                            if (CurrentProdStatus == "SR") throw new SystemException("條碼【" + BarcodeNo + "】為不良品, 需完成單站返修流程, 目前不可強制結束!!!");
                            if (CurrentProdStatus == "AM") throw new SystemException("條碼【" + BarcodeNo + "】為不良品, 需完成重新量測程, 目前不可強制結束!!!");
                            if (CurrentProdStatus == "S") throw new SystemException("條碼【" + BarcodeNo + "】為報廢品, 目前不可強制結束!!!");
                            if (CurrentProdStatus == "F") throw new SystemException("條碼【" + BarcodeNo + "】為不良品, 需完成品異判定流程, 目前不可強制結束!!!");

                            #region //判斷條碼是否開工中
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a 
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE b.BarcodeNo = @BarcodeNo
                                    AND a.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (BarcodeProcessResult.Count() > 0) throw new SystemException("條碼【" + BarcodeNo + "】目前為開工狀態，無法強制結束!!");
                            #endregion

                            #region //檢查條碼是否在治具上未解除綁定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.JigNo
                                    , d.WoSeq
                                    , e.WoErpPrefix, e.WoErpNo
                                    FROM MES.JigBarcode a 
                                    INNER JOIN MES.Jig b ON a.JigId = b.JigId
                                    INNER JOIN MES.MoProcess c On a.MoProcessId = c.MoProcessId
                                    INNER JOIN MES.ManufactureOrder d ON c.MoId = d.MoId
                                    INNER JOIN MES.WipOrder e ON d.WoId = e.WoId
                                    WHERE a.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var JigResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in JigResult)
                            {
                                throw new SystemException("條碼【" + BarcodeNo + "】目前被綁定在製令【" + item2.WoErpPrefix + "-" + item2.WoErpNo  + "(" + item2.WoSeq + ")】!!");
                            }
                            #endregion

                            #region //檢查此張製令是否需要維護屬性
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ItemNo, a.MoProcessId
                                    , c.TypeName ItemName
                                    FROM MES.MoProcessItem a 
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    INNER JOIN BAS.[Type] c ON a.ItemNo = c.TypeNo AND c.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    WHERE b.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var MoProcessItemResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in MoProcessItemResult)
                            {
                                #region //檢查此條碼是否有維護屬性
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 
                                        (
                                            SELECT TOP 1 1
                                            FROM MES.BarcodeAttribute x 
                                            WHERE x.MoId = a.MoId
                                            ANd x.BarcodeId = a.BarcodeId
                                            AND x.ItemNo = @ItemNo
                                        ) BarcodeAttribute
                                        FROM MES.BarcodeProcess a 
                                        WHERE a.BarcodeId = @BarcodeId
                                        AND a.MoProcessId = @MoProcessId";
                                dynamicParameters.Add("BarcodeId", BarcodeId);
                                dynamicParameters.Add("ItemNo", item2.ItemNo);
                                dynamicParameters.Add("MoProcessId", item2.MoProcessId);

                                var BarcodeAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item3 in BarcodeAttributeResult)
                                {
                                    if (item3.BarcodeAttribute == null)
                                    {
                                        throw new SystemException("此條碼【" + BarcodeNo + "】尚未維護屬性【" + item2.ItemName + "】!!");
                                    }
                                }
                                #endregion
                            }
                            #endregion

                            #region //確認此條碼是否有被託外生產單註冊，但未開立託外入庫單
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 c.OspNo
                                    FROM MES.OspBarcode a 
                                    INNER JOIN MES.OspDetail b ON a.OspDetailId = b.OspDetailId
                                    INNER JOIN MES.OutsourcingProduction c ON b.OspId = c.OspId
                                    WHERE a.BarcodeNo = @BarcodeNo
                                    AND NOT EXISTS (
                                        SELECT TOP 1 1 
                                        FROM MES.OspReceiptBarcode x 
                                        WHERE x.OspBarcodeId = a.OspBarcodeId
                                    )
                                    AND c.CompanyId = @CompanyId";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var OspBarcodeCheckResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in OspBarcodeCheckResult)
                            {
                                throw new SystemException("條碼【" + BarcodeNo + "】已被註冊在託外生產單【" + item2.OspNo + "】且尚未註冊於託外入庫單，無法強制結束!!");
                            }
                            #endregion

                            #region //確認此條碼是否有被託外入庫單註冊，且狀態為未過站或未拋轉
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT c.ProcessStatus
                                    , d.OsrErpPrefix + '-' + d.OsrErpNo OsrErpFullNo
                                    , d.TransferStatus
                                    FROM MES.OspReceiptBarcode a 
                                    INNER JOIN MES.OspBarcode b ON a.OspBarcodeId = b.OspBarcodeId
                                    INNER JOIN MES.OspReceiptDetail c ON a.OsrDetailId = c.OsrDetailId
                                    INNER JOIN MES.OspReceipt d ON c.OsrId = d.OsrId
                                    WHERE b.BarcodeNo = @BarcodeNo ";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var OspReceiptBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in OspReceiptBarcodeResult)
                            {
                                if (item2.ProcessStatus != "Y")
                                {
                                    throw new SystemException("條碼【" + BarcodeNo + "】尚有託外入庫單【" + item2.OsrErpFullNo + "】未完成過站，無法強制結束!!");
                                }

                                if (item2.TransferStatus != "Y")
                                {
                                    throw new SystemException("條碼【" + BarcodeNo + "】尚有託外入庫單【" + item2.OsrErpFullNo + "】未拋轉，無法強制結束!!");
                                }
                            }
                            #endregion

                            #region //結束條碼流程
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode
                                       SET BarcodeStatus = '7',
                                           NextMoProcessId = -1,
                                           CurrentProdStatus = 'P',
                                           LastModifiedDate = @LastModifiedDate,
                                           LastModifiedBy = @LastModifiedBy
                                     WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeNo,
                                    LastModifiedDate,
                                    LastModifiedBy
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //更改製令狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.ManufactureOrder
                                       SET Status = 'A',
                                           LastModifiedDate = @LastModifiedDate,
                                           LastModifiedBy = @LastModifiedBy
                                     WHERE MoId = @MoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoId
                                });
                            insertResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //紀錄LOG
                            #region //INSERT MES.TerminateOfMoLog
                            if (count == 1)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.TerminateOfMoLog (MoId, Remark
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.LogId
                                        VALUES (@MoId, @Remark
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MoId,
                                        Remark,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                
                                foreach (var item2 in insertResult)
                                {
                                    LogId = item2.LogId;
                                }
                            }
                            #endregion

                            #region //INSERT MES.TOmBarcodeLog
                            if (LogId <= 0) throw new SystemException("LogId記錄錯誤!!");

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.TOmBarcodeLog (LogId, BarcodeId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.LogId
                                    VALUES (@LogId, @BarcodeId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LogId,
                                    BarcodeId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMoProcessChange-- 新增製令途程變更單單頭 -- Shintokuro 2022-10-27
        public string AddMoProcessChange(int MoId, int MpcUserId, string DocDate, string Remark)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;

                        #region //品異單單頭建立

                        #region //單號自動取號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(MpcNo))), '000'), 3)) + 1 CurrentNum
                                FROM MES.MoProcessChange
								WHERE MpcNo NOT LIKE '%[A-Za-z]%'";

                        int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                        string DocDateNo = CreateDate.ToString("yyyyMM");
                        string MpcNo = DocDateNo + string.Format("{0:000}", currentNum);
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MoProcessChange (CompanyId, MpcNo, MoId, MpcUserId, DocDate, Remark, Status
                                , CreateDate,LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MpcId,INSERTED.MpcNo,INSERTED.MpcUserId
                                VALUES (@CompanyId, @MpcNo, @MoId, @MpcUserId, @DocDate, @Remark, @Status
                                , @CreateDate,@LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                MpcNo,
                                MoId,
                                MpcUserId,
                                DocDate,
                                Remark,
                                Status = "S",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected += insertResult.Count();

                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMpcRoutingProcessAll-- 新增製令途程變更單綁定製程 -- Shintokuro 2022-10-31
        public string AddMpcRoutingProcessAll(int MpcId, int MoId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷製令途程變更單資料是否正確
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcessChange
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令途程變更單資料錯誤!");
                        #endregion

                        #region //判斷變更單是否有綁定條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MpcBarcodeId
                                FROM MES.MpcBarcode a
                                WHERE a.MpcId = @MpcId
                                ";
                        dynamicParameters.Add("MpcId", MpcId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("請先綁定條碼才能套用途層");
                        #endregion

                        #region //撈取製令下的製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoProcessId,a.MoId,a.SortNumber,a.ProcessAlias,a.RoutingItemProcessDesc,a.Remark,a.DisplayStatus,a.NecessityStatus
                                ,a.OspFlag,a.ProcessCheckStatus,a.ProcessCheckType
                                FROM MES.MoProcess a
                                WHERE a.MoId = @MoId
                                ";
                        dynamicParameters.Add("MoId", MoId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令ID有問題找不到資料");
                        #endregion

                        int rowsAffected = 0;
                        foreach (var item in result)
                        {
                            #region //判斷製程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcess
                                    WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", item.MoProcessId);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("製程資料錯誤!");
                            #endregion

                            #region //判斷製程是否有重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 ProcessAlias
                                    FROM MES.MpcRoutingProcess
                                    WHERE MoProcessId = @MoProcessId
                                    AND MpcId = @MpcId";
                            dynamicParameters.Add("MoProcessId", item.MoProcessId);
                            dynamicParameters.Add("MpcId", MpcId);

                            result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0)
                            {
                                string ProcessAlias = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessAlias;
                                throw new SystemException("【製程:" + ProcessAlias + "】重複，請重新選擇!");
                            }
                            #endregion

                            #region //新增SQL
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MpcRoutingProcess (MpcId, MoProcessId, SortNumber 
                                    , ProcessAlias, RoutingItemProcessDesc, Remark, DisplayStatus
                                    , NecessityStatus, OspFlag, ProcessCheckStatus, ProcessCheckType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MpcId, @MoProcessId, @SortNumber 
                                    , @ProcessAlias, @RoutingItemProcessDesc, @Remark, @DisplayStatus
                                    , @NecessityStatus, @OspFlag, @ProcessCheckStatus, @ProcessCheckType
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MpcId,
                                    MoProcessId = item.MoProcessId,
                                    SortNumber = item.SortNumber,
                                    ProcessAlias = item.ProcessAlias,
                                    RoutingItemProcessDesc = item.RoutingItemProcessDesc,
                                    Remark = item.Remark,
                                    DisplayStatus = item.DisplayStatus,
                                    NecessityStatus = item.NecessityStatus,
                                    OspFlag = item.OspFlag,
                                    ProcessCheckStatus = item.ProcessCheckStatus,
                                    ProcessCheckType = item.ProcessCheckType,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion

                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMpcBarcode-- 新增製令途程變更單綁定條碼 -- Shintokuro 2022-10-31
        public string AddMpcBarcode(int MpcId, string BarcodeIds)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (MpcId <= 0) throw new SystemException("【變更單ID】不能為空!");
                        if (BarcodeIds.Length <= 0) throw new SystemException("【條碼清單】不能為空!");
                        int rowsAffected = 0;

                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #region //判斷製令途程變更單資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MoId,SortChange
                                FROM MES.MoProcessChange
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令途程變更單資料錯誤!");
                        int MoId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoId;
                        string SortChange = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortChange;
                        if (SortChange != "K") throw new SystemException("變更單的途層已經更動了!不可以再新增條碼!如要新增條碼請先清除變更單途層");
                        #endregion


                        foreach (var BarcodeNo in BarcodeIds.Split(','))
                        {
                            #region //判斷條碼是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.ManufactureOrder a
                                    LEFT JOIN MES.MrDetail b on a.MoId = b.MoId
                                    LEFT JOIN MES.MrBarcodeRegister b1 on b.MrDetailId = b1.MrDetailId
                                    LEFT JOIN MES.MoSetting c on a.MoId =c.MoId
                                    LEFT JOIN MES.BarcodePrint c1 on c.MoSettingId =c1.MoSettingId
                                    WHERE b1.BarcodeNo = @BarcodeNo or c1.BarcodeNo = @BarcodeNo 
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("MoId", MoId);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("條碼資料錯誤!");
                            #endregion

                            #region //判斷條碼是否存在變更單中
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcessChange a
                                    INNER JOIN MES.MpcBarcode b on a.MpcId = b.MpcId
                                    WHERE b.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0) throw new SystemException("條碼【" + BarcodeNo + "】:已經有開立變更單了,條碼只能開一次變更單!!!");
                            #endregion

                            #region //判斷條碼是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MpcBarcode a
                                    WHERE a.BarcodeNo = @BarcodeNo
                                    AND a.MpcId = @MpcId";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("MpcId", MpcId);

                            result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0) throw new SystemException("【" + BarcodeNo + "】條碼重複了,不可以新增!");
                            #endregion

                            #region //新增SQL
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MpcBarcode (MpcId, BarcodeNo
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MpcId, @BarcodeNo
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MpcId,
                                    BarcodeNo,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion

                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBarcodeAttribute -- 新增屬性置換資料 -- Yi 2023-04-26
        public string AddBarcodeAttribute(int OriBarcodeAttrId, int NewBarcodeAttrId, string Remark)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (OriBarcodeAttrId < 0) throw new SystemException("【置換原始資料】不能為空!");
                        if (NewBarcodeAttrId < 0) throw new SystemException("【欲置換資料】不能為空!");

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷 OriBarcodeAttrId 刻號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId OriBarcodeId, a.ItemNo OriItemNo, a.ItemValue OriItemValue, a.ItemSeq OriItemSeq
                                , b.MoId OriMoId
                                FROM MES.BarcodeAttribute a
                                INNER JOIN MES.Barcode b ON b.BarcodeId = a.BarcodeId
                                WHERE a.BarcodeAttrId = @OriBarcodeAttrId";
                        dynamicParameters.Add("OriBarcodeAttrId", OriBarcodeAttrId);

                        var oriBarcodeAttrResult = sqlConnection.Query(sql, dynamicParameters);
                        if (oriBarcodeAttrResult.Count() <= 0) throw new SystemException("原始屬性資料錯誤!");

                        int oriMoId = -1;
                        int oriBarcodeId = -1;
                        string oriItemNo = "";
                        string oriItemValue = "";
                        int? oriItemSeq = -1;
                        foreach (var item in oriBarcodeAttrResult)
                        {
                            oriMoId = item.OriMoId;
                            oriBarcodeId = item.OriBarcodeId;
                            oriItemNo = item.OriItemNo;
                            oriItemValue = item.OriItemValue;
                            oriItemSeq = item.OriItemSeq;
                        }
                        #endregion

                        #region //判斷 NewBarcodeAttrId 刻號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId NewBarcodeId, a.ItemNo NewItemNo, a.ItemValue NewItemValue, a.ItemSeq NewItemSeq
                                , b.MoId NewMoId, b.BarcodeNo NewBarcodeNo
                                FROM MES.BarcodeAttribute a
                                INNER JOIN MES.Barcode b ON b.BarcodeId = a.BarcodeId
                                WHERE a.BarcodeAttrId = @NewBarcodeAttrId";
                        dynamicParameters.Add("NewBarcodeAttrId", NewBarcodeAttrId);

                        var newBarcodeAttrResult = sqlConnection.Query(sql, dynamicParameters);
                        if (newBarcodeAttrResult.Count() <= 0) throw new SystemException("欲置換屬性資料錯誤!");

                        int newMoId = -1;
                        int newBarcodeId = -1;
                        string newItemNo = "";
                        string newItemValue = "";
                        int? newItemSeq = -1;
                        string newBarcodeNo = "";
                        foreach (var item in newBarcodeAttrResult)
                        {
                            newMoId = item.NewMoId;
                            newBarcodeId = item.NewBarcodeId;
                            newItemNo = item.NewItemNo;
                            newItemValue = item.NewItemValue;
                            newItemSeq = item.NewItemSeq;
                            newBarcodeNo = item.NewBarcodeNo;
                        }
                        #endregion

                        #region //判斷製令及使用者公司別，防止系統取錯人
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                WHERE b.CompanyId = (
                                    SELECT zc.CompanyId
                                    FROM MES.Barcode za
                                    INNER JOIN MES.ManufactureOrder zb ON za.MoId = zb.MoId
                                    INNER JOIN MES.WipOrder zc ON zb.WoId = zc.WoId
                                    WHERE za.BarcodeId = @BarcodeId
                                )
                                AND a.MoId = @MoId";
                        dynamicParameters.Add("BarcodeId", oriBarcodeId);
                        dynamicParameters.Add("MoId", oriMoId);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (companyResult.Count() <= 0) throw new SystemException("製令與使用者所屬公司不符!");
                        #endregion

                        #region //確認是否有置換紀錄且尚未確認
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.OriBarcodeAttrId, a.NewBarcodeAttrId
                                , b.[Status]
                                , (
                                    SELECT TOP 1 1
                                    FROM MES.BarcodeProcess x 
                                    WHERE x.BarcodeId = @BarcodeId
                                    AND x.FinishDate IS NULL
                                ) CheckBarcodeProcess
                                FROM MES.BarcodeProcessAttributeLog a 
                                LEFT JOIN MES.BpalDetail b ON a.ProcessAttrLogId = b.ProcessAttrLogId
                                WHERE a.NewBarcodeId = @BarcodeId
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("BarcodeId", newBarcodeId);

                        var BarcodeProcessAtrLogResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in BarcodeProcessAtrLogResult)
                        {
                            if (item.OriBarcodeAttrId != item.NewBarcodeAttrId)
                            {
                                if (item.Status != "Y" && item.CheckBarcodeProcess == null)
                                {
                                    throw new SystemException("條碼【" + newBarcodeNo + "】已被置換，請實際執行重新刻字的動作後再進行後續動作!!");
                                }
                            }
                        }
                        #endregion

                        #region //Insert MES.BarcodeProcessAttributeLog 資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeProcessAttributeLog (OriBarcodeAttrId, NewBarcodeAttrId, OriBarcodeId, NewBarcodeId
                                , OriMoId, NewMoId, OriItemNo, NewItemNo, OriItemValue, NewItemValue, Remark
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.ProcessAttrLogId
                                VALUES (@OriBarcodeAttrId, @NewBarcodeAttrId, @OriBarcodeId, @NewBarcodeId
                                , @OriMoId, @NewMoId, @OriItemNo, @NewItemNo, @OriItemValue, @NewItemValue, @Remark
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                OriBarcodeAttrId,
                                NewBarcodeAttrId,
                                OriBarcodeId = oriBarcodeId,
                                NewBarcodeId = newBarcodeId,
                                OriMoId = oriMoId,
                                NewMoId = newMoId,
                                OriItemNo = oriItemNo,
                                NewItemNo = newItemNo,
                                OriItemValue = oriItemValue,
                                NewItemValue = newItemValue,
                                Remark,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();
                        #endregion

                        #region //更新 MES.BarcodeAttribute 舊資料之新的 BarcodeId
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeAttribute SET
                                ItemValue = @ItemValue,
                                ItemSeq = @ItemSeq,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeAttrId = @OriBarcodeAttrId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ItemValue = newItemValue,
                                ItemSeq = newItemSeq,
                                LastModifiedDate,
                                LastModifiedBy,
                                OriBarcodeAttrId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新 MES.BarcodeAttribute 新資料之舊的 BarcodeId
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeAttribute SET
                                ItemValue = @ItemValue,
                                ItemSeq = @ItemSeq,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeAttrId = @NewBarcodeAttrId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ItemValue = oriItemValue,
                                ItemSeq = oriItemSeq,
                                LastModifiedDate,
                                LastModifiedBy,
                                NewBarcodeAttrId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region // Add BarcodePrintBindItem --批量條碼綁定穴號 Barcode屬性新增 --Gpai 20230512
        public string BarcodePrintBindItem(string BarcodePrintIds, int ItemValue, int MoId)
        {
            try
            {
                int UserId = CreateBy;
                string[] BarcodePrintIdList = BarcodePrintIds.Split(',');
                List<string> BarcodePrintNoList = new List<string>();
                List<int> BarcodePrintQtyList = new List<int>();

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //ID轉NO AND 驗證是否存在
                        foreach (var PrintId in BarcodePrintIdList)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT *
                                FROM MES.BarcodePrint 
                                WHERE PrintId = @PrintId";
                            dynamicParameters.Add("PrintId", PrintId);

                            var result0 = sqlConnection.Query(sql, dynamicParameters);
                            if (result0.Count() > 0)
                            {
                                BarcodePrintNoList.Add(result0.First().BarcodeNo);
                            } //throw new SystemException("條碼資料錯誤!" + PrintId);
                        }

                        #endregion

                        #region //確認條碼是否為同製令
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.PrintId,a.BarcodeNo,b.MoSettingId,a.BarcodeQty,a.PrintStatus,b.MoId,b.LotStatus,b.LotQty,e.MtlItemNo ,(d.WoErpPrefix + '-' + d.WoErpNo)WoErpNo
                                FROM MES.BarcodePrint a
                                INNER JOIN MES.MoSetting b ON b.MoSettingId = a.MoSettingId
                                INNER JOIN MES.ManufactureOrder c ON c.MoId = b.MoId
                                INNER JOIN MES.WipOrder d ON d.WoId = c.WoId
                                INNER JOIN PDM.MtlItem e ON e.MtlItemId = d.MtlItemId
                                WHERE b.MoId = @MoId AND a.BarcodeNo IN @BarcodeNo";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("BarcodeNo", BarcodePrintNoList);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() != BarcodePrintNoList.Count) throw new SystemException("條碼資料錯誤!");
                        if (result.First().LotStatus != "Y") throw new SystemException("該條碼無法綁定穴號! (" + result.First().BarcodeNo + ")");
                        foreach (var item in result)
                        {
                            BarcodePrintQtyList.Add(item.BarcodeQty);

                        }
                        #endregion

                        #region //取得站別
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MoProcessId FROM MES.MoProcess WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        var moResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //新增
                        int rowsAffected = 0;
                        foreach (var Barcode in BarcodePrintNoList)
                        {

                            var index = BarcodePrintNoList.FindIndex(w => w == Barcode);
                            int Qty = BarcodePrintQtyList[index];
                            var inserBarcodeId = 0;

                            #region //取得BarcodeId
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT BarcodeId
                                    FROM MES.Barcode a
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", Barcode);

                            var resultBarcode = sqlConnection.Query(sql, dynamicParameters);
                            int BarcodeId = resultBarcode.First().BarcodeId;
                            inserBarcodeId = BarcodeId;
                            #endregion

                            #region //檢查MES.Barcode是否已經有這筆批量條碼(已開工)
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", Barcode);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0) throw new SystemException("批量條碼已開工，無法更新!");
                            #endregion

                            #region //檢查是否有在領料條碼中
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrBarcodeRegister a
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", Barcode);

                            var MrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);
                            if (MrBarcodeRegisterResult.Count() > 0) throw new SystemException("此條碼已被領料單綁定，無法更新!!");
                            #endregion

                            #region //確認條碼是否已綁定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId,b.BarcodeId,b.BarcodeNo
                                    FROM MES.BarcodeAttribute a
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE a.BarcodeId = @BarcodeId";
                            dynamicParameters.Add("BarcodeId", inserBarcodeId);

                            var attributeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (attributeResult.Count() >= 1) throw new SystemException("該條碼已綁定! (" + attributeResult.First().BarcodeNo + ")");
                            #endregion

                            #region //如果Barcode無資料，新增
                            if (resultBarcode.Count() <= 0)
                            {

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.Barcode (BarcodeNo, MoId, CurrentMoProcessId, NextMoProcessId, BarcodeQty, BarcodeProcessId, BarcodeStatus, CurrentProdStatus, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeId
                                VALUES (@BarcodeNo, @MoId, @CurrentMoProcessId, @NextMoProcessId, @BarcodeQty, @BarcodeProcessId, @BarcodeStatus, @CurrentProdStatus, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = Barcode,
                                        MoId,
                                        CurrentMoProcessId = moResult.First().MoProcessId,
                                        NextMoProcessId = moResult.First().MoProcessId,
                                        BarcodeQty = Qty,
                                        BarcodeProcessId = -1,
                                        BarcodeStatus = 1,
                                        CurrentProdStatus = "P",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });
                                var insertResult1 = sqlConnection.Query(sql, dynamicParameters);
                                int BarcodeBarcodeId = insertResult1.First().BarcodeId;
                                inserBarcodeId = BarcodeBarcodeId;
                            }
                            #endregion


                            #region //條碼屬性新增
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeAttribute (MoId, BarcodeId, ItemNo,ItemValue, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeAttrId
                                VALUES (@Moid, @BarcodeId, @ItemNo, @ItemValue, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoId,
                                    BarcodeId = inserBarcodeId,
                                    ItemNo = "Cavity",
                                    ItemValue,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });
                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult2.Count();
                            #endregion

                        }
                        #endregion


                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //AddDepSecondmentRecord-- 新增部門借調記錄 -- WuTC 2024-03-18
        public string AddDepSecondmentRecord(int UserId, int DepartmentId, string StartDate, string EndDate, string Remark)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //查詢同時段內有相同員工借調記錄(開始時間)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId, [Status], StartDate, EndDate
                                    FROM MES.DepartmentalSecondment
                                    WHERE UserId = @UserId AND [Status] = 'A' AND @StartDate between StartDate and EndDate";
                        dynamicParameters.Add("UserId", UserId);
                        dynamicParameters.Add("StartDate", StartDate);
                        dynamicParameters.Add("EndDate", EndDate);

                        var checkRecordresultstartdate = sqlConnection.Query(sql, dynamicParameters);
                        if (checkRecordresultstartdate.Count() > 0) throw new SystemException("同時段(開始時間)已存在該員工的借調記錄!");
                        #endregion
                        #region //查詢同時段內有相同員工借調記錄(結束時間)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId, [Status], StartDate, EndDate
                                    FROM MES.DepartmentalSecondment
                                    WHERE UserId = @UserId AND [Status] = 'A' AND @EndDate between StartDate and EndDate";
                        dynamicParameters.Add("UserId", UserId);
                        dynamicParameters.Add("StartDate", StartDate);
                        dynamicParameters.Add("EndDate", EndDate);

                        var checkRecordresultenddate = sqlConnection.Query(sql, dynamicParameters);
                        if (checkRecordresultenddate.Count() > 0) throw new SystemException("同時段(結束時間)已存在該員工的借調記錄!");
                        #endregion

                        #region //新增SQL
                        dynamicParameters = new DynamicParameters();

                        sql = @"INSERT INTO MES.DepartmentalSecondment(UserId, DepartmentId, StartDate, EndDate, [Status], Remark
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.DsId
                                VALUES (@UserId, @DepartmentId, @StartDate, @EndDate, 'A', @Remark
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                UserId,
                                DepartmentId,
                                StartDate,
                                EndDate,
                                Remark,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();
                        #endregion


                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddOspList -- 新增委外預排製程 -- Ann 2025-06-06
        public string AddOspList(List<OspListData> UploadJson, string TransferFlag)
        {
            try
            {
                if (UploadJson.Count() <= 0) throw new SystemException("上傳檔案內容為空，請嘗試重新操作!!");
                int rowsAffected = 0;
                string format = "yyyy-MM-dd";
                DateTime parsedDate;
                bool isValid = false;
                List<OspListData> ospLists = UploadJson;
                string CompanyNo = "";
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyNo, a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            CompanyNo = item.CompanyNo;
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            foreach (var item in UploadJson)
                            {
                                #region //Data Valid
                                #region //確認製令資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoId  
                                        , b.WoStatus
                                        , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                                        FROM MES.ManufactureOrder a 
                                        INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                        INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                        WHERE b.WoErpPrefix + '-' + b.WoErpNo +  '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')' = @WoErpFullNo
                                        AND b.CompanyId = @CompanyId";
                                dynamicParameters.Add("WoErpFullNo", item.WoErpFullNo);
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                                if (ManufactureOrderResult.Count() <= 0) throw new SystemException($"製令【{item.WoErpFullNo}】資料錯誤!!");

                                int MoId = -1;
                                foreach (var item2 in ManufactureOrderResult)
                                {
                                    if (item2.WoStatus == "Y" || item2.WoStatus == "y")
                                    {
                                        throw new SystemException($"製令【{item.WoErpFullNo}】狀態錯誤!!");
                                    }

                                    MoId = item2.MoId;
                                    item.MtlItemNo = item2.MtlItemNo;
                                    item.MtlItemName = item2.MtlItemName;
                                    item.MtlItemSpec = item2.MtlItemSpec;
                                }
                                #endregion

                                #region //確認製令製程資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoProcessId
                                        , c.Quantity
                                        FROM MES.MoProcess a 
                                        INNER JOIN MES.Process b ON a.ProcessId = b.ProcessId
                                        INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                        WHERE a.MoId = @MoId 
                                        AND a.ProcessAlias = @ProcessAlias 
                                        AND b.ProcessNo = @ProcessNo";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("ProcessAlias", item.ProcessAlias);
                                dynamicParameters.Add("ProcessNo", item.ProcessNo);

                                var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MoProcessResult.Count() <= 0) throw new SystemException($"製令【{item.WoErpFullNo}】<br>查無製程【{item.ProcessNo}-{item.ProcessAlias}】!!");

                                foreach (var item2 in MoProcessResult)
                                {
                                    item.MoProcessId = item2.MoProcessId;

                                    if (item.Quantity <= 0)
                                    {
                                        throw new SystemException($"製令【{item.WoErpFullNo}】數量不可為0或負數!!");
                                    }
                                    else if (item2.Quantity < item.Quantity)
                                    {
                                        throw new SystemException($"製令【{item.WoErpFullNo}】此次委外數量已超過製令預計生產數量({item2.Quantity})!!");
                                    }
                                }
                                #endregion

                                #region //確認委託部門
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.DepartmentId, a.DepartmentName
                                        FROM BAS.Department a 
                                        WHERE a.DepartmentNo = @DepartmentNo
                                        AND a.CompanyId = @CompanyId";
                                dynamicParameters.Add("DepartmentNo", item.DepartmentNo);
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var DepartmentResult = sqlConnection.Query(sql, dynamicParameters);

                                if (DepartmentResult.Count() <= 0) throw new SystemException($"製令【{item.WoErpFullNo}】<br>部門資料【{item.DepartmentNo}】錯誤!!");

                                item.DepartmentId = DepartmentResult.FirstOrDefault().DepartmentId;
                                item.DepartmentName = DepartmentResult.FirstOrDefault().DepartmentName;
                                #endregion

                                #region //確認委外日期格式
                                isValid = DateTime.TryParseExact(
                                    item.OspDate,
                                    format,
                                    CultureInfo.InvariantCulture,
                                    DateTimeStyles.None,
                                    out parsedDate
                                );

                                if (!isValid)
                                {
                                    throw new SystemException($"製令【{item.WoErpFullNo}】<br>委外日期格式【{item.OspDate}】錯誤!!");
                                }
                                #endregion

                                #region //確認供應商資料
                                if (!string.IsNullOrEmpty(item.SupplierNo))
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.SupplierId
                                            FROM SCM.Supplier a 
                                            WHERE a.SupplierNo = @SupplierNo
                                            AND a.CompanyId = @CompanyId";
                                    dynamicParameters.Add("SupplierNo", item.SupplierNo);
                                    dynamicParameters.Add("CompanyId", CurrentCompany);

                                    var SupplierResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (SupplierResult.Count() <= 0) throw new SystemException($"製令【{item.WoErpFullNo}】<br>查無供應商資料【{item.SupplierNo}】!!");

                                    item.SupplierId = SupplierResult.FirstOrDefault().SupplierId;
                                }
                                #endregion

                                #region //確認製程代碼
                                if (!string.IsNullOrEmpty(item.SupplierNo) && !string.IsNullOrEmpty(item.ProcessCode))
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT LTRIM(RTRIM(MW002)) ProcessCodeName
                                            FROM CMSMW a
                                            WHERE a.MW005 = @SupplierNo
                                            AND a.MW001 = @ProcessCode";
                                    dynamicParameters.Add("SupplierNo", item.SupplierNo);
                                    dynamicParameters.Add("ProcessCode", item.ProcessCode);

                                    var CMSMWResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (CMSMWResult.Count() <= 0) throw new SystemException($"製令【{item.WoErpFullNo}】<br>製程代碼【{item.ProcessCode}】錯誤!!");

                                    item.ProcessCodeName = CMSMWResult.FirstOrDefault().ProcessCodeName;
                                }
                                #endregion

                                #region //確認日期格式
                                isValid = DateTime.TryParseExact(
                                    item.ExpectedDate,
                                    format,
                                    CultureInfo.InvariantCulture,
                                    DateTimeStyles.None,
                                    out parsedDate
                                );

                                if (!isValid)
                                {
                                    throw new SystemException($"製令【{item.WoErpFullNo}】<br>回廠日期格式【{item.ExpectedDate}】錯誤!!");
                                }
                                #endregion

                                #region //是否支援工程檢格式
                                if (item.ProcessCheckStatus != "Y" && item.ProcessCheckStatus != "N")
                                {
                                    throw new SystemException($"製令【{item.WoErpFullNo}】<br>是否支援工程檢格式【{item.ProcessCheckStatus}】錯誤!!");
                                }
                                #endregion

                                #region //確認是否有相同製令製程的單據且未拋轉
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.OspList a 
                                        WHERE a.MoProcessId = @MoProcessId
                                        AND a.[Status] = 'N'";
                                dynamicParameters.Add("MoProcessId", item.MoProcessId);

                                var CheckOspListResult = sqlConnection.Query(sql, dynamicParameters);

                                if (CheckOspListResult.Count() > 0) throw new SystemException($"製令【{item.WoErpFullNo}】已有相同製令製程的單據且未拋轉!!");
                                #endregion
                                #endregion

                                #region //Insert OspList
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.OspList (DepartmentId, MoProcessId, OspDate, SupplierId, Quantity
                                        , ProcessCode, ProcessCodeName, ExpectedDate, ProcessCheckStatus, ProcessCheckType
                                        , Remark, Status
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@DepartmentId, @MoProcessId, @OspDate, @SupplierId, @Quantity
                                        , @ProcessCode, @ProcessCodeName, @ExpectedDate, @ProcessCheckStatus, @ProcessCheckType
                                        , @Remark, @Status
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        item.DepartmentId,
                                        item.MoProcessId,
                                        item.OspDate,
                                        item.SupplierId,
                                        item.Quantity,
                                        item.ProcessCode,
                                        item.ProcessCodeName,
                                        item.ExpectedDate,
                                        item.ProcessCheckStatus,
                                        ProcessCheckType = "2",
                                        item.Remark,
                                        Status = TransferFlag,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }

                            #region //依據群組分類
                            var groupOspList = UploadJson.GroupBy(x => new { x.DepartmentId });
                            #endregion

                            #region //通知採購單位
                            string Content = "";
                            foreach (var group in groupOspList)
                            {
                                string ospListMenuMamo = "| 製令 | 品號 | 品名 | 規格 | 製令製程 | 委託部門 | 數量 | 委託日期 |\n| :-- | :-- | :-- | :-- | :-- | :-- | :-- |\n";
                                string ospListMenuEmail = "";
                                string ospListContent = "";

                                #region //資料載入
                                foreach (var item in group)
                                {
                                    ospListMenuMamo += $"| {item.WoErpFullNo} | {item.MtlItemNo} | {item.MtlItemName} | {item.MtlItemSpec} | {item.ProcessAlias} | {item.DepartmentName} | {item.Quantity} | {item.OspDate}\n";
                                    ospListContent += $@"
                                                        <tr>
                                                            <td>{item.WoErpFullNo}</td>
                                                            <td>{item.MtlItemNo}</td>
                                                            <td>{item.MtlItemName}</td>
                                                            <td>{item.MtlItemSpec}</td>
                                                            <td>{item.ProcessAlias}</td>
                                                            <td>{item.DepartmentName}</td>
                                                            <td>{item.Quantity}</td>
                                                            <td>{item.OspDate}</td>
                                                        </tr>";
                                }

                                ospListMenuEmail += $@"<html>
                                                        <body>
                                                            <h2>中揚光電-企業管理平台 委外預排製程通知</h2>
                                                            <p>系統日期：{DateTime.Now.ToString("yyyy-MM-dd HH:mm")}</p>
                                                            <p>委外預排製程列表如下：</p>
                                                            <table border='1' cellpadding='8' cellspacing='0' style='border-collapse: collapse; font-family: Arial, sans-serif;'>
                                                                <thead style='background-color: #f0f0f0;'>
                                                                    <tr>
                                                                        <th>製令</th>
                                                                        <th>品號</th>
                                                                        <th>品名</th>
                                                                        <th>規格</th>
                                                                        <th>製令製程</th>
                                                                        <th>委託部門</th>
                                                                        <th>數量</th>
                                                                        <th>委託日期</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {ospListContent}
                                                                </tbody>
                                                            </table>
                                                            <br>
                                                            <p style='color: #666; font-size: 12px;'>
                                                                本通訊及其所有附件所含之資訊均屬機密，僅供指定之收件人使用...
                                                            </p>
                                                        </body>
                                                      </html>";
                                #endregion

                                #region //MAMO
                                Content = "### 【委外預排製程通知】\n" +
                                            "- 系統日期:" + DateTime.Now.ToString("yyyy-MM-dd HH:mm") + "\n" +
                                            "- 單據列表:\n" + ospListMenuMamo + "\n" +
                                            "- 系統連結如下:\n" +
                                            "https://bm.zy-tech.com.tw/Production/OspListManagement" + "\n";

                                #region //確認推播群組
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.ChannelId
                                        FROM MES.OspListMamoChannel a
                                        WHERE a.OspMamoNo = @OspMamoNo";
                                dynamicParameters.Add("OspMamoNo", "JC_PO");

                                var QcMamoChannelResult = sqlConnection.Query(sql, dynamicParameters);

                                if (QcMamoChannelResult.Count() <= 0) throw new SystemException("採購部門尚未建立MAMO群組!!");

                                int ChannelId = -1;
                                foreach (var item in QcMamoChannelResult)
                                {
                                    ChannelId = item.ChannelId;
                                }
                                #endregion

                                List<string> Tags = new List<string>();
                                List<int> Files = new List<int>();

                                string MamoResult = mamoHelper.SendMessage(CompanyNo, CurrentUser, "Channel", ChannelId.ToString(), Content, Tags, Files);

                                JObject MamoResultJson = JObject.Parse(MamoResult);
                                if (MamoResultJson["status"].ToString() != "success")
                                {
                                    throw new SystemException(MamoResultJson["msg"].ToString());
                                }
                                #endregion

                                #region //Email
                                #region //取得要寄送的人員信箱
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(STRING_AGG(b.UserNo + ':' + b.Email, ';'), '') AS CombinedUsers
                                        FROM MAMO.ChannelMembers a 
                                        INNER JOIN BAS.[User] b ON a.UserId = b.UserId
                                        WHERE a.ChannelId = @ChannelId
                                        AND b.Email IS NOT NULL AND b.Email != '' AND b.[Status] = 'A'";
                                dynamicParameters.Add("ChannelId", ChannelId);

                                var ChannelMembersResult = sqlConnection.Query(sql, dynamicParameters);

                                string Email = "";
                                foreach (var item in ChannelMembersResult)
                                {
                                    Email = item.CombinedUsers;
                                }
                                #endregion

                                if (Email != null && Email.Length > 0)
                                {
                                    #region //設定寄送格式
                                    string mailSubject = "【中揚光電-企業管理平台】";
                                    string mailContent = ospListMenuEmail;
                                    #endregion

                                    #region //寄送Mail
                                    MailConfig mailConfig = new MailConfig
                                    {
                                        Host = "192.168.20.252",
                                        Port = 25,
                                        SendMode = 0,
                                        From = "企業管理平台:jmo-service@zy-tech.com.tw",
                                        Subject = mailSubject,
                                        Account = "jmo-service",
                                        Password = "asdf!QAZ",
                                        MailTo = Email,
                                        MailCc = "",
                                        MailBcc = "",
                                        HtmlBody = mailContent,
                                        TextBody = "-"
                                    };
                                    BaseHelper.MailSend(mailConfig);
                                    #endregion
                                }
                                #endregion
                            }
                            #endregion

                            if (TransferFlag == "Y")
                            {
                                JObject transferResult = JObject.Parse(TransferOspList(UploadJson, CompanyNo, sqlConnection, sqlConnection2));
                                if (transferResult["status"].ToString() != "success")
                                {
                                    throw new SystemException(transferResult["msg"].ToString());
                                }
                                else
                                {
                                    jsonResponse = transferResult;
                                }
                            }
                            else
                            {
                                #region //Response
                                jsonResponse = JObject.FromObject(new
                                {
                                    status = "success",
                                    msg = "(" + rowsAffected + " rows affected)"
                                });
                                #endregion
                            }
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //Update
        #region //UpdateWipOrder -- 工單單頭資料更新 -- Ted 2022.08.08
        public string UpdateWipOrder(int WoId, string DocDate, int MtlItemId, int? SoDetailId, int UomId, int InventoryId, int PlanQty
            , string ExpectedStart, string ExpectedEnd, string WoRemark, string Project
            , string Property, string ProductionLine, string Processor, string CurrencyCode, double Exchange
            , string TaxCode, string TaxType, string TaxRate, string PricingTerm, string PaymentTerm
            , int ViewCompanyId)
        {
            try
            {
                int? nullDate = null;

                if (DocDate.Length <= 0) throw new SystemException("【單據日期】不能為空!");
                if (ExpectedStart.Length <= 0) throw new SystemException("【預計開工日期】不能為空!");
                if (ExpectedEnd.Length <= 0) throw new SystemException("【預計完工日期】不能為空!");
                if (MtlItemId <= 0) throw new SystemException("【產品品號】不能為空!");
                if (InventoryId <= 0) throw new SystemException("【入庫庫別】不能為空!");

                if (Exchange <= 0) throw new SystemException("【匯率】不能為空!");
                if (SoDetailId <= 0) { SoDetailId = nullDate; };
                DateTime date1 = DateTime.Parse(ExpectedStart);
                DateTime date2 = DateTime.Parse(ExpectedEnd);
                if (date2 < date1) throw new SystemException("【預計完工日期】不可以小於【預計開工日期】");



                string ErpDbName = "";
                string ErpNo = "";
                string WoErpPrefix = "";
                string WoErpNo = "";
                string MtlItemNo = "";
                string ActualStart = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();
                        int rowsAffected = 0;

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷工單單頭資料是否正確
                        sql = @"SELECT TOP 1 WoErpPrefix, WoErpNo, ConfirmStatus, WoStatus, TransferStatus
                                FROM MES.WipOrder
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("工單單頭資料錯誤!");
                        WoErpPrefix = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoErpPrefix;
                        WoErpNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoErpNo;
                        var ConfirmStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ConfirmStatus;
                        var WoStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoStatus;
                        var TransferStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TransferStatus;
                        if (ConfirmStatus == "Y") throw new SystemException("工單已經確認無法修改!");
                        if (ViewCompanyId == 2 && WoErpPrefix != "5301")
                        {
                            if (WoStatus == "3") throw new SystemException("製令單別為5301其製令狀態必須為生產中!!");
                            if (PlanQty <= 0) throw new SystemException("【預計產量】須大於零!");
                            ActualStart = ExpectedStart;
                        }
                        else
                        {
                            if (WoStatus != "1") throw new SystemException("工單已經開工無法修改!");
                            if (PlanQty < 0) throw new SystemException("【預計產量】不能為負數!");
                            ActualStart = null;
                        }
                        #endregion

                        #region //判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemId ,a.MtlItemNo
                                FROM PDM.MtlItem a
                                WHERE a.MtlItemId =@MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【工單單頭更新】－該品號在MES不存在或是未拋轉，請重新確認");
                        foreach (var item in result)
                        {
                            MtlItemNo = item.MtlItemNo;
                        }

                        #endregion

                        #region //判斷庫別是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT InventoryId
                                FROM SCM.Inventory
                                WHERE InventoryId = @InventoryId
                                AND CompanyId = @CompanyId";
                        dynamicParameters.Add("InventoryId", InventoryId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("庫別不存在");
                        #endregion

                        #region //判斷單位資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 UomId
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @UomId";
                        dynamicParameters.Add("UomId", UomId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("單位資料錯誤或不存在!");
                        #endregion

                        #region //判斷訂單是否相同品號
                        if (SoDetailId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MtlItemId
                                FROM  SCM.SoDetail
                                WHERE SoDetailId = @SoDetailId";
                            dynamicParameters.Add("SoDetailId", SoDetailId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("訂單不存在");
                            int SoMtlItemId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MtlItemId;
                            if (SoMtlItemId != MtlItemId) throw new SystemException("訂單品號與產品品號不同，不可以綁定!!!!!");
                        }

                        #endregion

                        #region //比對MES產品品號跟原本是否一樣
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId
                                        FROM MES.WipOrder
                                        WHERE WoId =@WoId
                                        AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("WoId", WoId);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            //單頭品號修改其工單單身刪除
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.WoDetail
                                WHERE WoId = @WoId";
                            dynamicParameters.Add("WoId", WoId);
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }

                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.WipOrder SET
                                DocDate = @DocDate,
                                MtlItemId = @MtlItemId,
                                SoDetailId = @SoDetailId,
                                UomId = @UomId,
                                InventoryId = @InventoryId,
                                PlanQty = @PlanQty,
                                ExpectedStart = @ExpectedStart,
                                ExpectedEnd = @ExpectedEnd,
                                ActualStart = @ActualStart,
                                WoRemark = @WoRemark,
                                Project = @Project,
                                Property = @Property,
                                ProductionLine = @ProductionLine,
                                Processor = @Processor,
                                CurrencyCode = @CurrencyCode,
                                Exchange = @Exchange,
                                TaxCode = @TaxCode,
                                TaxType = @TaxType,
                                TaxRate = @TaxRate,
                                PricingTerm = @PricingTerm,
                                PaymentTerm = @PaymentTerm,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE WoId = @WoId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                DocDate,
                                MtlItemId,
                                SoDetailId,
                                UomId,
                                InventoryId,
                                PlanQty,
                                ExpectedStart,
                                ExpectedEnd,
                                ActualStart,
                                WoRemark,
                                Project,
                                Property,
                                ProductionLine,
                                Processor,
                                CurrencyCode,
                                Exchange,
                                TaxCode,
                                TaxType,
                                TaxRate,
                                PricingTerm,
                                PaymentTerm,
                                LastModifiedDate,
                                LastModifiedBy,
                                WoId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //審核ERP權限
                        var USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI02", "UPDATE");
                        #endregion

                        #region //ERP判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                FROM INVMB a
                                WHERE MB001 = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);

                        var invmbResult = sqlConnection.Query(sql, dynamicParameters);
                        if (invmbResult.Count() <= 0) throw new SystemException("【工單單頭更新】－【" + MtlItemNo + "】該品號在ERP不存在，請確認品號是否有拋轉");
                        #endregion

                        #region //ERP判斷縣別是否存在
                        if (ProductionLine.Length > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MD001)) ProduceLineNo, LTRIM(RTRIM(MD002)) ProduceLineName
                                    FROM CMSMD
                                    LEFT JOIN CMSMB ON MB001=MD003
                                    WHERE 1=1
                                    AND MD001 = @ProductionLine";
                            dynamicParameters.Add("ProductionLine", ProductionLine);

                            invmbResult = sqlConnection.Query(sql, dynamicParameters);
                            if (invmbResult.Count() <= 0) throw new SystemException("【工單單頭更新】－【" + ProductionLine + "】該縣別在ERP不存在，請重新確認資料");

                        }
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateWoDetail -- 工單單身資料更新 -- Ted 2022.08.08
        public string UpdateWoDetail(int WoId, int WoDetailId, int MtlItemId, int InventoryId, int UomId, double DemandRequisitionQty
            , string SubstituteStatus, string ExpectedRequisitionDate, string WipDetailRemark, string MaterialProperties)
        {
            try
            {
                if (WoId <= 0) throw new SystemException("【工單單頭】不能為空!");
                if (WoDetailId <= 0) throw new SystemException("【工單單身】不能為空!");
                if (MtlItemId <= 0) throw new SystemException("【品號】不能為空!");
                if (InventoryId <= 0) throw new SystemException("【庫別】不能為空!");
                if (UomId <= 0) throw new SystemException("【單位】不能為空!");
                if (DemandRequisitionQty <= 0) throw new SystemException("【需領用量】不能為空!");
                if (SubstituteStatus.Length <= 0) throw new SystemException("【是否替代料】不能為空!");
                if (WipDetailRemark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                if (MaterialProperties.Length <= 0) throw new SystemException("【材料型態】不能為空!");

                string ErpDbName = "";
                string ErpNo = "";
                string MtlItemNo = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷單頭是否存在 + 撈取單頭產品品號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId as woIdMtlItemId
                                FROM MES.WipOrder
                                WHERE WoId =@WoId";
                        dynamicParameters.Add("WoId", WoId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES工單單頭有問題!");
                        int woIdMtlItemId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).woIdMtlItemId;
                        #endregion

                        #region //判斷MES單身資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.WoDetail
                                WHERE WoDetailId = @WoDetailId";
                        dynamicParameters.Add("WoDetailId", WoDetailId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES單身資料錯誤!");
                        #endregion

                        #region //查詢品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemNo
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId
                                AND TransferStatus = 'Y'";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【工單單頭更新】－ 該品號在MES不存在或是未拋轉，請重新確認");
                        foreach (var item in result)
                        {
                            MtlItemNo = item.MtlItemNo;
                        }
                        #endregion

                        #region //判斷庫別是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT InventoryId
                                FROM SCM.Inventory
                                WHERE InventoryId = @InventoryId
                                AND CompanyId = @CompanyId";
                        dynamicParameters.Add("InventoryId", InventoryId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("庫別不存在");
                        #endregion

                        #region //判斷單位資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 UomId
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @UomId";
                        dynamicParameters.Add("UomId", UomId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("單位資料錯誤或不存在!");
                        #endregion

                        #region //查詢是否有套用過相同品號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId, InventoryId
                            FROM MES.WoDetail
                            WHERE WoId =@WoId
                            AND MtlItemId = @MtlItemId
                            AND WoDetailId != @WoDetailId";
                        dynamicParameters.Add("WoId", WoId);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("WoDetailId", WoDetailId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("已經有相同庫別的BOM資料了!");
                        #endregion

                        #region //查詢是否是替代料
                        dynamicParameters = new DynamicParameters();
                        if (SubstituteStatus == "Y")
                        {
                            sql = @"SELECT TOP 1 a.MtlItemId SubstituteMtlItemId,a.Quantity,a.Remark MtlItemRemark, ROW_NUMBER() OVER(ORDER BY a.SortNumber) seq 
                                    ,a1.MtlItemNo,a1.MtlItemName,a1.MtlItemSpec,a1.InventoryId,a1.InventoryUomId
                                    ,b.MtlItemId BomDetailMtlItemId
                                    ,c.MtlItemId
                                    FROM PDM.BomSubstitution a
                                    INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                    INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                    INNER JOIN PDM.MtlItem b1 on b.MtlItemId = b1.MtlItemId
                                    INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                    INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
                                    WHERE 1=1 
                                    AND a.SubstituteStatus = '3' 
                                    AND (a.EffectiveDate <= FORMAT(GETDATE(), 'yyyyMMdd') OR a.EffectiveDate = '' OR a.EffectiveDate is NULL) 
                                    AND (a.ExpirationDate >= FORMAT(GETDATE(), 'yyyyMMdd') OR a.ExpirationDate = '' OR a.ExpirationDate is NULL)
                                    AND c1.MtlItemId = @woIdMtlItemId
                                    Order By seq";
                            dynamicParameters.Add("woIdMtlItemId", woIdMtlItemId);
                            var bomSubstitutionData = sqlConnection.Query(sql, dynamicParameters);
                            if (bomSubstitutionData.Count() <= 0) throw new SystemException("該產品無替代料!替代料設定狀態錯誤!");
                            int bomSubstitutionMtlItemId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SubstituteMtlItemId;

                            if (bomSubstitutionMtlItemId != MtlItemId) throw new SystemException("該材料品號非該產品替代料!替代料設定狀態錯誤!");
                        }
                        #endregion

                        

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.WoDetail SET
                                MtlItemId = @MtlItemId, 
                                InventoryId = @InventoryId, 
                                UomId = @UomId, 
                                DemandRequisitionQty = @DemandRequisitionQty, 
                                SubstituteStatus = @SubstituteStatus, 
                                ExpectedRequisitionDate = @ExpectedRequisitionDate, 
                                MaterialProperties = @MaterialProperties, 
                                WipDetailRemark = @WipDetailRemark, 
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE WoId = @WoId
                                AND WoDetailId = @WoDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MtlItemId,
                                InventoryId,
                                UomId,
                                DemandRequisitionQty,
                                SubstituteStatus,
                                ExpectedRequisitionDate,
                                MaterialProperties,
                                WipDetailRemark,
                                LastModifiedDate,
                                LastModifiedBy,
                                WoId,
                                WoDetailId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //ERP判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                FROM INVMB a
                                WHERE MB001 = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);

                        var invmbResult = sqlConnection.Query(sql, dynamicParameters);
                        if (invmbResult.Count() <= 0) throw new SystemException("【工單單身更新】－【" + MtlItemNo + "】該品號在ERP不存在，請確認品號是否有拋轉");
                        #endregion
                    }
                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateWoDetailChangeSubstitution -- 工單單身替代料替換 -- Shintokuro 2023.10.02
        public string UpdateWoDetailChangeSubstitution(int WoDetailId, int SubstitutionId)
        {
            try
            {
                //int test99 = 99;
                //if (test99 == 99) throw new SystemException("改版中~~~敬啟期待上線~(≧∇≦)b");
                if (WoDetailId <= 0) throw new SystemException("【工單元件】不能為空!");
                if (WoDetailId <= 0) throw new SystemException("【工單元件】不能為空!");
                if (SubstitutionId <= 0) throw new SystemException("【替代料】不能為空!");


                string ErpDbName = "";
                string ErpNo = "";
                string MtlItemNo = "";
                int WoId = -1;
                double DemandRequisitionQty = -1;
                int SubstituteMtlItemId = -1;//被取代
                int MtlItemId = -1;
                double Quantity = -1;
                int InventoryUomId = -1;
                int InventoryId = -1;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷MES工單單身資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 WoId,SubstituteMtlItemId,DemandRequisitionQty
                                FROM MES.WoDetail
                                WHERE WoDetailId = @WoDetailId";
                        dynamicParameters.Add("WoDetailId", WoDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES工單單身資料不存在，請重新確認!");
                        foreach (var item in result)
                        {
                            WoId = item.WoId;
                            SubstituteMtlItemId = item.SubstituteMtlItemId;
                            DemandRequisitionQty = item.DemandRequisitionQty;
                        }
                        #endregion

                        #region //判斷MES工單單身資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConfirmStatus
                                FROM MES.WipOrder
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES工單資料不存在，請重新確認!");
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus == "Y") throw new SystemException("MES工單已經處於確認狀態，不可以更動!!!");
                        }
                        #endregion

                        #region //判斷替代料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MtlItemId,a.Quantity,b.InventoryUomId,b.InventoryId,b.MtlItemNo
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                WHERE SubstitutionId = @SubstitutionId";
                        dynamicParameters.Add("SubstitutionId", SubstitutionId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("替代料不存在，請重新確認!");
                        foreach (var item in result)
                        {
                            MtlItemId = item.MtlItemId;
                            MtlItemNo = item.MtlItemNo;
                            Quantity = item.Quantity;
                            InventoryUomId = item.InventoryUomId;
                            InventoryId = item.InventoryId;
                        }
                        #endregion

                        #region //判斷MES單身資料是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.WoDetail a
                                WHERE a.MtlItemId = @MtlItemId
                                AND a.SubstituteMtlItemId = @SubstituteMtlItemId
                                AND a.WoId  = @WoId
                                ";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("SubstituteMtlItemId", SubstituteMtlItemId);
                        dynamicParameters.Add("WoId", WoId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("已存在相同組合單身,不可套用替代料!!!");
                        #endregion


                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.WoDetail SET
                                MtlItemId = @MtlItemId, 
                                InventoryId = @InventoryId, 
                                UomId = @UomId, 
                                DemandRequisitionQty = @DemandRequisitionQty, 
                                SubstituteStatus = @SubstituteStatus, 
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE WoId = @WoId
                                AND WoDetailId = @WoDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MtlItemId,
                                InventoryId,
                                UomId = InventoryUomId,
                                DemandRequisitionQty = DemandRequisitionQty * Quantity,
                                SubstituteStatus = "Y",
                                LastModifiedDate,
                                LastModifiedBy,
                                WoId,
                                WoDetailId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //ERP判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                FROM INVMB a
                                WHERE MB001 = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);

                        var invmbResult = sqlConnection.Query(sql, dynamicParameters);
                        if (invmbResult.Count() <= 0) throw new SystemException("【工單單身更新】－【" + MtlItemNo + "】該品號在ERP不存在，請確認品號是否有拋轉");
                        #endregion
                    }
                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateWipOrderToERP -- MES工單資料拋轉ERP -- Ted 2022.08.23
        public string UpdateWipOrderToERP(int WoId)
        {
            try
            {
                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                int userId = CreateBy;
                string MESCompanyNo = "";
                string userNo = "";
                List<MOCTA> wipOrders = new List<MOCTA>();
                List<MOCTB> WipDetails = new List<MOCTB>();
                List<string> mesMtlItemNoList = new List<string>();
                List<string> erpAddMtlItemNoList = new List<string>();
                List<string> erpUpdateMtlItemNoList = new List<string>();
                string WoErpPrefix = "";
                string WoErpNo = "";
                string MtlItemNo = "";
                string Plant = "";
                string Currency = "";
                string docDate = "";
                string UserNoMESBase = "";
                string TransactionType = "T";
                string ActualStart = "";
                var ErpDb = "";
                var ErpNo = "";
                var BomDate = "";
                var BomVersion = "";

                int WoCompanyIdBase = -1;
                //撈取MES上工單資料
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //撈取BM工單單頭資料
                    string WoStatus = "";
                    string DocDate = "";
                    string CreateDateOre = "";
                    string ConfirmStatus = "";
                    int MtlItemId = -1;

                    sql = @"SELECT a.WoId, a.CompanyId, a.WoErpPrefix TA001, a.WoErpNo TA002, a.Version TA062, FORMAT(a.CreateDate, 'yyyy-MM-dd hh:mm:ss') CreateDateOre, FORMAT(a.DocDate, 'yyyyMMdd') TA003
                            , a.PlanQty TA015, a.RequisitionSetQty TA016, a.StockInQty TA017, a.ScrapQty TA018, a.MtlItemId
                            , ISNULL(FORMAT(a.ExpectedStart, 'yyyyMMdd'), '') TA009, ISNULL(FORMAT(a.ExpectedEnd, 'yyyyMMdd'), '') TA010
                            , FORMAT(a.ActualStart, 'yyyyMMdd') TA012, FORMAT(a.ActualEnd, 'yyyyMMdd') TA014
                            , FORMAT(a.BomDate, 'yyyyMMdd') TA004, a.BomVersion TA005, a.UrgentMtl TA044, a.Property TA030
                            , a.Project TA551, a.ProductionLine TA021, a.Processor TA032, a.CurrencyCode TA042, a.Exchange TA043
                            , a.TaxCode TA070, a.TaxType TA056, a.TaxRate TA057, a.PricingTerm TA058, a.PaymentTerm TA059
                            , a.WoRemark TA029
                            , FORMAT(a.ConfirmDate, 'yyyyMMdd') TA040, a.WoStatus TA011 ,a.ConfirmStatus TA013, a.TransferStatus, a.TransferDate
                            , b.MtlItemNo TA006, b.MtlItemName TA034, b.MtlItemSpec TA035
                            , c.InventoryNo TA020
                            , d.UomNo TA007
                            , e.UserNo TA055
                            , f.SoSequence TA028
                            , g.SoErpPrefix TA026 ,g.SoErpNo TA027
                            FROM MES.WipOrder a
                            INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                            INNER JOIN SCM.Inventory c ON a.InventoryId = c.InventoryId
                            INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                            INNER JOIN BAS.[User] e ON a.UserId = e.UserId
                            LEFT JOIN SCM.SoDetail f ON a.SoDetailId = f.SoDetailId
                            LEFT JOIN SCM.SaleOrder g ON f.SoId = g.SoId
                            WHERE a.WoId = @WoId
                            ORDER BY a.WoId";
                    dynamicParameters.Add("WoId", WoId);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("MES製令有問題");
                    foreach (var item in result)
                    {
                        WoCompanyIdBase = item.CompanyId;
                        WoStatus = item.TA011;
                        WoErpPrefix = item.TA001;
                        WoErpNo = item.TA002;
                        MtlItemNo = item.TA006;
                        ConfirmStatus = item.TA013;
                        DocDate = item.TA003;
                        CreateDateOre = item.CreateDateOre;
                        MtlItemId = Convert.ToInt32(item.MtlItemId);
                        UserNoMESBase = item.TA055;
                        ActualStart = item.TA012;
                    }
                    if (WoCompanyIdBase == 2 && WoErpPrefix == "5301")
                    {
                        //5301(晶彩無效工時)可以允許不建立單身
                        if (WoStatus != "3") throw new SystemException("5301製令,其製令狀態必須是生產中!!");
                        if (ActualStart.Length <= 0) throw new SystemException("5301製令,其實際開工日不可為空!!");
                    }
                    else
                    {
                        if (WoStatus != "1") throw new SystemException("MES製令已開工不可更改");
                    }
                    if (ConfirmStatus == "Y") throw new SystemException("MES製令處於確認狀態不可以拋轉確認");
                    if (WoCompanyIdBase != CurrentCompany) throw new SystemException("單據的公司別與目前公司別不同，請嘗試重新登入!!");

                    wipOrders = sqlConnection.Query<MOCTA>(sql, dynamicParameters).ToList();
                    #endregion

                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        MESCompanyNo = item.ErpNo;
                        ErpDb = item.ErpDb;
                    }
                    #endregion

                    #region //撈取BOM日期和版次
                    //dynamicParameters = new DynamicParameters();
                    //sql = @"SELECT FORMAT(ConfirmDate, 'yyyy-MM-dd 00:00:00') ConfirmDate,Version
                    //                        FROM PDM.BillOfMaterials
                    //                        WHERE MtlItemId = @MtlItemId";
                    //dynamicParameters.Add("MtlItemId", MtlItemId);

                    //result = sqlConnection.Query(sql, dynamicParameters);
                    //if (result.Count() > 0)
                    //{
                    //    BomDate = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ConfirmDate;
                    //    BomVersion = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Version;

                    //    CreateDateOre = DateTime.ParseExact(CreateDateOre, "yyyy-MM-dd hh:mm:ss", null).ToString("yyyy-MM-dd hh:mm:ss");
                    //    if (BomDate == null) throw new SystemException("無法取得BOM日期，請確認BOM表是否有拋轉ERP,單據是否有核單");
                    //    //開單日期不能早於BOM日期
                    //    if (DateTime.Parse(BomDate) > DateTime.Parse(CreateDateOre)) throw new SystemException("開單日(" + CreateDateOre + ")不可以早於BOM日期(" + BomDate + ")");
                    //    BomDate = DateTime.ParseExact(BomDate, "yyyy-MM-dd hh:mm:ss", null).ToString("yyyyMMdd");
                    //}
                    //else
                    //{
                    //    //throw new SystemException("BOM日期和版次不存在");
                    //}
                    #endregion

                    #region //檢查MES工單單身資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MtlItemId,b.MtlItemNo
                            FROM MES.WoDetail a
                            LEFT JOIN PDM.MtlItem b on a.MtlItemId =b.MtlItemId
                            WHERE WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);
                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (WoCompanyIdBase == 2 && WoErpPrefix == "5301")
                    {
                        //5301(晶彩無效工時)可以允許不建立單身
                    }
                    else
                    {
                        if (result.Count() <= 0) throw new SystemException("MES工單單身沒有資料不能確認");

                    }

                    #region //判斷品號是否重複
                    foreach (var item in result)
                    {
                        mesMtlItemNoList.Add(item.MtlItemNo);
                    }
                    bool repeatMtlItemNo = mesMtlItemNoList.GroupBy(i => i).Where(g => g.Count() > 1).Count() >= 1;
                    if (repeatMtlItemNo) throw new SystemException("MES工單單身有重複資料");
                    #endregion
                    #endregion

                    #region //撈取BM工單單身資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.WoId,a.WoDetailId, a.DemandRequisitionQty TB004, a.RequisitionQty TB005, a.Substitute TB010
                            ,a.WipDetailRemark TB017,a.ConfirmStatus TB018, a.MaterialProperties TB011
                            , FORMAT(a.ExpectedRequisitionDate, 'yyyyMMdd') TB015
                            , FORMAT(a.ActualRequisitionDate, 'yyyyMMdd') TB016
                            , b.MtlItemNo TB003, b.MtlItemName TB012, b.MtlItemSpec TB013
                            , c.MtlItemNo TB023
                            , d.InventoryNo TB009, d.InventoryType
                            , e.UomNo TB007
                            , f.WoErpPrefix TB001,f.WoErpNo TB002
                            , g.MtlItemNo TB014
                            FROM MES.WoDetail a
                            INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                            INNER JOIN PDM.MtlItem c on a.SubstituteMtlItemId = c.MtlItemId
                            INNER JOIN SCM.Inventory d on a.InventoryId = d.InventoryId
                            INNER JOIN PDM.UnitOfMeasure e on a.UomId = e.UomId
                            INNER JOIN MES.WipOrder f on a.WoId = f.WoId
                            INNER JOIN PDM.MtlItem g on f.MtlItemId = g.MtlItemId
                            WHERE a.WoId = @WoId
                            ORDER BY a.WoId";
                    dynamicParameters.Add("WoId", WoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    foreach (var item in result)
                    {
                        if (item.TB011 == "5")
                        {
                            if (item.InventoryType == "1") throw new SystemException("【單身資料異常】單身品號為" + item.TB003 + ",材料型態為客戶供料的情況下,庫別需為非存貨倉");
                        }
                    }
                    WipDetails = sqlConnection.Query<MOCTB>(sql, dynamicParameters).ToList();

                    #endregion

                    #region //撈取使用者No
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                    dynamicParameters.Add("UserId", CurrentUser);
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("Status", "A");
                    dynamicParameters.Add("FunctionCode", "WipOrderManagement");
                    dynamicParameters.Add("DetailCode", "confirm");

                    var resultUser = sqlConnection.Query(sql, dynamicParameters);
                    if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                    foreach (var item in resultUser)
                    {
                        userNo = item.UserNo;
                    }

                    wipOrders
                        .ToList()
                        .ForEach(x =>
                        {
                            x.CREATOR = userNo;
                            x.MODIFIER = userNo;
                            //x.TA004 = BomDate;
                            x.TA041 = userNo;
                        });
                    WipDetails
                        .ToList()
                        .ForEach(x =>
                        {
                            x.MODIFIER = userNo;
                            x.CREATOR = userNo;
                        });
                    #endregion
                }
                //ERP工單操作
                if (wipOrders.Select(x => x.TA013).FirstOrDefault() == "N") //工單沒有確認
                {
                    int rowsAffected = 0;
                    if (wipOrders.Count() > 0)
                    {
                        using (TransactionScope transactionScope = new TransactionScope())
                        {
                            using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                            {
                                DynamicParameters dynamicParameters = new DynamicParameters();



                                //單頭清單
                                List<MOCTA> addwipOrders = wipOrders.Where(x => x.TransferStatus == "N").ToList();
                                List<MOCTA> updatewipOrders = wipOrders.Where(x => x.TransferStatus == "Y").ToList();
                                //單身清單
                                List<MOCTB> addwoDetails = new List<MOCTB>();
                                List<MOCTB> updatewoDetails = new List<MOCTB>();
                                addwoDetails = WipDetails.Where(x => x.TB018 == "N").ToList();

                                #region //ERP公司代碼取得
                                string ERPCompanyNo = "";
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 ML001  
                                            FROM CMSML";
                                var resultCompanyNo = sqlConnection.Query(sql, dynamicParameters);
                                foreach (var item in resultCompanyNo)
                                {
                                    ERPCompanyNo = item.ML001;
                                }
                                if (MESCompanyNo != ERPCompanyNo) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                                #endregion

                                #region //ERP工單新增修改
                                if (wipOrders.Select(x => x.TransferStatus).FirstOrDefault() == "N") //沒有拋轉過
                                {
                                    #region //審核ERP權限-建立
                                    var USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI02", "CREATE");
                                    #endregion

                                    #region //審核ERP權限-確認
                                    var USR_GROUP1 = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI02", "CONFIRM");
                                    #endregion

                                    addwoDetails = WipDetails.Where(x => x.TB018 == "N").ToList();

                                    #region //取值
                                    WoErpPrefix = wipOrders.Select(x => x.TA001).FirstOrDefault();
                                    MtlItemNo = wipOrders.Select(x => x.TA006).FirstOrDefault();
                                    string DocDate = wipOrders.Select(x => x.TA003).FirstOrDefault();

                                    #region //撈取單據編號編碼格式設定
                                    string WoType = "";
                                    string encode = ""; // 編碼格式
                                    int yearLength = 0; // 年碼數
                                    int lineLength = 0; // 流水碼數
                                    DateTime referenceTime = default(DateTime);
                                    docDate = addwipOrders.Select(x => x.TA003).FirstOrDefault();
                                    referenceTime = DateTime.ParseExact(docDate, "yyyyMMdd", CultureInfo.InvariantCulture);


                                    #region //ERP廠別取得
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 MB001  
                                            FROM CMSMB";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                    var resultPlant = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item in resultPlant)
                                    {
                                        Plant = item.MB001;
                                    }
                                    #endregion

                                    #region //撈取ERP單據設定
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MQ004, a.MQ005, a.MQ006, a.MQ044, a.MQ017
                                            FROM CMSMQ a
                                            WHERE MQ001 = @WoErpPrefix";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                    var resultReceiptNo = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item in resultReceiptNo)
                                    {
                                        encode = item.MQ004; //編碼方式
                                        yearLength = Convert.ToInt32(item.MQ005); //年碼數
                                        lineLength = Convert.ToInt32(item.MQ006); //流水號碼數
                                        WoType = item.MQ017;
                                    }
                                    #endregion

                                    #region //單號自動取號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TA002))), '" + new string('0', lineLength) + @"'), " + lineLength + @")) + 1 CurrentNum
                                            FROM MOCTA
                                            WHERE TA001 = @WoErpPrefix";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);


                                    #region //編碼格式相關
                                    string dateFormat = "";
                                    switch (encode)
                                    {
                                        case "1": //日編
                                            if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                            if ((lineLength + yearLength + 4) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                            dateFormat = new string('y', yearLength) + "MMdd";
                                            sql += @" AND RTRIM(LTRIM(TA002)) LIKE @ReferenceTime  + '" + new string('_', lineLength) + @"'";
                                            //sql += @" AND TA002 LIKE '%' + @ReferenceTime + '%' + '" + new string('_', lineLength) + @"'";
                                            dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));

                                            string tedstNo = referenceTime.ToString(dateFormat);
                                            WoErpNo = referenceTime.ToString(dateFormat);
                                            break;
                                        case "2": //月編
                                            if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                            if ((lineLength + yearLength + 2) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                            dateFormat = new string('y', yearLength) + "MM";
                                            sql += @" AND RTRIM(LTRIM(TA002))  LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                            dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                            WoErpNo = referenceTime.ToString(dateFormat);
                                            break;
                                        case "3": //流水號
                                            if (yearLength == 0) throw new SystemException("【ERP單據性質】年碼數必須等於0");
                                            if (lineLength <= 0 || lineLength > 11) throw new SystemException("【ERP單據性質】流水編碼碼數必須大於0小於等於11");
                                            break;
                                        case "4": //手動編號
                                            break;
                                        default:
                                            throw new SystemException("編碼方式錯誤!");
                                    }

                                    int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                                    WoErpNo += string.Format("{0:" + new string('0', lineLength) + "}", currentNum);
                                    #endregion

                                    #region //判斷ERP工單單號是否重複
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MOCTA
                                            WHERE TA001 = @TA001
                                            AND TA002 = @TA002";
                                    dynamicParameters.Add("TA001", WoErpPrefix);
                                    dynamicParameters.Add("TA002", WoErpNo);

                                    var result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0) throw new SystemException("【工單單號】重複，請重新取號!");
                                    #endregion

                                    #endregion

                                    #region //撈取本國貨幣,營業稅率
                                    string TaxNo = ""; // 稅別碼
                                    string Taxation = ""; //課稅別
                                    Double BusinessTaxRate = 0.0; //營業稅率

                                    if (WoType == "2") // 托外
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 MA003
                                                FROM CMSMA";
                                        var resultCMSMA = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var item in resultCMSMA)
                                        {
                                            Currency = item.MA003;
                                        }
                                        TaxNo = "";
                                        Taxation = "";

                                    }
                                    else //廠內
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 MA004
                                                FROM CMSMA";
                                        var resultCMSMA = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var item in resultCMSMA)
                                        {
                                            BusinessTaxRate = Convert.ToDouble(item.MA004);
                                        }
                                        Currency = "";
                                        TaxNo = "";
                                        Taxation = "2";
                                    }
                                    #endregion

                                    #endregion
                                    #endregion

                                    #region //賦值
                                    addwipOrders
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.TA026 = x.TA026 != null ? x.TA026 : "";
                                            x.TA027 = x.TA027 != null ? x.TA027 : "";
                                            x.TA028 = x.TA028 != null ? x.TA028 : "";
                                            x.TA002 = WoErpNo;
                                            x.CFIELD01 = x.TA001 + "-" + WoErpNo;
                                        });
                                    addwoDetails
                                       .ToList()
                                       .ForEach(x =>
                                       {
                                           #region //判斷取替代碼
                                           string TB010 = "";
                                           dynamicParameters = new DynamicParameters();
                                           sql = @"SELECT TOP 1 1
                                                    FROM BOMMA a
                                                    WHERE MA001 = @MA001
                                                    AND MA002 = @MA002";
                                           dynamicParameters.Add("MA001", x.TB003);
                                           dynamicParameters.Add("MA002", MtlItemNo);
                                           var resultTB010 = sqlConnection.Query(sql, dynamicParameters);
                                           if (resultTB010.Count() > 0)
                                           {
                                               TB010 = "*";
                                           }
                                           #endregion

                                           x.TB002 = WoErpNo;
                                           x.TB010 = TB010;
                                       });
                                    #endregion

                                    #region //新增

                                    #region //單頭
                                    if (addwipOrders.Count > 0)
                                    {
                                        addwipOrders
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.COMPANY = MESCompanyNo;
                                                x.USR_GROUP = USR_GROUP;
                                                x.CREATE_DATE = dateNow;
                                                //x.MODIFIER = "";
                                                x.MODI_DATE = dateNow;
                                                x.FLAG = "1";
                                                x.CREATE_TIME = timeNow;
                                                x.CREATE_AP = BaseHelper.ClientComputer();
                                                x.CREATE_PRID = "BM";
                                                x.MODI_TIME = timeNow;
                                                x.MODI_AP = "";
                                                x.MODI_PRID = "";
                                                x.TA008 = "";//預留欄位
                                                x.TA013 = "Y";//確認碼
                                                x.TA014 = "";//完工日
                                                x.TA019 = Plant;//廠別代號
                                                x.TA022 = 0;//加工單價
                                                x.TA023 = x.TA007;//加工單位
                                                x.TA024 = x.TA001;//母製令別
                                                x.TA025 = x.TA002;//母製令編號
                                                x.TA031 = 0;//列印次數
                                                x.TA033 = "";//計劃批號
                                                x.TA036 = "";//預計開工(代號)休假顯示0.不休假、1.全天、2.半天
                                                x.TA037 = "";//預計完工(代號)休假顯示0.不休假、1.全天、2.半天
                                                x.TA038 = "";//實際開工(代號)休假顯示0.不休假、1.全天、2.半天
                                                x.TA039 = "";//實際完工(代號)休假顯示0.不休假、1.全天、2.半天
                                                x.TA040 = dateNow;//確認日
                                                x.TA045 = 0;//預計產包裝量
                                                x.TA046 = 0;//已生產包裝量
                                                x.TA047 = 0;//報廢包裝數量
                                                x.TA048 = "";//包裝單位
                                                x.TA049 = "N";//簽核狀態碼
                                                x.TA050 = 0;//傳送次數
                                                x.TA051 = "";//客戶品號
                                                x.TA052 = "";//APS規劃製令號碼
                                                x.TA053 = 0;//產品序號數量
                                                x.TA054 = "2";//類型
                                                x.TA060 = "";//送貨地址(一)
                                                x.TA061 = "";//送貨地址(二)
                                                x.TA062 = "0000";//版次
                                                x.TA063 = "";//預計批號
                                                x.TA064 = 0.0;//預留欄位
                                                x.TA065 = 0.0;//預留欄位
                                                x.TA066 = "";//MES拋轉紀錄碼
                                                x.TA067 = "";//預留欄位
                                                x.TA068 = "";//預留欄位
                                                x.TA069 = 0.0;//原幣加工金額
                                                x.TA071 = "";//Marking代號
                                                x.TA072 = "";//計價方式
                                                x.TA073 = 0.0;//不良品單價
                                                x.TA074 = 0.0;//廢品單價
                                                x.TA075 = "";//製造廠商
                                                x.TA076 = 0.0;//計價單價
                                                x.TA077 = 0.0;//驗收單價
                                                x.TA078 = "";//進貨/託外進貨單別
                                                x.TA079 = "";//進貨/託外進貨單號
                                                x.TA080 = "";//進貨/託外進貨序號
                                                x.TA081 = "";//採購限制日期
                                                x.TA082 = "";//預留欄位
                                                x.TA083 = "";//預留欄位
                                                x.TA084 = "";//預留欄位
                                                x.TA085 = "";//預留欄位
                                                x.TA086 = "";//預留欄位
                                                x.TA087 = "";//預留欄位
                                                x.TA088 = "";//預留欄位
                                                x.TA089 = "";//預留欄位
                                                x.TA090 = "";//預留欄位
                                                x.TA091 = "";//預留欄位
                                                x.TA092 = "N";//製程否
                                                x.TA093 = "";//預留欄位
                                                x.TA094 = 0;//預留欄位
                                                x.TA095 = "";//優先順序
                                                x.TA096 = "";//預留欄位
                                                x.TA097 = "N";//單身多稅率
                                                x.TA500 = "";//不良品庫別
                                                x.TA501 = "";//MARKING
                                                x.TA502 = "";//BONDING
                                                x.TA503 = 0.0;//加工片數
                                                x.TA504 = 0.0;//已交片數
                                                x.TA505 = "";//加工項目代號
                                                x.TA506 = "";//晶片厚度
                                                x.TA507 = "";//晶片尺寸
                                                x.TA508 = "";//領料單單別
                                                x.TA509 = "";//領料單單號
                                                x.TA510 = "";//備註說明A
                                                x.TA511 = "";//備註說明B
                                                x.TA512 = "";//備註說明C
                                                x.TA513 = "";//備註說明D
                                                x.TA514 = 0.0;//需領用總數
                                                x.TA515 = 0.0;//需領用包裝總數
                                                x.TA516 = 0.0;//GROSS_DIE總數
                                                x.TA520 = "";//特性1
                                                x.TA521 = "";//特性2
                                                x.TA522 = "";//特性3
                                                x.TA523 = "";//特性4
                                                x.TA524 = "";//特性5
                                                x.TA525 = "";//特性6
                                                x.TA526 = "";//特性7
                                                x.TA527 = "";//特性8
                                                x.TA528 = "";//特性9
                                                x.TA530 = "";//下站加工項目
                                                x.TA531 = "";//下站加工廠商
                                                x.TA532 = "";//下站加工聯絡人
                                                x.TA533 = "";//下站加工電話
                                                x.TA534 = "";//送貨地址一
                                                x.TA535 = "";//送貨地址二
                                                x.TA550 = "";//性質 1:量產品 2:工程品
                                                x.TA552 = 0.0;//材料單價比率
                                                x.TA553 = "";//預留欄位
                                                x.TA554 = "";//自動扣料已轉撥
                                                x.TA555 = "";//轉撥單別
                                                x.TA556 = "";//轉撥單號
                                                x.UDF01 = "";
                                                x.UDF02 = "";
                                                x.UDF03 = "";
                                                x.UDF04 = "";
                                                x.UDF05 = "";
                                                x.UDF06 = 0.0;
                                                x.UDF07 = 0.0;
                                                x.UDF08 = 0.0;
                                                x.UDF09 = 0.0;
                                                x.UDF10 = 0.0;
                                            });

                                        sql = @"INSERT INTO MOCTA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                                CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TA001, TA002, TA003, TA004, TA005, TA006, TA007, 
                                                TA008, TA009, TA010, TA011, TA012, TA013, TA014, TA015, TA016, TA017, TA018, TA019, TA020, TA021, TA022, 
                                                TA023, TA024, TA025, TA026, TA027, TA028, TA029, TA030, TA031, TA032, TA033, TA034, TA035, TA036, TA037, 
                                                TA038, TA039, TA040, TA041, TA042, TA043, TA044, TA045, TA046, TA047, TA048, TA049, TA050, TA051, TA052, 
                                                TA053, TA054, TA055, TA056, TA057, TA058, TA059, TA060, TA061, TA062, TA063, TA064, TA065, TA066, TA067, 
                                                TA068, TA069, TA070, TA071, TA072, TA073, TA074, TA075, TA076, TA077, TA078, TA079, TA080, TA081, TA082, 
                                                TA083, TA084, TA085, TA086, TA087, TA088, TA089, TA090, TA091, TA092, TA093, TA094, TA095, TA096, TA500, 
                                                TA501, TA502, TA503, TA504, TA505, TA506, TA507, TA508, TA509, TA510, TA511, TA512, TA513, TA514, TA515, 
                                                TA516, TA520, TA521, TA522, TA523, TA524, TA525, TA526, TA527, TA528, TA530, TA531, TA532, TA533, TA534, 
                                                TA535, TA550, TA551, TA552, TA553, UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, 
                                                TA097, TA554, TA555, TA556)
                                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
                                                @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TA001, @TA002, @TA003, @TA004, @TA005, @TA006, @TA007, 
                                                @TA008, @TA009, @TA010, @TA011, @TA012, @TA013, @TA014, @TA015, @TA016, @TA017, @TA018, @TA019, @TA020, @TA021, @TA022, 
                                                @TA023, @TA024, @TA025, @TA026, @TA027, @TA028, @TA029, @TA030, @TA031, @TA032, @TA033, @TA034, @TA035, @TA036, @TA037, 
                                                @TA038, @TA039, @TA040, @TA041, @TA042, @TA043, @TA044, @TA045, @TA046, @TA047, @TA048, @TA049, @TA050, @TA051, @TA052, 
                                                @TA053, @TA054, @TA055, @TA056, @TA057, @TA058, @TA059, @TA060, @TA061, @TA062, @TA063, @TA064, @TA065, @TA066, @TA067, 
                                                @TA068, @TA069, @TA070, @TA071, @TA072, @TA073, @TA074, @TA075, @TA076, @TA077, @TA078, @TA079, @TA080, @TA081, @TA082, 
                                                @TA083, @TA084, @TA085, @TA086, @TA087, @TA088, @TA089, @TA090, @TA091, @TA092, @TA093, @TA094, @TA095, @TA096, @TA500, 
                                                @TA501, @TA502, @TA503, @TA504, @TA505, @TA506, @TA507, @TA508, @TA509, @TA510, @TA511, @TA512, @TA513, @TA514, @TA515, 
                                                @TA516, @TA520, @TA521, @TA522, @TA523, @TA524, @TA525, @TA526, @TA527, @TA528, @TA530, @TA531, @TA532, @TA533, @TA534, 
                                                @TA535, @TA550, @TA551, @TA552, @TA553, @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10, 
                                                @TA097, @TA554, @TA555, @TA556)";
                                        rowsAffected += sqlConnection.Execute(sql, addwipOrders);
                                    }
                                    #endregion

                                    #region //單身                                    
                                    if (addwoDetails.Count > 0)
                                    {
                                        addwoDetails
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.COMPANY = MESCompanyNo;
                                                x.USR_GROUP = USR_GROUP;
                                                x.CREATE_DATE = dateNow;
                                                //x.MODIFIER = "";
                                                x.MODI_DATE = dateNow;
                                                x.FLAG = "2";
                                                x.CREATE_TIME = timeNow;
                                                x.CREATE_AP = BaseHelper.ClientComputer();
                                                x.CREATE_PRID = "BM";
                                                x.MODI_TIME = timeNow;
                                                x.MODI_AP = BaseHelper.ClientComputer();
                                                x.MODI_PRID = "BM";
                                                x.TB006 = "****";//製程代號
                                                x.TB008 = ""; //預留欄位
                                                x.TB018 = "Y"; //確認碼
                                                x.TB019 = 0.0; //需領用包裝量
                                                x.TB020 = 0.0; //已領用包裝量
                                                x.TB021 = ""; //包裝單位
                                                x.TB022 = "2"; //類型
                                                x.TB024 = 0.0; //預留欄位
                                                x.TB025 = "****"; //被取替代製程
                                                x.TB026 = 0.0; //預留欄位
                                                x.TB027 = "1"; //來源碼
                                                x.TB028 = ""; //預留欄位
                                                x.TB029 = 0.0; //預留欄位
                                                x.TB030 = 0.0; //預留欄位
                                                x.TB031 = 0.0; //預留欄位
                                                x.TB032 = ""; //預留欄位
                                                x.TB033 = ""; //預留欄位
                                                x.TB034 = ""; //預留欄位
                                                x.TB035 = ""; //發料DATECODE
                                                x.TB036 = ""; //發料儲位
                                                x.TB037 = ""; //加工順序
                                                x.TB038 = 0.0; //營業稅率
                                                x.TB039 = ""; //稅別碼
                                                x.TB500 = ""; //DATECODE
                                                x.TB501 = 0.0; //GROSS_DIE
                                                x.TB502 = ""; //批號
                                                x.TB503 = ""; //領料單別
                                                x.TB504 = ""; //領料單號
                                                x.TB505 = ""; //領料序號
                                                x.TB550 = ""; //性質
                                                x.TB551 = ""; //入庫批號
                                                x.TB552 = ""; //專案代號
                                                x.TB553 = ""; //刻號/BIN記錄
                                                x.TB554 = ""; //刻號管理
                                                x.TB555 = ""; //預留欄位
                                                x.TB556 = ""; //預留欄位
                                                x.TB557 = ""; //預留欄位
                                                x.UDF01 = "";
                                                x.UDF02 = "";
                                                x.UDF03 = "";
                                                x.UDF04 = "";
                                                x.UDF05 = "";
                                                x.UDF06 = 0.0;
                                                x.UDF07 = 0.0;
                                                x.UDF08 = 0.0;
                                                x.UDF09 = 0.0;
                                                x.UDF10 = 0.0;
                                            });

                                        sql = @"INSERT INTO MOCTB(COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                            CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TB001, TB002, TB003, TB004, TB005, TB006, 
                                            TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB014, TB015, TB016, TB017, TB018, TB019, TB020, TB021, 
                                            TB022, TB023, TB024, TB025, TB026, TB027, TB028, TB029, TB030, TB031, TB032, TB033, TB034, TB035, TB036, 
                                            TB037, TB500, TB501, TB502, TB503, TB504, TB505, TB550, TB551, TB552, TB553, TB554, UDF01, UDF02, UDF03, 
                                            UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, TB038, TB039, TB555, TB556, TB557)
                                            VALUES(@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
                                            @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, 
                                            @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014, @TB015, @TB016, @TB017, @TB018, @TB019, @TB020, @TB021, 
                                            @TB022, @TB023, @TB024, @TB025, @TB026, @TB027, @TB028, @TB029, @TB030, @TB031, @TB032, @TB033, @TB034, @TB035, @TB036, 
                                            @TB037, @TB500, @TB501, @TB502, @TB503, @TB504, @TB505, @TB550, @TB551, @TB552, @TB553, @TB554, @UDF01, @UDF02, @UDF03, 
                                            @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10, @TB038, @TB039, @TB555, @TB556, @TB557)";
                                        rowsAffected += sqlConnection.Execute(sql, addwoDetails);
                                    }

                                    #endregion

                                    #endregion
                                }
                                else if (wipOrders.Select(x => x.TransferStatus).FirstOrDefault() == "Y") //有拋轉過
                                {
                                    #region //審核ERP權限-建立
                                    var USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI02", "CREATE");
                                    #endregion

                                    #region //審核ERP權限-確認
                                    var USR_GROUP1 = BaseHelper.CheckErpAuthority(UserNo, sqlConnection, "MOCI02", "CONFIRM");
                                    #endregion

                                    #region //判斷ERP工單是否存在+可不可以拋轉確認
                                    string erpWoStatus = "";
                                    string erpConfirmStatus = "";
                                    TransactionType = "RT";
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TA011,TA013
                                            FROM MOCTA
                                            WHERE TA001 =@WoErpPrefix
                                            AND TA002 = @WoErpNo";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", WoErpNo);
                                    var result1 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result1.Count() <= 0) throw new SystemException("ERP工單不存在,請重新確認!!!");

                                    foreach (var item in result1)
                                    {
                                        erpWoStatus = item.TA011;
                                        erpConfirmStatus = item.TA013;
                                    }
                                    if (erpWoStatus != "1") throw new SystemException("ERP工單已開工不可更動!!!");
                                    if (erpConfirmStatus == "Y") throw new SystemException("ERP工單處於確認狀態不可以拋轉確認!!!");
                                    #endregion

                                    #region //新增修改-單頭單身
                                    #region //單身ERP工單編號賦值
                                    addwoDetails
                                       .ToList()
                                       .ForEach(x =>
                                       {
                                           x.TB002 = WoErpNo;

                                           #region //判斷取替代碼
                                           string TB010 = "";
                                           dynamicParameters = new DynamicParameters();
                                           sql = @"SELECT TOP 1 1
                                                    FROM BOMMA a
                                                    WHERE MA001 = @MA001
                                                    AND MA002 = @MA002";
                                           dynamicParameters.Add("MA001", x.TB003);
                                           dynamicParameters.Add("MA002", MtlItemNo);
                                           var resultTB010 = sqlConnection.Query(sql, dynamicParameters);
                                           if (resultTB010.Count() > 0)
                                           {
                                               TB010 = "*";
                                           }
                                           #endregion

                                           x.TB002 = WoErpNo;
                                           x.TB010 = TB010;
                                       });
                                    #endregion

                                    #region //單頭修改
                                    if (updatewipOrders.Count > 0)
                                    {
                                        updatewipOrders
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.TA013 = "Y";
                                                x.TA040 = dateNow;
                                                x.TA041 = userNo;
                                                x.MODI_DATE = dateNow;
                                                x.MODI_TIME = timeNow;
                                                x.MODI_AP = BaseHelper.ClientComputer();
                                            });

                                        sql = @"UPDATE MOCTA SET
                                                TA004 = @TA004,
                                                TA005 = @TA005,
                                                TA006 = @TA006,
                                                TA007 = @TA007,
                                                TA009 = @TA009,
                                                TA010 = @TA010,
                                                TA011 = @TA011,
                                                TA013 = @TA013,
                                                TA015 = @TA015,
                                                TA020 = @TA020,
                                                TA021 = @TA021,
                                                TA023 = @TA007,
                                                TA026 = @TA026,
                                                TA027 = @TA027,
                                                TA028 = @TA028,
                                                TA029 = @TA029,
                                                TA032 = @TA032,
                                                TA034 = @TA034,
                                                TA035 = @TA035,
                                                TA040 = @TA040,
                                                TA041 = @TA041,
                                                TA042 = @TA042,
                                                TA043 = @TA043,
                                                TA055 = @TA055,
                                                TA056 = @TA056,
                                                TA057 = @TA057,
                                                TA058 = @TA058,
                                                TA059 = @TA059,
                                                TA062 = @TA062,
                                                TA070 = @TA070,
                                                TA551 = @TA551,
                                                MODI_DATE = @MODI_DATE,
                                                MODI_TIME = @MODI_TIME,
                                                MODI_AP = @MODI_AP
                                                WHERE TA001 = @TA001
                                                AND TA002 = @TA002";
                                        rowsAffected += sqlConnection.Execute(sql, updatewipOrders);
                                    }
                                    #endregion

                                    #region //單身
                                    #region //刪除單身
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE MOCTB
                                            WHERE TB001 = @WoErpPrefix
                                            AND TB002 = @WoErpNo";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", WoErpNo);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //新增單身 
                                    if (addwoDetails.Count > 0)
                                    {
                                        addwoDetails
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.COMPANY = MESCompanyNo;
                                                x.USR_GROUP = USR_GROUP;
                                                x.CREATE_DATE = dateNow;
                                                //x.MODIFIER = "";
                                                x.MODI_DATE = dateNow;
                                                x.FLAG = "2";
                                                x.CREATE_TIME = timeNow;
                                                x.CREATE_AP = BaseHelper.ClientComputer();
                                                x.CREATE_PRID = "BM";
                                                x.MODI_TIME = timeNow;
                                                x.MODI_AP = BaseHelper.ClientComputer();
                                                x.MODI_PRID = "BM";
                                                x.TB006 = "****";//製程代號
                                                x.TB008 = ""; //預留欄位
                                                x.TB018 = "Y"; //確認碼
                                                x.TB019 = 0.0; //需領用包裝量
                                                x.TB020 = 0.0; //已領用包裝量
                                                x.TB021 = ""; //包裝單位
                                                x.TB022 = "2"; //類型
                                                x.TB024 = 0.0; //預留欄位
                                                x.TB025 = "****"; //被取替代製程
                                                x.TB026 = 0.0; //預留欄位
                                                x.TB027 = "1"; //來源碼
                                                x.TB028 = ""; //預留欄位
                                                x.TB029 = 0.0; //預留欄位
                                                x.TB030 = 0.0; //預留欄位
                                                x.TB031 = 0.0; //預留欄位
                                                x.TB032 = ""; //預留欄位
                                                x.TB033 = ""; //預留欄位
                                                x.TB034 = ""; //預留欄位
                                                x.TB035 = ""; //發料DATECODE
                                                x.TB036 = ""; //發料儲位
                                                x.TB037 = ""; //加工順序
                                                x.TB038 = 0.0; //營業稅率
                                                x.TB039 = ""; //稅別碼
                                                x.TB500 = ""; //DATECODE
                                                x.TB501 = 0.0; //GROSS_DIE
                                                x.TB502 = ""; //批號
                                                x.TB503 = ""; //領料單別
                                                x.TB504 = ""; //領料單號
                                                x.TB505 = ""; //領料序號
                                                x.TB550 = ""; //性質
                                                x.TB551 = ""; //入庫批號
                                                x.TB552 = ""; //專案代號
                                                x.TB553 = ""; //刻號/BIN記錄
                                                x.TB554 = ""; //刻號管理
                                                x.TB555 = ""; //預留欄位
                                                x.TB556 = ""; //預留欄位
                                                x.TB557 = ""; //預留欄位
                                                x.UDF01 = "";
                                                x.UDF02 = "";
                                                x.UDF03 = "";
                                                x.UDF04 = "";
                                                x.UDF05 = "";
                                                x.UDF06 = 0.0;
                                                x.UDF07 = 0.0;
                                                x.UDF08 = 0.0;
                                                x.UDF09 = 0.0;
                                                x.UDF10 = 0.0;
                                            });

                                        sql = @"INSERT INTO MOCTB(COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                                CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TB001, TB002, TB003, TB004, TB005, TB006, 
                                                TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB014, TB015, TB016, TB017, TB018, TB019, TB020, TB021, 
                                                TB022, TB023, TB024, TB025, TB026, TB027, TB028, TB029, TB030, TB031, TB032, TB033, TB034, TB035, TB036, 
                                                TB037, TB500, TB501, TB502, TB503, TB504, TB505, TB550, TB551, TB552, TB553, TB554, UDF01, UDF02, UDF03, 
                                                UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, TB038, TB039, TB555, TB556, TB557)
                                                VALUES(@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
                                                @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, 
                                                @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014, @TB015, @TB016, @TB017, @TB018, @TB019, @TB020, @TB021, 
                                                @TB022, @TB023, @TB024, @TB025, @TB026, @TB027, @TB028, @TB029, @TB030, @TB031, @TB032, @TB033, @TB034, @TB035, @TB036, 
                                                @TB037, @TB500, @TB501, @TB502, @TB503, @TB504, @TB505, @TB550, @TB551, @TB552, @TB553, @TB554, @UDF01, @UDF02, @UDF03, 
                                                @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10, @TB038, @TB039, @TB555, @TB556, @TB557)";
                                        rowsAffected += sqlConnection.Execute(sql, addwoDetails);
                                    }

                                    #endregion
                                    #endregion
                                    #endregion
                                }
                                #endregion
                            }

                            #region //MES工單修改確認碼

                            using (SqlConnection sqlConnections = new SqlConnection(MainConnectionStrings))
                            {
                                DynamicParameters dynamicParameters = new DynamicParameters();


                                if (wipOrders.Select(x => x.TransferStatus).FirstOrDefault() == "N") //沒有拋轉過
                                {
                                    //修改MES工單單號,拋轉狀態,確認碼(拋轉前MES工單單號是亂碼;拋轉ERP後得到正確單號再回來修改MES上的工單單號)
                                    #region //單頭
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.WipOrder SET
                                            WoErpNo = @WoErpNo,
                                            Version = @Version,
                                            ConfirmStatus = @ConfirmStatus,
                                            ConfirmUserId = @ConfirmUserId,
                                            ConfirmDate = @ConfirmDate,
                                            TransferStatus = @TransferStatus,
                                            TransferDate = @TransferDate,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE WoId = @WoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            WoErpNo = wipOrders.Select(x => x.TA002).FirstOrDefault(),
                                            Version = "0000",
                                            ConfirmStatus = "Y",
                                            ConfirmUserId = userId,
                                            ConfirmDate = dateNow,
                                            TransferStatus = "Y",
                                            TransferDate = LastModifiedDate,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            WoId
                                        });
                                    var insertResult = sqlConnections.Query(sql, dynamicParameters);

                                    rowsAffected += sqlConnections.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //單身
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.WoDetail SET
                                            ConfirmStatus = @ConfirmStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE WoId = @WoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            ConfirmStatus = "Y",
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            WoId
                                        });
                                    insertResult = sqlConnections.Query(sql, dynamicParameters);

                                    rowsAffected += sqlConnections.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                else if (wipOrders.Select(x => x.TransferStatus).FirstOrDefault() == "Y") //有拋轉過
                                {
                                    #region//修改MES工單確認碼
                                    //單頭更新
                                    sql = @"UPDATE MES.WipOrder SET
                                            ConfirmStatus = @ConfirmStatus,
                                            ConfirmUserId = @ConfirmUserId,
                                            ConfirmDate = @ConfirmDate,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE WoId = @WoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            ConfirmStatus = "Y",
                                            ConfirmUserId = userId,
                                            ConfirmDate = dateNow,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            WoId
                                        });
                                    var insertResult = sqlConnections.Query(sql, dynamicParameters);

                                    rowsAffected += sqlConnections.Execute(sql, dynamicParameters);

                                    //單身更新
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.WoDetail SET
                                            ConfirmStatus = @ConfirmStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE WoId = @WoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            ConfirmStatus = "Y",
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            WoId
                                        });
                                    insertResult = sqlConnections.Query(sql, dynamicParameters);

                                    rowsAffected += sqlConnections.Execute(sql, dynamicParameters);

                                    #endregion
                                }
                                else
                                {
                                    throw new SystemException("【拋轉狀態值有問題】");
                                }

                                #region //ERP log紀錄
                                List<WipOrder> wipOrderMES = new List<WipOrder>();

                                sql = @"SELECT WoId, CompanyId, UserId, WoErpPrefix, WoErpNo, Version, DocDate, MtlItemId, InventoryId, UomId, PlanQty, RequisitionSetQty, 
                                        StockInQty, ScrapQty, ExpectedStart, ExpectedEnd, ActualStart, ActualEnd, BomDate, BomVersion, UrgentMtl, Property, SoDetailId, Project, 
                                        WoRemark, ConfirmStatus, ConfirmUserId, ConfirmDate, WoStatus, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, 
                                        LastModifiedBy
                                        FROM MES.WipOrder a
                                        WHERE a.WoId = @WoId";
                                dynamicParameters.Add("WoId", WoId);
                                var resultWoLog = sqlConnections.Query(sql, dynamicParameters);
                                if (resultWoLog.Count() <= 0) throw new SystemException("MES製令有問題");
                                wipOrderMES = sqlConnections.Query<WipOrder>(sql, dynamicParameters).ToList();

                                if (wipOrderMES.Count > 0)
                                {
                                    wipOrderMES
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.TransactionType = TransactionType;
                                            x.ErpDb = ErpDb;
                                            x.ErpNo = ErpNo;
                                            x.TransactionUserId = CurrentUser;
                                            x.TransactionDate = CreateDate;
                                        });

                                    sql = @"INSERT INTO MES.WipOrderLog (TransactionType,ErpDb,ErpNo,TransactionUserId,TransactionDate,
                                        WoId, CompanyId, UserId, WoErpPrefix, WoErpNo, Version, DocDate, MtlItemId, InventoryId, UomId, 
                                        PlanQty, RequisitionSetQty, StockInQty, ScrapQty, ExpectedStart, ExpectedEnd, ActualStart, ActualEnd, BomDate, 
                                        BomVersion, UrgentMtl, Property, SoDetailId, Project, WoRemark, ConfirmStatus, ConfirmUserId, 
                                        ConfirmDate, WoStatus, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, 
                                        LastModifiedBy)
                                        VALUES (@TransactionType,@ErpDb,@ErpNo,@TransactionUserId,@TransactionDate,
                                        @WoId, @CompanyId, @UserId, @WoErpPrefix, @WoErpNo, @Version, @DocDate, @MtlItemId, @InventoryId, @UomId, 
                                        @PlanQty, @RequisitionSetQty, @StockInQty, @ScrapQty, @ExpectedStart, @ExpectedEnd, @ActualStart, @ActualEnd, @BomDate, 
                                        @BomVersion, @UrgentMtl, @Property, @SoDetailId, @Project, @WoRemark, @ConfirmStatus, @ConfirmUserId, 
                                        @ConfirmDate, @WoStatus, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, 
                                        @LastModifiedBy)";
                                    rowsAffected += sqlConnections.Execute(sql, wipOrderMES);
                                }
                                #endregion
                            }
                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "拋轉成功"
                            });
                            #endregion

                            transactionScope.Complete();
                        }
                        #endregion
                    }
                }
                else
                {
                    throw new SystemException("工單已確認過");
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //UpdateWipOrderReconfirm -- 工單反確認 -- Ted 2022-08-19
        public string UpdateWipOrderReconfirm(int WoId)
        {
            try
            {
                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                int userId = CreateBy;
                string WoErpPrefix;
                string WoErpNo = "";
                string ErpNo = "";
                string userNo = "";
                int rowsAffected = 0;
                int mesWoDetailNum = 0;
                int CompanyIdBase = -1;

                DynamicParameters dynamicParameters = new DynamicParameters();
                //MES工單檢查
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //檢查資料
                    #region //判斷單頭資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT CompanyId, WoErpPrefix, WoErpNo, ConfirmStatus
                                FROM MES.WipOrder
                                WHERE WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");
                    foreach (var item in result)
                    {
                        WoErpPrefix = item.WoErpPrefix;
                        WoErpNo = item.WoErpNo;
                        CompanyIdBase = item.CompanyId;
                    }
                    WoErpPrefix = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoErpPrefix;
                    WoErpNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoErpNo;
                    if (CompanyIdBase != CurrentCompany) throw new SystemException("使用者公司別與單據公司別不同，請嘗試重新登入!!");

                    #endregion

                    #region //判斷單身資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ConfirmStatus
                                FROM MES.WoDetail
                                WHERE WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);
                    var result2 = sqlConnection.Query(sql, dynamicParameters);
                    if (CompanyIdBase == 2 && WoErpPrefix == "5301")
                    {
                        //5301(晶彩無效工時)可以允許不建立單身
                    }
                    else
                    {
                        if (result.Count() <= 0) throw new SystemException("MES工單單身沒有資料不能確認");

                    }
                    mesWoDetailNum = result2.Count();
                    #endregion

                    #region //判斷是否有綁定MES製令
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1 
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b on a.WoId = b.WoId
                            WHERE a.WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);
                    var resultMoId = sqlConnection.Query(sql, dynamicParameters);
                    if (resultMoId.Count() > 0) throw new SystemException("該製令已經綁定了MES,請先解除MES綁定才能反確認!");
                    #endregion

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                    if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion

                    #region //撈取使用者No
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                    dynamicParameters.Add("UserId", CurrentUser);
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("Status", "A");
                    dynamicParameters.Add("FunctionCode", "WipOrderManagement");
                    dynamicParameters.Add("DetailCode", "reconfirm");

                    var resultUser = sqlConnection.Query(sql, dynamicParameters);
                    if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                    foreach (var item in resultUser)
                    {
                        userNo = item.UserNo;
                    }
                    #endregion
                    #endregion
                }
                //ERP工單檢查
                using (SqlConnection sqlConnectionERP = new SqlConnection(ErpConnectionStrings))
                {
                    #region //檢查資料
                    #region //審核ERP權限-確認
                    var USR_GROUP1 = BaseHelper.CheckErpAuthority(UserNo, sqlConnectionERP, "MOCI02", "CONFIRM");
                    #endregion

                    #region //判斷單頭資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TA001, TA002, TA013
                            FROM MOCTA
                            WHERE TA001 = @WoErpPrefix
                            AND TA002 = @WoErpNo";
                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                    dynamicParameters.Add("WoErpNo", WoErpNo);
                    var result1 = sqlConnectionERP.Query(sql, dynamicParameters);
                    if (result1.Count() <= 0) throw new SystemException("ERP製令資料錯誤!");
                    #endregion

                    #region //判斷單身資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TB001, TB002, TB018
                            FROM MOCTB
                            WHERE TB001 = @WoErpPrefix
                            AND TB002 = @WoErpNo";
                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                    dynamicParameters.Add("WoErpNo", WoErpNo);
                    var result2 = sqlConnectionERP.Query(sql, dynamicParameters);
                    if (result2.Count() != mesWoDetailNum)
                    {
                        if (result2.Count() < mesWoDetailNum)
                        {
                            throw new SystemException("ERP工單單身資料少於MES工單單身!");
                        }
                        else
                        {
                            throw new SystemException("ERP工單單身資料大於MES工單單身!");
                        }
                    }
                    #endregion
                    #endregion
                }
                //工單取消確認碼
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    //MES工單
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //單頭取消確認碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.WipOrder SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE WoId = @WoId";
                        dynamicParameters.AddDynamicParams(
                             new
                             {
                                 ConfirmStatus = "N",
                                 LastModifiedDate,
                                 LastModifiedBy,
                                 WoId
                             });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //單身工單確認碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.WoDetail SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE WoId = @WoId";
                        dynamicParameters.AddDynamicParams(
                             new
                             {
                                 ConfirmStatus = "N",
                                 LastModifiedDate,
                                 LastModifiedBy,
                                 WoId
                             });
                        insertResult = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                    }
                    //ERP工單
                    using (SqlConnection sqlConnectionERP = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //ERP公司代碼取得
                        string CompanyNo = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ML001  
                                FROM CMSML";
                        var resultCompanyNo = sqlConnectionERP.Query(sql, dynamicParameters);
                        foreach (var item in resultCompanyNo)
                        {
                            CompanyNo = item.ML001;
                        }
                        if (ErpNo != CompanyNo) throw new SystemException("MES的公司代碼與ERP的公司代碼不同，請嘗試重新登入!!");
                        #endregion

                        #region //單頭取消確認碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTA SET 
                                TA013 = @TA013,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP
                                WHERE TA001 = @TA001
                                AND TA002 = @TA002";
                        dynamicParameters.AddDynamicParams(
                                new
                                {
                                    TA013 = "N",
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = BaseHelper.ClientComputer(),
                                    TA001 = WoErpPrefix,
                                    TA002 = WoErpNo,
                                });
                        var insertResult = sqlConnectionERP.Query(sql, dynamicParameters);

                        rowsAffected += sqlConnectionERP.Execute(sql, dynamicParameters);
                        #endregion

                        #region //單身取消確認碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTB SET 
                                TB018 = @TB018,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP
                                WHERE TB001 = @TB001
                                AND TB002 = @TB002";
                        dynamicParameters.AddDynamicParams(
                                new
                                {
                                    TB018 = "N",
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = BaseHelper.ClientComputer(),
                                    TB001 = WoErpPrefix,
                                    TB002 = WoErpNo,
                                });
                        insertResult = sqlConnectionERP.Query(sql, dynamicParameters);

                        rowsAffected += sqlConnectionERP.Execute(sql, dynamicParameters);
                        #endregion

                    }
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "反確認成功"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateWomSynchronize -- 製令變更單資料手動同步 -- Shintokuro 2024.02.20
        //public string UpdateWomSynchronize(string ErpFullNo, string SyncStartDate, string SyncEndDate
        //    , string NormalSync, string TranSync, string CompanyNo
        //    )
        //{
        //    try
        //    {
        //        List<ReturnReceiveOrder> returnReceiveOrder = new List<ReturnReceiveOrder>();
        //        List<RtDetail> rtDetails = new List<RtDetail>();

        //        int mainAffected = 0, detailAffected = 0, mainDelAffected = 0, detailDelAffected = 0; ;
        //        string companyNo = "";
        //        string companyNoBase = "";
        //        //if (CompanyNo.Length <= 0) throw new SystemException("【公司】不能為空!");
        //        int CompanyId = -1;
        //        string ErpConnectionStrings = "";

        //        using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
        //        {
        //            using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
        //            {
        //                #region //判斷公司資料是否正確
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
        //                        FROM BAS.Company
        //                        WHERE CompanyId = @CompanyId";
        //                dynamicParameters.Add("CompanyId", CurrentCompany);

        //                var result = sqlConnection.Query(sql, dynamicParameters);
        //                if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

        //                foreach (var item in result)
        //                {
        //                    CompanyId = Convert.ToInt32(item.CompanyId);
        //                    ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
        //                    companyNo = item.ErpNo;
        //                }
        //                #endregion
        //            }

        //            #region //正常同步
        //            if (NormalSync == "Y")
        //            {
        //                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
        //                {
        //                    #region //判斷ERP銷退單資料是否存在
        //                    if (ErpFullNo.Length > 0)
        //                    {
        //                        dynamicParameters = new DynamicParameters();
        //                        sql = @"SELECT TOP 1 1
        //                                FROM COPTI
        //                                WHERE (LTRIM(RTRIM(TI001)) + '-' + LTRIM(RTRIM(TI002))) LIKE '%' + @ErpFullNo + '%'";
        //                        dynamicParameters.Add("ErpFullNo", ErpFullNo);

        //                        var resultTsn = sqlConnection.Query(sql, dynamicParameters);
        //                        if (resultTsn.Count() <= 0) throw new SystemException("ERP銷退單資料錯誤");
        //                    }
        //                    #endregion

        //                    #region //撈取ERP銷退單頭資料 
        //                    sql = @"SELECT 
        //                            LTRIM(RTRIM(TI001)) RtErpPrefix,            LTRIM(RTRIM(TI002)) RtErpNo,
        //                                                                        LTRIM(RTRIM(TI004)) CustomerNo,
        //                            LTRIM(RTRIM(TI005)) DepartmentNo,           LTRIM(RTRIM(TI006)) SalesmenNo,
        //                            LTRIM(RTRIM(TI007)) Factory,                LTRIM(RTRIM(TI008)) Currency,
        //                            LTRIM(RTRIM(TI009)) ExchangeRate,           LTRIM(RTRIM(TI010)) OriginalAmount,
        //                            LTRIM(RTRIM(TI011)) OriginalTaxAmount,      LTRIM(RTRIM(TI012)) InvoiceType,
        //                            LTRIM(RTRIM(TI013)) TaxType,                LTRIM(RTRIM(TI014)) InvNumEnd,
        //                            LTRIM(RTRIM(TI015)) UiNo,                   LTRIM(RTRIM(TI016)) PrintCount,
        //                                                                        LTRIM(RTRIM(TI018)) UpdateCode,
        //                            LTRIM(RTRIM(TI019)) ConfirmStatus,          LTRIM(RTRIM(TI020)) Remark,
        //                            LTRIM(RTRIM(TI021)) CustomerFullName,       LTRIM(RTRIM(TI022)) CollectionSalesmenNo,
        //                            LTRIM(RTRIM(TI023)) Remark1,                LTRIM(RTRIM(TI024)) Remark2,
        //                            LTRIM(RTRIM(TI025)) Remark3,                LTRIM(RTRIM(TI026)) DeductionDistinction,
        //                            LTRIM(RTRIM(TI027)) CustomsClearance,       LTRIM(RTRIM(TI028)) RowCnt,
        //                            LTRIM(RTRIM(TI029)) TotalQuantity,          LTRIM(RTRIM(TI030)) StaffNo,
        //                            LTRIM(RTRIM(TI031)) RevenueJournalCode,     LTRIM(RTRIM(TI032)) CostJournalCode,
        //                            LTRIM(RTRIM(TI033)) ApplyYYMM,              
        //                            LTRIM(RTRIM(TI035)) ConfirmUserNo,          LTRIM(RTRIM(TI036)) TaxRate,
        //                            LTRIM(RTRIM(TI037)) PretaxAmount,           LTRIM(RTRIM(TI038)) TaxAmount,
        //                            LTRIM(RTRIM(TI039)) PaymentTerm,            LTRIM(RTRIM(TI040)) TotalPackages,
        //                            LTRIM(RTRIM(TI041)) SignatureStatus,        LTRIM(RTRIM(TI042)) ProcessCode,
        //                            LTRIM(RTRIM(TI043)) TransferStatusERP,      LTRIM(RTRIM(TI044)) BondCode,
        //                            LTRIM(RTRIM(TI045)) TransmissionCount,      LTRIM(RTRIM(TI046)) CustomerAddressFirst,
        //                            LTRIM(RTRIM(TI047)) CustomerAddressSecond,  LTRIM(RTRIM(TI049)) ContactPerson,
        //                            LTRIM(RTRIM(TI050)) Courier,                LTRIM(RTRIM(TI051)) SiteCommCalcMethod,
        //                            LTRIM(RTRIM(TI052)) SiteCommRate,           LTRIM(RTRIM(TI053)) CommCalcInclTax,
        //                            LTRIM(RTRIM(TI054)) TotalCommAmount,        LTRIM(RTRIM(TI057)) TradingTerms,
        //                            LTRIM(RTRIM(TI058)) CustomerEgFullName,     LTRIM(RTRIM(TI061)) DebitNote,
        //                            LTRIM(RTRIM(TI064)) TaxCode,                LTRIM(RTRIM(TI066)) RemarkCode,
        //                            LTRIM(RTRIM(TI067)) MultipleInvoices,       LTRIM(RTRIM(TI068)) InvNumStart,
        //                            LTRIM(RTRIM(TI069)) NumberOfInvoices,       LTRIM(RTRIM(TI070)) MultiTaxRate,
        //                            LTRIM(RTRIM(TI071)) TaxCurrencyRate,        
        //                            LTRIM(RTRIM(TI075)) VoidTime,               LTRIM(RTRIM(TI076)) VoidRemark,
        //                            LTRIM(RTRIM(TI077)) IncomeDraftID,          LTRIM(RTRIM(TI078)) IncomeDraftSeq,
        //                            LTRIM(RTRIM(TI079)) IncomeVoucherType,      LTRIM(RTRIM(TI080)) IncomeVoucherNumber,
        //                            LTRIM(RTRIM(TI081)) [Status],               LTRIM(RTRIM(TI086)) GenLedgerAcctType,
        //                            LTRIM(RTRIM(TI087)) InvCode2,               LTRIM(RTRIM(TI088)) InvSymbol,
        //                            LTRIM(RTRIM(TI091)) ContactEmail,           LTRIM(RTRIM(TI092)) OrigInvNumber		
        //                            , CASE WHEN LEN(LTRIM(RTRIM(TI003))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TI003)) as date), 'yyyy-MM-dd') ELSE NULL END ReturnDate
        //                            , CASE WHEN LEN(LTRIM(RTRIM(TI017))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TI017)) as date), 'yyyy-MM-dd') ELSE NULL END InvoiceDate
        //                            , CASE WHEN LEN(LTRIM(RTRIM(TI034))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TI034)) as date), 'yyyy-MM-dd') ELSE NULL END DocDate
        //                            , CASE WHEN LEN(LTRIM(RTRIM(TI074))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TI074)) as date), 'yyyy-MM-dd') ELSE NULL END VoidDate
        //                            , CASE WHEN LEN(LTRIM(RTRIM(CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
        //                            , CASE WHEN LEN(LTRIM(RTRIM(CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
        //                            FROM COPTI
        //                            WHERE 1=1";
        //                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "RtErpFullNo", @" AND (LTRIM(RTRIM(TG001)) + '-' + LTRIM(RTRIM(TG002))) LIKE '%' + @RtErpFullNo + '%'", RtErpFullNo);
        //                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "SyncStartDate", @" AND (CREATE_DATE + ' ' + CREATE_TIME >= @SyncStartDate OR MODI_DATE + ' ' + MODI_TIME >= @SyncStartDate)", SyncStartDate.Length > 0 ? Convert.ToDateTime(SyncStartDate).ToString("yyyyMMdd 00:00:00") : "");
        //                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "SyncEndDate", @" AND (CREATE_DATE + ' ' + CREATE_TIME <= @SyncEndDate OR MODI_DATE + ' ' + MODI_TIME <= @SyncEndDate)", SyncEndDate.Length > 0 ? Convert.ToDateTime(SyncEndDate).ToString("yyyyMMdd 23:59:59") : ""); sql += @" ORDER BY TransferDate, TransferTime";

        //                    returnReceiveOrder = sqlConnection.Query<ReturnReceiveOrder>(sql, dynamicParameters).ToList();
        //                    #endregion

        //                    #region //撈取ERP銷退單身資料 
        //                    sql = @"SELECT  
        //                             LTRIM(RTRIM(TJ001)) RtErpPrefix                 ,LTRIM(RTRIM(TJ002)) RtErpNo
        //                            ,LTRIM(RTRIM(TJ003)) RtSequence                 ,LTRIM(RTRIM(TJ004)) MtlItemNo
        //                            ,LTRIM(RTRIM(TJ007)) Quantity                    ,LTRIM(RTRIM(TJ008)) UomNo
        //                            ,LTRIM(RTRIM(TJ011)) UnitPrice                   ,LTRIM(RTRIM(TJ012)) Amount
        //                            ,LTRIM(RTRIM(TJ013)) InventoryNo                 ,LTRIM(RTRIM(TJ014)) LotNumber
        //                            ,LTRIM(RTRIM(TJ015)) RoErpPrefix                 ,LTRIM(RTRIM(TJ016)) RoErpNo
        //                            ,LTRIM(RTRIM(TJ017)) RoSequence
        //                            ,LTRIM(RTRIM(TJ018)) SoErpPrefix                 ,LTRIM(RTRIM(TJ019)) SoErpNo
        //                            ,LTRIM(RTRIM(TJ020)) SoSequence
        //                            ,LTRIM(RTRIM(TJ021)) ConfirmStatus               ,LTRIM(RTRIM(TJ022)) UpdateCode
        //                            ,LTRIM(RTRIM(TJ023)) Remarks                     ,LTRIM(RTRIM(TJ024)) CheckOutCode
        //                            ,LTRIM(RTRIM(TJ025)) CheckOutPrefix              ,LTRIM(RTRIM(TJ026)) CheckOutNo
        //                            ,LTRIM(RTRIM(TJ027)) CheckOutSeq                 ,LTRIM(RTRIM(TJ028)) ProjectCode
        //                            ,LTRIM(RTRIM(TJ029)) CustomerMtlItemNo           ,LTRIM(RTRIM(TJ030)) Type
        //                            ,LTRIM(RTRIM(TJ031)) OrigPreTaxAmt               ,LTRIM(RTRIM(TJ032)) OrigTaxAmt
        //                            ,LTRIM(RTRIM(TJ033)) PreTaxAmt                   ,LTRIM(RTRIM(TJ034)) TaxAmt
        //                            ,LTRIM(RTRIM(TJ035)) PackageQty                  ,LTRIM(RTRIM(TJ036)) PackageUomNo
        //                            ,LTRIM(RTRIM(TJ037)) BondedCode                  ,LTRIM(RTRIM(TJ038)) CommissionRate
        //                            ,LTRIM(RTRIM(TJ039)) CommissionAmount            ,LTRIM(RTRIM(TJ040)) OriginalCustomer
        //                            ,LTRIM(RTRIM(TJ041)) FreeSpareType               ,LTRIM(RTRIM(TJ042)) FreeSpareQty
        //                            ,LTRIM(RTRIM(TJ043)) PackageFreeSpareQty         ,LTRIM(RTRIM(TJ048)) NotPayTemp
        //                            ,LTRIM(RTRIM(TJ049)) Location                    ,LTRIM(RTRIM(TJ050)) AvailableQty
        //                            ,LTRIM(RTRIM(TJ051)) AvailableUomNo              ,LTRIM(RTRIM(TJ058)) TaxRate
        //                            ,LTRIM(RTRIM(TJ070)) TaxCode                     ,LTRIM(RTRIM(TJ071)) DiscountAmount
        //                            , CASE WHEN LEN(LTRIM(RTRIM(CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
        //                            , CASE WHEN LEN(LTRIM(RTRIM(CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
        //                            FROM COPTJ
        //                            WHERE 1=1";
        //                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "RtErpFullNo", @" AND (LTRIM(RTRIM(TJ001)) + '-' + LTRIM(RTRIM(TJ002))) LIKE '%' + @RtErpFullNo + '%'", RtErpFullNo);
        //                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "SyncStartDate", @" AND (CREATE_DATE + ' ' + CREATE_TIME >= @SyncStartDate OR MODI_DATE + ' ' + MODI_TIME >= @SyncStartDate)", SyncStartDate.Length > 0 ? Convert.ToDateTime(SyncStartDate).ToString("yyyyMMdd 00:00:00") : "");
        //                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "SyncEndDate", @" AND (CREATE_DATE + ' ' + CREATE_TIME <= @SyncEndDate OR MODI_DATE + ' ' + MODI_TIME <= @SyncEndDate)", SyncEndDate.Length > 0 ? Convert.ToDateTime(SyncEndDate).ToString("yyyyMMdd 23:59:59") : ""); sql += @" ORDER BY TransferDate, TransferTime";

        //                    rtDetails = sqlConnection.Query<RtDetail>(sql, dynamicParameters).ToList();
        //                    #endregion
        //                }
        //                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
        //                {
        //                    #region //撈取客戶ID
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT CustomerId, CustomerNo 
        //                            FROM SCM.Customer
        //                            WHERE CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);

        //                    List<Customer> resultCustomers = sqlConnection.Query<Customer>(sql, dynamicParameters).ToList();

        //                    returnReceiveOrder = returnReceiveOrder.Join(resultCustomers, x => x.CustomerNo, y => y.CustomerNo, (x, y) => { x.CustomerId = y.CustomerId; return x; }).ToList();
        //                    #endregion

        //                    #region //撈取部門ID
        //                    sql = @"SELECT DepartmentId, DepartmentNo
        //                            FROM BAS.Department
        //                            WHERE CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);
        //                    List<Department> resultDepartments = sqlConnection.Query<Department>(sql, dynamicParameters).ToList();
        //                    returnReceiveOrder = returnReceiveOrder.GroupJoin(resultDepartments, x => x.DepartmentNo, y => y.DepartmentNo, (x, y) => { x.DepartmentId = y.FirstOrDefault()?.DepartmentId; return x; }).ToList();
        //                    #endregion

        //                    #region //撈取業務人員ID
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT a.UserId, a.UserNo 
        //                            FROM BAS.[User] a";
        //                    List<User> resultUser = sqlConnection.Query<User>(sql, dynamicParameters).ToList();
        //                    returnReceiveOrder = returnReceiveOrder.GroupJoin(resultUser, x => x.SalesmenNo, y => y.UserNo, (x, y) => { x.SalesmenId = y.FirstOrDefault()?.UserId; return x; }).ToList();
        //                    returnReceiveOrder = returnReceiveOrder.GroupJoin(resultUser, x => x.ConfirmUserNo, y => y.UserNo, (x, y) => { x.ConfirmUserId = y.FirstOrDefault()?.UserId; return x; }).ToList();
        //                    returnReceiveOrder = returnReceiveOrder.GroupJoin(resultUser, x => x.CollectionSalesmenNo, y => y.UserNo, (x, y) => { x.CollectionSalesmenId = y.FirstOrDefault()?.UserId; return x; }).ToList();
        //                    returnReceiveOrder = returnReceiveOrder.GroupJoin(resultUser, x => x.StaffNo, y => y.UserNo, (x, y) => { x.StaffId = y.FirstOrDefault()?.UserId; return x; }).ToList();
        //                    #endregion

        //                    #region //撈取單位ID
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT UomId, UomNo
        //                            FROM PDM.UnitOfMeasure
        //                            WHERE CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);
        //                    List<Uom> resultSoPriceUomrNos = sqlConnection.Query<Uom>(sql, dynamicParameters).ToList();
        //                    rtDetails = rtDetails.Join(resultSoPriceUomrNos, x => x.AvailableUomNo.ToUpper(), y => y.UomNo, (x, y) => { x.AvailableUomId = y.UomId; return x; }).ToList();
        //                    rtDetails = rtDetails.Join(resultSoPriceUomrNos, x => x.UomNo.ToUpper(), y => y.UomNo, (x, y) => { x.UomId = y.UomId; return x; }).ToList();
        //                    rtDetails = rtDetails.GroupJoin(resultSoPriceUomrNos, x => x.PackageUomNo.ToUpper(), y => y.UomNo, (x, y) => { x.PackageUomId = y.FirstOrDefault()?.UomId; return x; }).ToList();
        //                    #endregion

        //                    #region //撈取品號ID
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT MtlItemId, MtlItemNo
        //                            FROM PDM.MtlItem
        //                            WHERE CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);
        //                    List<MtlItem> resultMtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();
        //                    rtDetails = rtDetails.Join(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
        //                    #endregion

        //                    #region //撈取庫別ID
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT InventoryId, InventoryNo
        //                            FROM SCM.Inventory
        //                            WHERE CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);
        //                    List<Inventory> resultInventories = sqlConnection.Query<Inventory>(sql, dynamicParameters).ToList();
        //                    rtDetails = rtDetails.Join(resultInventories, x => x.InventoryNo, y => y.InventoryNo, (x, y) => { x.InventoryId = y.InventoryId; return x; }).ToList();
        //                    #endregion

        //                    #region //判斷訂單是否有資料
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT a.SoDetailId, a.SoId,b.SoErpPrefix,b.SoErpNo, a.SoSequence
        //                            FROM SCM.SoDetail a
        //                            INNER JOIN SCM.SaleOrder b ON a.SoId = b.SoId
        //                            WHERE b.CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);

        //                    List<SoDetail> resultSoDetails = sqlConnection.Query<SoDetail>(sql, dynamicParameters).ToList();

        //                    rtDetails = rtDetails.GroupJoin(resultSoDetails, x => new { x.SoErpPrefix, x.SoErpNo, x.SoSequence }, y => new { y.SoErpPrefix, y.SoErpNo, y.SoSequence }, (x, y) => { x.SoDetailId = y.FirstOrDefault()?.SoDetailId; return x; }).ToList();
        //                    #endregion

        //                    #region //判斷銷貨單是否有資料
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT a.RoDetailId,b.RoId, b.RoErpPrefix, b.RoErpNo, a.RoSequence
        //                            FROM SCM.RoDetail a 
        //                            INNER JOIN SCM.ReceiveOrder b ON a.RoId = b.RoId
        //                            WHERE CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);
        //                    List<RoDetail> resultRoDetail = sqlConnection.Query<RoDetail>(sql, dynamicParameters).ToList();
        //                    rtDetails = rtDetails.GroupJoin(resultRoDetail, x => new { x.RoErpPrefix, x.RoErpNo, x.RoSequence }, y => new { y.RoErpPrefix, y.RoErpNo, y.RoSequence }, (x, y) => { x.RoDetailId = y.FirstOrDefault()?.RoDetailId; return x; }).Select(x => x).ToList();
        //                    #endregion

        //                    #region //判斷銷退單是否有資料
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT RtId, RtErpPrefix, RtErpNo
        //                            FROM SCM.ReturnReceiveOrder
        //                            WHERE CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);
        //                    List<ReturnReceiveOrder> resultReturnReceiveOrder = sqlConnection.Query<ReturnReceiveOrder>(sql, dynamicParameters).ToList();
        //                    returnReceiveOrder = returnReceiveOrder.GroupJoin(resultReturnReceiveOrder, x => new { x.RtErpPrefix, x.RtErpNo }, y => new { y.RtErpPrefix, y.RtErpNo }, (x, y) => { x.RtId = y.FirstOrDefault()?.RtId; return x; }).Select(x => x).ToList();
        //                    #endregion

        //                    #region //銷貨單單頭(新增/修改)
        //                    List<ReturnReceiveOrder> addReturnReceiveOrders = returnReceiveOrder.Where(x => x.RtId == null).ToList();
        //                    List<ReturnReceiveOrder> updateReturnReceiveOrders = returnReceiveOrder.Where(x => x.RtId != null).ToList();

        //                    #region //新增
        //                    dynamicParameters = new DynamicParameters();
        //                    if (addReturnReceiveOrders.Count > 0)
        //                    {
        //                        addReturnReceiveOrders
        //                            .ToList()
        //                            .ForEach(x =>
        //                            {
        //                                x.CompanyId = CurrentCompany;
        //                                x.TransferStatusMES = "Y";
        //                                x.CreateDate = CreateDate;
        //                                x.LastModifiedDate = LastModifiedDate;
        //                                x.CreateBy = CreateBy;
        //                                x.LastModifiedBy = LastModifiedBy;
        //                            });

        //                        #region //新增單頭資料表
        //                        sql = @"INSERT INTO SCM.ReturnReceiveOrder (CompanyId, RtErpPrefix, RtErpNo, ReturnDate, CustomerId, DepartmentId, 
        //                                SalesmenId, Factory, Currency, ExchangeRate, OriginalAmount, OriginalTaxAmount, InvoiceType, TaxType, 
        //                                InvNumEnd, UiNo, PrintCount, InvoiceDate, UpdateCode, ConfirmStatus, Remark, CustomerFullName, 
        //                                CollectionSalesmenId, Remark1, Remark2, Remark3, DeductionDistinction, CustomsClearance, RowCnt, 
        //                                TotalQuantity, StaffId, RevenueJournalCode, CostJournalCode, ApplyYYMM, DocDate, ConfirmUserId, TaxRate, 
        //                                PretaxAmount, TaxAmount, PaymentTerm, TotalPackages, SignatureStatus, ProcessCode, TransferStatusERP, 
        //                                BondCode, TransmissionCount, CustomerAddressFirst, CustomerAddressSecond, ContactPerson, Courier, 
        //                                SiteCommCalcMethod, SiteCommRate, CommCalcInclTax, TotalCommAmount, TradingTerms, CustomerEgFullName, 
        //                                DebitNote, TaxCode, RemarkCode, MultipleInvoices, InvNumStart, NumberOfInvoices, MultiTaxRate, 
        //                                TaxCurrencyRate, VoidDate, VoidTime, VoidRemark, IncomeDraftID, IncomeDraftSeq, IncomeVoucherType, 
        //                                IncomeVoucherNumber, Status, GenLedgerAcctType, InvCode2, InvSymbol, ContactEmail, OrigInvNumber, 
        //                                TransferStatusMES, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
        //                                VALUES ( @CompanyId, @RtErpPrefix, @RtErpNo, @ReturnDate, @CustomerId, @DepartmentId, 
        //                                @SalesmenId, @Factory, @Currency, @ExchangeRate, @OriginalAmount, @OriginalTaxAmount, @InvoiceType, @TaxType, 
        //                                @InvNumEnd, @UiNo, @PrintCount, @InvoiceDate, @UpdateCode, @ConfirmStatus, @Remark, @CustomerFullName, 
        //                                @CollectionSalesmenId, @Remark1, @Remark2, @Remark3, @DeductionDistinction, @CustomsClearance, @RowCnt, 
        //                                @TotalQuantity, @StaffId, @RevenueJournalCode, @CostJournalCode, @ApplyYYMM, @DocDate, @ConfirmUserId, @TaxRate, 
        //                                @PretaxAmount, @TaxAmount, @PaymentTerm, @TotalPackages, @SignatureStatus, @ProcessCode, @TransferStatusERP, 
        //                                @BondCode, @TransmissionCount, @CustomerAddressFirst, @CustomerAddressSecond, @ContactPerson, @Courier, 
        //                                @SiteCommCalcMethod, @SiteCommRate, @CommCalcInclTax, @TotalCommAmount, @TradingTerms, @CustomerEgFullName, 
        //                                @DebitNote, @TaxCode, @RemarkCode, @MultipleInvoices, @InvNumStart, @NumberOfInvoices, @MultiTaxRate, 
        //                                @TaxCurrencyRate, @VoidDate, @VoidTime, @VoidRemark, @IncomeDraftID, @IncomeDraftSeq, @IncomeVoucherType, 
        //                                @IncomeVoucherNumber, @Status, @GenLedgerAcctType, @InvCode2, @InvSymbol, @ContactEmail, @OrigInvNumber, 
        //                                @TransferStatusMES, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
        //                        int addMain = sqlConnection.Execute(sql, addReturnReceiveOrders);
        //                        mainAffected += addMain;
        //                        #endregion

        //                    }
        //                    #endregion

        //                    #region //修改
        //                    dynamicParameters = new DynamicParameters();
        //                    if (updateReturnReceiveOrders.Count > 0)
        //                    {
        //                        updateReturnReceiveOrders
        //                            .ToList()
        //                            .ForEach(x =>
        //                            {
        //                                x.TransferStatusMES = "Y";
        //                                x.LastModifiedDate = LastModifiedDate;
        //                                x.LastModifiedBy = LastModifiedBy;
        //                            });

        //                        #region //更新單頭資料表
        //                        dynamicParameters = new DynamicParameters();
        //                        sql = @"UPDATE SCM.ReturnReceiveOrder SET
        //                                ReturnDate			= @ReturnDate,			
        //                                CustomerId			= @CustomerId,			
        //                                DepartmentId		= @DepartmentId,			
        //                                SalesmenId			= @SalesmenId,			
        //                                Factory				= @Factory,				
        //                                Currency			= @Currency,				
        //                                ExchangeRate		= @ExchangeRate,			
        //                                OriginalAmount		= @OriginalAmount,		
        //                                OriginalTaxAmount	= @OriginalTaxAmount,	
        //                                InvoiceType			= @InvoiceType,			
        //                                TaxType				= @TaxType,				
        //                                InvNumEnd			= @InvNumEnd,			
        //                                UiNo				= @UiNo,					
        //                                PrintCount			= @PrintCount,			
        //                                InvoiceDate			= @InvoiceDate,			
        //                                UpdateCode			= @UpdateCode,			
        //                                ConfirmStatus		= @ConfirmStatus,		
        //                                Remark				= @Remark,				
        //                                CustomerFullName	= @CustomerFullName,		
        //                                CollectionSalesmenId= @CollectionSalesmenId,	
        //                                Remark1				= @Remark1,				
        //                                Remark2				= @Remark2,				
        //                                Remark3				= @Remark3,				
        //                                DeductionDistinction= @DeductionDistinction,	
        //                                CustomsClearance	= @CustomsClearance,		
        //                                RowCnt				= @RowCnt,				
        //                                TotalQuantity		= @TotalQuantity,		
        //                                StaffId				= @StaffId,				
        //                                RevenueJournalCode	= @RevenueJournalCode,	
        //                                CostJournalCode		= @CostJournalCode,		
        //                                ApplyYYMM			= @ApplyYYMM,			
        //                                DocDate				= @DocDate,				
        //                                ConfirmUserId		= @ConfirmUserId,		
        //                                TaxRate				= @TaxRate,				
        //                                PretaxAmount		= @PretaxAmount,			
        //                                TaxAmount			= @TaxAmount,			
        //                                PaymentTerm			= @PaymentTerm,			
        //                                TotalPackages		= @TotalPackages,		
        //                                SignatureStatus		= @SignatureStatus,	
        //                                ProcessCode			= @ProcessCode,		
        //                                TransferStatusERP	= @TransferStatusERP,	
        //                                BondCode			= @BondCode,				
        //                                TransmissionCount	= @TransmissionCount,	
        //                                CustomerAddressFirst= @CustomerAddressFirst,	
        //                                CustomerAddressSecond= @CustomerAddressSecond,
        //                                ContactPerson		= @ContactPerson,		
        //                                Courier				= @Courier,				
        //                                SiteCommCalcMethod	= @SiteCommCalcMethod,	
        //                                SiteCommRate		= @SiteCommRate,		
        //                                CommCalcInclTax		= @CommCalcInclTax,		
        //                                TotalCommAmount		= @TotalCommAmount,		
        //                                TradingTerms		= @TradingTerms,			
        //                                CustomerEgFullName	= @CustomerEgFullName,	
        //                                DebitNote			= @DebitNote,			
        //                                TaxCode				= @TaxCode,				
        //                                RemarkCode			= @RemarkCode,			
        //                                MultipleInvoices	= @MultipleInvoices,		
        //                                InvNumStart			= @InvNumStart,			
        //                                NumberOfInvoices	= @NumberOfInvoices,		
        //                                MultiTaxRate		= @MultiTaxRate,			
        //                                TaxCurrencyRate		= @TaxCurrencyRate,		
        //                                VoidDate			= @VoidDate,				
        //                                VoidTime			= @VoidTime,				
        //                                VoidRemark			= @VoidRemark,			
        //                                IncomeDraftID		= @IncomeDraftID,		
        //                                IncomeDraftSeq		= @IncomeDraftSeq,		
        //                                IncomeVoucherType	= @IncomeVoucherType,	
        //                                IncomeVoucherNumber	= @IncomeVoucherNumber,
        //                                Status			    = @Status,				
        //                                GenLedgerAcctType	= @GenLedgerAcctType,	
        //                                InvCode2			= @InvCode2,			
        //                                InvSymbol			= @InvSymbol,			
        //                                ContactEmail		= @ContactEmail,			
        //                                OrigInvNumber		= @OrigInvNumber,		
        //                                TransferStatusMES	= @TransferStatusMES,	
        //                                LastModifiedDate	= @LastModifiedDate,		
        //                                LastModifiedBy		= @LastModifiedBy	
        //                                WHERE RtId = @RtId";
        //                        int updateMain = sqlConnection.Execute(sql, updateReturnReceiveOrders);
        //                        mainAffected += updateMain;
        //                        #endregion
        //                    }
        //                    #endregion
        //                    #endregion

        //                    #region //銷貨單單身(新增/修改)
        //                    #region //撈取銷退單單頭ID
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT RtId, RtErpPrefix, RtErpNo
        //                            FROM SCM.ReturnReceiveOrder
        //                            WHERE CompanyId = @CompanyId
        //                            ORDER BY RtId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);

        //                    resultReturnReceiveOrder = sqlConnection.Query<ReturnReceiveOrder>(sql, dynamicParameters).ToList();

        //                    rtDetails = rtDetails.Join(resultReturnReceiveOrder, x => new { x.RtErpPrefix, x.RtErpNo }, y => new { y.RtErpPrefix, y.RtErpNo }, (x, y) => { x.RtId = y.RtId; return x; }).Select(x => x).ToList();
        //                    #endregion

        //                    #region //判斷SCM.RtDetail是否有資料
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT a.RtDetailId, a.RtId, a.RtSequence
        //                            FROM SCM.RtDetail a
        //                            INNER JOIN SCM.ReturnReceiveOrder b ON a.RtId = b.RtId
        //                            WHERE b.CompanyId = @CompanyId";
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);

        //                    List<RtDetail> resultRtDetails = sqlConnection.Query<RtDetail>(sql, dynamicParameters).ToList();

        //                    rtDetails = rtDetails.GroupJoin(resultRtDetails, x => new { x.RtId, x.RtSequence }, y => new { y.RtId, y.RtSequence }, (x, y) => { x.RtDetailId = y.FirstOrDefault()?.RtDetailId; return x; }).ToList();
        //                    #endregion

        //                    List<RtDetail> addRtDetails = rtDetails.Where(x => x.RtDetailId == null).ToList();
        //                    List<RtDetail> updateRtDetails = rtDetails.Where(x => x.RtDetailId != null).ToList();

        //                    #region //新增
        //                    dynamicParameters = new DynamicParameters();
        //                    if (addRtDetails.Count > 0)
        //                    {
        //                        addRtDetails
        //                            .ToList()
        //                            .ForEach(x =>
        //                            {
        //                                x.TransferStatusMES = "Y";
        //                                x.CreateDate = CreateDate;
        //                                x.LastModifiedDate = LastModifiedDate;
        //                                x.CreateBy = CreateBy;
        //                                x.LastModifiedBy = LastModifiedBy;
        //                            });
        //                        sql = @"INSERT INTO SCM.RtDetail (RtId, RtSequence, MtlItemId, Quantity, UomId, UnitPrice, Amount, InventoryId, LotNumber, 
        //                                RoDetailId, SoDetailId, ConfirmStatus, UpdateCode, Remarks, CheckOutCode, CheckOutPrefix, CheckOutNo, 
        //                                CheckOutSeq, ProjectCode, CustomerMtlItemNo, Type, OrigPreTaxAmt, OrigTaxAmt, PreTaxAmt, TaxAmt, PackageQty, 
        //                                PackageUomId, BondedCode, CommissionRate, CommissionAmount, OriginalCustomer, FreeSpareType, 
        //                                FreeSpareQty, PackageFreeSpareQty, NotPayTemp, Location, AvailableQty, AvailableUomId, TaxRate, TaxCode, 
        //                                DiscountAmount, TransferStatusMES, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
        //                                VALUES ( @RtId, @RtSequence, @MtlItemId, @Quantity, @UomId, @UnitPrice, @Amount, @InventoryId, @LotNumber, 
        //                                @RoDetailId, @SoDetailId, @ConfirmStatus, @UpdateCode, @Remarks, @CheckOutCode, @CheckOutPrefix, @CheckOutNo, 
        //                                @CheckOutSeq, @ProjectCode, @CustomerMtlItemNo, @Type, @OrigPreTaxAmt, @OrigTaxAmt, @PreTaxAmt, @TaxAmt, @PackageQty, 
        //                                @PackageUomId, @BondedCode, @CommissionRate, @CommissionAmount, @OriginalCustomer, @FreeSpareType, 
        //                                @FreeSpareQty, @PackageFreeSpareQty, @NotPayTemp, @Location, @AvailableQty, @AvailableUomId, @TaxRate, @TaxCode, 
        //                                @DiscountAmount, @TransferStatusMES, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy
        //                                )";
        //                        int addDetail = sqlConnection.Execute(sql, addRtDetails);
        //                        detailAffected += addDetail;
        //                    }
        //                    #endregion

        //                    #region //修改
        //                    dynamicParameters = new DynamicParameters();
        //                    if (updateRtDetails.Count > 0)
        //                    {
        //                        updateRtDetails
        //                            .ToList()
        //                            .ForEach(x =>
        //                            {
        //                                x.TransferStatusMES = "Y";
        //                                x.LastModifiedDate = LastModifiedDate;
        //                                x.LastModifiedBy = LastModifiedBy;
        //                            });

        //                        sql = @"UPDATE SCM.RtDetail SET
        //                                RtSequence = @RtSequence, 
        //                                MtlItemId = @MtlItemId, 
        //                                Quantity = @Quantity, 
        //                                UomId = @UomId, 
        //                                UnitPrice = @UnitPrice, 
        //                                Amount = @Amount, 
        //                                InventoryId = @InventoryId, 
        //                                LotNumber = @LotNumber, 
        //                                RoDetailId = @RoDetailId, 
        //                                SoDetailId = @SoDetailId, 
        //                                ConfirmStatus = @ConfirmStatus, 
        //                                UpdateCode = @UpdateCode, 
        //                                Remarks = @Remarks, 
        //                                CheckOutCode = @CheckOutCode, 
        //                                CheckOutPrefix = @CheckOutPrefix, 
        //                                CheckOutNo = @CheckOutNo, 
        //                                CheckOutSeq = @CheckOutSeq, 
        //                                ProjectCode = @ProjectCode, 
        //                                CustomerMtlItemNo = @CustomerMtlItemNo, 
        //                                Type = @Type, 
        //                                OrigPreTaxAmt = @OrigPreTaxAmt, 
        //                                OrigTaxAmt = @OrigTaxAmt, 
        //                                PreTaxAmt = @PreTaxAmt, 
        //                                TaxAmt = @TaxAmt, 
        //                                PackageQty = @PackageQty, 
        //                                PackageUomId = @PackageUomId, 
        //                                BondedCode = @BondedCode, 
        //                                CommissionRate = @CommissionRate, 
        //                                CommissionAmount = @CommissionAmount, 
        //                                OriginalCustomer = @OriginalCustomer, 
        //                                FreeSpareType = @FreeSpareType, 
        //                                FreeSpareQty = @FreeSpareQty, 
        //                                PackageFreeSpareQty = @PackageFreeSpareQty, 
        //                                NotPayTemp = @NotPayTemp, 
        //                                Location = @Location, 
        //                                AvailableQty = @AvailableQty, 
        //                                AvailableUomId = @AvailableUomId, 
        //                                TaxRate = @TaxRate, 
        //                                TaxCode = @TaxCode, 
        //                                DiscountAmount = @DiscountAmount, 
        //                                TransferStatusMES = @TransferStatusMES, 
        //                                LastModifiedDate = @LastModifiedDate, 
        //                                LastModifiedBy = @LastModifiedBy
        //                                WHERE RoDetailId = @RoDetailId";
        //                        int updateDetail = sqlConnection.Execute(sql, updateRtDetails);
        //                        detailAffected += updateDetail;
        //                    }
        //                    #endregion
        //                    #endregion
        //                }
        //            }
        //            #endregion

        //            if (TranSync == "Y")
        //            {
        //                using (SqlConnection erpConnection = new SqlConnection(ErpConnectionStrings))
        //                {
        //                    #region //ERP銷退單單頭資料
        //                    sql = @"SELECT TI001 RtErpPrefix, TI002 RtErpNo
        //                            FROM COPTI
        //                            WHERE 1=1
        //                            ORDER BY TI001, TI002";
        //                    var resultErpRt = erpConnection.Query<ReturnReceiveOrder>(sql, dynamicParameters);
        //                    #endregion

        //                    using (SqlConnection bmConnection = new SqlConnection(MainConnectionStrings))
        //                    {
        //                        #region //BM銷退單單頭資料
        //                        sql = @"SELECT RtErpPrefix, RtErpNo
        //                                FROM SCM.ReturnReceiveOrder
        //                                WHERE CompanyId = @CompanyId
        //                                ORDER BY RtErpPrefix, RtErpNo";
        //                        dynamicParameters.Add("CompanyId", CurrentCompany);
        //                        var resultBmRt = bmConnection.Query<ReturnReceiveOrder>(sql, dynamicParameters);
        //                        #endregion

        //                        #region //篩選ERP不存在但BM還存在的訂單單頭
        //                        var dictionaryErpRt = resultErpRt.ToDictionary(x => x.RtErpPrefix + "-" + x.RtErpNo, x => x.RtErpPrefix + "-" + x.RtErpNo);
        //                        var dictionaryBmRt = resultBmRt.ToDictionary(x => x.RtErpPrefix + "-" + x.RtErpNo, x => x.RtErpPrefix + "-" + x.RtErpNo);
        //                        var changeRo = dictionaryBmRt.Where(x => !dictionaryErpRt.ContainsKey(x.Key)).ToList();
        //                        var changeRoList = changeRo.Select(x => x.Value).ToList();
        //                        #endregion

        //                        #region //刪除異動訂單單頭
        //                        if (changeRoList.Count > 0)
        //                        {
        //                            #region //單身刪除
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"DELETE SCM.RtDetail
        //                                    WHERE RoId IN (
        //                                        SELECT RtId
        //                                        FROM SCM.ReturnReceiveOrder
        //                                        WHERE RtErpPrefix + '-' + RtErpNo IN @RtErpFullNo
        //                                    )";
        //                            dynamicParameters.Add("RtErpFullNo", changeRoList.Select(x => x).ToArray());
        //                            mainDelAffected += bmConnection.Execute(sql, dynamicParameters);
        //                            #endregion

        //                            #region //單頭刪除
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"DELETE SCM.ReturnReceiveOrder
        //                                    WHERE RtErpPrefix + '-' + RtErpNo IN @RtErpFullNo";
        //                            dynamicParameters.Add("RtErpFullNo", changeRoList.Select(x => x).ToArray());
        //                            detailDelAffected += bmConnection.Execute(sql, dynamicParameters);
        //                            #endregion
        //                        }
        //                        #endregion


        //                    }

        //                    #region //ERP銷退單身資料
        //                    sql = @"SELECT TJ001 RtErpPrefix, TJ002 RtErpNo, TJ003 RtSequence
        //                            FROM COPTJ
        //                            WHERE 1=1
        //                            ORDER BY TJ001, TJ002, TJ003";
        //                    var resultErpRtDetail = erpConnection.Query<RtDetail>(sql, dynamicParameters);
        //                    #endregion

        //                    using (SqlConnection bmConnection = new SqlConnection(MainConnectionStrings))
        //                    {
        //                        #region //BM銷退單單身資料
        //                        sql = @"SELECT b.RtErpPrefix, b.RtErpNo, a.RtSequence
        //                                FROM SCM.RtDetail a
        //                                INNER JOIN SCM.ReturnReceiveOrder b ON a.RtId = b.RtId
        //                                WHERE b.CompanyId = @CompanyId
        //                                ORDER BY b.RtErpPrefix, b.RtErpNo, a.RtSequence";
        //                        dynamicParameters.Add("CompanyId", CurrentCompany);
        //                        var resultBmRtDetail = bmConnection.Query<RtDetail>(sql, dynamicParameters);
        //                        #endregion

        //                        #region //篩選ERP不存在但BM還存在的銷退單單身
        //                        var dictionaryErpRtDetail = resultErpRtDetail.ToDictionary(x => x.RtErpPrefix + "-" + x.RtErpNo + "-" + x.RtSequence, x => x.RtErpPrefix + "-" + x.RtErpNo + "-" + x.RtSequence);
        //                        var dictionaryBmRtDetail = resultBmRtDetail.ToDictionary(x => x.RtErpPrefix + "-" + x.RtErpNo + "-" + x.RtSequence, x => x.RtErpPrefix + "-" + x.RtErpNo + "-" + x.RtSequence);
        //                        var changeRoDetail = dictionaryBmRtDetail.Where(x => !dictionaryErpRtDetail.ContainsKey(x.Key)).ToList();
        //                        var changeRoDetailList = changeRoDetail.Select(x => x.Value).ToList();
        //                        #endregion

        //                        #region //刪除訂單單身
        //                        if (changeRoDetailList.Count > 0)
        //                        {
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"DELETE a
        //                                    FROM SCM.RtDetail a
        //                                    INNER JOIN SCM.ReturnReceiveOrder b ON a.RtId = b.RtId
        //                                    WHERE b.RtErpPrefix + '-' + b.RtErpNo + '-' + RIGHT('0000' + a.Sequence, 4) IN @RtErpFullNo";
        //                            dynamicParameters.Add("RtErpFullNo", changeRoDetailList.Select(x => x).ToArray());
        //                            detailDelAffected += bmConnection.Execute(sql, dynamicParameters, null, 300);
        //                        }
        //                        #endregion
        //                    }
        //                }
        //            }

        //            #region //Response
        //            jsonResponse = JObject.FromObject(new
        //            {
        //                status = "success",
        //                msg = "(" + mainAffected + detailAffected + " rows affected)",
        //                data = "已更新資料<br />【" + mainAffected + "】筆單頭<br />【" + detailAffected + "】筆單身<br />刪除<br />【" + mainDelAffected + "】筆單頭<br />【" + detailDelAffected + "】筆單身"
        //            });
        //            #endregion

        //            transactionScope.Complete();
        //        }
        //    }
        //    catch (Exception e)
        //    {
        //        #region //Response
        //        jsonResponse = JObject.FromObject(new
        //        {
        //            status = "errorForDA",
        //            msg = e.Message
        //        });
        //        #endregion

        //        logger.Error(e.Message);
        //    }
        //    return jsonResponse.ToString();
        //}
        #endregion

        #region //UpdateErpModify -- (未完成)ERP工單變更 -- Ted 2022.08.23
        //public string UpdateErpModify(int WoId, string ModifyDate, int SoDetailId, int UomId, int InventoryId, int PlanQty
        //    , string ExpectedStart, string ExpectedEnd, int UserId, string ModiReason, string WoRemark, string Project)
        //{
        //    try
        //    {
        //        if (ModifyDate.Length <= 0) throw new SystemException("【變更日期】不能為空!");
        //        if (InventoryId <= 0) throw new SystemException("【入庫庫別】不能為空!");
        //        if (PlanQty <= 0) throw new SystemException("【預計產量】不能為空!");

        //        string dateNow = DateTime.Now.ToString("yyyyMMdd");
        //        string timeNow = DateTime.Now.ToString("HH:mm:ss");
        //        int userId = BaseHelper.CurrentUser();
        //        string WoErpPrefix;
        //        string WoErpNo;
        //        int rowsAffected = 0;
        //        int mesWoDetailNum = 0;

        //        DynamicParameters dynamicParameters = new DynamicParameters();
        //        //MES工單檢查
        //        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
        //        {
        //            #region //確認資料
        //            #region //判斷工單資料是否正確
        //            dynamicParameters = new DynamicParameters();
        //            sql = @"SELECT WoErpPrefix, WoErpNo, ConfirmStatus
        //                        FROM MES.WipOrder
        //                        WHERE WoId = @WoId";
        //            dynamicParameters.Add("WoId", WoId);
        //            var result = sqlConnection.Query(sql, dynamicParameters);
        //            if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");
        //            WoErpPrefix = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoErpPrefix;
        //            WoErpNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoErpNo;
        //            #endregion

        //            #region //判斷工單單身資料是否正確
        //            dynamicParameters = new DynamicParameters();
        //            sql = @"SELECT ConfirmStatus
        //                        FROM MES.WoDetail
        //                        WHERE WoId = @WoId";
        //            dynamicParameters.Add("WoId", WoId);
        //            var result2 = sqlConnection.Query(sql, dynamicParameters);
        //            if (result2.Count() <= 0) throw new SystemException("MES製令資料錯誤!");
        //            #endregion
        //            #endregion
        //        }
        //        //ERP工單檢查
        //        using (SqlConnection sqlConnectionERP = new SqlConnection(ErpConnectionStrings))
        //        {
        //            #region //確認資料
        //            #region //判斷工單資料是否正確
        //            dynamicParameters = new DynamicParameters();
        //            sql = @"SELECT TA001, TA002, TA013
        //                    FROM MOCTA
        //                    WHERE TA001 = @WoErpPrefix
        //                    AND TA002 = @WoErpNo";
        //            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
        //            dynamicParameters.Add("WoErpNo", WoErpNo);
        //            var result1 = sqlConnectionERP.Query(sql, dynamicParameters);
        //            if (result1.Count() <= 0) throw new SystemException("ERP製令資料錯誤!");
        //            mesWoDetailNum = result1.Count();
        //            #endregion

        //            #region //判斷工單資料是否正確
        //            dynamicParameters = new DynamicParameters();
        //            sql = @"SELECT TB001, TB002, TB018
        //                    FROM MOCTB
        //                    WHERE TB001 = @WoErpPrefix
        //                    AND TB002 = @WoErpNo";
        //            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
        //            dynamicParameters.Add("WoErpNo", WoErpNo);
        //            var result2 = sqlConnectionERP.Query(sql, dynamicParameters);
        //            if (result2.Count() != mesWoDetailNum)
        //            {
        //                if (result2.Count() < mesWoDetailNum)
        //                {
        //                    throw new SystemException("ERP工單單身資料少於MES工單單身!");
        //                }
        //                else
        //                {
        //                    throw new SystemException("ERP工單單身資料大於MES工單單身!");
        //                }
        //            }
        //            #endregion
        //            #endregion

        //        }











        //        List <MOCTA> wipOrders = new List<MOCTA>();
        //        List<MOCTB> wipDetails = new List<MOCTB>();

        //        string dateNow = DateTime.Now.ToString("yyyyMMdd");
        //        string timeNow = DateTime.Now.ToString("HH:mm:ss");
        //        int userId = BaseHelper.CurrentUser();

        //        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
        //        {
        //            DynamicParameters dynamicParameters = new DynamicParameters();

        //            #region //撈取BM工單單頭資料
        //            sql = @"SELECT a.WoId, a.CompanyId, a.WoErpPrefix TA001, a.WoErpNo TA002, a.Version TA062, FORMAT(a.DocDate, 'yyyyMMdd') TA003
        //                    , a.PlanQty TA015, a.RequisitionSetQty TA016, a.StockInQty TA017, a.ScrapQty TA018
        //                    , ISNULL(FORMAT(a.ExpectedStart, 'yyyyMMdd'), '') TA009, ISNULL(FORMAT(a.ExpectedEnd, 'yyyyMMdd'), '') TA010
        //                    , FORMAT(a.ActualStart, 'yyyyMMdd') TA012, FORMAT(a.ActualEnd, 'yyyyMMdd') TA014
        //                    , FORMAT(a.BomDate, 'yyyyMMdd') TA004, a.BomVersion TA005, a.UrgentMtl TA044, a.Property TA030
        //                    , a.Project TA551, a.WoRemark TA029
        //                    , FORMAT(a.ConfirmDate, 'yyyyMMdd') TA040, a.WoStatus TA011 ,a.ConfirmStatus TA013, a.TransferStatus, a.TransferDate
        //                    , b.MtlItemNo TA006, b.MtlItemName TA034, b.MtlItemSpec TA035
        //                    , c.InventoryNo TA020
        //                    , d.UomNo TA007
        //                    , e.UserNo TA055
        //                    , f.SoSequence TA028
        //                    , g.SoErpPrefix TA026 ,g.SoErpNo TA027
        //                    FROM MES.WipOrder a
        //                    INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
        //                    INNER JOIN SCM.Inventory c ON a.InventoryId = c.InventoryId
        //                    INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
        //                    INNER JOIN BAS.[User] e ON a.UserId = e.UserId
        //                    LEFT JOIN SCM.SoDetail f ON a.SoDetailId = f.SoDetailId
        //                    LEFT JOIN SCM.SaleOrder g ON f.SoId = g.SoId
        //                    WHERE a.WoId = @WoId";
        //            dynamicParameters.Add("WoId", WoId);

        //            string OrderBy = "WoId";
        //            wipOrders = BaseHelper.SqlQuery<MOCTA>(sqlConnection, sql, dynamicParameters, OrderBy);
        //            #endregion

        //            #region //撈取BM工單單身資料
        //            dynamicParameters = new DynamicParameters();
        //            sql = @"SELECT a.WoId,a.WoDetailId, a.DemandRequisitionQty TB004, a.RequisitionQty TB005, a.Substitute TB010
        //                    ,a.WipDetailRemark TB017,a.ConfirmStatus TB018
        //                    , FORMAT(a.ExpectedRequisitionDate, 'yyyyMMdd') TB015
        //                    , FORMAT(a.ActualRequisitionDate, 'yyyyMMdd') TB016
        //                    , b.MtlItemNo TB003, b.MtlItemName TB012, b.MtlItemSpec TB013
        //                    , c.MtlItemNo TB023
        //                    , d.InventoryNo TB009
        //                    , e.UomNo TB007
        //                    , f.WoErpPrefix TB001,f.WoErpNo TB002
        //                    , g.MtlItemNo TB014
        //                    FROM MES.WoDetail a
        //                    INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
        //                    INNER JOIN PDM.MtlItem c on a.SubstituteMtlItemId = c.MtlItemId
        //                    INNER JOIN SCM.Inventory d on a.InventoryId = d.InventoryId
        //                    INNER JOIN PDM.UnitOfMeasure e on a.UomId = e.UomId
        //                    INNER JOIN MES.WipOrder f on a.WoId = f.WoId
        //                    INNER JOIN PDM.MtlItem g on f.MtlItemId = g.MtlItemId
        //                    WHERE a.WoId = @WoId";
        //            dynamicParameters.Add("WoId", WoId);

        //            OrderBy = "WoId";
        //            wipDetails = BaseHelper.SqlQuery<MOCTB>(sqlConnection, sql, dynamicParameters, OrderBy);
        //            #endregion

        //            #region //撈取使用者No
        //            dynamicParameters = new DynamicParameters();
        //            sql = @"SELECT a.UserNo
        //                    FROM BAS.[User] a
        //                    WHERE a.UserId = @userId";
        //            dynamicParameters.Add("userId", userId);

        //            string userNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).UserNo;

        //            wipOrders
        //                .ToList()
        //                .ForEach(x =>
        //                {
        //                    x.CREATOR = userNo;
        //                    x.TA041 = userNo;
        //                    x.TA055 = userNo;
        //                });
        //            wipDetails
        //                .ToList()
        //                .ForEach(x =>
        //                {
        //                    x.CREATOR = userNo;
        //                });
        //            #endregion
        //        }

        //        if (wipOrders.Select(x => x.TA013).FirstOrDefault() == "N")
        //        {
        //            int rowsAffected = 0;
        //            if (wipOrders.Count() > 0)
        //            {
        //                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
        //                {
        //                    DynamicParameters dynamicParameters = new DynamicParameters();

        //                    using (TransactionScope transactionScope = new TransactionScope())
        //                    {

        //                        List<MOCTA> addwipOrders = wipOrders.Where(x => x.TransferStatus == "N").ToList();
        //                        List<MOCTA> updatewipOrders = wipOrders.Where(x => x.TransferStatus != "N").ToList();

        //                        List<MOCTB> addwoDetails = wipDetails.Where(x => x.TB018 == "N").ToList();
        //                        List<MOCTB> updatewoDetails = wipDetails.Where(x => x.TB018 != "N").ToList();

        //                        #region //ERP工單新增修改
        //                        if (wipOrders.Select(x => x.TransferStatus).FirstOrDefault() == "N")
        //                        {
        //                            #region //取值
        //                            string WoErpPrefix = wipOrders.Select(x => x.TA001).FirstOrDefault();
        //                            string DocDate = wipOrders.Select(x => x.TA003).FirstOrDefault();
        //                            string MtlItemNo = wipOrders.Select(x => x.TA006).FirstOrDefault();

        //                            #region //單號自動取號
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TA002))), '000'), 3)) + 1 CurrentNum
        //                                    FROM MOCTA
        //                                    WHERE TA001 = @WoErpPrefix
        //                                    AND TA003 = @DocDate";
        //                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
        //                            dynamicParameters.Add("DocDate", DocDate);

        //                            int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
        //                            string WoErpNo = DocDate + string.Format("{0:000}", currentNum);
        //                            #endregion

        //                            #region //判斷ERP工單單號是否重複
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"SELECT TOP 1 1
        //                                        FROM MOCTA
        //                                        WHERE TA001 = @TA001
        //                                        AND TA002 = @TA002";
        //                            dynamicParameters.Add("TA001", WoErpPrefix);
        //                            dynamicParameters.Add("TA002", WoErpNo);

        //                            var result = sqlConnection.Query(sql, dynamicParameters);
        //                            if (result.Count() > 0) throw new SystemException("【工單單號】重複，請重新取號!");
        //                            #endregion

        //                            #region //ERP產品結構 撈取BOM日期和版次
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"SELECT a.MC017 bomDate, a.MC009 bomEdition
        //                                    FROM BOMMC a
        //                                    WHERE a.MC001 = @MtlItemNo";
        //                            dynamicParameters.Add("MtlItemNo", MtlItemNo);

        //                            var result2 = sqlConnection.Query(sql, dynamicParameters);
        //                            if (result2.Count() <= 0) throw new SystemException("【BOM日期】缺少");
        //                            string bomDate = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).bomDate;
        //                            string bomEdition = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).bomEdition;
        //                            #endregion
        //                            #endregion

        //                            #region //賦值
        //                            wipOrders
        //                                .ToList()
        //                                .ForEach(x =>
        //                                {
        //                                    x.TA002 = WoErpNo;
        //                                    x.CFIELD01 = x.TA001 + "-" + WoErpNo;
        //                                    x.TA004 = bomDate;
        //                                    x.TA005 = bomEdition;
        //                                });
        //                            wipDetails
        //                               .ToList()
        //                               .ForEach(x =>
        //                               {
        //                                   x.TB002 = WoErpNo;
        //                               });
        //                            #endregion

        //                            #region //新增

        //                            #region //單頭
        //                            if (addwipOrders.Count > 0)
        //                            {
        //                                addwipOrders
        //                                    .ToList()
        //                                    .ForEach(x =>
        //                                    {
        //                                        x.COMPANY = "ZY01";
        //                                        x.USR_GROUP = "";
        //                                        x.CREATE_DATE = dateNow;
        //                                        x.MODIFIER = "";
        //                                        x.MODI_DATE = dateNow;
        //                                        x.FLAG = "1";
        //                                        x.CREATE_TIME = timeNow;
        //                                        x.CREATE_AP = BaseHelper.ClientComputer();
        //                                        x.CREATE_PRID = "BM";
        //                                        x.MODI_TIME = timeNow;
        //                                        x.MODI_AP = "";
        //                                        x.MODI_PRID = "";
        //                                        x.TA008 = "";//預留欄位
        //                                        x.TA013 = "Y";//確認碼
        //                                        x.TA019 = "ZY01";//廠別代號
        //                                        x.TA021 = "";//生產線別
        //                                        x.TA022 = 0;//加工單價
        //                                        x.TA023 = x.TA007;//加工單位
        //                                        x.TA024 = x.TA001;//母製令別
        //                                        x.TA025 = x.TA002;//母製令編號
        //                                        x.TA031 = 0;//列印次數
        //                                        x.TA032 = "9999999";//加工廠商
        //                                        x.TA033 = "";//計劃批號
        //                                        x.TA036 = "";//預計開工(代號)休假顯示0.不休假、1.全天、2.半天
        //                                        x.TA037 = "";//預計完工(代號)休假顯示0.不休假、1.全天、2.半天
        //                                        x.TA038 = "";//實際開工(代號)休假顯示0.不休假、1.全天、2.半天
        //                                        x.TA039 = "";//實際完工(代號)休假顯示0.不休假、1.全天、2.半天
        //                                        x.TA040 = dateNow;//確認日
        //                                        x.TA042 = "NT$";//幣別
        //                                        x.TA043 = 1;//匯率
        //                                        x.TA045 = 0;//預計產包裝量
        //                                        x.TA046 = 0;//已生產包裝量
        //                                        x.TA047 = 0;//報廢包裝數量
        //                                        x.TA048 = "";//包裝單位
        //                                        x.TA049 = "N";//簽核狀態碼
        //                                        x.TA050 = 0;//傳送次數
        //                                        x.TA051 = "";//客戶品號
        //                                        x.TA052 = "";//APS規劃製令號碼
        //                                        x.TA053 = 0;//產品序號數量
        //                                        x.TA054 = "2";//類型
        //                                        x.TA056 = "4";//課稅別
        //                                        x.TA057 = 0.0;//營業稅率
        //                                        x.TA058 = "";//價格條件
        //                                        x.TA059 = "";//付款條件代號
        //                                        x.TA060 = "";//送貨地址(一)
        //                                        x.TA061 = "";//送貨地址(二)
        //                                        x.TA062 = "0";//預留欄位
        //                                        x.TA063 = "";//預計批號
        //                                        x.TA064 = 0.0;//預留欄位
        //                                        x.TA065 = 0.0;//預留欄位
        //                                        x.TA066 = "";//MES拋轉紀錄碼
        //                                        x.TA067 = "";//預留欄位
        //                                        x.TA068 = "";//預留欄位
        //                                        x.TA069 = 0.0;//原幣加工金額
        //                                        x.TA070 = "P16";//稅別碼
        //                                        x.TA071 = "";//Marking代號
        //                                        x.TA072 = "";//計價方式
        //                                        x.TA073 = 0.0;//不良品單價
        //                                        x.TA074 = 0.0;//廢品單價
        //                                        x.TA075 = "";//製造廠商
        //                                        x.TA076 = 0.0;//計價單價
        //                                        x.TA077 = 0.0;//驗收單價
        //                                        x.TA078 = "";//進貨/託外進貨單別
        //                                        x.TA079 = "";//進貨/託外進貨單號
        //                                        x.TA080 = "";//進貨/託外進貨序號
        //                                        x.TA081 = "";//採購限制日期
        //                                        x.TA082 = "";//預留欄位
        //                                        x.TA083 = "";//預留欄位
        //                                        x.TA084 = "";//預留欄位
        //                                        x.TA085 = "";//預留欄位
        //                                        x.TA086 = "";//預留欄位
        //                                        x.TA087 = "";//預留欄位
        //                                        x.TA088 = "";//預留欄位
        //                                        x.TA089 = "";//預留欄位
        //                                        x.TA090 = "";//預留欄位
        //                                        x.TA091 = "";//預留欄位
        //                                        x.TA092 = "N";//製程否
        //                                        x.TA093 = "";//預留欄位
        //                                        x.TA094 = 0;//預留欄位
        //                                        x.TA095 = "";//優先順序
        //                                        x.TA096 = "";//預留欄位
        //                                        x.TA097 = "N";//單身多稅率
        //                                        x.TA500 = "";//不良品庫別
        //                                        x.TA501 = "";//MARKING
        //                                        x.TA502 = "";//BONDING
        //                                        x.TA503 = 0.0;//加工片數
        //                                        x.TA504 = 0.0;//已交片數
        //                                        x.TA505 = "";//加工項目代號
        //                                        x.TA506 = "";//晶片厚度
        //                                        x.TA507 = "";//晶片尺寸
        //                                        x.TA508 = "";//領料單單別
        //                                        x.TA509 = "";//領料單單號
        //                                        x.TA510 = "";//備註說明A
        //                                        x.TA511 = "";//備註說明B
        //                                        x.TA512 = "";//備註說明C
        //                                        x.TA513 = "";//備註說明D
        //                                        x.TA514 = 0.0;//需領用總數
        //                                        x.TA515 = 0.0;//需領用包裝總數
        //                                        x.TA516 = 0.0;//GROSS_DIE總數
        //                                        x.TA520 = "";//特性1
        //                                        x.TA521 = "";//特性2
        //                                        x.TA522 = "";//特性3
        //                                        x.TA523 = "";//特性4
        //                                        x.TA524 = "";//特性5
        //                                        x.TA525 = "";//特性6
        //                                        x.TA526 = "";//特性7
        //                                        x.TA527 = "";//特性8
        //                                        x.TA528 = "";//特性9
        //                                        x.TA530 = "";//下站加工項目
        //                                        x.TA531 = "";//下站加工廠商
        //                                        x.TA532 = "";//下站加工聯絡人
        //                                        x.TA533 = "";//下站加工電話
        //                                        x.TA534 = "";//送貨地址一
        //                                        x.TA535 = "";//送貨地址二
        //                                        x.TA550 = "";//性質 1:量產品 2:工程品
        //                                        x.TA552 = 0.0;//材料單價比率
        //                                        x.TA553 = "";//預留欄位
        //                                        x.TA554 = "";//自動扣料已轉撥
        //                                        x.TA555 = "";//轉撥單別
        //                                        x.TA556 = "";//轉撥單號
        //                                        x.UDF01 = "";
        //                                        x.UDF02 = "";
        //                                        x.UDF03 = "";
        //                                        x.UDF04 = "";
        //                                        x.UDF05 = "";
        //                                        x.UDF06 = 0.0;
        //                                        x.UDF07 = 0.0;
        //                                        x.UDF08 = 0.0;
        //                                        x.UDF09 = 0.0;
        //                                        x.UDF10 = 0.0;

        //                                        //x.COMPANY = "";
        //                                        //x.USR_GROUP = "";
        //                                        //x.CREATE_DATE = dateNow;
        //                                        //x.MODIFIER = "";
        //                                        //x.MODI_DATE = dateNow;
        //                                        //x.FLAG = "1";
        //                                        //x.CREATE_TIME = timeNow;
        //                                        //x.CREATE_AP = "";
        //                                        //x.CREATE_PRID = "BM";
        //                                        //x.MODI_TIME = timeNow;
        //                                        //x.MODI_AP = "";
        //                                        //x.MODI_PRID = "";
        //                                        //x.TA008 = "";//預留欄位
        //                                        //x.TA019 = "";//廠別代號
        //                                        //x.TA021 = "";//生產線別
        //                                        //x.TA022 = 0;//加工單價
        //                                        //x.TA023 = "";//加工單位
        //                                        //x.TA024 = "";//母製令別
        //                                        //x.TA025 = "";//母製令編號
        //                                        //x.TA031 = 0;//列印次數
        //                                        //x.TA032 = "99999";//加工廠商
        //                                        //x.TA033 = "";//計劃批號
        //                                        //x.TA036 = "";//預計開工(代號)休假顯示0.不休假、1.全天、2.半天
        //                                        //x.TA037 = "";//預計完工(代號)休假顯示0.不休假、1.全天、2.半天
        //                                        //x.TA038 = "";//實際開工(代號)休假顯示0.不休假、1.全天、2.半天
        //                                        //x.TA039 = "";//實際完工(代號)休假顯示0.不休假、1.全天、2.半天
        //                                        //x.TA042 = "";//幣別
        //                                        //x.TA043 = 1;//匯率
        //                                        //x.TA045 = 0;//預計產包裝量
        //                                        //x.TA046 = 0;//已生產包裝量
        //                                        //x.TA047 = 0;//報廢包裝數量
        //                                        //x.TA048 = "";//包裝單位
        //                                        //x.TA049 = "";//簽核狀態碼
        //                                        //x.TA050 = 0;//傳送次數
        //                                        //x.TA051 = "";//客戶品號
        //                                        //x.TA052 = "";//APS規劃製令號碼
        //                                        //x.TA053 = 0;//產品序號數量
        //                                        //x.TA054 = "";//類型
        //                                        //x.TA056 = "";//課稅別
        //                                        //x.TA057 = 0.0;//營業稅率
        //                                        //x.TA058 = "";//價格條件
        //                                        //x.TA059 = "";//付款條件代號
        //                                        //x.TA060 = "";//送貨地址(一)
        //                                        //x.TA061 = "";//送貨地址(二)
        //                                        //x.TA063 = "";//預計批號
        //                                        //x.TA064 = 0;//預留欄位
        //                                        //x.TA065 = 0;//預留欄位
        //                                        //x.TA066 = "";//MES拋轉紀錄碼
        //                                        //x.TA067 = "";//預留欄位
        //                                        //x.TA068 = "";//預留欄位
        //                                        //x.TA069 = 0;//原幣加工金額
        //                                        //x.TA070 = "";//稅別碼
        //                                        //x.TA071 = "";//Marking代號
        //                                        //x.TA072 = "";//計價方式
        //                                        //x.TA073 = 0;//不良品單價
        //                                        //x.TA074 = 0;//廢品單價
        //                                        //x.TA075 = "";//製造廠商
        //                                        //x.TA076 = 0;//計價單價
        //                                        //x.TA077 = 0;//驗收單價
        //                                        //x.TA078 = "";//進貨/託外進貨單別
        //                                        //x.TA079 = "";//進貨/託外進貨單號
        //                                        //x.TA080 = "";//進貨/託外進貨序號
        //                                        //x.TA081 = "";//採購限制日期
        //                                        //x.TA082 = "";//預留欄位
        //                                        //x.TA083 = "";//預留欄位
        //                                        //x.TA084 = "";//預留欄位
        //                                        //x.TA085 = "";//預留欄位
        //                                        //x.TA086 = "";//預留欄位
        //                                        //x.TA087 = "";//預留欄位
        //                                        //x.TA088 = "";//預留欄位
        //                                        //x.TA089 = "";//預留欄位
        //                                        //x.TA090 = "";//預留欄位
        //                                        //x.TA091 = "";//預留欄位
        //                                        //x.TA092 = "";//製程否
        //                                        //x.TA093 = "";//預留欄位
        //                                        //x.TA094 = 0;//預留欄位
        //                                        //x.TA095 = "";//優先順序
        //                                        //x.TA096 = "";//預留欄位
        //                                        //x.TA097 = "";//單身多稅率
        //                                        //x.TA500 = "";//不良品庫別
        //                                        //x.TA501 = "";//MARKING
        //                                        //x.TA502 = "";//BONDING
        //                                        //x.TA503 = 0.0;//加工片數
        //                                        //x.TA504 = 0.0;//已交片數
        //                                        //x.TA505 = "";//加工項目代號
        //                                        //x.TA506 = "";//晶片厚度
        //                                        //x.TA507 = "";//晶片尺寸
        //                                        //x.TA508 = "";//領料單單別
        //                                        //x.TA509 = "";//領料單單號
        //                                        //x.TA510 = "";//備註說明A
        //                                        //x.TA511 = "";//備註說明B
        //                                        //x.TA512 = "";//備註說明C
        //                                        //x.TA513 = "";//備註說明D
        //                                        //x.TA514 = 0;//需領用總數
        //                                        //x.TA515 = 0;//需領用包裝總數
        //                                        //x.TA516 = 0;//GROSS_DIE總數
        //                                        //x.TA520 = "";//特性1
        //                                        //x.TA521 = "";//特性2
        //                                        //x.TA522 = "";//特性3
        //                                        //x.TA523 = "";//特性4
        //                                        //x.TA524 = "";//特性5
        //                                        //x.TA525 = "";//特性6
        //                                        //x.TA526 = "";//特性7
        //                                        //x.TA527 = "";//特性8
        //                                        //x.TA528 = "";//特性9
        //                                        //x.TA530 = "";//下站加工項目
        //                                        //x.TA531 = "";//下站加工廠商
        //                                        //x.TA532 = "";//下站加工聯絡人
        //                                        //x.TA533 = "";//下站加工電話
        //                                        //x.TA534 = "";//送貨地址一
        //                                        //x.TA535 = "";//送貨地址二
        //                                        //x.TA550 = "";//性質 1:量產品 2:工程品
        //                                        //x.TA552 = 0;//材料單價比率
        //                                        //x.TA553 = "";//預留欄位
        //                                        //x.TA554 = "";//自動扣料已轉撥
        //                                        //x.TA555 = "";//轉撥單別
        //                                        //x.TA556 = "";//轉撥單號
        //                                        //x.UDF01 = "";
        //                                        //x.UDF02 = "";
        //                                        //x.UDF03 = "";
        //                                        //x.UDF04 = "";
        //                                        //x.UDF05 = "";
        //                                        //x.UDF06 = 0;
        //                                        //x.UDF07 = 0;
        //                                        //x.UDF08 = 0;
        //                                        //x.UDF09 = 0;
        //                                        //x.UDF10 = 0;
        //                                    });

        //                                sql = @"INSERT INTO MOCTA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
        //                                        CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TA001, TA002, TA003, TA004, TA005, TA006, TA007, 
        //                                        TA008, TA009, TA010, TA011, TA012, TA013, TA014, TA015, TA016, TA017, TA018, TA019, TA020, TA021, TA022, 
        //                                        TA023, TA024, TA025, TA026, TA027, TA028, TA029, TA030, TA031, TA032, TA033, TA034, TA035, TA036, TA037, 
        //                                        TA038, TA039, TA040, TA041, TA042, TA043, TA044, TA045, TA046, TA047, TA048, TA049, TA050, TA051, TA052, 
        //                                        TA053, TA054, TA055, TA056, TA057, TA058, TA059, TA060, TA061, TA062, TA063, TA064, TA065, TA066, TA067, 
        //                                        TA068, TA069, TA070, TA071, TA072, TA073, TA074, TA075, TA076, TA077, TA078, TA079, TA080, TA081, TA082, 
        //                                        TA083, TA084, TA085, TA086, TA087, TA088, TA089, TA090, TA091, TA092, TA093, TA094, TA095, TA096, TA500, 
        //                                        TA501, TA502, TA503, TA504, TA505, TA506, TA507, TA508, TA509, TA510, TA511, TA512, TA513, TA514, TA515, 
        //                                        TA516, TA520, TA521, TA522, TA523, TA524, TA525, TA526, TA527, TA528, TA530, TA531, TA532, TA533, TA534, 
        //                                        TA535, TA550, TA551, TA552, TA553, UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, 
        //                                        TA097, TA554, TA555, TA556)
        //                                        VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
        //                                        @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TA001, @TA002, @TA003, @TA004, @TA005, @TA006, @TA007, 
        //                                        @TA008, @TA009, @TA010, @TA011, @TA012, @TA013, @TA014, @TA015, @TA016, @TA017, @TA018, @TA019, @TA020, @TA021, @TA022, 
        //                                        @TA023, @TA024, @TA025, @TA026, @TA027, @TA028, @TA029, @TA030, @TA031, @TA032, @TA033, @TA034, @TA035, @TA036, @TA037, 
        //                                        @TA038, @TA039, @TA040, @TA041, @TA042, @TA043, @TA044, @TA045, @TA046, @TA047, @TA048, @TA049, @TA050, @TA051, @TA052, 
        //                                        @TA053, @TA054, @TA055, @TA056, @TA057, @TA058, @TA059, @TA060, @TA061, @TA062, @TA063, @TA064, @TA065, @TA066, @TA067, 
        //                                        @TA068, @TA069, @TA070, @TA071, @TA072, @TA073, @TA074, @TA075, @TA076, @TA077, @TA078, @TA079, @TA080, @TA081, @TA082, 
        //                                        @TA083, @TA084, @TA085, @TA086, @TA087, @TA088, @TA089, @TA090, @TA091, @TA092, @TA093, @TA094, @TA095, @TA096, @TA500, 
        //                                        @TA501, @TA502, @TA503, @TA504, @TA505, @TA506, @TA507, @TA508, @TA509, @TA510, @TA511, @TA512, @TA513, @TA514, @TA515, 
        //                                        @TA516, @TA520, @TA521, @TA522, @TA523, @TA524, @TA525, @TA526, @TA527, @TA528, @TA530, @TA531, @TA532, @TA533, @TA534, 
        //                                        @TA535, @TA550, @TA551, @TA552, @TA553, @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10, 
        //                                        @TA097, @TA554, @TA555, @TA556)";
        //                                rowsAffected += sqlConnection.Execute(sql, addwipOrders);
        //                            }
        //                            #endregion

        //                            #region //單身                                    
        //                            if (addwoDetails.Count > 0)
        //                            {
        //                                addwoDetails
        //                                    .ToList()
        //                                    .ForEach(x =>
        //                                    {
        //                                        x.COMPANY = "ZY01";
        //                                        x.USR_GROUP = "";
        //                                        x.CREATE_DATE = dateNow;
        //                                        x.MODIFIER = "";
        //                                        x.MODI_DATE = dateNow;
        //                                        x.FLAG = "1";
        //                                        x.CREATE_TIME = timeNow;
        //                                        x.CREATE_AP = BaseHelper.ClientComputer();
        //                                        x.CREATE_PRID = "BM";
        //                                        x.MODI_TIME = timeNow;
        //                                        x.MODI_AP = "";
        //                                        x.MODI_PRID = "";
        //                                        x.TB006 = "****";//製程代號
        //                                        x.TB008 = ""; //預留欄位
        //                                        x.TB011 = "1"; //材料型態
        //                                        x.TB018 = "Y"; //確認碼
        //                                        x.TB019 = 0.0; //需領用包裝量
        //                                        x.TB020 = 0.0; //已領用包裝量
        //                                        x.TB021 = ""; //包裝單位
        //                                        x.TB022 = "2"; //類型
        //                                        x.TB024 = 0.0; //預留欄位
        //                                        x.TB025 = "****"; //被取替代製程
        //                                        x.TB026 = 0.0; //預留欄位
        //                                        x.TB027 = "1"; //來源碼
        //                                        x.TB028 = ""; //預留欄位
        //                                        x.TB029 = 0.0; //預留欄位
        //                                        x.TB030 = 0.0; //預留欄位
        //                                        x.TB031 = 0.0; //預留欄位
        //                                        x.TB032 = ""; //預留欄位
        //                                        x.TB033 = ""; //預留欄位
        //                                        x.TB034 = ""; //預留欄位
        //                                        x.TB035 = ""; //發料DATECODE
        //                                        x.TB036 = ""; //發料儲位
        //                                        x.TB037 = ""; //加工順序
        //                                        x.TB038 = 0.0; //營業稅率
        //                                        x.TB039 = ""; //稅別碼
        //                                        x.TB500 = ""; //DATECODE
        //                                        x.TB501 = 0.0; //GROSS_DIE
        //                                        x.TB502 = ""; //批號
        //                                        x.TB503 = ""; //領料單別
        //                                        x.TB504 = ""; //領料單號
        //                                        x.TB505 = ""; //領料序號
        //                                        x.TB550 = ""; //性質
        //                                        x.TB551 = ""; //入庫批號
        //                                        x.TB552 = ""; //專案代號
        //                                        x.TB553 = ""; //刻號/BIN記錄
        //                                        x.TB554 = ""; //刻號管理
        //                                        x.TB555 = ""; //預留欄位
        //                                        x.TB556 = ""; //預留欄位
        //                                        x.TB557 = ""; //預留欄位
        //                                        x.UDF01 = "";
        //                                        x.UDF02 = "";
        //                                        x.UDF03 = "";
        //                                        x.UDF04 = "";
        //                                        x.UDF05 = "";
        //                                        x.UDF06 = 0.0;
        //                                        x.UDF07 = 0.0;
        //                                        x.UDF08 = 0.0;
        //                                        x.UDF09 = 0.0;
        //                                        x.UDF10 = 0.0;
        //                                    });

        //                                sql = @"INSERT INTO MOCTB(COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
        //                                    CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TB001, TB002, TB003, TB004, TB005, TB006, 
        //                                    TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB014, TB015, TB016, TB017, TB018, TB019, TB020, TB021, 
        //                                    TB022, TB023, TB024, TB025, TB026, TB027, TB028, TB029, TB030, TB031, TB032, TB033, TB034, TB035, TB036, 
        //                                    TB037, TB500, TB501, TB502, TB503, TB504, TB505, TB550, TB551, TB552, TB553, TB554, UDF01, UDF02, UDF03, 
        //                                    UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, TB038, TB039, TB555, TB556, TB557)
        //                                    VALUES(@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
        //                                    @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, 
        //                                    @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014, @TB015, @TB016, @TB017, @TB018, @TB019, @TB020, @TB021, 
        //                                    @TB022, @TB023, @TB024, @TB025, @TB026, @TB027, @TB028, @TB029, @TB030, @TB031, @TB032, @TB033, @TB034, @TB035, @TB036, 
        //                                    @TB037, @TB500, @TB501, @TB502, @TB503, @TB504, @TB505, @TB550, @TB551, @TB552, @TB553, @TB554, @UDF01, @UDF02, @UDF03, 
        //                                    @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10, @TB038, @TB039, @TB555, @TB556, @TB557)";
        //                                rowsAffected += sqlConnection.Execute(sql, addwoDetails);
        //                            }

        //                            #endregion

        //                            #endregion
        //                        }
        //                        else
        //                        {
        //                            #region //修改
        //                            #region //單頭
        //                            if (updatewipOrders.Count > 0)
        //                            {
        //                                updatewipOrders
        //                                    .ToList()
        //                                    .ForEach(x =>
        //                                    {
        //                                        x.MODI_DATE = dateNow;
        //                                        x.MODI_TIME = timeNow;
        //                                    });

        //                                sql = @"UPDATE MOCTA SET
        //                                        TA006 = @TA006,
        //                                        TA013 = @TA013,
        //                                        TA026 = @TA026,
        //                                        TA027 = @TA027,
        //                                        TA028 = @TA028,
        //                                        TA007 = @TA007,
        //                                        TA020 = @TA020,
        //                                        TA015 = @TA015,
        //                                        TA009 = @TA009,
        //                                        TA010 = @TA010,
        //                                        TA029 = @TA029,
        //                                        TA551 = @TA551
        //                                        WHERE TA001 = @TA001
        //                                        AND TA002 = @TA002";

        //                                rowsAffected += sqlConnection.Execute(sql, updatewipOrders);
        //                            }
        //                            #endregion

        //                            #region //單身
        //                            if (addwoDetails.Count > 0)
        //                            {
        //                                addwoDetails
        //                                    .ToList()
        //                                    .ForEach(x =>
        //                                    {
        //                                        x.MODI_DATE = dateNow;
        //                                        x.MODI_TIME = timeNow;
        //                                    });

        //                                sql = @"UPDATE MOCTB SET
        //                                        TB003 = @TB003, 
        //                                        TB009 = @TB009, 
        //                                        TB007 = @TB007, 
        //                                        TB004 = @TB004, 
        //                                        TB010 = @TB010, 
        //                                        TB015 = @TB015, 
        //                                        TB017 = @TB017, 
        //                                        TB018 = @TB018
        //                                        WHERE TB001 = @TB001
        //                                        AND TB002 = @TB002";
        //                                rowsAffected += sqlConnection.Execute(sql, updatewoDetails);
        //                            }
        //                            #endregion
        //                            #endregion
        //                        }
        //                        transactionScope.Complete();
        //                        #endregion
        //                    }
        //                }
        //                if (wipOrders.Select(x => x.TransferStatus).FirstOrDefault() == "N")
        //                {
        //                    #region//修改MES工單單號,拋轉狀態,確認碼(拋轉前MES工單單號是亂碼;拋轉ERP後得到正確單號再回來修改MES上的工單單號)
        //                    using (SqlConnection sqlConnections = new SqlConnection(MainConnectionStrings))
        //                    {
        //                        using (TransactionScope transactionScope = new TransactionScope())
        //                        {
        //                            DynamicParameters dynamicParameters = new DynamicParameters();
        //                            sql = @"UPDATE MES.WipOrder SET
        //                            WoErpNo = @WoErpNo,
        //                            ConfirmStatus = @ConfirmStatus,
        //                            TransferStatus = @TransferStatus,
        //                            LastModifiedDate = @LastModifiedDate,
        //                            LastModifiedBy = @LastModifiedBy
        //                            WHERE WoId = @WoId";
        //                            var parametersObject = new
        //                            {
        //                                WoErpNo = wipOrders.Select(x => x.TA002).FirstOrDefault(),
        //                                ConfirmStatus = "Y",
        //                                TransferStatus = "Y",
        //                                LastModifiedDate,
        //                                LastModifiedBy,
        //                                WoId
        //                            };
        //                            dynamicParameters.AddDynamicParams(parametersObject);

        //                            rowsAffected = sqlConnections.Execute(sql, dynamicParameters);

        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"UPDATE MES.WoDetail SET
        //                            ConfirmStatus = @ConfirmStatus,
        //                            LastModifiedDate = @LastModifiedDate,
        //                            LastModifiedBy = @LastModifiedBy
        //                            WHERE WoId = @WoId";
        //                            var parametersObjects = new
        //                            {
        //                                ConfirmStatus = "Y",
        //                                LastModifiedDate,
        //                                LastModifiedBy,
        //                                WoId
        //                            };
        //                            dynamicParameters.AddDynamicParams(parametersObject);

        //                            rowsAffected = sqlConnections.Execute(sql, dynamicParameters);

        //                            transactionScope.Complete();
        //                        }
        //                    }
        //                    #endregion
        //                }
        //                else if (wipOrders.Select(x => x.TransferStatus).FirstOrDefault() == "Y")
        //                {
        //                    #region//修改MES工單確認碼
        //                    using (SqlConnection sqlConnections = new SqlConnection(MainConnectionStrings))
        //                    {
        //                        using (TransactionScope transactionScope = new TransactionScope())
        //                        {
        //                            //單頭更新
        //                            DynamicParameters dynamicParameters = new DynamicParameters();
        //                            sql = @"UPDATE MES.WipOrder SET
        //                            ConfirmStatus = @ConfirmStatus,
        //                            LastModifiedDate = @LastModifiedDate,
        //                            LastModifiedBy = @LastModifiedBy
        //                            WHERE WoId = @WoId";
        //                            var parametersObject = new
        //                            {
        //                                ConfirmStatus = "Y",
        //                                LastModifiedDate,
        //                                LastModifiedBy,
        //                                WoId
        //                            };
        //                            dynamicParameters.AddDynamicParams(parametersObject);

        //                            rowsAffected = sqlConnections.Execute(sql, dynamicParameters);

        //                            //單身更新
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"UPDATE MES.WoDetail SET
        //                            ConfirmStatus = @ConfirmStatus,
        //                            LastModifiedDate = @LastModifiedDate,
        //                            LastModifiedBy = @LastModifiedBy
        //                            WHERE WoId = @WoId";
        //                            var parametersObjects = new
        //                            {
        //                                ConfirmStatus = "Y",
        //                                LastModifiedDate,
        //                                LastModifiedBy,
        //                                WoId
        //                            };
        //                            dynamicParameters.AddDynamicParams(parametersObject);

        //                            rowsAffected = sqlConnections.Execute(sql, dynamicParameters);

        //                            transactionScope.Complete();
        //                        }
        //                    }
        //                    #endregion
        //                }
        //                else
        //                {
        //                    throw new SystemException("【拋轉狀態值有問題】");
        //                }
        //            }

        //            #region //Response
        //            jsonResponse = JObject.FromObject(new
        //            {
        //                status = "success",
        //                msg = "拋轉成功"
        //            });
        //            #endregion
        //        }
        //        else
        //        {
        //            throw new SystemException("工單已確認過");
        //        }
        //    }
        //    catch (Exception e)
        //    {
        //        #region //Response
        //        jsonResponse = JObject.FromObject(new
        //        {
        //            status = "errorForDA",
        //            msg = e.Message
        //        });
        //        #endregion

        //        logger.Error(e.Message);
        //    }

        //    return jsonResponse.ToString();
        //}

        #endregion

        #region //UpdateVoidWipOrder -- ERP工單作廢 -- Shintokuro 2023-05-16
        public string UpdateVoidWipOrder(int WoId)
        {
            try
            {
                if (WoId <= 0) throw new SystemException("【ERP工單作廢】製令ID不能為空");

                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                int userId = CreateBy;
                string WoErpPrefix = "";
                string WoErpNo = "";
                string ErpNo = "";

                string ConfirmStatus = "";
                int MoNum = -1;
                string UserNo = "";
                int WoDetailNum = -1;
                int rowsAffected = 0;
                int CompanyIdBase = -1;

                DynamicParameters dynamicParameters = new DynamicParameters();
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    //MES工單取消確認碼
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //檢查資料
                        #region //判斷工單資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyId,a.WoId,a.WoErpPrefix, a.WoErpNo, a.ConfirmStatus ,b.WoDetailNum, c.MoNum
                                FROM MES.WipOrder a
                                OUTER APPLY(
                                    SELECT COUNT(x.WoDetailId) WoDetailNum  FROM MES.WoDetail x WHERE a.WoId = x.WoId
                                ) b
                                OUTER APPLY(
                                    SELECT COUNT(x.MoId) MoNum  FROM MES.ManufactureOrder x WHERE a.WoId = x.WoId
                                ) c
                                WHERE a.WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【ERP工單作廢】MES製令資料錯誤!製令ID不存在");
                        foreach (var item in result)
                        {
                            WoErpPrefix = item.WoErpPrefix;
                            WoErpNo = item.WoErpNo;
                            WoDetailNum = item.WoDetailNum;
                            ConfirmStatus = item.ConfirmStatus;
                            MoNum = item.MoNum;
                            CompanyIdBase = item.CompanyId;
                        }
                        if (ConfirmStatus != "N") throw new SystemException("【ERP工單作廢】必須在未確認狀態下才能作廢單據");
                        if (MoNum > 0) throw new SystemException("【ERP工單作廢】MES製令已經開立了,不能作廢");
                        if (CompanyIdBase != CurrentCompany) throw new SystemException("使用者公司別與單據公司別不同，請嘗試重新登入!!");

                        #endregion

                        #region //判斷工單資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.UserNo
                                FROM BAS.[User] a
                                WHERE a.UserId = @UserId";
                        dynamicParameters.Add("UserId", CreateBy);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【ERP工單作廢】使用者Id不存在,請重新確認");
                        foreach (var item in result)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion
                        #endregion

                        #region //資料新增/修改
                        #region //單頭-確認碼作廢
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.WipOrder SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE WoId = @WoId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "V",
                                LastModifiedDate,
                                LastModifiedBy,
                                WoId,
                            });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //單身-確認碼作廢
                        if (WoDetailNum > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.WoDetail SET
                                    ConfirmStatus = @ConfirmStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE WoId = @WoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "V",
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    WoId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion
                        #endregion

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpNo = item.ErpNo;
                        }
                        #endregion
                    }

                    //ERP工單取消確認碼
                    using (SqlConnection sqlConnectionERP = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //檢查資料
                        #region //ERP公司代碼取得
                        string CompanyNo = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ML001  
                                FROM CMSML";
                        var resultCompanyNo = sqlConnectionERP.Query(sql, dynamicParameters);
                        foreach (var item in resultCompanyNo)
                        {
                            CompanyNo = item.ML001;
                        }
                        if (ErpNo != CompanyNo) throw new SystemException("MES的公司代碼與ERP的公司代碼不同，請嘗試重新登入!!");
                        #endregion

                        #region //判斷工單資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TA001, TA002, TA013
                                FROM MOCTA
                                WHERE TA001 = @WoErpPrefix
                                AND TA002 = @WoErpNo";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);
                        var result1 = sqlConnectionERP.Query(sql, dynamicParameters);
                        if (result1.Count() <= 0) throw new SystemException("【ERP工單作廢】ERP製令資料錯誤!");
                        #endregion

                        #region //判斷工單資料是否正確
                        if (WoDetailNum > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TB001, TB002, TB018
                                    FROM MOCTB
                                    WHERE TB001 = @WoErpPrefix
                                    AND TB002 = @WoErpNo";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);
                            result1 = sqlConnectionERP.Query(sql, dynamicParameters);
                            if (result1.Count() <= 0) throw new SystemException("【ERP工單作廢】ERP製令單身資料錯誤!");
                        }
                        #endregion
                        #endregion

                        #region //資料新增/修改
                        #region //單頭-確認碼作廢
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTA SET 
                                TA011 = @TA011,
                                TA013 = @TA013,
                                MODIFIER = @MODIFIER,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP
                                WHERE TA001 = @TA001
                                AND TA002 = @TA002";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TA011 = "1",
                                TA013 = "V",
                                MODIFIER = UserNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = BaseHelper.ClientComputer(),
                                TA001 = WoErpPrefix,
                                TA002 = WoErpNo,
                            });
                        rowsAffected += sqlConnectionERP.Execute(sql, dynamicParameters);
                        #endregion

                        #region //單身-確認碼作廢
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTB SET 
                                TB018 = @TB018,
                                MODIFIER = @MODIFIER,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP
                                WHERE TB001 = @TB001
                                AND TB002 = @TB002";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TB018 = "V",
                                MODIFIER = UserNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = BaseHelper.ClientComputer(),
                                TB001 = WoErpPrefix,
                                TB002 = WoErpNo
                            });
                        rowsAffected += sqlConnectionERP.Execute(sql, dynamicParameters);
                        #endregion
                        #endregion
                    }

                    transactionScope.Complete();
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "反確認成功"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateWipOrderSynchronize -- 製令資料同步 -- Ted 2022.07.18
        public string UpdateWipOrderSynchronize(string CompanyNo, string UpdateDate, string WoErpFullNo)
        {
            try
            {
                if (WoErpFullNo == null) WoErpFullNo = "";
                List<WipOrder> wipOrder = new List<WipOrder>();
                List<WoDetail> woDetails = new List<WoDetail>();

                if (CompanyNo.Length <= 0) throw new SystemException("【公司】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
                {
                    int CompanyId = -1;
                    string ErpConnectionStrings = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", CompanyNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //撈取ERP單頭資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(TA055)) UserNo, LTRIM(RTRIM(TA001)) WoErpPrefix, LTRIM(RTRIM(TA002)) WoErpNo, LTRIM(RTRIM(TA062)) Version
                                , CASE WHEN LEN(LTRIM(RTRIM(TA003))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TA003)) as date), 'yyyy-MM-dd') ELSE NULL END DocDate
                                , LTRIM(RTRIM(TA006)) MtlItemNo, LTRIM(RTRIM(TA020)) InventoryNo
                                , LTRIM(RTRIM(TA007)) UomNo, TA015 PlanQty, TA016 RequisitionSetQty, TA017 StockInQty, TA018 ScrapQty
                                , CASE WHEN LEN(LTRIM(RTRIM(TA009))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TA009)) as date), 'yyyy-MM-dd') ELSE NULL END ExpectedStart
                                , CASE WHEN LEN(LTRIM(RTRIM(TA010))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TA010)) as date), 'yyyy-MM-dd') ELSE NULL END ExpectedEnd
                                , CASE WHEN LEN(LTRIM(RTRIM(TA012))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TA012)) as date), 'yyyy-MM-dd') ELSE NULL END ActualStart
                                , CASE WHEN LEN(LTRIM(RTRIM(TA014))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TA014)) as date), 'yyyy-MM-dd') ELSE NULL END ActualEnd
                                , CASE WHEN LEN(LTRIM(RTRIM(TA004))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TA004)) as date), 'yyyy-MM-dd') ELSE NULL END BomDate
                                , LTRIM(RTRIM(TA005)) BomVersion, LTRIM(RTRIM(TA044)) UrgentMtl, LTRIM(RTRIM(TA030)) Property
                                , LTRIM(RTRIM(TA026)) SoErpPrefix, LTRIM(RTRIM(TA027)) SoErpNo, LTRIM(RTRIM(TA028)) SoSequence
                                , LTRIM(RTRIM(TA551)) Project, LTRIM(RTRIM(TA032)) Processor, LTRIM(RTRIM(TA021)) ProductionLine, LTRIM(RTRIM(TA042)) CurrencyCode, TA043 Exchange
                                , LTRIM(RTRIM(TA070)) TaxCode, LTRIM(RTRIM(TA056)) TaxType, TA057 TaxRate, LTRIM(RTRIM(TA058)) PricingTerm, LTRIM(RTRIM(TA059)) PaymentTerm
                                , LTRIM(RTRIM(TA029)) WoRemark
                                , LTRIM(RTRIM(TA013)) ConfirmStatus, LTRIM(RTRIM(TA041)) ConfirmUserNo
                                , CASE WHEN LEN(LTRIM(RTRIM(TA040))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(TA040)) as date), 'yyyy-MM-dd') ELSE NULL END ConfirmDate
                                , LTRIM(RTRIM(TA011)) WoStatus
                                , CASE WHEN LEN(LTRIM(RTRIM(CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                FROM MOCTA
                                WHERE 1=1 AND TA007!='pcs'";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (CREATE_DATE + ' ' + CREATE_TIME > @UpdateDate OR MODI_DATE + ' ' + MODI_TIME > @UpdateDate)", UpdateDate);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND TA001 + '-' + TA002 = @WoErpFullNo", WoErpFullNo);
                        sql += @" ORDER BY TransferDate, TransferTime";

                        wipOrder = sqlConnection.Query<WipOrder>(sql, dynamicParameters).ToList();

                        #endregion

                        #region //撈取ERP單身資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.TB001)) WoErpPrefix, LTRIM(RTRIM(a.TB002)) WoErpNo, LTRIM(RTRIM(a.TB003)) MtlItemNo, LTRIM(RTRIM(a.TB009)) InventoryNo, LTRIM(RTRIM(a.TB007)) UomNo
                                , LTRIM(RTRIM(a.TB004)) DemandRequisitionQty, LTRIM(RTRIM(a.TB005)) RequisitionQty
                                , LTRIM(RTRIM(a.TB010)) Substitute, LTRIM(RTRIM(a.TB023)) SubstituteMtlItemNo, LTRIM(RTRIM(a.TB011)) MaterialProperties
                                , CASE WHEN LEN(LTRIM(RTRIM(a.TB015))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.TB015)) as date), 'yyyy-MM-dd') ELSE NULL END ExpectedRequisitionDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.TB016))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.TB016)) as date), 'yyyy-MM-dd') ELSE NULL END ActualRequisitionDate
                                , LTRIM(RTRIM(a.TB017)) WipDetailRemark , LTRIM(RTRIM(a.TB018)) ConfirmStatus
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                , ISNULL(c.CompositionQuantity, d.CompositionQuantity) CompositionQuantity, ISNULL(c.Base, d.Base) Base, ISNULL(c.LossRate, d.LossRate) LossRate
                                , ISNULL(c.BomSequence, d.BomSequence) BomSequence
                                FROM MOCTB a
                                INNER JOIN MOCTA b ON a.TB001 = b.TA001 AND a.TB002 = b.TA002
                                OUTER APPLY(
                                    SELECT LTRIM(RTRIM(ca.MD006)) CompositionQuantity
                                    , LTRIM(RTRIM(ca.MD007)) Base, LTRIM(RTRIM(ca.MD008)) LossRate
                                    , LTRIM(RTRIM(ca.MD001)) BomMtlItemNo, LTRIM(RTRIM(ca.MD003)) BomDetailMtlItemNo
                                    , LTRIM(RTRIM(ca.MD002)) BomSequence
                                    FROM BOMMD ca
                                    INNER JOIN BOMMC cb ON ca.MD001 = cb.MC001
                                    WHERE cb.MC001 = b.TA006 AND ca.MD003 = a.TB003
                                ) c
                                OUTER APPLY(
                                    SELECT TOP 1 LTRIM(RTRIM(db.MD006)) CompositionQuantity
                                    , LTRIM(RTRIM(db.MD007)) Base, LTRIM(RTRIM(db.MD008)) LossRate
                                    , LTRIM(RTRIM(db.MD002)) BomSequence
                                    FROM BOMMB da
                                    INNER JOIN BOMMD db ON da.MB001 = db.MD003 AND da.MB002 = db.MD001
                                    WHERE da.MB001 = a.TB003 AND da.MB002 = b.TA006
                                    AND da.MB001 = c.BomDetailMtlItemNo AND da.MB002 = c.BomMtlItemNo
                                    ORDER BY MB009
                                ) d
                                WHERE 1=1 AND a.TB007!='pcs'";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + ISNULL(a.CREATE_TIME, '00:00:00') > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND a.TB001 + '-' + a.TB002 = @WoErpFullNo", WoErpFullNo);
                        sql += @" ORDER BY TransferDate, TransferTime";

                        woDetails = sqlConnection.Query<WoDetail>(sql, dynamicParameters).ToList();

                        #endregion
                    }

                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //使用者ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId, UserNo
                                FROM BAS.[User] a
                                INNER JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                                INNER JOIN BAS.Company c ON b.CompanyId = c.CompanyId
                                WHERE c.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<User> resultUsers = sqlConnection.Query<User>(sql, dynamicParameters).ToList();

                        wipOrder = wipOrder.Join(resultUsers, x => x.UserNo, y => y.UserNo, (x, y) => { x.UserId = y.UserId; return x; }).ToList();
                        wipOrder = wipOrder.Join(resultUsers, x => x.ConfirmUserNo, y => y.UserNo, (x, y) => { x.ConfirmUserId = y.UserId; return x; }).ToList();
                        #endregion

                        #region //撈取品號ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId, MtlItemNo
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<MtlItem> resultMtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();

                        wipOrder = wipOrder.Join(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        woDetails = woDetails.Join(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        woDetails = woDetails.Join(resultMtlitems, x => x.SubstituteMtlItemNo, y => y.MtlItemNo, (x, y) => { x.SubstituteMtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        #endregion

                        #region //撈取庫別ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT InventoryId, InventoryNo
                                FROM SCM.Inventory
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<Inventory> resultInventories = sqlConnection.Query<Inventory>(sql, dynamicParameters).ToList();

                        wipOrder = wipOrder.Join(resultInventories, x => x.InventoryNo, y => y.InventoryNo, (x, y) => { x.InventoryId = y.InventoryId; return x; }).ToList();
                        woDetails = woDetails.Join(resultInventories, x => x.InventoryNo, y => y.InventoryNo, (x, y) => { x.InventoryId = y.InventoryId; return x; }).ToList();
                        #endregion

                        #region //撈取單位ID  
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UomId, UomNo
                                FROM PDM.UnitOfMeasure
                                WHERE Status='A' AND CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<UnitOfMeasure> resultUoms = sqlConnection.Query<UnitOfMeasure>(sql, dynamicParameters).ToList();

                        wipOrder = wipOrder.Join(resultUoms, x => x.UomNo.ToUpper(), y => y.UomNo.ToUpper(), (x, y) => { x.UomId = y.UomId; return x; }).ToList();
                        woDetails = woDetails.Join(resultUoms, x => x.UomNo.ToUpper(), y => y.UomNo.ToUpper(), (x, y) => { x.UomId = y.UomId; return x; }).ToList();
                        #endregion

                        #region //撈取訂單ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.SoDetailId, b.SoErpPrefix, b.SoErpNo, a.SoSequence
                                FROM SCM.SoDetail a
                                INNER JOIN SCM.SaleOrder b ON a.SoId = b.SoId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<SoDetail> resultSoDetail = sqlConnection.Query<SoDetail>(sql, dynamicParameters).ToList();

                        wipOrder = wipOrder.GroupJoin(resultSoDetail, x => new { x.SoErpPrefix, x.SoErpNo, x.SoSequence }, y => new { y.SoErpPrefix, y.SoErpNo, y.SoSequence }, (x, y) => { x.SoDetailId = y.FirstOrDefault()?.SoDetailId; return x; }).Select(x => x).ToList();
                        #endregion

                        #region //判斷MES.WipOrder是否有資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT WoId, WoErpPrefix, WoErpNo
                                FROM MES.WipOrder
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<WipOrder> resultWipOrder = sqlConnection.Query<WipOrder>(sql, dynamicParameters).ToList();

                        wipOrder = wipOrder.GroupJoin(resultWipOrder, x => new { x.WoErpPrefix, x.WoErpNo }, y => new { y.WoErpPrefix, y.WoErpNo }, (x, y) => { x.WoId = y.FirstOrDefault()?.WoId; return x; }).Select(x => x).ToList();
                        #endregion

                        #region //製令單頭 新增/更新
                        List<WipOrder> addWipOrder = wipOrder.Where(x => x.WoId == null).ToList();
                        List<WipOrder> updateWipOrder = wipOrder.Where(x => x.WoId != null).ToList();

                        #region //新增
                        if (addWipOrder.Count > 0)
                        {
                            addWipOrder
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.CompanyId = CompanyId;
                                    x.TransferStatus = "Y";
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO MES.WipOrder (CompanyId, UserId, WoErpPrefix, WoErpNo, Version
                                    , DocDate, MtlItemId, InventoryId, UomId
                                    , PlanQty, RequisitionSetQty, StockInQty, ScrapQty
                                    , ExpectedStart, ExpectedEnd, ActualStart, ActualEnd
                                    , BomDate, BomVersion, UrgentMtl, Property, SoDetailId
                                    , Project, ProductionLine, Processor, CurrencyCode, Exchange
                                    , TaxCode, TaxType, TaxRate, PricingTerm, PaymentTerm
                                    , WoRemark, ConfirmStatus, ConfirmUserId
                                    , ConfirmDate, WoStatus, TransferStatus, TransferDate
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@CompanyId, @UserId, @WoErpPrefix, @WoErpNo, @Version
                                    , @DocDate, @MtlItemId, @InventoryId, @UomId
                                    , @PlanQty, @RequisitionSetQty, @StockInQty, @ScrapQty
                                    , @ExpectedStart, @ExpectedEnd, @ActualStart, @ActualEnd
                                    , @BomDate, @BomVersion, @UrgentMtl, @Property, @SoDetailId
                                    , @Project, @ProductionLine, @Processor, @CurrencyCode, @Exchange
                                    , @TaxCode, @TaxType, @TaxRate, @PricingTerm, @PaymentTerm
                                    , @WoRemark, @ConfirmStatus, @ConfirmUserId
                                    , @ConfirmDate, @WoStatus, @TransferStatus, @TransferDate
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, addWipOrder);
                        }
                        #endregion

                        #region //修改
                        if (updateWipOrder.Count > 0)
                        {
                            updateWipOrder
                                .ToList()
                                .ForEach(x =>
                                {
                                    Convert.ToDouble(x.Exchange);
                                    Convert.ToDouble(x.TaxRate);
                                    x.TransferStatus = "Y";
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"UPDATE MES.WipOrder SET
                                    UserId = @UserId,
                                    Version = @Version,
                                    DocDate = @DocDate,
                                    MtlItemId = @MtlItemId,
                                    InventoryId = @InventoryId,
                                    UomId = @UomId,
                                    PlanQty = @PlanQty,
                                    RequisitionSetQty = @RequisitionSetQty,
                                    ScrapQty = @ScrapQty,
                                    ExpectedStart = @ExpectedStart,
                                    ExpectedEnd = @ExpectedEnd,
                                    ActualStart = @ActualStart,
                                    ActualEnd = @ActualEnd,
                                    BomDate = @BomDate,
                                    BomVersion = @BomVersion,
                                    UrgentMtl = @UrgentMtl,
                                    Property = @Property,
                                    SoDetailId = @SoDetailId,
                                    Project = @Project,
                                    ProductionLine = @ProductionLine,
                                    Processor = @Processor,
                                    CurrencyCode = @CurrencyCode,
                                    Exchange = @Exchange,
                                    TaxCode = @TaxCode,
                                    TaxType = @TaxType,
                                    TaxRate = @TaxRate,
                                    PricingTerm = @PricingTerm,
                                    PaymentTerm = @PaymentTerm,
                                    WoRemark = @WoRemark,
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    ConfirmDate = @ConfirmDate,
                                    WoStatus = @WoStatus,
                                    TransferStatus = @TransferStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE WoId = @WoId";
                            rowsAffected += sqlConnection.Execute(sql, updateWipOrder);
                        }
                        #endregion
                        #endregion

                        #region //製令單身 新增/更新
                        #region //撈取製令單頭ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT WoId, WoErpPrefix, WoErpNo
                                FROM MES.WipOrder
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        resultWipOrder = sqlConnection.Query<WipOrder>(sql, dynamicParameters).ToList();

                        woDetails = woDetails.Join(resultWipOrder, x => new { x.WoErpPrefix, x.WoErpNo }, y => new { y.WoErpPrefix, y.WoErpNo }, (x, y) => { x.WoId = y.WoId; return x; }).Select(x => x).ToList();
                        #endregion

                        #region //判斷MES.WoDetail是否有資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.WoDetailId, a.WoId, a.MtlItemId
                                FROM MES.WoDetail a
                                INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<WoDetail> resultWoDetails = sqlConnection.Query<WoDetail>(sql, dynamicParameters).ToList();

                        woDetails = woDetails.GroupJoin(resultWoDetails, x => new { x.WoId, x.MtlItemId }, y => new { y.WoId, y.MtlItemId }, (x, y) => { x.WoDetailId = y.FirstOrDefault()?.WoDetailId; return x; }).ToList();
                        #endregion

                        List<WoDetail> addWoDetails = woDetails.Where(x => x.WoDetailId == null).ToList();
                        List<WoDetail> updateWoDetails = woDetails.Where(x => x.WoDetailId != null).ToList();

                        #region //新增
                        if (addWoDetails.Count > 0)
                        {
                            addWoDetails
                                .ToList()
                                .ForEach(x =>
                                {
                                    if (x.MtlItemId != x.SubstituteMtlItemId) { x.SubstituteStatus = "Y"; } else { x.SubstituteStatus = "N"; };
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId, CompositionQuantity, Base, LossRate, BomSequence
                                    , DemandRequisitionQty, RequisitionQty, Substitute, SubstituteStatus
                                    , SubstituteMtlItemId, MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate
                                    , WipDetailRemark, ConfirmStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence
                                    , @DemandRequisitionQty, @RequisitionQty, @Substitute, @SubstituteStatus
                                    , @SubstituteMtlItemId, @MaterialProperties,@ExpectedRequisitionDate, @ActualRequisitionDate
                                    , @WipDetailRemark, @ConfirmStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, addWoDetails);
                        }
                        #endregion

                        #region //修改
                        if (updateWoDetails.Count > 0)
                        {
                            updateWoDetails
                                .ToList()
                                .ForEach(x =>
                                {
                                    if (x.MtlItemId != x.SubstituteMtlItemId) { x.SubstituteStatus = "Y"; } else { x.SubstituteStatus = "N"; };
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"UPDATE MES.WoDetail SET
                                    WoId = @WoId,
                                    MtlItemId = @MtlItemId,
                                    InventoryId = @InventoryId,
                                    UomId = @UomId,
                                    CompositionQuantity = @CompositionQuantity,
                                    Base = @Base,
                                    LossRate = @LossRate,
                                    BomSequence = @BomSequence,
                                    DemandRequisitionQty = @DemandRequisitionQty,
                                    RequisitionQty = @RequisitionQty,
                                    Substitute = @Substitute,
                                    SubstituteStatus = @SubstituteStatus,
                                    SubstituteMtlItemId = @SubstituteMtlItemId,
                                    ExpectedRequisitionDate = @ExpectedRequisitionDate,
                                    ActualRequisitionDate = @ActualRequisitionDate,
                                    WipDetailRemark = @WipDetailRemark,
                                    ConfirmStatus = @ConfirmStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE WoDetailId = @WoDetailId";
                            rowsAffected += sqlConnection.Execute(sql, updateWoDetails);
                        }
                        #endregion
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateManufactureOrderStatus -- 更新MES製令啟用狀態 -- Ann 2022-07-27
        public string UpdateManufactureOrderStatus(int MoId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷途程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 Status
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");
                        #endregion

                        #region //調整為相反狀態
                        string Status = "";
                        foreach (var item in result)
                        {
                            Status = item.Status;
                        }

                        switch (Status)
                        {
                            case "A":
                                Status = "S";
                                break;
                            case "S":
                                Status = "A";
                                break;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.ManufactureOrder SET
                                Status = @Status,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoId = @MoId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                Status,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoSetting -- 更新MES製令設定 -- Ann 2022-07-29
        public string UpdateMoSetting(int MoId, string LotStatus, int LotQty, string MtlControl, string NgToBarcode, string BarcodePrefix, string BarcodePostfix, int SequenceLen, int ModeId
            , string DeliveryProcess, string Source, string PVTQCFlag, string OQcCheckType, string BarcodeCtrl, string TrayBarcode, string MrType, string OutputBarcodeFlag, string NgToDisassembly
            , string VehicleFlag, string FullPassQcFlag)
        {
            try
            {
                if (LotStatus.Length <= 0) throw new SystemException("【是否批量生產】不能為空!");
                if (LotStatus == "Y" && LotQty < 1) throw new SystemException("【批量生產數量】至少需要設定為1!");
                if (LotStatus == "Y" && Source.Length <= 0) throw new SystemException("【發料來源】不能為空!");
                if (LotStatus == "N" && LotQty < 0) LotQty = 0;
                if (LotStatus == "Y" && TrayBarcode.Length < 0) throw new SystemException("【Tray盤是否有雷刻條碼】不能為空!");
                if (LotStatus == "N" && NgToDisassembly == "Y") throw new SystemException("非批量模式無法選擇拆解模式!!");
                //if (DeliveryProcess.Length <= 0) throw new SystemException("【出貨工程】不能為空!");
                if (PVTQCFlag.Length <= 0) throw new SystemException("【是否可以無條碼進行出貨檢】不能為空!");
                if (BarcodeCtrl.Length <= 0) throw new SystemException("【是否要條碼控管】不能為空!");
                if (NgToBarcode == "N" && NgToDisassembly == "Y") throw new SystemException("若不需刷取NG條碼，則無法使用拆料模式!!");

                if (BarcodeCtrl == "Y")
                {
                    if (OutputBarcodeFlag != "N") throw new SystemException("非數量過站無法製程中產條碼!!");
                    if (MrType.Length <= 0) throw new SystemException("是否可以領取非當月條碼(料)不可為空!!");
                }

                if (LotStatus == "Y" && Source == "BP")
                {
                    if (NgToBarcode.Length <= 0 || BarcodePrefix.Length <= 0 || SequenceLen <= 0) throw new SystemException("尚未設定批量條碼相關資訊!");
                }

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷MES製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.[Status]
                                , b.MoId, b.LotStatus, b.LotQty, b.BarcodePrefix, b.SequenceLen, b.BarcodePostfix, b.NgToBarcode
                                , b.MtlControl, b.Source, b.PVTQCFlag, b.OQcCheckType, b.BarcodeCtrl, b.TrayBarcode, b.MrType
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");

                        bool OQcCheckFlag = false;
                        foreach (var item in result)
                        {
                            if (item.Status != "N")
                            {
                                #region //只能更改OQcCheckType
                                if (item.MoId != MoId || item.LotStatus != LotStatus || item.BarcodePrefix != BarcodePrefix
                                    || item.SequenceLen != SequenceLen || item.BarcodePostfix != BarcodePostfix || item.NgToBarcode != NgToBarcode
                                    || item.Source != Source || item.PVTQCFlag != PVTQCFlag || item.BarcodeCtrl != BarcodeCtrl || item.TrayBarcode != TrayBarcode || item.MrType != MrType)
                                {
                                    throw new SystemException("製令已開工，無法更改!");
                                }
                                else
                                {
                                    OQcCheckFlag = true;
                                }
                                #endregion
                            }
                        }
                        #endregion

                        #region //判斷是否存在此張製令設定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MoSettingId
                                FROM MES.MoSetting
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("製令設定資料異常!");

                        int MoSettingId = -1;
                        foreach (var item in result2)
                        {
                            MoSettingId = item.MoSettingId;
                        }
                        #endregion

                        #region //判斷批量條碼數量是否異常
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.Quantity
                                FROM MES.ManufactureOrder a
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result3)
                        {
                            if (LotQty > Convert.ToInt32(item.Quantity)) throw new SystemException("批量條碼數量不能大於MES預計生產數量!");
                        }
                        #endregion

                        #region //判斷生產模式資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ProdMode
                                WHERE ModeId = @ModeId";
                        dynamicParameters.Add("ModeId", ModeId);

                        var result5 = sqlConnection.Query(sql, dynamicParameters);
                        if (result5.Count() <= 0) throw new SystemException("生產模式資料錯誤!");
                        #endregion

                        if (Source == "BP")
                        {
                            #region //判斷此批量條碼命名規則是否已存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoSetting a
                                    WHERE a.BarcodePrefix = @BarcodePrefix
                                    AND a.BarcodePostfix = @BarcodePostfix
                                    AND a.SequenceLen = @SequenceLen
                                    AND MoId != @MoId";
                            dynamicParameters.Add("BarcodePrefix", BarcodePrefix);
                            dynamicParameters.Add("BarcodePostfix", BarcodePostfix);
                            dynamicParameters.Add("SequenceLen", SequenceLen);
                            dynamicParameters.Add("MoId", MoId);

                            var result6 = sqlConnection.Query(sql, dynamicParameters);
                            if (result6.Count() > 0) throw new SystemException("批量條碼命名規則重複!");
                            #endregion
                        }

                        #region //UPDATE MES.MoSetting
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoSetting SET
                                LotStatus = @LotStatus,
                                LotQty = @LotQty,
                                NgToBarcode = @NgToBarcode,
                                BarcodePrefix = @BarcodePrefix,
                                BarcodePostfix = @BarcodePostfix,
                                SequenceLen = @SequenceLen,
                                Source = @Source,
                                PVTQCFlag = @PVTQCFlag,
                                OQcCheckType = @OQcCheckType,
                                BarcodeCtrl = @BarcodeCtrl,
                                TrayBarcode = @TrayBarcode,
                                MrType = @MrType,
                                OutputBarcodeFlag = @OutputBarcodeFlag,
                                NgToDisassembly = @NgToDisassembly,
                                VehicleFlag = @VehicleFlag,
                                FullPassQcFlag = @FullPassQcFlag,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoId = @MoId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LotStatus,
                                LotQty,
                                NgToBarcode = NgToBarcode.Length > 0 ? NgToBarcode : "N",
                                BarcodePrefix,
                                BarcodePostfix,
                                SequenceLen,
                                Source,
                                PVTQCFlag,
                                OQcCheckType,
                                BarcodeCtrl,
                                TrayBarcode,
                                MrType,
                                OutputBarcodeFlag,
                                //OutputBarcodeFlag = "N", //功能上線前先強制為'N'
                                NgToDisassembly,
                                VehicleFlag,
                                FullPassQcFlag,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新製令生產模式、出貨工程
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.ManufactureOrder SET
                                ModeId = @ModeId,
                                DeliveryProcess = @DeliveryProcess,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoId = @MoId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ModeId,
                                DeliveryProcess,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        //#region //根據是否批量生產來預設用料設定
                        //if (BarcodeCtrl == "N")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"UPDATE MES.MoMtlSetting SET
                        //            BarcodeCtrl = 'N',
                        //            MainBarcode = 'N',
                        //            LastModifiedDate = @LastModifiedDate,
                        //            LastModifiedBy = @LastModifiedBy
                        //            WHERE MoId = @MoId";
                        //    dynamicParameters.AddDynamicParams(
                        //        new
                        //        {
                        //            LastModifiedDate,
                        //            LastModifiedBy,
                        //            MoId
                        //        });

                        //    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //}
                        //else
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"UPDATE MES.MoMtlSetting SET
                        //            BarcodeCtrl = 'Y',
                        //            MainBarcode = 'Y',
                        //            LastModifiedDate = @LastModifiedDate,
                        //            LastModifiedBy = @LastModifiedBy
                        //            WHERE MoId = @MoId";
                        //    dynamicParameters.AddDynamicParams(
                        //        new
                        //        {
                        //            LastModifiedDate,
                        //            LastModifiedBy,
                        //            MoId
                        //        });

                        //    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //}
                        //#endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoMtlSetting -- 更新MES製令用料設定 -- Ann 2022-08-01
        public string UpdateMoMtlSetting(int MoMtlSettingId, int MoId, int WoDetailId, int UomId, double CompositionQuantity
            , double Base, double LossRate, string BomSequence, string ProcessBinding, int MoProcessId
            , string BarcodeCtrl, string MainBarcode, string ControlType, string BindType)
        {
            try
            {
                if (!Regex.IsMatch(BarcodeCtrl, "^(Y|N)$", RegexOptions.IgnoreCase)) throw new SystemException("【是否綁定條碼】錯誤!");
                if (!Regex.IsMatch(MainBarcode, "^(Y|N)$", RegexOptions.IgnoreCase)) throw new SystemException("【是否檢核條碼】錯誤!");
                if (!Regex.IsMatch(ProcessBinding, "^(Y|N)$", RegexOptions.IgnoreCase)) throw new SystemException("【物料需製程綁定】錯誤!");
                if (ControlType.Length <= 0) throw new SystemException("【扣帳方式】不能為空!");
                //if (BindType == "B" && BarcodeCtrl != "Y") throw new SystemException("若上料模式為【條碼】，則必須設定為【需綁定條碼】!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #region //判斷MES製令用料設定資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSetting
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令用料設定資料錯誤!");
                        #endregion

                        #region //判斷MES製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 Status
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("MES製令資料錯誤!");

                        foreach (var item in result2)
                        {
                            if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                        }
                        #endregion

                        #region //判斷ERP工單結構資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.WoDetail
                                WHERE WoDetailId = @WoDetailId";
                        dynamicParameters.Add("WoDetailId", WoDetailId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() <= 0) throw new SystemException("ERP工單結構資料錯誤!");
                        #endregion

                        #region //判斷單位是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @UomId";
                        dynamicParameters.Add("UomId", UomId);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        if (result4.Count() <= 0) throw new SystemException("單位資料錯誤!");
                        #endregion

                        #region //判斷MES製令製程資料是否正確
                        if (MoProcessId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                FROM MES.MoProcess
                                WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var result5 = sqlConnection.Query(sql, dynamicParameters);
                            if (result5.Count() <= 0) throw new SystemException("MES製令製程資料錯誤!");
                        }
                        #endregion

                        #region //判斷 MES製令+ERP工單結構資料 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSetting
                                WHERE MoId = @MoId
                                AND WoDetailId = @WoDetailId
                                AND MoMtlSettingId != @MoMtlSettingId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("WoDetailId", WoDetailId);
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result6 = sqlConnection.Query(sql, dynamicParameters);
                        if (result6.Count() > 0) throw new SystemException("【MES製令 + ERP工單結構資料】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoMtlSetting SET
                                MoId = @MoId,
                                WoDetailId = @WoDetailId,
                                UomId = @UomId,
                                CompositionQuantity = @CompositionQuantity,
                                Base = @Base,
                                LossRate = @LossRate,
                                BomSequence = @BomSequence,
                                ProcessBinding = @ProcessBinding,
                                MoProcessId = @MoProcessId,
                                BarcodeCtrl = @BarcodeCtrl,
                                MainBarcode = @MainBarcode,
                                ControlType = @ControlType,
                                BindType = @BindType,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoId,
                                WoDetailId,
                                UomId,
                                CompositionQuantity = CompositionQuantity > 0 ? (int?)CompositionQuantity : null,
                                Base = Base > 0 ? (int?)Base : null,
                                LossRate = LossRate > 0 ? (int?)LossRate : null,
                                BomSequence,
                                ProcessBinding,
                                MoProcessId = MoProcessId > 0 ? (int?)MoProcessId : null,
                                BarcodeCtrl,
                                MainBarcode,
                                ControlType,
                                BindType,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoMtlSettingId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBindType -- 更新物料上料類型設定 -- Ann 2024-05-06
        public string UpdateBindType(string MoMtlSettingInfo, string BindType)
        {
            try
            {
                if (MoMtlSettingInfo.Length <= 0) throw new SystemException("製令用料設定ID錯誤!!");
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string[] MoMtlSettingArray = MoMtlSettingInfo.Split(',');
                        foreach (var MoMtlSettingId in MoMtlSettingArray)
                        {
                            #region //判斷MES製令用料設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeCtrl, a.MoProcessId, a.BindType
                                    , b.Status
                                    FROM MES.MoMtlSetting a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    WHERE MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("MES製令用料設定資料錯誤!");

                            int? MoProcessId = -1;
                            string OriBindType = "";
                            foreach (var item in result)
                            {
                                //if (BindType == "B" && item.BarcodeCtrl != "Y") throw new SystemException("若上料模式為【條碼】，則必須設定為【需綁定條碼】!!");
                                //if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                                MoProcessId = item.MoProcessId;
                                OriBindType = item.BindType;
                            }
                            #endregion

                            #region //確定是否已有上料
                            switch (OriBindType)
                            {
                                #region //批號模式
                                case "L":
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponent a 
                                            INNER JOIN SCM.LotNumber b ON a.LotNumberId = b.LotNumberId
                                            INNER JOIN MES.MoProcess c ON a.MoProcessId = c.MoProcessId
                                            INNER JOIN MES.MoMtlSetting d ON d.MoId = c.MoId
                                            INNER JOIN MES.WoDetail e ON d.WoDetailId = e.WoDetailId AND e.MtlItemId = b.MtlItemId
                                            WHERE d.MoMtlSettingId = @MoMtlSettingId";
                                    dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                                    var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeComponentResult.Count() > 0) throw new SystemException("此物料已有上料紀錄!!");
                                    break;
                                #endregion
                                #region //條碼模式
                                case "B":
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponent a 
                                            INNER JOIN MES.Barcode b ON a.AssemblyBarcodeId = b.BarcodeId 
                                            INNER JOIN MES.MrBarcodeRegister c ON b.BarcodeNo = c.BarcodeNo
                                            INNER JOIN MES.MrDetail d ON c.MrDetailId = d.MrDetailId AND d.MoId = b.MoId
                                            INNER JOIN MES.MoMtlSetting e ON d.MoId = e.MoId
                                            INNER JOIN MES.WoDetail f ON e.WoDetailId = f.WoDetailId AND f.MtlItemId = d.MtlItemId
                                            WHERE e.MoMtlSettingId = @MoMtlSettingId";
                                    dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                                    var BarcodeComponentResult2 = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeComponentResult2.Count() > 0) throw new SystemException("此物料已有上料紀錄!!");
                                    break;
                                #endregion
                                default:
                                    break;
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoMtlSetting SET
                                    ProcessBinding = @ProcessBinding,
                                    BindType = @BindType,
                                    MoProcessId = @MoProcessId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ProcessBinding = BindType != "N" ? "Y" : "N",
                                    BindType,
                                    MoProcessId = BindType != "N" ? MoProcessId : null,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoMtlSettingId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBindMoProcess -- 更改物料上料製程 -- Ann 2024-05-31
        public string UpdateBindMoProcess(string MoMtlSettingInfo, int MoProcessId)
        {
            try
            {
                if (MoMtlSettingInfo.Length <= 0) throw new SystemException("製令用料設定ID錯誤!!");
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string[] MoMtlSettingArray = MoMtlSettingInfo.Split(',');
                        foreach (var MoMtlSettingId in MoMtlSettingArray)
                        {
                            #region //判斷MES製令用料設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeCtrl, a.ProcessBinding
                                    , b.Status
                                    , d.MtlItemNo
                                    FROM MES.MoMtlSetting a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    INNER JOIN MES.WoDetail c ON a.WoDetailId = c.WoDetailId
                                    INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                    WHERE MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("MES製令用料設定資料錯誤!");
                            string OriBindType = "";

                            foreach (var item in result)
                            {
                                if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                                if (item.ProcessBinding != "Y") throw new SystemException("物料【"+ item.MtlItemNo + "】不需上料，無法綁定製程!!");
                                OriBindType = item.BindType;

                            }
                            #endregion

                            #region //確定是否已有上料
                            switch (OriBindType)
                            {
                                #region //批號模式
                                case "L":
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponent a 
                                            INNER JOIN SCM.LotNumber b ON a.LotNumberId = b.LotNumberId
                                            INNER JOIN MES.MoProcess c ON a.MoProcessId = c.MoProcessId
                                            INNER JOIN MES.MoMtlSetting d ON d.MoId = c.MoId
                                            INNER JOIN MES.WoDetail e ON d.WoDetailId = e.WoDetailId AND e.MtlItemId = b.MtlItemId
                                            WHERE d.MoMtlSettingId = @MoMtlSettingId";
                                    dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                                    var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeComponentResult.Count() > 0) throw new SystemException("此物料已有上料紀錄!!");
                                    break;
                                #endregion
                                #region //條碼模式
                                case "B":
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponent a 
                                            INNER JOIN MES.Barcode b ON a.AssemblyBarcodeId = b.BarcodeId 
                                            INNER JOIN MES.MrBarcodeRegister c ON b.BarcodeNo = c.BarcodeNo
                                            INNER JOIN MES.MrDetail d ON c.MrDetailId = d.MrDetailId AND d.MoId = b.MoId
                                            INNER JOIN MES.MoMtlSetting e ON d.MoId = e.MoId
                                            INNER JOIN MES.WoDetail f ON e.WoDetailId = f.WoDetailId AND f.MtlItemId = d.MtlItemId
                                            WHERE e.MoMtlSettingId = @MoMtlSettingId";
                                    dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                                    var BarcodeComponentResult2 = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeComponentResult2.Count() > 0) throw new SystemException("此物料已有上料紀錄!!");
                                    break;
                                #endregion
                                default:
                                    break;
                            }
                            #endregion


                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoMtlSetting SET
                                    MoProcessId = @MoProcessId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoProcessId,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoMtlSettingId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateManufactureOrder -- 更新MES製令資料 -- Ann 2022-08-02
        public string UpdateManufactureOrder(int MoId, int WoId, int WoSeq, int Quantity, int InputQty, int CompleteQty, int ScrapQty, string ProjectNo,string Remark)
        {
            try
            {
                if (WoSeq <= 0) throw new SystemException("【MES製令序號】不能為空!");
                if (Quantity < 1) throw new SystemException("【MES製令數量】不能為空!");
                if (InputQty < 0) throw new SystemException("【已投入數量】不能為空!");
                if (CompleteQty < 0) throw new SystemException("【完工數量】不能為空!");
                if (ScrapQty < 0) throw new SystemException("【報廢數量】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #region //判斷MES製令是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 Quantity, Status
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("ERP製令資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                        }
                        #endregion

                        #region //判斷ERP製令是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 PlanQty, ConfirmStatus
                                FROM MES.WipOrder
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("ERP製令資料錯誤!");

                        int planQty = 0;
                        foreach (var item in result2)
                        {
                            if (item.ConfirmStatus != "Y") throw new SystemException("ERP製令尚未核單，無法新增!!");
                            planQty = item.PlanQty;
                        }

                        //判斷MES製令數量是否異常
                        if (Quantity > planQty) throw new SystemException("MES製令數量不能大於ERP預計生產數量!");
                        #endregion

                        #region //判斷 ERP製令+MES製令數量 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder
                                WHERE WoId = @WoId
                                AND WoSeq = @WoSeq
                                AND MoId != @MoId";
                        dynamicParameters.Add("WoId", WoId);
                        dynamicParameters.Add("WoSeq", WoSeq);
                        dynamicParameters.Add("MoId", MoId);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        if (result4.Count() > 0) throw new SystemException("【ERP製令 + MES製令序號】重複，請重新輸入!");
                        #endregion

                        #region //判斷MES產量是否大於原本MES設定之批量數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.LotStatus, a.LotQty
                                FROM MES.MoSetting a
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result5 = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in result5)
                        {
                            if (item.LotStatus == "Y")
                            {
                                if (Quantity < Convert.ToInt32(item.LotQty)) throw new SystemException("修改後的MES預計產量小於設定的批量數量(" + item.LotQty + ")，請重新輸入!");
                            }
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.ManufactureOrder SET
                                WoId = @WoId,
                                WoSeq = @WoSeq,
                                Quantity = @Quantity,
                                InputQty = @InputQty,
                                CompleteQty = @CompleteQty,
                                ScrapQty = @ScrapQty,
                                ProjectNo = @ProjectNo,
                                Remark=@Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoId = @MoId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                WoId,
                                WoSeq,
                                Quantity,
                                InputQty,
                                CompleteQty,
                                ScrapQty,
                                ProjectNo,
                                Remark,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBarcodePrint -- 更新批量條碼資料 -- Ann 2022-08-03
        public string UpdateBarcodePrint(string BarcodeNo, int BarcodeQty)
        {
            try
            {
                if (BarcodeQty <= 0) throw new SystemException("【批量數量】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #region //判斷批量條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.PrintId, b.MoId, a.BarcodeQty
                                FROM MES.BarcodePrint a
                                INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("批量條碼資料錯誤!");

                        int MoId = 0;
                        int currentBarcodeQty = 0;
                        int PrintId = -1;
                        foreach (var item in result)
                        {
                            PrintId = item.PrintId;
                            MoId = item.MoId;
                            currentBarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //判斷是否已超過MES預計出貨量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeQty, c.Quantity
                                FROM MES.BarcodePrint a
                                INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() > 0)
                        {
                            int totalQty = 0;
                            int quantity = 0;
                            foreach (var item3 in result3)
                            {
                                quantity = item3.Quantity;
                                totalQty += Convert.ToInt32(item3.BarcodeQty);
                            }

                            if (((totalQty - currentBarcodeQty) + BarcodeQty) > quantity) throw new SystemException("批量總數量超過MES預計產量(" + quantity + ")!");
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodePrint SET
                                BarcodeQty = @BarcodeQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                PrintId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoRoutingSort -- 更新MES製令途程排序 -- Ann 2022-08-08
        public string UpdateMoRoutingSort(string SortNumber)
        {
            try
            {
                if (SortNumber.Length <= 0) throw new SystemException("【途程順序】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        string[] MoRoutingIdArray = SortNumber.Split(',');
                        int MoId = 0;
                        #region //判斷途程製程資料是否正確
                        foreach (var item in MoRoutingIdArray)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MoId
                                    FROM MES.MoRouting
                                    WHERE MoRoutingId = @MoRoutingId";
                            dynamicParameters.Add("MoRoutingId", item);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("途程資料錯誤!");

                            foreach (var item2 in result)
                            {
                                MoId = Convert.ToInt32(item2.MoId);
                            }

                            #region //檢查此製令製程是否已開工過
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoRouting a
                                    INNER JOIN MES.MoProcess b ON a.MoRoutingId = b.MoRoutingId
                                    INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId
                                    WHERE a.MoRoutingId = @MoRoutingId";
                            dynamicParameters.Add("MoRoutingId", item);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0) throw new SystemException("此張製令製程已開工，無法刪除!");
                            #endregion
                        }
                        #endregion

                        #region //先將此途程排序改為-1
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoRouting SET
                                SortNumber = SortNumber * -1,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("LastModifiedDate", LastModifiedDate);
                        dynamicParameters.Add("LastModifiedBy", LastModifiedBy);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新順序
                        int sort = 1;
                        foreach (var item3 in MoRoutingIdArray)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoRouting SET
                                    SortNumber = @SortNumber,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoRoutingId = @MoRoutingId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    SortNumber = sort,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoRoutingId = Convert.ToInt32(item3)
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            sort++;
                        }
                        #endregion

                        #region //同步更新MES.MoProcess順序
                        #region //先將原本製程刪除
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoProcess
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //依目前途程順序依序新增製程
                        int newSort = 1;
                        foreach (var item in MoRoutingIdArray)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT c.RoutingProcessId, c.ProcessId, c.SortNumber, c.ProcessAlias, c.DisplayStatus, c.NecessityStatus
                                    , c.ProcessCheckStatus, c.ProcessCheckType
                                    , d.RoutingItemProcessDesc, d.Remark
                                    FROM MES.MoRouting a
                                    INNER JOIN MES.RoutingItem b ON a.RoutingItemId = b.RoutingItemId
                                    INNER JOIN MES.RoutingProcess c ON b.RoutingId = c.RoutingId
                                    LEFT JOIN MES.RoutingItemProcess d ON d.RoutingItemId = b.RoutingItemId AND d.RoutingProcessId = c.RoutingProcessId
                                    WHERE a.MoRoutingId = @MoRoutingId";
                            dynamicParameters.Add("MoRoutingId", item);

                            var result = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in result)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MoProcess (MoId, MoRoutingId, RoutingProcessId, ProcessId, SortNumber, ProcessAlias, RoutingItemProcessDesc, Remark, DisplayStatus, NecessityStatus
                                        , OspFlag, ProcessCheckStatus, ProcessCheckType
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MoProcessId
                                        VALUES (@MoId, @MoRoutingId, @RoutingProcessId, @ProcessId, @SortNumber, @ProcessAlias, @RoutingItemProcessDesc, @Remark, @DisplayStatus, @NecessityStatus
                                        , @OspFlag, @ProcessCheckStatus, @ProcessCheckType
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MoId,
                                        MoRoutingId = item,
                                        item2.RoutingProcessId,
                                        item2.ProcessId,
                                        SortNumber = newSort,
                                        item2.ProcessAlias,
                                        item2.RoutingItemProcessDesc,
                                        item2.Remark,
                                        item2.DisplayStatus,
                                        item2.NecessityStatus,
                                        OspFlag = "N",
                                        item2.ProcessCheckStatus,
                                        item2.ProcessCheckType,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                newSort++;
                            }
                        }
                        #endregion
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateProcessBinding -- 更新物料控管-是否綁定製程狀態 -- Ann 2022-08-10
        public string UpdateProcessBinding(int MoMtlSettingId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令物料設定資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.ProcessBinding
                                , b.Status
                                FROM MES.MoMtlSetting a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                WHERE a.MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.Status != "N") throw new SystemException("此製令已開工，無法更改!");
                        }
                        #endregion

                        #region //調整為相反狀態
                        string ProcessBinding = "";
                        foreach (var item in result)
                        {
                            ProcessBinding = item.ProcessBinding;
                        }

                        switch (ProcessBinding)
                        {
                            case "Y":
                                ProcessBinding = "N";
                                break;
                            case "N":
                                ProcessBinding = "Y";
                                break;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoMtlSetting SET
                                ProcessBinding = @ProcessBinding,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ProcessBinding,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoMtlSettingId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBarcodeCtrl -- 更新物料控管-是否綁定條碼狀態 -- Ann 2022-08-10
        public string UpdateBarcodeCtrl(int MoMtlSettingId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令物料設定資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.BarcodeCtrl, a.MoId, a.BindType
                                , b.Status
                                , c.MtlItemId
                                FROM MES.MoMtlSetting a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                INNER JOIN MES.WoDetail c ON a.WoDetailId = c.WoDetailId
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");

                        string BarcodeCtrl = "";
                        int MtlItemId = -1;
                        int MoId = -1;
                        string BindType = "";
                        foreach (var item in result)
                        {
                            if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                            BarcodeCtrl = item.BarcodeCtrl;
                            MtlItemId = item.MtlItemId;
                            MoId = item.MoId;
                            BindType = item.BindType;
                        }
                        #endregion

                        #region //若原本為條碼控管，檢核相關卡控
                        if (BarcodeCtrl == "Y")
                        {
                            #region //確認此料號沒有綁定任何一個條碼
                            sql = @"SELECT TOP 1 c.MrErpPrefix + '-' + c.MrErpNo MrErpFullNo
                                        FROM MES.MrBarcodeRegister a 
                                        INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                        INNER JOIN MES.MaterialRequisition c ON b.MrId = c.MrId
                                        WHERE b.MoId = @MoId
                                    AND b.MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var MrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrBarcodeRegisterResult.Count() > 0)
                            {
                                foreach (var item in MrBarcodeRegisterResult)
                                {
                                    throw new SystemException("此料號已被領料單【" + item.MrErpFullNo + "】綁定料號，無法更改!!");
                                }
                            }
                            #endregion

                            #region //確認上料類型非條碼模式
                            if (BindType == "B")
                            {
                                //throw new SystemException("若上料模式為【條碼】，則必須設定為【需綁定條碼】!!");
                            }
                            #endregion
                        }
                        #endregion

                        #region //調整為相反狀態
                        switch (BarcodeCtrl)
                        {
                            case "Y":
                                BarcodeCtrl = "N";
                                break;
                            case "N":
                                BarcodeCtrl = "Y";
                                break;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoMtlSetting SET
                                BarcodeCtrl = @BarcodeCtrl,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeCtrl,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoMtlSettingId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBarcodeCtrlByLotMode -- 更新物料控管-是否綁定條碼狀態(批量設定模式) -- Ann 2023-09-11
        public string UpdateBarcodeCtrlByLotMode(string MoMtlSettingIdList)
        {
            try
            {
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string[] MoMtlSettingIdArray = MoMtlSettingIdList.Split(',');

                        foreach (var moMtlSettingId in MoMtlSettingIdArray)
                        {
                            #region //判斷MES製令物料設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.BarcodeCtrl, a.MoId, a.BindType
                                    , b.Status
                                    , c.MtlItemId
                                    FROM MES.MoMtlSetting a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    INNER JOIN MES.WoDetail c ON a.WoDetailId = c.WoDetailId
                                    WHERE MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.Add("MoMtlSettingId", moMtlSettingId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");

                            int MoId = -1;
                            int MtlItemId = -1;
                            string BarcodeCtrl = "";
                            string BindType = "";
                            foreach (var item in result)
                            {
                                if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                                MoId = item.MoId;
                                MtlItemId = item.MtlItemId;
                                BarcodeCtrl = item.BarcodeCtrl;
                                BindType = item.BindType;
                            }
                            #endregion

                            #region //若原本為條碼控管模式，確認相關卡控
                            if (BarcodeCtrl == "Y")
                            {
                                #region //確認此料號沒有綁定任何一個條碼
                                sql = @"SELECT TOP 1 c.MrErpPrefix + '-' + c.MrErpNo MrErpFullNo
                                            FROM MES.MrBarcodeRegister a 
                                            INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                            INNER JOIN MES.MaterialRequisition c ON b.MrId = c.MrId
                                            WHERE b.MoId = @MoId
                                        AND b.MtlItemId = @MtlItemId";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MtlItemId", MtlItemId);

                                var MrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MrBarcodeRegisterResult.Count() > 0)
                                {
                                    foreach (var item in MrBarcodeRegisterResult)
                                    {
                                        throw new SystemException("此料號已被領料單【" + item.MrErpFullNo + "】綁定料號，無法更改!!");
                                    }
                                }
                                #endregion

                                #region //確認上料類型非條碼模式
                                if (BindType == "B")
                                {
                                    //throw new SystemException("若上料模式為【條碼】，則必須設定為【需綁定條碼】!!");
                                }
                                #endregion
                            }
                            #endregion

                            #region //調整為相反狀態
                            switch (BarcodeCtrl)
                            {
                                case "Y":
                                    BarcodeCtrl = "N";
                                    break;
                                case "N":
                                    BarcodeCtrl = "Y";
                                    break;
                            }
                            #endregion

                            #region //Update MES.MoMtlSetting
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoMtlSetting SET
                                    BarcodeCtrl = @BarcodeCtrl,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeCtrl,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoMtlSettingId = moMtlSettingId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMainBarcode -- 更新物料控管-是否檢核條碼狀態 -- Ann 2022-08-10
        public string UpdateMainBarcode(int MoMtlSettingId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令物料設定資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MainBarcode
                                , b.Status
                                FROM MES.MoMtlSetting a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                WHERE a.MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                        }
                        #endregion

                        #region //調整為相反狀態
                        string MainBarcode = "";
                        foreach (var item in result)
                        {
                            MainBarcode = item.MainBarcode;
                        }

                        switch (MainBarcode)
                        {
                            case "Y":
                                MainBarcode = "N";
                                break;
                            case "N":
                                MainBarcode = "Y";
                                break;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoMtlSetting SET
                                MainBarcode = @MainBarcode,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MainBarcode,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoMtlSettingId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMainBarcodeByLotMode -- 更新物料控管-是否檢核條碼狀態(批量更改模式) -- Ann 2023-09-11
        public string UpdateMainBarcodeByLotMode(string MoMtlSettingIdList)
        {
            try
            {
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string[] MoMtlSettingIdArray = MoMtlSettingIdList.Split(',');

                        foreach (var moMtlSettingId in MoMtlSettingIdArray)
                        {
                            #region //判斷MES製令物料設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.MainBarcode
                                    , b.Status
                                    FROM MES.MoMtlSetting a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    WHERE a.MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.Add("MoMtlSettingId", moMtlSettingId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");

                            foreach (var item in result)
                            {
                                if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                            }
                            #endregion

                            #region //調整為相反狀態
                            string MainBarcode = "";
                            foreach (var item in result)
                            {
                                MainBarcode = item.MainBarcode;
                            }

                            switch (MainBarcode)
                            {
                                case "Y":
                                    MainBarcode = "N";
                                    break;
                                case "N":
                                    MainBarcode = "Y";
                                    break;
                            }
                            #endregion

                            #region //Update MES.MoMtlSetting
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoMtlSetting SET
                                    MainBarcode = @MainBarcode,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MainBarcode,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoMtlSettingId = moMtlSettingId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateControlType -- 更新物料控管-扣帳方式 -- Ann 2022-08-10
        public string UpdateControlType(int MoMtlSettingId, string ControlType)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (ControlType.Length <= 0) throw new SystemException("扣帳方式資料錯誤!");

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令物料設定資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MainBarcode
                                , b.Status
                                FROM MES.MoMtlSetting a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                WHERE a.MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoMtlSetting SET
                                ControlType = @ControlType,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ControlType,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoMtlSettingId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoMtlSettingAttribute -- 更新MES製令物料控管屬性檔 -- Ann 2022-08-11
        public string UpdateMoMtlSettingAttribute(int MoMtlSettingAttrId, int MoMtlSettingId, string ItemNo, string ItemName, string ItemDesc, string ChkUnique, string ChkRange)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (ItemName.Length <= 0) throw new SystemException("【項目名稱】不能為空!");
                        if (ItemName.Length > 30) throw new SystemException("【項目名稱】長度錯誤!");
                        if (ItemDesc.Length > 200) throw new SystemException("【項目描述】長度錯誤!");
                        if (ChkUnique.Length <= 0) throw new SystemException("【檢核重覆值】不能為空!");
                        if (ChkUnique.Length > 1) throw new SystemException("【檢核重覆值】長度錯誤!");

                        if (ChkUnique == "Y")
                        {
                            if (ChkRange.Length <= 0) throw new SystemException("【檢核範圍】不能為空!");
                            if (ChkRange.Length > 1) throw new SystemException("【檢核範圍】長度錯誤!");
                        }

                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #region //判斷MES製令物料控管屬性檔資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSettingAttribute
                                WHERE MoMtlSettingAttrId = @MoMtlSettingAttrId";
                        dynamicParameters.Add("MoMtlSettingAttrId", MoMtlSettingAttrId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料控管屬性檔資料錯誤!");
                        #endregion

                        #region //判斷MES製令物料控管資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSetting
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("MES製令物料控管資料錯誤!");
                        #endregion

                        #region //判斷類別資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM BAS.Type
                                WHERE TypeNo = @TypeNo";
                        dynamicParameters.Add("TypeNo", ItemNo);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() <= 0) throw new SystemException("類別資料錯誤!");
                        #endregion

                        #region //判斷 MES製令物料控管+項目 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSettingAttribute
                                WHERE MoMtlSettingId = @MoMtlSettingId
                                AND ItemNo = @ItemNo
                                AND MoMtlSettingAttrId != @MoMtlSettingAttrId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);
                        dynamicParameters.Add("ItemNo", ItemNo);
                        dynamicParameters.Add("MoMtlSettingAttrId", MoMtlSettingAttrId);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        if (result4.Count() > 0) throw new SystemException("【MES製令 + 項目】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoMtlSettingAttribute SET
                                MoMtlSettingId = @MoMtlSettingId,
                                ItemNo = @ItemNo,
                                ItemName = @ItemName,
                                ItemDesc = @ItemDesc,
                                ChkUnique = @ChkUnique,
                                ChkRange = @ChkRange,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoMtlSettingAttrId = @MoMtlSettingAttrId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoMtlSettingId,
                                ItemNo,
                                ItemName,
                                ItemDesc,
                                ChkUnique,
                                ChkRange = ChkRange.Length > 0 ? ChkRange : null,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoMtlSettingAttrId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoMtlSettingAttributeChkUnique -- 更新物料控管屬性檔-檢核重複值 -- Ann 2022-08-11
        public string UpdateMoMtlSettingAttributeChkUnique(int MoMtlSettingAttrId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令物料控管屬性檔資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ChkUnique
                                FROM MES.MoMtlSettingAttribute
                                WHERE MoMtlSettingAttrId = @MoMtlSettingAttrId";
                        dynamicParameters.Add("MoMtlSettingAttrId", MoMtlSettingAttrId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");
                        #endregion

                        #region //調整為相反狀態
                        string ChkUnique = "";
                        foreach (var item in result)
                        {
                            ChkUnique = item.ChkUnique;
                        }

                        switch (ChkUnique)
                        {
                            case "Y":
                                ChkUnique = "N";
                                break;
                            case "N":
                                ChkUnique = "Y";
                                break;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoMtlSettingAttribute SET
                                ChkUnique = @ChkUnique,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoMtlSettingAttrId = @MoMtlSettingAttrId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ChkUnique,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoMtlSettingAttrId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoProcessSort -- 更新製令製程排序 -- Ann 2022-11-08
        public string UpdateMoProcessSort(string MoProcessSort)
        {
            try
            {
                if (MoProcessSort.Length <= 0) throw new SystemException("【製程順序】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        string[] MoProcessIdArray = MoProcessSort.Split(',');
                        int MoId = -1;
                        int MoProcessCount = 0;
                        foreach (var moProcessId in MoProcessIdArray)
                        {
                            #region //判斷製令製程資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MoId
                                    FROM MES.MoProcess
                                    WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", moProcessId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                            foreach (var item in result)
                            {
                                MoId = item.MoId;
                            }
                            #endregion

                            #region //判斷此製程是否已有過站紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.SortNumber
                                    FROM MES.BarcodeProcess a
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", moProcessId);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);

                            if (result2.Count() > 0)
                            {
                                int newSortNumber = Array.IndexOf(MoProcessIdArray, moProcessId) + 1;
                                foreach (var item in result2)
                                {
                                    if (item.SortNumber != newSortNumber) throw new SystemException("變更名單中有製程已開工，無法更改!");
                                }
                            }
                            #endregion

                            #region //判斷此製程是否為別顆BARCODE的下製程
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.BarcodeNo, b.ProcessAlias
                                    FROM MES.Barcode a
                                    INNER JOIN MES.MoProcess b ON a.NextMoProcessId = b.MoProcessId
                                    WHERE a.NextMoProcessId = @NextMoProcessId";
                            dynamicParameters.Add("NextMoProcessId", moProcessId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result3)
                            {
                                #region //判斷此製程順序有無被更動
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.SortNumber
                                        FROM MES.MoProcess a
                                        WHERE a.MoProcessId = @MoProcessId";
                                dynamicParameters.Add("MoProcessId", moProcessId);

                                var result4 = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item2 in result4)
                                {
                                    int newSortNumber = Array.IndexOf(MoProcessIdArray, moProcessId) + 1;
                                    if (item2.SortNumber != newSortNumber)
                                    {
                                        //遇到下製程已有條碼綁定, 將下製程的NextMoProcessId 改到新的順序
                                        int PreMoProcessId = 0;

                                        if (MoProcessCount == 0)
                                        {
                                            PreMoProcessId = Convert.ToInt32(MoProcessIdArray[0]);
                                        }
                                        else
                                        {
                                            PreMoProcessId = Convert.ToInt32(MoProcessIdArray[MoProcessCount - 1]);
                                        }

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode 
                                                   SET NextMoProcessId = @PreMoProcessId,
                                                       LastModifiedDate = @LastModifiedDate,
                                                       LastModifiedBy = @LastModifiedBy
                                                 WHERE NextMoProcessId = @MoProcessId
                                                   AND MoId = @MoId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                PreMoProcessId,
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                moProcessId,
                                                MoId
                                            });
                                        int UpdateBarcodeNextProcessResult = sqlConnection.Execute(sql, dynamicParameters);
                                    }
                                }
                                #endregion
                            }
                            #endregion

                            MoProcessCount++;
                        }

                        #region //先將此途程製程排序改為-1
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcess SET
                                SortNumber = SortNumber * -1,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("LastModifiedDate", LastModifiedDate);
                        dynamicParameters.Add("LastModifiedBy", LastModifiedBy);
                        dynamicParameters.Add("MoId", MoId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新順序
                        int sort = 1;
                        foreach (var moProcessId in MoProcessIdArray)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoProcess SET
                                    SortNumber = @SortNumber,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    SortNumber = sort,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoProcessId = moProcessId
                                });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            sort++;
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoProcess -- 更新途程製程資料 -- Ann 2022-07-15
        public string UpdateMoProcess(int MoProcessId, int ProcessId, string ProcessAlias
            , string DisplayStatus, string NecessityStatus, string ProcessCheckStatus, string ProcessCheckType, string PackageFlag, string RoutingItemProcessDesc)
        {
            try
            {
                if (ProcessId <= 0) throw new SystemException("【製程資訊】不能為空!");
                if (ProcessAlias.Length <= 0) throw new SystemException("【製程別名】不能為空!");
                if (ProcessAlias.Length > 32) throw new SystemException("【製程別名】長度錯誤!");
                if (!Regex.IsMatch(NecessityStatus, "^(Y|N)$", RegexOptions.IgnoreCase)) throw new SystemException("【必要過站】錯誤!");
                if (!Regex.IsMatch(DisplayStatus, "^(Y|N)$", RegexOptions.IgnoreCase)) throw new SystemException("【是否顯示在流程卡】錯誤!");
                if (ProcessCheckStatus.Length <= 0) throw new SystemException("【是否支援工程檢】不能為空!");
                if (ProcessCheckStatus == "Y" && ProcessCheckType.Length <= 0) throw new SystemException("【檢驗頻率】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MoId, MoRoutingId, RoutingProcessId, RoutingItemProcessDesc, Remark, OspFlag
                                FROM MES.MoProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                        int MoId = -1;
                        foreach (var item in result)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //判斷此製程是否已有開工紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("此製程已有開工紀錄，無法更改!");
                        #endregion

                        #region //判斷製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Process
                                WHERE ProcessId = @ProcessId";
                        dynamicParameters.Add("ProcessId", ProcessId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() <= 0) throw new SystemException("製程資料錯誤!");
                        #endregion

                        #region //判斷製程別名是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcess
                                WHERE MoId = @MoId
                                AND ProcessAlias = @ProcessAlias
                                AND MoProcessId != @MoProcessId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("ProcessAlias", ProcessAlias);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        if (result4.Count() > 0) throw new SystemException("此製程別名已存在!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcess SET
                                MoId = @MoId,
                                ProcessId = @ProcessId,
                                ProcessAlias = @ProcessAlias,
                                DisplayStatus = @DisplayStatus,
                                NecessityStatus = @NecessityStatus,
                                ProcessCheckStatus = @ProcessCheckStatus,
                                ProcessCheckType = @ProcessCheckType,
                                PackageFlag = @PackageFlag,
                                RoutingItemProcessDesc=@RoutingItemProcessDesc,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoId,
                                ProcessId,
                                ProcessAlias,
                                DisplayStatus,
                                NecessityStatus,
                                ProcessCheckStatus,
                                ProcessCheckType = ProcessCheckType.Length > 0 ? ProcessCheckType : null,
                                PackageFlag,
                                RoutingItemProcessDesc,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoProcessId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoNecessityStatus -- 更新製令製程必要過站狀態 -- Ann 2022-11-09
        public string UpdateMoNecessityStatus(int MoProcessId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 NecessityStatus, MoId
                                FROM MES.MoProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                        int MoId = -1;
                        string NecessityStatus = "";
                        foreach (var item in result)
                        {
                            MoId = item.MoId;
                            NecessityStatus = item.NecessityStatus;
                        }
                        #endregion

                        #region //判斷此製程是否已有開工紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("此製程已有開工紀錄，無法更改!");
                        #endregion

                        #region //調整為相反狀態
                        switch (NecessityStatus)
                        {
                            case "Y":
                                NecessityStatus = "N";
                                break;
                            case "N":
                                NecessityStatus = "Y";
                                break;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcess SET
                                NecessityStatus = @NecessityStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                NecessityStatus,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoProcessId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoDisplayStatus -- 更新製令製程是否顯示在流程卡狀態 -- Ann 2022-11-09
        public string UpdateMoDisplayStatus(int MoProcessId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 DisplayStatus, MoId
                                FROM MES.MoProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                        int MoId = -1;
                        string DisplayStatus = "";
                        foreach (var item in result)
                        {
                            MoId = item.MoId;
                            DisplayStatus = item.DisplayStatus;
                        }
                        #endregion

                        #region //判斷此製程是否已有開工紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("此製程已有開工紀錄，無法更改!");
                        #endregion

                        #region //調整為相反狀態
                        switch (DisplayStatus)
                        {
                            case "Y":
                                DisplayStatus = "N";
                                break;
                            case "N":
                                DisplayStatus = "Y";
                                break;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcess SET
                                DisplayStatus = @DisplayStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                DisplayStatus,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoProcessId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMoProcessItem -- 更新製令製程屬性檔 -- Ann 2022-11-09
        public string UpdateMoProcessItem(int MoProcessItemId, int MoProcessId, string ItemNo, string ChkUnique)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (ChkUnique.Length <= 0) throw new SystemException("【是否檢核重複值】不能為空!");

                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #region //判斷製令製程屬性檔資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcessItem a
                                WHERE a.MoProcessItemId = @MoProcessItemId";
                        dynamicParameters.Add("MoProcessItemId", MoProcessItemId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令製程屬性檔資料錯誤!");
                        #endregion

                        #region //判斷製令製程資料是否正確
                        sql = @"SELECT TOP 1 MoId
                                FROM MES.MoProcess a
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                        int MoId = -1;
                        foreach (var item in result2)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //判斷類別資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM BAS.Type a
                                WHERE a.TypeNo = @TypeNo
                                AND a.TypeSchema = 'RoutingProcessItem.ItemNo'";
                        dynamicParameters.Add("TypeNo", ItemNo);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        if (result4.Count() <= 0) throw new SystemException("類別資料錯誤!");
                        #endregion

                        #region //判斷 製令製程+項目 是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcessItem
                                WHERE MoProcessId = @MoProcessId
                                AND ItemNo = @ItemNo
                                AND MoProcessItemId != @MoProcessItemId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        dynamicParameters.Add("ItemNo", ItemNo);
                        dynamicParameters.Add("MoProcessItemId", MoProcessItemId);

                        var result5 = sqlConnection.Query(sql, dynamicParameters);
                        if (result5.Count() > 0) throw new SystemException("【製令製程 + 項目】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcessItem SET
                                MoProcessId = @MoProcessId,
                                ItemNo = @ItemNo,
                                ChkUnique = @ChkUnique,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoProcessItemId = @MoProcessItemId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoProcessId,
                                ItemNo,
                                ChkUnique,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoProcessItemId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateDecompositionFlag -- 更新物料發料一發多狀況 -- Ann 2023-03-21
        public string UpdateDecompositionFlag(int MoMtlSettingId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令物料設定資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.DecompositionFlag
                                , b.Status
                                FROM MES.MoMtlSetting a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                WHERE a.MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                        }
                        #endregion

                        #region //調整為相反狀態
                        string DecompositionFlag = "";
                        foreach (var item in result)
                        {
                            DecompositionFlag = item.DecompositionFlag;
                        }

                        switch (DecompositionFlag)
                        {
                            case "Y":
                                DecompositionFlag = "N";
                                break;
                            case "N":
                                DecompositionFlag = "Y";
                                break;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoMtlSetting SET
                                DecompositionFlag = @DecompositionFlag,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                DecompositionFlag,
                                LastModifiedDate,
                                LastModifiedBy,
                                MoMtlSettingId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateDecompositionFlagByLotMode -- 更新物料發料一發多狀況(批量設定模式) -- Ann 2023-09-11
        public string UpdateDecompositionFlagByLotMode(string MoMtlSettingIdList)
        {
            int rowsAffected = 0;
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string[] MoMtlSettingIdArray = MoMtlSettingIdList.Split(',');

                        foreach (var moMtlSettingId in MoMtlSettingIdArray)
                        {
                            #region //判斷MES製令物料設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.DecompositionFlag
                                    , b.Status
                                    FROM MES.MoMtlSetting a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    WHERE a.MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.Add("MoMtlSettingId", moMtlSettingId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("MES製令物料設定資料錯誤!");

                            foreach (var item in result)
                            {
                                if (item.Status != "N") throw new SystemException("製令已開工，無法更改!");
                            }
                            #endregion

                            #region //調整為相反狀態
                            string DecompositionFlag = "";
                            foreach (var item in result)
                            {
                                DecompositionFlag = item.DecompositionFlag;
                            }

                            switch (DecompositionFlag)
                            {
                                case "Y":
                                    DecompositionFlag = "N";
                                    break;
                                case "N":
                                    DecompositionFlag = "Y";
                                    break;
                            }
                            #endregion

                            #region //UPDATE MES.MoMtlSetting
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoMtlSetting SET
                                    DecompositionFlag = @DecompositionFlag,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoMtlSettingId = @MoMtlSettingId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    DecompositionFlag,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoMtlSettingId = moMtlSettingId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateCloseManufactureOrder -- 指定結案ERP及MES製令 -- Ann 2023-08-25
        public string UpdateCloseManufactureOrder(int WoId, string Remark, string FinishDate)
        {
            try
            {
                int rowsAffected = 0;
                string ErpNo = "";

                if (Remark.Length <= 0) throw new SystemException("變更原因為必填欄位!!");
                if (FinishDate.Length <= 0) throw new SystemException("實際完工日不能為空!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            dynamicParameters = new DynamicParameters();

                            #region //取得USER資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT UserNo
                                    FROM BAS.[User] 
                                    WHERE UserId = @CreateBy";
                            dynamicParameters.Add("CreateBy", CreateBy);

                            var UserResult = sqlConnection.Query(sql, dynamicParameters);

                            string UserNo = "";
                            foreach (var item in UserResult)
                            {
                                UserNo = item.UserNo;
                            }
                            #endregion

                            #region //查詢廠別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB001)) MB001 FROM CMSMB";
                            var CMSMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMBResult.Count() <= 0) throw new SystemException("找不到廠別!!");
                            if (CMSMBResult.Count() > 1) throw new SystemException("廠別數有多個，請與資訊人員確認!!");

                            string FactoryNo = "";
                            foreach (var item in CMSMBResult)
                            {
                                FactoryNo = item.MB001;
                            }
                            #endregion

                            #region //檢核ERP權限
                            string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "", "");
                            #endregion

                            #region //判斷ERP工單資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.WoErpPrefix, a.WoErpNo, a.WoStatus
                                    FROM MES.WipOrder a
                                    WHERE a.WoId = @WoId";
                            dynamicParameters.Add("WoId", WoId);

                            var WoResult = sqlConnection.Query(sql, dynamicParameters);
                            if (WoResult.Count() <= 0) throw new SystemException("ERP工單資料錯誤!!");

                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            foreach (var item in WoResult)
                            {
                                if (item.WoStatus == "Y" || item.WoStatus == "y") throw new SystemException("此工單狀態已完工，無法變更!!");
                                WoErpPrefix = item.WoErpPrefix;
                                WoErpNo = item.WoErpNo;
                            }
                            #endregion

                            #region //確認ERP工單資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TA001, a.TA002, a.TA005, a.TA004, a.TA005, a.TA006, a.TA007, a.TA009, a.TA010, a.TA012, a.TA014
                                    , a.TA015, a.TA016, a.TA017, a.TA018, a.TA020, a.TA021, a.TA022, a.TA023, a.TA026, a.TA027, a.TA028, a.TA029
                                    , a.TA030, a.TA031, a.TA032, a.TA033, a.TA034, a.TA035, a.TA042, a.TA043, a.TA044, a.TA045, a.TA046, a.TA047
                                    , a.TA048, a.TA049, a.TA050, a.TA051, a.TA053, a.TA062, a.TA054, a.TA055, a.TA056, a.TA057, a.TA058, a.TA059
                                    , a.TA060, a.TA061, a.TA063, a.TA069, a.TA070, a.TA081, a.TA003, a.TA011, a.TA019, a.TA072, a.TA092, a.TA505
                                    , a.TA503, a.TA504
                                    FROM MOCTA a 
                                    WHERE a.TA001 = @WoErpPrefix
                                    AND a.TA002 = @WoErpNo";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);

                            var MOCTAResult = sqlConnection2.Query(sql, dynamicParameters);

                            #region //宣告MOCTO欄位
                            string COMPANY = "";
                            string CREATOR = "";
                            string CREATE_DATE = "";
                            string MODIFIER = "";
                            string MODI_DATE = "";
                            string FLAG = "";
                            string CREATE_TIME = "";
                            string CREATE_AP = "";
                            string CREATE_PRID = "";
                            string MODI_TIME = "";
                            string MODI_AP = "";
                            string MODI_PRID = "";

                            string TO001 = "";
                            string TO002 = "";
                            string TO003 = "";
                            string TO004 = "";
                            string TO005 = "";
                            string TO006 = "";
                            string TO007 = "";
                            string TO008 = "";
                            string TO009 = "";
                            string TO010 = "";
                            string TO012 = "";
                            string TO013 = "";
                            string TO014 = "";
                            string TO015 = "";
                            string TO016 = "";
                            decimal TO017 = -1;
                            decimal TO018 = -1;
                            decimal TO019 = -1;
                            decimal TO020 = -1;
                            string TO021 = "";
                            string TO022 = "";
                            string TO023 = "";
                            decimal TO024 = -1;
                            string TO025 = "";
                            string TO026 = "";
                            string TO027 = "";
                            string TO028 = "";
                            string TO029 = "";
                            string TO030 = "";
                            string TO031 = "";
                            string TO032 = "";
                            string TO033 = "";
                            string TO034 = "";
                            string TO035 = "";
                            string TO036 = "";
                            string TO041 = "";
                            decimal TO042 = -1;
                            string TO043 = "";
                            string TO044 = "";
                            string TO045 = "";
                            decimal TO046 = -1;
                            string TO047 = "";
                            decimal TO048 = -1;
                            decimal TO049 = -1;
                            decimal TO050 = -1;
                            string TO051 = "";
                            string TO052 = "";
                            decimal TO053 = -1;
                            string TO054 = "";
                            decimal TO055 = -1;
                            string TO056 = "";
                            string TO057 = "";
                            string TO058 = "";
                            decimal TO059 = -1;
                            string TO060 = "";
                            string TO061 = "";
                            string TO062 = "";
                            string TO063 = "";
                            string TO064 = "";
                            decimal TO070 = -1;
                            string TO071 = "";
                            string TO075 = "";
                            string TO076 = "";
                            string TO077 = "";
                            string TO103 = "";
                            string TO106 = "";
                            string TO107 = "";
                            string TO108 = "";
                            string TO109 = "";
                            string TO110 = "";
                            string TO112 = "";
                            string TO113 = "";
                            string TO114 = "";
                            string TO115 = "";
                            string TO116 = "";
                            decimal TO117 = -1;
                            decimal TO118 = -1;
                            decimal TO119 = -1;
                            decimal TO120 = -1;
                            string TO121 = "";
                            string TO122 = "";
                            string TO123 = "";
                            decimal TO124 = -1;
                            string TO125 = "";
                            string TO126 = "";
                            string TO127 = "";
                            string TO128 = "";
                            string TO129 = "";
                            string TO130 = "";
                            string TO131 = "";
                            string TO132 = "";
                            string TO133 = "";
                            string TO134 = "";
                            string TO135 = "";
                            string TO136 = "";
                            string TO145 = "";
                            decimal TO146 = -1;
                            string TO147 = "";
                            decimal TO148 = -1;
                            decimal TO149 = -1;
                            decimal TO150 = -1;
                            string TO151 = "";
                            string TO152 = "";
                            decimal TO153 = -1;
                            string TO154 = "";
                            string TO157 = "";
                            string TO158 = "";
                            decimal TO159 = -1;
                            string TO160 = "";
                            string TO161 = "";
                            string TO162 = "";
                            string TO163 = "";
                            string TO164 = "";
                            decimal TO170 = -1;
                            string TO171 = "";
                            string TO177 = "";
                            decimal TO500 = -1;
                            decimal TO501 = -1;
                            string TO502 = "";
                            string TO534 = "";
                            #endregion

                            string Edition = "";
                            string TA012 = "";
                            int version = 0;
                            foreach (var item in MOCTAResult)
                            {
                                #region //確認目前製令變更單次數
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT COUNT(1) Count
                                        FROM MOCTO
                                        WHERE TO001 = @WoErpPrefix
                                        AND TO002 = @WoErpNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);

                                var MOCTOResult2 = sqlConnection2.Query(sql, dynamicParameters);

                                foreach (var item2 in MOCTOResult2)
                                {
                                    version = Convert.ToInt32(item2.Count) + 1;
                                }

                                Edition = version.ToString().PadLeft(4, '0');
                                #endregion

                                if (item.TA011 == "Y" || item.TA011 == "y") throw new SystemException("此工單狀態已完工，無法變更!!");
                                TA012 = item.TA012;

                                #region //整理MOCTO DEFAULT欄位
                                COMPANY = FactoryNo;
                                CREATOR = UserNo;
                                CREATE_DATE = DateTime.Now.ToString("yyyyMMdd");
                                MODIFIER = UserNo;
                                MODI_DATE = DateTime.Now.ToString("yyyyMMdd");
                                FLAG = "1";
                                CREATE_TIME = DateTime.Now.ToString("HH:mm:ss");
                                CREATE_AP = UserNo + "PC";
                                CREATE_PRID = "BM";
                                MODI_TIME = DateTime.Now.ToString("HH:mm:ss");
                                MODI_AP = UserNo + "PC";
                                MODI_PRID = "BM";
                                
                                TO001 = item.TA001;
                                TO002 = item.TA002;
                                TO003 = Edition;
                                TO004 = DateTime.Now.ToString("yyyyMMdd");
                                TO005 = Remark;
                                TO006 = DateTime.Now.ToString("yyyyMMdd");
                                TO007 = item.TA004;
                                TO008 = item.TA005;
                                TO009 = item.TA006;
                                TO010 = item.TA007;
                                TO012 = item.TA009;
                                TO013 = item.TA010;
                                TO014 = "y";
                                TO015 = (item.TA012 != null && item.TA012 != "") ? item.TA012 : DateTime.Now.ToString("yyyyMMdd");
                                TO016 = (item.TA014 != null && item.TA014 != "") ? item.TA014 : DateTime.Now.ToString("yyyyMMdd");
                                TO017 = item.TA015;
                                TO018 = item.TA016;
                                TO019 = item.TA017;
                                TO020 = item.TA018;
                                TO021 = item.TA019;
                                TO022 = item.TA020;
                                TO023 = item.TA021;
                                TO024 = item.TA022;
                                TO025 = item.TA023;
                                TO026 = item.TA001;
                                TO027 = item.TA002;
                                TO028 = item.TA026;
                                TO029 = item.TA027;
                                TO030 = item.TA028;
                                TO031 = item.TA029;
                                TO032 = item.TA030;
                                TO033 = item.TA032;
                                TO034 = item.TA033;
                                TO035 = item.TA034;
                                TO036 = item.TA035;
                                TO041 = "Y";
                                TO042 = item.TA031;
                                TO043 = DateTime.Now.ToString("yyyyMMdd");
                                TO044 = UserNo;
                                TO045 = item.TA042;
                                TO046 = item.TA043;
                                TO047 = item.TA044;
                                TO048 = item.TA045;
                                TO049 = item.TA046;
                                TO050 = item.TA047;
                                TO051 = item.TA048;
                                TO052 = item.TA049;
                                TO053 = item.TA050;
                                TO054 = item.TA051;
                                TO055 = item.TA053;
                                TO056 = item.TA054;
                                TO057 = item.TA055;
                                TO058 = item.TA056;
                                TO059 = item.TA057;
                                TO060 = item.TA058;
                                TO061 = item.TA059;
                                TO062 = item.TA060;
                                TO063 = item.TA061;
                                TO064 = item.TA063;
                                TO070 = item.TA069;
                                TO071 = item.TA070;
                                TO075 = "0000";
                                TO076 = "0000";
                                TO077 = item.TA092;
                                TO103 = item.TA062;
                                TO106 = item.TA003;
                                TO107 = item.TA004;
                                TO108 = item.TA005;
                                TO109 = item.TA006;
                                TO110 = item.TA007;
                                TO112 = item.TA009;
                                TO113 = item.TA010;
                                TO114 = item.TA011;
                                TO115 = item.TA012;
                                TO116 = item.TA014;
                                TO117 = item.TA015;
                                TO118 = item.TA016;
                                TO119 = item.TA017;
                                TO120 = item.TA018;
                                TO121 = item.TA019;
                                TO122 = item.TA020;
                                TO123 = item.TA021;
                                TO124 = item.TA022;
                                TO125 = item.TA023;
                                TO126 = item.TA001;
                                TO127 = item.TA002;
                                TO128 = item.TA026;
                                TO129 = item.TA027;
                                TO130 = item.TA028;
                                TO131 = item.TA029;
                                TO132 = item.TA030;
                                TO133 = item.TA032;
                                TO134 = item.TA033;
                                TO135 = item.TA034;
                                TO136 = item.TA035;
                                TO145 = item.TA042;
                                TO146 = item.TA043;
                                TO147 = item.TA044;
                                TO148 = item.TA045;
                                TO149 = item.TA046;
                                TO150 = item.TA047;
                                TO151 = item.TA048;
                                TO152 = item.TA051;
                                TO153 = item.TA053;
                                TO154 = item.TA054;
                                TO157 = item.TA055;
                                TO158 = item.TA056;
                                TO159 = item.TA057;
                                TO160 = item.TA058;
                                TO161 = item.TA059;
                                TO162 = item.TA060;
                                TO163 = item.TA061;
                                TO164 = item.TA063;
                                TO170 = item.TA069;
                                TO171 = item.TA070;
                                TO177 = item.TA092;
                                TO500 = item.TA503;
                                TO501 = item.TA504;
                                TO502 = item.TA505;
                                TO534 = item.TA072;
                                #endregion
                            }
                            #endregion

                            #region //檢核相關條件卡控

                            /*
                            整理製令y指定完工的msg by weiwei大幫手:

                            1.該製令有『領料單』，但領料未確認，做指定結案存檔會顯示警告msg(不會卡控):
                            ”該張製令已有大於實際完工日的領/退料單！”，但仍是可以存檔及確認。

                            2.新增一張製令變更單，需卡控"實際完工日需>=關帳日才可以變更該製令，若沒有實際完工日則都可以"
                            (↑ ERP允許，但會影響到中揚帳務，會有問題，因此需要卡控) --2024-02-06修正

                            3.製令變更指定結案後，
                            當月入庫顯示警告msg:"此製令已完工!" (不會卡控)
                            下月入庫顯示卡控msg:"驗收月份不可大於此製令之完工月份!"
                             */

                            #region //確認實際完工日未關帳
                            DateTime dtDate;
                            if (!DateTime.TryParse(FinishDate, out dtDate))
                            {
                                throw new Exception("實際完工日期格式錯誤!!");
                            }

                            DateTime TA014Date = Convert.ToDateTime(FinishDate);

                            #region //比對ERP關帳日期
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                        FROM CMSMA";
                            var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                            if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                            foreach (var item in cmsmaResult)
                            {
                                string eprDate = item.MA013;
                                string erpYear = eprDate.Substring(0, 4);
                                string erpMonth = eprDate.Substring(4, 2);
                                string erpDay = eprDate.Substring(6, 2);
                                string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                DateTime DocDateDateTime = Convert.ToDateTime(TA014Date);
                                int compare = DocDateDateTime.CompareTo(erpDateTime);
                                if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + TA014Date + ")之單據!!");
                            }
                            #endregion
                            #endregion

                            #region //確認是否有其他未核單之變更單
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MOCTO
                                    WHERE TO001 = @WoErpPrefix
                                    AND TO002 = @WoErpNo
                                    AND TO041 != 'Y'
                                    AND TO041 != 'V'";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);

                            var MOCTOResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (MOCTOResult.Count() > 0) throw new SystemException("此製令尚有變更單未核單!!");
                            #endregion

                            #region //確認製令是否已報工時 CSTI02
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM CSTMB a 
                                    INNER JOIN CMSMQ b ON a.MB003 = b.MQ001
                                    WHERE MB003 = @WoErpPrefix
                                    AND MB004 = @WoErpNo
                                    AND b.UDF01 = 'Y'";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);

                            var CSTMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            //if (CSTMBResult.Count() <= 0) throw new SystemException("此製令尚無任何一筆報工資料，無法進行指定結案!!");
                            #endregion

                            #region //取得MES製令列表，並進行後續檢核
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoId, a.Status, a.WoSeq
                                    , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo
                                    FROM MES.ManufactureOrder a
                                    INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                    WHERE a.WoId = @WoId ";
                            dynamicParameters.Add("WoId", WoId);

                            var MoResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in MoResult)
                            {
                                //if (item.Status != "A") throw new SystemException("製令【" + item.WoErpFullNo + "(" + item.WoSeq + ")】狀態非開工中，無法進行指定結案!!");

                                #region //檢核是否有條碼未入庫
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeId, a.BarcodeNo
                                        FROM MES.Barcode a
                                        WHERE a.MoId = @MoId
                                        AND a.BarcodeStatus != '8'
                                        AND a.BarcodeStatus != '7'
                                        AND a.BarcodeStatus != '10'
                                        AND a.BarcodeQty > 0";
                                dynamicParameters.Add("MoId", item.MoId);

                                var BarcodeStatusResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item2 in BarcodeStatusResult)
                                {
                                    #region //檢核是否有拆併盤紀錄，並且新條碼已入庫
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1 
                                            FROM MES.BarcodeTransfer a 
                                            INNER JOIN MES.Barcode b ON a.ToBarcodeId = b.BarcodeId
                                            WHERE a.FromBarcodeId = @BarcodeId
                                            AND b.BarcodeStatus IN ('8', '7', '10')";
                                    dynamicParameters.Add("BarcodeId", item2.BarcodeId);

                                    var BarcodeTransferResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeTransferResult.Count() <= 0) throw new SystemException("製令【" + item.WoErpFullNo + "(" + item.WoSeq + ")】中條碼【" + item2.BarcodeNo + "】非入庫狀態，無法指定完工!!");
                                    #endregion
                                }
                                #endregion
                            }
                            #endregion

                            #endregion

                            #region //MES段，狀態修改

                            #region //UPDATE MES.WipOrder
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.WipOrder SET 
                                    WoStatus = 'y',
                                    Version = @Edition,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE WoId = @WoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    Edition,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    WoId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //UPDATE MES.ManufactureOrder
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.ManufactureOrder SET 
                                    Status = 'y',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE WoId = @WoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    WoId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #endregion

                            #region //ERP段，新增變更單資料、更改原工單狀態

                            #region //INSERT MOCTO 製令變更單單頭
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MOCTO (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                    , TO001, TO002, TO003, TO004, TO005, TO006, TO007, TO008, TO009, TO010, TO012, TO013, TO014, TO015, TO016, TO017, TO018, TO019, TO020, TO021
                                    , TO022, TO023, TO024, TO025, TO026, TO027, TO028, TO029, TO030, TO031, TO032, TO033, TO034, TO035, TO036, TO041, TO042, TO043, TO044, TO045
                                    , TO046, TO047, TO048, TO049, TO050, TO051, TO052, TO053, TO054, TO055, TO056, TO057, TO058, TO059, TO060, TO061, TO062, TO063, TO064, TO070
                                    , TO071, TO075, TO076, TO077, TO103, TO106, TO107, TO108, TO109, TO110, TO112, TO113, TO114, TO115, TO116, TO117, TO118, TO119, TO120, TO121
                                    , TO122, TO123, TO124, TO125, TO126, TO127, TO128, TO129, TO130, TO131, TO132, TO133, TO134, TO135, TO136, TO145, TO146, TO147, TO148, TO149
                                    , TO150, TO151, TO152, TO153, TO154, TO157, TO158, TO159, TO160, TO161, TO162, TO163, TO164, TO170, TO171, TO177, TO500, TO501, TO502, TO534)
                                    OUTPUT INSERTED.TO001
                                    VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                    , @TO001, @TO002, @TO003, @TO004, @TO005, @TO006, @TO007, @TO008, @TO009, @TO010, @TO012, @TO013, @TO014, @TO015, @TO016, @TO017, @TO018, @TO019, @TO020, @TO021
                                    , @TO022, @TO023, @TO024, @TO025, @TO026, @TO027, @TO028, @TO029, @TO030, @TO031, @TO032, @TO033, @TO034, @TO035, @TO036, @TO041, @TO042, @TO043, @TO044, @TO045
                                    , @TO046, @TO047, @TO048, @TO049, @TO050, @TO051, @TO052, @TO053, @TO054, @TO055, @TO056, @TO057, @TO058, @TO059, @TO060, @TO061, @TO062, @TO063, @TO064, @TO070
                                    , @TO071, @TO075, @TO076, @TO077, @TO103, @TO106, @TO107, @TO108, @TO109, @TO110, @TO112, @TO113, @TO114, @TO115, @TO116, @TO117, @TO118, @TO119, @TO120, @TO121
                                    , @TO122, @TO123, @TO124, @TO125, @TO126, @TO127, @TO128, @TO129, @TO130, @TO131, @TO132, @TO133, @TO134, @TO135, @TO136, @TO145, @TO146, @TO147, @TO148, @TO149
                                    , @TO150, @TO151, @TO152, @TO153, @TO154, @TO157, @TO158, @TO159, @TO160, @TO161, @TO162, @TO163, @TO164, @TO170, @TO171, @TO177, @TO500, @TO501, @TO502, @TO534)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    COMPANY,
                                    CREATOR,
                                    USR_GROUP,
                                    CREATE_DATE,
                                    MODIFIER,
                                    MODI_DATE,
                                    FLAG,
                                    CREATE_TIME,
                                    CREATE_AP,
                                    CREATE_PRID,
                                    MODI_TIME,
                                    MODI_AP,
                                    MODI_PRID,
                                    TO001,
                                    TO002,
                                    TO003,
                                    TO004,
                                    TO005,
                                    TO006,
                                    TO007,
                                    TO008,
                                    TO009,
                                    TO010,
                                    TO012,
                                    TO013,
                                    TO014,
                                    TO015,
                                    TO016,
                                    TO017,
                                    TO018,
                                    TO019,
                                    TO020,
                                    TO021,
                                    TO022,
                                    TO023,
                                    TO024,
                                    TO025,
                                    TO026,
                                    TO027,
                                    TO028,
                                    TO029,
                                    TO030,
                                    TO031,
                                    TO032,
                                    TO033,
                                    TO034,
                                    TO035,
                                    TO036,
                                    TO041,
                                    TO042,
                                    TO043,
                                    TO044,
                                    TO045,
                                    TO046,
                                    TO047,
                                    TO048,
                                    TO049,
                                    TO050,
                                    TO051,
                                    TO052,
                                    TO053,
                                    TO054,
                                    TO055,
                                    TO056,
                                    TO057,
                                    TO058,
                                    TO059,
                                    TO060,
                                    TO061,
                                    TO062,
                                    TO063,
                                    TO064,
                                    TO070,
                                    TO071,
                                    TO075,
                                    TO076,
                                    TO077,
                                    TO103,
                                    TO106,
                                    TO107,
                                    TO108,
                                    TO109,
                                    TO110,
                                    TO112,
                                    TO113,
                                    TO114,
                                    TO115,
                                    TO116,
                                    TO117,
                                    TO118,
                                    TO119,
                                    TO120,
                                    TO121,
                                    TO122,
                                    TO123,
                                    TO124,
                                    TO125,
                                    TO126,
                                    TO127,
                                    TO128,
                                    TO129,
                                    TO130,
                                    TO131,
                                    TO132,
                                    TO133,
                                    TO134,
                                    TO135,
                                    TO136,
                                    TO145,
                                    TO146,
                                    TO147,
                                    TO148,
                                    TO149,
                                    TO150,
                                    TO151,
                                    TO152,
                                    TO153,
                                    TO154,
                                    TO157,
                                    TO158,
                                    TO159,
                                    TO160,
                                    TO161,
                                    TO162,
                                    TO163,
                                    TO164,
                                    TO170,
                                    TO171,
                                    TO177,
                                    TO500,
                                    TO501,
                                    TO502,
                                    TO534
                                });

                            var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion

                            #region //UPDATE MOCTA 製令單頭狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MOCTA SET
                                    MODIFIER = @MODIFIER,
                                    MODI_DATE = @MODI_DATE,
                                    MODI_AP = @MODI_AP,
                                    FLAG += 1,
                                    MODI_TIME = @MODI_TIME,
                                    MODI_PRID = 'BM',
                                    TA011 = 'y',
                                    TA012 = @TA012,
                                    TA014 = @TA014,
                                    TA062 = @TA062
                                    WHERE TA001 = @WoErpPrefix
                                    AND TA002 = @WoErpNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER,
                                    MODI_DATE,
                                    MODI_AP,
                                    MODI_TIME,
                                    TA012 = (TA012 != null && TA012 != "") ? TA012 : DateTime.Now.ToString("yyyyMMdd"),
                                    TA014 = TA014Date.ToString("yyyyMMdd"),
                                    TA062 = Edition,
                                    WoErpPrefix,
                                    WoErpNo
                                });

                            rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                            #endregion

                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateCloseManufactureOrderBatch -- 指定結案ERP及MES製令(批量) -- Shintokuro 2024-07-26
        public string UpdateCloseManufactureOrderBatch(string WoIdList, string Remark, string FinishDate)
        {
            try
            {
                int rowsAffected = 0;
                string ErpNo = "";

                if (Remark.Length <= 0) throw new SystemException("變更原因為必填欄位!!");
                if (FinishDate.Length <= 0) throw new SystemException("實際完工日不能為空!!");

                List<int> WoIdListData = WoIdList.Split(',').Select(int.Parse).ToList();

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //取得USER資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserNo
                                    FROM BAS.[User] 
                                    WHERE UserId = @CreateBy";
                        dynamicParameters.Add("CreateBy", CreateBy);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        string UserNo = "";
                        foreach (var item in UserResult)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            dynamicParameters = new DynamicParameters();



                            #region //查詢廠別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB001)) MB001 FROM CMSMB";
                            var CMSMBResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (CMSMBResult.Count() <= 0) throw new SystemException("找不到廠別!!");
                            if (CMSMBResult.Count() > 1) throw new SystemException("廠別數有多個，請與資訊人員確認!!");

                            string FactoryNo = "";
                            foreach (var item in CMSMBResult)
                            {
                                FactoryNo = item.MB001;
                            }
                            #endregion

                            #region //檢核ERP權限
                            string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "", "");
                            #endregion

                            foreach (var WoId in WoIdListData)
                            {
                                #region //判斷ERP工單資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.WoErpPrefix, a.WoErpNo, a.WoStatus
                                    FROM MES.WipOrder a
                                    WHERE a.WoId = @WoId";
                                dynamicParameters.Add("WoId", WoId);

                                var WoResult = sqlConnection.Query(sql, dynamicParameters);
                                if (WoResult.Count() <= 0) throw new SystemException("ERP工單資料錯誤!!");

                                string WoErpPrefix = "";
                                string WoErpNo = "";
                                foreach (var item in WoResult)
                                {
                                    if (item.WoStatus == "Y" || item.WoStatus == "y") throw new SystemException("此工單狀態已完工，無法變更!!");
                                    WoErpPrefix = item.WoErpPrefix;
                                    WoErpNo = item.WoErpNo;
                                }
                                #endregion

                                #region //確認ERP工單資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TA001, a.TA002, a.TA005, a.TA004, a.TA005, a.TA006, a.TA007, a.TA009, a.TA010, a.TA012, a.TA014
                                    , a.TA015, a.TA016, a.TA017, a.TA018, a.TA020, a.TA021, a.TA022, a.TA023, a.TA026, a.TA027, a.TA028, a.TA029
                                    , a.TA030, a.TA031, a.TA032, a.TA033, a.TA034, a.TA035, a.TA042, a.TA043, a.TA044, a.TA045, a.TA046, a.TA047
                                    , a.TA048, a.TA049, a.TA050, a.TA051, a.TA053, a.TA062, a.TA054, a.TA055, a.TA056, a.TA057, a.TA058, a.TA059
                                    , a.TA060, a.TA061, a.TA063, a.TA069, a.TA070, a.TA081, a.TA003, a.TA011, a.TA019, a.TA072, a.TA092, a.TA505
                                    , a.TA503, a.TA504
                                    FROM MOCTA a 
                                    WHERE a.TA001 = @WoErpPrefix
                                    AND a.TA002 = @WoErpNo";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);

                                var MOCTAResult = sqlConnection2.Query(sql, dynamicParameters);

                                #region //宣告MOCTO欄位
                                string COMPANY = "";
                                string CREATOR = "";
                                string CREATE_DATE = "";
                                string MODIFIER = "";
                                string MODI_DATE = "";
                                string FLAG = "";
                                string CREATE_TIME = "";
                                string CREATE_AP = "";
                                string CREATE_PRID = "";
                                string MODI_TIME = "";
                                string MODI_AP = "";
                                string MODI_PRID = "";

                                string TO001 = "";
                                string TO002 = "";
                                string TO003 = "";
                                string TO004 = "";
                                string TO005 = "";
                                string TO006 = "";
                                string TO007 = "";
                                string TO008 = "";
                                string TO009 = "";
                                string TO010 = "";
                                string TO012 = "";
                                string TO013 = "";
                                string TO014 = "";
                                string TO015 = "";
                                string TO016 = "";
                                decimal TO017 = -1;
                                decimal TO018 = -1;
                                decimal TO019 = -1;
                                decimal TO020 = -1;
                                string TO021 = "";
                                string TO022 = "";
                                string TO023 = "";
                                decimal TO024 = -1;
                                string TO025 = "";
                                string TO026 = "";
                                string TO027 = "";
                                string TO028 = "";
                                string TO029 = "";
                                string TO030 = "";
                                string TO031 = "";
                                string TO032 = "";
                                string TO033 = "";
                                string TO034 = "";
                                string TO035 = "";
                                string TO036 = "";
                                string TO041 = "";
                                decimal TO042 = -1;
                                string TO043 = "";
                                string TO044 = "";
                                string TO045 = "";
                                decimal TO046 = -1;
                                string TO047 = "";
                                decimal TO048 = -1;
                                decimal TO049 = -1;
                                decimal TO050 = -1;
                                string TO051 = "";
                                string TO052 = "";
                                decimal TO053 = -1;
                                string TO054 = "";
                                decimal TO055 = -1;
                                string TO056 = "";
                                string TO057 = "";
                                string TO058 = "";
                                decimal TO059 = -1;
                                string TO060 = "";
                                string TO061 = "";
                                string TO062 = "";
                                string TO063 = "";
                                string TO064 = "";
                                decimal TO070 = -1;
                                string TO071 = "";
                                string TO075 = "";
                                string TO076 = "";
                                string TO077 = "";
                                string TO103 = "";
                                string TO106 = "";
                                string TO107 = "";
                                string TO108 = "";
                                string TO109 = "";
                                string TO110 = "";
                                string TO112 = "";
                                string TO113 = "";
                                string TO114 = "";
                                string TO115 = "";
                                string TO116 = "";
                                decimal TO117 = -1;
                                decimal TO118 = -1;
                                decimal TO119 = -1;
                                decimal TO120 = -1;
                                string TO121 = "";
                                string TO122 = "";
                                string TO123 = "";
                                decimal TO124 = -1;
                                string TO125 = "";
                                string TO126 = "";
                                string TO127 = "";
                                string TO128 = "";
                                string TO129 = "";
                                string TO130 = "";
                                string TO131 = "";
                                string TO132 = "";
                                string TO133 = "";
                                string TO134 = "";
                                string TO135 = "";
                                string TO136 = "";
                                string TO145 = "";
                                decimal TO146 = -1;
                                string TO147 = "";
                                decimal TO148 = -1;
                                decimal TO149 = -1;
                                decimal TO150 = -1;
                                string TO151 = "";
                                string TO152 = "";
                                decimal TO153 = -1;
                                string TO154 = "";
                                string TO157 = "";
                                string TO158 = "";
                                decimal TO159 = -1;
                                string TO160 = "";
                                string TO161 = "";
                                string TO162 = "";
                                string TO163 = "";
                                string TO164 = "";
                                decimal TO170 = -1;
                                string TO171 = "";
                                string TO177 = "";
                                decimal TO500 = -1;
                                decimal TO501 = -1;
                                string TO502 = "";
                                string TO534 = "";
                                #endregion

                                string Edition = "";
                                string TA012 = "";
                                int version = 0;
                                foreach (var item in MOCTAResult)
                                {
                                    #region //確認目前製令變更單次數
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT COUNT(1) Count
                                        FROM MOCTO
                                        WHERE TO001 = @WoErpPrefix
                                        AND TO002 = @WoErpNo";
                                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                    dynamicParameters.Add("WoErpNo", WoErpNo);

                                    var MOCTOResult2 = sqlConnection2.Query(sql, dynamicParameters);

                                    foreach (var item2 in MOCTOResult2)
                                    {
                                        version = Convert.ToInt32(item2.Count) + 1;
                                    }

                                    Edition = version.ToString().PadLeft(4, '0');
                                    #endregion

                                    if (item.TA011 == "Y" || item.TA011 == "y") throw new SystemException("此工單狀態已完工，無法變更!!");
                                    TA012 = item.TA012;

                                    #region //整理MOCTO DEFAULT欄位
                                    COMPANY = FactoryNo;
                                    CREATOR = UserNo;
                                    CREATE_DATE = DateTime.Now.ToString("yyyyMMdd");
                                    MODIFIER = UserNo;
                                    MODI_DATE = DateTime.Now.ToString("yyyyMMdd");
                                    FLAG = "1";
                                    CREATE_TIME = DateTime.Now.ToString("HH:mm:ss");
                                    CREATE_AP = UserNo + "PC";
                                    CREATE_PRID = "BM";
                                    MODI_TIME = DateTime.Now.ToString("HH:mm:ss");
                                    MODI_AP = UserNo + "PC";
                                    MODI_PRID = "BM";

                                    TO001 = item.TA001;
                                    TO002 = item.TA002;
                                    TO003 = Edition;
                                    TO004 = DateTime.Now.ToString("yyyyMMdd");
                                    TO005 = Remark;
                                    TO006 = DateTime.Now.ToString("yyyyMMdd");
                                    TO007 = item.TA004;
                                    TO008 = item.TA005;
                                    TO009 = item.TA006;
                                    TO010 = item.TA007;
                                    TO012 = item.TA009;
                                    TO013 = item.TA010;
                                    TO014 = "y";
                                    TO015 = (item.TA012 != null && item.TA012 != "") ? item.TA012 : DateTime.Now.ToString("yyyyMMdd");
                                    TO016 = (item.TA014 != null && item.TA014 != "") ? item.TA014 : DateTime.Now.ToString("yyyyMMdd");
                                    TO017 = item.TA015;
                                    TO018 = item.TA016;
                                    TO019 = item.TA017;
                                    TO020 = item.TA018;
                                    TO021 = item.TA019;
                                    TO022 = item.TA020;
                                    TO023 = item.TA021;
                                    TO024 = item.TA022;
                                    TO025 = item.TA023;
                                    TO026 = item.TA001;
                                    TO027 = item.TA002;
                                    TO028 = item.TA026;
                                    TO029 = item.TA027;
                                    TO030 = item.TA028;
                                    TO031 = item.TA029;
                                    TO032 = item.TA030;
                                    TO033 = item.TA032;
                                    TO034 = item.TA033;
                                    TO035 = item.TA034;
                                    TO036 = item.TA035;
                                    TO041 = "Y";
                                    TO042 = item.TA031;
                                    TO043 = DateTime.Now.ToString("yyyyMMdd");
                                    TO044 = UserNo;
                                    TO045 = item.TA042;
                                    TO046 = item.TA043;
                                    TO047 = item.TA044;
                                    TO048 = item.TA045;
                                    TO049 = item.TA046;
                                    TO050 = item.TA047;
                                    TO051 = item.TA048;
                                    TO052 = item.TA049;
                                    TO053 = item.TA050;
                                    TO054 = item.TA051;
                                    TO055 = item.TA053;
                                    TO056 = item.TA054;
                                    TO057 = item.TA055;
                                    TO058 = item.TA056;
                                    TO059 = item.TA057;
                                    TO060 = item.TA058;
                                    TO061 = item.TA059;
                                    TO062 = item.TA060;
                                    TO063 = item.TA061;
                                    TO064 = item.TA063;
                                    TO070 = item.TA069;
                                    TO071 = item.TA070;
                                    TO075 = "0000";
                                    TO076 = "0000";
                                    TO077 = item.TA092;
                                    TO103 = item.TA062;
                                    TO106 = item.TA003;
                                    TO107 = item.TA004;
                                    TO108 = item.TA005;
                                    TO109 = item.TA006;
                                    TO110 = item.TA007;
                                    TO112 = item.TA009;
                                    TO113 = item.TA010;
                                    TO114 = item.TA011;
                                    TO115 = item.TA012;
                                    TO116 = item.TA014;
                                    TO117 = item.TA015;
                                    TO118 = item.TA016;
                                    TO119 = item.TA017;
                                    TO120 = item.TA018;
                                    TO121 = item.TA019;
                                    TO122 = item.TA020;
                                    TO123 = item.TA021;
                                    TO124 = item.TA022;
                                    TO125 = item.TA023;
                                    TO126 = item.TA001;
                                    TO127 = item.TA002;
                                    TO128 = item.TA026;
                                    TO129 = item.TA027;
                                    TO130 = item.TA028;
                                    TO131 = item.TA029;
                                    TO132 = item.TA030;
                                    TO133 = item.TA032;
                                    TO134 = item.TA033;
                                    TO135 = item.TA034;
                                    TO136 = item.TA035;
                                    TO145 = item.TA042;
                                    TO146 = item.TA043;
                                    TO147 = item.TA044;
                                    TO148 = item.TA045;
                                    TO149 = item.TA046;
                                    TO150 = item.TA047;
                                    TO151 = item.TA048;
                                    TO152 = item.TA051;
                                    TO153 = item.TA053;
                                    TO154 = item.TA054;
                                    TO157 = item.TA055;
                                    TO158 = item.TA056;
                                    TO159 = item.TA057;
                                    TO160 = item.TA058;
                                    TO161 = item.TA059;
                                    TO162 = item.TA060;
                                    TO163 = item.TA061;
                                    TO164 = item.TA063;
                                    TO170 = item.TA069;
                                    TO171 = item.TA070;
                                    TO177 = item.TA092;
                                    TO500 = item.TA503;
                                    TO501 = item.TA504;
                                    TO502 = item.TA505;
                                    TO534 = item.TA072;
                                    #endregion
                                }
                                #endregion

                                #region //檢核相關條件卡控

                                /*
                                整理製令y指定完工的msg by weiwei大幫手:

                                1.該製令有『領料單』，但領料未確認，做指定結案存檔會顯示警告msg(不會卡控):
                                ”該張製令已有大於實際完工日的領/退料單！”，但仍是可以存檔及確認。

                                2.新增一張製令變更單，需卡控"實際完工日需>=關帳日才可以變更該製令，若沒有實際完工日則都可以"
                                (↑ ERP允許，但會影響到中揚帳務，會有問題，因此需要卡控) --2024-02-06修正

                                3.製令變更指定結案後，
                                當月入庫顯示警告msg:"此製令已完工!" (不會卡控)
                                下月入庫顯示卡控msg:"驗收月份不可大於此製令之完工月份!"
                                 */

                                #region //確認實際完工日未關帳
                                DateTime dtDate;
                                if (!DateTime.TryParse(FinishDate, out dtDate))
                                {
                                    throw new Exception("實際完工日期格式錯誤!!");
                                }

                                DateTime TA014Date = Convert.ToDateTime(FinishDate);

                                #region //比對ERP關帳日期
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                                        FROM CMSMA";
                                var cmsmaResult = sqlConnection2.Query(sql, dynamicParameters);
                                if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                                foreach (var item in cmsmaResult)
                                {
                                    string eprDate = item.MA013;
                                    string erpYear = eprDate.Substring(0, 4);
                                    string erpMonth = eprDate.Substring(4, 2);
                                    string erpDay = eprDate.Substring(6, 2);
                                    string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                    DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                    DateTime DocDateDateTime = Convert.ToDateTime(TA014Date);
                                    int compare = DocDateDateTime.CompareTo(erpDateTime);
                                    if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + TA014Date + ")之單據!!");
                                }
                                #endregion
                                #endregion

                                #region //確認是否有其他未核單之變更單
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                    FROM MOCTO
                                    WHERE TO001 = @WoErpPrefix
                                    AND TO002 = @WoErpNo
                                    AND TO041 != 'Y'
                                    AND TO041 != 'V'";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);

                                var MOCTOResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (MOCTOResult.Count() > 0) throw new SystemException("此製令尚有變更單未核單!!");
                                #endregion

                                #region //確認製令是否已報工時 CSTI02
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                    FROM CSTMB a 
                                    INNER JOIN CMSMQ b ON a.MB003 = b.MQ001
                                    WHERE MB003 = @WoErpPrefix
                                    AND MB004 = @WoErpNo
                                    AND b.UDF01 = 'Y'";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                dynamicParameters.Add("WoErpNo", WoErpNo);

                                var CSTMBResult = sqlConnection2.Query(sql, dynamicParameters);

                                //if (CSTMBResult.Count() <= 0) throw new SystemException("此製令尚無任何一筆報工資料，無法進行指定結案!!");
                                #endregion

                                #region //取得MES製令列表，並進行後續檢核
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoId, a.Status, a.WoSeq
                                    , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo
                                    FROM MES.ManufactureOrder a
                                    INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                    WHERE a.WoId = @WoId ";
                                dynamicParameters.Add("WoId", WoId);

                                var MoResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in MoResult)
                                {
                                    //if (item.Status != "A") throw new SystemException("製令【" + item.WoErpFullNo + "(" + item.WoSeq + ")】狀態非開工中，無法進行指定結案!!");

                                    #region //檢核是否有條碼未入庫
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeId, a.BarcodeNo
                                        FROM MES.Barcode a
                                        WHERE a.MoId = @MoId
                                        AND a.BarcodeStatus != '8'
                                        AND a.BarcodeStatus != '7'";
                                    dynamicParameters.Add("MoId", item.MoId);

                                    var BarcodeStatusResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item2 in BarcodeStatusResult)
                                    {
                                        #region //檢核是否有拆併盤紀錄，並且新條碼已入庫
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1 
                                            FROM MES.BarcodeTransfer a 
                                            INNER JOIN MES.Barcode b ON a.ToBarcodeId = b.BarcodeId
                                            WHERE a.FromBarcodeId = @BarcodeId
                                            AND b.BarcodeStatus IN ('8', '7')";
                                        dynamicParameters.Add("BarcodeId", item2.BarcodeId);

                                        var BarcodeTransferResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (BarcodeTransferResult.Count() <= 0) throw new SystemException("製令【" + item.WoErpFullNo + "(" + item.WoSeq + ")】中條碼【" + item2.BarcodeNo + "】非入庫狀態，無法指定完工!!");
                                        #endregion
                                    }
                                    #endregion
                                }
                                #endregion

                                #endregion

                                #region //MES段，狀態修改

                                #region //UPDATE MES.WipOrder
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.WipOrder SET 
                                    WoStatus = 'y',
                                    Version = @Edition,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE WoId = @WoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        Edition,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        WoId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //UPDATE MES.ManufactureOrder
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.ManufactureOrder SET 
                                    Status = 'y',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE WoId = @WoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        WoId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #endregion

                                #region //ERP段，新增變更單資料、更改原工單狀態

                                #region //INSERT MOCTO 製令變更單單頭
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MOCTO (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                    , TO001, TO002, TO003, TO004, TO005, TO006, TO007, TO008, TO009, TO010, TO012, TO013, TO014, TO015, TO016, TO017, TO018, TO019, TO020, TO021
                                    , TO022, TO023, TO024, TO025, TO026, TO027, TO028, TO029, TO030, TO031, TO032, TO033, TO034, TO035, TO036, TO041, TO042, TO043, TO044, TO045
                                    , TO046, TO047, TO048, TO049, TO050, TO051, TO052, TO053, TO054, TO055, TO056, TO057, TO058, TO059, TO060, TO061, TO062, TO063, TO064, TO070
                                    , TO071, TO075, TO076, TO077, TO103, TO106, TO107, TO108, TO109, TO110, TO112, TO113, TO114, TO115, TO116, TO117, TO118, TO119, TO120, TO121
                                    , TO122, TO123, TO124, TO125, TO126, TO127, TO128, TO129, TO130, TO131, TO132, TO133, TO134, TO135, TO136, TO145, TO146, TO147, TO148, TO149
                                    , TO150, TO151, TO152, TO153, TO154, TO157, TO158, TO159, TO160, TO161, TO162, TO163, TO164, TO170, TO171, TO177, TO500, TO501, TO502, TO534)
                                    OUTPUT INSERTED.TO001
                                    VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                    , @TO001, @TO002, @TO003, @TO004, @TO005, @TO006, @TO007, @TO008, @TO009, @TO010, @TO012, @TO013, @TO014, @TO015, @TO016, @TO017, @TO018, @TO019, @TO020, @TO021
                                    , @TO022, @TO023, @TO024, @TO025, @TO026, @TO027, @TO028, @TO029, @TO030, @TO031, @TO032, @TO033, @TO034, @TO035, @TO036, @TO041, @TO042, @TO043, @TO044, @TO045
                                    , @TO046, @TO047, @TO048, @TO049, @TO050, @TO051, @TO052, @TO053, @TO054, @TO055, @TO056, @TO057, @TO058, @TO059, @TO060, @TO061, @TO062, @TO063, @TO064, @TO070
                                    , @TO071, @TO075, @TO076, @TO077, @TO103, @TO106, @TO107, @TO108, @TO109, @TO110, @TO112, @TO113, @TO114, @TO115, @TO116, @TO117, @TO118, @TO119, @TO120, @TO121
                                    , @TO122, @TO123, @TO124, @TO125, @TO126, @TO127, @TO128, @TO129, @TO130, @TO131, @TO132, @TO133, @TO134, @TO135, @TO136, @TO145, @TO146, @TO147, @TO148, @TO149
                                    , @TO150, @TO151, @TO152, @TO153, @TO154, @TO157, @TO158, @TO159, @TO160, @TO161, @TO162, @TO163, @TO164, @TO170, @TO171, @TO177, @TO500, @TO501, @TO502, @TO534)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        COMPANY,
                                        CREATOR,
                                        USR_GROUP,
                                        CREATE_DATE,
                                        MODIFIER,
                                        MODI_DATE,
                                        FLAG,
                                        CREATE_TIME,
                                        CREATE_AP,
                                        CREATE_PRID,
                                        MODI_TIME,
                                        MODI_AP,
                                        MODI_PRID,
                                        TO001,
                                        TO002,
                                        TO003,
                                        TO004,
                                        TO005,
                                        TO006,
                                        TO007,
                                        TO008,
                                        TO009,
                                        TO010,
                                        TO012,
                                        TO013,
                                        TO014,
                                        TO015,
                                        TO016,
                                        TO017,
                                        TO018,
                                        TO019,
                                        TO020,
                                        TO021,
                                        TO022,
                                        TO023,
                                        TO024,
                                        TO025,
                                        TO026,
                                        TO027,
                                        TO028,
                                        TO029,
                                        TO030,
                                        TO031,
                                        TO032,
                                        TO033,
                                        TO034,
                                        TO035,
                                        TO036,
                                        TO041,
                                        TO042,
                                        TO043,
                                        TO044,
                                        TO045,
                                        TO046,
                                        TO047,
                                        TO048,
                                        TO049,
                                        TO050,
                                        TO051,
                                        TO052,
                                        TO053,
                                        TO054,
                                        TO055,
                                        TO056,
                                        TO057,
                                        TO058,
                                        TO059,
                                        TO060,
                                        TO061,
                                        TO062,
                                        TO063,
                                        TO064,
                                        TO070,
                                        TO071,
                                        TO075,
                                        TO076,
                                        TO077,
                                        TO103,
                                        TO106,
                                        TO107,
                                        TO108,
                                        TO109,
                                        TO110,
                                        TO112,
                                        TO113,
                                        TO114,
                                        TO115,
                                        TO116,
                                        TO117,
                                        TO118,
                                        TO119,
                                        TO120,
                                        TO121,
                                        TO122,
                                        TO123,
                                        TO124,
                                        TO125,
                                        TO126,
                                        TO127,
                                        TO128,
                                        TO129,
                                        TO130,
                                        TO131,
                                        TO132,
                                        TO133,
                                        TO134,
                                        TO135,
                                        TO136,
                                        TO145,
                                        TO146,
                                        TO147,
                                        TO148,
                                        TO149,
                                        TO150,
                                        TO151,
                                        TO152,
                                        TO153,
                                        TO154,
                                        TO157,
                                        TO158,
                                        TO159,
                                        TO160,
                                        TO161,
                                        TO162,
                                        TO163,
                                        TO164,
                                        TO170,
                                        TO171,
                                        TO177,
                                        TO500,
                                        TO501,
                                        TO502,
                                        TO534
                                    });

                                var insertResult = sqlConnection2.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                #endregion

                                #region //UPDATE MOCTA 製令單頭狀態
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MOCTA SET
                                    MODIFIER = @MODIFIER,
                                    MODI_DATE = @MODI_DATE,
                                    MODI_AP = @MODI_AP,
                                    FLAG += 1,
                                    MODI_TIME = @MODI_TIME,
                                    MODI_PRID = 'BM',
                                    TA011 = 'y',
                                    TA012 = @TA012,
                                    TA014 = @TA014,
                                    TA062 = @TA062
                                    WHERE TA001 = @WoErpPrefix
                                    AND TA002 = @WoErpNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MODIFIER,
                                        MODI_DATE,
                                        MODI_AP,
                                        MODI_TIME,
                                        TA012 = (TA012 != null && TA012 != "") ? TA012 : DateTime.Now.ToString("yyyyMMdd"),
                                        TA014 = TA014Date.ToString("yyyyMMdd"),
                                        TA062 = Edition,
                                        WoErpPrefix,
                                        WoErpNo
                                    });

                                rowsAffected += sqlConnection2.Execute(sql, dynamicParameters);
                                #endregion

                                #endregion


                            }


                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMpcIdStatus -- 更新製令途程變更單狀態 -- Shintokuro 2022.10.27
        public string UpdateMpcIdStatus(int MpcId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();


                        #region //判斷生產單元是否正確
                        sql = @"SELECT TOP 1 Status
                                FROM MES.MoProcessChange
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        var resultStatus = sqlConnection.Query(sql, dynamicParameters);
                        if (resultStatus.Count() <= 0) throw new SystemException("製令途程變更單資料錯誤!");
                        var Status = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Status;
                        //if(Status =="A") throw new SystemException("變更單已啟用,不可以更動!!!");

                        #region //判斷變更單內的條碼條碼是否有開工
                        sql = @"SELECT c.BarcodeNo,b.ProcessAlias
                                FROM MES.MoProcessChange a
                                INNER JOIN MES.MpcRoutingProcess b ON a.MpcId = b.MpcId
                                INNER JOIN MES.MpcBarcode c ON a.MpcId = c.MpcId
                                AND EXISTS(SELECT 1
                                           FROM MES.MoProcess d
			                               WHERE b.MoProcessId = d.MoProcessId
			                               AND b.SortNumber != d.SortNumber
				                           AND EXISTS(SELECT 1
				                                      FROM MES.BarcodeProcess e
							                          INNER JOIN MES.Barcode f on e.BarcodeId = f.BarcodeId
							                          WHERE d.MoProcessId = e.MoProcessId
							                          AND f.BarcodeNo = c.BarcodeNo
                                                      )
                                           )
                                WHERE a.MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            var ProcessAlias = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessAlias;
                            string BarcodeNo = "";
                            int itemNum = 0;
                            foreach (var item in result)
                            {
                                if (itemNum == 0)
                                {
                                    BarcodeNo += "\n" + item.BarcodeNo;
                                }
                                else
                                {
                                    BarcodeNo += "\n," + item.BarcodeNo;

                                }
                                itemNum++;
                            }
                            throw new SystemException("【" + ProcessAlias + "】站,以下條碼:【" + BarcodeNo + "\n】有過站紀錄了!!!不可以變更!!");
                        }


                        string status = "";
                        foreach (var item in resultStatus)
                        {
                            status = item.Status;
                        }

                        #region //調整為相反狀態
                        switch (status)
                        {
                            case "A":
                                status = "S";
                                break;
                            case "S":
                                status = "A";
                                break;
                        }
                        #endregion
                        #endregion
                        #endregion


                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcessChange SET
                                Status = @Status,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MpcId = @MpcId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                Status = status,
                                LastModifiedDate,
                                LastModifiedBy,
                                MpcId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion        

        #region //UpdateMpcRoutingProcessSort -- 更新途程變更單製程排序 -- Shintokuro 2022-11-02
        public string UpdateMpcRoutingProcessSort(int MpcId, string RoutingProcessSort)
        {
            try
            {
                if (RoutingProcessSort.Length <= 0) throw new SystemException("【製程順序】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        string[] RoutingProcessSortArray = RoutingProcessSort.Split(','); //變動製程順序(全)

                        #region //判定是否有綁定條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MpcBarcodeId 
                                FROM MES.MpcBarcode a
                                WHERE a.MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);
                        var mpcBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (mpcBarcodeResult.Count() <= 0) throw new SystemException("請先在製令途程變更單綁定條碼,才能做製程順序變更!");
                        #endregion

                        #region //撈取原途程順序
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT SortNumber 
                                FROM MES.MoProcess a
                                INNER JOIN MES.MoProcessChange b on a.MoId =b.MoId
                                WHERE b.MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        var sortNumberResult = sqlConnection.Query(sql, dynamicParameters);
                        if (sortNumberResult.Count() <= 0) throw new SystemException("途程製程資料錯誤!");
                        int itemNum = 0;
                        string sortNumbrtOre = "";
                        foreach (var item in sortNumberResult)
                        {
                            if (itemNum == 0)
                            {
                                sortNumbrtOre = Convert.ToString(item.SortNumber);
                            }
                            else
                            {
                                sortNumbrtOre += "," + Convert.ToString(item.SortNumber);
                            }
                            itemNum++;
                        }
                        string[] sortNumbrtOreArray = sortNumbrtOre.Split(','); //原製程順序
                        #endregion
                        #region //判斷順序變動的製程
                        List<string> changeSortNumbrt = new List<string>(); //變動的製程順序(比較過後)
                        itemNum = 0;
                        foreach (var item in sortNumbrtOreArray)
                        {
                            if (RoutingProcessSortArray[itemNum].Contains(item) == false)
                            {
                                changeSortNumbrt.Add(item);
                            }
                            itemNum++;

                        }
                        #endregion


                        #region //撈取變動製成的ID
                        List<int> RoutingProcessIdArray = new List<int>(); //變動的製程ID
                        bool cheack313 = true;
                        itemNum = 0;
                        foreach (var item in RoutingProcessSortArray)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.MpcId,a.MpcRoutingProcessId,a.SortNumber,b.ProcessId
                                FROM MES.MpcRoutingProcess a
                                INNER JOIN MES.MoProcess b on a.MoProcessId = b.MoProcessId
                                INNER JOIN MES.Process c on b.ProcessId = c.ProcessId
                                WHERE a.SortNumber = @SortNumber
                                AND a.MpcId = @MpcId";
                            dynamicParameters.Add("SortNumber", item);
                            dynamicParameters.Add("MpcId", MpcId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("途程製程資料錯誤!");
                            var MpcRoutingProcessId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MpcRoutingProcessId;
                            var ProcessId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessId;
                            //if (itemNum == 0) { if (ProcessId == 313) throw new SystemException("退鎳站不可以是首站!"); }
                            if (ProcessId == 312) { cheack313 = true; };
                            if (ProcessId == 313) { cheack313 = false; };
                            RoutingProcessIdArray.Add(MpcRoutingProcessId);
                            itemNum++;
                        }
                        if (cheack313 == false) throw new SystemException("退鎳站必須在鎳站前!");
                        #endregion


                        #region //判斷途程製程資料是否正確
                        int MoProcessId = 0;
                        foreach (var item in changeSortNumbrt)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MpcId,MoProcessId
                                FROM MES.MpcRoutingProcess
                                WHERE SortNumber = @SortNumber
                                AND MpcId = @MpcId";
                            dynamicParameters.Add("SortNumber", item);
                            dynamicParameters.Add("MpcId", MpcId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("途程製程資料錯誤!");

                            foreach (var item2 in result)
                            {
                                MoProcessId = Convert.ToInt32(item2.MoProcessId);
                            }

                            #region //判斷製成是否已經過站
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT d.BarcodeNo,a.ProcessAlias
                                    FROM MES.MoProcess a
                                    INNER JOIN MES.BarcodeProcess b ON a.MoProcessId = b.MoProcessId
	                                INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
	                                INNER JOIN MES.MpcBarcode d ON c.BarcodeNo = d.BarcodeNo
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                var BarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;
                                var ProcessAlias = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessAlias;
                                throw new SystemException("【" + BarcodeNo + "】在【" + ProcessAlias + "】已經過站，無法更動製程順序!");
                            }
                            #endregion
                        }
                        #endregion

                        #region //先將此途程製程排序改為-1
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MpcRoutingProcess SET
                                SortNumber = SortNumber * -1,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);
                        dynamicParameters.Add("LastModifiedDate", LastModifiedDate);
                        dynamicParameters.Add("LastModifiedBy", LastModifiedBy);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新順序
                        int sort = 1;
                        foreach (var item3 in RoutingProcessIdArray)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MpcRoutingProcess SET
                                    SortNumber = @SortNumber,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MpcRoutingProcessId = @MpcRoutingProcessId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    SortNumber = sort,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MpcRoutingProcessId = Convert.ToInt32(item3)
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            sort++;
                        }
                        #endregion

                        #region //更新 - 單頭順序狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcessChange SET
                                    SortChange = 'C',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MpcId = @MpcId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LastModifiedDate,
                                LastModifiedBy,
                                MpcId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBarcodeAttribute -- 更新屬性置換資料 -- Yi 2023.05.17
        public string UpdateBarcodeAttribute(int ProcessAttrLogId, int OriBarcodeAttrId, int NewBarcodeAttrId
            , int MoId, string NewItemValue, string NewSortNumber, string Remark, string ChkUnique)
        {
            try
            {
                if (OriBarcodeAttrId <= 0) throw new SystemException("【原始屬性資料】不能為空!");
                if (NewItemValue.Length <= 0) throw new SystemException("【欲更新資料】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();
                        int rowsAffected = 0;

                        #region //判斷 OriBarcodeAttrId 刻號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId OriBarcodeId, a.ItemNo OriItemNo, a.ItemValue OriItemValue
                                , b.MoId OriMoId
                                FROM MES.BarcodeAttribute a
                                INNER JOIN MES.Barcode b ON b.BarcodeId = a.BarcodeId
                                WHERE a.BarcodeAttrId = @OriBarcodeAttrId";
                        dynamicParameters.Add("OriBarcodeAttrId", OriBarcodeAttrId);

                        var oriBarcodeAttrResult = sqlConnection.Query(sql, dynamicParameters);
                        if (oriBarcodeAttrResult.Count() <= 0) throw new SystemException("原始屬性資料錯誤!");

                        int OriMoId = -1;
                        int OriBarcodeId = -1;
                        string OriItemNo = "";
                        string OriItemValue = "";

                        int NewMoId = -1;
                        int NewBarcodeId = -1;
                        string NewItemNo = "";
                        foreach (var item in oriBarcodeAttrResult)
                        {
                            OriMoId = item.OriMoId;
                            OriBarcodeId = item.OriBarcodeId;
                            OriItemNo = item.OriItemNo;
                            OriItemValue = item.OriItemValue;
                        }
                        #endregion

                        #region //判斷製令及使用者公司別，防止系統取錯人
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder a
                                INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                WHERE b.CompanyId = (
                                    SELECT zc.CompanyId
                                    FROM MES.Barcode za
                                    INNER JOIN MES.ManufactureOrder zb ON za.MoId = zb.MoId
                                    INNER JOIN MES.WipOrder zc ON zb.WoId = zc.WoId
                                    WHERE za.BarcodeId = @BarcodeId
                                )
                                AND a.MoId = @MoId";
                        dynamicParameters.Add("BarcodeId", OriBarcodeId);
                        dynamicParameters.Add("MoId", OriMoId);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (companyResult.Count() <= 0) throw new SystemException("製令與使用者所屬公司不符!");
                        #endregion

                        //#region //判斷MoProcessItem刻號是否允許重複
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT b.ItemNo, ISNULL(b.ChkUnique, '') ChkUnique, a.MoId, d.BarcodeId, d.BarcodeNo
                        //        FROM MES.MoProcess a
                        //        LEFT JOIN MES.MoProcessItem b ON b.MoProcessId = a.MoProcessId
                        //        INNER JOIN MES.ManufactureOrder c ON c.MoId = a.MoId
                        //        INNER JOIN MES.Barcode d ON d.MoId = c.MoId
                        //        INNER JOIN MES.BarcodeAttribute e ON e.BarcodeId = d.BarcodeId
                        //        WHERE b.ItemNo = @ItemNo
                        //        AND d.BarcodeId = @BarcodeId";
                        //dynamicParameters.Add("ItemNo", OriItemNo);
                        //dynamicParameters.Add("BarcodeId", OriBarcodeId);

                        //var result = sqlConnection.Query(sql, dynamicParameters);
                        //if (result.Count() <= 0) throw new SystemException("【原始屬性】資料錯誤!");

                        //string chkunique = "";
                        //foreach (var item in result)
                        //{
                        //    chkunique = item.ChkUnique;
                        //}
                        //#endregion

                        if (OriItemNo == "Lettering")
                        {

                            if (NewSortNumber.Length <= 0) throw new SystemException("【欲更新流水號】不能為空!");

                            #region //判斷MES.MoItemPart資料是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MoItemPartId
                                    FROM MES.MoItemPart
                                    WHERE MoId = @OriMoId
                                    AND MoItemPartNo = @MoItemPartNo";
                            dynamicParameters.Add("OriMoId", OriMoId);
                            dynamicParameters.Add("MoItemPartNo", OriItemValue);

                            var moItemPartResult = sqlConnection.Query(sql, dynamicParameters);
                            if (moItemPartResult.Count() <= 0) throw new SystemException("該製令刻號資料錯誤!");

                            int moItemPartId = -1;
                            foreach (var item in moItemPartResult)
                            {
                                moItemPartId = item.MoItemPartId;
                            }
                            #endregion

                            #region //判斷MES.MoItemPart是否已存在新刻字
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoItemPart
                                    WHERE MoId = @OriMoId
                                    AND MoItemPartNo = @MoItemPartNo";
                            dynamicParameters.Add("OriMoId", OriMoId);
                            dynamicParameters.Add("MoItemPartNo", NewItemValue);

                            var Result = sqlConnection.Query(sql, dynamicParameters);
                            if (Result.Count() > 0) throw new SystemException("該製令刻號已存在，無法更新!");
                            #endregion

                            #region //更新 MES.MoItemPart 舊資料之新的 MoItemPartNo、MoItemPartSortNumber
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoItemPart SET
                                    MoItemPartNo = @MoItemPartNo,
                                    MoItemPartSortNumber = @MoItemPartSortNumber,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoItemPartId = @MoItemPartId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoItemPartNo = NewItemValue,
                                    MoItemPartSortNumber = NewSortNumber,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoItemPartId = moItemPartId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //新增MES.BarcodeProcessAttributeLog資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeProcessAttributeLog (OriBarcodeAttrId, NewBarcodeAttrId, OriBarcodeId, NewBarcodeId
                                , OriMoId, NewMoId, OriItemNo, NewItemNo, OriItemValue, NewItemValue, Remark
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.ProcessAttrLogId
                                VALUES (@OriBarcodeAttrId, @NewBarcodeAttrId, @OriBarcodeId, @NewBarcodeId
                                , @OriMoId, @NewMoId, @OriItemNo, @NewItemNo, @OriItemValue, @NewItemValue, @Remark
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                OriBarcodeAttrId,
                                NewBarcodeAttrId = OriBarcodeAttrId,
                                OriBarcodeId,
                                NewBarcodeId = OriBarcodeId,
                                OriMoId,
                                NewMoId = OriMoId,
                                OriItemNo,
                                NewItemNo = OriItemNo,
                                OriItemValue,
                                NewItemValue,
                                Remark,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();
                        #endregion

                        #region //更新 MES.BarcodeAttribute 舊資料之新的 BarcodeId
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeAttribute SET
                                ItemValue = @ItemValue,
                                ItemSeq = @ItemSeq,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeAttrId = @OriBarcodeAttrId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ItemValue = NewItemValue,
                                ItemSeq = NewSortNumber,
                                LastModifiedDate,
                                LastModifiedBy,
                                OriBarcodeAttrId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBindItem --修改綁定穴號 --GPai 20230606
        public string UpdateBindItem(int PrintId, int ItemValue)
        {
            try
            {


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();
                        int rowsAffected = 0;


                        #region //取得BarcodeAttribute資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT c.*,b.BarcodeNo
                                FROM MES.Barcode a
                                INNER JOIN MES.BarcodePrint b ON a.BarcodeNo = b.BarcodeNo
                                LEFT JOIN MES.BarcodeAttribute c ON c.BarcodeId = a.BarcodeId
                                WHERE  b.PrintId = @PrintId";
                        dynamicParameters.Add("PrintId", PrintId);

                        var barcodeAttrResult = sqlConnection.Query(sql, dynamicParameters);
                        if (barcodeAttrResult.Count() <= 0) throw new SystemException("資料錯誤!");
                        var barcodeAttrId = barcodeAttrResult.First().BarcodeAttrId;
                        var barcodeBarcodeNo = barcodeAttrResult.First().BarcodeNo;
                        #endregion

                        #region //檢查MES.Barcode是否已經有這筆批量條碼(已開工)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", barcodeBarcodeNo);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("批量條碼已開工，無法更新!");
                        #endregion

                        #region //檢查是否有在領料條碼中
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                    FROM MES.MrBarcodeRegister a
                                    WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", barcodeBarcodeNo);

                        var MrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MrBarcodeRegisterResult.Count() > 0) throw new SystemException("此條碼已被領料單綁定，無法更新!!");
                        #endregion


                        #region //更新 MES.BarcodeAttribute
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeAttribute SET
                                ItemValue = @ItemValue,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeAttrId = @BarcodeAttrId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ItemValue,
                                LastModifiedDate,
                                LastModifiedBy,
                                BarcodeAttrId = barcodeAttrId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateSelectBindItem --修改選擇綁定穴號 --GPai 202306013
        public string UpdateSelectBindItem(string PrintIds,  int ItemValue)
        {
            try
            {
                string[] BarcodePrintIdList = PrintIds.Split(',');

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();
                        int rowsAffected = 0;

                        foreach (var PrintId in BarcodePrintIdList)
                        {
                            #region //取得BarcodeAttribute資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT c.*,b.BarcodeNo
                                FROM MES.Barcode a
                                INNER JOIN MES.BarcodePrint b ON a.BarcodeNo = b.BarcodeNo
                                LEFT JOIN MES.BarcodeAttribute c ON c.BarcodeId = a.BarcodeId
                                WHERE  b.PrintId = @PrintId";
                            dynamicParameters.Add("PrintId", PrintId);

                            var barcodeAttrResult = sqlConnection.Query(sql, dynamicParameters);
                            if (barcodeAttrResult.Count() <= 0) throw new SystemException("資料錯誤!");
                            var barcodeAttrId = barcodeAttrResult.First().BarcodeAttrId;
                            var barcodeBarcodeNo = barcodeAttrResult.First().BarcodeNo;
                            #endregion

                            #region //檢查MES.Barcode是否已經有這筆批量條碼(已開工)
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", barcodeBarcodeNo);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0) throw new SystemException("批量條碼已開工，無法更新!");
                            #endregion

                            #region //檢查是否有在領料條碼中
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MrBarcodeRegister a
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", barcodeBarcodeNo);

                            var MrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);
                            if (MrBarcodeRegisterResult.Count() > 0) throw new SystemException("此條碼已被領料單綁定，無法更新!!");
                            #endregion


                            #region //更新 MES.BarcodeAttribute
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.BarcodeAttribute SET
                                ItemValue = @ItemValue,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeAttrId = @BarcodeAttrId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ItemValue,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    BarcodeAttrId = barcodeAttrId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        
        #region //UpdateDepSecondmentRecord --更新部門借調記錄 -- WuTC 2024-03-27
        public string UpdateDepSecondmentRecord(int DsId, int UserId, int DepartmentId, string StartDate, string EndDate, string Status, string Remark)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        if (DsId <= 0) throw new SystemException("【借調單號】不能為空!");
                        if (UserId <= 0) throw new SystemException("【借調人員】不能為空!");
                        if (DepartmentId <= 0) throw new SystemException("【借調部門】不能為空!");
                        int rowsAffected = 0;

                        #region //查詢同時段內有相同員工借調記錄(開始時間)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId, [Status], StartDate, EndDate
                                    FROM MES.DepartmentalSecondment
                                    WHERE DsId != @DsId AND UserId = @UserId AND [Status] = 'A' AND @StartDate between StartDate and EndDate";
                        dynamicParameters.Add("DsId", DsId);
                        dynamicParameters.Add("UserId", UserId);
                        dynamicParameters.Add("StartDate", StartDate);
                        dynamicParameters.Add("EndDate", EndDate);

                        var checkRecordresultstartdate = sqlConnection.Query(sql, dynamicParameters);
                        if (checkRecordresultstartdate.Count() > 0) throw new SystemException("同時段(開始時間)已存在該員工的借調記錄!");
                        #endregion
                        #region //查詢同時段內有相同員工借調記錄(結束時間)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId, [Status], StartDate, EndDate
                                    FROM MES.DepartmentalSecondment
                                    WHERE DsId != @DsId AND UserId = @UserId AND [Status] = 'A' AND @EndDate between StartDate and EndDate";
                        dynamicParameters.Add("DsId", DsId);
                        dynamicParameters.Add("UserId", UserId);
                        dynamicParameters.Add("StartDate", StartDate);
                        dynamicParameters.Add("EndDate", EndDate);

                        var checkRecordresultenddate = sqlConnection.Query(sql, dynamicParameters);
                        if (checkRecordresultenddate.Count() > 0) throw new SystemException("同時段(結束時間)已存在該員工的借調記錄!");
                        #endregion

                        #region //更新 MES.DepartmentalSecondment
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.DepartmentalSecondment SET
                                UserId = @UserId,
                                DepartmentId = @DepartmentId,
                                StartDate = @StartDate,
                                EndDate = @EndDate,
                                Status = @Status,
                                Remark = @Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE DsId = @DsId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                UserId,
                                DepartmentId,
                                StartDate,
                                EndDate,
                                Status,
                                Remark,
                                LastModifiedDate,
                                LastModifiedBy,
                                DsId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateDepSecondmentRecordStatus -- 更新部門借調記錄的狀態 -- WuTC 2024-03-27
        public string UpdateDepSecondmentRecordStatus(int DsId, int UserId, string StartDate, string EndDate, string Status)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (Status == "A") //改變為啟用時查詢記錄
                        {
                            #region //查詢同時段內有相同員工借調記錄(開始時間)
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT UserId, [Status], StartDate, EndDate
                                    FROM MES.DepartmentalSecondment
                                    WHERE DsId != @DsId AND UserId = @UserId AND [Status] = 'A' AND @StartDate between StartDate and EndDate";
                            dynamicParameters.Add("DsId", DsId);
                            dynamicParameters.Add("UserId", UserId);
                            dynamicParameters.Add("StartDate", StartDate);
                            dynamicParameters.Add("EndDate", EndDate);

                            var checkRecordresultstartdate = sqlConnection.Query(sql, dynamicParameters);
                            if (checkRecordresultstartdate.Count() > 0) throw new SystemException("同時段(開始時間)已存在該員工的借調記錄!");
                            #endregion
                            #region //查詢同時段內有相同員工借調記錄(結束時間)
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT UserId, [Status], StartDate, EndDate
                                    FROM MES.DepartmentalSecondment
                                    WHERE DsId != @DsId AND UserId = @UserId AND [Status] = 'A' AND @EndDate between StartDate and EndDate";
                            dynamicParameters.Add("DsId", DsId);
                            dynamicParameters.Add("UserId", UserId);
                            dynamicParameters.Add("StartDate", StartDate);
                            dynamicParameters.Add("EndDate", EndDate);

                            var checkRecordresultenddate = sqlConnection.Query(sql, dynamicParameters);
                            if (checkRecordresultenddate.Count() > 0) throw new SystemException("同時段(結束時間)已存在該員工的借調記錄!");
                            #endregion
                        }

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.DepartmentalSecondment SET
                                Status = @Status,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE DsId = @DsId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                Status,
                                LastModifiedDate,
                                LastModifiedBy,
                                DsId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateTransferOspList -- 拋轉委外預排製程 -- Ann 2025-06-09
        public string UpdateTransferOspList(List<OspListData> UploadData)
        {
            try
            {
                if (UploadData.Count <= 0) throw new SystemException("上傳項目不能為空!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyNo, a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        string CompanyNo = "";
                        foreach (var item in companyResult)
                        {
                            CompanyNo = item.CompanyNo;
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //取得預排資料
                            List<OspListData> ospLists = new List<OspListData>();
                            foreach (var item in UploadData)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.OspListId, a.DepartmentId, a.MoProcessId, a.OspDate, a.SupplierId
                                        , a.Quantity, a.ProcessCode, a.ProcessCodeName, a.ExpectedDate
                                        , a.ProcessCheckStatus, a.ProcessCheckType, a.[Status], a.Remark
                                        , b.ProcessAlias
                                        , c.WoSeq
                                        , d.WoErpPrefix, d.WoErpNo
                                        , e.MtlItemNo, e.MtlItemName, e.MtlItemSpec
                                        , f.DepartmentName
                                        FROM MES.OspList a 
                                        INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId 
                                        INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
                                        INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                        INNER JOIN PDM.MtlItem e ON d.MtlItemId = e.MtlItemId
                                        INNER JOIN BAS.Department f ON a.DepartmentId = f.DepartmentId
                                        WHERE a.OspListId = @OspListId";
                                dynamicParameters.Add("OspListId", item.OspListId);

                                OspListData ospList = sqlConnection.QueryFirstOrDefault<OspListData>(sql, dynamicParameters);

                                if (ospList == null)
                                {
                                    throw new SystemException("拋轉項目中有資料錯誤!!");
                                }

                                if (ospList.Status != "P")
                                {
                                    throw new SystemException($"製令【{ospList.WoErpPrefix}-{ospList.WoErpNo}({ospList.WoSeq})】製程【{ospList.ProcessAlias}】狀態錯誤!!");
                                }

                                ospList.GroupId = item.GroupId;

                                #region //確認供應商資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.SupplierNo, a.SupplierName
                                        FROM SCM.Supplier a 
                                        WHERE a.SupplierId = @SupplierId";
                                dynamicParameters.Add("SupplierId", item.SupplierId);

                                var SupplierResult = sqlConnection.Query(sql, dynamicParameters);

                                if (SupplierResult.Count() <= 0) throw new SystemException($"製令【{ospList.WoErpPrefix}-{ospList.WoErpNo}({ospList.WoSeq})】製程【{ospList.ProcessAlias}】<br>查無供應商資料!!");

                                item.SupplierNo = SupplierResult.FirstOrDefault().SupplierNo;
                                ospList.SupplierName = SupplierResult.FirstOrDefault().SupplierName;
                                #endregion

                                #region //確認製程代碼
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MW002)) ProcessCodeName
                                        FROM CMSMW a
                                        WHERE a.MW005 = @SupplierNo
                                        AND a.MW001 = @ProcessCode";
                                dynamicParameters.Add("SupplierNo", item.SupplierNo);
                                dynamicParameters.Add("ProcessCode", item.ProcessCode);

                                var CMSMWResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (CMSMWResult.Count() <= 0) throw new SystemException($"製令【{ospList.WoErpPrefix}-{ospList.WoErpNo}({ospList.WoSeq})】製程【{ospList.ProcessAlias}】<br>製程代碼【{item.ProcessCode}】錯誤!!");

                                item.ProcessCodeName = CMSMWResult.FirstOrDefault().ProcessCodeName;
                                #endregion

                                #region //UPDATE MES.OspList
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.OspList SET
                                        SupplierId = @SupplierId,
                                        ProcessCode = @ProcessCode,
                                        ProcessCodeName = @ProcessCodeName,
                                        ExpectedDate = @ExpectedDate,
                                        Status = 'Y',
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE OspListId = @OspListId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        item.SupplierId,
                                        item.ProcessCode,
                                        item.ProcessCodeName,
                                        item.ExpectedDate,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        item.OspListId
                                    });

                                sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                ospList.SupplierId = item.SupplierId;
                                ospList.ProcessCode = item.ProcessCode;
                                ospList.ProcessCodeName = item.ProcessCodeName;
                                ospList.ExpectedDate = item.ExpectedDate;
                                ospLists.Add(ospList);
                            }
                            #endregion

                            JObject transferResult = JObject.Parse(TransferOspList(ospLists, CompanyNo, sqlConnection, sqlConnection2));
                            if (transferResult["status"].ToString() != "success")
                            {
                                throw new SystemException(transferResult["msg"].ToString());
                            }
                            else
                            {
                                jsonResponse = transferResult;
                            }
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateOspList -- 更新委外預排製程 -- Ann 2025-06-10
        public string UpdateOspList(int OspListId, int MoProcessId, string OspDate
            , int DepartmentId, int Quantity, string ExpectedDate, string ProcessCheckStatus, string Remark)
        {
            try
            {
                if (OspDate.Length <= 0) throw new SystemException("【委外日期】不能為空!");
                if (Quantity <= 0) throw new SystemException("【委外數量】不能為空!");
                if (ExpectedDate.Length <= 0) throw new SystemException("【預計回廠日期】不能為空!");
                if (ProcessCheckStatus.Length <= 0) throw new SystemException("【支援工程檢】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷委外預排製程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.[Status]
                                    FROM MES.OspList a 
                                    WHERE a.OspListId = @OspListId";
                            dynamicParameters.Add("OspListId", OspListId);

                            var OspListResult = sqlConnection.Query(sql, dynamicParameters);
                            if (OspListResult.Count() <= 0) throw new SystemException("委外預排製程資料錯誤!!");

                            foreach (var item in OspListResult)
                            {
                                if (item.Status != "N") throw new SystemException("單據狀態錯誤!!");
                            }
                            #endregion

                            #region //確認是否有相同製令製程的單據且未拋轉
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.OspList a 
                                    WHERE a.MoProcessId = @MoProcessId
                                    AND a.[Status] = 'N'
                                    AND a.OspListId != @OspListId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            dynamicParameters.Add("OspListId", OspListId);

                            var CheckOspListResult = sqlConnection.Query(sql, dynamicParameters);

                            if (CheckOspListResult.Count() > 0) throw new SystemException("已有相同製令製程的單據且未拋轉!!");
                            #endregion

                            #region //確認製令製程資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoProcessId
                                    , c.Quantity
                                    FROM MES.MoProcess a 
                                    INNER JOIN MES.Process b ON a.ProcessId = b.ProcessId
                                    INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MoProcessResult.Count() <= 0) throw new SystemException("製令製程資料錯誤!!");

                            foreach (var item in MoProcessResult)
                            {
                                if (item.Quantity < Quantity)
                                {
                                    throw new SystemException($"委外數量已超過製令預計生產數量({item.Quantity})!!");
                                }
                            }
                            #endregion

                            #region //確認委託部門
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM BAS.Department a 
                                    WHERE a.DepartmentId = @DepartmentId";
                            dynamicParameters.Add("DepartmentId", DepartmentId);

                            var DepartmentResult = sqlConnection.Query(sql, dynamicParameters);

                            if (DepartmentResult.Count() <= 0) throw new SystemException($"部門資料錯誤!!");
                            #endregion

                            #region //是否支援工程檢格式
                            if (ProcessCheckStatus != "Y" && ProcessCheckStatus != "N")
                            {
                                throw new SystemException($"支援工程檢格式錯誤!!");
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.OspList SET
                                    DepartmentId = @DepartmentId,
                                    MoProcessId = @MoProcessId,
                                    OspDate = @OspDate,
                                    Quantity = @Quantity,
                                    ExpectedDate = @ExpectedDate,
                                    ProcessCheckStatus = @ProcessCheckStatus,
                                    Remark = @Remark,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE OspListId = @OspListId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    DepartmentId,
                                    MoProcessId,
                                    OspDate,
                                    Quantity,
                                    ExpectedDate,
                                    ProcessCheckStatus,
                                    Remark,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    OspListId
                                });

                            int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateOspSupplierAnonymous -- 更新託外生產單供應商資料(無權限版本) -- Ann 2025-06-17
        public string UpdateOspSupplierAnonymous(List<OspDetailData> OspDetailData)
        {
            int rowsAffected = 0;

            try
            {
                if (OspDetailData.Count() <= 0) throw new SystemException("上傳資料不可為空!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認供應商資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyId, a.SupplierNo
                                FROM SCM.Supplier a 
                                WHERE a.SupplierId = @SupplierId";
                        dynamicParameters.Add("SupplierId", OspDetailData.FirstOrDefault().SupplierId);

                        var SupplierResult = sqlConnection.Query(sql, dynamicParameters);

                        if (SupplierResult.Count() <= 0) throw new SystemException("查無供應商資料!!");

                        int CompanyId = SupplierResult.FirstOrDefault().CompanyId;
                        string SupplierNo = SupplierResult.FirstOrDefault().SupplierNo;
                        #endregion

                        #region //確認USER資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.UserId
                                FROM BAS.[User] a 
                                WHERE a.UserNo = @UserNo";
                        dynamicParameters.Add("UserNo", OspDetailData.FirstOrDefault().UserNo);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        if (UserResult.Count() <= 0) throw new SystemException("使用者資料錯誤!!");

                        int UserId = UserResult.FirstOrDefault().UserId;
                        #endregion

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //確認託外生產單資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.Status, a.SupplierId, a.OspNo
                                    FROM MES.OutsourcingProduction a 
                                    WHERE a.OspId = @OspId";
                            dynamicParameters.Add("OspId", OspDetailData.FirstOrDefault().OspId);

                            var OutsourcingProductionResult = sqlConnection.Query(sql, dynamicParameters);

                            if (OutsourcingProductionResult.Count() <= 0) throw new SystemException("查無託外生產單資料!!");

                            int? oriSupplierId = -1;
                            string OspNo = "";
                            foreach (var item in OutsourcingProductionResult)
                            {
                                if (item.Status != "P")
                                {
                                    throw new SystemException("託外生產單狀態非BPM簽核中!!");
                                }

                                oriSupplierId = item.SupplierId;
                                OspNo = item.OspNo;
                            }
                            #endregion

                            #region //取得單日供應商序號
                            if (oriSupplierId == null || oriSupplierId != OspDetailData.FirstOrDefault().SupplierId)
                            {
                                string nowDate = DateTime.Now.ToString("yyyyMMdd");
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(MAX(OspNo), '1-0') MaxOspNo
                                        FROM MES.OutsourcingProduction a
                                        WHERE a.CompanyId = @CompanyId
                                        AND a.OspNo LIKE '" + nowDate + SupplierNo + "%'";
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var result3 = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in result3)
                                {
                                    string maxOspNo = item.MaxOspNo;
                                    int count = Convert.ToInt32(maxOspNo.Split('-')[1]) + 1;
                                    OspNo = nowDate + SupplierNo + "-" + count.ToString("D4");
                                }
                            }
                            #endregion

                            #region //UPDATE MES.OutsourcingProduction
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.OutsourcingProduction SET
                                    OspNo = @OspNo,
                                    SupplierId = @SupplierId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE OspId = @OspId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    OspNo,
                                    OspDetailData.FirstOrDefault().SupplierId,
                                    LastModifiedDate = DateTime.Now,
                                    LastModifiedBy = UserId,
                                    OspDetailData.FirstOrDefault().OspId,
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            foreach (var item in OspDetailData)
                            {
                                #region //確認製程代碼
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MW002)) ProcessCodeName
                                        FROM CMSMW a
                                        WHERE a.MW005 = @SupplierNo
                                        AND a.MW001 = @ProcessCode";
                                dynamicParameters.Add("SupplierNo", SupplierNo);
                                dynamicParameters.Add("ProcessCode", item.ProcessCode);

                                var CMSMWResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (CMSMWResult.Count() <= 0) throw new SystemException($"製程代碼錯誤!!");

                                string ProcessCodeName = CMSMWResult.FirstOrDefault().ProcessCodeName;
                                #endregion

                                #region //Update MES.OspDetail
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.OspDetail SET
                                        ProcessCode = @ProcessCode,
                                        ProcessCodeName = @ProcessCodeName,
                                        ExpectedDate = @ExpectedDate,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE OspDetailId = @OspDetailId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        item.ProcessCode,
                                        ProcessCodeName,
                                        item.ExpectedDate,
                                        LastModifiedDate = DateTime.Now,
                                        LastModifiedBy = UserId,
                                        item.OspDetailId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateOspListStatus -- 更新委外預排製程狀態 -- Ann 2025-06-24
        public string UpdateOspListStatus(string OspListIds, string Status, string PoRejectionReason)
        {
            int rowsAffected = 0;

            try
            {
                if (Status == "F" && string.IsNullOrEmpty(PoRejectionReason)) throw new SystemException("備註不可為空!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        List<OspListData> ospListDatas = new List<OspListData>();
                        string[] ospListIdArray = OspListIds.Split(',');
                        foreach (var ospListId in ospListIdArray)
                        {
                            #region //判斷委外預排製程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.OspListId, a.[Status], a.DepartmentId, a.Quantity
                                    , FORMAT(a.OspDate, 'yyyy-MM-dd') OspDate
                                    , b.ProcessAlias
                                    , c.WoSeq
                                    , d.WoErpPrefix, d.WoErpNo
                                    , e.MtlItemNo, e.MtlItemName, e.MtlItemSpec
                                    , f.DepartmentName
                                    FROM MES.OspList a 
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
                                    INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                    INNER JOIN PDM.MtlItem e ON d.MtlItemId = e.MtlItemId
                                    INNER JOIN BAS.Department f ON a.DepartmentId = f.DepartmentId
                                    WHERE a.OspListId = @OspListId";
                            dynamicParameters.Add("OspListId", ospListId);

                            OspListData OspListResult = sqlConnection.QueryFirstOrDefault<OspListData>(sql, dynamicParameters);
                            if (OspListResult == null) throw new SystemException("委外預排製程資料錯誤!!");

                            if (OspListResult.Status == "Y")
                            {
                                throw new SystemException($"品號【{OspListResult.MtlItemNo}】製程【{OspListResult.ProcessAlias}】狀態無法修改!!");
                            }

                            ospListDatas.Add(OspListResult);
                            #endregion

                            #region //Update MES.OspList
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.OspList SET
                                    PoConfirmDate = @PoConfirmDate,
                                    PoRejectionReason = @PoRejectionReason,
                                    PoUserId = @PoUserId,
                                    Status = @Status,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE OspListId = @OspListId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    PoConfirmDate = DateTime.Now,
                                    PoRejectionReason,
                                    PoUserId = CurrentUser,
                                    Status,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    OspListId = ospListId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //Insert MES.OspListStatusLog
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.OspListStatusLog (OspListId, PoConfirmDate, PoRejectionReason, PoUserId, Status, CreateDate)
                                    VALUES (@OspListId, @PoConfirmDate, @PoRejectionReason, @PoUserId, @Status, @CreateDate)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    OspListId = ospListId,
                                    PoConfirmDate = DateTime.Now,
                                    PoRejectionReason,
                                    PoUserId = CurrentUser,
                                    Status,
                                    CreateDate
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        if (Status == "F")
                        {
                            #region //依部門分組資料
                            var groupOspList = ospListDatas.GroupBy(x => new { x.DepartmentId });
                            #endregion

                            #region //通知生管群組
                            string Content = "";
                            foreach (var group in groupOspList)
                            {
                                string ospListMenuMamo = "| 製令 | 品號 | 品名 | 規格 | 製令製程 | 委託部門 | 數量 | 委託日期 |\n| :-- | :-- | :-- | :-- | :-- | :-- | :-- |\n";
                                string ospListMenuEmail = "";
                                string ospListContent = "";

                                #region //資料載入
                                foreach (var item in group)
                                {
                                    ospListMenuMamo += $"| {item.WoErpPrefix}-{item.WoErpNo}({item.WoSeq}) | {item.MtlItemNo} | {item.MtlItemName} | {item.MtlItemSpec} | {item.ProcessAlias} | {item.DepartmentName} | {item.Quantity} | {item.OspDate}\n";
                                    ospListContent += $@"
                                                        <tr>
                                                            <td>{item.WoErpPrefix}-{item.WoErpNo}({item.WoSeq})</td>
                                                            <td>{item.MtlItemNo}</td>
                                                            <td>{item.MtlItemName}</td>
                                                            <td>{item.MtlItemSpec}</td>
                                                            <td>{item.ProcessAlias}</td>
                                                            <td>{item.DepartmentName}</td>
                                                            <td>{item.Quantity}</td>
                                                            <td>{item.OspDate}</td>
                                                        </tr>";
                                }

                                ospListMenuEmail += $@"<html>
                                                        <body>
                                                            <h2>中揚光電-企業管理平台 委外預排製程 採購通知</h2>
                                                            <p>系統日期：{DateTime.Now.ToString("yyyy-MM-dd HH:mm")}</p>
                                                            <p>狀態：採購駁回</p>
                                                            <p>備註：{PoRejectionReason}</p>
                                                            <p>委外預排製程列表如下：</p>
                                                            <table border='1' cellpadding='8' cellspacing='0' style='border-collapse: collapse; font-family: Arial, sans-serif;'>
                                                                <thead style='background-color: #f0f0f0;'>
                                                                    <tr>
                                                                        <th>製令</th>
                                                                        <th>品號</th>
                                                                        <th>品名</th>
                                                                        <th>規格</th>
                                                                        <th>製令製程</th>
                                                                        <th>委託部門</th>
                                                                        <th>數量</th>
                                                                        <th>委託日期</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {ospListContent}
                                                                </tbody>
                                                            </table>
                                                            <br>
                                                            <p style='color: #666; font-size: 12px;'>
                                                                本通訊及其所有附件所含之資訊均屬機密，僅供指定之收件人使用...
                                                            </p>
                                                        </body>
                                                      </html>";
                                #endregion

                                #region //MAMO
                                Content = "### 【委外預排製程 採購通知】\n" +
                                            "- 系統日期:" + DateTime.Now.ToString("yyyy-MM-dd HH:mm") + "\n" +
                                            "- 狀態：採購駁回 \n" +
                                            "- 備註：" + PoRejectionReason + "\n" +
                                            "- 單據列表:\n" + ospListMenuMamo + "\n" +
                                            "- 系統連結如下:\n" +
                                            "https://bm.zy-tech.com.tw/Production/OspListManagement" + "\n";

                                #region //確認推播群組
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.ChannelId
                                        FROM MES.OspListMamoChannel a
                                        WHERE a.DepartmentId = @DepartmentId";
                                dynamicParameters.Add("DepartmentId", group.FirstOrDefault().DepartmentId);

                                var QcMamoChannelResult = sqlConnection.Query(sql, dynamicParameters);

                                if (QcMamoChannelResult.Count() <= 0) throw new SystemException($"部門【{group.FirstOrDefault().DepartmentName}】尚未建立MAMO群組!!");

                                int ChannelId = -1;
                                foreach (var item in QcMamoChannelResult)
                                {
                                    ChannelId = item.ChannelId;
                                }
                                #endregion

                                List<string> Tags = new List<string>();
                                List<int> Files = new List<int>();

                                #region //確認公司別DB
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.CompanyNo
                                        FROM BAS.Company a
                                        WHERE CompanyId = @CompanyId";
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var companyResult = sqlConnection.Query(sql, dynamicParameters);

                                if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                                string CompanyNo = "";
                                foreach (var item in companyResult)
                                {
                                    CompanyNo = item.CompanyNo;
                                }
                                #endregion

                                string MamoResult = mamoHelper.SendMessage(CompanyNo, CurrentUser, "Channel", ChannelId.ToString(), Content, Tags, Files);

                                JObject MamoResultJson = JObject.Parse(MamoResult);
                                if (MamoResultJson["status"].ToString() != "success")
                                {
                                    throw new SystemException(MamoResultJson["msg"].ToString());
                                }
                                #endregion

                                #region //Email
                                #region //取得要寄送的人員信箱
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(STRING_AGG(b.UserNo + ':' + b.Email, ';'), '') AS CombinedUsers
                                        FROM MAMO.ChannelMembers a 
                                        INNER JOIN BAS.[User] b ON a.UserId = b.UserId
                                        WHERE a.ChannelId = @ChannelId
                                        AND b.Email IS NOT NULL AND b.Email != '' AND b.[Status] = 'A'";
                                dynamicParameters.Add("ChannelId", ChannelId);

                                var ChannelMembersResult = sqlConnection.Query(sql, dynamicParameters);

                                string Email = "";
                                foreach (var item in ChannelMembersResult)
                                {
                                    Email = item.CombinedUsers;
                                }
                                #endregion

                                if (Email != null && Email.Length > 0)
                                {
                                    #region //設定寄送格式
                                    string mailSubject = "【中揚光電-企業管理平台】";
                                    string mailContent = ospListMenuEmail;
                                    #endregion

                                    #region //寄送Mail
                                    MailConfig mailConfig = new MailConfig
                                    {
                                        Host = "192.168.20.252",
                                        Port = 25,
                                        SendMode = 0,
                                        From = "企業管理平台:jmo-service@zy-tech.com.tw",
                                        Subject = mailSubject,
                                        Account = "jmo-service",
                                        Password = "asdf!QAZ",
                                        MailTo = Email,
                                        MailCc = "",
                                        MailBcc = "",
                                        HtmlBody = mailContent,
                                        TextBody = "-"
                                    };
                                    BaseHelper.MailSend(mailConfig);
                                    #endregion
                                }
                                #endregion
                            }
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //Delete
        #region //DeleteWipOrder -- MES工單刪除 -- Ted 2022-08-18
        public string DeleteWipOrder(int WoId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        AddUserOperateLog(WoId);
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷工單單頭資料是否正確
                        sql = @"SELECT ConfirmStatus, WoStatus, TransferStatus
                                FROM MES.WipOrder
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("工單單頭資料錯誤!");

                        //判斷工單確認碼是否確認
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("工單已確認，無法刪除!");
                            if (item.TransferStatus != "N") throw new SystemException("工單已拋轉，無法刪除!");
                            //if (item.WoStatus != "1") throw new SystemException("工單未處於未開工裝態，無法刪除!");
                        }
                        #endregion

                        #region //判斷工單單身確認碼是否確認
                        sql = @"SELECT b.ConfirmStatus
                                FROM MES.WipOrder a
                                INNER JOIN MES.WoDetail b on a.WoId =b.WoId
                                WHERE a.WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result2)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("工單單身已確認，無法刪除!");
                        }
                        #endregion

                        #region //判斷MES製令是否有開立
                        sql = @"SELECT TOP 1 1
                            FROM MES.ManufactureOrder a
                            WHERE a.WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("已經有MES工單開立,不可以刪除");
                        #endregion
                        int rowsAffected = 0;

                        #region //刪除工單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.WoDetail
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除工單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.WipOrder
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteWoDetail -- MES工單單身刪除 -- Ted 2022-08-12
        public string DeleteWoDetail(int WoId, int WoDetailId)
        {
            try
            {
                string WoErpPrefix = "";
                string WoErpNo = "";
                string ErpNo = "";
                string woDetailMtlItemNo = "";

                #region //MES資料確認
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷工單單頭資料是否正確
                    sql = @"SELECT WoStatus, WoErpPrefix, WoErpNo
                            FROM MES.WipOrder
                            WHERE WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("工單單頭資料錯誤!");
                    WoErpPrefix = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoErpPrefix;
                    WoErpNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WoErpNo;

                    foreach (var item in result)
                    {
                        if (item.WoStatus != "1") throw new SystemException("工單不處於未開工狀態，無法刪除!");
                    }
                    #endregion

                    #region //判斷工單單身確認碼是否確認
                    sql = @"SELECT a.ConfirmStatus,b.MtlItemNo
                            FROM MES.WoDetail a
                            INNER JOIN PDM.MtlItem b on a.MtlItemId =b.MtlItemId
                            WHERE WoDetailId = @WoDetailId";
                    dynamicParameters.Add("WoDetailId", WoDetailId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("工單單身資料錯誤!");
                    woDetailMtlItemNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MtlItemNo;

                    foreach (var item in result)
                    {
                        if (item.ConfirmStatus != "N") throw new SystemException("工單單身已確認，無法刪除!");
                    }
                    #endregion

                    #region //判斷MES製令是否有開立
                    sql = @"SELECT TOP 1 1
                            FROM MES.ManufactureOrder a
                            WHERE a.WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0) throw new SystemException("已經有MES工單開立,不可以刪除");
                    #endregion

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                    if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion

                }
                #endregion

                #region //判斷ERP工單單身是否存在
                using (SqlConnection sqlConnectionERP = new SqlConnection(ErpConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT TB003
                            FROM MOCTB
                            WHERE TB001 = @WoErpPrefix
                            AND TB002 = @WoErpNo
                            AND TB003 = @woDetailMtlItemNo";
                    dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                    dynamicParameters.Add("WoErpNo", WoErpNo);
                    dynamicParameters.Add("woDetailMtlItemNo", woDetailMtlItemNo);

                    var result2 = sqlConnectionERP.Query(sql, dynamicParameters);
                    //if (result2.Count() > 0) throw new SystemException("該筆單身已經拋轉ERP不能刪除!");
                }
                #endregion

                #region //MES工單單身刪除
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        AddUserOperateLog(WoId);

                        int rowsAffected = 0;

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.WoDetail
                                WHERE WoId = @WoId
                                AND WoDetailId = @WoDetailId";
                        dynamicParameters.Add("WoId", WoId);
                        dynamicParameters.Add("WoDetailId", WoDetailId);

                        rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
                #endregion

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteWoDetailAll -- MES工單單身刪除(全) -- Shintokuri 2023-11-01
        public string DeleteWoDetailAll(int WoId)
        {
            try
            {
                string WoErpPrefix = "";
                string WoErpNo = "";
                string ErpNo = "";
                string woDetailMtlItemNo = "";

                #region //MES資料確認
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷工單單頭資料是否正確
                    sql = @"SELECT WoStatus, WoErpPrefix, WoErpNo
                            FROM MES.WipOrder
                            WHERE WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("工單單頭資料錯誤!");
                    foreach(var item in result)
                    {
                        if (item.WoStatus != "1") throw new SystemException("工單不處於未開工狀態，無法刪除!");
                        WoErpPrefix = item.WoErpPrefix;
                        WoErpNo = item.WoErpNo;
                    }
                    #endregion

                    #region //判斷工單單身確認碼是否確認
                    sql = @"SELECT a.ConfirmStatus,b.MtlItemNo
                            FROM MES.WoDetail a
                            INNER JOIN PDM.MtlItem b on a.MtlItemId =b.MtlItemId
                            WHERE a.WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("工單單身資料錯誤!");
                    foreach(var item in result)
                    {
                        if(item.ConfirmStatus == "Y") throw new SystemException("工單單身目前處於確認狀態不可以刪除,請重新確認資料!");
                    }

                    #endregion

                    #region //判斷MES製令是否有開立
                    sql = @"SELECT TOP 1 1
                            FROM MES.ManufactureOrder a
                            WHERE a.WoId = @WoId";
                    dynamicParameters.Add("WoId", WoId);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0) throw new SystemException("已經有MES工單開立,不可以刪除");
                    #endregion

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                    if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion

                }
                #endregion

                #region //判斷ERP工單單身是否存在
                using (SqlConnection sqlConnectionERP = new SqlConnection(ErpConnectionStrings))
                {
                }
                #endregion

                #region //MES工單單身刪除
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        AddUserOperateLog(WoId);

                        int rowsAffected = 0;

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.WoDetail
                                WHERE WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
                #endregion

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMoRouting -- 刪除MES製令途程 -- Ann 2022-07-28
        public string DeleteMoRouting(int MoRoutingId)
        {
            try
            {
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷途程製程資料是否正確
                        sql = @"SELECT a.MoId, a.RoutingItemId
                                , b.RoutingId
                                FROM MES.MoRouting a
                                INNER JOIN MES.RoutingItem b ON a.RoutingItemId = b.RoutingItemId 
                                WHERE MoRoutingId = @MoRoutingId";
                        dynamicParameters.Add("MoRoutingId", MoRoutingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令途程資料錯誤!");

                        int MoId = 0;
                        int RoutingItemId = 0;
                        int RoutingId = 0;
                        foreach (var item in result)
                        {
                            MoId = item.MoId;
                            RoutingItemId = item.RoutingItemId;
                            RoutingId = item.RoutingId;
                        }
                        #endregion

                        #region //確認是否有託外單綁定此製令製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoProcessId
                                FROM MES.MoProcess a
                                WHERE MoRoutingId = @MoRoutingId";
                        dynamicParameters.Add("MoRoutingId", MoRoutingId);

                        var MoRoutingResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in MoRoutingResult)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.OspNo
                                    FROM MES.OspDetail a
                                    INNER JOIN MES.OutsourcingProduction b ON a.OspId = b.OspId
                                    WHERE a.MoProcessId = @MoProcessId
                                    AND b.Status != 'V'";
                            dynamicParameters.Add("MoProcessId", item.MoProcessId);

                            var OspDetailResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in OspDetailResult)
                            {
                                throw new SystemException("此製令途程已綁定託外生產單【" + item2.OspNo + "】!");
                            }
                        }
                        #endregion

                        #region //檢查此製令製程是否已開工過
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoRouting a
                                INNER JOIN MES.MoProcess b ON a.MoRoutingId = b.MoRoutingId
                                INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId
                                WHERE a.MoRoutingId = @MoRoutingId";
                        dynamicParameters.Add("MoRoutingId", MoRoutingId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("此張製令製程已開工，無法刪除!");
                        #endregion

                        #region //檢查MoMtlSetting是否有設定到此途程製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoRouting a
                                INNER JOIN MES.MoProcess b ON a.MoRoutingId = b.MoRoutingId
                                INNER JOIN MES.MoMtlSetting c ON b.MoProcessId = c.MoProcessId
                                WHERE a.MoRoutingId = @MoRoutingId";
                        dynamicParameters.Add("MoRoutingId", MoRoutingId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() > 0) throw new SystemException("此途程製程已被綁定，無法刪除!");
                        #endregion

                        #region //檢查是否已經有BARCODE使用到此途程製程

                        #region //先取得此途程所有製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoProcessId, a.MoId
                                FROM MES.MoProcess a
                                WHERE a.MoRoutingId = @MoRoutingId";
                        dynamicParameters.Add("MoRoutingId", MoRoutingId);

                        var MoProcessIdResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        foreach (var item in MoProcessIdResult)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.Barcode a
                                    WHERE a.CurrentMoProcessId = @MoProcessId
                                    OR a.NextMoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", item.MoProcessId);

                            var CurrentBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (CurrentBarcodeResult.Count() > 0)
                            {
                                #region //檢查是否有其他製程，若有則將Current及Next都改為下個順位1的製程
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 a.MoProcessId
                                        FROM MES.MoProcess a
                                        WHERE a.MoId = @MoId
                                        AND (a.MoRoutingId != @MoRoutingId OR a.MoRoutingId IS NULL)
                                        ORDER BY a.SortNumber";
                                dynamicParameters.Add("MoId", item.MoId);
                                dynamicParameters.Add("MoRoutingId", MoRoutingId);

                                var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MoProcessResult.Count() <= 0)
                                {
                                    throw new SystemException("此途程製程已被條碼綁定，請新增其他途程製程再進行刪除!!");
                                }
                                else
                                {
                                    foreach (var item2 in MoProcessResult)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode SET
                                                CurrentMoProcessId = @NewMoProcessId,
                                                NextMoProcessId = @NewMoProcessId,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE CurrentMoProcessId = @MoProcessId
                                                OR NextMoProcessId = @MoProcessId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                NewMoProcessId = item2.MoProcessId,
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                item.MoProcessId
                                            });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    }
                                }
                                #endregion
                            }
                        }

                        #endregion

                        #region //找尋此途程下的製程資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.RoutingItemId, b.ProcessId, b.ProcessAlias
                                FROM MES.RoutingItem a
                                INNER JOIN MES.RoutingProcess b ON a.RoutingId = b.RoutingId
                                WHERE a.RoutingItemId = @RoutingItemId";
                        dynamicParameters.Add("RoutingItemId", RoutingItemId);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result4)
                        {
                            #region //刪除製程量測項目
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.MoProcessQcItem a 
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    INNER JOIN MES.MoRouting c ON b.MoId = c.MoId
                                    WHERE c.MoRoutingId = @MoRoutingId";
                            dynamicParameters.Add("MoRoutingId", MoRoutingId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //先刪除關聯Table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.OspDetail a 
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    WHERE b.MoRoutingId = @MoRoutingId";
                            dynamicParameters.Add("MoRoutingId", MoRoutingId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a
                                    FROM MES.MoProcessItem a
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    WHERE b.ProcessId = @ProcessId
                                    AND b.MoRoutingId = @MoRoutingId";
                            dynamicParameters.Add("ProcessId", item.ProcessId);
                            dynamicParameters.Add("MoRoutingId", MoRoutingId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.MoProcess
                                    WHERE ProcessId = @ProcessId
                                    AND MoRoutingId = @MoRoutingId";
                            dynamicParameters.Add("ProcessId", item.ProcessId);
                            dynamicParameters.Add("MoRoutingId", MoRoutingId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoRouting
                                WHERE MoRoutingId = @MoRoutingId";
                        dynamicParameters.Add("MoRoutingId", MoRoutingId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //重新排序MES.MoRouting
                        dynamicParameters = new DynamicParameters();
                        sql = @"With UpdateSort As
                                (
                                  SELECT SortNumber,
                                  ROW_NUMBER() OVER(ORDER BY SortNumber) NewRoutingProcessSort
                                  FROM MES.MoRouting
                                  WHERE MoId = @MoId
                                )
                                UPDATE MES.MoRouting 
                                SET SortNumber = NewRoutingProcessSort
                                FROM MES.MoRouting
                                INNER JOIN UpdateSort ON MES.MoRouting.SortNumber = UpdateSort.SortNumber
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //重新排序MES.MoProcess
                        dynamicParameters = new DynamicParameters();
                        sql = @"With UpdateSort As
                                (
                                  SELECT SortNumber,
                                  ROW_NUMBER() OVER(ORDER BY SortNumber) NewRoutingProcessSort
                                  FROM MES.MoProcess
                                  WHERE MoId = @MoId
                                )
                                UPDATE MES.MoProcess 
                                SET SortNumber = NewRoutingProcessSort
                                FROM MES.MoProcess
                                INNER JOIN UpdateSort ON MES.MoProcess.SortNumber = UpdateSort.SortNumber
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //確認此製令是否還有其他途程，若沒有，則UPDATE MODEID IS NULL
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoRouting a 
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var CheckMoRoutingResult = sqlConnection.Query(sql, dynamicParameters);

                        if (CheckMoRoutingResult.Count() <= 0)
                        {
                            #region //UPDATE MES.MoSetting ModeId
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.ManufactureOrder SET
                                    ModeId = null,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MoId = @MoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MoId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //確認量測資料是否有未上傳的單據，若有則一起刪除
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a 
                                    FROM MES.QcRecord a 
                                    WHERE a.SpreadsheetData IS NULL
                                    AND a.CheckQcMeasureData = 'N'
                                    AND (a.CurrentFileId IS NULL OR a.CurrentFileId = -1)
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMoMtlSetting -- 刪除MES製令用料設定 -- Ann 2022-08-01
        public string DeleteMoMtlSetting(int MoMtlSettingId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷製令用料設定資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSetting
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令用料設定資料錯誤!");
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoMtlSetting
                                WHERE MoMtlSettingId = @MoMtlSettingId";
                        dynamicParameters.Add("MoMtlSettingId", MoMtlSettingId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteManufactureOrder -- 刪除MES製令資料 -- Ann 2022-08-03
        public string DeleteManufactureOrder(int MoId)
        {
            try
            {
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        AddUserOperateLog(MoId);

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷製令資料是否正確
                        sql = @"SELECT TOP 1 Status
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.Status != "N") throw new SystemException("製令已開工，無法刪除!");
                        }
                        #endregion

                        #region //確認是否已經有領料單綁定此製令
                        sql = @"SELECT TOP 1 1
                                FROM MES.MrDetail
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("此製令已被領退料單綁定，無法刪除!");
                        #endregion

                        #region //檢查是否已產生批量條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodePrint a 
                                INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodePrintResult.Count() > 0) throw new SystemException("請先將批量條碼刪除後，再刪除製令!!");
                        #endregion

                        #region //先刪除關聯Table
                        #region //刪除製程量測項目
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a 
                                FROM MES.MoProcessQcItem a 
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a
                                FROM MES.QcRecord a
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a
                                FROM MES.BarcodePrint a
                                INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a
                                FROM MES.MoMtlSettingAttribute a
                                INNER JOIN MES.MoMtlSetting b ON a.MoMtlSettingId = b.MoMtlSettingId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MoMtlSetting
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a
                                FROM MES.MoProcessItem a
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a
                                FROM MES.MoProcess a
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MoSetting
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MoRouting
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MoItemPart
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBarcodePrint -- 刪除批量條碼資料 -- Ann 2022-08-04
        public string DeleteBarcodePrint(int MoId)
        {
            try
            {
                int rowsAffected = 0;
                List<BarcodePrint> barcodePrints = new List<BarcodePrint>();

                TransactionOptions options = new TransactionOptions
                {
                    Timeout = TimeSpan.FromMinutes(2)
                };

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, options))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認製令資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MoSettingId
                                FROM MES.ManufactureOrder a     
                                INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoIdResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoIdResult.Count() <= 0) throw new SystemException("製令資訊錯誤!!");

                        int MoSettingId = -1;
                        foreach (var item in MoIdResult)
                        {
                            MoSettingId = item.MoSettingId;
                        }
                        #endregion

                        #region //確認是否已經有條碼開工
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 b.BarcodeNo
                                FROM MES.BarcodeProcess a 
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                INNER JOIN MES.BarcodePrint c ON b.BarcodeNo = c.BarcodeNo
                                INNER JOIN MES.MoSetting d ON c.MoSettingId = d.MoSettingId
                                WHERE d.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeProcessResult.Count() > 0) throw new SystemException("批量條碼中已有過站紀錄，無法刪除!!");
                        #endregion

                        #region //檢查此張製令條碼是否有被其他領料單綁定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 c.MrErpPrefix + '-' + c.MrErpNo MrErpFullNo
                                FROM MES.MrBarcodeRegister a 
                                INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                INNER JOIN MES.MaterialRequisition c ON b.MrId = c.MrId
                                INNER JOIN MES.Barcode d ON a.BarcodeNo = d.BarcodeNo
                                INNER JOIN MES.BarcodePrint e ON d.BarcodeNo = e.BarcodeNo
                                INNER JOIN MES.MoSetting f ON e.MoSettingId = f.MoSettingId
                                WHERE f.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var CheckMrBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (CheckMrBarcodeResult.Count() > 0)
                        {
                            foreach (var item in CheckMrBarcodeResult)
                            {
                                throw new SystemException("條碼已被領料單【" + item.MrErpFullNo + "】綁定，無法刪除!!");
                            }
                        }
                        #endregion

                        #region //計算此製令下共有多少數量條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT COUNT(1) Count
                                FROM MES.Barcode a 
                                INNER JOIN MES.BarcodePrint b ON a.BarcodeNo = b.BarcodeNo
                                INNER JOIN MES.MoSetting c ON b.MoSettingId = c.MoSettingId
                                WHERE c.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodeCountResult = sqlConnection.Query(sql, dynamicParameters);

                        int BarcodeCount = 0;
                        foreach (var item in BarcodeCountResult)
                        {
                            BarcodeCount = item.Count;
                        }
                        #endregion

                        #region //計算此製令下的批量條碼數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT COUNT(1) Count
                                FROM MES.BarcodePrint a 
                                INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodePrintCountResult = sqlConnection.Query(sql, dynamicParameters);

                        int BarcodePrintCount = 0;
                        foreach (var item in BarcodePrintCountResult)
                        {
                            BarcodePrintCount = item.Count;
                        }
                        #endregion

                        #region //計算此製令下的條碼屬性數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT COUNT(1) Count
                                FROM MES.BarcodeAttribute a 
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                INNER JOIN MES.BarcodePrint c ON b.BarcodeNo = c.BarcodeNo
                                INNER JOIN MES.MoSetting d ON c.MoSettingId = d.MoSettingId
                                WHERE d.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodeAttributeCountResult = sqlConnection.Query(sql, dynamicParameters);

                        int BarcodeAttributeCount = 0;
                        foreach (var item in BarcodePrintCountResult)
                        {
                            BarcodeAttributeCount = item.Count;
                        }
                        #endregion

                        #region //DELETE MES.BarcodeAttribute
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.BarcodeAttribute
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        //int calculateCount = 0;
                        //calculateCount = (BarcodeAttributeCount / 300) + 1;
                        //for (int i=1; i<=calculateCount; i++)
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"DELETE TOP(300) a 
                        //            FROM MES.BarcodeAttribute a 
                        //            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                        //            INNER JOIN MES.BarcodePrint c ON b.BarcodeNo = c.BarcodeNo
                        //            INNER JOIN MES.MoSetting d ON c.MoSettingId = d.MoSettingId
                        //            WHERE d.MoId = @MoId";
                        //    dynamicParameters.Add("MoId", MoId);

                        //    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //}
                        #endregion

                        #region //DELETE MES.Barcode
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.Barcode
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //calculateCount = (BarcodeCount / 300) + 1;
                        //for (int i=1; i<=calculateCount; i++)
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"DELETE TOP(300) a 
                        //            FROM MES.Barcode a 
                        //            INNER JOIN MES.BarcodePrint b ON a.BarcodeNo = b.BarcodeNo
                        //            INNER JOIN MES.MoSetting c ON b.MoSettingId = c.MoSettingId
                        //            WHERE c.MoId = @MoId";
                        //    dynamicParameters.Add("MoId", MoId);

                        //    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //}
                        #endregion

                        #region //DELETE MES.BarcodePrint
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.BarcodePrint
                                WHERE MoSettingId = @MoSettingId";
                        dynamicParameters.Add("MoSettingId", MoSettingId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //calculateCount = (BarcodePrintCount / 300) + 1;
                        //for (int i=1; i<=calculateCount; i++)
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"DELETE TOP(300) a 
                        //            FROM MES.BarcodePrint a
                        //            INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                        //            WHERE b.MoId = @MoId";
                        //    dynamicParameters.Add("MoId", MoId);

                        //    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //}
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMoMtlSettingAttribute -- 刪除MES製令物料控管屬性檔 -- Ann 2022-08-11
        public string DeleteMoMtlSettingAttribute(int MoMtlSettingAttrId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令物料控管屬性檔資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoMtlSettingAttribute
                                WHERE MoMtlSettingAttrId = @MoMtlSettingAttrId";
                        dynamicParameters.Add("MoMtlSettingAttrId", MoMtlSettingAttrId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令物料控管屬性檔資料錯誤!");
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoMtlSettingAttribute
                                WHERE MoMtlSettingAttrId = @MoMtlSettingAttrId";
                        dynamicParameters.Add("MoMtlSettingAttrId", MoMtlSettingAttrId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMoItemPart -- 刪除MES製令刻字號資料 -- Ann 2022-10-24
        public string DeleteMoItemPart(int MoItemPartId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令刻字號資料是否正確
                        sql = @"SELECT a.MoId, a.MoItemPartNo
                                FROM MES.MoItemPart a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                WHERE MoItemPartId = @MoItemPartId";
                        dynamicParameters.Add("MoItemPartId", MoItemPartId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("MES製令刻字號資料錯誤!");

                        int MoId = -1;
                        string MoItemPartNo = "";
                        foreach (var item in result)
                        {
                            MoId = item.MoId;
                            MoItemPartNo = item.MoItemPartNo;
                        }
                        #endregion

                        #region //檢查此刻字號是否已經被綁定
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeAttribute a
                                WHERE a.ItemNo = 'Lettering'
                                AND a.ItemValue = @ItemValue
                                AND a.MoId = @MoId";
                        dynamicParameters.Add("ItemValue", MoItemPartNo);
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("此刻字號【" + MoItemPartNo + "】已被綁定，無法刪除!");
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MoItemPart
                                WHERE MoItemPartId = @MoItemPartId";
                        dynamicParameters.Add("MoItemPartId", MoItemPartId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteLotMoItemPart -- 批量刪除MES製令刻字號資料 -- Ann 2022-10-24
        public string DeleteLotMoItemPart(string MoItemPartId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        string[] MoItemPartIdList = MoItemPartId.Split(',');
                        int rowsAffected = 0;
                        foreach (var item in MoItemPartIdList)
                        {
                            #region //判斷MES製令刻字號資料是否正確
                            sql = @"SELECT a.MoItemPartNo, a.MoId
                                    FROM MES.MoItemPart a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    WHERE MoItemPartId = @MoItemPartId";
                            dynamicParameters.Add("MoItemPartId", item);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("MES製令刻字號資料錯誤!");

                            string MoItemPartNo = "";
                            int MoId = -1;
                            foreach (var item2 in result)
                            {
                                MoItemPartNo = item2.MoItemPartNo;
                                MoId = item2.MoId;
                            }
                            #endregion

                            #region //檢查此刻字號是否已經被綁定
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeAttribute a
                                    WHERE a.ItemNo = 'Lettering'
                                    AND a.ItemValue = @ItemValue
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("ItemValue", MoItemPartNo);
                            dynamicParameters.Add("MoId", MoId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() > 0) throw new SystemException("此刻字號【" + MoItemPartNo + "】已被綁定，無法刪除!");
                            #endregion

                            #region //刪除主要table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM MES.MoItemPart
                                    WHERE MoItemPartId = @MoItemPartId";
                            dynamicParameters.Add("MoItemPartId", item);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteAllMoItemPart -- 刪除指定MES製令刻字號資料 -- Ann 2022-10-24
        public string DeleteAllMoItemPart(int MoId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);

                        if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");
                        #endregion

                        #region //判斷MES製令刻字號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MoItemPartNo
                                FROM MES.MoItemPart
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("此製令無維護任何刻字號資料!");

                        foreach (var item in result2)
                        {
                            #region //檢查此刻字號是否已經被綁定
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeAttribute a
                                    WHERE a.ItemNo = 'Lettering'
                                    AND a.ItemValue = @ItemValue
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("ItemValue", item.MoItemPartNo);
                            dynamicParameters.Add("MoId", MoId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() > 0) throw new SystemException("此刻字號【" + item.MoItemPartNo + "】已被綁定，無法刪除!");
                            #endregion
                        }
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MoItemPart
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMoProcess -- 刪除MES製令製程 -- Ann 2022-11-08
        public string DeleteMoProcess(int MoProcessId)
        {
            try
            {
                AddUserOperateLog(MoProcessId);
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷MES製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MoId
                                FROM MES.MoProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result = sqlConnection.Query(sql, dynamicParameters);

                        if (result.Count() <= 0) throw new SystemException("MES製令製程資料錯誤!");

                        int MoId = -1;
                        foreach (var item in result)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //判斷此製令製程是否已有開工紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess a
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        if (result2.Count() > 0) throw new SystemException("此製令製程已開工，無法刪除!");
                        #endregion

                        #region //確認是否已被託外單綁定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.OspNo
                                FROM MES.OspDetail a
                                INNER JOIN MES.OutsourcingProduction b ON a.OspId = b.OspId
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var OspDetailResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in OspDetailResult)
                        {
                            throw new SystemException("此製程已被託外單【" + item.OspNo + "】綁定，無法刪除!!");
                        }
                        #endregion

                        #region //判斷此製程是否為別顆BARCODE的目前、下製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.BarcodeNo
                                , a.CurrentMoProcessId, a.NextMoProcessId
                                , b.ProcessAlias NextProcessAlias
                                , c.ProcessAlias CurrentProcessAlias
                                FROM MES.Barcode a
                                INNER JOIN MES.MoProcess b ON a.NextMoProcessId = b.MoProcessId
                                INNER JOIN MES.MoProcess c ON a.CurrentMoProcessId = c.MoProcessId
                                WHERE a.CurrentMoProcessId = @MoProcessId
                                OR a.NextMoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        int NextMoProcessId = -1;
                        if (result3.Count() > 0)
                        {
                            foreach (var item in result3)
                            {
                                if (item.CurrentMoProcessId == MoProcessId && item.NextMoProcessId != MoProcessId)
                                {
                                    NextMoProcessId = item.NextMoProcessId;
                                }
                                else
                                {
                                    #region //找尋此製程順序下一製程
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MoProcessId NextMoProcessId, a.ProcessId, a.NecessityStatus, a.SortNumber
                                            FROM MES.MoProcess a
                                            INNER JOIN MES.MoProcess b ON a.MoId = b.MoId AND b.MoProcessId = @MoProcessId
                                            WHERE a.MoId = @MoId AND a.SortNumber = b.SortNumber + 1";
                                    dynamicParameters.Add("MoProcessId", MoProcessId);
                                    dynamicParameters.Add("MoId", MoId);

                                    var NextMoProcessIdResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (NextMoProcessIdResult.Count() <= 0)
                                    {
                                        #region //若找不到則代表已無下製程，將條碼視為最後一站已完工
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode SET
                                                NextMoProcessId = -1,
                                                BarcodeStatus = '0',
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE NextMoProcessId = @MoProcessId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                MoProcessId
                                            });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                    else
                                    {
                                        foreach (var item2 in NextMoProcessIdResult)
                                        {
                                            if (item2.ProcessId == 15 && item2.NecessityStatus == "N" && item2.SortNumber == 1)
                                            {
                                                //throw new SystemException("調整後首站製程為【退鎳】，因此無法進行此次動作!!");
                                            }

                                            NextMoProcessId = item2.NextMoProcessId;
                                        }
                                    }
                                    #endregion
                                }

                                #region //Update Barcode NextMoProcessId
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        NextMoProcessId = @NextMoProcessId,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE NextMoProcessId = @MoProcessId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        NextMoProcessId,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MoProcessId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //Update Barcode CurrentMoProcessId
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        CurrentMoProcessId = @NextMoProcessId,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE CurrentMoProcessId = @MoProcessId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        NextMoProcessId,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MoProcessId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                        }
                        #endregion

                        #region //確認是否有條碼是否還有其他製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcess a
                                WHERE a.MoId = @MoId
                                AND a.MoProcessId != @MoProcessId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoProcessResult.Count() <= 0) throw new SystemException("已無其他剩餘製程，無法刪除!!");
                        #endregion

                        #region //先刪除關聯Table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoProcessQcItem
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoProcessItem
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.AdvancedLog
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MoProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //重新排序
                        dynamicParameters = new DynamicParameters();
                        sql = @"With UpdateSort As
                                (
                                    SELECT SortNumber,
                                    ROW_NUMBER() OVER(ORDER BY SortNumber) NewRoutingProcessSort
                                    FROM MES.MoProcess
                                    WHERE MoId = @MoId
                                )
                                UPDATE MES.MoProcess 
                                SET SortNumber = NewRoutingProcessSort
                                FROM MES.MoProcess
                                INNER JOIN UpdateSort ON MES.MoProcess.SortNumber = UpdateSort.SortNumber
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMoProcessItem -- 刪除製令製程屬性檔 -- Ann 2022-08-12
        public string DeleteMoProcessItem(int MoProcessItemId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷製令製程屬性資料是否正確
                        sql = @"SELECT TOP 1 b.MoId
                                FROM MES.MoProcessItem a
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                WHERE MoProcessItemId = @MoProcessItemId";
                        dynamicParameters.Add("MoProcessItemId", MoProcessItemId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令製程屬性資料錯誤!");

                        int MoId = 0;
                        foreach (var item in result)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoProcessItem
                                WHERE MoProcessItemId = @MoProcessItemId";
                        dynamicParameters.Add("MoProcessItemId", MoProcessItemId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMoProcessChange -- 刪除製令途程變更單 -- Shintokuro 2022-10-27
        public string DeleteMoProcessChange(int MpcId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;

                        #region //判斷製令途程變更單資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcessChange
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令途程變更單資料錯誤!");
                        #endregion


                        #region //先刪除關聯Table
                        //製令途程變更單 - 單身(變更途程製程)
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MpcRoutingProcess
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        //製令途程變更單 - 單身(變更途程所綁定條碼)
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MpcBarcode
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除主要table
                        //製令途程變更單 - 單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.MoProcessChange
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMpcBarcode -- 刪除製令途程變更單條碼 -- Shintokuro 2022-10-27
        public string DeleteMpcBarcode(int MpcBarcodeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;

                        #region //判斷製令途程變更單資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MpcBarcode
                                WHERE MpcBarcodeId = @MpcBarcodeId";
                        dynamicParameters.Add("MpcBarcodeId", MpcBarcodeId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令途程變更單綁定條碼資料錯誤!");
                        #endregion


                        #region //先刪除關聯Table
                        //製令途程變更單 - 單身(變更途程所綁定條碼)
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MpcBarcode
                                WHERE MpcBarcodeId = @MpcBarcodeId";
                        dynamicParameters.Add("MpcBarcodeId", MpcBarcodeId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMpcBarcodeAll -- 刪除製令途程變更單條碼(全) -- Shintokuro 2022-10-27
        public string DeleteMpcBarcodeAll(int MpcId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;

                        #region //判斷製令途程變更單資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MpcBarcode
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令途程變更單綁定條碼資料錯誤!");
                        #endregion


                        #region //先刪除關聯Table
                        //製令途程變更單 - 單身(變更途程所綁定條碼)
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MpcBarcode
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMpcRoutingProcessAll -- 刪除製令途程變更單綁定製程(全) -- Shintokuro 2022-11-02
        public string DeleteMpcRoutingProcessAll(int MpcId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;

                        #region //判斷製令途程變更單資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcessChange
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令途程變更單資料錯誤!");
                        #endregion


                        #region //刪除SQL - 主要Table
                        //製令途程變更單 - 單身(變更途程製程)
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.MpcRoutingProcess
                                WHERE MpcId = @MpcId";
                        dynamicParameters.Add("MpcId", MpcId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新 - 單頭順序狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcessChange SET
                                    SortChange = 'K',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MpcId = @MpcId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LastModifiedDate,
                                LastModifiedBy,
                                MpcId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteSelectedBarcodePrint --刪除已選批量條碼 --Gpai 20230605
        public string DeleteSelectedBarcodePrint(string BarcodePrintIds, int MoId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    string[] BarcodePrintIdList = BarcodePrintIds.Split(',');


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //確認製令資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder a
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoIdResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoIdResult.Count() <= 0) throw new SystemException("製令資訊錯誤!!");
                        #endregion

                        int rowsAffected = 0;

                        foreach (var PrintId in BarcodePrintIdList)
                        {
                            #region //取得此批量條碼資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.PrintId, a.BarcodeNo
                                FROM MES.BarcodePrint a
                                WHERE a.PrintId = @PrintId";
                            dynamicParameters.Add("PrintId", PrintId);

                            var BarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion


                            foreach (var item in BarcodePrintResult)
                            {
                                #region //檢查MES.Barcode是否已經有這筆批量條碼(已開工)
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item.BarcodeNo);

                                var result2 = sqlConnection.Query(sql, dynamicParameters);
                                if (result2.Count() > 0) throw new SystemException("批量條碼已開工，無法刪除!");
                                #endregion

                                #region //檢查是否有在領料條碼中
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                    FROM MES.MrBarcodeRegister a
                                    WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item.BarcodeNo);

                                var MrBarcodeRegisterResult = sqlConnection.Query(sql, dynamicParameters);
                                if (MrBarcodeRegisterResult.Count() > 0) throw new SystemException("此條碼已被領料單綁定，無法刪除!!");
                                #endregion

                                #region //刪除BarcodePrint table
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE MES.BarcodePrint
                                    WHERE PrintId = @PrintId";
                                dynamicParameters.Add("PrintId", item.PrintId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //Barcode table
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT *
                                    FROM MES.Barcode
                                    WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item.BarcodeNo);
                                var barcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                #endregion

                                if (barcodeResult.Count() > 0)
                                {
                                    var delBarcodeId = barcodeResult.First().BarcodeId;

                                    #region //BarcodeAttribute table
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT *
                                    FROM MES.BarcodeAttribute
                                    WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", delBarcodeId);
                                    var barcodeAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (barcodeAttributeResult.Count() > 0)
                                    {
                                        #region //刪除BarcodeAttribute table
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE MES.BarcodeAttribute
                                    WHERE BarcodeId = @BarcodeId";
                                        dynamicParameters.Add("BarcodeId", delBarcodeId);

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                    #endregion

                                    #region //刪除Barcode table
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE MES.Barcode
                                    WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", delBarcodeId);

                                    var barcodeDelResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }

                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteDepSecondmentRecord --刪除部門借調記錄 -- WuTC 2024-03-27
        public string DeleteDepSecondmentRecord(int DsId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;

                        #region //刪除Barcode table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.DepartmentalSecondment
                        WHERE DsId = @DsId";
                        dynamicParameters.Add("DsId", DsId);

                        var barcodeDelResult = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteOspList -- 刪除委外預排製程 -- Ann 2025-06-10
        public string DeleteOspList(string OspListIds)
        {
            try
            {
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (OspListIds.Length <= 0) throw new SystemException("刪除ID不可為空!!");

                        string[] ospListIdArray = OspListIds.Split(',');
                        foreach (var ospListId in ospListIdArray)
                        {
                            #region //判斷委外預排製程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.[Status]
                                    FROM MES.OspList a 
                                    WHERE a.OspListId = @OspListId";
                            dynamicParameters.Add("OspListId", ospListId);

                            var result = sqlConnection.Query(sql, dynamicParameters);

                            if (result.Count() <= 0) throw new SystemException("委外預排製程資料錯誤!!");
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.OspList
                                    WHERE OspListId = @OspListId";
                            dynamicParameters.Add("OspListId", ospListId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //公用程式
        #region //AddWoDetailLog --ERP工單單身Log紀錄 --Shintokuro 2023-09-28
        public int AddWoDetailLog(string TransactionType, string ErpDb, string ErpNo, int TransactionUserId, DateTime TransactionDate,
                int CompanyId, int WoId, int WoDetailId, int WoMtlItemId, string WoErpPrefix, string WoErpNo, int MtlItemId, int InventoryId, int UomId,
                double CompositionQuantity, double Base, double LossRate, string BomSequence, double DemandRequisitionQty, int RequisitionQty, string Substitute, string SubstituteStatus,
                int SubstituteMtlItemId, string MaterialProperties, string ExpectedRequisitionDate, string ActualRequisitionDate,
                string WipDetailRemark, string ConfirmStatus, DateTime CreateDate, DateTime LastModifiedDate, int CreateBy, int LastModifiedBy, SqlConnection sqlConnection)
        {
            int rows = 0;

            dynamicParameters = new DynamicParameters();
            sql = @"INSERT INTO MES.WoDetailLog (TransactionType, ErpDb, ErpNo, TransactionUserId, TransactionDate, 
                    CompanyId, WoId, WoDetailId, WoMtlItemId, WoErpPrefix, WoErpNo, MtlItemId, InventoryId, UomId, 
                    CompositionQuantity, Base, LossRate, BomSequence, DemandRequisitionQty, RequisitionQty, Substitute, 
                    SubstituteStatus, SubstituteMtlItemId, MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate, 
                    WipDetailRemark, ConfirmStatus, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                    VALUES (@TransactionType ,@ErpDb ,@ErpNo ,@TransactionUserId ,@TransactionDate 
                    ,@CompanyId ,@WoId ,@WoDetailId ,@WoMtlItemId ,@WoErpPrefix ,@WoErpNo ,@MtlItemId ,@InventoryId ,@UomId
                    ,@CompositionQuantity ,@Base ,@LossRate ,@BomSequence ,@DemandRequisitionQty ,@RequisitionQty ,@Substitute
                    ,@SubstituteStatus ,@SubstituteMtlItemId ,@MaterialProperties ,@ExpectedRequisitionDate ,@ActualRequisitionDate
                    ,@WipDetailRemark ,@ConfirmStatus ,@CreateDate ,@LastModifiedDate ,@CreateBy ,@LastModifiedBy)";
            dynamicParameters.AddDynamicParams(
                new
                {
                    TransactionType,
                    ErpDb,
                    ErpNo,
                    TransactionUserId,
                    TransactionDate,
                    CompanyId,
                    WoId,
                    WoDetailId,
                    WoMtlItemId,
                    WoErpPrefix,
                    WoErpNo,
                    MtlItemId,
                    InventoryId,
                    UomId,
                    CompositionQuantity,
                    Base,
                    LossRate,
                    BomSequence,
                    DemandRequisitionQty,
                    RequisitionQty,
                    Substitute,
                    SubstituteStatus,
                    SubstituteMtlItemId,
                    MaterialProperties,
                    ExpectedRequisitionDate,
                    ActualRequisitionDate,
                    WipDetailRemark,
                    ConfirmStatus,
                    CreateDate,
                    LastModifiedDate,
                    CreateBy,
                    LastModifiedBy
                });

            var insertResult = sqlConnection.Query(sql, dynamicParameters);
            return rows;
        }
        #endregion
        #endregion

        #region //FOR EIP API
        #region //GetMoSettingEIP -- 取得MES製令設定 --
        public string GetMoSettingEIP(int MoId
            , string OrderBy, int PageIndex, int PageSize, int[] CustomerIds)
        {
            try
            {
                if (CustomerIds == null) throw new SystemException("客戶資料尚未綁定");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MoSettingId, g.CustomerId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MoId, a.LotStatus, a.LotQty, a.BarcodePrefix, a.SequenceLen, a.BarcodePostfix, a.NgToBarcode
                        , a.MtlControl, a.Source, a.PVTQCFlag, a.OQcCheckType, a.BarcodeCtrl, a.TrayBarcode, a.MrType, a.OutputBarcodeFlag, a.NgToDisassembly
                        , b.WoId, b.Quantity, b.DeliveryProcess
                        , c.MtlItemId, c.WoErpPrefix, c.WoErpNo
                        , d.ModeId, d.ModeNo, d.ModeName
                        , e.MtlItemNo, e.MtlItemName";
                    sqlQuery.mainTables =
                        @"FROM MES.MoSetting a
                        INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                        INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                        LEFT JOIN MES.ProdMode d ON b.ModeId = d.ModeId
                        INNER JOIN PDM.MtlItem e ON c.MtlItemId = e.MtlItemId
                        INNER JOIN BAS.Company f on c.CompanyId = f.CompanyId
                        INNER JOIN SCM.Customer g on f.CompanyId = g.CompanyId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND g.CustomerId IN @CustomerId";
                    dynamicParameters.Add("CustomerId", CustomerIds);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoSettingId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion

        #region //For 批量建立製令作業
        #region //ExpandStructure -- 品號展開下階BOM物料 -- Ann 2024-07-23
        public string ExpandStructure(string UploadJson, string BomExpandFlag)
        {
            try
            {
                if (UploadJson.Length <= 0) throw new SystemException("品號資料不能為空!!");
                if (BomExpandFlag != "Y" && BomExpandFlag != "N") throw new SystemException("是否展延BOM不能為空!!");

                List<BatchManufactureOrder> batchManufactureOrders = new List<BatchManufactureOrder>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        JObject mtlItemJson = JObject.Parse(UploadJson);
                        foreach (var item in mtlItemJson["mtlItemInfo"])
                        {
                            BatchManufactureOrder batchManufactureOrder = new BatchManufactureOrder();

                            switch (BomExpandFlag)
                            {
                                case "Y":
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"WITH RecursiveCTE AS (
                                            SELECT a.MtlItemId, a.CompositionQuantity, a.Base
                                            , c.MtlItemId ParentMtlItemId, c.MtlItemNo ParentMtlItemNo, c.MtlItemName ParentMtlItemName
                                            , d.MtlItemNo, d.MtlItemName, d.MtlItemSpec, d.ItemAttribute
                                            , e.TypeName ItemAttributeName
                                            , f.InventoryNo
                                            , g.UomNo
                                            FROM PDM.BomDetail a 
                                            INNER JOIN PDM.BillOfMaterials b ON a.BomId = b.BomId
                                            INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                            INNER JOIN PDM.MtlItem d ON a.MtlItemId = d.MtlItemId
                                            INNER JOIN BAS.[Type] e ON d.ItemAttribute = e.TypeNo AND e.TypeSchema = 'MtlItem.ItemAttribute'
                                            INNER JOIN SCM.Inventory f ON d.InventoryId = f.InventoryId
                                            INNER JOIN PDM.UnitOfMeasure g ON a.UomId = g.UomId
                                            WHERE b.MtlItemId = @MtlItemId
                                            AND GETDATE() >= ISNULL(d.EffectiveDate, GETDATE())
	                                        AND GETDATE() <= ISNULL(d.ExpirationDate, GETDATE())
                                            UNION ALL
                                            SELECT x.MtlItemId, x.CompositionQuantity, x.Base
                                            , xc.MtlItemId ParentMtlItemId, xc.MtlItemNo ParentMtlItemNo, xc.MtlItemName ParentMtlItemName
                                            , xd.MtlItemNo ,xd.MtlItemName, xd.MtlItemSpec, xd.ItemAttribute
                                            , xe.TypeName ItemAttributeName
                                            , xf.InventoryNo
                                            , xg.UomNo
                                            FROM PDM.BomDetail x
                                            INNER JOIN PDM.BillOfMaterials xb ON x.BomId = xb.BomId
                                            INNER JOIN RecursiveCTE xa ON xb.MtlItemId = xa.MtlItemId
                                            INNER JOIN PDM.MtlItem xc ON xb.MtlItemId = xc.MtlItemId
                                            INNER JOIN PDM.MtlItem xd ON x.MtlItemId = xd.MtlItemId
                                            INNER JOIN BAS.[Type] xe ON xd.ItemAttribute = xe.TypeNo AND xe.TypeSchema = 'MtlItem.ItemAttribute'
                                            INNER JOIN SCM.Inventory xf ON xd.InventoryId = xf.InventoryId
                                            INNER JOIN PDM.UnitOfMeasure xg ON x.UomId = xg.UomId
                                            AND GETDATE() >= ISNULL(xd.EffectiveDate, GETDATE())
	                                        AND GETDATE() <= ISNULL(xd.ExpirationDate, GETDATE())
                                        )
                                        SELECT MtlItemId
                                        , MtlItemNo, MtlItemName, MtlItemSpec, ItemAttribute
                                        , ItemAttributeName
                                        , InventoryNo
                                        , CompositionQuantity, Base, UomNo
                                        , ParentMtlItemId, ParentMtlItemNo, ParentMtlItemName
                                        , 2 AS SortOrder
                                        FROM RecursiveCTE
                                        UNION ALL
                                        SELECT x.MtlItemId
                                        , x.MtlItemNo ,x.MtlItemName, x.MtlItemSpec, x.ItemAttribute
                                        , xa.TypeName ItemAttributeName
                                        , xb.InventoryNo
                                        , NULL CompositionQuantity, NULL Base, xc.UomNo
                                        , NULL ParentMtlItemId, NULL ParentMtlItemNo, NULL ParentMtlItemName
                                        , 1 AS SortOrder
                                        FROM PDM.MtlItem x 
                                        INNER JOIN BAS.[Type] xa ON x.ItemAttribute = xa.TypeNo AND xa.TypeSchema = 'MtlItem.ItemAttribute'
                                        INNER JOIN SCM.Inventory xb ON x.InventoryId = xb.InventoryId
                                        INNER JOIN PDM.UnitOfMeasure xc ON x.InventoryUomId = xc.UomId
                                        WHERE x.MtlItemId = @MtlItemId
                                        AND GETDATE() >= ISNULL(x.EffectiveDate, GETDATE())
                                        AND GETDATE() <= ISNULL(x.ExpirationDate, GETDATE())
                                        ORDER BY SortOrder, ItemAttribute;";
                                    break;
                                case "N":
                                    sql = @"SELECT a.MtlItemId, a.MtlItemNo, a.MtlItemName, a.MtlItemSpec, a.ItemAttribute
                                            , b.TypeName ItemAttributeName
                                            , c.InventoryNo
                                            , d.UomNo
                                            FROM PDM.MtlItem a 
                                            INNER JOIN BAS.[Type] b ON a.ItemAttribute = b.TypeNo AND b.TypeSchema = 'MtlItem.ItemAttribute'
                                            INNER JOIN SCM.Inventory c ON a.InventoryId = c.InventoryId
                                            INNER JOIN PDM.UnitOfMeasure d ON a.InventoryUomId = d.UomId
                                            WHERE a.MtlItemId = @MtlItemId";
                                    break;
                                default:
                                    throw new SystemException("BOM是否展開的設定錯誤!!");
                            }
                            dynamicParameters.Add("MtlItemId", Convert.ToInt32(item["MtlItemId"]));

                            var ExpandResult = sqlConnection.Query<BatchManufactureOrder>(sql, dynamicParameters);

                            batchManufactureOrders.AddRange(ExpandResult);
                        }

                        #region //取得EPR相關資料
                        int index = 0;
                        foreach (var item in batchManufactureOrders)
                        {
                            #region //取得ERP庫存數
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(MC007, 0) MC007 
                                    FROM INVMC 
                                    WHERE MC001 = @MC001 
                                    AND MC002 = @MC002";
                            dynamicParameters.Add("MC001", item.MtlItemNo);
                            dynamicParameters.Add("MC002", item.InventoryNo);

                            var INVMCResult = sqlConnection2.Query(sql, dynamicParameters);

                            double? InventoryQty = 0;
                            foreach (var item2 in INVMCResult)
                            {
                                InventoryQty = Convert.ToDouble(item2.MC007);
                            }

                            batchManufactureOrders[index].InventoryQty = InventoryQty;
                            #endregion

                            #region //取得ERP在途採購數量
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(SUM(TD008 - TD015), 0) PoQty
                                    FROM PURTD 
                                    WHERE TD004 = @MtlItemNo 
                                    AND TD016 = 'N'
                                    AND TD018 = 'Y'";
                            dynamicParameters.Add("MtlItemNo", item.MtlItemNo);

                            var PURTDResult = sqlConnection2.Query(sql, dynamicParameters);

                            double? PoQty = 0;
                            foreach (var item2 in PURTDResult)
                            {
                                PoQty = Convert.ToDouble(item2.PoQty);
                            }

                            batchManufactureOrders[index].PoQty = PoQty;
                            #endregion

                            index++;
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = batchManufactureOrders
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //BatchAddManufactureOrder -- 批量開立製令 -- Ann 2024-08-01
        public string BatchAddManufactureOrder(string UploadJson)
        {
            try
            {
                if (UploadJson.Length <= 0) throw new SystemException("上傳檔案內容為空，請嘗試重新操作!!");
                List<string> TotalErrorMessages = new List<string>();
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        string CompanyNo = "";
                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            CompanyNo = item.CompanyNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            JObject uploadJson = JObject.Parse(UploadJson);
                            List<int> MoIdList = new List<int>();
                            foreach (var item in uploadJson["uploadInfo"])
                            {
                                List<string> ErrorMessages = new List<string>();

                                string defaultErrorMsg = "製令【" + item["WoErpPrefix"].ToString() + "-" + item["WoErpNo"] + "】<br>";
                                ErrorMessages.Add(defaultErrorMsg);

                                #region //資料驗證段
                                #region //確認單別是否有誤
                                if (item["WoErpPrefix"] != null)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                        FROM CMSMQ 
                                        LEFT JOIN CMSMU ON MQ001 = MU001 
                                        WHERE (MQ003 = '51' OR MQ003 = '52')
                                        AND MQ001 = @WoErpPrefix
                                        AND ((MU003 = '" + UserNo + "' AND MQ029 = 'Y')  or MQ029 = 'N' )";
                                    dynamicParameters.Add("WoErpPrefix", item["WoErpPrefix"].ToString());

                                    var CMSMQResult = sqlConnection2.Query(sql, dynamicParameters);

                                    if (CMSMQResult.Count() <= 0) ErrorMessages.Add("(" + ErrorMessages.Count + ") 製令單別錯誤!!<br>");
                                }
                                else
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 製令單別不能為空值!!<br>");
                                }
                                //if (item["WoErpPrefix"].ToString().IndexOf("52") != -1) ErrorMessages.Add("(" + ErrorMessages.Count + ") 此模式下無法開立52單別製令!!<br>");
                                #endregion

                                #region //單號驗證
                                if (item["WoErpNo"] == null || item["WoErpNo"].Type.ToString() == "Null")
                                {
                                    item["WoErpNo"] = BaseHelper.RandomCode(11);
                                }
                                #endregion

                                #region //確認日期格式是否正確
                                DateTime parsedDate;
                                bool docDateIsValid;
                                bool ExpectedStartIsValid = false;
                                bool ExpectedEndIsValid = false;

                                if (item["DocDate"] != null)
                                {
                                    docDateIsValid = DateTime.TryParseExact(
                                        item["DocDate"].ToString(),
                                        "yyyy-MM-dd",
                                        CultureInfo.InvariantCulture,
                                        DateTimeStyles.None,
                                        out parsedDate
                                    );
                                    if (!docDateIsValid)
                                    {
                                        ErrorMessages.Add("(" + ErrorMessages.Count + ") 【單據日期】格式錯誤!!<br>");
                                    }
                                }
                                else
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 【單據日期】不能為空值!!<br>");
                                }

                                if (item["ExpectedStart"] != null)
                                {
                                    ExpectedStartIsValid = DateTime.TryParseExact(
                                        item["ExpectedStart"].ToString(),
                                        "yyyy-MM-dd",
                                        CultureInfo.InvariantCulture,
                                        DateTimeStyles.None,
                                        out parsedDate
                                    );
                                    if (!ExpectedStartIsValid)
                                    {
                                        ErrorMessages.Add("(" + ErrorMessages.Count + ") 【預計開工日期】格式錯誤!!<br>");
                                    }
                                }
                                else
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 【預計開工日期】不能為空值!!<br>");
                                }

                                if (item["ExpectedEnd"] != null)
                                {
                                    ExpectedEndIsValid = DateTime.TryParseExact(
                                        item["ExpectedEnd"].ToString(),
                                        "yyyy-MM-dd",
                                        CultureInfo.InvariantCulture,
                                        DateTimeStyles.None,
                                        out parsedDate
                                    );
                                    if (!ExpectedEndIsValid)
                                    {
                                        ErrorMessages.Add("(" + ErrorMessages.Count + ") 【預計完工日期】格式錯誤!!<br>");
                                    }
                                }
                                else
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 【預計完工日期】不能為空值!!<br>");
                                }

                                if (ExpectedStartIsValid && ExpectedEndIsValid)
                                {
                                    #region //預計開工完工日檢核
                                    DateTime startDate = DateTime.Parse(item["ExpectedStart"].ToString());
                                    DateTime endDate = DateTime.Parse(item["ExpectedEnd"].ToString());
                                    if (startDate > endDate)
                                    {
                                        ErrorMessages.Add("(" + ErrorMessages.Count + ") 【預計開工日】不可大於【預計完工日】!!<br>");
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //確認MES品號資料是否正確
                                int MtlItemId = -1;
                                string MtlItemNo = "";
                                string MtlItemName = "";
                                string MtlItemSpec = "";
                                int UomId = -1;

                                if (item["MtlItemNo"] != null)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MtlItemId, a.MtlItemNo, a.MtlItemName, a.MtlItemSpec
                                        , a.InventoryUomId UomId
                                        FROM PDM.MtlItem a 
                                        WHERE a.MtlItemNo = @MtlItemNo
                                        AND a.TransferStatus = 'Y'
                                        AND a.CompanyId = @CompanyId";
                                    dynamicParameters.Add("MtlItemNo", item["MtlItemNo"].ToString());
                                    dynamicParameters.Add("CompanyId", CurrentCompany);

                                    var MtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (MtlItemResult.Count() <= 0) ErrorMessages.Add("(" + ErrorMessages.Count + ") 查無此品號資料: " + item["MtlItemNo"].ToString() + "!!<br>");

                                    foreach (var item2 in MtlItemResult)
                                    {
                                        MtlItemId = item2.MtlItemId;
                                        MtlItemNo = item2.MtlItemNo;
                                        MtlItemName = item2.MtlItemName;
                                        MtlItemSpec = item2.MtlItemSpec;
                                        UomId = item2.UomId;
                                    }
                                }
                                else
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 品號資料不能為空值!!<br>");
                                }
                                
                                #endregion

                                #region //確認ERP品號相關資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MB004)) MB004
                                        , LTRIM(RTRIM(MB030)) MB030
                                        , LTRIM(RTRIM(MB031)) MB031
                                        FROM INVMB
                                        WHERE MB001 = @MB001";
                                dynamicParameters.Add("MB001", MtlItemNo);

                                var INVMBResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (INVMBResult.Count() <= 0) ErrorMessages.Add("(" + ErrorMessages.Count + ") ERP品號基本資料錯誤!!<br>");

                                foreach (var item2 in INVMBResult)
                                {
                                    #region //判斷ERP品號生效日與失效日
                                    if (item2.MB030 != "" && item2.MB030 != null)
                                    {
                                        #region //判斷單據日期需大於或等於生效日
                                        string EffectiveDate = item2.MB030;
                                        string effYear = EffectiveDate.Substring(0, 4);
                                        string effMonth = EffectiveDate.Substring(4, 2);
                                        string effDay = EffectiveDate.Substring(6, 2);
                                        DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                        int effresult = DateTime.Compare(Convert.ToDateTime(item["DocDate"].ToString()), effFullDate);
                                        if (effresult < 0) ErrorMessages.Add("(" + ErrorMessages.Count + ") 此品號尚未生效，無法使用!!<br>");
                                        #endregion
                                    }

                                    if (item2.MB031 != "" && item2.MB031 != null)
                                    {
                                        #region //判斷日期需小於或等於失效日
                                        string ExpirationDate = item2.MB031;
                                        string effYear = ExpirationDate.Substring(0, 4);
                                        string effMonth = ExpirationDate.Substring(4, 2);
                                        string effDay = ExpirationDate.Substring(6, 2);
                                        DateTime effFullDate = Convert.ToDateTime(effYear + "-" + effMonth + "-" + effDay);
                                        int effresult = DateTime.Compare(Convert.ToDateTime(item["DocDate"].ToString()), effFullDate);
                                        if (effresult > 0) ErrorMessages.Add("(" + ErrorMessages.Count + ") 此品號已失效，無法使用!!<br>");
                                        #endregion
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //確認此單別單號在ERP是否已存在
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1 
                                        FROM MOCTA 
                                        WHERE TA001 = @TA001 
                                        AND TA002 = @TA002";
                                dynamicParameters.Add("TA001", item["WoErpPrefix"].ToString());
                                dynamicParameters.Add("TA002", item["WoErpNo"].ToString());

                                var MOCTAResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (MOCTAResult.Count() > 0) ErrorMessages.Add("(" + ErrorMessages.Count + ") 此單別單號已存在ERP，無法重複建立!!<br>");
                                #endregion

                                #region //判斷庫別資料是否正確
                                int InventoryId = -1;

                                if (item["InventoryNo"] != null)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.InventoryId
                                            FROM SCM.Inventory a 
                                            WHERE a.InventoryNo = @InventoryNo
                                            AND a.CompanyId = @CompanyId";
                                    dynamicParameters.Add("InventoryNo", item["InventoryNo"].ToString());
                                    dynamicParameters.Add("CompanyId", CurrentCompany);

                                    var InventoryResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (InventoryResult.Count() <= 0) ErrorMessages.Add("(" + ErrorMessages.Count + ") 庫別資料有誤!!<br>");

                                    foreach (var item2 in InventoryResult)
                                    {
                                        InventoryId = item2.InventoryId;
                                    }
                                }
                                else
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 庫別不能為空值!!<br>");
                                }
                                #endregion

                                #region //判斷訂單資料是否正確
                                int SoDetailId = -1;
                                if (item["SoErpFullNo"] != null && item["SoErpFullNo"].ToString().Length > 0)
                                {
                                    if (item["SoErpFullNo"].ToString().IndexOf("(") == -1)
                                    {
                                        ErrorMessages.Add("(" + ErrorMessages.Count + ") 訂單格式錯誤!!<br>");
                                    }
                                    else
                                    {
                                        string soErpPrefix = item["SoErpFullNo"].ToString().Split('-')[0];
                                        string soErpNo = item["SoErpFullNo"].ToString().Split('-')[1].Split('(')[0];
                                        string soSequence = item["SoErpFullNo"].ToString().Split('-')[1].Split('(')[1].Split(')')[0];

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.SoDetailId
                                                FROM SCM.SoDetail a 
                                                INNER JOIN SCM.SaleOrder b ON a.SoId = b.SoId
                                                WHERE b.SoErpPrefix = @SoErpPrefix
                                                AND b.SoErpNo = @SoErpNo 
                                                AND a.SoSequence = @SoSequence
                                                AND b.CompanyId = @CompanyId 
                                                AND b.ConfirmStatus = 'Y'";
                                        dynamicParameters.Add("SoErpPrefix", soErpPrefix);
                                        dynamicParameters.Add("SoErpNo", soErpNo);
                                        dynamicParameters.Add("SoSequence", soSequence);
                                        dynamicParameters.Add("CompanyId", CurrentCompany);

                                        var SoDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (SoDetailResult.Count() <= 0) ErrorMessages.Add("(" + ErrorMessages.Count + ") 查無訂單資料!!<br>");

                                        foreach (var item2 in SoDetailResult)
                                        {
                                            SoDetailId = item2.SoDetailId;
                                        }
                                    }
                                }
                                #endregion

                                #region //確認計畫生產數量格式
                                if (item["PlanQty"] != null)
                                {
                                    int checkResult;
                                    bool canConvert = int.TryParse(item["PlanQty"].ToString(), out checkResult);
                                    if (!canConvert)
                                    {
                                        ErrorMessages.Add("(" + ErrorMessages.Count + ") 計畫生產數無法轉換為數字!!<br>");
                                    }
                                }
                                else
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 計畫生產數不能為空值!!<br>");
                                }
                                #endregion

                                #region //確認途程資料是否正確
                                int RoutingItemId = -1;
                                int ModeId = -1;
                                string OQcCheckType = "N";
                                string ModeName = "";
                                string BarcodeCtrl = "Y";
                                string Source = "MR";
                                string PVTQCFlag = "N";
                                string NgToBarcode = "N";
                                string TrayBarcode = "N";
                                string LotStatus = "N";
                                string MrType = "Y";
                                if (item["RoutingItemId"] != null && item["RoutingItemId"].ToString().Length > 0)
                                {
                                    if (item["RoutingItemId"].ToString().IndexOf(":") == -1)
                                    {
                                        ErrorMessages.Add("(" + ErrorMessages.Count + ") 途程品號格式錯誤: " + item["RoutingItemId"].ToString() + "!!<br>");
                                    }
                                    else
                                    {
                                        RoutingItemId = Convert.ToInt32(item["RoutingItemId"].ToString().Split(':')[0]);
                                    }

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.RoutingItemId, a.RoutingId, a.ControlId, a.MtlItemId, a.RoutingItemConfirm
                                            , b.ModeId, b.RoutingConfirm, b.Status, b.RoutingName
                                            , c.ModeName, c.OQcCheckType, c.BarcodeCtrl, c.Source, c.PVTQCFlag, c.NgToBarcode
                                            , c.TrayBarcode, c.LotStatus, c.OutputBarcodeFlag, c.MrType
                                            FROM MES.RoutingItem a
                                            INNER JOIN MES.Routing b ON a.RoutingId = b.RoutingId
                                            INNER JOIN MES.ProdMode c ON b.ModeId = c.ModeId
                                            WHERE a.RoutingItemId = @RoutingItemId
                                            AND a.RoutingItemConfirm = 'Y'
                                            AND b.RoutingConfirm = 'Y'
                                            ORDER BY a.CreateDate ";
                                    dynamicParameters.Add("RoutingItemId", RoutingItemId);

                                    var RoutingItemResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (RoutingItemResult.Count() <= 0)
                                    {
                                        ErrorMessages.Add("(" + ErrorMessages.Count + ") 查無此途程品號資料: " + item["RoutingItemId"].ToString() + "!!<br>");
                                    }

                                    foreach (var item2 in RoutingItemResult)
                                    {
                                        if (item2.MtlItemId != MtlItemId)
                                        {
                                            ErrorMessages.Add("(" + ErrorMessages.Count + ") 途程品號與製令品號不同: " + item["RoutingItemId"].ToString() + "!!<br>");
                                        }

                                        RoutingItemId = item2.RoutingItemId;
                                        ModeId = item2.ModeId;
                                        OQcCheckType = item2.OQcCheckType;
                                        ModeName = item2.ModeName;
                                        BarcodeCtrl = item2.BarcodeCtrl;
                                        BarcodeCtrl = item2.BarcodeCtrl;
                                        Source = item2.Source;
                                        PVTQCFlag = item2.PVTQCFlag;
                                        NgToBarcode = item2.NgToBarcode;
                                        TrayBarcode = item2.TrayBarcode;
                                        LotStatus = item2.LotStatus;
                                        MrType = item2.MrType;
                                    }
                                }
                                #endregion
                                #endregion

                                #region //確認相關資料
                                #region //取得本幣資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 MA003 FROM CMSMA";
                                var CMSMAResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (CMSMAResult.Count() <= 0)
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 取得本幣資料錯誤!!<br>");
                                }

                                string CurrencyCode = "";
                                foreach (var item2 in CMSMAResult)
                                {
                                    CurrencyCode = item2.MA003;
                                }
                                #endregion

                                #region //取得本幣匯率
                                string Today = DateTime.Now.ToString("yyyyMMdd");
                                sql = @"SELECT TOP 1 ROUND(LTRIM(RTRIM(MG005)),3) MG005
                                        FROM CMSMG 
                                        WHERE MG001 = @MG001
                                        AND MG002 <= @Today
                                        ORDER BY MG002 DESC";
                                dynamicParameters.Add("MG001", CurrencyCode);
                                dynamicParameters.Add("Today", Today);

                                var CMSMGResult = sqlConnection2.Query(sql, dynamicParameters);

                                if (CMSMGResult.Count() <= 0)
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 本幣匯率資料錯誤!!<br>");
                                }

                                double Exchange = 0;
                                foreach (var item2 in CMSMGResult)
                                {
                                    Exchange = item2.MG005;
                                }
                                #endregion

                                #region //取得BOM版次資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MC009)) MC009
                                        FROM BOMMC 
                                        WHERE MC001 = @MC001";
                                dynamicParameters.Add("MC001", MtlItemNo);
                                var BOMMCResult = sqlConnection2.Query(sql, dynamicParameters);

                                string BomVersion = "0000";
                                foreach (var item2 in BOMMCResult)
                                {
                                    BomVersion = item2.MC009;
                                }
                                #endregion

                                #region //取得此品號BOM結構
                                if (item["WoErpPrefix"].ToString().IndexOf("52") == -1)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT test.* FROM(
							            SELECT  a.ConfirmStatus,b.MtlItemNo as ManMtlItemNo,b.MtlItemId as ManMtlItemId
							            ,c.MtlItemId,c.EffectiveDate,c.ExpirationDate,c.CompositionQuantity,c.Base,c.BomSequence,c.LossRate,c.MaterialProperties
							            ,d.MtlItemNo as BomDetailMtlItemNo ,d.InventoryId, d.InventoryUomId,d.MtlItemRemark
							            , ROW_NUMBER() OVER(ORDER BY c.BomSequence) seq 
							            ,(CASE WHEN c.EffectiveDate is not null 
		                                        THEN (
			                                        case when CONVERT(varchar(10),c.EffectiveDate, 120)  <= @DocDate
			                                        THEN 1
			                                        ELSE 2
			                                        END ) 
		                                        ELSE 3
		                                        END) as EffectiveDateStatus
	                                        ,(CASE WHEN c.ExpirationDate is not null 
		                                        THEN (
			                                        case when CONVERT(varchar(10),c.ExpirationDate, 120)  >= @DocDate
			                                        THEN 1 
			                                        ELSE 2 
			                                        END ) 
		                                        ELSE 3
		                                        END) as ExpirationDateStatus
							            FROM PDM.BillOfMaterials a
							            INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
							            INNER JOIN PDM.BomDetail c on a.BomId = c.BomId
							            INNER JOIN PDM.MtlItem d on c.MtlItemId = d.MtlItemId) test
							            WHERE test.ManMtlItemId = @MtlItemId
                                        AND test.ConfirmStatus = 'Y'
                                        AND test.EffectiveDateStatus !=2
							            AND test.ExpirationDateStatus !=2
                                        Order By seq DESC";
                                    dynamicParameters.Add("MtlItemId", MtlItemId);
                                    dynamicParameters.Add("DocDate", item["DocDate"].ToString());
                                }
                                else
                                {
                                    #region //撈取品號相關資料
                                    sql = @"SELECT MtlItemId, MtlItemNo, InventoryId, InventoryUomId, MtlItemRemark
                                            , 1 CompositionQuantity, 1 Base, 1 LossRate, '1' MaterialProperties
                                            FROM PDM.MtlItem a
                                            WHERE 1=1
                                            AND MtlItemId = @MtlItemId
                                            AND TransferStatus = 'Y'";
                                    dynamicParameters.Add("MtlItemId", MtlItemId);
                                    #endregion
                                }

                                var BillOfMaterialsResult = sqlConnection.Query(sql, dynamicParameters);
                                if (BillOfMaterialsResult.Count() <= 0)
                                {
                                    ErrorMessages.Add("(" + ErrorMessages.Count + ") 查無此品號相關BOM材料資料!!<br>");
                                }
                                #endregion
                                #endregion

                                if (ErrorMessages.Count > 1)
                                {
                                    ErrorMessages.Add("=======================<br>");
                                    TotalErrorMessages.AddRange(ErrorMessages);
                                    continue;
                                }

                                #region //INSERT MES段

                                #region //INSERT MES.WipOrder
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.WipOrder (CompanyId, UserId, WoErpPrefix, WoErpNo, Version, DocDate, MtlItemId, InventoryId, UomId, 
                                        PlanQty, RequisitionSetQty, StockInQty, ScrapQty, ExpectedStart, ExpectedEnd, ActualStart, ActualEnd, BomDate, 
                                        BomVersion, UrgentMtl, Property, ProductionLine, Processor, CurrencyCode, Exchange, TaxCode, TaxType, TaxRate, PricingTerm, PaymentTerm,
                                        SoDetailId, Project, WoRemark, ConfirmStatus, ConfirmUserId, 
                                        ConfirmDate, WoStatus, LossRateStatus, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, 
                                        LastModifiedBy)
                                        OUTPUT INSERTED.WoId, INSERTED.WoErpNo, INSERTED.Version, INSERTED.BomDate, INSERTED.BomVersion
                                        VALUES (@CompanyId, @UserId, @WoErpPrefix, @WoErpNo, @Version, @DocDate, @MtlItemId, @InventoryId, @UomId, 
                                        @PlanQty, @RequisitionSetQty, @StockInQty, @ScrapQty, @ExpectedStart, @ExpectedEnd, @ActualStart, @ActualEnd, @BomDate, 
                                        @BomVersion, @UrgentMtl, @Property, @ProductionLine, @Processor, @CurrencyCode, @Exchange, @TaxCode, @TaxType, @TaxRate, @PricingTerm, @PaymentTerm,
                                        @SoDetailId, @Project, @WoRemark, @ConfirmStatus, @ConfirmUserId, 
                                        @ConfirmDate, @WoStatus, @LossRateStatus, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, 
                                        @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        CompanyId = CurrentCompany,
                                        UserId = CurrentUser,
                                        WoErpPrefix = item["WoErpPrefix"].ToString(),
                                        WoErpNo = item["WoErpNo"].ToString(),
                                        Version = "0000",
                                        DocDate = item["DocDate"].ToString(),
                                        MtlItemId,
                                        InventoryId,
                                        UomId,
                                        PlanQty = Convert.ToInt32(item["PlanQty"]),
                                        RequisitionSetQty = 0,
                                        StockInQty = 0,
                                        ScrapQty = 0,
                                        ExpectedStart = item["ExpectedStart"].ToString(),
                                        ExpectedEnd = item["ExpectedEnd"].ToString(),
                                        ActualStart = (string)null,
                                        ActualEnd = (string)null,
                                        BomDate = CreateDate,
                                        BomVersion,
                                        UrgentMtl = "N",
                                        SoDetailId = SoDetailId > 0 ? SoDetailId : (int?)null,
                                        Project = "",
                                        Property = "2",
                                        ProductionLine = "",
                                        Processor = "",
                                        CurrencyCode,
                                        Exchange,
                                        TaxCode = "",
                                        TaxType = "",
                                        TaxRate = 0,
                                        PricingTerm = "",
                                        PaymentTerm = "",
                                        WoRemark = "",
                                        ConfirmStatus = "N",
                                        ConfirmUserId = "",
                                        ConfirmDate = (DateTime?)null,
                                        WoStatus = "1",
                                        LossRateStatus = "Y",
                                        TransferStatus = "N",
                                        TransferDate = (DateTime?)null,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);
                                rowsAffected += insertResult.Count();

                                int WoId = -1;
                                foreach (var item2 in insertResult)
                                {
                                    WoId = item2.WoId;
                                }
                                #endregion

                                #region //INSERT MES.WoDetail
                                foreach (var item2 in BillOfMaterialsResult)
                                {
                                    if (item2.MaterialProperties == null || item2.MaterialProperties == "")
                                    {
                                        throw new SystemException("製令【" + item["WoErpPrefix"].ToString() + "-" + item["WoErpNo"] + "】<br>物料品號【" + item2.MtlItemNo + "】材料型態欄位錯誤!!");
                                    }

                                    #region //計算需領用量
                                    double DemandRequisitionQty = 0;
                                    double CompositionQuantity = item2.CompositionQuantity;
                                    double Base = item2.Base != 0 ? item2.Base : 0;
                                    int BomUomId = item2.InventoryUomId;
                                    if (BomUomId == 1)
                                    {
                                        DemandRequisitionQty = Convert.ToInt32(item["PlanQty"]) * CompositionQuantity / (Base * 1000);
                                    }
                                    else
                                    {
                                        DemandRequisitionQty = Convert.ToInt32(item["PlanQty"]) * CompositionQuantity / Base;
                                    }

                                    if (double.IsNaN(DemandRequisitionQty))
                                    {
                                        DemandRequisitionQty = 0;
                                    }
                                    #endregion

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.WoDetail (WoId, MtlItemId, InventoryId, UomId, CompositionQuantity, Base, LossRate, BomSequence
                                            , DemandRequisitionQty, RequisitionQty, Substitute, SubstituteStatus
                                            , SubstituteMtlItemId, MaterialProperties, ExpectedRequisitionDate, ActualRequisitionDate
                                            , WipDetailRemark, ConfirmStatus
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.WoDetailId
                                            VALUES (@WoId, @MtlItemId, @InventoryId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence
                                            , @DemandRequisitionQty, @RequisitionQty, @Substitute, @SubstituteStatus
                                            , @SubstituteMtlItemId, @MaterialProperties, @ExpectedRequisitionDate, @ActualRequisitionDate
                                            , @WipDetailRemark, @ConfirmStatus
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            WoId,
                                            item2.MtlItemId,
                                            item2.InventoryId,
                                            UomId = item2.InventoryUomId,
                                            item2.CompositionQuantity,
                                            item2.Base,
                                            item2.LossRate,
                                            item2.BomSequence,
                                            DemandRequisitionQty,
                                            RequisitionQty = 0,
                                            Substitute = "",
                                            SubstituteStatus = "N",
                                            SubstituteMtlItemId = item2.MtlItemId,
                                            item2.MaterialProperties,
                                            ExpectedRequisitionDate = item["ExpectedStart"].ToString(),
                                            ActualRequisitionDate = (DateTime?)null,
                                            WipDetailRemark = "",
                                            ConfirmStatus = "N",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    insertResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected += insertResult.Count();
                                }
                                #endregion

                                #endregion

                                #region //拋轉至ERP並核單

                                #region //取得工單單頭資料
                                string WoStatus = "";
                                string DocDate = "";
                                string CreateDateOre = "";
                                string ConfirmStatus = "";
                                string WoErpPrefix = "";
                                string WoErpNo = "";
                                string ActualStart = "";

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.WoId, a.CompanyId, a.WoErpPrefix TA001, a.WoErpNo TA002, a.Version TA062, FORMAT(a.CreateDate, 'yyyy-MM-dd hh:mm:ss') CreateDateOre, FORMAT(a.DocDate, 'yyyyMMdd') TA003
                                        , a.PlanQty TA015, a.RequisitionSetQty TA016, a.StockInQty TA017, a.ScrapQty TA018, a.MtlItemId
                                        , ISNULL(FORMAT(a.ExpectedStart, 'yyyyMMdd'), '') TA009, ISNULL(FORMAT(a.ExpectedEnd, 'yyyyMMdd'), '') TA010
                                        , FORMAT(a.ActualStart, 'yyyyMMdd') TA012, FORMAT(a.ActualEnd, 'yyyyMMdd') TA014
                                        , FORMAT(a.BomDate, 'yyyyMMdd') TA004, a.BomVersion TA005, a.UrgentMtl TA044, a.Property TA030
                                        , a.Project TA551, a.ProductionLine TA021, a.Processor TA032, a.CurrencyCode TA042, a.Exchange TA043
                                        , a.TaxCode TA070, a.TaxType TA056, a.TaxRate TA057, a.PricingTerm TA058, a.PaymentTerm TA059
                                        , a.WoRemark TA029
                                        , FORMAT(a.ConfirmDate, 'yyyyMMdd') TA040, a.WoStatus TA011 ,a.ConfirmStatus TA013, a.TransferStatus, a.TransferDate
                                        , b.MtlItemNo TA006, b.MtlItemName TA034, b.MtlItemSpec TA035
                                        , c.InventoryNo TA020
                                        , d.UomNo TA007
                                        , e.UserNo TA055
                                        , f.SoSequence TA028
                                        , g.SoErpPrefix TA026 ,g.SoErpNo TA027
                                        FROM MES.WipOrder a
                                        INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                        INNER JOIN SCM.Inventory c ON a.InventoryId = c.InventoryId
                                        INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                                        INNER JOIN BAS.[User] e ON a.UserId = e.UserId
                                        LEFT JOIN SCM.SoDetail f ON a.SoDetailId = f.SoDetailId
                                        LEFT JOIN SCM.SaleOrder g ON f.SoId = g.SoId
                                        WHERE a.WoId = @WoId
                                        ORDER BY a.WoId";
                                dynamicParameters.Add("WoId", WoId);
                                var result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("MES製令有問題");
                                foreach (var item2 in result)
                                {
                                    WoStatus = item2.TA011;
                                    WoErpPrefix = item2.TA001;
                                    WoErpNo = item2.TA002;
                                    DocDate = item2.TA003;
                                    CreateDateOre = item2.CreateDateOre;
                                    ActualStart = item2.TA012;
                                }

                                List<MOCTA> wipOrders = sqlConnection.Query<MOCTA>(sql, dynamicParameters).ToList();
                                #endregion

                                #region //取得工單單身資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.WoId,a.WoDetailId, a.DemandRequisitionQty TB004, a.RequisitionQty TB005, a.Substitute TB010
                                        ,a.WipDetailRemark TB017,a.ConfirmStatus TB018, a.MaterialProperties TB011
                                        , FORMAT(a.ExpectedRequisitionDate, 'yyyyMMdd') TB015
                                        , FORMAT(a.ActualRequisitionDate, 'yyyyMMdd') TB016
                                        , b.MtlItemNo TB003, b.MtlItemName TB012, b.MtlItemSpec TB013
                                        , c.MtlItemNo TB023
                                        , d.InventoryNo TB009, d.InventoryType
                                        , e.UomNo TB007
                                        , f.WoErpPrefix TB001,f.WoErpNo TB002
                                        , g.MtlItemNo TB014
                                        FROM MES.WoDetail a
                                        INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                        INNER JOIN PDM.MtlItem c on a.SubstituteMtlItemId = c.MtlItemId
                                        INNER JOIN SCM.Inventory d on a.InventoryId = d.InventoryId
                                        INNER JOIN PDM.UnitOfMeasure e on a.UomId = e.UomId
                                        INNER JOIN MES.WipOrder f on a.WoId = f.WoId
                                        INNER JOIN PDM.MtlItem g on f.MtlItemId = g.MtlItemId
                                        WHERE a.WoId = @WoId
                                        ORDER BY a.WoId";
                                dynamicParameters.Add("WoId", WoId);

                                List<MOCTB> woDetails = sqlConnection.Query<MOCTB>(sql, dynamicParameters).ToList();
                                #endregion

                                #region //撈取單據編號編碼格式設定
                                string WoType = "";
                                string encode = ""; // 編碼格式
                                int yearLength = 0; // 年碼數
                                int lineLength = 0; // 流水碼數
                                string Plant = "";
                                DateTime referenceTime = default(DateTime);
                                string docDate = wipOrders.Select(x => x.TA003).FirstOrDefault();
                                referenceTime = DateTime.ParseExact(docDate, "yyyyMMdd", CultureInfo.InvariantCulture);

                                #region //ERP廠別取得
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 MB001  
                                        FROM CMSMB";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                var resultPlant = sqlConnection2.Query(sql, dynamicParameters);
                                foreach (var item2 in resultPlant)
                                {
                                    Plant = item2.MB001;
                                }
                                #endregion

                                #region //撈取ERP單據設定
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MQ004, a.MQ005, a.MQ006, a.MQ044, a.MQ017
                                        FROM CMSMQ a
                                        WHERE MQ001 = @WoErpPrefix";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                                var resultReceiptNo = sqlConnection2.Query(sql, dynamicParameters);
                                foreach (var item2 in resultReceiptNo)
                                {
                                    encode = item2.MQ004; //編碼方式
                                    yearLength = Convert.ToInt32(item2.MQ005); //年碼數
                                    lineLength = Convert.ToInt32(item2.MQ006); //流水號碼數
                                    WoType = item2.MQ017;
                                }
                                #endregion

                                #region //單號自動取號
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TA002))), '" + new string('0', lineLength) + @"'), " + lineLength + @")) + 1 CurrentNum
                                        FROM MOCTA
                                        WHERE TA001 = @WoErpPrefix";
                                dynamicParameters.Add("WoErpPrefix", WoErpPrefix);

                                #region //編碼格式相關
                                string dateFormat = "";
                                switch (encode)
                                {
                                    case "1": //日編
                                        if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                        if ((lineLength + yearLength + 4) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                        dateFormat = new string('y', yearLength) + "MMdd";
                                        sql += @" AND RTRIM(LTRIM(TA002)) LIKE @ReferenceTime  + '" + new string('_', lineLength) + @"'";
                                        //sql += @" AND TA002 LIKE '%' + @ReferenceTime + '%' + '" + new string('_', lineLength) + @"'";
                                        dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));

                                        string tedstNo = referenceTime.ToString(dateFormat);
                                        WoErpNo = referenceTime.ToString(dateFormat);
                                        break;
                                    case "2": //月編
                                        if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                        if ((lineLength + yearLength + 2) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                        dateFormat = new string('y', yearLength) + "MM";
                                        sql += @" AND RTRIM(LTRIM(TA002))  LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                        dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                        WoErpNo = referenceTime.ToString(dateFormat);
                                        break;
                                    case "3": //流水號
                                        if (yearLength == 0) throw new SystemException("【ERP單據性質】年碼數必須等於0");
                                        if (lineLength <= 0 || lineLength > 11) throw new SystemException("【ERP單據性質】流水編碼碼數必須大於0小於等於11");
                                        break;
                                    case "4": //手動編號
                                        break;
                                    default:
                                        throw new SystemException("編碼方式錯誤!");
                                }

                                int currentNum = sqlConnection2.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                                WoErpNo += string.Format("{0:" + new string('0', lineLength) + "}", currentNum);
                                wipOrders[0].TA002 = WoErpNo;
                                #endregion

                                #region //判斷ERP工單單號是否重複
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MOCTA
                                        WHERE TA001 = @TA001
                                        AND TA002 = @TA002";
                                dynamicParameters.Add("TA001", WoErpPrefix);
                                dynamicParameters.Add("TA002", WoErpNo);

                                var MOCTAResult2 = sqlConnection2.Query(sql, dynamicParameters);
                                if (MOCTAResult2.Count() > 0) throw new SystemException("【工單單號】重複，請重新取號!");
                                #endregion

                                #endregion
                                #endregion

                                string USR_GROUP = BaseHelper.CheckErpAuthority(UserNo, sqlConnection2, "MOCI02", "CREATE");

                                #region //INSERT MOCTA
                                if (wipOrders.Count > 0)
                                {
                                    wipOrders
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.COMPANY = CompanyNo;
                                            x.USR_GROUP = USR_GROUP;
                                            x.CREATE_DATE = DateTime.Now.ToString("yyyyMMdd");
                                            x.MODI_DATE = DateTime.Now.ToString("yyyyMMdd");
                                            x.FLAG = "1";
                                            x.CREATE_TIME = DateTime.Now.ToString("HH:mm:ss");
                                            x.CREATE_AP = BaseHelper.ClientComputer();
                                            x.CREATE_PRID = "BM";
                                            x.MODI_TIME = DateTime.Now.ToString("HH:mm:ss");
                                            x.MODI_AP = "";
                                            x.MODI_PRID = "";
                                            x.TA008 = "";//預留欄位
                                            x.TA013 = "Y";//確認碼
                                            x.TA014 = "";//完工日
                                            x.TA019 = Plant;//廠別代號
                                            x.TA022 = 0;//加工單價
                                            x.TA023 = x.TA007;//加工單位
                                            x.TA024 = x.TA001;//母製令別
                                            x.TA025 = x.TA002;//母製令編號
                                            x.TA031 = 0;//列印次數
                                            x.TA033 = "";//計劃批號
                                            x.TA036 = "";//預計開工(代號)休假顯示0.不休假、1.全天、2.半天
                                            x.TA037 = "";//預計完工(代號)休假顯示0.不休假、1.全天、2.半天
                                            x.TA038 = "";//實際開工(代號)休假顯示0.不休假、1.全天、2.半天
                                            x.TA039 = "";//實際完工(代號)休假顯示0.不休假、1.全天、2.半天
                                            x.TA040 = DateTime.Now.ToString("yyyyMMdd");//確認日
                                            x.TA045 = 0;//預計產包裝量
                                            x.TA046 = 0;//已生產包裝量
                                            x.TA047 = 0;//報廢包裝數量
                                            x.TA048 = "";//包裝單位
                                            x.TA049 = "N";//簽核狀態碼
                                            x.TA050 = 0;//傳送次數
                                            x.TA051 = "";//客戶品號
                                            x.TA052 = "";//APS規劃製令號碼
                                            x.TA053 = 0;//產品序號數量
                                            x.TA054 = "2";//類型
                                            x.TA060 = "";//送貨地址(一)
                                            x.TA061 = "";//送貨地址(二)
                                            x.TA062 = "0000";//版次
                                            x.TA063 = "";//預計批號
                                            x.TA064 = 0.0;//預留欄位
                                            x.TA065 = 0.0;//預留欄位
                                            x.TA066 = "";//MES拋轉紀錄碼
                                            x.TA067 = "";//預留欄位
                                            x.TA068 = "";//預留欄位
                                            x.TA069 = 0.0;//原幣加工金額
                                            x.TA071 = "";//Marking代號
                                            x.TA072 = "";//計價方式
                                            x.TA073 = 0.0;//不良品單價
                                            x.TA074 = 0.0;//廢品單價
                                            x.TA075 = "";//製造廠商
                                            x.TA076 = 0.0;//計價單價
                                            x.TA077 = 0.0;//驗收單價
                                            x.TA078 = "";//進貨/託外進貨單別
                                            x.TA079 = "";//進貨/託外進貨單號
                                            x.TA080 = "";//進貨/託外進貨序號
                                            x.TA081 = "";//採購限制日期
                                            x.TA082 = "";//預留欄位
                                            x.TA083 = "";//預留欄位
                                            x.TA084 = "";//預留欄位
                                            x.TA085 = "";//預留欄位
                                            x.TA086 = "";//預留欄位
                                            x.TA087 = "";//預留欄位
                                            x.TA088 = "";//預留欄位
                                            x.TA089 = "";//預留欄位
                                            x.TA090 = "";//預留欄位
                                            x.TA091 = "";//預留欄位
                                            x.TA092 = "N";//製程否
                                            x.TA093 = "";//預留欄位
                                            x.TA094 = 0;//預留欄位
                                            x.TA095 = "";//優先順序
                                            x.TA096 = "";//預留欄位
                                            x.TA097 = "N";//單身多稅率
                                            x.TA500 = "";//不良品庫別
                                            x.TA501 = "";//MARKING
                                            x.TA502 = "";//BONDING
                                            x.TA503 = 0.0;//加工片數
                                            x.TA504 = 0.0;//已交片數
                                            x.TA505 = "";//加工項目代號
                                            x.TA506 = "";//晶片厚度
                                            x.TA507 = "";//晶片尺寸
                                            x.TA508 = "";//領料單單別
                                            x.TA509 = "";//領料單單號
                                            x.TA510 = "";//備註說明A
                                            x.TA511 = "";//備註說明B
                                            x.TA512 = "";//備註說明C
                                            x.TA513 = "";//備註說明D
                                            x.TA514 = 0.0;//需領用總數
                                            x.TA515 = 0.0;//需領用包裝總數
                                            x.TA516 = 0.0;//GROSS_DIE總數
                                            x.TA520 = "";//特性1
                                            x.TA521 = "";//特性2
                                            x.TA522 = "";//特性3
                                            x.TA523 = "";//特性4
                                            x.TA524 = "";//特性5
                                            x.TA525 = "";//特性6
                                            x.TA526 = "";//特性7
                                            x.TA527 = "";//特性8
                                            x.TA528 = "";//特性9
                                            x.TA530 = "";//下站加工項目
                                            x.TA531 = "";//下站加工廠商
                                            x.TA532 = "";//下站加工聯絡人
                                            x.TA533 = "";//下站加工電話
                                            x.TA534 = "";//送貨地址一
                                            x.TA535 = "";//送貨地址二
                                            x.TA550 = "";//性質 1:量產品 2:工程品
                                            x.TA552 = 0.0;//材料單價比率
                                            x.TA553 = "";//預留欄位
                                            x.TA554 = "";//自動扣料已轉撥
                                            x.TA555 = "";//轉撥單別
                                            x.TA556 = "";//轉撥單號
                                            x.UDF01 = "";
                                            x.UDF02 = "";
                                            x.UDF03 = "";
                                            x.UDF04 = "";
                                            x.UDF05 = "";
                                            x.UDF06 = 0.0;
                                            x.UDF07 = 0.0;
                                            x.UDF08 = 0.0;
                                            x.UDF09 = 0.0;
                                            x.UDF10 = 0.0;
                                        });

                                    sql = @"INSERT INTO MOCTA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                            CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TA001, TA002, TA003, TA004, TA005, TA006, TA007, 
                                            TA008, TA009, TA010, TA011, TA012, TA013, TA014, TA015, TA016, TA017, TA018, TA019, TA020, TA021, TA022, 
                                            TA023, TA024, TA025, TA026, TA027, TA028, TA029, TA030, TA031, TA032, TA033, TA034, TA035, TA036, TA037, 
                                            TA038, TA039, TA040, TA041, TA042, TA043, TA044, TA045, TA046, TA047, TA048, TA049, TA050, TA051, TA052, 
                                            TA053, TA054, TA055, TA056, TA057, TA058, TA059, TA060, TA061, TA062, TA063, TA064, TA065, TA066, TA067, 
                                            TA068, TA069, TA070, TA071, TA072, TA073, TA074, TA075, TA076, TA077, TA078, TA079, TA080, TA081, TA082, 
                                            TA083, TA084, TA085, TA086, TA087, TA088, TA089, TA090, TA091, TA092, TA093, TA094, TA095, TA096, TA500, 
                                            TA501, TA502, TA503, TA504, TA505, TA506, TA507, TA508, TA509, TA510, TA511, TA512, TA513, TA514, TA515, 
                                            TA516, TA520, TA521, TA522, TA523, TA524, TA525, TA526, TA527, TA528, TA530, TA531, TA532, TA533, TA534, 
                                            TA535, TA550, TA551, TA552, TA553, UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, 
                                            TA097, TA554, TA555, TA556)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
                                            @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TA001, @TA002, @TA003, @TA004, @TA005, @TA006, @TA007, 
                                            @TA008, @TA009, @TA010, @TA011, @TA012, @TA013, @TA014, @TA015, @TA016, @TA017, @TA018, @TA019, @TA020, @TA021, @TA022, 
                                            @TA023, @TA024, @TA025, @TA026, @TA027, @TA028, @TA029, @TA030, @TA031, @TA032, @TA033, @TA034, @TA035, @TA036, @TA037, 
                                            @TA038, @TA039, @TA040, @TA041, @TA042, @TA043, @TA044, @TA045, @TA046, @TA047, @TA048, @TA049, @TA050, @TA051, @TA052, 
                                            @TA053, @TA054, @TA055, @TA056, @TA057, @TA058, @TA059, @TA060, @TA061, @TA062, @TA063, @TA064, @TA065, @TA066, @TA067, 
                                            @TA068, @TA069, @TA070, @TA071, @TA072, @TA073, @TA074, @TA075, @TA076, @TA077, @TA078, @TA079, @TA080, @TA081, @TA082, 
                                            @TA083, @TA084, @TA085, @TA086, @TA087, @TA088, @TA089, @TA090, @TA091, @TA092, @TA093, @TA094, @TA095, @TA096, @TA500, 
                                            @TA501, @TA502, @TA503, @TA504, @TA505, @TA506, @TA507, @TA508, @TA509, @TA510, @TA511, @TA512, @TA513, @TA514, @TA515, 
                                            @TA516, @TA520, @TA521, @TA522, @TA523, @TA524, @TA525, @TA526, @TA527, @TA528, @TA530, @TA531, @TA532, @TA533, @TA534, 
                                            @TA535, @TA550, @TA551, @TA552, @TA553, @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10, 
                                            @TA097, @TA554, @TA555, @TA556)";
                                    rowsAffected += sqlConnection2.Execute(sql, wipOrders);
                                }
                                #endregion

                                #region //INSERT MOCTB
                                if (woDetails.Count > 0)
                                {
                                    woDetails
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.COMPANY = CompanyNo;
                                            x.USR_GROUP = USR_GROUP;
                                            x.CREATE_DATE = DateTime.Now.ToString("yyyyMMdd");
                                            x.MODI_DATE = DateTime.Now.ToString("yyyyMMdd");
                                            x.FLAG = "2";
                                            x.CREATE_TIME = DateTime.Now.ToString("HH:mm:ss");
                                            x.CREATE_AP = BaseHelper.ClientComputer();
                                            x.CREATE_PRID = "BM";
                                            x.MODI_TIME = DateTime.Now.ToString("HH:mm:ss");
                                            x.MODI_AP = BaseHelper.ClientComputer();
                                            x.MODI_PRID = "BM";
                                            x.TB001 = wipOrders[0].TA001;
                                            x.TB002 = wipOrders[0].TA002;
                                            x.TB006 = "****";//製程代號
                                            x.TB008 = ""; //預留欄位
                                            x.TB018 = "Y"; //確認碼
                                            x.TB019 = 0.0; //需領用包裝量
                                            x.TB020 = 0.0; //已領用包裝量
                                            x.TB021 = ""; //包裝單位
                                            x.TB022 = "2"; //類型
                                            x.TB024 = 0.0; //預留欄位
                                            x.TB025 = "****"; //被取替代製程
                                            x.TB026 = 0.0; //預留欄位
                                            x.TB027 = "1"; //來源碼
                                            x.TB028 = ""; //預留欄位
                                            x.TB029 = 0.0; //預留欄位
                                            x.TB030 = 0.0; //預留欄位
                                            x.TB031 = 0.0; //預留欄位
                                            x.TB032 = ""; //預留欄位
                                            x.TB033 = ""; //預留欄位
                                            x.TB034 = ""; //預留欄位
                                            x.TB035 = ""; //發料DATECODE
                                            x.TB036 = ""; //發料儲位
                                            x.TB037 = ""; //加工順序
                                            x.TB038 = 0.0; //營業稅率
                                            x.TB039 = ""; //稅別碼
                                            x.TB500 = ""; //DATECODE
                                            x.TB501 = 0.0; //GROSS_DIE
                                            x.TB502 = ""; //批號
                                            x.TB503 = ""; //領料單別
                                            x.TB504 = ""; //領料單號
                                            x.TB505 = ""; //領料序號
                                            x.TB550 = ""; //性質
                                            x.TB551 = ""; //入庫批號
                                            x.TB552 = ""; //專案代號
                                            x.TB553 = ""; //刻號/BIN記錄
                                            x.TB554 = ""; //刻號管理
                                            x.TB555 = ""; //預留欄位
                                            x.TB556 = ""; //預留欄位
                                            x.TB557 = ""; //預留欄位
                                            x.UDF01 = "";
                                            x.UDF02 = "";
                                            x.UDF03 = "";
                                            x.UDF04 = "";
                                            x.UDF05 = "";
                                            x.UDF06 = 0.0;
                                            x.UDF07 = 0.0;
                                            x.UDF08 = 0.0;
                                            x.UDF09 = 0.0;
                                            x.UDF10 = 0.0;
                                        });

                                    sql = @"INSERT INTO MOCTB(COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                            CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, TB001, TB002, TB003, TB004, TB005, TB006, 
                                            TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB014, TB015, TB016, TB017, TB018, TB019, TB020, TB021, 
                                            TB022, TB023, TB024, TB025, TB026, TB027, TB028, TB029, TB030, TB031, TB032, TB033, TB034, TB035, TB036, 
                                            TB037, TB500, TB501, TB502, TB503, TB504, TB505, TB550, TB551, TB552, TB553, TB554, UDF01, UDF02, UDF03, 
                                            UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, TB038, TB039, TB555, TB556, TB557)
                                            VALUES(@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
                                            @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, 
                                            @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014, @TB015, @TB016, @TB017, @TB018, @TB019, @TB020, @TB021, 
                                            @TB022, @TB023, @TB024, @TB025, @TB026, @TB027, @TB028, @TB029, @TB030, @TB031, @TB032, @TB033, @TB034, @TB035, @TB036, 
                                            @TB037, @TB500, @TB501, @TB502, @TB503, @TB504, @TB505, @TB550, @TB551, @TB552, @TB553, @TB554, @UDF01, @UDF02, @UDF03, 
                                            @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10, @TB038, @TB039, @TB555, @TB556, @TB557)";
                                    rowsAffected += sqlConnection2.Execute(sql, woDetails);
                                }
                                #endregion
                                #endregion

                                #region //回寫MES資料
                                #region //Update MES.WipOrder
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.WipOrder SET
                                        WoErpNo = @WoErpNo,
                                        Version = @Version,
                                        ConfirmStatus = @ConfirmStatus,
                                        ConfirmUserId = @ConfirmUserId,
                                        ConfirmDate = @ConfirmDate,
                                        TransferStatus = @TransferStatus,
                                        TransferDate = @TransferDate,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE WoId = @WoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        WoErpNo = wipOrders.Select(x => x.TA002).FirstOrDefault(),
                                        Version = "0000",
                                        ConfirmStatus = "Y",
                                        ConfirmUserId = CurrentUser,
                                        ConfirmDate = DateTime.Now.ToString("yyyy-MM-dd"),
                                        TransferStatus = "Y",
                                        TransferDate = LastModifiedDate,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        WoId
                                    });
                                insertResult = sqlConnection.Query(sql, dynamicParameters);
                                rowsAffected += insertResult.Count();
                                #endregion

                                #region //Update MES.WoDetail
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.WoDetail SET
                                        ConfirmStatus = @ConfirmStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE WoId = @WoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ConfirmStatus = "Y",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        WoId
                                    });
                                insertResult = sqlConnection.Query(sql, dynamicParameters);
                                rowsAffected += insertResult.Count();
                                #endregion
                                #endregion

                                #region //建立MES製令段
                                #region //INSERT MES.ManufactureOrder
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.ManufactureOrder (WoId, WoSeq, Quantity, InputQty, CompleteQty, ScrapQty, Status, ProjectNo,Remark
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MoId
                                        VALUES (@WoId, @WoSeq, @Quantity, @InputQty, @CompleteQty, @ScrapQty, @Status, @ProjectNo,@Remark
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        WoId,
                                        WoSeq = 1,
                                        Quantity = Convert.ToInt32(item["PlanQty"]),
                                        InputQty = 0,
                                        CompleteQty = 0,
                                        ScrapQty = 0,
                                        Status = "N",
                                        ProjectNo = "",
                                        Remark = item["Remark"].ToString(),
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = CurrentUser,
                                        LastModifiedBy = CurrentUser
                                    });

                                insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();

                                int MoId = 0;
                                foreach (var item2 in insertResult)
                                {
                                    MoId = Convert.ToInt32(item2.MoId);
                                    MoIdList.Add(MoId);
                                }
                                #endregion

                                #region //自動註冊途程
                                if (RoutingItemId <= 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.RoutingItemId, a.RoutingId, a.ControlId, a.MtlItemId, a.RoutingItemConfirm
                                            , b.ModeId, b.RoutingConfirm, b.Status, b.RoutingName
                                            , c.ModeName, c.OQcCheckType, c.BarcodeCtrl, c.Source, c.PVTQCFlag, c.NgToBarcode
                                            , c.TrayBarcode, c.LotStatus, c.OutputBarcodeFlag, c.MrType
                                            FROM MES.RoutingItem a
                                            INNER JOIN MES.Routing b ON a.RoutingId = b.RoutingId
                                            INNER JOIN MES.ProdMode c ON b.ModeId = c.ModeId
                                            WHERE a.MtlItemId = @MtlItemId
                                            AND a.RoutingItemConfirm = 'Y'
                                            AND b.RoutingConfirm = 'Y'
                                            ORDER BY a.CreateDate ";
                                    dynamicParameters.Add("MtlItemId", MtlItemId);

                                    var RoutingItemResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item2 in RoutingItemResult)
                                    {
                                        RoutingItemId = item2.RoutingItemId;
                                        ModeId = item2.ModeId;
                                        OQcCheckType = item2.OQcCheckType != null ? item2.OQcCheckType : "Y";
                                        ModeName = item2.ModeName;
                                        BarcodeCtrl = item2.BarcodeCtrl != null ? item2.BarcodeCtrl : "Y";
                                        Source = item2.Source != null ? item2.Source : "MR";
                                        PVTQCFlag = item2.PVTQCFlag != null ? item2.PVTQCFlag : "N";
                                        NgToBarcode = item2.NgToBarcode != null ? item2.NgToBarcode : "N";
                                        TrayBarcode = item2.TrayBarcode != null ? item2.TrayBarcode : "N";
                                        LotStatus = item2.LotStatus != null ? item2.LotStatus : "N";
                                        MrType = item2.MrType != null ? item2.MrType : "Y";
                                    }
                                }

                                if (RoutingItemId > 0)
                                {
                                    #region //INSERT MES.MoRouting
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.MoRouting (MoId, RoutingItemId, SortNumber
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.MoRoutingId
                                            VALUES (@MoId, @RoutingItemId, @SortNumber
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MoId,
                                            RoutingItemId,
                                            SortNumber = 1,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();

                                    int MoRoutingId = 0;
                                    foreach (var item2 in insertResult)
                                    {
                                        MoRoutingId = item2.MoRoutingId;
                                    }
                                    #endregion

                                    #region //新增資料至MES.MoProcess
                                    #region //取得途程製程資訊
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT b.RoutingProcessId, b.ProcessId, b.SortNumber, b.ProcessAlias, b.NecessityStatus, b.ProcessCheckStatus, b.ProcessCheckType, b.PackageFlag
                                            , b.DisplayStatus
                                            , c.ItemProcessId, c.RoutingItemProcessDesc,c.Remark
                                            , d.ProcessName, d.ProcessName
                                            FROM MES.RoutingItem a
                                            INNER JOIN MES.RoutingProcess b ON a.RoutingId = b.RoutingId
                                            LEFT JOIN MES.RoutingItemProcess c ON a.RoutingItemId = c.RoutingItemId AND c.RoutingProcessId = b.RoutingProcessId
                                            INNER JOIN MES.Process d ON d.ProcessId = b.ProcessId
                                            WHERE a.RoutingItemId = @RoutingItemId
                                            ORDER BY b.SortNumber";
                                    dynamicParameters.Add("RoutingItemId", RoutingItemId);

                                    var RoutingItemResult2 = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion

                                    #region //INSERT MES.MoProcess
                                    int count = 1;
                                    string finalProcessName = "";
                                    foreach (var item2 in RoutingItemResult2)
                                    {
                                        if (count == RoutingItemResult2.Count())
                                        {
                                            finalProcessName = item2.ProcessName;
                                        }
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.MoProcess (MoId, MoRoutingId, RoutingProcessId, ProcessId, SortNumber, ProcessAlias, RoutingItemProcessDesc, Remark, DisplayStatus, NecessityStatus, OspFlag, ProcessCheckStatus, ProcessCheckType, PackageFlag
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.MoProcessId
                                                VALUES (@MoId, @MoRoutingId, @RoutingProcessId, @ProcessId, @SortNumber, @ProcessAlias, @RoutingItemProcessDesc, @Remark, @DisplayStatus, @NecessityStatus, @OspFlag, @ProcessCheckStatus, @ProcessCheckType, @PackageFlag
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MoId,
                                                MoRoutingId,
                                                item2.RoutingProcessId,
                                                item2.ProcessId,
                                                SortNumber = Convert.ToInt32(item2.SortNumber),
                                                item2.ProcessAlias,
                                                item2.RoutingItemProcessDesc,
                                                item2.Remark,
                                                item2.DisplayStatus,
                                                item2.NecessityStatus,
                                                OspFlag = "N",
                                                item2.ProcessCheckStatus,
                                                item2.ProcessCheckType,
                                                item2.PackageFlag,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });

                                        insertResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();
                                        count++;

                                        int MoProcessId = -1;
                                        foreach (var item3 in insertResult)
                                        {
                                            MoProcessId = item3.MoProcessId;
                                        }

                                        #region //新增資料至MES.MoProcessItem

                                        #region //取得RoutingProcessItem資料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.ItemNo, a.ChkUnique
                                                FROM MES.RoutingProcessItem a
                                                WHERE a.RoutingProcessId = @RoutingProcessId";
                                        dynamicParameters.Add("RoutingProcessId", item2.RoutingProcessId);

                                        var routingProcessItemResult = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion

                                        if (routingProcessItemResult.Count() <= 0)
                                        {
                                            #region //檢查是否為刻字站，若為刻字站則自動帶入刻字屬性
                                            if (item2.ProcessName == "刻字")
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO MES.MoProcessItem (MoProcessId, ItemNo, ChkUnique
                                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                        OUTPUT INSERTED.MoProcessId
                                                        VALUES (@MoProcessId, @ItemNo, @ChkUnique
                                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        MoProcessId,
                                                        ItemNo = "Lettering",
                                                        ChkUnique = "Y",
                                                        CreateDate,
                                                        LastModifiedDate,
                                                        CreateBy,
                                                        LastModifiedBy
                                                    });

                                                insertResult = sqlConnection.Query(sql, dynamicParameters);

                                                rowsAffected += insertResult.Count();
                                            }
                                            #endregion
                                        }
                                        else
                                        {
                                            foreach (var item3 in routingProcessItemResult)
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO MES.MoProcessItem (MoProcessId, ItemNo, ChkUnique
                                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                        OUTPUT INSERTED.MoProcessId
                                                        VALUES (@MoProcessId, @ItemNo, @ChkUnique
                                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        MoProcessId,
                                                        item3.ItemNo,
                                                        item3.ChkUnique,
                                                        CreateDate,
                                                        LastModifiedDate,
                                                        CreateBy,
                                                        LastModifiedBy
                                                    });

                                                insertResult = sqlConnection.Query(sql, dynamicParameters);

                                                rowsAffected += insertResult.Count();
                                            }
                                        }
                                        #endregion

                                        #region //確認途程是否有設定量測項目
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.RoutingItemQcItemId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance, a.Remark
                                                FROM MES.RoutingItemQcItem a 
                                                INNER JOIN MES.RoutingItemProcess b ON a.ItemProcessId = b.ItemProcessId
                                                WHERE a.RoutingItemId = @RoutingItemId
                                                AND b.RoutingProcessId = @RoutingProcessId";
                                        dynamicParameters.Add("RoutingItemId", RoutingItemId);
                                        dynamicParameters.Add("RoutingProcessId", item2.RoutingProcessId);

                                        var RoutingItemQcItemResult = sqlConnection.Query(sql, dynamicParameters);

                                        foreach (var item3 in RoutingItemQcItemResult)
                                        {
                                            #region //Insert MES.MoProcessQcItem
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.MoProcessQcItem (MoProcessId, QcItemId, QcItemDesc, DesignValue, UpperTolerance, LowerTolerance, Remark
                                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                    VALUES (@MoProcessId, @QcItemId, @QcItemDesc, @DesignValue, @UpperTolerance, @LowerTolerance, @Remark
                                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MoProcessId,
                                                    item3.QcItemId,
                                                    item3.QcItemDesc,
                                                    item3.DesignValue,
                                                    item3.UpperTolerance,
                                                    item3.LowerTolerance,
                                                    item3.Remark,
                                                    CreateDate,
                                                    LastModifiedDate,
                                                    CreateBy,
                                                    LastModifiedBy
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                        #endregion
                                    }
                                    #endregion
                                    #endregion

                                    #region //UPDATE MES.ManufactureOrder ModeId
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.ManufactureOrder SET
                                            ModeId = @ModeId,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE MoId = @MoId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            ModeId,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            MoId
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //依據生產別自動建立量測單據
                                    if (OQcCheckType == "N")
                                    {
                                        #region //取得預設SpreadsheetData
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 a.DefaultSpreadsheetData
                                                FROM MES.QcRecord a";

                                        var DefaultFileIdResult = sqlConnection.Query(sql, dynamicParameters);

                                        string DefaultSpreadsheetData = "";
                                        foreach (var item2 in DefaultFileIdResult)
                                        {
                                            DefaultSpreadsheetData = item2.DefaultSpreadsheetData;
                                        }
                                        #endregion

                                        #region //取得此生產模式下OQC資料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.QcTypeId
                                                FROM QMS.QcType a 
                                                WHERE a.ModeId = @ModeId
                                                AND a.QcTypeNo = 'OQC'";
                                        dynamicParameters.Add("ModeId", ModeId);

                                        var QcTypeResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (QcTypeResult.Count() <= 0) throw new SystemException("生產模式【" + ModeName + "】尚未設定量測類型，請通知系統開發室!!");

                                        int QcTypeId = -1;
                                        foreach (var item2 in QcTypeResult)
                                        {
                                            QcTypeId = item2.QcTypeId;
                                        }
                                        #endregion

                                        #region //INSERT MES.QcRecord
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.QcRecord (QcTypeId, InputType, MoId, MoProcessId, Remark, DefaultFileId, CurrentFileId, DefaultSpreadsheetData, CheckQcMeasureData
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.QcRecordId
                                                VALUES (@QcTypeId, @InputType, @MoId, @MoProcessId, @Remark, @DefaultFileId, @CurrentFileId, @DefaultSpreadsheetData, @CheckQcMeasureData
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                QcTypeId,
                                                InputType = "Lettering",
                                                MoId,
                                                MoProcessId = (int?)null,
                                                Remark = "",
                                                DefaultFileId = -1,
                                                CurrentFileId = -1,
                                                DefaultSpreadsheetData,
                                                CheckQcMeasureData = "N",
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });

                                        insertResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();
                                        #endregion
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //新增MES製令設定
                                #region //取得Barcode前置碼
                                string BarcodePrefix = "";
                                if (MtlItemName.IndexOf(" ") > 0)
                                {
                                    BarcodePrefix = MtlItemName.Split(' ')[1];
                                }

                                if (BarcodePrefix.Length <= 0) BarcodePrefix = "SYSTEMAUTO";
                                #endregion

                                #region //取得機種最大滿盤數
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BatchCount TrayCount 
                                        FROM MES.ItemTrayCount a 
                                        INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                        INNER JOIN MES.WipOrder c ON b.MtlItemId = c.MtlItemId
                                        WHERE c.WoId = @WoId";
                                dynamicParameters.Add("WoId", WoId);

                                var ItemTrayCountResult = sqlConnection.Query(sql, dynamicParameters);

                                int LotQty = 1;
                                foreach (var item2 in ItemTrayCountResult)
                                {
                                    LotQty = item2.TrayCount;
                                }
                                #endregion

                                #region //INSERT MES.MoSetting
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MoSetting (MoId, LotStatus, LotQty, MtlControl, OutputBarcodeFlag, Source, PVTQCFlag, OQcCheckType
                                        , BarcodePrefix, SequenceLen, BarcodePostfix
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MoSettingId
                                        VALUES (@MoId, @LotStatus, @LotQty, @MtlControl, @OutputBarcodeFlag, @Source, @PVTQCFlag, @OQcCheckType
                                        , @BarcodePrefix, @SequenceLen, @BarcodePostfix
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MoId,
                                        LotStatus,
                                        LotQty,
                                        MtlControl = "Y",
                                        OutputBarcodeFlag = "N",
                                        Source,
                                        PVTQCFlag,
                                        OQcCheckType,
                                        BarcodePrefix,
                                        SequenceLen = 4,
                                        BarcodePostfix = "-" + MoId.ToString(),
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = CurrentUser,
                                        LastModifiedBy = CurrentUser
                                    });

                                insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                #endregion
                                #endregion

                                #region //新增製令用料設定檔
                                #region //查詢此ERP工單下所需物料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.WoDetailId, a.UomId, a.CompositionQuantity, a.Base, a.LossRate, a.BomSequence
                                        , d.ComponentType
                                        FROM MES.WoDetail a 
                                        INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                        LEFT JOIN PDM.BillOfMaterials c ON b.MtlItemId = c.MtlItemId
                                        LEFT JOIN PDM.BomDetail d ON c.BomId = d.BomId AND d.MtlItemId = a.MtlItemId
                                        WHERE a.WoId = @WoId";
                                dynamicParameters.Add("WoId", WoId);

                                var WoDetailResult = sqlConnection.Query(sql, dynamicParameters);
                                #endregion

                                foreach (var item2 in WoDetailResult)
                                {
                                    string bindType = item2.ComponentType != "" && item2.ComponentType != null ? item2.ComponentType : "N";
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.MoMtlSetting (MoId, WoDetailId, UomId, CompositionQuantity, Base, LossRate, BomSequence, ProcessBinding, BarcodeCtrl, MainBarcode, ControlType, BindType
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.MoMtlSettingId
                                            VALUES (@MoId, @WoDetailId, @UomId, @CompositionQuantity, @Base, @LossRate, @BomSequence, @ProcessBinding, @BarcodeCtrl, @MainBarcode, @ControlType, @BindType
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MoId,
                                            item2.WoDetailId,
                                            item2.UomId,
                                            CompositionQuantity = item2.CompositionQuantity > 0 ? (double?)item2.CompositionQuantity : null,
                                            Base = item2.Base > 0 ? (double?)item2.Base : null,
                                            item2.LossRate,
                                            item2.BomSequence,
                                            ProcessBinding = bindType != "N" ? "Y" : "N",
                                            BarcodeCtrl = "Y",
                                            MainBarcode = "Y",
                                            ControlType = "2",
                                            BindType = bindType,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = CurrentUser,
                                            LastModifiedBy = CurrentUser
                                        });

                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                }
                                #endregion
                                #endregion
                            }

                            if (TotalErrorMessages.Count > 0)
                            {
                                string errorMessages = "";
                                foreach (var msg in TotalErrorMessages)
                                {
                                    errorMessages += msg;
                                }
                                throw new SystemException(errorMessages);
                            }

                            #region //取得目前製令資料
                            IEnumerable<dynamic> ManufactureOrderResult = null;
                            if (MoIdList.Count > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoId, a.Remark
                                        , b.WoErpPrefix, b.WoErpNo, FORMAT(b.DocDate, 'yyyy-MM-dd') DocDate
                                        , b.PlanQty, b.InventoryId
                                        , FORMAT(b.ExpectedStart, 'yyyy-MM-dd') ExpectedStart
                                        , FORMAT(b.ExpectedEnd, 'yyyy-MM-dd') ExpectedEnd
                                        , c.MtlItemId, c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                                        , d.InventoryNo
                                        , f.SoErpPrefix + '-' + f.SoErpNo + '(' + e.SoSequence + ')' SoErpFullNo
                                        , ISNULL(h.RoutingItemId, 0) RoutingItemId
                                        , ISNULL(i.RoutingName, '') RoutingName
                                        , j.BarcodeCtrl, j.Source, j.TrayBarcode, j.LotStatus, j.LotQty
                                        FROM MES.ManufactureOrder a 
                                        INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                        INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                        INNER JOIN SCM.Inventory d ON b.InventoryId = d.InventoryId
                                        LEFT JOIN SCM.SoDetail e ON b.SoDetailId = e.SoDetailId
                                        LEFT JOIN SCM.SaleOrder f ON e.SoId = f.SoId
                                        LEFT JOIN MES.MoRouting g ON a.MoId = g.MoId
                                        LEFT JOIN MES.RoutingItem h ON g.RoutingItemId = h.RoutingItemId
                                        LEFT JOIN MES.Routing i ON h.RoutingId = i.RoutingId
                                        INNER JOIN MES.MoSetting j ON a.MoId = j.MoId
                                        WHERE a.MoId IN (" + string.Join(",", MoIdList) + ")";

                                ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);
                            }
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)",
                                data = ManufactureOrderResult
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetErpInventoryQty -- 取得ERP庫存資料 -- Ann 2024-09-05
        public string GetErpInventoryQty(string MtlItemNo, string InventoryNo)
        {
            if (MtlItemNo.Length <= 0) throw new SystemException("品號不能為空!!");
            //if (InventoryId <= 0 && InventoryNo.Length <= 0) throw new SystemException("庫別不能為空!!");

            try
            {
                List<INVMC> iNVMCs = new List<INVMC>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //取得此品號底下的BOM
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT d.MtlItemNo 
                                FROM PDM.BomDetail a 
                                INNER JOIN PDM.BillOfMaterials b ON a.BomId = b.BomId
                                INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                INNER JOIN PDM.MtlItem d ON a.MtlItemId = d.MtlItemId
                                WHERE c.MtlItemNo = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);

                        var BomDetailResult = sqlConnection.Query(sql, dynamicParameters);

                        List<string> bomMtlItemNo = new List<string>();
                        foreach (var item in BomDetailResult)
                        {
                            bomMtlItemNo.Add(item.MtlItemNo);
                        }
                        #endregion

                        foreach (var item in bomMtlItemNo)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MC001, a.MC002, LTRIM(RTRIM(a.MC001)) MtlItemNo
                                    , LTRIM(RTRIM(a.MC002)) InventoryNo, LTRIM(RTRIM(a.MC003)) InventorySite
                                    , LTRIM(RTRIM(a.MC007)) InventoryQty
                                    FROM INVMC a
                                    WHERE 1=1";
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MC001 = @MtlItemNo", item);
                           
                            sql += " ORDER BY a.MC001";

                            var ErpResult = sqlConnection2.Query<INVMC>(sql, dynamicParameters);

                            iNVMCs.AddRange(ErpResult);
                        }

                        #region //回MES查資料
                        int i = 0;
                        foreach (var item in iNVMCs)
                        {
                            #region //查庫別資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.InventoryId, a.InventoryName
                                    FROM SCM.Inventory a
                                    WHERE a.InventoryNo = @InventoryNo
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.Add("InventoryNo", item.InventoryNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            var inventoryResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in inventoryResult)
                            {
                                iNVMCs[i].InventoryId = item2.InventoryId;
                                iNVMCs[i].InventoryName = item2.InventoryName;
                            }
                            #endregion

                            #region //查品號資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemName
                                    FROM PDM.MtlItem a
                                    WHERE a.MtlItemNo = @MtlItemNo
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            var mtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in mtlItemResult)
                            {
                                iNVMCs[i].MtlItemName = item2.MtlItemName;
                            }
                            #endregion
                            i++;
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = iNVMCs
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSingleErpInventoryQty -- 取得ERP庫存資料 -- Ann 2024-09-05
        public string GetSingleErpInventoryQty(string MtlItemNo, string InventoryNo)
        {
            if (MtlItemNo.Length <= 0) throw new SystemException("品號不能為空!!");
            if (InventoryNo.Length <= 0) throw new SystemException("庫別不能為空!!");

            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MC001, a.MC002, LTRIM(RTRIM(a.MC001)) MtlItemNo
                                , LTRIM(RTRIM(a.MC002)) InventoryNo, LTRIM(RTRIM(a.MC003)) InventorySite
                                , LTRIM(RTRIM(a.MC007)) InventoryQty
                                FROM INVMC a
                                WHERE 1=1";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MC001 = @MtlItemNo", MtlItemNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "InventoryNo", @" AND a.MC002 = @InventoryNo", InventoryNo);

                        sql += " ORDER BY a.MC001";

                        var ErpResult = sqlConnection2.Query<INVMC>(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = ErpResult
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //PC平台測試
        #region //ExpandStructureForPC -- 品號展開下階BOM物料(PC平台測試) -- Ann 2024-12-02
        public string ExpandStructureForPC(string MtlItemNo, string CompanyNo)
        {
            try
            {
                if (MtlItemNo.Length <= 0) throw new SystemException("品號資料不能為空!!");
                
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyNo = @CompanyNo";
                    dynamicParameters.Add("CompanyNo", CompanyNo);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"WITH RecursiveCTE AS (
                                    SELECT a.MD006 CompositionQuantity, a.MD007 Base, a.MD008 LossRate
                                    , LTRIM(RTRIM(c.MB001)) ParentMtlItemNo, LTRIM(RTRIM(c.MB002)) ParentMtlItemName
                                    , LTRIM(RTRIM(d.MB001)) MtlItemNo, LTRIM(RTRIM(d.MB002)) MtlItemName, LTRIM(RTRIM(d.MB003)) MtlItemSpec
                                    , LTRIM(RTRIM(d.MB025)) ItemAttribute, LTRIM(RTRIM(d.MB017)) InventoryNo, LTRIM(RTRIM(d.MB004)) UomNo
                                    , CASE 
                                        WHEN LTRIM(RTRIM(d.MB025)) = 'P' THEN '採購件'
                                        WHEN LTRIM(RTRIM(d.MB025)) = 'M' THEN '自製件'
                                        ELSE LTRIM(RTRIM(d.MB025))
                                      END AS ItemAttributeName
                                    FROM BOMMD a 
                                    INNER JOIN BOMMC b ON b.MC001 = a.MD001
                                    INNER JOIN INVMB c ON c.MB001 = b.MC001
                                    INNER JOIN INVMB d ON d.MB001 = a.MD003
                                    WHERE c.MB001 = @MtlItemNo
                                    AND GETDATE() >= ISNULL(CONVERT(DATETIME, NULLIF(LTRIM(RTRIM(d.MB030)), ''), 120), GETDATE())
                                    AND GETDATE() <= ISNULL(CONVERT(DATETIME, NULLIF(LTRIM(RTRIM(d.MB031)), ''), 120), GETDATE())
                                    UNION ALL
                                    SELECT x.MD006 CompositionQuantity, x.MD007 Base, x.MD008 LossRate
                                    , LTRIM(RTRIM(xc.MB001)) ParentMtlItemNo, LTRIM(RTRIM(xc.MB002)) ParentMtlItemName
                                    , LTRIM(RTRIM(xd.MB001)) MtlItemNo, LTRIM(RTRIM(xd.MB002)) MtlItemName, LTRIM(RTRIM(xd.MB003)) MtlItemSpec
                                    , LTRIM(RTRIM(xd.MB025)) ItemAttribute, LTRIM(RTRIM(xd.MB017)) InventoryNo, LTRIM(RTRIM(xd.MB004)) UomNo
                                    , CASE 
                                        WHEN LTRIM(RTRIM(xd.MB025)) = 'P' THEN '採購件'
                                        WHEN LTRIM(RTRIM(xd.MB025)) = 'M' THEN '自製件'
                                        ELSE LTRIM(RTRIM(xd.MB025))
                                      END AS ItemAttributeName
                                    FROM BOMMD x
                                    INNER JOIN BOMMC xb ON xb.MC001 = x.MD001
                                    INNER JOIN RecursiveCTE xa ON xb.MC001 = xa.MtlItemNo
                                    INNER JOIN INVMB xc ON xc.MB001 = xb.MC001
                                    INNER JOIN INVMB xd ON xd.MB001 = x.MD003
                                    WHERE GETDATE() >= ISNULL(CONVERT(DATETIME, NULLIF(LTRIM(RTRIM(xd.MB030)), ''), 120), GETDATE())
                                    AND GETDATE() <= ISNULL(CONVERT(DATETIME, NULLIF(LTRIM(RTRIM(xd.MB031)), ''), 120), GETDATE())
                                )
                                SELECT CompositionQuantity, Base, LossRate
                                , ParentMtlItemNo, ParentMtlItemName
                                , MtlItemNo, MtlItemName, MtlItemSpec
                                , ItemAttribute, InventoryNo, UomNo
                                , ItemAttributeName
                                , 2 AS SortOrder
                                FROM RecursiveCTE
                                UNION ALL
                                SELECT 1 CompositionQuantity, 1 Base, 0 LossRate
                                , NULL ParentMtlItemNo, NULL ParentMtlItemName
                                , LTRIM(RTRIM(x.MB001)) MtlItemNo, LTRIM(RTRIM(x.MB002)) MtlItemName, LTRIM(RTRIM(x.MB003)) MtlItemSpec
                                , LTRIM(RTRIM(x.MB025)) ItemAttribute, LTRIM(RTRIM(x.MB017)) InventoryNo, LTRIM(RTRIM(x.MB004)) UomNo
                                , CASE 
                                    WHEN LTRIM(RTRIM(x.MB025)) = 'P' THEN '採購件'
                                    WHEN LTRIM(RTRIM(x.MB025)) = 'M' THEN '自製件'
                                    ELSE LTRIM(RTRIM(x.MB025))
                                  END AS ItemAttributeName
                                , 1 AS SortOrder
                                FROM INVMB x 
                                WHERE x.MB001 = @MtlItemNo
                                AND GETDATE() >= ISNULL(CONVERT(DATETIME, NULLIF(LTRIM(RTRIM(x.MB030)), ''), 120), GETDATE())
                                AND GETDATE() <= ISNULL(CONVERT(DATETIME, NULLIF(LTRIM(RTRIM(x.MB031)), ''), 120), GETDATE())
                                ORDER BY SortOrder, ItemAttribute";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //BPM
        #region //TransferOspToBpm -- 拋轉托外生產單至BPM -- Ann 2025-04-10
        public string TransferOspToBpm(string OspIds, string CompanyNo, SqlConnection sqlConnection, SqlConnection sqlConnection2)
        {
            try
            {
                string token = "";
                int rowsAffected = 0;

                string[] OspIdArray = OspIds.Split(',');
                foreach (var OspId in OspIdArray)
                {
                    #region //判斷委外單資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.OspId, a.CompanyId, a.DepartmentId, a.OspNo, FORMAT(a.OspDate, 'yyyy-MM-dd') OspDate
                            , a.SupplierId, a.OspStatus, a.OspDesc, a.[Status]
                            , b.DepartmentNo, b.DepartmentName
                            , ISNULL(c.SupplierNo, '') SupplierNo, ISNULL(c.SupplierShortName, '') SupplierShortName
                            FROM MES.OutsourcingProduction a 
                            INNER JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                            LEFT JOIN SCM.Supplier c ON a.SupplierId = c.SupplierId
                            WHERE a.OspId = @OspId";
                    dynamicParameters.Add("OspId", OspId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("委外單【" + OspId + "】資料錯誤!");

                    string OspNo = "";
                    string DepartmentNo = "";
                    string OspDesc = "";
                    string OspStatus = "";
                    string OspDate = "";
                    string DepartmentName = "";
                    string SupplierNo = "";
                    string SupplierName = "";
                    foreach (var item in result)
                    {
                        if (item.Status != "N" && item.Status != "E") throw new SystemException("委外單狀態無法拋轉!");
                        OspNo = item.OspNo;
                        DepartmentNo = item.DepartmentNo;
                        OspDesc = item.OspDesc;
                        OspStatus = item.OspStatus == "Y" ? "供料" : "不供料";
                        OspDate = item.OspDate;
                        DepartmentName = item.DepartmentName;
                        SupplierNo = item.SupplierNo;
                        SupplierName = item.SupplierShortName;
                    }
                    #endregion

                    #region //取得BPM TOKEN
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.IpAddress, a.CompanyId, a.Token, FORMAT(a.VerifyDate, 'yyyy-MM-dd HH:mm:ss') VerifyDate
                            FROM BPM.SystemToken a
                            WHERE IpAddress = @IpAddress
                            AND CompanyId = @CompanyId";
                    dynamicParameters.Add("IpAddress", BpmServerPath);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var systemTokenResult = sqlConnection.Query(sql, dynamicParameters);
                    if (systemTokenResult.Count() <= 0) throw new SystemException("查無此憑證!");

                    foreach (var item in systemTokenResult)
                    {
                        DateTime verifyDate = Convert.ToDateTime(item.VerifyDate);
                        DateTime nowDate = DateTime.Now;
                        var CheckMin = (nowDate - verifyDate).TotalMinutes;
                        if (CheckMin >= 30)
                        {
                            #region //取得新BPM TOKEN
                            string tokenResponse = BpmHelper.GetBpmToken(BpmServerPath, BpmAccount, BpmPassword);
                            var tokenJson = JObject.Parse(tokenResponse);
                            foreach (var item2 in tokenJson)
                            {
                                if (item2.Key == "status")
                                {
                                    if (item2.Value.ToString() != "success") throw new SystemException("取得token失敗!");
                                }
                                else if (item2.Key == "data")
                                {
                                    token = item2.Value.ToString();
                                }
                            }
                            #endregion

                            #region //將新的TOKEN更新回MES
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE BPM.SystemToken SET
                                    Token = @Token,
                                    VerifyDate = @VerifyDate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE IpAddress = @IpAddress
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    Token = token,
                                    VerifyDate = nowDate,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    IpAddress = BpmServerPath,
                                    CompanyId = CurrentCompany
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        else
                        {
                            token = item.Token;
                        }
                    }
                    #endregion

                    #region //取得BpmUser資料
                    string BpmUserId = "";
                    string BpmRoleId = "";
                    string BpmUserNo = "";
                    string UserName = "";
                    string BpmDepNo = "";
                    string BpmDepName = "";
                    using (SqlConnection sqlConnection3 = new SqlConnection(BpmDbConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"WITH BasicUserInfo(MemID, LoginID, UserName, MainRoleID, RolID, RolName, ParentRol) AS(
                                SELECT a.MemID, a.LoginID, a.UserName, a.MainRoleID
                                , b.RolID, b.Name, b.DepID AS ParentRol
                                FROM Mem_GenInf a
                                LEFT JOIN Rol_GenInf b ON b.RolID = a.MainRoleID
                                WHERE a.LoginID = @LoginID
                                UNION ALL
                                SELECT a.MemID, a.LoginID, a.UserName, a.MainRoleID
                                , b.RolID, b.Name, b.DepID AS ParentRol
                                FROM BasicUserInfo a, Rol_GenInf b
                                WHERE a.ParentRol = b.RolID
                                )
                                SELECT a.MemID, a.LoginID, a.UserName, a.MainRoleID
                                , b.Name AS RolName
                                , c.DepID, c.ID AS DepNo, c.Name AS DepName
                                FROM BasicUserInfo a
                                LEFT JOIN Rol_GenInf AS parentRol_GenInf ON a.RolID = parentRol_GenInf.RolID
                                LEFT JOIN Dep_GenInf c ON parentRol_GenInf.DepID = c.DepID
                                , Rol_GenInf b
                                WHERE a.MainRoleID = b.RolID
                                AND c.DepID IS NOT NULL
                                UNION
                                SELECT a.MemID, a.LoginID, a.UserName, a.MainRoleID
                                , b.Name AS RolName
                                , c.ComID AS DepID, c.ID AS DepNo, c.Name AS DepName
                                FROM Mem_GenInf a
                                LEFT JOIN Rol_GenInf b ON a.MainRoleID = b.RolID
                                LEFT JOIN Company c ON b.DepID = c.ComID
                                WHERE c.ComID IS NOT NULL
                                AND a.LoginID = @LoginID
                                ORDER BY a.LoginID";
                        dynamicParameters.Add("LoginID", UserNo);

                        var MemGenInfResult = sqlConnection3.Query(sql, dynamicParameters);

                        if (MemGenInfResult.Count() <= 0) throw new SystemException("取得BPM使用者資訊時發生錯誤!!");

                        foreach (var item in MemGenInfResult)
                        {
                            BpmUserId = item.MemID;
                            BpmRoleId = item.MainRoleID;
                            BpmUserNo = item.LoginID;
                            UserName = item.UserName;
                            BpmDepNo = item.DepNo;
                            BpmDepName = item.DepName;
                        }
                    }
                    #endregion

                    #region //取得單身資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.OspDetailId, a.OspId, a.MoId, a.MoProcessId, a.ProcessCheckStatus, a.ProcessCheckType, a.OspQty, a.SuppliedQty
                            , ISNULL(a.ProcessCode, '') ProcessCode, ISNULL(a.ProcessCodeName, '') ProcessCodeName
                            , FORMAT(a.ExpectedDate, 'yyyy-MM-dd') ExpectedDate, a.Remark
                            , b.ProcessAlias
                            , c.WoSeq
                            , d.WoErpPrefix, d.WoErpNo
                            , e.MtlItemId, e.MtlItemNo, e.MtlItemName, e.MtlItemSpec
                            FROM MES.OspDetail a 
                            INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                            INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                            INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                            INNER JOIN PDM.MtlItem e ON d.MtlItemId = e.MtlItemId
                            WHERE a.OspId = @OspId 
                            ORDER BY OspDetailId";
                    dynamicParameters.Add("OspId", OspId);

                    var ospDetailResult = sqlConnection.Query(sql, dynamicParameters);
                    if (ospDetailResult.Count() <= 0) throw new SystemException("委外單【" + OspId + "】單身資料錯誤!");
                    #endregion

                    #region //組單身資料
                    JArray tabPR_Line_Data = new JArray();

                    int count = 1;
                    foreach (var item in ospDetailResult)
                    {
                        string woErpFullNo = item.WoErpPrefix + item.WoErpNo + "(" + item.WoSeq.ToString() + ")";
                        string processCheckStatus = item.ProcessCheckStatus == "Y" ? "是" : "否";
                        string processCheckType = item.ProcessCheckType == "1" ? "全檢" : "抽檢";

                        tabPR_Line_Data.Add(JObject.FromObject(new
                        {
                            PRNumber_SN = count.ToString("D4"),
                            ItemNo = item.MtlItemNo.ToString(),
                            ItemName = item.MtlItemName.ToString(),
                            Spec = item.MtlItemSpec.ToString(),
                            WoErpFullNo = woErpFullNo,
                            ProcessAlias = item.ProcessAlias.ToString(),
                            OspQty = item.OspQty.ToString(),
                            SuppliedQty = item.SuppliedQty.ToString(),
                            ProcessCode = item.ProcessCode.ToString(),
                            ExpectedDate = item.ExpectedDate.ToString(),
                            ProcessCheckStatus = processCheckStatus,
                            ProcessCheckType = processCheckType,
                            item.Remark
                        }));

                        count++;
                    }
                    #endregion

                    #region //依公司別取得ProId
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TypeName ProId
                            FROM BAS.[Type] a
                            WHERE a.TypeSchema = 'BPM.OspProId'
                            AND a.TypeNo = @CompanyNo";
                    dynamicParameters.Add("CompanyNo", CompanyNo);

                    var ProIdResult = sqlConnection.Query(sql, dynamicParameters);

                    if (ProIdResult.Count() <= 0) throw new SystemException("此公司別【" + CompanyNo + "】尚未建立拋轉起單碼，請聯繫資訊人員!!");

                    string proId = "";
                    foreach (var item in ProIdResult)
                    {
                        proId = item.ProId;
                    }
                    #endregion

                    #region //組請購BPM資料
                    string memId = BpmUserId;
                    string rolId = BpmRoleId;
                    string startMethod = "NoOpFirst";

                    JObject artInsAppData = JObject.FromObject(new
                    {
                        dbTable = "MES.OutsourcingProduction",
                        Title = "MES託外生產單 = " + OspNo,
                        OspDesc,
                        OspStatus,
                        OspDate,
                        OspDeptName = DepartmentName,
                        SupplierName,
                        mesID = OspId,
                        company = CompanyNo,
                        SupplierNo,
                        PRNumber_MES = OspNo,
                        OspDeptNo = DepartmentNo,
                        tabPR_Line_Data = JsonConvert.SerializeObject(tabPR_Line_Data),
                    });
                    #endregion

                    string sData = BpmHelper.PostFormToBpm(token, proId, memId, rolId, startMethod, artInsAppData, BpmServerPath);

                    if (sData == "true")
                    {
                        #region //更改單據狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.OutsourcingProduction SET
                                Status = 'P',
                                TransferBpmDate = @TransferBpmDate,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE OspId = @OspId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransferBpmDate = DateTime.Now,
                                LastModifiedDate,
                                LastModifiedBy,
                                OspId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }
                    else
                    {
                        throw new SystemException("委外單【" + OspId + "】拋轉BPM失敗!");
                    }
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //Function API
        #region //TransferOspList -- 拋轉委外預排製程 -- Ann 2025-06-09
        public string TransferOspList(List<OspListData> ospLists, string CompanyNo, SqlConnection sqlConnection, SqlConnection sqlConnection2)
        {
            try
            {
                if (ospLists.Count() <= 0) throw new SystemException("拋轉項目不能為空!!");
                int rowsAffected = 0;
                List<string> ospNoArray = new List<string>();
                List<string> ospIds = new List<string>();

                #region //進行分類後建立單據
                var groupOspList = ospLists.GroupBy(x => new { x.GroupId });
                foreach (var group in groupOspList)
                {
                    var distinctCombinations = group
                        .Select(x => new { x.DepartmentId, x.OspDate, x.SupplierId })
                        .Distinct()
                        .Count();

                    if (distinctCombinations != 1)
                    {
                        throw new SystemException($"群組【{group.Key.GroupId}】內有不同的委託部門、委外日期或供應商!!");
                    }

                    #region //建立託外生產單單頭
                    #region //判斷供應商資料是否有誤
                    string SupplierNo = "";
                    string PassStationControl = "";
                    if (group.FirstOrDefault()?.SupplierId != null && group.FirstOrDefault()?.SupplierId > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 SupplierNo, PassStationControl
                            FROM SCM.Supplier
                            WHERE CompanyId = @CompanyId
                            AND SupplierId = @SupplierId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("SupplierId", group.FirstOrDefault().SupplierId);

                        var SupplierResult = sqlConnection.Query(sql, dynamicParameters);
                        if (SupplierResult.Count() <= 0) throw new SystemException("供應商資料有誤!");

                        foreach (var item in SupplierResult)
                        {
                            SupplierNo = item.SupplierNo;
                            PassStationControl = item.PassStationControl;
                        }
                    }
                    #endregion

                    #region //取得單日供應商序號
                    string OspNo = "";
                    string nowDate = DateTime.Now.ToString("yyyyMMdd");
                    if (SupplierNo.Length <= 0)
                    {
                        SupplierNo = "100A0000";
                    }

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ISNULL(MAX(OspNo), '1-0') MaxOspNo
                            FROM MES.OutsourcingProduction a
                            WHERE a.CompanyId = @CompanyId
                            AND a.OspNo LIKE '" + nowDate + SupplierNo + "%'";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result3 = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in result3)
                    {
                        string maxOspNo = item.MaxOspNo;
                        int count = Convert.ToInt32(maxOspNo.Split('-')[1]) + 1;
                        OspNo = nowDate + SupplierNo + "-" + count.ToString("D4");
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"INSERT INTO MES.OutsourcingProduction (CompanyId, DepartmentId, OspNo, OspDate, SupplierId, OspStatus, OspDesc, Status
                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                            OUTPUT INSERTED.OspId
                            VALUES (@CompanyId, @DepartmentId, @OspNo, @OspDate, @SupplierId, @OspStatus, @OspDesc, @Status
                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                    dynamicParameters.AddDynamicParams(
                        new
                        {
                            CompanyId = CurrentCompany,
                            group.FirstOrDefault().DepartmentId,
                            OspNo,
                            group.FirstOrDefault().OspDate,
                            group.FirstOrDefault().SupplierId,
                            OspStatus = "Y",
                            OspDesc = "",
                            Status = CompanyNo == "JMO-CT" ? "N" : "Y",
                            CreateDate,
                            LastModifiedDate,
                            CreateBy,
                            LastModifiedBy
                        });

                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                    rowsAffected += insertResult.Count();

                    int OspId = insertResult.FirstOrDefault().OspId;

                    ospNoArray.Add(OspNo);
                    ospIds.Add(OspId.ToString());
                    #endregion

                    #region //建立託外生產單單身
                    foreach (var item in group)
                    {
                        #region //確認MES製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId, a.ProcessId
                                , b.ModeId
                                FROM MES.MoProcess a 
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", item.MoProcessId);

                        var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoProcessResult.Count() <= 0) throw new SystemException("【製令製程】資料錯誤!!");

                        int MoId = -1;
                        int ProcessId = -1;
                        int ModeId = -1;
                        foreach (var item2 in MoProcessResult)
                        {
                            MoId = item2.MoId;
                            ProcessId = item2.ProcessId;
                            ModeId = item2.ModeId;
                        }
                        #endregion

                        #region //判斷製令製程是否已存在且已過站
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.OspReceiptDetail a 
                                INNER JOIN MES.OspDetail b ON a.OspDetailId = b.OspDetailId
                                WHERE b.MoProcessId = @MoProcessId
                                AND a.ProcessStatus = 'N'";
                        dynamicParameters.Add("MoProcessId", item.MoProcessId);

                        var OspReceiptDetailResult = sqlConnection.Query(sql, dynamicParameters);

                        if (OspReceiptDetailResult.Count() > 0) throw new SystemException("此製令製程已存在託外單據，且未過站!!");
                        #endregion

                        #region //若需工程檢，自動開立量測單據
                        if (item.ProcessCheckStatus == "Y")
                        {
                            #region //取得預設SpreadsheetData
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.DefaultSpreadsheetData
                                    FROM MES.QcRecord a";

                            var DefaultFileIdResult = sqlConnection.Query(sql, dynamicParameters);

                            string DefaultSpreadsheetData = "";
                            foreach (var item2 in DefaultFileIdResult)
                            {
                                DefaultSpreadsheetData = item2.DefaultSpreadsheetData;
                            }
                            #endregion

                            #region //取得此生產模式下IPQC資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.QcTypeId
                                    FROM QMS.QcType a 
                                    WHERE a.ModeId = @ModeId
                                    AND a.QcTypeNo = 'IPQC'";
                            dynamicParameters.Add("ModeId", ModeId);

                            var QcTypeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (QcTypeResult.Count() <= 0) throw new SystemException("此生產模式尚未設定量測類型，請通知系統開發室!!");

                            int QcTypeId = -1;
                            foreach (var item2 in QcTypeResult)
                            {
                                QcTypeId = item2.QcTypeId;
                            }
                            #endregion

                            #region //INSERT MES.QcRecord
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.QcRecord (QcTypeId, InputType, MoId, MoProcessId, Remark, DefaultFileId, CurrentFileId, DefaultSpreadsheetData, CheckQcMeasureData
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.QcRecordId
                                    VALUES (@QcTypeId, @InputType, @MoId, @MoProcessId, @Remark, @DefaultFileId, @CurrentFileId, @DefaultSpreadsheetData, @CheckQcMeasureData
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcTypeId,
                                    InputType = "BarcodeNo",
                                    MoId,
                                    item.MoProcessId,
                                    Remark = "由託外生產單自動建立",
                                    DefaultFileId = -1,
                                    CurrentFileId = -1,
                                    DefaultSpreadsheetData,
                                    CheckQcMeasureData = "N",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        #endregion

                        #region //確認供應商是否為自主過站模式，若是則檢核是否已設定過站機台
                        if (PassStationControl == "Y")
                        {
                            #region //檢核是否已設定供應商過站機台
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM SCM.SupplierMachine a 
                                    WHERE a.SupplierId = @SupplierId
                                    AND a.ProcessId = @ProcessId";
                            dynamicParameters.Add("SupplierId", item.SupplierId);
                            dynamicParameters.Add("ProcessId", ProcessId);

                            var SupplierMachineResult = sqlConnection.Query(sql, dynamicParameters);

                            if (SupplierMachineResult.Count() <= 0) throw new SystemException("此供應商尚未維護此製程機台!!");
                            #endregion
                        }
                        #endregion

                        #region //將委外製程改為非必要過站
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcess SET
                                NecessityStatus = 'N',
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LastModifiedDate,
                                LastModifiedBy,
                                item.MoProcessId
                            });

                        sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.OspDetail (OspId, MoId, MoProcessId, ProcessCheckStatus, ProcessCheckType, OspQty, SuppliedQty
                                , ProcessCode, ProcessCodeName, ExpectedDate, Remark
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@OspId, @MoId, @MoProcessId, @ProcessCheckStatus, @ProcessCheckType, @OspQty, @SuppliedQty
                                , @ProcessCode, @ProcessCodeName, @ExpectedDate, @Remark
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                OspId,
                                MoId,
                                item.MoProcessId,
                                item.ProcessCheckStatus,
                                ProcessCheckType = "2",
                                OspQty = item.Quantity,
                                SuppliedQty = item.Quantity,
                                item.ProcessCode,
                                item.ProcessCodeName,
                                item.ExpectedDate,
                                item.Remark,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                    }
                    #endregion
                }
                #endregion

                #region //拋轉BPM
                JObject transferResult = JObject.Parse(TransferOspToBpm(String.Join(",", ospIds), CompanyNo, sqlConnection, sqlConnection2));
                if (transferResult["status"].ToString() != "success")
                {
                    throw new SystemException(transferResult["msg"].ToString());
                }
                #endregion

                #region //依部門分組資料
                var groupOspListByDep = ospLists.GroupBy(x => new { x.DepartmentId });
                #endregion

                #region //通知生管群組
                string Content = "";
                foreach (var group in groupOspListByDep)
                {
                    string ospListMenuMamo = "| 製令 | 品號 | 品名 | 規格 | 供應商 | 製令製程 | 委託部門 | 數量 | 委託日期 | 備註 |\n| :-- | :-- | :-- | :-- | :-- | :-- | :-- | :-- | :-- |\n";
                    string ospListMenuEmail = "";
                    string ospListContent = "";

                    #region //資料載入
                    foreach (var item in group)
                    {
                        ospListMenuMamo += $"| {item.WoErpPrefix}-{item.WoErpNo}({item.WoSeq}) | {item.MtlItemNo} | {item.MtlItemName} | {item.MtlItemSpec} | {item.SupplierName} | {item.ProcessAlias} | {item.DepartmentName} | {item.Quantity} | {item.OspDate} | {item.Remark}\n";
                        ospListContent += $@"
                                            <tr>
                                                <td>{item.WoErpPrefix}-{item.WoErpNo}({item.WoSeq})</td>
                                                <td>{item.MtlItemNo}</td>
                                                <td>{item.MtlItemName}</td>
                                                <td>{item.MtlItemSpec}</td>
                                                <td>{item.ProcessAlias}</td>
                                                <td>{item.DepartmentName}</td>
                                                <td>{item.Quantity}</td>
                                                <td>{item.OspDate}</td>
                                                <td>{item.Remark}</td>
                                            </tr>";
                    }

                    ospListMenuEmail += $@"<html>
                                            <body>
                                                <h2>中揚光電-企業管理平台 委外預排製程 採購確認並拋轉BPM通知</h2>
                                                <p>系統日期：{DateTime.Now.ToString("yyyy-MM-dd HH:mm")}</p>
                                                <p>委外預排製程列表如下：</p>
                                                <table border='1' cellpadding='8' cellspacing='0' style='border-collapse: collapse; font-family: Arial, sans-serif;'>
                                                    <thead style='background-color: #f0f0f0;'>
                                                        <tr>
                                                            <th>製令</th>
                                                            <th>品號</th>
                                                            <th>品名</th>
                                                            <th>規格</th>
                                                            <th>製令製程</th>
                                                            <th>委託部門</th>
                                                            <th>數量</th>
                                                            <th>委託日期</th>
                                                            <th>備註</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {ospListContent}
                                                    </tbody>
                                                </table>
                                                <br>
                                                <p style='color: #666; font-size: 12px;'>
                                                    本通訊及其所有附件所含之資訊均屬機密，僅供指定之收件人使用...
                                                </p>
                                            </body>
                                            </html>";
                    #endregion

                    #region //MAMO
                    Content = "### 【委外預排製程 採購確認並拋轉BPM通知】\n" +
                                "- 系統日期:" + DateTime.Now.ToString("yyyy-MM-dd HH:mm") + "\n" +
                                "- 單據列表:\n" + ospListMenuMamo + "\n" +
                                "- 系統連結如下:\n" +
                                "https://bm.zy-tech.com.tw/Production/OspListManagement" + "\n";

                    #region //確認推播群組
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ChannelId
                            FROM MES.OspListMamoChannel a
                            WHERE a.DepartmentId = @DepartmentId";
                    dynamicParameters.Add("DepartmentId", group.FirstOrDefault().DepartmentId);

                    var QcMamoChannelResult = sqlConnection.Query(sql, dynamicParameters);

                    if (QcMamoChannelResult.Count() <= 0) throw new SystemException($"部門【{group.FirstOrDefault().DepartmentName}】尚未建立MAMO群組!!");

                    int ChannelId = -1;
                    foreach (var item in QcMamoChannelResult)
                    {
                        ChannelId = item.ChannelId;
                    }
                    #endregion

                    List<string> Tags = new List<string>();
                    List<int> Files = new List<int>();

                    string MamoResult = mamoHelper.SendMessage(CompanyNo, CurrentUser, "Channel", ChannelId.ToString(), Content, Tags, Files);

                    JObject MamoResultJson = JObject.Parse(MamoResult);
                    if (MamoResultJson["status"].ToString() != "success")
                    {
                        throw new SystemException(MamoResultJson["msg"].ToString());
                    }
                    #endregion

                    #region //Email
                    #region //取得要寄送的人員信箱
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ISNULL(STRING_AGG(b.UserNo + ':' + b.Email, ';'), '') AS CombinedUsers
                            FROM MAMO.ChannelMembers a 
                            INNER JOIN BAS.[User] b ON a.UserId = b.UserId
                            WHERE a.ChannelId = @ChannelId
                            AND b.Email IS NOT NULL AND b.Email != '' AND b.[Status] = 'A'";
                    dynamicParameters.Add("ChannelId", ChannelId);

                    var ChannelMembersResult = sqlConnection.Query(sql, dynamicParameters);

                    string Email = "";
                    foreach (var item in ChannelMembersResult)
                    {
                        Email = item.CombinedUsers;
                    }
                    #endregion

                    if (Email != null && Email.Length > 0)
                    {
                        #region //設定寄送格式
                        string mailSubject = "【中揚光電-企業管理平台】";
                        string mailContent = ospListMenuEmail;
                        #endregion

                        #region //寄送Mail
                        MailConfig mailConfig = new MailConfig
                        {
                            Host = "192.168.20.252",
                            Port = 25,
                            SendMode = 0,
                            From = "企業管理平台:jmo-service@zy-tech.com.tw",
                            Subject = mailSubject,
                            Account = "jmo-service",
                            Password = "asdf!QAZ",
                            MailTo = Email,
                            MailCc = "",
                            MailBcc = "",
                            HtmlBody = mailContent,
                            TextBody = "-"
                        };
                        BaseHelper.MailSend(mailConfig);
                        #endregion
                    }
                    #endregion
                }
                #endregion

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)",
                    ospNo = String.Join(",", ospNoArray)
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        public static string GetRandomString(int length)
        {
            const string chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
            Random random = new Random();
            return new string(Enumerable.Repeat(chars, length)
                .Select(s => s[random.Next(s.Length)]).ToArray());
        }
    }
}