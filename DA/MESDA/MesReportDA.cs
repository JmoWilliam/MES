using Dapper;
using Helpers;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using NLog;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Linq;
using System.Transactions;
using System.Web;

namespace MESDA
{
    public class MesReportDA
    {
        public string MainConnectionStrings = "";
        public string ErpConnectionStrings = "";
        public string HrmConnectionStrings = "";
        public string OfficialConnectionStrings = "";
        public string AutomationConnectionStrings = "";
        public string ETGAutomationConnectionStrings = "";
        public string ETGAutomationConnectionStrings2 = "";


        public int CurrentCompany = -1;
        public int CurrentUser = -1;
        public int CreateBy = -1;
        public int LastModifiedBy = -1;
        public DateTime CreateDate = default(DateTime);
        public DateTime LastModifiedDate = default(DateTime);

        public string sql = "";
        public JObject jsonResponse = new JObject();
        public Logger logger = LogManager.GetCurrentClassLogger();
        public DynamicParameters dynamicParameters = new DynamicParameters();
        public SqlQuery sqlQuery = new SqlQuery();
        public MamoHelper mamoHelper = new MamoHelper();

        public MesReportDA()
        {
            MainConnectionStrings = ConfigurationManager.AppSettings["MainDb"];
            HrmConnectionStrings = ConfigurationManager.AppSettings["HrmDb"];
            OfficialConnectionStrings = ConfigurationManager.AppSettings["OfficialDb"];
            AutomationConnectionStrings = ConfigurationManager.AppSettings["AutomationDB"];
            ETGAutomationConnectionStrings = ConfigurationManager.AppSettings["ETGAutomationDB"];
            ETGAutomationConnectionStrings2 = ConfigurationManager.AppSettings["ETGAutomationDB2"];


            GetUserInfo();

            CreateDate = DateTime.Now;
            LastModifiedDate = DateTime.Now;

            dynamicParameters = new DynamicParameters();
            sqlQuery = new SqlQuery();
        }
        
        #region //GetUserInfo 取得使用者資訊
        private void GetUserInfo()
        {
            try
            {
                CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["UserCompany"]);
                CurrentUser = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                CreateBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                LastModifiedBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);

                if (HttpContext.Current.Session["CompanySwitch"] != null)
                {
                    if (HttpContext.Current.Session["CompanySwitch"].ToString() == "manual")
                    {
                        CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["CompanyId"]);
                    }
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }
        }
        #endregion

        #region //Get
        #region //GetMonthlySalesDetailReport -- 取得每月業務撈取ERP銷貨明細 -- [Luca] [20250523]
        public string GetMonthlySalesDetailReport(string YearMonth, string SalesPersonCode, string CustomerCode,
            string StartDate, string EndDate, string SalesOrderNo, string ProductNo, string ProductCategory,
            string OrderBy, int PageIndex, int PageSize)
        {
            try
            {                
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                    FROM BAS.Company a
                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.公司別, a.單據類別, a.產品分類, a.製程, a.BU分類
                        , a.客戶代碼, a.客戶, a.集團交易, a.單別, a.銷貨單號
                        , CAST(a.銷貨序號 AS VARCHAR(10)) 銷貨序號
                        , a.品號, a.品名, a.機種, a.規格
                        , FORMAT(a.銷售日期, 'yyyy/MM/dd') as 銷售日期
                        , a.銷售年月, a.銷貨數量, a.單位, a.幣別, a.匯率
                        , a.單價, a.本幣單價, a.原幣金額, a.本幣金額, a.台幣金額
                        , a.原幣稅額, a.本幣稅額, a.單位成本, a.銷貨成本
                        , a.材料成本, a.人工成本, a.製費成本, a.加工成本
                        , a.結帳碼, a.預留1數, a.預留2數, a.預留1文, a.預留2文
                        , a.毛利, a.毛利率, a.業務人員
                        FROM [finance].[集團銷貨] a
                        WHERE 1=1";                        

                        // 年月條件
                        if (!string.IsNullOrEmpty(YearMonth))
                        {
                            YearMonth = YearMonth.Replace("-", "");
                            sql += " AND a.銷售年月 = @YearMonth ";
                            dynamicParameters.Add("YearMonth", YearMonth);
                        }

                        // 業務人員條件（支援多選）
                        if (!string.IsNullOrEmpty(SalesPersonCode))
                        {
                            var salesPersonCodes = SalesPersonCode.Split(',').Where(x => !string.IsNullOrEmpty(x)).ToArray();
                            if (salesPersonCodes.Length > 0)
                            {
                                var salesPersonParams = new List<string>();
                                for (int i = 0; i < salesPersonCodes.Length; i++)
                                {
                                    salesPersonParams.Add($"@SalesPerson{i}");
                                    dynamicParameters.Add($"SalesPerson{i}", salesPersonCodes[i]);
                                }
                                sql += $" AND a.業務人員 IN ({string.Join(",", salesPersonParams)}) ";
                            }
                        }

                        // 客戶條件（支援多選）
                        if (!string.IsNullOrEmpty(CustomerCode))
                        {
                            var customerCodes = CustomerCode.Split(',').Where(x => !string.IsNullOrEmpty(x)).ToArray();
                            if (customerCodes.Length > 0)
                            {
                                var customerParams = new List<string>();
                                for (int i = 0; i < customerCodes.Length; i++)
                                {
                                    customerParams.Add($"@Customer{i}");
                                    dynamicParameters.Add($"Customer{i}", customerCodes[i]);
                                }
                                sql += $" AND a.客戶代碼 IN ({string.Join(",", customerParams)}) ";
                            }
                        }

                        // 產品分類條件（支援多選）
                        if (!string.IsNullOrEmpty(ProductCategory))
                        {
                            var categories = ProductCategory.Split(',').Where(x => !string.IsNullOrEmpty(x)).ToArray();
                            if (categories.Length > 0)
                            {
                                var categoryParams = new List<string>();
                                for (int i = 0; i < categories.Length; i++)
                                {
                                    categoryParams.Add($"@Category{i}");
                                    dynamicParameters.Add($"Category{i}", categories[i]);
                                }
                                sql += $" AND a.產品分類 IN ({string.Join(",", categoryParams)}) ";
                            }
                        }

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "StartDate",
                            " AND a.銷售日期 >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "EndDate",
                            " AND a.銷售日期 <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "SalesOrderNo",
                            " AND a.銷貨單號 LIKE '%' + @SalesOrderNo + '%'", SalesOrderNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProductNo",
                            " AND (a.品號 LIKE '%' + @ProductNo + '%' OR a.品名 LIKE '%' + @ProductNo + '%')", ProductNo);

                        sql += " ORDER BY " + (OrderBy.Length > 0 ? OrderBy : "a.銷售日期 DESC, a.銷貨單號, a.銷貨序號");

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSalesPersonList  -- 取得業務人員清單 -- [Luca] [20250523]
        public string GetSalesPersonList(string UserNo)
        {
            try
            {
                List<SalesPersonList> salesPersons = new List<SalesPersonList>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                    FROM BAS.Company a
                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "a.業務人員";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns = @", a.業務人員 as SalesPersonName";

                        sqlQuery.mainTables = @" FROM (
                            SELECT DISTINCT 業務人員
                            FROM [finance].[集團銷貨]
                            WHERE 業務人員 IS NOT NULL AND 業務人員 != ''
                        ) a";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"";

                        sqlQuery.conditions = queryCondition;
                        

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //Response
                        return JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        }).ToString();
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
                return JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                }).ToString();
            }
        }
        #endregion

        #region //GetCustomerList -- 取得客戶清單  -- [Luca] [20250523]
        public string GetCustomerList(string UserNo)
        {
            try
            {
                List<CustomerList> customers = new List<CustomerList>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                    FROM BAS.Company a
                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "a.客戶代碼";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns = @", a.客戶代碼 as CustomerCode, a.客戶 as CustomerName";

                        sqlQuery.mainTables = @" FROM (
                            SELECT DISTINCT 客戶代碼, 客戶
                            FROM [finance].[集團銷貨]
                            WHERE 客戶代碼 IS NOT NULL AND 客戶代碼 != ''
                        ) a";

                        sqlQuery.auxTables = "";
                        string queryCondition = @"";
                        sqlQuery.conditions = queryCondition;
                       

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //Response
                        return JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        }).ToString();
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
                return JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                }).ToString();
            }
        }
        #endregion

        #region //GetProductCategoryList -- 取得產品分類清單 -- [Luca] [20250523]
        public string GetProductCategoryList(string UserNo)
        {
            try
            {
                List<ProductCategoryList> productCategories = new List<ProductCategoryList>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                    FROM BAS.Company a
                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                                sqlQuery.mainKey = "a.產品分類";
                                sqlQuery.auxKey = "";
                                sqlQuery.columns = @", a.產品分類 as CategoryCode, a.產品分類 as CategoryName";

                                sqlQuery.mainTables = @" FROM (
                            SELECT DISTINCT 產品分類
                            FROM [finance].[集團銷貨]
                            WHERE 產品分類 IS NOT NULL AND 產品分類 != ''
                        ) a";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"";

                        sqlQuery.conditions = queryCondition;
                                

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);                               

                        #region //Response
                        return JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        }).ToString();
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
                return JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                }).ToString();
            }
        }
        #endregion

        #region //GetProductQuery -- 取得產品資料 -- Xuan 2023.07.25 
            public string GetProductQuery(int MoId, int ModeId, string WoErpFullNo, string MtlItemNo, string StartDate, string EndDate, string ProcessAlias
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                List<ProductQuery> productQuerys = new List<ProductQuery>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "a.MoId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.WoSeq, a.InputQty, a.Quantity, FORMAT(b.DocDate, 'yyyy-MM-dd') DocDate
                              , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo, b.StockInQty, b.PlanQty, b.StockInQty,b.RequisitionSetQty
                              , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                              , (
                                    SELECT a.WoSeq, x.MoProcessId
                                    , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo
                                    , x.ProcessId, ISNULL(x.ProcessAlias, '') ProcessAlias, ISNULL(x.TotalInputQty, 0) TotalInputQty
                                    , ISNULL(x.TotalPassQty, 0) TotalPassQty, ISNULL(x.TotalNgQty, 0) TotalNgQty
                                    , ISNULL(x.TotalScrapQty, 0) TotalScrapQty, ISNULL(x.WipQty, 0) WipQty, ISNULL(x.AlreadyQty, 0) AlreadyQty
                                    , CASE 
                                        WHEN ISNULL(x.TotalInputQty, 0) > 0
                                            THEN CONVERT(varchar, CONVERT(decimal(18,0), CONVERT(decimal(18,0), x.TotalPassQty) / CONVERT(decimal(18,0), x.TotalInputQty) * 100)) + '%'
                                            ELSE '0%'
                                        END PassRate
                                    FROM MES.MoProcess x
                                    WHERE x.MoId = a.MoId
                                    ORDER BY x.SortNumber
                                    FOR JSON PATH, ROOT('data')
                              ) ProcessDetail";

                        sqlQuery.mainTables =
                          @" FROM MES.ManufactureOrder a
                          INNER JOIN MES.WipOrder b ON b.WoId = a.WoId
                          INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId
                          OUTER APPLY(
                              SELECT TOP 1 x.MoProcessId
                              FROM MES.MoProcess x
                              WHERE x.MoId = a.MoId
                          ) d";

                        string queryTable =
                        @"FROM (
                            SELECT a.MoId, b.CompanyId, a.WoSeq, a.InputQty, a.Quantity, a.CreateDate
                              , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo, b.StockInQty, b.PlanQty, b.RequisitionSetQty, b.DocDate
                              ,c.MtlItemNo, c.MtlItemName
                              , (
                                SELECT z.ProcessId, z.ProcessAlias
                                FROM MES.MoProcess z
                                WHERE z.MoId = a.MoId
                                FOR JSON PATH, ROOT('data')
                            ) ProcessDetail
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b ON b.WoId = a.WoId
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId
                        ) a
                        OUTER APPLY (
                            SELECT TOP 1 x.ProcessId, x.ProcessAlias
                            FROM OPENJSON(a.ProcessDetail, '$.data')
                            WITH (
                                ProcessId int N'$.ProcessId', 
                                ProcessAlias NVARCHAR(32) N'$.ProcessAlias'
                            ) x
                        ) b";

                        sqlQuery.auxTables = queryTable;
                        //sqlQuery.distinct = true;
                        //sqlQuery.auxTables = "";
                        string queryCondition = @"AND a.CompanyId = @CompanyId
                                                  ";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ModeId", @" AND a.ModeId = @ModeId", ModeId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND a.WoErpFullNo = @WoErpFullNo ", WoErpFullNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (a.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR a.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.DocDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.DocDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        productQuerys = BaseHelper.SqlQuery<ProductQuery>(sqlConnection, dynamicParameters, sqlQuery);


                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = productQuerys
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProductionInProcess -- 取得生產在製資料 -- Zoey 2023.01.03
        public string GetProductionInProcess(int ModeId, string WoErpFullNo, string MtlItemNo, string StartDate, string EndDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<ManufactureOrder> manufactureOrders = new List<ManufactureOrder>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                        FROM BAS.Company a
                        WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId, a.WoSeq, a.InputQty, a.Quantity,ISNULL(a.Remark,'') Remark
                            , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo, b.StockInQty, b.PlanQty, b.StockInQty,b.RequisitionSetQty
                            , b.WoErpPrefix, b.WoErpNo
                            , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                            , (
                                SELECT a.WoSeq, x.MoProcessId
                                , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo
                                , x.ProcessId, ISNULL(x.ProcessAlias, '') ProcessAlias, ISNULL(x.TotalInputQty, 0) TotalInputQty
                                , ISNULL(x.TotalPassQty, 0) TotalPassQty, ISNULL(x.TotalNgQty, 0) TotalNgQty
                                , ISNULL(x.TotalScrapQty, 0) TotalScrapQty, ISNULL(x.AlreadyQty, 0) AlreadyQty
                                , CASE 
                                    WHEN ISNULL(x.TotalInputQty, 0) > 0
                                        THEN CONVERT(varchar, CONVERT(decimal(18,0), CONVERT(decimal(18,0), x.TotalPassQty) / CONVERT(decimal(18,0), x.TotalInputQty) * 100)) + '%'
                                        ELSE '0%'
                                    END PassRate
                                FROM MES.MoProcess x
                                WHERE x.MoId = a.MoId
                                ORDER BY x.SortNumber
                                FOR JSON PATH, ROOT('data')
                            ) ProcessDetail
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b ON b.WoId = a.WoId
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId
                            OUTER APPLY(
                                SELECT TOP 1 x.MoProcessId
                                FROM MES.MoProcess x
                                WHERE x.MoId = a.MoId
                            ) d
                            WHERE 1=1
                            AND b.CompanyId = @CompanyId
                            AND d.MoProcessId > 0";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ModeId", @" AND a.ModeId = @ModeId", ModeId);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND b.WoErpPrefix + '-' + b.WoErpNo + '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')' LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND (c.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR c.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "StartDate", @" AND b.DocDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "EndDate", @" AND b.DocDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                        sql += @" Order By a.CreateDate Desc";
                        manufactureOrders = sqlConnection.Query<ManufactureOrder>(sql, dynamicParameters).ToList();

                        #region //搜尋此製令所有領料單資訊，並找出實際已核單領料套數
                        foreach (var item in manufactureOrders)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT 
                                        ISNULL(SUM(CASE WHEN x.MQ010 = -1 THEN a.TD006 ELSE 0 END), 0) AS RequisitionQty,
                                        ISNULL(SUM(CASE WHEN x.MQ010 = 1 THEN a.TD006 ELSE 0 END), 0) AS ReturnQty
                                    FROM MOCTD a
                                    INNER JOIN MOCTC b 
                                        ON a.TD001 = b.TC001 
                                        AND a.TD002 = b.TC002
                                    LEFT JOIN CMSMQ x 
                                        ON x.MQ001 = a.TD001
                                    WHERE a.TD003 = @WoErpPrefix
                                        AND a.TD004 = @WoErpNo
                                        AND b.TC009 = 'Y'";
                            dynamicParameters.Add("WoErpPrefix", item.WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", item.WoErpNo);

                            var ErpMrWipOrderResult = sqlConnection2.Query(sql, dynamicParameters);

                            decimal RequisitionQty = ErpMrWipOrderResult.FirstOrDefault().RequisitionQty;
                            decimal ReturnQty = ErpMrWipOrderResult.FirstOrDefault().ReturnQty;

                            item.RequisitionSetQty = Convert.ToDouble(RequisitionQty - ReturnQty);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = manufactureOrders
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWipBarcodeCountData -- 取得條碼在製資料筆數 -- Ann 2023-11-24
        public string GetWipBarcodeCountData(string MoProcessIdListString)
       {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoProcessIdListString.Length <= 0) throw new SystemException("【製程】不能為空!");

                    sql = @"WITH NotStartCTE AS (
                                SELECT a.MoProcessId, a.SortNumber, a.MoId,
                                       ISNULL(SUM(x.BarcodeQty), 0) AS NotStartQty,
                                       xa.NecessityStatus PreNecessityStatus
                                FROM MES.MoProcess a
                                LEFT JOIN MES.Barcode x
                                    ON ((x.CurrentMoProcessId != a.MoProcessId AND x.NextMoProcessId = a.MoProcessId AND x.ParentBarcode IS NULL)
                                            OR (a.SortNumber = 1 AND x.CurrentMoProcessId = a.MoProcessId AND x.NextMoProcessId = a.MoProcessId))
                                LEFT JOIN MES.MoProcess xa
		                            ON a.MoId = xa.MoId AND xa.SortNumber = a.SortNumber - 1
                                WHERE 1=1 
                                GROUP BY a.MoProcessId, xa.NecessityStatus, a.SortNumber, a.MoId
                            ),
                            StartCTE AS (
                                SELECT a.MoProcessId,
                                       ISNULL(SUM(x.StationQty), 0) AS StartQty
                                FROM MES.MoProcess a
                                LEFT JOIN MES.BarcodeProcess x
                                ON x.MoProcessId = a.MoProcessId
                                WHERE x.FinishDate IS NULL
                                GROUP BY a.MoProcessId
                            ),
                            WipQtyCTE AS (
                                SELECT a.MoProcessId,
                                       ISNULL(SUM(x.BarcodeQty), 0) AS WipQty
                                FROM MES.MoProcess a
                                LEFT JOIN MES.Barcode x
                                ON x.CurrentMoProcessId = a.MoProcessId AND x.NextMoProcessId != x.CurrentMoProcessId AND x.ParentBarcode IS NULL
                                GROUP BY a.MoProcessId
                            )
                            SELECT a.MoProcessId, a.ProcessAlias, a.SortNumber, a.MoId,
                                   b.WoSeq,
                                   c.WoErpPrefix + '-' + c.WoErpNo AS WoErpFullNo,
                                   NotStartCTE.PreNecessityStatus,
                                   NotStartCTE.NotStartQty,
                                   StartCTE.StartQty,
                                   WipQtyCTE.WipQty
                            FROM MES.MoProcess a
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                            LEFT JOIN NotStartCTE ON a.MoProcessId = NotStartCTE.MoProcessId
                            LEFT JOIN StartCTE ON a.MoProcessId = StartCTE.MoProcessId
                            LEFT JOIN WipQtyCTE ON a.MoProcessId = WipQtyCTE.MoProcessId
                            WHERE a.MoProcessId IN (" + MoProcessIdListString + ");";

                    List<BarcodeWipCount> result = sqlConnection.Query<BarcodeWipCount>(sql, dynamicParameters).ToList();

                    foreach (var item in result)
                    {
                        //若前一站為非必要過站且非首站，則未開工數量需要重新計算
                        if (item.PreNecessityStatus == "N" && item.SortNumber != 1)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"select (select Max(a1.SortNumber)
                                                      from MES.MoProcess a1
		                                             where a1.MoId = a.MoId
		                                               and a1.SortNumber < a.SortNumber
		                                               and a1.NecessityStatus != 'N'
                                                  ) MaxSortNumber
                                      from MES.MoProcess a
                                     where a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", item.MoProcessId);

                            var maxMoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            int maxSortNumber = 0;
                            foreach (var item2 in maxMoProcessResult)
                            {
                                maxSortNumber = item2.MaxSortNumber;
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"select isnull(sum(x.BarcodeQty), 0) TotalBarcodeQty
                                      from MES.Barcode x
                                     where x.NextMoProcessId in(
							                                    select a.MoProcessId
							                                      from MES.MoProcess a
							                                     where a.MoId = @MoId
							                                       and a.SortNumber <= @SortNumber
							                                       and a.SortNumber > @MaxSortNumber)
                                       and x.CurrentMoProcessId != NextMoProcessId";
                            dynamicParameters.Add("MoId", item.MoId);
                            dynamicParameters.Add("SortNumber", item.SortNumber);
                            dynamicParameters.Add("MaxSortNumber", maxSortNumber);

                            var barcodeQtyResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in barcodeQtyResult)
                            {
                                item.NotStartQty = item2.TotalBarcodeQty;
                            }
                        }
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeTracking -- 取得條碼追蹤資料 -- Ann 2024-03-29
        public string GetBarcodeTracking(int BarcodeId, string BarcodeNo, string MoProcessList, string QueryType
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (BarcodeNo.Length <= 0) throw new SystemException("【產品條碼】不能為空!");
                    if (QueryType.Length <= 0) throw new SystemException("【查詢方式】不能為空!");

                    #region //先檢查是否為TrayBarcode
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT BarcodeNo
                            FROM MES.Tray
                            WHERE TrayNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in TrayResult)
                    {
                        if (item.BarcodeNo == null) break;
                        BarcodeNo = item.BarcodeNo;
                    }
                    #endregion

                    string detailCondition = "";
                    if (MoProcessList.Length > 0)
                    {
                        detailCondition += @" AND t.MoProcessId IN (" + MoProcessList + ")";
                    }

                    sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeStatus, a.CurrentMoProcessId, a.BarcodeQty, a.CurrentProdStatus, a.MoId
                            , b.WoSeq
                            , c.WoErpPrefix + '-' + c.WoErpNo WoErpFullNo
                            , d.MtlItemNo
                            , ISNULL(
                                (
                                    SELECT t.BarcodeProcessId, t.ProdStatus, t.CycleTime, t.MoProcessId, t.StationQty
                                    , FORMAT(t.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(t.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                                    , u.ProcessAlias
                                    , ISNULL(v.MachineName, '') MachineName
                                    , w.UserNo StartUserNo, w.UserName StartUserName
                                    , x.UserNo FinishUserNo, x.UserName FinishUserName
                                    , xa.WoSeq
                                    , xb.WoErpPrefix + '-' + xb.WoErpNo WoErpFullNo
                                    , (
                                        SELECT TOP 1 xb.SupplierNo
                                        FROM MES.OspDetail x
                                        INNER JOIN MES.OutsourcingProduction xa ON x.OspId = xa.OspId
                                        INNER JOIN SCM.Supplier xb ON xa.SupplierId = xb.SupplierId
                                        WHERE x.MoProcessId = t.MoProcessId
                                    ) SupplierNo
                                    , (
                                        SELECT TOP 1 xb.SupplierShortName
                                        FROM MES.OspDetail x
                                        INNER JOIN MES.OutsourcingProduction xa ON x.OspId = xa.OspId
                                        INNER JOIN SCM.Supplier xb ON xa.SupplierId = xb.SupplierId
                                        WHERE x.MoProcessId = t.MoProcessId
                                    ) SupplierShortName
                                    FROM MES.BarcodeProcess t
                                    INNER JOIN MES.MoProcess u ON u.MoProcessId = t.MoProcessId
                                    LEFT JOIN MES.Machine v ON v.MachineId = t.MachineId
                                    INNER JOIN BAS.[User] w ON w.UserId = t.StartUserId
                                    INNER JOIN BAS.[User] x ON x.UserId = t.FinishUserId
                                    
                                    INNER JOIN MES.ManufactureOrder xa ON t.MoId = xa.MoId
                                    INNER JOIN MES.WipOrder xb ON xa.WoId = xb.WoId
                                    WHERE t.BarcodeId = a.BarcodeId";
                    sql += detailCondition;
                    sql += @"
                                    ORDER BY t.StartDate
                                    FOR JSON PATH, ROOT('data')
                                ), '') ProcessDetail
                            , (
                                SELECT (ea.TypeName + ':' + e.ItemValue) ItemValue
                                , CASE WHEN LEN(LTRIM(RTRIM(e.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(e.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                                FROM MES.BarcodeAttribute e
                                INNER JOIN BAS.[Type] ea ON e.ItemNo = ea.TypeNo AND ea.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE e.BarcodeId = a.BarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , e.TypeName CurrentProdStatusName
                            , f.ProcessAlias CurrentProcessName
                            , ISNULL(g.ProcessAlias, '無下製程') NextProcessName
                            , i.TrayNo
                            , ISNULL(
                                (
                                    SELECT STRING_AGG(t.BarcodeNo, ',') 
                                    FROM MES.Barcode t
                                    WHERE t.ParentBarcode = a.BarcodeId
                                ), ''
                            )  LensBarcode
                            FROM MES.Barcode a
                            INNER JOIN MES.ManufactureOrder b ON b.MoId = a.MoId
                            INNER JOIN MES.WipOrder c ON c.WoId = b.WoId
                            INNER JOIN PDM.MtlItem d ON d.MtlItemId = c.MtlItemId
                            INNER JOIN BAS.[Type] e ON a.CurrentProdStatus = e.TypeNo AND TypeSchema = 'Barcode.CurrentProdStatus'
                            INNER JOIN MES.MoProcess f ON a.CurrentMoProcessId = f.MoProcessId
                            LEFT JOIN MES.MoProcess g ON a.NextMoProcessId = g.MoProcessId
                            LEFT JOIN MES.BarcodeAttribute h ON a.BarcodeId = h.BarcodeId AND h.ItemNo = 'Lettering'
                            LEFT JOIN MES.Tray i ON a.BarcodeNo = i.BarcodeNo
                            WHERE 1=1";
                    
                    switch (QueryType)
                    {
                        case "BarcodeNo":
                            sql += @" AND a.BarcodeNo LIKE '%' + @BarcodeNo + '%'";
                            break;
                        case "Lettering":
                            sql += @" AND h.ItemValue LIKE '%' + @BarcodeNo + '%'";
                            break;
                        default:
                            throw new SystemException("【查詢方式】錯誤!!");

                    }
                    dynamicParameters.Add("BarcodeNo", BarcodeNo.Trim());

                    string allRowsSql = sql;

                    sql += @" ORDER BY a.BarcodeId 
                                OFFSET @PageSize * (@PageIndex - 1) ROWS
                                FETCH NEXT @PageSize ROWS ONLY;";
                    dynamicParameters.Add("PageSize", PageSize);
                    dynamicParameters.Add("PageIndex", PageIndex);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    sql = @"SELECT COUNT(1) AS TotalCount
                            FROM ("+ allRowsSql + ") AS TotalQuery";

                    var TotalCountResult = sqlConnection.Query(sql, dynamicParameters);

                    int TotalCount = 0;
                    foreach (var item in TotalCountResult)
                    {
                        TotalCount = item.TotalCount;
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        result,
                        TotalCount
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProductionHistory -- 取得生產歷史資料-- Ann 2023-06-20
        public string GetProductionHistory(int MoProcessId, string ProdStatus)
        {
            try
            {
                if (MoProcessId <= 0) throw new SystemException("製令製程編號不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT a.BarcodeProcessId, a.ProdStatus, a.CycleTime, a.MoProcessId, a.StationQty
                            , i.CauseNo, ISNULL(i.CauseName, '') CauseName
                            , FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                            , b.WoSeq
                            , c.WoErpPrefix + '-'+ c.WoErpNo WoErpFullNo
                            , d.BarcodeNo
                            , e.ProcessId, e.ProcessAlias
                            , f.MachineName,f.MachineDesc
                            , g.UserNo StartUserNo, g.UserName StartUserName
                            , h.UserNo FinishUserNo, h.UserName FinishUserName
                            , (
                                SELECT (ja.TypeName + ':' + j.ItemValue) ItemValue
                                , CASE WHEN LEN(LTRIM(RTRIM(j.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(j.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                                FROM MES.BarcodeAttribute j
                                INNER JOIN BAS.[Type] ja ON j.ItemNo = ja.TypeNo AND ja.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE j.BarcodeId = a.BarcodeId
                                FOR JSON PATH, ROOT('data') 
                            ) ItemValue
                            FROM MES.BarcodeProcess a
                            INNER JOIN MES.ManufactureOrder b ON b.MoId = a.MoId
                            INNER JOIN MES.WipOrder c ON c.WoId = b.WoId
                            INNER JOIN MES.Barcode d ON d.BarcodeId = a.BarcodeId AND d.ParentBarcode IS NULL
                            INNER JOIN MES.MoProcess e ON e.MoProcessId = a.MoProcessId
                            LEFT JOIN MES.Machine f ON f.MachineId = a.MachineId
                            INNER JOIN BAS.[User] g ON g.UserId = a.StartUserId
                            INNER JOIN BAS.[User] h ON h.UserId = a.FinishUserId
                            LEFT JOIN QMS.DefectCause i ON i.CauseNo = a.CauseNo
                            LEFT JOIN QMS.DefectClass j ON i.ClassId=  j.ClassId
                            LEFT JOIN QMS.DefectGroup k ON j.GroupId = k.GroupId AND (k.CompanyId = @CompanyId OR k.CompanyId IS NULL)
                            WHERE a.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProdStatus", @" AND a.ProdStatus = @ProdStatus", ProdStatus);

                    sql += @" ORDER BY d.BarcodeNo";

                    List<ProductionHistory> productionHistories = sqlConnection.Query<ProductionHistory>(sql, dynamicParameters).ToList();

                    #region //若為託外生產過站，USER改找供應商資料
                    foreach (var item in productionHistories)
                    {
                        if (item.StartUserNo == "Z100" || item.FinishUserNo == "Z100")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 c.SupplierNo, c.SupplierShortName
                                    FROM MES.OspDetail a 
                                    INNER JOIN MES.OutsourcingProduction b ON a.OspId = b.OspId
                                    INNER JOIN SCM.Supplier c ON b.SupplierId = c.SupplierId
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", item.MoProcessId);

                            var ospSupplierResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in ospSupplierResult)
                            {
                                productionHistories[productionHistories.IndexOf(item)].StartUserNo = item2.SupplierNo;
                                productionHistories[productionHistories.IndexOf(item)].StartUserName = item2.SupplierShortName;
                                productionHistories[productionHistories.IndexOf(item)].FinishUserNo = item2.SupplierNo;
                                productionHistories[productionHistories.IndexOf(item)].FinishUserName = item2.SupplierShortName;
                            }
                        }
                    }
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = productionHistories
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcRecord -- 取得量測記錄資料 -- Ann 2023-02-24
        public string GetQcRecord(int QcRecordId, string DocErpFullNo, string QcNoticeNo, string MtlItemNo, string MtlItemName
            , int QcTypeId, string CheckQcMeasureData, int UserId, string StartDate, string EndDate, string BarcodeNo, string QcType, int MoProcessId, string LotNumber, string QcLotNumber
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QcRecordId, a.QcNoticeId, a.QcTypeId, a.MoId, a.MoProcessId, ISNULL(a.PassQty, 0) PassQty, ISNULL(a.NgQty, 0) NgQty, a.SystemStatus
                            , a.QcStatus, a.QcUserId, ISNULL(a.Remark, '') Remark, FORMAT(a.CreateDate, 'yyyy-MM-dd') CreateDate, a.SpreadsheetData
                            , a.InputType, a.DefaultFileId, a.CheckQcMeasureData, ISNULL(a.DisallowanceReason, '') DisallowanceReason
                            , CAST(b.WoSeq AS VARCHAR) DocSeq
                            , (c.WoErpPrefix + '-' + c.WoErpNo) DocErpFullNo
                            , d.MtlItemNo, d.MtlItemName
                            , ISNULL(e.ProcessAlias, '') ProcessAlias
                            , ISNULL(f.StatusName, '') StatusName
                            , g.UserNo, g.UserName
                            , k.QcTypeNo, k.QcTypeName
                            , l.StatusName CheckQcMeasureDataName
							, j.LotNumber QcLotNumber
							, a.BarcodeId
                            FROM MES.QcRecord a
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                            INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                            LEFT JOIN MES.MoProcess e ON a.MoProcessId = e.MoProcessId
                            LEFT JOIN BAS.[Status] f ON a.QcStatus = f.StatusNo AND f.StatusSchema = 'QcRecord.QcStatus'
                            INNER JOIN BAS.[User] g ON a.CreateBy = g.UserId
                            LEFT JOIN QMS.QcNotice h ON a.QcNoticeId = h.QcNoticeId
                            INNER JOIN QMS.QcType k ON a.QcTypeId = k.QcTypeId
                            INNER JOIN BAS.Status l ON a.CheckQcMeasureData = l.StatusNo 
                                AND l.StatusSchema = 'QcRecord.CheckQcMeasureData'
                            OUTER APPLY (
                                SELECT TOP 1 LotNumber 
                                FROM QMS.QcMeasureData 
                                WHERE QcRecordId = a.QcRecordId
                            ) j
                            LEFT JOIN MES.Barcode z ON a.BarcodeId = z.BarcodeId
                            WHERE c.CompanyId = @CompanyId";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcRecordId", @" AND a.QcRecordId = @QcRecordId", QcRecordId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "DocErpFullNo", @" AND (c.WoErpPrefix + '-' + c.WoErpNo +  '(' + CONVERT(VARCHAR(10), b.WoSeq) + ')') LIKE '%' + @DocErpFullNo + '%'", DocErpFullNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcType", @" AND k.QcTypeNo = @QcType", QcType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND EXISTS (SELECT TOP 1 1 FROM MES.QcBarcode x INNER JOIN MES.Barcode xa ON x.BarcodeId = xa.BarcodeId WHERE x.QcRecordId = a.QcRecordId AND xa.BarcodeNo LIKE '%' + @BarcodeNo + '%')", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" OR z.BarcodeNo LIKE '%' + @BarcodeNo + '%'", BarcodeNo);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND d.MtlItemNo = @MtlItemNo", MtlItemNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemName", @" AND d.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcLotNumber", @" AND j.LotNumber = @QcLotNumber", QcLotNumber);



                    sql += @" UNION ALL 
                                SELECT a.QcRecordId, a.QcNoticeId, a.QcTypeId, a.MoId, a.MoProcessId, ISNULL(a.PassQty, 0) PassQty, ISNULL(a.NgQty, 0) NgQty, a.SystemStatus
                                , a.QcStatus, a.QcUserId, ISNULL(a.Remark, '') Remark, FORMAT(a.CreateDate, 'yyyy-MM-dd') CreateDate, a.SpreadsheetData
                                , a.InputType, a.DefaultFileId, a.CheckQcMeasureData, ISNULL(a.DisallowanceReason, '') DisallowanceReason
                                , c.GrSeq DocSeq
                                , c.GrErpPrefix + '-' + c.GrErpNo DocErpFullNo
                                , d.MtlItemNo, d.MtlItemName
                                , '' ProcessAlias
                                , ISNULL(e.StatusName, '') StatusName
                                , f.UserNo, f.UserName
                                , 'IQC' QcTypeNo, '進貨檢' QcTypeName
                                , g.StatusName CheckQcMeasureDataName
							    , j.LotNumber QcLotNumber
							    , a.BarcodeId

                                FROM MES.QcRecord a 
                                INNER JOIN MES.QcGoodsReceipt b ON a.QcRecordId = b.QcRecordId
                                INNER JOIN SCM.GrDetail c ON b.GrDetailId = c.GrDetailId
                                INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                LEFT JOIN BAS.[Status] e ON a.QcStatus = e.StatusNo AND e.StatusSchema = 'QcRecord.QcStatus'
                                INNER JOIN BAS.[User] f ON a.CreateBy = f.UserId
                                INNER JOIN BAS.Status g ON a.CheckQcMeasureData = g.StatusNo AND g.StatusSchema = 'QcRecord.CheckQcMeasureData' 
								INNER JOIN QMS.QcType k ON a.QcTypeId = k.QcTypeId
							    OUTER APPLY (
                                SELECT TOP 1 LotNumber 
                                FROM QMS.QcMeasureData 
                                WHERE QcRecordId = a.QcRecordId
                                ) j
                                LEFT JOIN MES.Barcode z ON a.BarcodeId = z.BarcodeId
                                WHERE d.CompanyId = @CompanyId";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcRecordId", @" AND a.QcRecordId = @QcRecordId", QcRecordId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "DocErpFullNo", @" AND c.GrErpPrefix + '-' + c.GrErpNo LIKE '%' + @DocErpFullNo + '%'", DocErpFullNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND d.MtlItemNo = @MtlItemNo", MtlItemNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "LotNumber", @" AND c.LotNumber = @LotNumber", LotNumber);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemName", @" AND d.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcLotNumber", @" AND j.LotNumber = @QcLotNumber", QcLotNumber);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcType", @" AND k.QcTypeNo = @QcType", QcType);


                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    #region //取得全部筆數
                    string totalSql = @"SELECT COUNT(1) AS TotalCount
                                        FROM (" + sql + ") AS TotalQuery";

                    var TotalCountResult = sqlConnection.Query(totalSql, dynamicParameters);

                    int TotalCount = 0;
                    foreach (var item in TotalCountResult)
                    {
                        TotalCount = item.TotalCount;
                    }
                    #endregion

                    sql += @" ORDER BY a.QcRecordId DESC
                                OFFSET @PageSize * (@PageIndex - 1) ROWS
                                FETCH NEXT @PageSize ROWS ONLY;";
                    dynamicParameters.Add("PageSize", PageSize);
                    dynamicParameters.Add("PageIndex", PageIndex);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcRecordId", @" AND a.QcRecordId = @QcRecordId", QcRecordId);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND (c.WoErpPrefix + '-' + c.WoErpNo +  '(' + CONVERT(VARCHAR(10), b.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND d.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemName", @" AND d.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcTypeId", @" AND a.QcTypeId = @QcTypeId", QcTypeId);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "CheckQcMeasureData", @" AND a.CheckQcMeasureData = @CheckQcMeasureData", CheckQcMeasureData);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UserId", @" AND a.CreateBy = @UserId", UserId);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "StartDate", @" AND a.CreateDate >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "EndDate", @" AND a.CreateDate <= @EndDate", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND EXISTS (SELECT TOP 1 1 FROM MES.QcBarcode x INNER JOIN MES.Barcode xa ON x.BarcodeId = xa.BarcodeId WHERE x.QcRecordId = a.QcRecordId AND xa.BarcodeNo LIKE '%' + @BarcodeNo + '%')", BarcodeNo);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcType", @" AND k.QcTypeNo = @QcType", QcType);
                    //sqlQuery.conditions = sql;
                    //sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.QcRecordId DESC";
                    //sqlQuery.pageIndex = PageIndex;
                    //sqlQuery.pageSize = PageSize;

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    //var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        result,
                        TotalCount
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcMeasureData -- 取得量測詳細資料 -- Ann 2023-04-20
        public string GetQcMeasureData(int QcRecordId, string BarcodeNo, string QcResult, string QcItemName, string MachineNumber)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QmdId, a.QcRecordId, a.QcItemId, a.BarcodeId, a.QmmDetailId, a.Unit, a.BallMark
                            , ISNULL(CONVERT(nvarchar(18), a.DesignValue), '') AS DesignValue
                            , ISNULL(CONVERT(nvarchar(18), a.UpperTolerance), '') AS UpperTolerance
                            , ISNULL(CONVERT(nvarchar(18), a.LowerTolerance), '') AS LowerTolerance
                            , ISNULL(a.ZAxis, '') ZAxis
                            , a.MeasureValue
                            , a.QcResult, a.CauseId, a.CauseDesc, a.Cavity, a.LotNumber, a.MakeCount, a.Remark, a.QcItemDesc
                            , b.QcItemNo, b.QcItemName
                            , c.BarcodeNo, c.BarcodeQty
                            , (
                                SELECT (da.TypeName + ':' + d.ItemValue) ItemValue
                                FROM MES.BarcodeAttribute d
                                INNER JOIN BAS.[Type] da ON d.ItemNo = da.TypeNo AND da.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE d.BarcodeId = c.BarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , e.MachineNumber, (left(b.QcItemNo,3) + e.MachineNumber + right(b.QcItemNo,4)) serialCode
                            , f.MachineName, f.MachineDesc
                            , g.CauseNo, g.CauseName
                            , ISNULL(h.UserNo, '') QcUserNo, ISNULL(h.UserName, '') QcUserName
                            , i.UserNo CreateUserNo, i.UserName CreateUserName
                            , j.ItemSeq
                            , k.InputType
                            FROM QMS.QcMeasureData a
                            INNER JOIN QMS.QcItem b ON a.QcItemId = b.QcItemId
                            LEFT JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                            INNER JOIN QMS.QmmDetail e ON a.QmmDetailId = e.QmmDetailId
                            INNER JOIN MES.Machine f ON e.MachineId = f.MachineId
                            LEFT JOIN QMS.DefectCause g ON a.CauseId = g.CauseId
                            LEFT JOIN BAS.[User] h ON a.QcUserId = h.UserId
                            LEFT JOIN BAS.[User] i ON a.CreateBy = i.UserId
                            LEFT JOIN MES.BarcodeAttribute j on a.BarcodeId = j.BarcodeId
                            INNER JOIN MES.QcRecord k ON a.QcRecordId = k.QcRecordId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcRecordId", @" AND a.QcRecordId = @QcRecordId", QcRecordId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND (c.BarcodeNo LIKE '%' + @BarcodeNo + '%' OR a.Cavity LIKE '%' + @BarcodeNo + '%')", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcResult", @" AND a.QcResult = @QcResult", QcResult);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcItemName", @" AND b.QcItemName LIKE '%' + @QcItemName + '%'", QcItemName);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineNumber", @" AND e.MachineNumber = @MachineNumber", MachineNumber);

                    sql += "    ORDER BY serialCode, j.ItemSeq, a.Cavity, c.BarcodeNo, a.LotNumber, a.QmdId";
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    if (result.Count() <= 0) throw new SystemException("找不到量測數據!!");

                    #region //取得QcRecord 的 Barcode -- FOR -- MTF
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeId, b.BarcodeNo, a.BarcodeProcessId, c.MoProcessId, d.ProcessId, e.ProcessNo, d.ProcessAlias
                            FROM MES.QcRecord a
                                LEFT JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                LEFT JOIN MES.BarcodeProcess c On a.BarcodeProcessId = c.BarcodeProcessId
                                LEFT JOIN MES.MoProcess d ON c.MoProcessId = d.MoProcessId
                                LEFT JOIN MES.Process e ON d.ProcessId = e.ProcessId
                            WHERE a.QcRecordId = @QcRecordId";
                    dynamicParameters.Add("QcRecordId", QcRecordId);
                    var barcodeResult = sqlConnection.Query(sql, dynamicParameters);
                    string QcRecordBarcodeNo = "";
                    string QcRecordProcessNo = "";
                    string QcRecordProcessAlias = "";

                    foreach (var item in barcodeResult)
                    {
                        QcRecordBarcodeNo = item.BarcodeNo;
                        QcRecordProcessNo = item.ProcessNo;
                        QcRecordProcessAlias = item.ProcessAlias;
                    }
                    #endregion

                    #region //sql result 組成 dhx excel 套件 json 格式 -- WuTc 2024-05-16                    
                    List<string> cellList = new List<string>() { "A1", "B1", "C1", "D1", "E1", "F1", "G1", "H1", "I1", "J1", "K1" };
                    List<string> valueList = new List<string>() { "序號", "球標", "檢測項目", "檢測備註", "設計值", "上公差", "下公差", "單位", "量測設備", "Z軸", "量測人員" };
                    List<string> formatList = new List<string>() { "common", "common", "common", "common", "common", "common", "common", "common", "common", "common", "common" };
                    List<string> cssList = new List<string>() { "title-class", "title-class", "title-class", "title-class", "title-class", "title-class", "title-class", "title-class", "title-class", "title-class", "title-class" };

                    //套件的 json 格式以列排序，所以先放刻字流水號或是穴號到第一列的尾端
                    int dataCount = 11;
                    string lastSerial = "";
                    foreach (var item in result)
                    {
                        string serial = item.serialCode;
                        string inputType = item.InputType;

                        if (lastSerial != "" && serial != lastSerial)
                        {
                            break;
                        }

                        dataCount += 1;
                        string columnWord = NunberToChar(dataCount);
                        int letteringSeq = item.ItemSeq ?? 0;
                        string cavity = item.Cavity;
                        string lotNumber = item.LotNumber;
                        string barcodeNo = item.BarcodeNo;

                        cellList.Add(columnWord + "1");
                        formatList.Add("common");
                        cssList.Add("cave-lettering");
                        if (inputType == "Lettering")
                        {
                            valueList.Add(letteringSeq.ToString()); //刻字
                        }
                        else if (inputType == "Cavity")
                        {
                            valueList.Add(cavity); //穴號
                        }
                        else if (inputType == "LotNumber")
                        {
                            valueList.Add(lotNumber); //批號
                        }
                        else if (inputType == "BarcodeNo")
                        {
                            valueList.Add(barcodeNo); //條碼
                        }

                        lastSerial = serial;
                    }

                    //再放第二列開始的量測數據
                    dataCount = 11;
                    int serialCount = 1;
                    lastSerial = "";
                    foreach (var item in result)
                    {
                        string measureValue = "";
                        string serialCode = "";
                        string ballMark = "";
                        string qcitemName = "";
                        string qcitemDesc = "";
                        string machineName = "";
                        string unit = "";
                        string design = "";
                        string usl = "";
                        string lsl = "";
                        string zaxis = "";
                        string surveyor = "";
                        string valueResult = "";
                        float n;

                        if  (item.QcUserNo != "")
                        {
                            surveyor = item.QcUserNo + " " + item.QcUserName;
                        }
                        else
                        {
                            surveyor = item.CreateUserNo + " " + item.CreateUserName;
                        }
                        
                        serialCode = item.serialCode;
                        ballMark = item.BallMark;
                        qcitemName = item.QcItemName;
                        qcitemDesc = item.QcItemDesc;
                        machineName = item.MachineName;
                        design = item.DesignValue;
                        usl = item.UpperTolerance;
                        lsl = item.LowerTolerance;
                        unit = item.Unit;
                        zaxis = item.ZAxis == 0 ? "" : item.ZAxis.ToString();
                        measureValue = item.MeasureValue;

                        bool measureResult = float.TryParse(measureValue, out n);
                        bool designResult = float.TryParse(design, out n);
                        bool uslResult = float.TryParse(usl, out n);
                        bool lslResult = float.TryParse(lsl, out n);

                        if (measureResult && designResult && uslResult && lslResult)
                        {
                            if (float.Parse(measureValue) > (float.Parse(design) + float.Parse(usl)) || float.Parse(measureValue) < (float.Parse(design) + float.Parse(lsl)))
                            {
                                valueResult = "design-value-red";
                            }
                            else
                            {
                                valueResult = "design-value-blue"; 
                            }
                        }
                        else
                        {
                            valueResult = "design-value-blue";
                        }

                        if (serialCode != lastSerial)
                        {
                            serialCount += 1;
                            //CELLS
                            cellList.Add("A" + serialCount);
                            cellList.Add("B" + serialCount);
                            cellList.Add("C" + serialCount);
                            cellList.Add("D" + serialCount);
                            cellList.Add("E" + serialCount);
                            cellList.Add("F" + serialCount);
                            cellList.Add("G" + serialCount);
                            cellList.Add("H" + serialCount);
                            cellList.Add("I" + serialCount);
                            cellList.Add("J" + serialCount);
                            cellList.Add("K" + serialCount);

                            //value & format
                            valueList.Add(serialCode); //序號
                            formatList.Add("common");
                            cssList.Add("left-Value");
                            valueList.Add(ballMark); //球標
                            formatList.Add("common");
                            cssList.Add("left-Value");
                            valueList.Add(qcitemName); //檢測項目
                            formatList.Add("common");
                            cssList.Add("left-Value");
                            valueList.Add(qcitemDesc); //檢測備註
                            formatList.Add("common");
                            cssList.Add("left-Value");
                            valueList.Add(design); //設計值
                            formatList.Add("number");
                            cssList.Add("left-Value");
                            valueList.Add(usl); //上限
                            formatList.Add("number");
                            cssList.Add("left-Value");
                            valueList.Add(lsl); //下限
                            formatList.Add("number");
                            cssList.Add("left-Value");
                            valueList.Add(unit); //單位
                            formatList.Add("common");
                            cssList.Add("left-Value");
                            valueList.Add(machineName); //量測設備
                            formatList.Add("common");
                            cssList.Add("left-Value");
                            valueList.Add(zaxis); //Z軸
                            formatList.Add("znumber");
                            cssList.Add("left-Value");
                            valueList.Add(surveyor);//量測人員
                            formatList.Add("common");
                            cssList.Add("left-Value");

                            dataCount = 11;
                        }
                        dataCount += 1;
                        string columnWord = NunberToChar(dataCount);
                        valueList.Add(measureValue); //量測數據
                        cellList.Add(columnWord + serialCount);
                        formatList.Add("number");
                        cssList.Add(valueResult);
                        lastSerial = serialCode;
                    }

                    //數字轉字母，用ASCII碼轉換
                    string NunberToChar(int number)
                    {
                        var stword = "";
                        System.Text.ASCIIEncoding asciiEncoding = new System.Text.ASCIIEncoding();

                        if (number > 26)
                        {
                            int numU = number % 26;
                            int numT = number / 26;
                            if (numU == 0)
                            {
                                numU = 26;
                                numT -= 1;
                            }
                            stword = asciiEncoding.GetString(new byte[] { (byte)(numT + 64) }) + asciiEncoding.GetString(new byte[] { (byte)(numU + 64) });
                        }
                        else
                        {
                            int num = number + 64;
                            byte[] btNumber = new byte[] { (byte)num };
                            stword = asciiEncoding.GetString(btNumber);
                        }
                        return stword;
                    }
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = new { result, cellList, valueList, formatList, cssList, QcRecordBarcodeNo, QcRecordProcessNo, QcRecordProcessAlias }
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcRecordFileForPicture -- 取得量測記錄檔案(限定PNG格式) -- Ann 2023-04-21
        public string GetQcRecordFileForPicture(int QcRecordId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.FileId, b.FileName, b.FileSize
                            FROM MES.QcRecordFile a
                            INNER JOIN BAS.[File] b ON a.FileId = b.FileId
                            WHERE a.QcRecordId = @QcRecordId
                            AND (b.FileExtension LIKE '%PNG%' OR b.FileExtension LIKE '%png%' OR b.FileExtension LIKE '%JPG%' OR b.FileExtension LIKE '%jpg%')";
                    dynamicParameters.Add("QcRecordId", QcRecordId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcRecordFile -- 取得量測記錄檔案 -- Ann 2023-10-16
        public string GetQcRecordFile(int QcRecordId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT b.FileId, b.[FileName] + b.FileExtension FileName, b.FileSize,a.PhysicalPath
                            FROM MES.QcRecordFile a 
                            LEFT JOIN BAS.[File] b ON a.FileId = b.FileId
                            WHERE a.QcRecordId = @QcRecordId";
                    dynamicParameters.Add("QcRecordId", QcRecordId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMeasurementRecord -- 取得量測記錄資料-- Zoey 2023.01.16
        public string GetMeasurementRecord(string BarcodeNo, string WoErpFullNo, string WoSeq, int ProcessId, string QcType
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.QcRecordId";
                    sqlQuery.distinct = true;
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.QcType, a.MoId
                        , d.WoErpPrefix + '-' + d.WoErpNo WoErpFullNo
                        , e.MtlItemNo, e.MtlItemName, e.MtlItemSpec, d.PlanQty
                        , CASE WHEN a.QcStatus IS NULL THEN b.QcStatus ELSE a.QcStatus END QcStatus
                        , CASE WHEN a.SystemStatus IS NULL THEN b.SystemStatus ELSE a.SystemStatus END SystemStatus
                        , ISNULL(CONVERT(VARCHAR, CASE WHEN a.PassQty IS NULL AND a.NgQty IS NULL THEN b.PassQty + b.NgQty ELSE a.PassQty + a.NgQty END), '無') BarcodeQty
                        , ISNULL(b.QcBarcodeId, '') QcBarcodeId
                        , ISNULL(f.ProcessAlias, '') ProcessAlias
                        , g.UserName
                        , ISNULL((
                            SELECT e.MoId, e.QcType, ISNULL(eg.BarcodeNo, '') BarcodeNo
                            , eb.QcItemName
                            , ed.MachineName
                            , ea.MeasureValue, ea.QcResult
                            , eh.UserName
                            , CONVERT(varchar(100), ea.CreateDate, 121) CreateDate
                            FROM MES.QcRecord e
                            INNER JOIN QMS.QcMeasureData ea ON ea.QcRecordId = e.QcRecordId
                            INNER JOIN QMS.QcItem eb ON eb.QcItemId = ea.QcItemId
                            INNER JOIN QMS.QmmDetail ec ON ec.QmmDetailId = ea.QmmDetailId
                            INNER JOIN MES.Machine ed ON ed.MachineId = ec.MachineId
                            LEFT JOIN MES.QcBarcode ef ON ef.QcRecordId = e.QcRecordId
                            LEFT JOIN MES.Barcode eg ON eg.BarcodeId = ef.BarcodeId
                            LEFT JOIN BAS.[User] eh ON eh.UserId = ea.CreateBy
                            WHERE e.QcRecordId = ea.QcRecordId AND e.MoId = a.MoId
                            FOR JSON PATH, ROOT('data')
                        ), '') MeasureDetail";
                    sqlQuery.mainTables =
                        @"FROM MES.QcRecord a
                        LEFT JOIN MES.QcBarcode b ON b.QcRecordId = a.QcRecordId
                        INNER JOIN MES.ManufactureOrder c ON c.MoId = a.MoId
                        INNER JOIN MES.WipOrder d ON d.WoId = c.WoId
                        INNER JOIN PDM.MtlItem e ON e.MtlItemId = d.MtlItemId
                        LEFT JOIN MES.MoProcess f ON f.MoProcessId = a.MoProcessId
                        INNER JOIN BAS.[User] g ON g.UserId = a.CreateBy";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND d.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (d.WoErpPrefix + '-' + d.WoErpNo) LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessId", @" AND f.ProcessId = @ProcessId", ProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcType", @" AND a.QcType = @QcType", QcType);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoSeq", @" AND c.WoSeq = @WoSeq", WoSeq);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.QcRecordId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetTimeout -- 取得頁面刷新時間 -- Ann 2023-11-23
        public string GetTimeout(string TypeSchema)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TypeId, a.TypeSchema, a.TypeNo
                            FROM BAS.[Type] a
                            WHERE a.TypeSchema = @TypeSchema";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TypeSchema", @" AND a.TypeSchema = @TypeSchema", TypeSchema);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQryProductionHistory //數量生產歷史
        public string GetQryProductionHistory(int MoId, int ProcessId, string ProdStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {


                    dynamicParameters = new DynamicParameters();
                    sql = @"select b.ProcessAlias,c.MachineDesc,c.MachineName,d.UserNo, d.UserName, a.ProdStatus,a.Quantity,a.CauseNo, ISNULL(e.CauseName, '') CauseName, FORMAT(a.InputDate, 'yyyy-MM-dd HH:mm:ss') InputDate
                    from MES.MoProcessTransaction a
                    inner join MES.MoProcess b on b.MoId = a.MoId and b.MoProcessId = a.MoProcessId
                    inner join MES.Machine c on c.MachineId = a.MachineId
                    inner join BAS.[User] d on d.UserId  = a.CreateBy
                    left join QMS.DefectCause e ON e.CauseNo = a.CauseNo
                    WHERE a.MoId = @MoId and b.ProcessId = @ProcessId
                    ";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("ProcessId", ProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProdStatus", @" and a.ProdStatus = @ProdStatus", ProdStatus);
                    sql += @" order by a.MoProcessId ASC";
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProductionComponent -- 取得上料生產資料-- Daiyi 2023.03.31
        public string GetProductionComponent(int MoId, string WoErpFullNo, string MtlItemNo, string MtlItemName
            , string BarcodeNo, string BarcodeProcessNo, string BarcodeProcessName, string BarcodeComponentNo, string BarcodeComponentName
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.MoId";
                    sqlQuery.auxKey = ", a.DetailData";
                    sqlQuery.columns =
                        @", (b.WoErpPrefix + '-'  + b.WoErpNo) WoErpFullNo
                        , c.MtlItemNo, c.MtlItemName";
                    sqlQuery.mainTables =
                        @"FROM MES.ManufactureOrder a
                        LEFT JOIN MES.WipOrder b ON b.WoId = a.WoId
                        INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId";
                    string queryTable =
                        @"FROM (
                            SELECT a.MoId, b.CompanyId, (b.WoErpPrefix + '-'  + b.WoErpNo) WoErpFullNo
                            , c.MtlItemNo, c.MtlItemName
                                , (
                                    SELECT g.MrId, g.MrDetailId, (g1.MrErpPrefix + '-' + g1.MrErpNo) MrErpFullNo, g.MrSequence
                                    , ge.MtlItemNo, ge.MtlItemName
                                    , ISNULL(gb.BarcodeNo, '') BarcodeNo
                                    , ISNULL(gg.ItemNo, '') BarcodeProcessNo, ISNULL(gg.ItemValue, '') BarcodeProcessName
                                    , ISNULL(gi.ItemNo, '') BarcodeComponentNo, ISNULL(gi.ItemValue, '') BarcodeComponentName
                                    , ISNULL(gj.StatusName, '') BarcodeStatus
                                    FROM MES.MrDetail g
                                    LEFT JOIN MES.MaterialRequisition g1 ON g1.MrId = g.MrId
                                    LEFT JOIN MES.MrBarcodeRegister ga ON ga.MrDetailId = g.MrDetailId
                                    LEFT JOIN MES.Barcode gb ON gb.BarcodeNo = ga.BarcodeNo
                                    INNER JOIN MES.ManufactureOrder gc ON gc.MoId = g.MoId
                                    INNER JOIN MES.WipOrder gd ON gd.WoId = gc.WoId
                                    INNER JOIN PDM.MtlItem ge ON ge.MtlItemId = g.MtlItemId
                                    INNER JOIN MES.WoDetail gk ON gk.WoId = gd.WoId AND gk.MtlItemId = ge.MtlItemId
                                    LEFT JOIN MES.BarcodeAttribute gg ON gg.BarcodeId = gb.BarcodeId
                                    LEFT JOIN MES.BarcodeComponent gh ON gh.AssemblyBarcodeId = gb.BarcodeProcessId
                                    LEFT JOIN MES.BarcodeComponentAttribute gi ON gi.BarcodeComponentId = gh.BarcodeComponentId
                                    LEFT JOIN BAS.[Status] gj ON gj.StatusNo = gb.BarcodeStatus AND gj.StatusSchema = 'Barcode.BarcodeStatus'
                                    WHERE g.MoId = a.MoId
                                    FOR JSON PATH, ROOT('data')
                                ) DetailData
                            FROM MES.ManufactureOrder a
                            LEFT JOIN MES.WipOrder b ON b.WoId = a.WoId
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId
                        ) a
                        OUTER APPLY (
                            SELECT TOP 1 x.BarcodeNo, x.BarcodeProcessNo, x.BarcodeProcessName, x.BarcodeComponentNo, x.BarcodeComponentName
                            FROM OPENJSON(a.DetailData, '$.data')
                            WITH (
                                BarcodeNo NVARCHAR(60) N'$.BarcodeNo',
                                BarcodeProcessNo NVARCHAR(10) N'$.BarcodeProcessNo',
                                BarcodeProcessName NVARCHAR(100) N'$.BarcodeProcessName',
                                BarcodeComponentNo NVARCHAR(30) N'$.BarcodeComponentNo',
                                BarcodeComponentName NVARCHAR(30) N'$.BarcodeComponentName'
                            ) x
                        ) b";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @" AND a.CompanyId = @CompanyId
                                              AND EXISTS(SELECT TOP 1 1 FROM MES.MoMtlSetting x WHERE x.MoId = a.MoId AND x.ProcessBinding = 'Y')";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND a.WoErpFullNo LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND a.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND a.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND b.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeProcessNo", @" AND b.BarcodeProcessNo LIKE '%' + @BarcodeProcessNo + '%'", BarcodeProcessNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeProcessName", @" AND b.BarcodeProcessName LIKE '%' + @BarcodeProcessName + '%'", BarcodeProcessName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeComponentNo", @" AND b.BarcodeComponentNo LIKE '%' + @BarcodeComponentNo + '%'", BarcodeComponentNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeComponentName", @" AND b.BarcodeComponentName LIKE '%' + @BarcodeComponentName + '%'", BarcodeComponentName);


                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetToolTransaction -- 取得工具異動資料 -- Ellie 2023.04.07
        public string GetToolTransaction(int ToolTransactionsId, string ToolNo, string ToolModelNo
            , int ToolClassId, int ToolCategoryId, string TransactionType
            , int ToolInventoryId, int ToolLocatorId
            , string StartDate, string EndDate, string TimeStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.ToolTransactionsId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", d.ToolNo, e.ToolModelNo, g.ToolClassName, f.ToolCategoryName
                        , i.TypeName TransactionTypeName
                        , FORMAT(a.CreateDate,'yyyy-MM-dd HH:mm') AS CreateDate, c.ToolInventoryName, b.ToolLocatorName
                        , ISNULL(h.UserName, '') UserName
                        , a.TransactionReason,a.ProcessingQty";
                    sqlQuery.mainTables =
                        @"FROM MES.ToolTransactions a 
                        INNER JOIN MES.ToolLocator b ON b.ToolLocatorId = a.ToolLocatorId 
                        INNER JOIN MES.ToolInventory c ON c.ToolInventoryId = b.ToolInventoryId
                        INNER JOIN MES.WorkShop c1 ON c1.ShopId = c.ShopId
                        INNER JOIN MES.Tool d ON d.ToolId = a.ToolId
                        INNER JOIN MES.ToolModel e ON e.ToolModelId = d.ToolModelId
                        INNER JOIN MES.ToolCategory f ON f.ToolCategoryId = e.ToolCategoryId	
                        INNER JOIN MES.ToolClass g ON g.ToolClassId = f.ToolClassId
                        LEFT JOIN BAS.[User] h ON h.UserId = a.TraderId
                        INNER JOIN BAS.[Type] i ON i.TypeSchema = 'ToolTransactions.TransactionType' AND a.TransactionType = i.TypeNo";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c1.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    if (TimeStatus == "now")
                    {
                        sqlQuery.mainTables +=
                            @" OUTER APPLY (
                            SELECT TOP 1 ja.ToolTransactionsId
                            FROM MES.ToolTransactions ja
                            WHERE ja.ToolId = a.ToolId
                            ORDER BY ja.CreateDate DESC, ja.ToolTransactionsId DESC
                        ) j";
                        queryCondition = @" AND a.ToolTransactionsId = j.ToolTransactionsId";
                    }



                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToolTransactionsId", @" AND a.ToolTransactionsId = @ToolTransactionsId", ToolTransactionsId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToolNo", @" AND d.ToolNo LIKE '%' + @ToolNo + '%'", ToolNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToolModelNo", @" AND e.ToolModelNo LIKE '%' + @ToolModelNo + '%'", ToolModelNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToolClassId", @" AND g.ToolClassId = @ToolClassId", ToolClassId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToolCategoryId", @" AND f.ToolCategoryId = @ToolCategoryId", ToolCategoryId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransactionType", @" AND a.TransactionType = @TransactionType", TransactionType);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToolInventoryId", @" AND c.ToolInventoryId = @ToolInventoryId", ToolInventoryId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToolLocatorId", @" AND b.ToolLocatorId = @ToolLocatorId", ToolLocatorId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.CreateDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.CreateDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.ToolTransactionsId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetDeptA372 取得光薄報表資料 -- Mark 2023.09.11, OK TO 套用 數量生產歷史     
        public string GetDeptA372(string EndDate, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = $@"
                        SELECT *
                        FROM
                        (
                            SELECT
                                [ProcessNo]
                                ,[ProcessName]
                                ,[ProcessAlias]
                                ,[StartDateDayOnly]	
                                ,MtlItemNo
	                            ,MtlItemName
                                ,[DeptNo]
	                            ,[DeptName]
	                            ,[StartUserNo]
	                            ,[StartUserName]
	                            ,[MachineName]
                                ,Sum([StationQty]) SumQty
                                ,Sum(DiffSec) SumSec
                                ,Count(*) RowCnt
                                ,Count(DISTINCT [BarcodeNo]) DistinctBarcodeCnt
                            FROM 
                            (    
                                SELECT	
                                    u2.ProcessNo, u2.ProcessName,
                                    T10.BarcodeNo,
                                    T10.BarcodeQty,
                                    T9.MtlItemNo,
                                    T9.MtlItemName,
                                    xb.MtlItemId,
                                    T8.ModeNo,
                                    T8.ModeName,
                                    xa.ModeId,
                                    t.MoId, 
                                    t.BarcodeId, 
                                    t.BarcodeProcessId, 
                                    t.ProdStatus, 
                                    t.CycleTime, 
                                    t.MoProcessId, 
                                    t.StationQty,
					                CAST(t.StartDate AS DATE) AS StartDateDayOnly,
					                DATEDIFF(SECOND, t.StartDate, t.FinishDate) AS DiffSec,
                                    FORMAT(t.StartDate, 'yyyy-MM-dd HH:mm:ss') AS StrStartDate, 
                                    FORMAT(t.FinishDate, 'yyyy-MM-dd HH:mm:ss') AS StrFinishDate,
                                    u.ProcessAlias,
                                    v.MachineName,
					                x2.DepartmentNo DeptNo,
					                x2.DepartmentName DeptName,
                                    w.UserNo AS StartUserNo, 
                                    w.UserName AS StartUserName,
                                    x.UserNo AS FinishUserNo, 
                                    x.UserName AS FinishUserName,
                                    xb.WoErpPrefix + '-' + xb.WoErpNo AS WoErpFullNo
                                FROM MES.BarcodeProcess t
                                INNER JOIN MES.MoProcess u ON u.MoProcessId = t.MoProcessId
				                INNER JOIN MES.Process u2 ON u2.ProcessId = u.ProcessId
                                INNER JOIN MES.Machine v ON v.MachineId = t.MachineId
                                INNER JOIN BAS.[User] w ON w.UserId = t.StartUserId
                                INNER JOIN BAS.[User] x ON x.UserId = t.FinishUserId
				                INNER JOIN BAS.[Department] x2 ON x2.DepartmentId = x.DepartmentId
                                INNER JOIN MES.ManufactureOrder xa ON t.MoId = xa.MoId
                                INNER JOIN MES.WipOrder xb ON xa.WoId = xb.WoId
				                INNER JOIN MES.ProdMode T8 ON T8.ModeId = xa.ModeId
				                INNER JOIN PDM.MtlItem T9 ON T9.MtlItemId = xb.MtlItemId
				                INNER JOIN [MES].[Barcode] T10 ON T10.BarcodeId= t.BarcodeId
                            ) T1
                            WHERE 
                                DeptNo='A372'
                            GROUP BY 
                                [ProcessNo]
                                ,[ProcessName]
                                ,[ProcessAlias]
                                ,[StartDateDayOnly]	
                                ,MtlItemNo
		                        ,MtlItemName
                                ,[DeptNo]
                                ,[DeptName]
                                ,[StartUserNo]
                                ,[StartUserName]
                                ,[MachineName]
                        ) TT
                        WHERE TT.StartDateDayOnly='{EndDate}'";
                    //dynamicParameters.Add("MoId", 1);
                    //dynamicParameters.Add("ProcessId", ProcessId);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProdStatus", @" and a.ProdStatus = @ProdStatus", ProdStatus);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProdStatus", @" and TT.DeptNo='A372'", ProdStatus);
                    sql += @" order by ProcessName,[ProcessAlias],[StartUserName],[MachineName]";
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetMirrorCoatingMold 取得鍍膜塑膠鏡片
        public string GetMirrorCoatingMold(
            string MtlItemNo, string MtlItemName, string ErpNo, string BarcodeNo,
            string MirrorMoldingStartDate, string MirrorMoldingEndDate,
            string PlatingMoldStartDate, string PlatingMoldEndDate, int MachineId,
            string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.BarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.BarcodeNo,a.BarcodeQty
                            , c.WoErpPrefix + '-' + c.WoErpNo WoErpFullNo
                            , d.MtlItemNo,d.MtlItemName
                            ,e.CavityItemValue
                            ,f.CavityFinishDate
                            ,g.PotNumberItemValue
                            ,h.PotNumberFinishDate,h.MachineDesc";
                    sqlQuery.mainTables =
                        @"FROM MES.Barcode a
                            INNER JOIN MES.ManufactureOrder b ON b.MoId = a.MoId
                            INNER JOIN MES.WipOrder c ON c.WoId = b.WoId
                            INNER JOIN PDM.MtlItem d ON d.MtlItemId = c.MtlItemId
                            INNER JOIN (
                                SELECT x.ItemNo, x.ItemValue AS CavityItemValue,x.BarcodeId
                                FROM MES.BarcodeAttribute x
                                WHERE  ItemNo='Cavity'        
                            )e ON e.BarcodeId=a.BarcodeId
                            INNER JOIN (
                                SELECT FORMAT(t.FinishDate, 'yyyy-MM-dd HH:mm:ss') CavityFinishDate,t.BarcodeId          
                                FROM MES.BarcodeProcess t            
                                INNER JOIN MES.MoProcess u ON u.MoProcessId = t.MoProcessId                    
                                INNER JOIN MES.Machine v ON v.MachineId = t.MachineId
                                INNER JOIN BAS.[User] w ON w.UserId = t.StartUserId
                                INNER JOIN BAS.[User] x ON x.UserId = t.FinishUserId       
                                WHERE  u.ProcessId=62
                            )f ON f.BarcodeId=a.BarcodeId
                            INNER JOIN (
                                SELECT x.ItemNo, x.ItemValue AS PotNumberItemValue,x.BarcodeId
                                FROM MES.BarcodeAttribute x
                                WHERE  ItemNo='PotNumber'        
                            )g ON g.BarcodeId=a.BarcodeId
                            INNER JOIN (
                                SELECT FORMAT(t.FinishDate, 'yyyy-MM-dd HH:mm:ss') PotNumberFinishDate,t.BarcodeId,v.MachineDesc,v.MachineId                                           
                                FROM MES.BarcodeProcess t            
                                INNER JOIN MES.MoProcess u ON u.MoProcessId = t.MoProcessId                    
                                INNER JOIN MES.Machine v ON v.MachineId = t.MachineId
                                INNER JOIN BAS.[User] w ON w.UserId = t.StartUserId
                                INNER JOIN BAS.[User] x ON x.UserId = t.FinishUserId       
                                WHERE  u.ProcessId=32
                            )h ON h.BarcodeId=a.BarcodeId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND d.MtlItemNo LIKE '%' + @MtlItemNo+ '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND d.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ErpNo", @" AND c.WoErpPrefix + '-' + c.WoErpNo LIKE '%' + @ErpNo + '%'", ErpNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MirrorMoldingStartDate", @" AND f.CavityFinishDate >= @MirrorMoldingStartDate ", MirrorMoldingStartDate.Length > 0 ? Convert.ToDateTime(MirrorMoldingStartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MirrorMoldingEndDate", @" AND f.CavityFinishDate <= @MirrorMoldingEndDate ", MirrorMoldingEndDate.Length > 0 ? Convert.ToDateTime(MirrorMoldingEndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PlatingMoldStartDate", @" AND h.PotNumberFinishDate >= @PlatingMoldStartDate ", PlatingMoldStartDate.Length > 0 ? Convert.ToDateTime(PlatingMoldStartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PlatingMoldEndDate", @" AND h.PotNumberFinishDate <= @PlatingMoldEndDate ", PlatingMoldEndDate.Length > 0 ? Convert.ToDateTime(PlatingMoldEndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineId", @" AND h.MachineId = @MachineId", MachineId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MoId,a.BarcodeId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeTransfer -- 取得條碼轉移紀錄 -- Ann 2023-07-10
        public string GetBarcodeTransfer(string FromBarcodeNo, string ToBarcodeNo, string WoErpFullNo, string TransferStartDate, string TransferEndDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.TransactionId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", FORMAT(a.TransactionDate, 'yyyy-MM-dd HH:mm:ss') TransactionDate, a.TransactionQty
                        , b.MoId, b.MoProcessId
                        , c.BarcodeNo FromBarcodeNo
                        , d.BarcodeNo ToBarcodeNo
                        , e.ProcessAlias
                        , f.WoSeq
                        , g.WoErpPrefix, g.WoErpNo
                        , h.UserNo, h.UserName
                        , (
                            SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                            FROM MES.BarcodeAttribute x
                            INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE x.BarcodeId = a.FromBarcodeId
                            FOR JSON PATH, ROOT('data')
                        ) FromBarcodeItemValue
                        , (
                            SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                            FROM MES.BarcodeAttribute x
                            INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE x.BarcodeId = a.ToBarcodeId
                            FOR JSON PATH, ROOT('data')
                        ) ToBarcodeItemValue";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodeTransfer a 
                        LEFT JOIN MES.BarcodeProcess b ON a.FromBarcodeProcessId = b.BarcodeProcessId
                        INNER JOIN MES.Barcode c ON a.FromBarcodeId = c.BarcodeId
                        INNER JOIN MES.Barcode d ON a.ToBarcodeId = d.BarcodeId 
                        INNER JOIN MES.MoProcess e ON b.MoProcessId = e.MoProcessId
                        INNER JOIN MES.ManufactureOrder f ON b.MoId = f.MoId
                        INNER JOIN MES.WipOrder g ON f.WoId = g.WoId
                        INNER JOIN BAS.[User] h ON a.CreateBy = h.UserId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FromBarcodeNo", @" AND c.BarcodeNo LIKE '%' + @FromBarcodeNo + '%'", FromBarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ToBarcodeNo", @" AND d.BarcodeNo LIKE '%' + @ToBarcodeNo + '%'", ToBarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (g.WoErpPrefix + '-' + g.WoErpNo +  '(' + CONVERT(VARCHAR(10), f.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferStartDate", @" AND a.TransactionDate >= @TransferStartDate ", TransferStartDate.Length > 0 ? Convert.ToDateTime(TransferStartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferEndDate", @" AND a.TransactionDate <= @TransferEndDate ", TransferEndDate.Length > 0 ? Convert.ToDateTime(TransferEndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcBarcode -- 取得量測判定資料 -- Ann 2023-07-21
        public string GetQcBarcode(int QcRecordId, string BarcodeNo, string QcStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (QcRecordId <= 0) throw new SystemException("量測單號不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.QcBarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.QcRecordId, a.BarcodeId, a.PassQty, a.NgQty, a.SystemStatus, a.QcStatus, a.Remark
                        , c.UserNo, c.UserName
                        , d.BarcodeNo
                        , f.StatusNo QcStatusNo, f.StatusName QcStatusName
                        , (
                            SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                            FROM MES.BarcodeAttribute x
                            INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE x.BarcodeId = a.BarcodeId
                            FOR JSON PATH, ROOT('data')
                        ) ItemValue";
                    sqlQuery.mainTables =
                        @"FROM MES.QcBarcode a 
                        INNER JOIN MES.QcRecord b ON a.QcRecordId = b.QcRecordId
                        INNER JOIN BAS.[User] c ON a.QcUserId = c.UserId
                        INNER JOIN MES.Barcode d ON a.BarcodeId = d.BarcodeId
                        LEFT JOIN MES.BarcodeAttribute e ON a.BarcodeId = e.BarcodeId AND e.ItemNo = 'Lettering'
                        INNER JOIN BAS.[Status] f ON a.QcStatus = f.StatusNo AND f.StatusSchema = 'BarcodeQcRecord.QcStatus'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.QcRecordId = @QcRecordId";
                    dynamicParameters.Add("QcRecordId", QcRecordId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND (d.BarcodeNo LIKE '%' + @BarcodeNo + '%' OR e.ItemValue LIKE '%' + @BarcodeNo + '%')", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcStatus", @" AND a.QcStatus = @QcStatus", QcStatus);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.QcBarcodeId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWipBarcode -- 取得特定站別在製條碼 -- Ann 2023-08-14
        public string GetWipBarcode(int MoProcessId, string WipStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (MoProcessId <= 0) throw new SystemException("製令製程不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    if (WipStatus == "未開工")
                    {
                        sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                                , b.ProcessAlias CurrentProcessAlias
                                , ISNULL(d.ProcessAlias, '已完工') NextProcessAlias
                                , e.TypeName CurrentProdStatusName
                                , f.StatusName BarcodeStatusName
                                , g.TrayNo
                                , (
                                    SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                    , CASE WHEN LEN(LTRIM(RTRIM(x.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(x.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                                    FROM MES.BarcodeAttribute x
                                    INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    WHERE x.BarcodeId = a.BarcodeId AND a.ParentBarcode IS NULL
                                    FOR JSON PATH, ROOT('data')
                                ) ItemValue
                                FROM MES.Barcode a
                                INNER JOIN MES.MoProcess b ON b.MoProcessId = a.CurrentMoProcessId
                                LEFT JOIN MES.MoProcess d ON a.NextMoProcessId = d.MoProcessId
                                INNER JOIN BAS.[Type] e ON a.CurrentProdStatus  = e.TypeNo AND e.TypeSchema = 'Barcode.CurrentProdStatus'
                                INNER JOIN BAS.[Status] f ON a.BarcodeStatus = f.StatusNo AND f.StatusSchema = 'Barcode.BarcodeStatus'
                                LEFT JOIN MES.Tray g ON a.BarcodeNo = g.BarcodeNo
                                WHERE (a.CurrentMoProcessId != @MoProcessId AND a.NextMoProcessId = @MoProcessId AND a.ParentBarcode IS NULL)
                                OR (b.SortNumber = 1 AND a.CurrentMoProcessId = @MoProcessId AND a.NextMoProcessId = @MoProcessId)
                                AND NOT EXISTS (
                                    SELECT TOP 1 1 FROM MES.BarcodeProcess c
                                    WHERE c.BarcodeId = a.BarcodeId AND c.MoProcessId = b.MoProcessId AND a.ParentBarcode IS NULL
                                )
                                ORDER BY a.BarcodeId DESC";
                    }
                    else if (WipStatus == "開工中")
                    {
                        sql = @"SELECT b.BarcodeNo, b.BarcodeQty, b.CurrentProdStatus, b.BarcodeStatus
                                , c.ProcessAlias CurrentProcessAlias
                                , ISNULL(d.ProcessAlias, '已完工') NextProcessAlias
                                , e.TypeName CurrentProdStatusName
                                , f.StatusName BarcodeStatusName
                                , g.TrayNo
                                , (
                                    SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                    , CASE WHEN LEN(LTRIM(RTRIM(x.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(x.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                                    FROM MES.BarcodeAttribute x
                                    INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    WHERE x.BarcodeId = a.BarcodeId
                                    FOR JSON PATH, ROOT('data')
                                ) ItemValue
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId AND b.ParentBarcode IS NULL
                                INNER JOIN MES.MoProcess c ON c.MoProcessId = b.CurrentMoProcessId
                                LEFT JOIN MES.MoProcess d ON b.NextMoProcessId = d.MoProcessId
                                INNER JOIN BAS.[Type] e ON b.CurrentProdStatus  = e.TypeNo AND e.TypeSchema = 'Barcode.CurrentProdStatus'
                                INNER JOIN BAS.[Status] f ON b.BarcodeStatus = f.StatusNo AND f.StatusSchema = 'Barcode.BarcodeStatus'
                                LEFT JOIN MES.Tray g ON b.BarcodeNo = g.BarcodeNo
                                WHERE a.MoProcessId = @MoProcessId AND b.ParentBarcode IS NULL
                                AND a.FinishDate IS NULL
                                ORDER BY b.BarcodeId DESC";
                    }
                    else if (WipStatus == "已完工")
                    {
                        sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                                , b.ProcessAlias CurrentProcessAlias
                                , ISNULL(c.ProcessAlias, '已完工') NextProcessAlias
                                , d.TypeName CurrentProdStatusName
                                , e.StatusName BarcodeStatusName
                                , f.TrayNo
                                , (
                                    SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                    , CASE WHEN LEN(LTRIM(RTRIM(x.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(x.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                                    FROM MES.BarcodeAttribute x
                                    INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    WHERE x.BarcodeId = a.BarcodeId AND a.ParentBarcode IS NULL
                                    FOR JSON PATH, ROOT('data')
                                ) ItemValue
                                FROM MES.Barcode a
                                INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
                                LEFT JOIN MES.MoProcess c ON a.NextMoProcessId = c.MoProcessId
                                INNER JOIN BAS.[Type] d ON a.CurrentProdStatus  = d.TypeNo AND d.TypeSchema = 'Barcode.CurrentProdStatus'
                                INNER JOIN BAS.[Status] e ON a.BarcodeStatus = e.StatusNo AND e.StatusSchema = 'Barcode.BarcodeStatus'
                                LEFT JOIN MES.Tray f ON a.BarcodeNo = f.BarcodeNo
                                WHERE a.CurrentMoProcessId = @MoProcessId AND a.NextMoProcessId != a.CurrentMoProcessId AND a.ParentBarcode IS NULL
                                ORDER BY a.BarcodeId DESC";
                    }
                    else
                    {
                        throw new SystemException("查詢方式不被允許!!");
                    }

                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    var result = sqlConnection.Query(sql ,dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetUserEventHistory -- 取得人員事件歷程 -- Xuan 2023-08-16
        public string GetUserEventHistory(string DepartmentName, string UserName, string StartDate, string FinishDate, string LastModifiedDate, int LastModifiedBy, string LastModifiedUserName, int DepartmentId, int UserId, string UserEventItemName, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.UserEventId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns = @",d.DepartmentId
                                         ,d.DepartmentName
                                         ,b.UserEventItemName
                                         ,a.StartDate
                                         ,a.FinishDate
                                         ,FORMAT((a.FinishDate - a.StartDate), 'HH:mm:ss') AS DuringTime
                                         ,a.LastModifiedBy
                                         ,e.UserName LastModifiedUserName
                                         ,COUNT(*) OVER () AS TotalRowCount";
                    sqlQuery.mainTables = @"FROM MES.UserEvent a
                                            INNER JOIN MES.UserEventItem b on b.UserEventItemId=a.UserEventItemId
                                            INNER JOIN BAS.[User] e on e.UserId=a.LastModifiedBy
                                            INNER JOIN BAS.Department d on d.DepartmentId=e.DepartmentId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId=@CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DepartmentId", @" AND d.DepartmentId = @DepartmentId", DepartmentId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "LastModifiedBy", @" AND a.LastModifiedBy = @LastModifiedBy", LastModifiedBy);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserEventItemName", @" AND b.UserEventItemName LIKE '%' + REPLACE(@UserEventItemName, ' ', '%') + '%'", UserEventItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.StartDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FinishDate", @" AND a.FinishDate <= @FinishDate ", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineEventHistory -- 取得機台事件歷程 -- Xuan 2023-08-17
        public string GetMachineEventHistory(string MachineName, string MachineDesc, string ShopName, string DuringTime, string UserName, string CreateDate, string StartDate, string FinishDate, int ShopId, int MachineId, string MachineEventName, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MachineEventId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns = @",c.MachineId
                                         ,c.MachineName
                                         ,c.MachineDesc
                                         ,d.ShopId
                                         ,d.ShopName
                                         ,b.MachineEventName
                                         ,FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate
										 ,FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                                         ,(a.FinishDate - a.StartDate) AS DuringTime
                                         ,a.CreateBy
										 ,e.UserName
										 ,FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate";
                    sqlQuery.mainTables = @"FROM MES.MachineEvent a
                                            INNER JOIN MES.MachineEventItem b on b.MachineEventItemId=a.MachineEventItemId
                                            INNER JOIN MES.Machine c on c.MachineId=b.MachineId
                                            INNER JOIN MES.WorkShop d on d.ShopId=c.ShopId
                                            INNER JOIN BAS.[User] e on e.UserId=a.CreateBy";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId=@CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopId", @" AND d.ShopId = @ShopId", ShopId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineId", @" AND c.MachineId = @MachineId", MachineId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineEventName", @" AND b.MachineEventName LIKE '%' + REPLACE(@MachineEventName, ' ', '%') + '%'", MachineEventName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.StartDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FinishDate", @" AND a.FinishDate <= @FinishDate ", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcessEventHistory -- 取得加工事件歷程 -- Xuan 2023-08-17
        public string GetProcessEventHistory(string WoErpFullNo, string MtlItemNo, string StartDate, string FinishDate, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeEventId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns = @",e.WoErpPrefix + '-' + e.WoErpNo WoErpFullNo
                                         ,f.MtlItemId
                                         ,f.MtlItemNo
                                         ,f.MtlItemName
										 ,b.Status
										 ,k.ProcessName
										 ,m.MachineName
                                         ,(
                                         SELECT ai.BarcodeNo
										 ,ah.ModeId,an.TypeName,ab.ProcessEventName
                                         ,aa.LastModifiedBy,aj.UserName
										 ,FORMAT(aa.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate
										 ,FORMAT(aa.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                                         FROM MES.BarcodeProcessEvent aa
										 INNER JOIN MES.ProcessEventItem ab on ab.ProcessEventItemId=aa.ProcessEventItemId
                                         INNER JOIN MES.BarcodeProcess ac on ac.BarcodeProcessId=aa.BarcodeProcessId
                                         INNER JOIN MES.ManufactureOrder ad on ad.MoId=ac.MoId
                                         INNER JOIN MES.WipOrder ae on ae.WoId=ad.WoId
                                         INNER JOIN PDM.MtlItem af on af.MtlItemId=ae.MtlItemId
                                         INNER JOIN MES.ProcessParameter ag on ag.ParameterId=ab.ParameterId
                                         INNER JOIN MES.ProdMode ah on ah.ModeId=ag.ModeId
										 INNER JOIN MES.Barcode ai on ai.BarcodeId=ac.BarcodeId
										 INNER JOIN BAS.[User] aj on aj.UserId=aa.LastModifiedBy
										 INNER JOIN MES.Process ak on ak.ProcessId=ag.ProcessId
										 INNER JOIN MES.Machine am on am.MachineId=ac.MachineId
										 INNER JOIN BAS.Type an on an.TypeNo=ab.ProcessEventType and an.TypeSchema='ProcessEventItem'
                                         WHERE aa.BarcodeEventId = a.BarcodeEventId
                                         AND an.TypeName = '加工前' OR an.TypeName = '加工後'
                                         FOR JSON PATH, ROOT('data')
                                         ) AS ProcessEventDetail";
                    sqlQuery.mainTables = @"FROM MES.BarcodeProcessEvent a
                                            INNER JOIN MES.ProcessEventItem b on b.ProcessEventItemId=a.ProcessEventItemId
                                            INNER JOIN MES.BarcodeProcess c on c.BarcodeProcessId=a.BarcodeProcessId
                                            INNER JOIN MES.ManufactureOrder d on d.MoId=c.MoId
                                            INNER JOIN MES.WipOrder e on e.WoId=d.WoId
                                            INNER JOIN PDM.MtlItem f on f.MtlItemId=e.MtlItemId
                                            INNER JOIN MES.ProcessParameter g on g.ParameterId=b.ParameterId
                                            INNER JOIN MES.ProdMode h on h.ModeId=g.ModeId
											INNER JOIN MES.Barcode i on i.BarcodeId=c.BarcodeId
											INNER JOIN BAS.[User] j on j.UserId=a.LastModifiedBy
											INNER JOIN MES.Process k on k.ProcessId=g.ProcessId
											INNER JOIN MES.Machine m on m.MachineId=c.MachineId
                                            INNER JOIN BAS.Type n ON n.TypeNo = b.ProcessEventType AND n.TypeSchema = 'ProcessEventItem'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId=@CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND e.WoErpPrefix + '-' + e.WoErpNo = @WoErpFullNo ", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (f.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR f.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.StartDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FinishDate", @" AND a.FinishDate <= @FinishDate ", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;


                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeProcessEvent -- 取得條碼過站事件資料 -- Xuan 2023-08-23
        public string GetBarcodeProcessEvent(int UserId, string BarcodeNo, string ProcessEventName, string MtlItemNo, string StartDate, string FinishDate, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "TT.BarcodeNo";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns = @",TT.ProcessAlias,TT.BarcodeProcessDetail";
                    sqlQuery.mainTables = @"FROM
                                            (
                                              SELECT 
                                              DISTINCT  e.BarcodeNo
                                                ,d.ProcessAlias 
                                                ,(
                                                    SELECT  f1.TypeName, b1.ProcessEventName, g1.UserName,
                                                            FORMAT(a1.StartDate, 'yyyy-MM-dd HH:mm:ss') AS StartDate,
                                                            FORMAT(a1.FinishDate, 'yyyy-MM-dd HH:mm:ss') AS FinishDate
                                                    FROM MES.BarcodeProcessEvent a1
                                                    INNER JOIN MES.ProcessEventItem b1 ON a1.ProcessEventItemId = b1.ProcessEventItemId
                                                    INNER JOIN MES.BarcodeProcess c1 ON a1.BarcodeProcessId = c1.BarcodeProcessId
                                                    INNER JOIN MES.MoProcess d1 ON c1.MoProcessId = d1.MoProcessId
                                                    INNER JOIN MES.Barcode e1 ON e1.BarcodeId = c1.BarcodeId
                                                    INNER JOIN BAS.Type f1 ON f1.TypeNo = b1.ProcessEventType AND f1.TypeSchema = 'ProcessEventItem'
                                                    INNER JOIN BAS.[User] g1 ON g1.UserId = a1.LastModifiedBy
                                                    WHERE c1.BarcodeProcessId = c.BarcodeProcessId
                                                    FOR JSON PATH, ROOT('data')
                                                ) AS BarcodeProcessDetail
                                            FROM MES.BarcodeProcessEvent a
                                            INNER JOIN MES.ProcessEventItem b ON a.ProcessEventItemId = b.ProcessEventItemId
                                            INNER JOIN MES.BarcodeProcess c ON a.BarcodeProcessId = c.BarcodeProcessId
                                            INNER JOIN MES.MoProcess d ON c.MoProcessId = d.MoProcessId
                                            INNER JOIN MES.Barcode e ON e.BarcodeId = c.BarcodeId
                                            INNER JOIN BAS.Type f ON f.TypeNo = b.ProcessEventType AND f.TypeSchema = 'ProcessEventItem'
                                            WHERE e.BarcodeNo = @BarcodeNo

                                            ) TT";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND e.BarcodeNo=@BarcodeNo";
                    //dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND c.StartDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FinishDate", @" AND c.FinishDate <= @FinishDate ", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    //sqlQuery.conditions = queryCondition;
                    //sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;
                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetLetteringChangeData -- 取得NG模仁刻號置換紀錄 -- Yi 2023-09-21
        public string GetLetteringChangeData(int ProcessAttrLogId, string WoErpFullNo, string MtlItemName
            , string BarcodeNo, string OriItemValue, string Status
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.ProcessAttrLogId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", (e.WoErpPrefix + '-' + e.WoErpNo) WoErpFullNo, f.MtlItemName, a.OriItemValue, a.NewItemValue, a.Remark
                        , FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm') QaReplacementDate, a1.UserName QaReplacementUser
                        , c.BarcodeNo
                        , b.BpalDetailId
                        , b3.StatusName StatusName
                        , ISNULL(FORMAT(b.CreateDate, 'yyyy-MM-dd HH:mm'), '') PeReplacementDate, ISNULL(b1.UserName, '') PeReplacementUser
                        , ISNULL(FORMAT(b.LastModifiedDate, 'yyyy-MM-dd HH:mm'), '') PeFinishDate, ISNULL(b2.UserName, '') PeFinishUser";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodeProcessAttributeLog a
                        LEFT JOIN BAS.[User] a1 ON a.CreateBy = a1.UserId
                        LEFT JOIN MES.BpalDetail b ON a.ProcessAttrLogId = b.ProcessAttrLogId AND a.NewBarcodeId = b.BarcodeId
                        LEFT JOIN BAS.[User] b1 ON b.CreateBy = b1.UserId
                        LEFT JOIN BAS.[User] b2 ON b.LastModifiedBy = b2.UserId
                        LEFT JOIN BAS.[Status] b3 ON ISNULL(b.[Status], 'N') = b3.StatusNo AND b3.StatusSchema = 'BpalDetail.Status'
                        LEFT JOIN MES.Barcode c ON a.NewBarcodeId = c.BarcodeId
                        LEFT JOIN MES.ManufactureOrder d ON a.OriMoId = d.MoId
                        LEFT JOIN MES.WipOrder e ON d.WoId = e.WoId
                        LEFT JOIN PDM.MtlItem f ON e.MtlItemId = f.MtlItemId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"
                                            AND a.OriItemNo = @OriItemNo
                                            AND a.ProcessAttrLogId IN (
                                                SELECT TOP 1 za.ProcessAttrLogId
                                                FROM MES.BarcodeProcessAttributeLog za
                                                WHERE za.OriItemNo = 'Lettering' 
                                                AND za.NewBarcodeId = a.NewBarcodeId
                                                ORDER BY za.CreateDate DESC
                                            )
                                            AND e.CompanyId = @CompanyId";
                    dynamicParameters.Add("OriItemNo", "Lettering");
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (e.WoErpPrefix + '-' + e.WoErpNo) LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND f.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND c.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OriItemValue", @" AND a.OriItemValue LIKE '%' + @OriItemValue + '%'", OriItemValue);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND ISNULL(b.[Status], 'N') = @Status", Status);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "b.Status";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetScrapReport --取得報廢報表 --GPai 20231012
        public string GetScrapReport(string MtlItemNo, string startDate, string endDate, string WoErpPrefix, string WoErpNo, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                string ErpNo = "";
                string te001 = "";
                //List<ScrapMain> scrapMain = new List<ScrapMain>();
                List<ScrapMo> scrapMo = new List<ScrapMo>();

                


                //List<ScrapMo> distinctScrapMtlitem = new List<ScrapMo>();

               

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion

                    if (CurrentCompany == 3)
                    {
                        te001 = "5402";
                    }
                    else
                    {
                        te001 = "5406";
                    }
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {

                    //#region //品號列表
                    //dynamicParameters = new DynamicParameters();
                    //sql = @"SELECT (a.MB001) MtlItemNo, (a.MB002) MtlItemName, (a.MB003) MtlItemspec FROM INVMB a";

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" WHERE a.MB001 = @MtlItemNo ", MtlItemNo);

                    ////var MtlResult = sqlConnection.Query(sql, dynamicParameters);
                    //scrapMain = sqlConnection.Query<ScrapMain>(sql, dynamicParameters).ToList();
                    //#endregion

                    #region //品號製令列表
                    dynamicParameters = new DynamicParameters();
                    //sqlQuery.mainKey = "a.MB001";
                    //sqlQuery.auxKey = "";
                    //sqlQuery.columns =
                    //    @" , (a.MB001) MtlItemNo, (a.MB002) MtlItemName, (a.MB003) MtlItemspec
                    //      , (b.TA001 + '-' + b.TA002) WoErpNo, (b.TA011) MoStatus, (b.TA015) ExpectedCount, (b.TA016) ReceiveCount, (b.TA017) ProducedCount";
                    //sqlQuery.mainTables =
                    //    @" FROM INVMB a
                    //      INNER JOIN MOCTA b ON a.MB001 = b.TA006";
                    //sqlQuery.auxTables = "";
                    //string queryCondition = @"";
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TA001", @" AND b.TA001 = @TA001", WoErpPrefix);
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "startDate", @" AND b.TA003 >= @startDate", startDate.Length > 0 ? Convert.ToDateTime(startDate).ToString("yyyyMMdd") : "");
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "endDate", @" AND b.TA003 <= @endDate ", endDate.Length > 0 ? Convert.ToDateTime(endDate).ToString("yyyyMMdd") : "");
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND a.MB001 = @MtlItemNo", MtlItemNo);

                    //sqlQuery.conditions = queryCondition;
                    //sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MB001";
                    //sqlQuery.pageIndex = PageIndex;
                    //sqlQuery.pageSize = PageSize;

                    //scrapMtlMo = BaseHelper.SqlQuery<ScrapMtlMo>(sqlConnection, dynamicParameters, sqlQuery);


                    sql = @"SELECT (a.MB001) MtlItemNo, (a.MB002) MtlItemName, (a.MB003) MtlItemspec, (b.TA001 + '-' + b.TA002) WoErpNo, (b.TA011) MoStatus, (b.TA015) ExpectedCount, (b.TA016) ReceiveCount, (b.TA017) ProducedCount, (b.TA018) ScrapCount, b.TA001
                            FROM INVMB a
                            INNER JOIN MOCTA b ON a.MB001 = b.TA006
                            WHERE b.TA013 = 'Y'
							AND b.TA003 >= @startDate
                            AND b.TA003 <= @endDate
							";
                    dynamicParameters.Add("startDate", startDate.Length > 0 ? Convert.ToDateTime(startDate).ToString("yyyyMMdd") : "");
                    dynamicParameters.Add("endDate", endDate.Length > 0 ? Convert.ToDateTime(endDate).ToString("yyyyMMdd") : "");
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MB001 = @MtlItemNo ", MtlItemNo);
                    if (WoErpPrefix.Length > 0)  BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TA001", @" AND b.TA001 IN @TA001 ", WoErpPrefix.Split(','));
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpNo", @" AND b.TA002 = @WoErpNo ", WoErpNo);

                    var MtlResult = sqlConnection.Query(sql, dynamicParameters);
                    scrapMo = sqlConnection.Query<ScrapMo>(sql, dynamicParameters).ToList();

                    ////過濾重複
                    //distinctScrapMtlitem = scrapMo
                    //                        .GroupBy(s => s.MtlItemNo)
                    //                             .Select(grp => grp.FirstOrDefault())
                    //                             .OrderBy(s => s.MtlItemNo)
                    //                             .ToList();

                    #endregion
                    

                    foreach (var item in scrapMo)
                    {
                        decimal overrecive = 0.00m;
                        decimal bomformula = 0.00m;
                        #region //入庫數
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT ISNULL(SUM(b.TI007),0)TI007
                        //    FROM INVMB a
                        //    INNER JOIN MOCTI b ON a.MB001 = b.TI004
                        //    INNER JOIN MOCTH c ON (b.TI001 + b.TI002) = (c.TH001 + c.TH002)
                        //    --and  a.MB001 = '4A101U001-1512-45'
                        //    --and '20230901' <= c.TH003 and c.TH003 <= '20230930'
                        //    AND (b.TI013 + '-' + b.TI014) = @WoErpNo";

                        //dynamicParameters.Add("WoErpNo", item.WoErpNo);
                        //var StoreResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        decimal scrapCount = 0.0m;
                        decimal moscrapCount = 0.0m;
                        var receiveCount = item.ReceiveCount;//製令已領套數
                        var producedCount = item.ProducedCount;//製令已生產數
                        var moMtlNo = item.MtlItemNo;


                        #region //製令單身(材料)第二層
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT (a.TB001 + '-' + a.TB002) WoErpNo, RTRIM(LTRIM(a.TB003)) MtlItemNo, RTRIM(LTRIM(a.TB012)) MtlItemName, RTRIM(LTRIM(a.TB013)) MtlItemspec, (a.TB004)ExpectedCount, (a.TB005)ReceiveCount, (TB007) Unit
                                FROM MOCTB a
                                WHERE (a.TB001 + '-' + a.TB002) = @WoErpNo
                                ORDER BY a.TB003";

                        dynamicParameters.Add("WoErpNo", item.WoErpNo);
                        var MoMtlResult = sqlConnection.Query(sql, dynamicParameters);

                        List<ScrapMoMtlMerge> scrapMoMtlMerge = new List<ScrapMoMtlMerge>();

                        var lastMoMTL = "";
                        var replacMTL = "";
                        foreach (var moMtl in MoMtlResult)
                        {
                            

                            var moMtlExpectedCount = moMtl.ExpectedCount;//材料需領用量
                            var moMtlReceiveCount = moMtl.ReceiveCount;//材料已領用量
                            //moMtlreceiveCount overrecive
                            decimal mergeScrapCount = 0.0m;
                            decimal mergeMoScrapCount = 0.0m;

                            decimal mergemoMtlreceiveCount = 0.0m;//材料已領用量總和
                            decimal mergeoverreciveCount = 0.0m;//材料超領總和
                            decimal mergemoMtlExpectedCount = 0.0m;//材料需領用量總和

                            List<ScrapMoMtl> scrapMoMtl = new List<ScrapMoMtl>();
                            List<ScrapMoReplaceMtl> scrapMoReplaceMtl = new List<ScrapMoReplaceMtl>();



                            //取BOM
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT RTRIM(LTRIM(MD001)), RTRIM(LTRIM(MD003)), MD006
                                            FROM BOMMD
                                            WHERE RTRIM(LTRIM(MD001)) = @MD001 AND RTRIM(LTRIM(MD003)) = @MD003";

                            dynamicParameters.Add("MD001", moMtlNo);
                            dynamicParameters.Add("MD003", moMtl.MtlItemNo);
                            var bomResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var bomitem in bomResult)
                            {
                               bomformula = bomitem.MD006;

                            }

                            //在製令內的替代料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT RTRIM(LTRIM(a.MB002)) MB002, RTRIM(LTRIM(a.MB001)) MB001, RTRIM(LTRIM(a.MB004)) MB004, b.MD006, RTRIM(LTRIM(d.MB002)) MtlName, RTRIM(LTRIM(d.MB003)) MtlSpec
                                    FROM BOMMB a
                                    INNER JOIN BOMMD b ON a.MB001 = b.MD003 AND a.MB002 = b.MD001
									INNER JOIN MOCTB c ON  a.MB001 = c.TB003
									INNER JOIN INVMB d on a.MB004 = d.MB001
                                    WHERE RTRIM(LTRIM(a.MB001)) = @MB001
                                    AND RTRIM(LTRIM(a.MB002)) = @MB002
                                    AND (c.TB001 + '-' + c.TB002) = @WoErpNo
                                    ORDER BY c.TB003";

                            dynamicParameters.Add("MB001", moMtl.MtlItemNo.Trim());
                            dynamicParameters.Add("MB002", moMtlNo.Trim());
                            dynamicParameters.Add("WoErpNo", item.WoErpNo.Trim());

                            var bomreplaceResult = sqlConnection.Query(sql, dynamicParameters);




                            //製令料品有替代料時
                            if (bomreplaceResult.Count() > 0)
                            {
                                foreach (var bomreplaceitem in bomreplaceResult)
                                {
                                    scrapMoMtl.Add(new ScrapMoMtl
                                    {
                                        MtlItemNo = moMtl.MtlItemNo,
                                        MtlItemName = moMtl.MtlItemName,
                                        MtlItemspec = moMtl.MtlItemspec,
                                        WoErpNo = moMtl.WoErpNo,
                                        ExpectedCount = moMtlExpectedCount,
                                        ReceiveCount = moMtlReceiveCount,
                                        ScrapCount = 0,
                                        MoScrapCount = 0,
                                        Unit = moMtl.Unit
                                    });

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT (a.TB001 + '-' + a.TB002) WoErpNo, (a.TB003)MtlItemNo, (a.TB012) MtlItemName, (a.TB013) MtlItemspec, (TB004)ExpectedCount, (TB005)ReceiveCount, (TB007) Unit
                                            FROM MOCTB a
                                            WHERE (a.TB001 + '-' + a.TB002) = @WoErpNo
                                            AND RTRIM(LTRIM(a.TB003)) = @TB003
                                            ORDER BY a.TB003";

                                    dynamicParameters.Add("WoErpNo", item.WoErpNo);
                                    dynamicParameters.Add("TB003", bomreplaceitem.MB004);
                                    var MoreplaceMtlResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var moreplaceMtlitem in MoreplaceMtlResult)
                                    {
                                        replacMTL = bomreplaceitem.MB004;
                                        scrapMoReplaceMtl.Add(new ScrapMoReplaceMtl
                                        {
                                            MB001 = moMtl.MtlItemNo,
                                            MtlItemNo = bomreplaceitem.MB004,
                                            MtlItemName = bomreplaceitem.MtlName,
                                            MtlItemspec = bomreplaceitem.MtlSpec,
                                            WoErpNo = moMtl.WoErpNo,
                                            ExpectedCount = moreplaceMtlitem.ExpectedCount,
                                            ReceiveCount = moreplaceMtlitem.ReceiveCount,
                                            ScrapCount = 0,
                                            MoScrapCount = 0,
                                            Unit = moMtl.Unit
                                        });
                                    }
                                    //if (bomreplaceitem.MB004.Trim() == moMtl.MtlItemNo.Trim())
                                    //{

                                    //}

                                }

                            }
                            else
                            {
                                //replacMTL = "NO";
                                if (moMtl.MtlItemNo.Trim() != replacMTL.Trim())
                                {
                                    scrapMoMtl.Add(new ScrapMoMtl
                                    {
                                        MtlItemNo = moMtl.MtlItemNo,
                                        MtlItemName = moMtl.MtlItemName,
                                        MtlItemspec = moMtl.MtlItemspec,
                                        WoErpNo = moMtl.WoErpNo,
                                        ExpectedCount = moMtlExpectedCount,
                                        ReceiveCount = moMtlReceiveCount,
                                        ScrapCount = 0,
                                        MoScrapCount = 0,
                                        Unit = moMtl.Unit
                                    });
                                }
                            
                                    
                                
                                //scrapMoMtl.Add(new ScrapMoMtl
                                //{
                                //    MtlItemNo = moMtl.MtlItemNo,
                                //    MtlItemName = moMtl.MtlItemName,
                                //    MtlItemspec = moMtl.MtlItemspec,
                                //    WoErpNo = moMtl.WoErpNo,
                                //    ExpectedCount = moMtlExpectedCount,
                                //    ReceiveCount = moMtlReceiveCount,
                                //    ScrapCount = 0,
                                //    MoScrapCount = 0,
                                //    Unit = moMtl.Unit
                                //});


                            }
                            


                            foreach (var subitem in scrapMoMtl)
                            {
                                var moMtlreceiveCount = subitem.ReceiveCount;//材料已領數
                                var moMtlExpectedCount2 = subitem.ExpectedCount;//材料需領數
                                mergemoMtlreceiveCount += moMtlreceiveCount;
                                mergemoMtlExpectedCount += moMtlExpectedCount2;

                                //超領
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(SUM(a.TE005),0)TE005
                                    FROM MOCTE a
                                    INNER JOIN MOCTA b on (a.TE011 + a.TE012) = (b.TA001 + b.TA002)
                                    INNER JOIN MOCTB c on (b.TA001 + b.TA002) = (c.TB001 + c.TB002) AND c.TB003 = a.TE004
                                    AND a.TE001 = @TE001
                                    AND a.TE004 = @TE004
                                    AND a.TE019 = 'Y'
                                    AND (a.TE011 + '-' + a.TE012) = @WoErpNo";

                                dynamicParameters.Add("TE004", subitem.MtlItemNo);
                                dynamicParameters.Add("WoErpNo", item.WoErpNo);
                                dynamicParameters.Add("TE001", te001);

                                var ReceiveUnfinishResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var receiveitem in ReceiveUnfinishResult)
                                {
                                    overrecive = receiveitem.TE005;
                                    mergeoverreciveCount += overrecive;
                                }

                                ////製令結案報廢數 領料數-入庫數
                                //foreach (var bomitem in bomResult)
                                //{
                                //    var bomformula2 = bomitem.MD006;
                                //    moscrapCount = moMtlreceiveCount - overrecive - (producedCount * bomformula2);

                                //}

                                if (item.MoStatus.ToUpper() != "Y") //未結案
                                {
                                    #region //製令未結案
                                    if (moMtlExpectedCount == 0 && bomformula == 0)
                                    {
                                        scrapCount = moMtlreceiveCount;
                                        moscrapCount = 0;

                                    }
                                    else if (moMtlExpectedCount > 0 && bomformula == 0) {
                                        scrapCount = overrecive;
                                        moscrapCount = moMtlreceiveCount - overrecive - (producedCount * 1);

                                    }
                                    else if (moMtlExpectedCount == 0 && bomformula > 0) {
                                        scrapCount = moMtlreceiveCount;
                                        moscrapCount = 0;

                                    }
                                    else if (moMtlExpectedCount > 0 && bomformula > 0)
                                    {
                                        scrapCount = overrecive;
                                        moscrapCount = moMtlreceiveCount - overrecive - (producedCount * bomformula);
                                    }

                                    #endregion
                                }
                                else //已結案
                                {
                                    #region //製令已結案:報廢數=已領用量-入庫數(已生產數)*BOM用量
                                    if (moMtlExpectedCount == 0 && bomformula == 0)
                                    {
                                        scrapCount = moMtlreceiveCount;
                                        moscrapCount = 0;

                                    }
                                    else if (moMtlExpectedCount > 0 && bomformula == 0)
                                    {
                                        scrapCount = moMtlreceiveCount - (producedCount * 1);
                                        moscrapCount = moMtlreceiveCount - overrecive - (producedCount * 1);

                                    }
                                    else if (moMtlExpectedCount == 0 && bomformula > 0)
                                    {
                                        scrapCount = moMtlreceiveCount;
                                        moscrapCount = 0;

                                    }
                                    else if (moMtlExpectedCount > 0 && bomformula > 0)
                                    {
                                        scrapCount = moMtlreceiveCount - (producedCount * bomformula);
                                        moscrapCount = moMtlreceiveCount - overrecive - (producedCount * bomformula);

                                    }
                                    #endregion
                                }

                                //if (moMtlreceiveCount == 0)
                                //{
                                //    scrapCount = 0;
                                //    moscrapCount = 0;
                                //}

                                //mergeMoScrapCount += moscrapCount;
                                //mergeScrapCount += scrapCount;

                                scrapMoMtl
                                    .Where(y => y.WoErpNo == item.WoErpNo)
                                    .Where(y => y.MtlItemNo == subitem.MtlItemNo)
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.ScrapCount = scrapCount;
                                        x.MoScrapCount = moscrapCount;
                                    });

                            }

                            foreach (var subitem in scrapMoReplaceMtl)
                            {
                                var moMtlreceiveCount = subitem.ReceiveCount;//材料已領數
                                var moMtlExpectedCount2 = subitem.ExpectedCount;//材料需領數
                                mergemoMtlreceiveCount += moMtlreceiveCount;
                                mergemoMtlExpectedCount += moMtlExpectedCount2;
                                //超領
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ISNULL(SUM(a.TE005),0)TE005
                                    FROM MOCTE a
                                    INNER JOIN MOCTA b on (a.TE011 + a.TE012) = (b.TA001 + b.TA002)
                                    INNER JOIN MOCTB c on (b.TA001 + b.TA002) = (c.TB001 + c.TB002) AND c.TB003 = a.TE004
                                    AND a.TE001 = @TE001
                                    AND a.TE004 = @TE004
                                    AND a.TE019 = 'Y'
                                    AND (a.TE011 + '-' + a.TE012) = @WoErpNo";

                                dynamicParameters.Add("TE004", subitem.MtlItemNo);
                                dynamicParameters.Add("WoErpNo", item.WoErpNo);
                                dynamicParameters.Add("TE001", te001);

                                var ReceiveUnfinishResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var receiveitem in ReceiveUnfinishResult)
                                {
                                    overrecive = receiveitem.TE005;
                                    mergeoverreciveCount += overrecive;
                                }

                                ////製令結案報廢數 領料數-入庫數
                                //foreach (var bomitem in bomResult)
                                //{
                                //    var bomformula2 = bomitem.MD006;
                                //    moscrapCount = moMtlreceiveCount - overrecive - (producedCount * bomformula2);
                                //}

                                if (item.MoStatus.ToUpper() != "Y") //未結案
                                {
                                    #region //製令未結案
                                    if (moMtlExpectedCount == 0 && bomformula == 0)
                                    {
                                        scrapCount = moMtlreceiveCount;
                                        moscrapCount = 0;

                                    }
                                    else if (moMtlExpectedCount > 0 && bomformula == 0)
                                    {
                                        scrapCount = overrecive;
                                        moscrapCount = moMtlreceiveCount - overrecive - (producedCount * 1);

                                    }
                                    else if (moMtlExpectedCount == 0 && bomformula > 0)
                                    {
                                        scrapCount = moMtlreceiveCount;
                                        moscrapCount = 0;

                                    }
                                    else if (moMtlExpectedCount > 0 && bomformula > 0)
                                    {
                                        scrapCount = overrecive;
                                        moscrapCount = moMtlreceiveCount - overrecive - (producedCount * bomformula);
                                    }

                                    #endregion
                                }
                                else //已結案
                                {
                                    #region //製令已結案:報廢數=已領用量-入庫數(已生產數)*BOM用量
                                    if (moMtlExpectedCount == 0 && bomformula == 0)
                                    {
                                        scrapCount = moMtlreceiveCount;
                                        moscrapCount = 0;

                                    }
                                    else if (moMtlExpectedCount > 0 && bomformula == 0)
                                    {
                                        scrapCount = moMtlreceiveCount - (producedCount * 1);
                                        moscrapCount = moMtlreceiveCount - overrecive - (producedCount * 1);

                                    }
                                    else if (moMtlExpectedCount == 0 && bomformula > 0)
                                    {
                                        scrapCount = moMtlreceiveCount;
                                        moscrapCount = 0;

                                    }
                                    else if (moMtlExpectedCount > 0 && bomformula > 0)
                                    {
                                        scrapCount = moMtlreceiveCount - (producedCount * bomformula);
                                        moscrapCount = moMtlreceiveCount - overrecive - (producedCount * bomformula);

                                    }
                                    #endregion
                                }

                                //if (moMtlreceiveCount == 0)
                                //{
                                //    scrapCount = 0;
                                //    moscrapCount = 0;
                                //}

                                //mergeMoScrapCount += moscrapCount;
                                //mergeScrapCount += scrapCount;

                                scrapMoReplaceMtl
                                    .Where(y => y.WoErpNo == item.WoErpNo)
                                    .Where(y => y.MtlItemNo == subitem.MtlItemNo)
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.ScrapCount = scrapCount;
                                        x.MoScrapCount = moscrapCount;
                                    });

                            }

                            ////製令結案報廢數 領料數-入庫數
                            //foreach (var bomitem in bomResult)
                            //{
                            //    var bomformula2 = bomitem.MD006;
                            //    mergeMoScrapCount = mergemoMtlreceiveCount - mergeoverreciveCount - (producedCount * bomformula);

                            //}

                            //總報廢數
                            if (item.MoStatus.ToUpper() != "Y") //未結案的
                            {

                                #region //製令未結案
                                if (mergemoMtlExpectedCount == 0 && bomformula == 0)
                                {
                                    mergeScrapCount = mergemoMtlreceiveCount;
                                    mergeMoScrapCount = 0;

                                }
                                else if (mergemoMtlExpectedCount > 0 && bomformula == 0)
                                {
                                    mergeScrapCount = mergeoverreciveCount;
                                    mergeMoScrapCount = mergemoMtlreceiveCount - mergeoverreciveCount - (producedCount * 1);

                                }
                                else if (mergemoMtlExpectedCount == 0 && bomformula > 0)
                                {
                                    mergeScrapCount = mergemoMtlreceiveCount;
                                    mergeMoScrapCount = 0;

                                }
                                else if (mergemoMtlExpectedCount > 0 && bomformula > 0)
                                {
                                    mergeScrapCount = mergeoverreciveCount;
                                    mergeMoScrapCount = mergemoMtlreceiveCount - mergeoverreciveCount - (producedCount * bomformula);
                                }
                                #endregion
                            }
                            else //已結案
                            {

                                #region //製令已結案:報廢數=已領用量-入庫數(已生產數)*BOM用量
                                if (mergemoMtlExpectedCount == 0 && bomformula == 0)
                                {
                                    mergeScrapCount = mergemoMtlreceiveCount;
                                    mergeMoScrapCount = 0;

                                }
                                else if (mergemoMtlExpectedCount > 0 && bomformula == 0)
                                {
                                    mergeScrapCount = mergemoMtlreceiveCount - (producedCount * 1);
                                    mergeMoScrapCount = mergemoMtlreceiveCount - mergeoverreciveCount - (producedCount * 1);

                                }
                                else if (mergemoMtlExpectedCount == 0 && bomformula > 0)
                                {
                                    mergeScrapCount = mergemoMtlreceiveCount;
                                    mergeMoScrapCount = 0;

                                }
                                else if (mergemoMtlExpectedCount > 0 && bomformula > 0)
                                {
                                    mergeScrapCount = mergemoMtlreceiveCount - (producedCount * bomformula);
                                    mergeMoScrapCount = mergemoMtlreceiveCount - mergeoverreciveCount - (producedCount * bomformula);

                                }
                                #endregion
                               
                            }

                            if (moMtl.MtlItemNo.Trim() != replacMTL.Trim())
                            {
                                scrapMoMtlMerge.Add(new ScrapMoMtlMerge
                                {
                                    ScrapMoMtldata = scrapMoMtl,
                                    ScrapMoReplaceMtldata = scrapMoReplaceMtl,
                                    MergeScrapCount = mergeScrapCount,
                                    MergeMoScrapCount = mergeMoScrapCount,
                                    Unit = moMtl.Unit
                                });
                            }

                        }

                        
                            scrapMo
                            .Where(y => y.WoErpNo == item.WoErpNo)
                            .ToList()
                            .ForEach(x =>
                            {
                                x.ScrapMoMtlMerge = scrapMoMtlMerge;
                            });
                        #endregion
                    
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = scrapMo
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetExcessReport --取得超領報表 --GPai 20231016
        public string GetExcessReport(string MtlItemNo, string startDate, string endDate, string WoErpPrefix, string WoErpNo, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                string ErpNo = "";
                string te001 = "";
                List<ScrapMoExcessMtl> excessMain = new List<ScrapMoExcessMtl>();
                

                decimal overrecive = 0.00m;

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpNo = item.ErpNo;
                    }
                    #endregion

                    if (CurrentCompany == 3)
                    {
                        te001 = "5402";
                    }
                    else
                    {
                        te001 = "5406";
                    }
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {

                    #region //製令料品超領列表
                    dynamicParameters = new DynamicParameters();
                    
                    sql = @"SELECT (a.TE011 + '-' + a.TE012) WoErpNo, (c.MB001) MtlItemNo, (c.MB002) MtlItemName, (c.MB003) MtlItemspec
							, (d.TA015) MoExpectedCount , (d.TA017) MoProducedCount
							, (b.TB004) ExpectedCount, (b.TB005) ReceiveCount
                            , (SUM(a.TE005)) ExcessCount, (b.TB007) Unit
                            FROM MOCTE a
                            INNER JOIN MOCTB b ON (a.TE011 + '-' + a.TE012) = (b.TB001 + '-' + b.TB002) AND a.TE004 = b.TB003
                            INNER JOIN INVMB c ON a.TE004 = c.MB001
                            INNER JOIN MOCTA d ON (b.TB001 + '-' + b.TB002) = (d.TA001 + '-' + d.TA002)
                            WHERE a.TE001 = @TE001 AND a.TE019 = 'Y' AND b.TB005 > 0
                            AND d.TA003 >= @startDate
                            AND d.TA003 <= @endDate
							";
                    dynamicParameters.Add("TE001", te001);
                    dynamicParameters.Add("startDate", startDate.Length > 0 ? Convert.ToDateTime(startDate).ToString("yyyyMMdd") : "");
                    dynamicParameters.Add("endDate", endDate.Length > 0 ? Convert.ToDateTime(endDate).ToString("yyyyMMdd") : "");
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND c.MB001 = @MtlItemNo ", MtlItemNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TA001", @" AND d.TA001 = @TA001 ", WoErpPrefix);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpNo", @" AND d.TA002 = @WoErpNo ", WoErpNo);
                    sql += @" GROUP BY (a.TE011 + '-' + a.TE012) , c.MB001, c.MB002, c.MB003, b.TB007, d.TA015, d.TA017, b.TB004, b.TB005
                                ORDER BY (a.TE011 + '-' + a.TE012) DESC, c.MB001";

                    var MtlResult = sqlConnection.Query(sql, dynamicParameters);
                    excessMain = sqlConnection.Query<ScrapMoExcessMtl>(sql, dynamicParameters).ToList();

                    ////過濾重複
                    //distinctScrapMtlitem = scrapMo
                    //                        .GroupBy(s => s.MtlItemNo)
                    //                             .Select(grp => grp.FirstOrDefault())
                    //                             .OrderBy(s => s.MtlItemNo)
                    //                             .ToList();

                    #endregion

                    foreach (var item in excessMain)
                    {

                        var excessPerson = (item.ExcessCount / (item.ReceiveCount));
                        excessPerson = Math.Round(excessPerson, 2);

                        excessMain
                            .Where(y => y.WoErpNo == item.WoErpNo)
                            .Where(y => y.MtlItemNo == item.MtlItemNo)
                            .ToList()
                            .ForEach(x =>
                            {
                                x.ExcessPerson = excessPerson;
                            });


                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = excessMain
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSaleRankingListVe1 -- 取得業務成績排行(BY單據業務) -- Shintokuro 2023.11.17
        public string GetSaleRankingListVe1(string Type, string Model, string StartDate, string EndDate
            , string CompanyList, int PgId, string ExcludeStatus)
        {
            try
            {
                string MESCompanyNo = "";
                string ErpNo = "";
                string ErpDb = "";
                string StartDateFull = "";
                string EndDateFull = "";
                string ExcludeSql = "";
                string ExcludeSql2 = "";
                DateTime dtEnd = new DateTime();
                if (StartDate.Split('-').Length == 2)
                {
                    StartDateFull = StartDate.Replace("-", "") + "01";
                    StartDate = StartDate + "-01";
                }
                else if (StartDate.Split('-').Length == 3)
                {
                    StartDateFull = StartDate.Replace("-", "");
                }

                if (EndDate.Split('-').Length == 2)
                {
                    int lastDay = DateTime.DaysInMonth(Convert.ToInt32(EndDate.Split('-')[0]), Convert.ToInt32(EndDate.Split('-')[1]));
                    EndDateFull = EndDate.Replace("-", "") + lastDay.ToString().PadLeft(2, '0');
                    dtEnd = DateTime.ParseExact(EndDate, "yyyy-MM", System.Globalization.CultureInfo.InvariantCulture);

                }
                else if (EndDate.Split('-').Length == 3)
                {
                    EndDateFull = EndDate.Replace("-", "");
                    dtEnd = DateTime.ParseExact(EndDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);

                }

                string dateNow = DateTime.Now.ToString("yyyyMM");
                //dateNow = "202305";
                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                List<Bar> barResult = new List<Bar>();
                List<Bar> intentAmount = new List<Bar>();
                List<Bar> barResultAll = new List<Bar>();
                List<Spline> splineResult = new List<Spline>();
                List<Spline> splineResultAll = new List<Spline>();

                foreach (var Company in CompanyList.Split(','))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", Company);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            MESCompanyNo = item.ErpNo;
                            ErpDb = item.ErpDb;


                        }
                        #endregion


                        #region //取得目標業績資料
                        if (PgId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT
                                     FORMAT(a.StartDate, 'yyyyMMdd') StartDate
                                    , FORMAT(a.EndDate, 'yyyyMMdd') EndDate
                                    FROM SCM.PerformanceGoals a
                                    WHERE a.PgId = @PgId";
                            dynamicParameters.Add("PgId", PgId);

                            var resultPg = sqlConnection.Query(sql, dynamicParameters);
                            if (resultPg.Count() <= 0) throw new SystemException("【目標業績】資料找不到請重新確認!");

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UserId, b.UserNo SalesNo, b.UserName Sales, a.IntentAmount
                                    FROM SCM.PgDetail a
                                    INNER JOIN BAS.[User] b on a.UserId = b.UserId
                                    WHERE a.PgId = @PgId
                                    AND a.IntentType = @IntentType";
                            dynamicParameters.Add("PgId", PgId);
                            switch (Type)
                            {
                                case "Sale":
                                    dynamicParameters.Add("IntentType", "S");
                                    break;
                                case "Delivery":
                                    dynamicParameters.Add("IntentType", "D");
                                    break;
                                case "Receive":
                                    dynamicParameters.Add("IntentType", "R");
                                    break;
                                case "Collection":
                                    dynamicParameters.Add("IntentType", "C");
                                    break;
                            }

                            intentAmount = sqlConnection.Query<Bar>(sql, dynamicParameters).ToList();

                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        switch (Model)
                        {
                            #region //長條圖
                            case "Bar":
                                switch (Type)
                                {
                                    #region //訂單
                                    case "Sale":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }

                                        sql = @"SELECT ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) Amount,a.TC006,b.MV002 Sales,LTRIM(RTRIM(b.MV001)) SalesNo,c.Amount AllAmount,d.Amount MoonAmount
                                                FROM (
                                                    SELECT ISNULL(SUM(x1.TC009 * x1.TC029), 0) Amount, x1.TC006  
                                                    FROM COPTC x1
                                                    WHERE (x1.TC003 >=" + StartDateFull + @" AND x1.TC003 <=" + EndDateFull + @") 
                                                    AND x1.TC027 = 'Y' 
                                                    AND x1.TC006 != ''
                                                    " + ExcludeSql + @"
                                                    GROUP BY x1.TC006
                                                ) AS a
                                                INNER JOIN CMSMV b on a.TC006 = b.MV001
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TC009 * x1.TC029), 0) Amount 
                                                    FROM COPTC x1
                                                    WHERE (x1.TC003 >=" + StartDateFull + @" AND x1.TC003 <=" + EndDateFull + @") 
                                                    AND x1.TC027 = 'Y' 
                                                    AND x1.TC006 != ''
                                                    " + ExcludeSql + @"
                                                ) AS c
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TC009 * x1.TC029), 0) Amount 
                                                    FROM COPTC x1
                                                    WHERE (x1.TC003 LIKE '" + dateNow + @"__') 
                                                    AND x1.TC027 = 'Y' 
                                                    AND x1.TC006 = a.TC006
                                                    " + ExcludeSql + @"
                                                ) AS d
                                                ORDER BY a.Amount DESC";
                                        break;
                                    #endregion
                                    #region //出貨
                                    case "Delivery":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('1008','2034')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('ZY001','QY001')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                            ExcludeSql2 = "";
                                        }
                                        sql = @"SELECT 
                                                a.TF008,b.MV002 Sales,LTRIM(RTRIM(b.MV001)) SalesNo,d.Amount MoonAmount
                                                ,(ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) - ROUND(CAST(ISNULL(e.Amount, 0) AS FLOAT), 5)) AS Amount
                                                , ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) TotalAmount
                                                , ROUND(CAST(ISNULL(e.Amount, 0) AS FLOAT), 5) ReturnAmount
                                                ,(ROUND(CAST(ISNULL(c.Amount, 0) AS FLOAT), 5) - ROUND(CAST(ISNULL(f.Amount, 0) AS FLOAT), 5)) AS AllAmount
                                                ,c.Amount AllTotalAmount
                                                ,f.Amount AllReutrnAmount
                                                FROM (
                                                        SELECT ISNULL(SUM(x1.TG013 * x2.TF012), 0) Amount,x2.TF008  
                                                        FROM INVTG x1
                                                        INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                        WHERE (x2.TF024 >=" + StartDateFull + @" AND x2.TF024 <=" + EndDateFull + @") 
                                                        AND x1.TG008 ='C01'
                                                        AND x2.TF020 = 'Y' 
                                                        AND x2.TF008 !=''
                                                        " + ExcludeSql + @"
                                                        GROUP BY x2.TF008
                                                    ) AS a
                                                INNER JOIN CMSMV b on a.TF008 = b.MV001
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TG013 * x2.TF012), 0) Amount 
                                                    FROM INVTG x1
                                                    INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                    WHERE (x2.TF024 >='" + StartDateFull + @"' AND x2.TF024 <=" + EndDateFull + @") 
                                                    AND x2.TF020 = 'Y' 
                                                    AND x2.TF008 !=''
                                                    " + ExcludeSql + @"
                                                ) AS c
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TG013 * x2.TF012),0) Amount 
                                                    FROM INVTG x1
                                                    INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                    WHERE (x2.TF024 LIKE '" + dateNow + @"__') 
                                                    AND x1.TG008 ='C01'
                                                    AND x2.TF020 = 'Y' 
                                                    AND x2.TF008 = a.TF008
                                                    " + ExcludeSql + @"
                                                ) AS d
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TI013 * x2.TH012), 0)  Amount 
                                                    FROM INVTI x1
                                                    INNER JOIN INVTH x2 on x1.TI001 = x2.TH001 AND x1.TI002 = x2.TH002
                                                    WHERE (x2.TH023 >=" + StartDateFull + @" AND x2.TH023 <=" + EndDateFull + @") 
                                                    AND x1.TI007 ='C01'
                                                    AND x2.TH020 = 'Y' 
                                                    AND x2.TH008 = a.TF008
                                                    " + ExcludeSql2 + @"
                                                ) AS e
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TI013 * x2.TH012), 0) Amount 
                                                    FROM INVTI x1
                                                    INNER JOIN INVTH x2 on x1.TI001 = x2.TH001 AND x1.TI002 = x2.TH002
                                                     WHERE (x2.TH023 >=" + StartDateFull + @" AND x2.TH023 <=" + EndDateFull + @") 
                                                    AND x1.TI007 ='C01'
                                                    AND x2.TH020 = 'Y' 
                                                    AND x2.TH008 != ''
                                                    " + ExcludeSql2 + @"
                                                ) AS f
                                                ORDER BY a.Amount DESC
                                                ";
                                        break;
                                    #endregion
                                    #region //銷貨
                                    case "Receive":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    ExcludeSql2 += "AND x1.TI004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('1008','2034')";
                                                    ExcludeSql2 += "AND x1.TI004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('ZY001','QY001')";
                                                    ExcludeSql2 += "AND x1.TI004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }

                                        sql = @"SELECT 
                                                a.TG006,b.MV002 Sales,LTRIM(RTRIM(b.MV001)) SalesNo,d.Amount MoonAmount
                                                ,(ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) - ROUND(CAST(ISNULL(e.Amount, 0) AS FLOAT), 5)) AS Amount
                                                , ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) TotalAmount
                                                , ROUND(CAST(ISNULL(e.Amount, 0) AS FLOAT), 5) ReturnAmount
                                                ,(ROUND(CAST(ISNULL(c.Amount, 0) AS FLOAT), 5) - ROUND(CAST(ISNULL(f.Amount, 0) AS FLOAT), 5)) AS AllAmount
                                                ,c.Amount AllTotalAmount
                                                ,f.Amount AllReutrnAmount
                                                FROM (
                                                    SELECT ISNULL(SUM(x1.TG045),0) Amount, x1.TG006  
                                                    FROM COPTG x1
                                                    WHERE (x1.TG003 >=" + StartDateFull + @" AND x1.TG003 <=" + EndDateFull + @") 
                                                    AND x1.TG023 = 'Y' 
                                                    AND x1.TG006 != ''
                                                    " + ExcludeSql + @"
                                                    GROUP BY x1.TG006
                                                ) AS a
                                                INNER JOIN CMSMV b on a.TG006 = b.MV001
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TG045),0) Amount 
                                                    FROM COPTG x1
                                                    WHERE (x1.TG003 >=" + StartDateFull + @" AND x1.TG003 <=" + EndDateFull + @") 
                                                    AND x1.TG023 = 'Y' 
                                                    AND x1.TG006 != ''
                                                    " + ExcludeSql + @"
                                                ) AS c
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TG045),0) Amount 
                                                    FROM COPTG x1
                                                    WHERE (x1.TG003 LIKE '" + dateNow + @"__') 
                                                    AND x1.TG023 = 'Y' 
                                                    AND x1.TG006 = a.TG006
                                                ) AS d
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TI037), 0)  Amount 
                                                    FROM COPTI x1
                                                    WHERE (x1.TI034 >=" + StartDateFull + @" AND x1.TI034 <=" + EndDateFull + @") 
                                                    AND x1.TI019 = 'Y' 
                                                    AND x1.TI006 = a.TG006
                                                    " + ExcludeSql2 + @"
                                                ) AS e
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TI037), 0) Amount 
                                                    FROM COPTI x1
                                                    WHERE (x1.TI034 >=" + StartDateFull + @" AND x1.TI034 <=" + EndDateFull + @") 
                                                    AND x1.TI019 = 'Y' 
                                                    AND x1.TI006 != ''
                                                    " + ExcludeSql2 + @"
                                                ) AS f
                                                ORDER BY a.Amount DESC
                                                ";
                                        break;
                                    #endregion
                                    #region //收款
                                    case "Collection":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }

                                        sql = @"SELECT ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) Amount
                                                ,a.TC015,b.MV002 Sales,LTRIM(RTRIM(b.MV001)) SalesNo
                                                ,c.Amount AllAmount
                                                ,d.Amount MoonAmount
                                                FROM (
                                                    SELECT ISNULL(SUM(x1.TC013), 0) Amount, x1.TC015
                                                    FROM ACRTC x1
                                                    WHERE (x1.TC003 >=" + StartDateFull + @" AND x1.TC003 <=" + EndDateFull + @") 
                                                    AND x1.TC008 = 'Y' 
                                                    AND x1.TC015 != ''
                                                    " + ExcludeSql + @"
                                                    GROUP BY x1.TC015
                                                ) AS a
                                                INNER JOIN CMSMV b on a.TC015 = b.MV001
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TC013), 0) Amount 
                                                    FROM ACRTC x1
                                                    WHERE (x1.TC003 >=" + StartDateFull + @" AND x1.TC003 <=" + EndDateFull + @") 
                                                    AND x1.TC008 = 'Y' 
                                                    AND x1.TC015 != ''
                                                    " + ExcludeSql + @"
                                                ) AS c
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TC013), 0) Amount 
                                                    FROM ACRTC x1
                                                    WHERE (x1.TC003 LIKE '" + dateNow + @"__') 
                                                    AND x1.TC008 = 'Y' 
                                                    AND x1.TC015 = a.TC015
                                                    " + ExcludeSql + @"
                                                ) AS d
                                                ORDER BY a.Amount DESC";
                                        break;
                                    #endregion
                                    default:
                                        break;
                                }
                                break;
                            #endregion
                            #region //折線圖
                            case "Spline":
                                string AmountSting = "";
                                string AmountMoon = "";
                                string startDate = StartDate;
                                switch (Type)
                                {
                                    #region //訂單
                                    case "Sale":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        for (var i = 1; i <= 12; i++)
                                        {

                                            string year = startDate.Split('-')[0];
                                            string moon = startDate.Split('-')[1];
                                            DateTime dtStart = DateTime.ParseExact(startDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                                            if (dtStart.CompareTo(dtEnd) <= 0)
                                            {
                                                dtStart = dtStart.AddMonths(1);
                                                startDate = dtStart.ToString("yyyy-MM-dd");
                                            }
                                            else
                                            {
                                                break;
                                            }


                                            AmountSting += ",ROUND(CAST(ISNULL(b" + i + ".Amount, 0) AS FLOAT), 5)'Moon" + moon + "'";

                                            AmountMoon += @"
                                                     OUTER APPLY(
                                                        SELECT SUM(x1.TC009 * x1.TC029) Amount, x1.TC006  
                                                        FROM COPTC x1
                                                        WHERE x1.TC003 LIKE '%" + year + moon + @"%' 
                                                        AND x1.TC027 = 'Y' 
                                                        AND x1.TC006 != ''
                                                        AND a.TC006 = x1.TC006
                                                        GROUP BY TC006
                                                     ) b" + i + @"  
                                                    ";
                                        }

                                        sql = @"SELECT a.TC006 Money,a.MV002 Sales" + AmountSting + @"
                                                FROM (
                                                    SELECT DISTINCT x1.TC006,x2.MV002
                                                    FROM COPTC x1
                                                    INNER JOIN CMSMV x2 on x1.TC006 = x2.MV001
                                                    WHERE (x1.TC003 >= " + StartDateFull + @" AND x1.TC003 <" + EndDateFull + @") 
                                                    AND x1.TC006 != ''
                                                ) AS a" + AmountMoon + @"
                                                OUTER APPLY(
                                                        SELECT SUM(x1.TC009 * x1.TC029) Amount
                                                        FROM COPTC x1
                                                        WHERE (x1.TC003 >= " + StartDateFull + @" AND x1.TC003 <" + EndDateFull + @") 
                                                        AND x1.TC027 = 'Y'
                                                        AND x1.TC006 != ''
                                                        AND x1.TC006 = a.TC006
                                                ) AS c
                                                ORDER by c.Amount DESC";
                                        break;
                                    #endregion
                                    #region //出貨
                                    case "Delivery":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('1008','2034')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('ZY001','QY001')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                            ExcludeSql2 = "";
                                        }
                                        for (var i = 1; i <= 12; i++)
                                        {
                                            string year = startDate.Split('-')[0];
                                            string moon = startDate.Split('-')[1];
                                            DateTime dtStart = DateTime.ParseExact(startDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                                            if (dtStart.CompareTo(dtEnd) <= 0)
                                            {
                                                dtStart = dtStart.AddMonths(1);
                                                startDate = dtStart.ToString("yyyy-MM-dd");
                                            }
                                            else
                                            {
                                                break;
                                            }

                                            AmountSting += ",ROUND(CAST(ISNULL(b" + i + ".Amount, 0) AS FLOAT), 5)'Moon" + moon + "'";

                                            AmountMoon += @"
                                                     OUTER APPLY(
                                                        SELECT ISNULL(SUM(x1.TG013 * x2.TF012), 0) Amount,x2.TF008  
                                                        FROM INVTG x1
                                                        INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                        WHERE x2.TF024 LIKE '%" + year + moon + @"%' 
                                                        AND x1.TG008 ='C01'
                                                        AND x2.TF008 != ''
                                                        AND x2.TF020 = 'Y' 
                                                        AND a.TF008 = x2.TF008
                                                        " + ExcludeSql + @"
                                                        GROUP BY x2.TF008
                                                     ) b" + i + @"  
                                                    ";
                                        }

                                        sql = @"SELECT a.TF008 Money,a.MV002 Sales" + AmountSting + @"
                                                FROM (
                                                    SELECT DISTINCT x1.TF008,x2.MV002
                                                    FROM INVTF x1
                                                    INNER JOIN CMSMV x2 on x1.TF008 = x2.MV001
                                                    WHERE (x1.TF024 >= " + StartDateFull + @" AND x1.TF024 <" + EndDateFull + @") 
                                                    AND x1.TF008 != ''
                                                ) AS a" + AmountMoon + @"
                                                OUTER APPLY(
                                                        SELECT ISNULL(SUM(x1.TG013 * x2.TF012), 0) Amount
                                                        FROM INVTG x1
                                                        INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                        WHERE (x2.TF024 >= " + StartDateFull + @" AND x2.TF024 <" + EndDateFull + @") 
                                                        AND x1.TG008 ='C01'
                                                        AND x2.TF008 != ''
                                                        AND x2.TF020 = 'Y' 
                                                        AND a.TF008 = x2.TF008
                                                        " + ExcludeSql + @"
                                                ) AS c
                                                ORDER by c.Amount DESC";
                                        break;
                                    #endregion
                                    #region //銷貨
                                    case "Receive":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        for (var i = 1; i <= 12; i++)
                                        {
                                            string year = startDate.Split('-')[0];
                                            string moon = startDate.Split('-')[1];
                                            DateTime dtStart = DateTime.ParseExact(startDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                                            if (dtStart.CompareTo(dtEnd) <= 0)
                                            {
                                                dtStart = dtStart.AddMonths(1);
                                                startDate = dtStart.ToString("yyyy-MM-dd");
                                            }
                                            else
                                            {
                                                break;
                                            }

                                            AmountSting += ",ROUND(CAST(ISNULL(b" + i + ".Amount, 0) AS FLOAT), 5)'Moon" + moon + "'";

                                            AmountMoon += @"
                                                     OUTER APPLY(
                                                        SELECT SUM(x1.TG045) Amount, x1.TG006  
                                                        FROM COPTG x1
                                                        WHERE x1.TG003 LIKE '%" + year + moon + @"%' 
                                                        AND x1.TG023 = 'Y' 
                                                        AND x1.TG006 != ''
                                                        AND a.TG006 = x1.TG006
                                                        " + ExcludeSql + @"
                                                        GROUP BY x1.TG006
                                                     ) b" + i + @"  
                                                    ";
                                        }

                                        sql = @"SELECT a.TG006 Money,a.MV002 Sales" + AmountSting + @"
                                                FROM (
                                                    SELECT DISTINCT x1.TG006,x2.MV002
                                                    FROM COPTG x1
                                                    INNER JOIN CMSMV x2 on x1.TG006 = x2.MV001
                                                    WHERE (x1.TG003 >= " + StartDateFull + @" AND x1.TG003 <" + EndDateFull + @") 
                                                    AND x1.TG006 != ''
                                                ) AS a" + AmountMoon + @"
                                                OUTER APPLY(
                                                        SELECT SUM(x1.TG045) Amount
                                                        FROM COPTG x1
                                                        WHERE (x1.TG003 >= " + StartDateFull + @" AND x1.TG003 <" + EndDateFull + @") 
                                                        AND x1.TG023 = 'Y'
                                                        AND x1.TG006 != ''
                                                        AND x1.TG006 = a.TG006
                                                        " + ExcludeSql + @"
                                                ) AS c
                                                ORDER by c.Amount DESC";
                                        break;
                                    #endregion
                                    #region //收款
                                    case "Collection":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        for (var i = 1; i <= 12; i++)
                                        {

                                            string year = startDate.Split('-')[0];
                                            string moon = startDate.Split('-')[1];
                                            DateTime dtStart = DateTime.ParseExact(startDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                                            if (dtStart.CompareTo(dtEnd) <= 0)
                                            {
                                                dtStart = dtStart.AddMonths(1);
                                                startDate = dtStart.ToString("yyyy-MM-dd");
                                            }
                                            else
                                            {
                                                break;
                                            }


                                            AmountSting += ",ROUND(CAST(ISNULL(b" + i + ".Amount, 0) AS FLOAT), 5)'Moon" + moon + "'";

                                            AmountMoon += @"
                                                     OUTER APPLY(
                                                        SELECT SUM(x1.TC013) Amount, x1.TC015  
                                                        FROM ACRTC x1
                                                        WHERE x1.TC003 LIKE '%" + year + moon + @"%' 
                                                        AND x1.TC008 = 'Y' 
                                                        AND x1.TC015 != ''
                                                        AND a.TC015 = x1.TC015
                                                        " + ExcludeSql + @"
                                                        GROUP BY x1.TC015
                                                     ) b" + i + @"  
                                                    ";
                                        }

                                        sql = @"SELECT a.TC015 Money,a.MV002 Sales" + AmountSting + @"
                                                FROM (
                                                    SELECT DISTINCT x1.TC015,x2.MV002
                                                    FROM ACRTC x1
                                                    INNER JOIN CMSMV x2 on x1.TC015 = x2.MV001
                                                    WHERE (x1.TC003 >= " + StartDateFull + @" AND x1.TC003 <" + EndDateFull + @") 
                                                    AND x1.TC015 != ''
                                                ) AS a" + AmountMoon + @"
                                                OUTER APPLY(
                                                        SELECT SUM(x1.TC013) Amount
                                                        FROM ACRTC x1
                                                        WHERE (x1.TC003 >= " + StartDateFull + @" AND x1.TC003 <" + EndDateFull + @") 
                                                        AND x1.TC008 = 'Y'
                                                        AND x1.TC015 != ''
                                                        AND x1.TC015 = a.TC015
                                                        " + ExcludeSql + @"
                                                ) AS c
                                                ORDER by c.Amount DESC";
                                        break;
                                    #endregion
                                    default:
                                        break;
                                }
                                break;
                            #endregion
                            default:
                                break;
                        }

                        #region //SQL執行+合併各公司資料
                        if (Model == "Bar")
                        {
                            barResult = sqlConnection.Query<Bar>(sql, dynamicParameters).ToList();

                            barResult.ToList()
                            .ForEach(x =>
                            {
                                foreach (var intent in intentAmount)
                                {
                                    if (x.Sales == intent.Sales)
                                    {
                                        x.IntentAmount = intent.IntentAmount;
                                    }
                                }
                                if (x.IntentAmount == null) x.IntentAmount = 0;
                                x.Company = MESCompanyNo;
                            });

                            List<int> elementsToRemove = new List<int>();
                            barResultAll.ToList()
                            .ForEach(x =>
                            {
                                int indexBarResult = 0;

                                foreach (var item2 in barResult)
                                {
                                    if (x.Sales == item2.Sales)
                                    {
                                        x.Amount += item2.Amount;
                                        x.MoonAmount += item2.MoonAmount;
                                        elementsToRemove.Add(indexBarResult);
                                    }
                                    indexBarResult++;
                                }
                            });
                            elementsToRemove.Sort((a, b) => b.CompareTo(a));

                            // 反向迭代列表並刪除指定索引的元素
                            for (int i = 0; i <= elementsToRemove.Count - 1; i++)
                            {
                                int indexToRemove = elementsToRemove[i];
                                if (indexToRemove >= 0 && indexToRemove < barResult.Count)
                                {
                                    barResult.RemoveAt(indexToRemove);
                                }
                            }
                            barResultAll.AddRange(barResult);
                        }
                        else if (Model == "Spline")
                        {
                            splineResult = sqlConnection.Query<Spline>(sql, dynamicParameters).ToList();

                            List<int> elementsToRemove = new List<int>();
                            splineResultAll.ToList()
                            .ForEach(x =>
                            {
                                int indexBarResult = 0;

                                foreach (var item2 in splineResult)
                                {
                                    if (x.Sales == item2.Sales)
                                    {
                                        x.Moon01 += item2.Moon01;
                                        x.Moon02 += item2.Moon02;
                                        x.Moon03 += item2.Moon03;
                                        x.Moon04 += item2.Moon04;
                                        x.Moon05 += item2.Moon05;
                                        x.Moon06 += item2.Moon06;
                                        x.Moon07 += item2.Moon07;
                                        x.Moon08 += item2.Moon08;
                                        x.Moon09 += item2.Moon09;
                                        x.Moon10 += item2.Moon10;
                                        x.Moon11 += item2.Moon11;
                                        x.Moon12 += item2.Moon12;
                                        elementsToRemove.Add(indexBarResult);
                                    }
                                    indexBarResult++;
                                }
                            });
                            elementsToRemove.Sort((a, b) => b.CompareTo(a));

                            // 反向迭代列表並刪除指定索引的元素
                            for (int i = 0; i <= elementsToRemove.Count - 1; i++)
                            {
                                int indexToRemove = elementsToRemove[i];
                                if (indexToRemove >= 0 && indexToRemove < splineResult.Count)
                                {
                                    splineResult.RemoveAt(indexToRemove);
                                }
                            }
                            splineResultAll.AddRange(splineResult);
                        }
                        else
                        {
                            throw new SystemException("【Model】資料有問題請重新確認!");
                        }
                        #endregion

                    }
                }

                if (Model == "Bar")
                {
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = barResultAll.OrderByDescending(bar => bar.Amount).ToList()
                    });
                    #endregion
                }
                else if (Model == "Spline")
                {
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = splineResultAll
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSaleRankingListVe2 -- 取得業務成績排行(BY客戶業務) -- Shintokuro 2023.11.17
        public string GetSaleRankingListVe2(string Type, string Model, string StartDate, string EndDate
            , string CompanyList, int PgId, string ExcludeStatus)
        {
            try
            {
                string MESCompanyNo = "";
                string ErpNo = "";
                string ErpDb = "";
                string StartDateFull = "";
                string EndDateFull = "";
                string ExcludeSql = "";
                string ExcludeSql2 = "";
                DateTime dtEnd = new DateTime();
                if (StartDate.Split('-').Length == 2)
                {
                    StartDateFull = StartDate.Replace("-", "") + "01";
                    StartDate = StartDate + "-01";
                }
                else if (StartDate.Split('-').Length == 3)
                {
                    StartDateFull = StartDate.Replace("-", "");
                }

                if (EndDate.Split('-').Length == 2)
                {
                    int lastDay = DateTime.DaysInMonth(Convert.ToInt32(EndDate.Split('-')[0]), Convert.ToInt32(EndDate.Split('-')[1]));
                    EndDateFull = EndDate.Replace("-", "") + lastDay.ToString().PadLeft(2, '0');
                    dtEnd = DateTime.ParseExact(EndDate, "yyyy-MM", System.Globalization.CultureInfo.InvariantCulture);

                }
                else if (EndDate.Split('-').Length == 3)
                {
                    EndDateFull = EndDate.Replace("-", "");
                    dtEnd = DateTime.ParseExact(EndDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);

                }

                string dateNow = DateTime.Now.ToString("yyyyMM");
                //dateNow = "202305";
                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                List<Bar> barResult = new List<Bar>();
                List<Bar> intentAmount = new List<Bar>();
                List<Bar> barResultAll = new List<Bar>();
                List<Spline> splineResult = new List<Spline>();
                List<Spline> splineResultAll = new List<Spline>();

                foreach (var Company in CompanyList.Split(','))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", Company);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            MESCompanyNo = item.ErpNo;
                            ErpDb = item.ErpDb;
                        }
                        #endregion


                        #region //取得目標業績資料
                        if (PgId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT
                                     FORMAT(a.StartDate, 'yyyyMMdd') StartDate
                                    , FORMAT(a.EndDate, 'yyyyMMdd') EndDate
                                    FROM SCM.PerformanceGoals a
                                    WHERE a.PgId = @PgId";
                            dynamicParameters.Add("PgId", PgId);

                            var resultPg = sqlConnection.Query(sql, dynamicParameters);
                            if (resultPg.Count() <= 0) throw new SystemException("【目標業績】資料找不到請重新確認!");

                            //foreach (var item in resultPg)
                            //{
                            //    StartDateFull = item.StartDate;
                            //    EndDateFull = item.EndDate;
                            //}

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UserId, b.UserNo SalesNo, a.IntentAmount
                                    FROM SCM.PgDetail a
                                    INNER JOIN BAS.[User] b on a.UserId = b.UserId
                                    WHERE a.PgId = @PgId
                                    AND a.IntentType = @IntentType";
                            dynamicParameters.Add("PgId", PgId);
                            switch (Type)
                            {
                                case "Sale":
                                    dynamicParameters.Add("IntentType", "S");
                                    break;
                                case "Delivery":
                                    dynamicParameters.Add("IntentType", "D");
                                    break;
                                case "Receive":
                                    dynamicParameters.Add("IntentType", "R");
                                    break;
                                case "Collection":
                                    dynamicParameters.Add("IntentType", "C");
                                    break;
                            }

                            intentAmount = sqlConnection.Query<Bar>(sql, dynamicParameters).ToList();

                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        switch (Model)
                        {
                            #region //長條圖
                            case "Bar":
                                switch (Type)
                                {
                                    #region //訂單
                                    case "Sale":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        sql = @"SELECT ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) Amount
                                                ,CASE 
                                                    WHEN a.MA016 ='' THEN 'OTHER'
                                                    ELSE a.MA016
                                                END AS SalesNo,
                                                CASE WHEN b.MV002 IS NULL THEN '其他'
                                                    ELSE b.MV002
                                                END AS Sales
                                                ,c.Amount AllAmount,d.Amount MoonAmount
                                                FROM (
                                                    SELECT x2.MA016,ISNULL(SUM(x1.TC009 * x1.TC029), 0) Amount
                                                    FROM COPTC x1
                                                    INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                    LEFT JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TC003 >=" + StartDateFull + @" AND x1.TC003 <=" + EndDateFull + @") 
                                                    AND x1.TC027 = 'Y' 
                                                    AND x1.TC004 != ''
                                                    AND x1.TC029 != 0
                                                    " + ExcludeSql + @"
                                                    GROUP BY x2.MA016
                                                ) AS a
                                                LEFT JOIN CMSMV b on a.MA016 = b.MV001
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TC009 * x1.TC029), 0) Amount 
                                                    FROM COPTC x1
                                                    WHERE (x1.TC003 >=" + StartDateFull + @" AND x1.TC003 <=" + EndDateFull + @") 
                                                    AND x1.TC027 = 'Y' 
                                                    " + ExcludeSql + @"
                                                ) AS c
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TC009 * x1.TC029), 0) Amount 
                                                    FROM COPTC x1
                                                    INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                    LEFT JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TC003 LIKE '" + dateNow + @"__') 
                                                    AND x1.TC027 = 'Y' 
                                                    AND x1.TC004 != ''
                                                    AND x2.MA016 = a.MA016
                                                    " + ExcludeSql + @"
                                                ) AS d
                                                ORDER BY a.Amount DESC";
                                        break;
                                    #endregion
                                    #region //出貨
                                    case "Delivery":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('1008','2034')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('ZY001','QY001')";
                                                    ExcludeSql2 += "AND x2.TH005  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                            ExcludeSql2 = "";
                                        }
                                        sql = @"SELECT 
                                                CASE 
                                                    WHEN a.MA016 ='' THEN 'OTHER'
                                                    ELSE a.MA016
                                                END AS SalesNo,
                                                CASE WHEN b.MV002 IS NULL THEN '其他'
                                                    ELSE b.MV002
                                                END AS Sales
                                                ,d.Amount MoonAmount
                                                ,(ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) - ROUND(CAST(ISNULL(e.Amount, 0) AS FLOAT), 5)) AS Amount
                                                , ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) TotalAmount
                                                , ROUND(CAST(ISNULL(e.Amount, 0) AS FLOAT), 5) ReturnAmount
                                                ,(ROUND(CAST(ISNULL(c.Amount, 0) AS FLOAT), 5) - ROUND(CAST(ISNULL(f.Amount, 0) AS FLOAT), 5)) AS AllAmount
                                                ,c.Amount AllTotalAmount
                                                ,f.Amount AllReutrnAmount
                                                FROM (
                                                    SELECT ISNULL(SUM(x1.TG013 * x2.TF012), 0) Amount, x3.MA016  
                                                    FROM INVTG x1
                                                    INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                    INNER JOIN COPMA x3 on x2.TF005 = x3.MA001
                                                    LEFT JOIN CMSMV x4 on x3.MA016 = x4.MV001
                                                    WHERE (x2.TF024 >=" + StartDateFull + @" AND x2.TF024 <=" + EndDateFull + @") 
                                                    AND x2.TF020 = 'Y'
                                                    AND x1.TG008 ='C01'
                                                    " + ExcludeSql + @"
                                                    GROUP BY x3.MA016
                                                ) AS a
                                                LEFT JOIN CMSMV b on a.MA016 = b.MV001
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TG013 * x2.TF012), 0) Amount 
                                                    FROM INVTG x1
                                                    INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                    WHERE (x2.TF024 >=" + StartDateFull + @" AND x2.TF024 <=" + EndDateFull + @") 
                                                    AND x1.TG008 ='C01'
                                                    AND x2.TF020 = 'Y'
                                                    " + ExcludeSql + @"
                                                ) AS c
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TG013 * x2.TF012),0) Amount 
                                                    FROM INVTG x1
                                                    INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                    INNER JOIN COPMA x3 on x2.TF005 = x3.MA001
                                                    LEFT JOIN CMSMV x4 on x3.MA016 = x4.MV001
                                                    WHERE (x2.TF024 LIKE '" + dateNow + @"__') 
                                                    AND x1.TG008 ='C01'
                                                    AND x2.TF020 = 'Y'  
                                                    AND x3.MA016 = a.MA016
                                                    " + ExcludeSql + @"
                                                ) AS d
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TI013 * x2.TH012), 0)  Amount 
                                                    FROM INVTI x1
                                                    INNER JOIN INVTH x2 on x1.TI001 = x2.TH001 AND x1.TI002 = x2.TH002
                                                    INNER JOIN COPMA x3 on x2.TH005 = x3.MA001
                                                    LEFT JOIN CMSMV x4 on x3.MA016 = x4.MV001
                                                    WHERE (x2.TH023 >=" + StartDateFull + @" AND x2.TH023 <=" + EndDateFull + @") 
                                                    AND x1.TI007 ='C01'
                                                    AND x2.TH020 = 'Y' 
                                                    AND x2.TH008 = a.MA016
                                                    " + ExcludeSql2 + @"
                                                ) AS e
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TI013 * x2.TH012), 0) Amount 
                                                    FROM INVTI x1
                                                    INNER JOIN INVTH x2 on x1.TI001 = x2.TH001 AND x1.TI002 = x2.TH002
                                                    WHERE (x2.TH023 >=" + StartDateFull + @" AND x2.TH023 <=" + EndDateFull + @") 
                                                    AND x1.TI007 ='C01'
                                                    AND x2.TH020 = 'Y' 
                                                    AND x2.TH008 != ''                                                
                                                    " + ExcludeSql2 + @"
                                                ) AS f
                                                ORDER BY a.Amount DESC
                                                ";
                                        break;
                                    #endregion
                                    #region //銷貨
                                    case "Receive":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    ExcludeSql2 += "AND x1.TI004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('1008','2034')";
                                                    ExcludeSql2 += "AND x1.TI004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('ZY001','QY001')";
                                                    ExcludeSql2 += "AND x1.TI004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        sql = @"SELECT 
                                                CASE 
                                                    WHEN a.MA016 ='' THEN 'OTHER'
                                                    ELSE a.MA016
                                                END AS SalesNo,
                                                CASE WHEN b.MV002 IS NULL THEN '其他'
                                                    ELSE b.MV002
                                                END AS Sales
                                                ,d.Amount MoonAmount
                                                ,(ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) - ROUND(CAST(ISNULL(e.Amount, 0) AS FLOAT), 5)) AS Amount
                                                , ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) TotalAmount
                                                , ROUND(CAST(ISNULL(e.Amount, 0) AS FLOAT), 5) ReturnAmount
                                                ,(ROUND(CAST(ISNULL(c.Amount, 0) AS FLOAT), 5) - ROUND(CAST(ISNULL(f.Amount, 0) AS FLOAT), 5)) AS AllAmount
                                                ,c.Amount AllTotalAmount
                                                ,f.Amount AllReutrnAmount
                                                FROM (
                                                    SELECT ISNULL(SUM(x1.TG045),0) Amount, x2.MA016  
                                                    FROM COPTG x1
                                                    INNER JOIN COPMA x2 on x1.TG004 = x2.MA001
                                                    LEFT JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TG003 >=" + StartDateFull + @" AND x1.TG003 <=" + EndDateFull + @") 
                                                    AND x1.TG023 = 'Y' 
                                                    " + ExcludeSql + @"
                                                    GROUP BY x2.MA016
                                                ) AS a
                                                LEFT JOIN CMSMV b on a.MA016 = b.MV001
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TG045),0) Amount 
                                                    FROM COPTG x1
                                                    WHERE (x1.TG003 >=" + StartDateFull + @" AND x1.TG003 <=" + EndDateFull + @") 
                                                    AND x1.TG023 = 'Y' 
                                                    " + ExcludeSql + @"
                                                ) AS c
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TG045),0) Amount 
                                                    FROM COPTG x1
                                                    INNER JOIN COPMA x2 on x1.TG004 = x2.MA001
                                                    LEFT JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TG003 LIKE '" + dateNow + @"__') 
                                                    AND x1.TG023 = 'Y' 
                                                    AND x2.MA016 = a.MA016
                                                    " + ExcludeSql + @"
                                                ) AS d
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TI037), 0)  Amount 
                                                    FROM COPTI x1
                                                    INNER JOIN COPMA x2 on x1.TI004 = x2.MA001
                                                    LEFT JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TI034 >=" + StartDateFull + @" AND x1.TI034 <=" + EndDateFull + @") 
                                                    AND x1.TI019 = 'Y' 
                                                    AND x2.MA016 = a.MA016
                                                    " + ExcludeSql2 + @"
                                                ) AS e
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TI037), 0) Amount 
                                                    FROM COPTI x1
                                                    WHERE (x1.TI034 >=" + StartDateFull + @" AND x1.TI034 <=" + EndDateFull + @") 
                                                    AND x1.TI019 = 'Y' 
                                                    " + ExcludeSql2 + @"
                                                ) AS f
                                                ORDER BY a.Amount DESC
                                                ";
                                        break;
                                    #endregion
                                    #region //收款
                                    case "Collection":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN  ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN  ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        sql = @"SELECT ROUND(CAST(ISNULL(a.Amount, 0) AS FLOAT), 5) Amount
                                                ,CASE 
                                                    WHEN a.MA016 ='' THEN 'OTHER'
                                                    ELSE a.MA016
                                                END AS SalesNo,
                                                CASE WHEN b.MV002 IS NULL THEN '其他'
                                                    ELSE b.MV002
                                                END AS Sales
                                                ,c.Amount AllAmount,d.Amount MoonAmount
                                                FROM (
                                                    SELECT x2.MA016,ISNULL(SUM(x1.TC013), 0) Amount
                                                    FROM ACRTC x1
                                                    INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                    LEFT JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TC003 >=" + StartDateFull + @" AND x1.TC003 <=" + EndDateFull + @") 
                                                    AND x1.TC008 = 'Y' 
                                                    AND x1.TC004 != ''
                                                    AND x1.TC013 != 0
                                                    " + ExcludeSql + @"
                                                    GROUP BY x2.MA016
                                                ) AS a
                                                LEFT JOIN CMSMV b on a.MA016 = b.MV001
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TC013), 0) Amount 
                                                    FROM ACRTC x1
                                                    WHERE (x1.TC003 >=" + StartDateFull + @" AND x1.TC003 <=" + EndDateFull + @") 
                                                    AND x1.TC008 = 'Y' 
                                                    " + ExcludeSql + @"
                                                ) AS c
                                                OUTER APPLY (
                                                    SELECT ISNULL(SUM(x1.TC013), 0) Amount 
                                                    FROM ACRTC x1
                                                    INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                    LEFT JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TC003 LIKE '" + dateNow + @"__') 
                                                    AND x1.TC008 = 'Y' 
                                                    AND x1.TC004 != ''
                                                    AND x2.MA016 = a.MA016
                                                    " + ExcludeSql + @"
                                                ) AS d
                                                ORDER BY a.Amount DESC";
                                        break;
                                    #endregion
                                    default:
                                        break;
                                }
                                break;
                            #endregion
                            #region //折線圖
                            case "Spline":
                                string AmountSting = "";
                                string AmountMoon = "";
                                string startDate = StartDate;
                                switch (Type)
                                {
                                    #region //訂單
                                    case "Sale":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        for (var i = 1; i <= 12; i++)
                                        {

                                            string year = startDate.Split('-')[0];
                                            string moon = startDate.Split('-')[1];
                                            DateTime dtStart = DateTime.ParseExact(startDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                                            if (dtStart.CompareTo(dtEnd) <= 0)
                                            {
                                                dtStart = dtStart.AddMonths(1);
                                                startDate = dtStart.ToString("yyyy-MM-dd");
                                            }
                                            else
                                            {
                                                break;
                                            }


                                            AmountSting += ",ROUND(CAST(ISNULL(b" + i + ".Amount, 0) AS FLOAT), 5)'Moon" + moon + "'";

                                            AmountMoon += @"
                                                     OUTER APPLY(
                                                        SELECT SUM(x1.TC009 * x1.TC029) Amount, x2.MA016  
                                                        FROM COPTC x1
                                                        INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                        LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                        WHERE x1.TC003 LIKE '%" + year + moon + @"%' 
                                                        AND x1.TC027 = 'Y' 
                                                        AND a.MA016 = x2.MA016
                                                        " + ExcludeSql + @"
                                                        GROUP BY x2.MA016
                                                     ) b" + i + @"  
                                                    ";
                                        }

                                        sql = @"SELECT 
                                                    CASE 
                                                        WHEN a.MA016 ='' THEN 'OTHER'
                                                        ELSE a.MA016
                                                    END AS Money,
                                                    a.MA016,
                                                    CASE WHEN a.MV002 IS NULL THEN '其他'
                                                    ELSE a.MV002
                                                    END AS Sales
                                                    " + AmountSting + @"
                                                FROM (
                                                    SELECT DISTINCT x2.MA016,x3.MV002
                                                    FROM COPTC x1
                                                    INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                    LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TC003 >= " + StartDateFull + @" AND x1.TC003 <" + EndDateFull + @") 
                                                    " + ExcludeSql + @"
                                                ) AS a" + AmountMoon + @"
                                                OUTER APPLY(
                                                        SELECT SUM(x1.TC009 * x1.TC029) Amount
                                                        FROM COPTC x1
                                                        INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                        LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                        WHERE (x1.TC003 >= " + StartDateFull + @" AND x1.TC003 <" + EndDateFull + @") 
                                                        AND x1.TC027 = 'Y'
                                                        AND x2.MA016 = a.MA016
                                                        " + ExcludeSql + @"
                                                ) AS c
                                                ORDER by c.Amount DESC";
                                        break;
                                    #endregion
                                    #region //出貨
                                    case "Delivery":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    ExcludeSql2 += "AND x1.TF005  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('1008','2034')";
                                                    ExcludeSql2 += "AND x1.TF005  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x2.TF005  NOT  IN ('ZY001','QY001')";
                                                    ExcludeSql2 += "AND x1.TF005  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                            ExcludeSql2 = "";
                                        }
                                        for (var i = 1; i <= 12; i++)
                                        {
                                            string year = startDate.Split('-')[0];
                                            string moon = startDate.Split('-')[1];
                                            DateTime dtStart = DateTime.ParseExact(startDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                                            if (dtStart.CompareTo(dtEnd) <= 0)
                                            {
                                                dtStart = dtStart.AddMonths(1);
                                                startDate = dtStart.ToString("yyyy-MM-dd");
                                            }
                                            else
                                            {
                                                break;
                                            }

                                            AmountSting += ",ROUND(CAST(ISNULL(b" + i + ".Amount, 0) AS FLOAT), 5)'Moon" + moon + "'";

                                            AmountMoon += @"
                                                     OUTER APPLY(
                                                        SELECT ISNULL(SUM(x1.TG013 * x2.TF012), 0) Amount, x3.MA016  
                                                        FROM INVTG x1
                                                        INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                        INNER JOIN COPMA x3 on x2.TF005 = x3.MA001
                                                        LEFT  JOIN CMSMV x4 on x3.MA016 = x4.MV001
                                                        WHERE x2.TF024 LIKE '%" + year + moon + @"%' 
                                                        AND x1.TG008 ='C01'
                                                        AND x2.TF020 = 'Y' 
                                                        AND x3.MA016 = a.MA016
                                                        " + ExcludeSql + @"
                                                        GROUP BY x3.MA016
                                                     ) b" + i + @"  
                                                    ";
                                        }

                                        sql = @"SELECT 
                                                    CASE 
                                                        WHEN a.MA016 ='' THEN 'OTHER'
                                                        ELSE a.MA016
                                                    END AS Money,
                                                    a.MA016,
                                                    CASE WHEN a.MV002 IS NULL THEN '其他'
                                                    ELSE a.MV002
                                                    END AS Sales
                                                    " + AmountSting + @"
                                                FROM (
                                                    SELECT DISTINCT x2.MA016,x3.MV002
                                                    FROM INVTF x1
                                                    INNER JOIN COPMA x2 on x1.TF005 = x2.MA001
                                                    LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TF024 >= " + StartDateFull + @" AND x1.TF024 <" + EndDateFull + @") 
                                                    " + ExcludeSql2 + @"
                                                ) AS a" + AmountMoon + @"
                                                OUTER APPLY(
                                                        SELECT ISNULL(SUM(x1.TG013 * x2.TF012), 0) Amount
                                                        FROM INVTG x1
                                                        INNER JOIN INVTF x2 on x1.TG001 = x2.TF001 AND x1.TG002 = x2.TF002
                                                        INNER JOIN COPMA x3 on x2.TF005 = x3.MA001
                                                        LEFT  JOIN CMSMV x4 on x3.MA016 = x4.MV001
                                                        WHERE (x2.TF024 >= " + StartDateFull + @" AND x2.TF024 <" + EndDateFull + @") 
                                                        AND x1.TG008 ='C01'
                                                        AND x2.TF020 = 'Y'
                                                        AND x3.MA016 = a.MA016
                                                        " + ExcludeSql + @"
                                                ) AS c
                                                ORDER by c.Amount DESC";
                                        break;
                                    #endregion
                                    #region //銷貨
                                    case "Receive":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TG004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        for (var i = 1; i <= 12; i++)
                                        {
                                            string year = startDate.Split('-')[0];
                                            string moon = startDate.Split('-')[1];
                                            DateTime dtStart = DateTime.ParseExact(startDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                                            if (dtStart.CompareTo(dtEnd) <= 0)
                                            {
                                                dtStart = dtStart.AddMonths(1);
                                                startDate = dtStart.ToString("yyyy-MM-dd");
                                            }
                                            else
                                            {
                                                break;
                                            }

                                            AmountSting += ",ROUND(CAST(ISNULL(b" + i + ".Amount, 0) AS FLOAT), 5)'Moon" + moon + "'";

                                            AmountMoon += @"
                                                     OUTER APPLY(
                                                        SELECT SUM(x1.TG045) Amount, x2.MA016  
                                                        FROM COPTG x1
                                                        INNER JOIN COPMA x2 on x1.TG004 = x2.MA001
                                                        LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                        WHERE x1.TG003 LIKE '%" + year + moon + @"%' 
                                                        AND x1.TG023 = 'Y' 
                                                        AND a.MA016 = x2.MA016
                                                        " + ExcludeSql + @"
                                                        GROUP BY x2.MA016
                                                     ) b" + i + @"  
                                                    ";
                                        }

                                        sql = @"SELECT 
                                                    CASE 
                                                        WHEN a.MA016 ='' THEN 'OTHER'
                                                        ELSE a.MA016
                                                    END AS Money,
                                                    CASE WHEN a.MV002 IS NULL THEN '其他'
                                                    ELSE a.MV002
                                                    END AS Sales
                                                " + AmountSting + @"
                                                FROM (
                                                    SELECT DISTINCT x2.MA016,x3.MV002
                                                    FROM COPTG x1
                                                    INNER JOIN COPMA x2 on x1.TG004 = x2.MA001
                                                    LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TG003 >= " + StartDateFull + @" AND x1.TG003 <" + EndDateFull + @") 
                                                    " + ExcludeSql + @"
                                                ) AS a" + AmountMoon + @"
                                                OUTER APPLY(
                                                        SELECT SUM(x1.TG045) Amount
                                                        FROM COPTG x1
                                                        INNER JOIN COPMA x2 on x1.TG004 = x2.MA001
                                                        LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                        WHERE (x1.TG003 >= " + StartDateFull + @" AND x1.TG003 <" + EndDateFull + @") 
                                                        AND x1.TG023 = 'Y'
                                                        AND x2.MA016 = a.MA016
                                                        " + ExcludeSql + @"
                                                ) AS c
                                                ORDER by c.Amount DESC";
                                        break;
                                    #endregion
                                    #region //收款
                                    case "Collection":
                                        if (ExcludeStatus == "Y")
                                        {
                                            switch (Company)
                                            {
                                                case "2":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('Z999','7777777','J002','H005','J003','E005')";
                                                    break;
                                                case "3":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('1008','2034')";
                                                    break;
                                                case "4":
                                                    ExcludeSql += "AND x1.TC004  NOT  IN ('ZY001','QY001')";
                                                    break;
                                            }
                                        }
                                        else
                                        {
                                            ExcludeSql = "";
                                        }
                                        for (var i = 1; i <= 12; i++)
                                        {

                                            string year = startDate.Split('-')[0];
                                            string moon = startDate.Split('-')[1];
                                            DateTime dtStart = DateTime.ParseExact(startDate, "yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture);
                                            if (dtStart.CompareTo(dtEnd) <= 0)
                                            {
                                                dtStart = dtStart.AddMonths(1);
                                                startDate = dtStart.ToString("yyyy-MM-dd");
                                            }
                                            else
                                            {
                                                break;
                                            }


                                            AmountSting += ",ROUND(CAST(ISNULL(b" + i + ".Amount, 0) AS FLOAT), 5)'Moon" + moon + "'";

                                            AmountMoon += @"
                                                     OUTER APPLY(
                                                        SELECT SUM(x1.TC013) Amount, x2.MA016  
                                                        FROM ACRTC x1
                                                        INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                        LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                        WHERE x1.TC003 LIKE '%" + year + moon + @"%' 
                                                        AND x1.TC008 = 'Y' 
                                                        AND a.MA016 = x2.MA016
                                                        " + ExcludeSql + @"
                                                        GROUP BY x2.MA016
                                                     ) b" + i + @"  
                                                    ";
                                        }

                                        sql = @"SELECT 
                                                    CASE 
                                                        WHEN a.MA016 ='' THEN 'OTHER'
                                                        ELSE a.MA016
                                                    END AS Money,
                                                    a.MA016,
                                                    CASE WHEN a.MV002 IS NULL THEN '其他'
                                                    ELSE a.MV002
                                                    END AS Sales
                                                    " + AmountSting + @"
                                                FROM (
                                                    SELECT DISTINCT x2.MA016,x3.MV002
                                                    FROM ACRTC x1
                                                    INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                    LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                    WHERE (x1.TC003 >= " + StartDateFull + @" AND x1.TC003 <" + EndDateFull + @") 
                                                    " + ExcludeSql + @"
                                                ) AS a" + AmountMoon + @"
                                                OUTER APPLY(
                                                        SELECT SUM(x1.TC013) Amount
                                                        FROM ACRTC x1
                                                        INNER JOIN COPMA x2 on x1.TC004 = x2.MA001
                                                        LEFT  JOIN CMSMV x3 on x2.MA016 = x3.MV001
                                                        WHERE (x1.TC003 >= " + StartDateFull + @" AND x1.TC003 <" + EndDateFull + @") 
                                                        AND x1.TC008 = 'Y'
                                                        AND x2.MA016 = a.MA016
                                                        " + ExcludeSql + @"
                                                ) AS c
                                                ORDER by c.Amount DESC";
                                        break;
                                    #endregion
                                    default:
                                        break;
                                }
                                break;
                            #endregion
                            default:
                                break;
                        }

                        #region //SQL執行+合併各公司資料
                        if (Model == "Bar")
                        {
                            barResult = sqlConnection.Query<Bar>(sql, dynamicParameters).ToList();

                            barResult.ToList()
                            .ForEach(x =>
                            {
                                foreach (var intent in intentAmount)
                                {
                                    if (x.SalesNo == intent.SalesNo)
                                    {
                                        x.IntentAmount = intent.IntentAmount;
                                    }
                                }
                                if (x.IntentAmount == null) x.IntentAmount = 0;
                                x.Company = MESCompanyNo;
                            });

                            List<int> elementsToRemove = new List<int>();
                            barResultAll.ToList()
                            .ForEach(x =>
                            {
                                int indexBarResult = 0;

                                foreach (var item2 in barResult)
                                {
                                    if (x.Sales == item2.Sales)
                                    {
                                        x.Amount += item2.Amount;
                                        x.MoonAmount += item2.MoonAmount;
                                        elementsToRemove.Add(indexBarResult);
                                    }
                                    indexBarResult++;
                                }
                            });
                            elementsToRemove.Sort((a, b) => b.CompareTo(a));

                            // 反向迭代列表並刪除指定索引的元素
                            for (int i = 0; i <= elementsToRemove.Count - 1; i++)
                            {
                                int indexToRemove = elementsToRemove[i];
                                if (indexToRemove >= 0 && indexToRemove < barResult.Count)
                                {
                                    barResult.RemoveAt(indexToRemove);
                                }
                            }
                            barResultAll.AddRange(barResult);
                        }
                        else if (Model == "Spline")
                        {
                            splineResult = sqlConnection.Query<Spline>(sql, dynamicParameters).ToList();

                            List<int> elementsToRemove = new List<int>();
                            splineResultAll.ToList()
                            .ForEach(x =>
                            {
                                int indexBarResult = 0;

                                foreach (var item2 in splineResult)
                                {
                                    if (x.Sales == item2.Sales)
                                    {
                                        x.Moon01 += item2.Moon01;
                                        x.Moon02 += item2.Moon02;
                                        x.Moon03 += item2.Moon03;
                                        x.Moon04 += item2.Moon04;
                                        x.Moon05 += item2.Moon05;
                                        x.Moon06 += item2.Moon06;
                                        x.Moon07 += item2.Moon07;
                                        x.Moon08 += item2.Moon08;
                                        x.Moon09 += item2.Moon09;
                                        x.Moon10 += item2.Moon10;
                                        x.Moon11 += item2.Moon11;
                                        x.Moon12 += item2.Moon12;
                                        elementsToRemove.Add(indexBarResult);
                                    }
                                    indexBarResult++;
                                }
                            });
                            elementsToRemove.Sort((a, b) => b.CompareTo(a));

                            // 反向迭代列表並刪除指定索引的元素
                            for (int i = 0; i <= elementsToRemove.Count - 1; i++)
                            {
                                int indexToRemove = elementsToRemove[i];
                                if (indexToRemove >= 0 && indexToRemove < splineResult.Count)
                                {
                                    splineResult.RemoveAt(indexToRemove);
                                }
                            }
                            splineResultAll.AddRange(splineResult);
                        }
                        else
                        {
                            throw new SystemException("【Model】資料有問題請重新確認!");
                        }
                        #endregion

                    }
                }

                if (Model == "Bar")
                {
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = barResultAll.OrderByDescending(bar => bar.Amount).ToList()
                    });
                    #endregion
                }
                else if (Model == "Spline")
                {
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = splineResultAll
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        
        #region //GetAllowUserIp -- 取得允許登入使用者 -- Ted 2023-12-22
        public string GetAllowUserIp(string ClientIP)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    DynamicParameters dynamicParameters = new DynamicParameters();
                    string AllowStatus = "N";
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1
                            FROM BAS.AllowUserIp a
                            WHERE a.IpAddress = @ClientIP";
                    dynamicParameters.Add("ClientIP", ClientIP);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        AllowStatus = "Y";
                    }

                    string[] Status = { AllowStatus.ToString() };

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = Status
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWoData 基礎過站資訊 GPai 20231222
        public string GetWoData(int ProcessId, string WoErpFullNo, string MtlItemNo, string StartDate, string EndDate, int UserId, string BarcodeNo, string Status, string isNewFinish
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<EtergeWoData> etergeWoData = new List<EtergeWoData>();
                List<EtergeWoDataDetail> etergeWoDataDetail = new List<EtergeWoDataDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //搜尋製令所有條碼過站資訊
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeProcessId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", b1.WoErpPrefix + '-' + b1.WoErpNo WoErpFullNo
                          , b.MoId, b.[Status] MoStatus
                          , c.BarcodeId, c.BarcodeNo 
                          , d.MoProcessId, d.ProcessAlias
                          , a.StationQty, a.PassQty, a.NgQty, a.CycleTime, FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate, a.ProdStatus BarcodeStatus
                          , e.UserNo + '-' + e.UserName StarUser
                          , f.UserNo + '-' + f.UserName FinishUser
                          , g.MachineNo, g.MachineName, g.MachineDesc
                          , h.MtlItemId, h.MtlItemNo, h.MtlItemName, h.MtlItemSpec
                          , i.ProcessId, i.ProcessName, a.ROWNUM, ISNULL(a.CauseNo,'') CauseNo
						  ,  FORMAT(LAG(a.FinishDate) OVER ( PARTITION BY a.BarcodeId ORDER BY a.BarcodeProcessId ), 'yyyy-MM-dd HH:mm:ss') LastStopFinish 
						  , (DATEDIFF (SECOND, FORMAT(LAG(a.FinishDate) OVER ( PARTITION BY a.BarcodeId ORDER BY a.BarcodeProcessId ), 'yyyy-MM-dd HH:mm:ss'),a.StartDate)) WaitTime
                          ";
                    sqlQuery.mainTables =
                        @"FROM (
						  SELECT ROW_NUMBER() OVER (PARTITION BY MoProcessId, BarcodeId ORDER BY BarcodeProcessId DESC) AS ROWNUM,*
						  FROM MES.BarcodeProcess ) AS  a
                          INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                          INNER JOIN MES.WipOrder b1 ON b.WoId = b1.WoId
                          INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                          INNER JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                          INNER JOIN BAS.[User] e ON a.StartUserId = e.UserId
                          LEFT JOIN BAS.[User] f ON a.FinishUserId = f.UserId
                          INNER JOIN MES.Machine g ON a.MachineId = g.MachineId
                          INNER JOIN PDM.MtlItem h ON b1.MtlItemId = h.MtlItemId
                          INNER JOIN MES.Process i ON d.ProcessId = i.ProcessId
                            ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND b1.CompanyId = @CompanyId AND a.FinishDate >= a.StartDate";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessId", @" AND d.ProcessId = @ProcessId", ProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND b1.WoErpPrefix + '-' + b1.WoErpNo LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (h.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR h.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.FinishDate >= @StartDate ", StartDate.Length > 0 ? (Convert.ToDateTime(StartDate).AddDays(-1)).ToString("yyyy-MM-dd 08:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.FinishDate <= @EndDate ", EndDate.Length > 0 ? (Convert.ToDateTime(EndDate).AddDays(1)).ToString("yyyy-MM-dd 07:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserId", @" AND f.UserId = @UserId ", UserId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.ProdStatus IN @Status ", Status.Split(','));
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "isNewFinish", @" AND a.ROWNUM = @isNewFinish ", isNewFinish);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND c.BarcodeNo = @BarcodeNo ", BarcodeNo);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.BarcodeId, a.BarcodeProcessId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    etergeWoDataDetail = BaseHelper.SqlQuery<EtergeWoDataDetail>(sqlConnection, dynamicParameters, sqlQuery);

                    //            #region //TESTttt
                    //            dynamicParameters = new DynamicParameters();
                    //            sqlQuery.mainKey = "a.BarcodeProcessId";
                    //            sqlQuery.auxKey = "";
                    //            sqlQuery.columns =
                    //                @", b1.WoErpPrefix + '-' + b1.WoErpNo WoErpFullNo
                    //                  , b.MoId, b.[Status] MoStatus
                    //                  , c.BarcodeId, c.BarcodeNo 
                    //                  , d.MoProcessId, d.ProcessAlias
                    //                  , a.StationQty, a.PassQty, a.NgQty, a.CycleTime, FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate, a.ProdStatus BarcodeStatus
                    //                  , e.UserNo + '-' + e.UserName StarUser
                    //                  , f.UserNo + '-' + f.UserName FinishUser
                    //                  , g.MachineNo, g.MachineName, g.MachineDesc
                    //                  , h.MtlItemId, h.MtlItemNo, h.MtlItemName, h.MtlItemSpec
                    //                  , i.ProcessId, i.ProcessName, a.ROWNUM, ISNULL(a.CauseNo,'') CauseNo
                    //,  FORMAT(LAG(a.FinishDate) OVER ( PARTITION BY a.BarcodeId ORDER BY a.BarcodeProcessId ), 'yyyy-MM-dd HH:mm:ss') LastStopFinish 
                    //, (DATEDIFF (SECOND, FORMAT(LAG(a.FinishDate) OVER ( PARTITION BY a.BarcodeId ORDER BY a.BarcodeProcessId ), 'yyyy-MM-dd HH:mm:ss'),a.StartDate)) WaitTime
                    //                  ";
                    //            sqlQuery.mainTables =
                    //                @"FROM (
                    //SELECT ROW_NUMBER() OVER (PARTITION BY MoProcessId, BarcodeId ORDER BY BarcodeProcessId DESC) AS ROWNUM,*
                    //FROM MES.BarcodeProcess ) AS  a
                    //                  INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                    //                  INNER JOIN MES.WipOrder b1 ON b.WoId = b1.WoId
                    //                  INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                    //                  INNER JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                    //                  INNER JOIN BAS.[User] e ON a.StartUserId = e.UserId
                    //                  LEFT JOIN BAS.[User] f ON a.FinishUserId = f.UserId
                    //                  INNER JOIN MES.Machine g ON a.MachineId = g.MachineId
                    //                  INNER JOIN PDM.MtlItem h ON b1.MtlItemId = h.MtlItemId
                    //                  INNER JOIN MES.Process i ON d.ProcessId = i.ProcessId
                    //                    ";
                    //            sqlQuery.auxTables = "";
                    //            string queryCondition2 = @" AND b1.CompanyId = @CompanyId";
                    //            dynamicParameters.Add("CompanyId", CurrentCompany);
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "ProcessId", @" AND d.ProcessId = @ProcessId", ProcessId);
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "WoErpFullNo", @" AND b1.WoErpPrefix + '-' + b1.WoErpNo LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "MtlItemNo", @" AND (h.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR h.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "StartDate", @" AND a.FinishDate >= @StartDate ", StartDate.Length > 0 ? (Convert.ToDateTime(StartDate)).ToString("yyyy-MM-dd 08:00:00") : "");
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "EndDate", @" AND a.FinishDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 07:59:59") : "");
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "UserId", @" AND f.UserId = @UserId ", UserId);
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "Status", @" AND a.ProdStatus IN @Status ", Status.Split(','));
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "isNewFinish", @" AND a.ROWNUM = @isNewFinish ", isNewFinish);
                    //            BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "BarcodeNo", @" AND c.BarcodeNo = @BarcodeNo ", BarcodeNo);

                    //            sqlQuery.conditions = queryCondition2;
                    //            sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.BarcodeProcessId";
                    //            sqlQuery.pageIndex = PageIndex;
                    //            sqlQuery.pageSize = PageSize;

                    //            var testresult =  BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    //            #endregion

                    //判斷是否最新最新過站
                    foreach (var item in etergeWoDataDetail)
                    {
                        var isnewfinish = "";
                        var orignqty = 0;
                        var finishDay = item.FinishDate;
                        var workDay = "";

                        if (Convert.ToDateTime(finishDay) >= Convert.ToDateTime(Convert.ToDateTime(finishDay).ToString("yyyy-MM-dd 00:00:00")) && Convert.ToDateTime(finishDay) <= Convert.ToDateTime(Convert.ToDateTime(finishDay).ToString("yyyy-MM-dd 08:00:00")))
                        {
                            workDay = Convert.ToDateTime(finishDay).AddDays(-1).ToString("yyyy-MM-dd");
                        }
                        else
                        {
                            workDay = Convert.ToDateTime(finishDay).ToString("yyyy-MM-dd");
                        }

                        //sql = @"SELECT *
                        //        FROM (
                        //        SELECT ROW_NUMBER() OVER (PARTITION BY BarcodeId ORDER BY BarcodeProcessId DESC) AS ROWNUM,*
                        //        FROM MES.BarcodeProcess ) AS anewestResult
                        //        WHERE a.ROWNUM = 1 
                        //        AND a.BarcodeId = @BarcodeId";
                        //dynamicParameters.Add("BarcodeId", item.BarcodeId);
                        //var newestResult = sqlConnection.Query(sql, dynamicParameters);

                        if (item.ROWNUM == 1)
                        {
                            isnewfinish = "Y";
                        }
                        else
                        {
                            isnewfinish = "N";
                        }


                        var value = etergeWoDataDetail.Find(x => x.BarcodeProcessId == item.BarcodeProcessId);
                        if (value != null)
                        {
                            value.isNewFinish = isnewfinish;
                            value.WorkDay = workDay;
                        }

                        //etergeWoDataDetail
                        //.Where(y => y.BarcodeProcessId == item.BarcodeProcessId)
                        //.ToList()
                        //.ForEach(x =>
                        //{
                        //    x.isNewFinish = isnewfinish;
                        //    x.WorkDay = workDay;
                        //});



                        //找原始過站數量
                        sql = @"SELECT a.BarcodeId,a.BarcodeProcessId,a1.ProcessAlias,a.StationQty, isnull(b.TransactionQty,0) FromQty, isnull(c.TransactionQty,0) ToQty,
                                       a.StationQty + isnull(b.TransactionQty,0) - isnull(c.TransactionQty,0) OrignQty
                                       , b.FromBarcodeId FromFromBarcodeId, b.ToBarcodeId FromToBarcodeId
									   , c.FromBarcodeId ToFromBarcodeId, c.ToBarcodeId ToToBarcodeId, a.CycleTime
                                 FROM (
                                         SELECT ROW_NUMBER() OVER (PARTITION BY MoProcessId, BarcodeId ORDER BY BarcodeProcessId DESC) AS ROWNUM,*
                                         FROM MES.BarcodeProcess 
                                      ) AS  a
                                 INNER JOIN MES.MoProcess a1 ON a.MoProcessId = a1.MoProcessId
                                 LEFT JOIN MES.BarcodeTransfer b ON a.BarcodeProcessId = b.FromBarcodeProcessId
                                 LEFT JOIN MES.BarcodeTransfer c ON a.BarcodeProcessId = c.ToBarcodeProcessId
                                 WHERE a.BarcodeProcessId = @BarcodeProcessId 
								 ORDER BY a.BarcodeProcessId, a1.MoProcessId, b.TransactionId DESC , c.TransactionId DESC";
                        dynamicParameters.Add("BarcodeProcessId", item.BarcodeProcessId);

                        var orignQtyResult = sqlConnection.Query(sql, dynamicParameters);

                        if ((orignQtyResult.Count() > 0) )
                        {

                            foreach (var item2 in orignQtyResult) {
                                if (item2.CycleTime > 0)
                                {
                                    if (item.BarcodeProcessId == item2.BarcodeProcessId)
                                    {
                                        int FromFromBarcodeId = item2.FromFromBarcodeId != null ? item2.FromFromBarcodeId : -1;
                                        int FromToBarcodeId = item2.FromToBarcodeId != null ? item2.FromToBarcodeId : -1; ;
                                        int ToFromBarcodeId = item2.ToFromBarcodeId != null ? item2.ToFromBarcodeId : -1; ;
                                        int ToToBarcodeId = item2.ToToBarcodeId != null ? item2.ToToBarcodeId : -1; ;

                                        //判定條碼是否有非良品條碼
                                        sql = @"SELECT BarcodeId, CurrentProdStatus
                                            FROM MES.Barcode
                                            WHERE CurrentProdStatus = 'F'";
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "FromFromBarcodeId", @" AND (BarcodeId = @FromFromBarcodeId ", FromFromBarcodeId);
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "FromToBarcodeId", @" OR BarcodeId = @FromToBarcodeId) ", FromToBarcodeId);
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ToFromBarcodeId", @" AND (BarcodeId = @ToFromBarcodeId ", ToFromBarcodeId);
                                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ToToBarcodeId", @" OR BarcodeId = @ToToBarcodeId) ", ToToBarcodeId);

                                        var barcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (barcodeResult.Count() > 0)
                                        {

                                            if (orignQtyResult.Count() == 1)
                                            {
                                                orignqty = item2.StationQty;
                                            }
                                            else {
                                                orignqty = item2.StationQty + item2.FromQty + item2.ToQty;

                                            }

                                        }
                                        else
                                        {
                                            if (orignQtyResult.Count() == 1)
                                            {
                                                orignqty = item2.StationQty;
                                            }
                                            else
                                            {
                                                orignqty = item2.StationQty + item2.FromQty + item2.ToQty;

                                            }

                                        }

                                        var value2 = etergeWoDataDetail.Find(x => x.BarcodeProcessId == item2.BarcodeProcessId);
                                        if (value2 != null)
                                        {
                                            value2.StationQty = orignqty;
                                        }

                                        //etergeWoDataDetail
                                        //.Where(y => y.BarcodeProcessId == item2.BarcodeProcessId)
                                        //.ToList()
                                        //.ForEach(x =>
                                        //{
                                        //    x.StationQty = orignqty;
                                        //});
                                        
                                    }
                                }
                                else {
                                    //var dd  = etergeWoDataDetail.RemoveAll(y => y.BarcodeProcessId == item2.BarcodeProcessId);
                                    //etergeWoDataDetail = etergeWoDataDetail.Where(x => x.BarcodeProcessId != item2.BarcodeProcessId).ToList();

                                    //etergeWoDataDetail = etergeWoDataDetail.Find(x => x.BarcodeProcessId != item2.BarcodeProcessId);
                                    if (item2.OrignQty == 0 && item2.CycleTime == 0 && item.BarcodeStatus == "P")
                                    {
                                        etergeWoDataDetail = etergeWoDataDetail.Where(x => x.BarcodeProcessId != item2.BarcodeProcessId).ToList();
                                    }
                                }

                            }
                            
                        }

                    }

                    #endregion
                    //var ddd1 = testresult.FirstOrDefault().BarcodeProcessId;
                    //var ddd2 = testresult.LastOrDefault().BarcodeProcessId;


                    //etergeWoDataDetail = etergeWoDataDetail
                    //       .Where(y => y.BarcodeProcessId >= ddd1)
                    //       .Where(y => y.BarcodeProcessId <= ddd2)
                    //       .ToList();
                    //etergeWoDataDetail = etergeWoDataDetail
                    //        .Where(y => y.StationQty > 0)
                    //        .ToList();

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = etergeWoDataDetail
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWoProcessData機種(品號)製程日夜班良率報表/各條碼資料
        public string GetWoProcessData(int ProcessId, string WoErpFullNo, string MtlItemNo, string StartDate, string EndDate, int UserId, string BarcodeNo, string Status, string isNewFinish
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<EtergeWoData> etergeWoData = new List<EtergeWoData>();
                List<EtergeWoDataDetail> etergeWoDataDetail = new List<EtergeWoDataDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    //#region //製令
                    //sqlQuery.mainKey = "a.MoId";
                    //sqlQuery.auxKey = "";
                    //sqlQuery.columns =
                    //    @", b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo, a.CreateDate
                    //          , c.ModeNo + '-' + c.ModeName Mode , b.MtlItemId , d.MtlItemNo, d.MtlItemName";
                    //sqlQuery.mainTables =
                    //    @"FROM MES.ManufactureOrder a
                    //          INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                    //          INNER JOIN MES.ProdMode c ON a.ModeId = c.ModeId
                    //          INNER JOIN PDM.MtlItem d ON b.MtlItemId = d.MtlItemId
                    //        ";
                    //sqlQuery.auxTables = "";
                    //string queryCondition = @"AND b.CompanyId = @CompanyId";
                    //dynamicParameters.Add("CompanyId", CurrentCompany);
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ModeId", @" AND a.ModeId = @ModeId", ModeId);
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND b.WoErpPrefix + '-' + b.WoErpNo + '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')' LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (d.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR d.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                    ////BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND b.DocDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    ////BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND b.DocDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    //sqlQuery.conditions = queryCondition;
                    //sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    //sqlQuery.pageIndex = PageIndex;
                    //sqlQuery.pageSize = PageSize;

                    //etergeWoData = BaseHelper.SqlQuery<EtergeWoData>(sqlConnection, dynamicParameters, sqlQuery);
                    //#endregion


                    #region //搜尋製令所有條碼過站資訊
                    sqlQuery.mainKey = "a.BarcodeProcessId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", b1.WoErpPrefix + '-' + b1.WoErpNo WoErpFullNo
                          , b.MoId, b.[Status] MoStatus
                          , c.BarcodeId, c.BarcodeNo 
                          , d.MoProcessId, d.ProcessAlias
                          , a.StationQty, a.PassQty, a.NgQty, a.CycleTime, FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate, a.ProdStatus BarcodeStatus
                          , e.UserNo + '-' + e.UserName StarUser
                          , f.UserNo + '-' + f.UserName FinishUser
                          , g.MachineNo, g.MachineName
                          , h.MtlItemId, h.MtlItemNo, h.MtlItemName, h.MtlItemSpec
                          , i.ProcessId, i.ProcessName
                          ";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodeProcess a
                          INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                          INNER JOIN MES.WipOrder b1 ON b.WoId = b1.WoId
                          INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                          INNER JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                          INNER JOIN BAS.[User] e ON a.StartUserId = e.UserId
                          INNER JOIN BAS.[User] f ON a.FinishUserId = f.UserId
                          INNER JOIN MES.Machine g ON a.MachineId = g.MachineId
                          INNER JOIN PDM.MtlItem h ON b1.MtlItemId = h.MtlItemId
                          INNER JOIN MES.Process i ON d.ProcessId = i.ProcessId
                            ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b1.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessId", @" AND d.ProcessId = @ProcessId", ProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND b1.WoErpPrefix + '-' + b.WoErpNo + '(' + CONVERT(VARCHAR(10), b1.WoSeq) + ')' LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (h.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR h.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND b1.DocDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND b1.DocDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND c.BarcodeNo = @BarcodeNo ", BarcodeNo);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.BarcodeId, a.BarcodeProcessId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    etergeWoDataDetail = BaseHelper.SqlQuery<EtergeWoDataDetail>(sqlConnection, dynamicParameters, sqlQuery);

                    
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = etergeWoDataDetail
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWoProcessUserData 機種(品號)人員產量報表/各條碼資料
        #endregion

        #region //GetProductManufactureData 日夜班產出統計(良品 & 不良品&良率)
        public string GetProductManufactureData(int ModeId, string WoErpFullNo, string MtlItemNo, string StartDate, string EndDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<ProductManufactureData> manufactureOrders = new List<ProductManufactureData>();
                List<ProductManufactureDetail> productManufactureDetail = new List<ProductManufactureDetail>();



                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion


                    #region //找製令資料
                    sqlQuery.mainKey = "a.MoId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @"    , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo, a.WoSeq
                              , c.MtlItemId, c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                              ";
                    sqlQuery.mainTables =
                        @"FROM MES.ManufactureOrder a
                          INNER JOIN MES.WipOrder b ON b.WoId = a.WoId
                          INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId
                          OUTER APPLY(
                              SELECT TOP 1 x.MoProcessId
                              FROM MES.MoProcess x
                              WHERE x.MoId = a.MoId
                          ) d";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND b.CompanyId = @CompanyId
                                              AND d.MoProcessId > 0";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ModeId", @" AND a.ModeId = @ModeId", ModeId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND b.WoErpPrefix + '-' + b.WoErpNo + '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')' LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (c.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR c.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND b.DocDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 08:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND b.DocDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 07:59:59") : "");
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    manufactureOrders = BaseHelper.SqlQuery<ProductManufactureData>(sqlConnection, dynamicParameters, sqlQuery);

                    string[] prodstatus = new string[] { "P", "F", "S" };

                    foreach (var item in manufactureOrders)
                    {
                        #region //找各製程
                        sql = @"SELECT x.MoId, x.MoProcessId, x.ProcessId, ISNULL(x.ProcessAlias, '') ProcessAlias
                                    FROM MES.MoProcess x
                                    WHERE x.MoId = @MoId
                                    ORDER BY x.SortNumber";
                        dynamicParameters.Add("MoId", item.MoId);
                        var moProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        productManufactureDetail = sqlConnection.Query<ProductManufactureDetail>(sql, dynamicParameters).ToList();

                        

                        #endregion

                        #region //各製程在時間內各狀態過站數量
                        foreach (var item2 in productManufactureDetail)
                        {
                            List<TotalMoProcessProdCount> totalMoProcessProdCount = new List<TotalMoProcessProdCount>();


                            foreach (var item3 in prodstatus)
                            {
                                List<MoProcessProdCount> moProcessProdCount = new List<MoProcessProdCount>();

                                sql = @"SELECT a.BarcodeProcessId,a.BarcodeId, a.StationQty, a.ProdStatus
						            FROM (
						            SELECT ROW_NUMBER() OVER (PARTITION BY MoProcessId, BarcodeId ORDER BY BarcodeProcessId DESC) AS ROWNUM,*
						            FROM MES.BarcodeProcess ) AS  a
                                    WHERE  a.MoId = @MoId
						            AND a.FinishDate >= @StartDate
						            AND a.FinishDate <= @EndDate
						            AND a.MoProcessId = @MoProcessId 
						            ";
                                dynamicParameters.Add("MoId", item.MoId);
                                dynamicParameters.Add("StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 08:00:00") : "");
                                dynamicParameters.Add("EndDate", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 07:59:59") : "");
                                dynamicParameters.Add("MoProcessId", item2.MoProcessId);
                                switch (item3) {
                                    case "P":
                                        sql += @"AND a.ROWNUM = 1 AND a.ProdStatus = 'P' ";
                                        break;
                                    case "F":
                                        sql += @"AND a.ProdStatus = 'F' ";

                                        break;
                                    case "S":
                                        sql += @"AND a.ProdStatus = 'S' ";

                                        break;

                                }
                                sql += @"ORDER BY a.BarcodeId";

                                var moProcessProdCountResult = sqlConnection.Query(sql, dynamicParameters);
                               // moProcessProdCount = sqlConnection.Query<MoProcessProdCount>(sql, dynamicParameters).ToList();


                                #region //找原始過站數量
                                foreach (var item4 in moProcessProdCountResult)
                                {
                                    sql = @"SELECT a.BarcodeId,a.BarcodeProcessId,a1.ProcessAlias,a.StationQty, isnull(b.TransactionQty,0) FromQty, isnull(c.TransactionQty,0) ToQty,
                                            a.StationQty + isnull(b.TransactionQty,0) - isnull(c.TransactionQty,0) OrignQty,
                                            b.FromBarcodeId, b.ToBarcodeId
                                            FROM (
                                                    SELECT ROW_NUMBER() OVER (PARTITION BY MoProcessId, BarcodeId ORDER BY BarcodeProcessId DESC) AS ROWNUM,*
                                                    FROM MES.BarcodeProcess 
                                                 ) AS  a
                                            INNER JOIN MES.MoProcess a1 ON a.MoProcessId = a1.MoProcessId
                                            LEFT JOIN MES.BarcodeTransfer b ON a.BarcodeProcessId = b.FromBarcodeProcessId
                                            LEFT JOIN MES.BarcodeTransfer c ON a.BarcodeProcessId = c.ToBarcodeProcessId
                                            WHERE a.BarcodeProcessId = @BarcodeProcessId 
                                            AND a.ROWNUM = 1 
                                            AND a.FinishDate >= @StartDate
						                    AND a.FinishDate <= @EndDate";
                                    dynamicParameters.Add("BarcodeProcessId", item4.BarcodeProcessId);
                                    dynamicParameters.Add("StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 08:00:00") : "");
                                    dynamicParameters.Add("EndDate", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 07:59:59") : "");
                                    var orignQtyResult = sqlConnection.Query(sql, dynamicParameters);
                                    var orignqty = 0;


                                    if (orignQtyResult.Count() > 0)
                                    {
                                        foreach (var item5 in orignQtyResult)
                                        {
                                            orignqty = item5.OrignQty;

                                        }
                                    }
                                    else {
                                        orignqty = item4.StationQty;
                                    }

                                    moProcessProdCount.Add(new MoProcessProdCount
                                    {
                                        BarcodeProcessId = item4.BarcodeProcessId,
                                        BarcodeId = item4.BarcodeId,
                                        StationQty = orignqty,
                                        ProdStatus = item4.ProdStatus,
                                    });
                                }
                                #endregion
                                var toitalStationQty = moProcessProdCount.Sum(p => p.StationQty);

                                totalMoProcessProdCount.Add(new TotalMoProcessProdCount
                                {
                                    StationQty = toitalStationQty,
                                    ProdStatus = item3,
                                });

                            }
                            var passqty = totalMoProcessProdCount[0].StationQty;
                            var ngsqty = totalMoProcessProdCount[1].StationQty;
                            var scrapqty = totalMoProcessProdCount[2].StationQty;

                            decimal passperson = 0.0m;

                            if ((ngsqty + scrapqty + passqty) == 0)
                            {
                                passperson = 0;
                            }
                            else {
                                passperson = (passqty / (ngsqty + scrapqty + passqty)) * 100 ;
                            }

                            productManufactureDetail
                                .Where(y => y.MoProcessId == item2.MoProcessId)
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.TotalMoProcessProdCount = totalMoProcessProdCount;
                                                x.PassPerson = passperson;
                                            });


                        }
                        #endregion
                        manufactureOrders
                        .Where(y => y.MoId == item.MoId)
                        .ToList()
                        .ForEach(x =>
                        {
                            x.ProcessDetail = productManufactureDetail;
                        });
                    }

                    #endregion


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = manufactureOrders
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetInspectionInfo -- 取得送測彙整資訊 -- Ann 2024-02-22
        public string GetInspectionInfo(string StartDate, string EndDate)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QcRecordId, ISNULL(a.DisallowanceReason, '') DisallowanceReason
                            , e.WoErpPrefix + '-' + e.WoErpNo WoErpFullNo
                            , c.ModeName ModeFullNo
                            , d.ProcessAlias
                            , a.RequestDate, a.ReceiptDate, a.QcFinishDate
                            , h.StatusNo + ' ' + h.StatusName CheckQcMeasureData
                            , f.UserNo + ' ' + f.UserName UserFullNo
                            , g.DepartmentName DepartmentFullNo
                            FROM MES.QcRecord a 
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            INNER JOIN MES.ProdMode c ON b.ModeId = c.ModeId
                            INNER JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                            INNER JOIN MES.WipOrder e ON b.WoId = e.WoId
                            INNER JOIN BAS.[User] f ON a.CreateBy = f.UserId
                            INNER JOIN BAS.Department g ON f.DepartmentId = g.DepartmentId
                            INNER JOIN BAS.[Status] h ON a.CheckQcMeasureData = h.StatusNo AND h.StatusSchema = 'QcRecord.CheckQcMeasureData'
                            WHERE 1=1
                            AND EXISTS (
                                SELECT TOP 1 1 FROM MES.QcReceiptBarcode x 
                                WHERE x.QcRecordId = a.QcRecordId
                            )";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "StartDate", @" AND a.RequestDate >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "EndDate", @" AND a.RequestDate <= @EndDate", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcess -- 取得製令製程資料 -- Ann 2024-03-26
        public string GetMoProcess(int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoProcessId, a.MoId, a.MoRoutingId, a.RoutingProcessId, a.ProcessId
                            , a.SortNumber, a.ProcessAlias, a.RoutingItemProcessDesc, a.Remark
                            FROM MES.MoProcess a 
                            WHERE a.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineEffectivenessListTempDelete -- 取得機台稼動清單 -- Ann 2024-05-02
        public string GetMachineEffectivenessListTempDelete(string Type, int ShopId, int MachineId, int ProcessId, string CustomerMtlItemNo, string StartDate, string FinishDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeProcessId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", b.MachineNo, b.MachineName, b.MachineDesc
                        , f.MtlItemId, f.MtlItemName, g.ProcessAlias
                        , h.UserNo + '-' + h.UserName UserInfo
                        , j.UserNo + '-' + j.UserName FinishUser
                        , a.StartDate
                        , FORMAT(a.FinishDate, 'HH:mm:ss') FinishDate
                        , i.CustomerMtlItemNo";
                    sqlQuery.mainTables =
                        @"FROM MES.BarcodeProcess a 
                        INNER JOIN MES.Machine b ON a.MachineId = b.MachineId
                        INNER JOIN MES.WorkShop c ON b.ShopId = c.ShopId
                        INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                        INNER JOIN MES.WipOrder e ON d.WoId = e.WoId
                        INNER JOIN PDM.MtlItem f ON e.MtlItemId = f.MtlItemId
                        INNER JOIN MES.MoProcess g ON a.MoProcessId = g.MoProcessId
                        INNER JOIN BAS.[User] h ON a.StartUserId = h.UserId
                        LEFT JOIN PDM.CustomerMtlItem i ON f.MtlItemId = i.MtlItemId
                        LEFT JOIN BAS.[User] j ON a.FinishUserId = j.UserId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    string currentDate = DateTime.Now.ToString("yyyy-MM-dd");
                    dynamicParameters.Add("currentDate", currentDate);

                    switch (Type)
                    {
                        case "Start":
                            queryCondition += @" AND a.FinishDate IS NULL AND CONVERT(date, a.StartDate) = @currentDate";
                            break;
                        case "Finish":
                            queryCondition += @" AND a.FinishDate IS NOT NULL AND CONVERT(date, a.FinishDate) = @currentDate";
                            break;
                        default:
                            break;
                    }

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopId", @" AND c.ShopId = @ShopId", ShopId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineId", @" AND b.MachineId = @MachineId", MachineId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessId", @" AND g.ProcessId = @ProcessId", ProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerMtlItemNo", @" AND i.CustomerMtlItemNo = @CustomerMtlItemNo", CustomerMtlItemNo);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : Type == "Start" ? "a.StartDate DESC" : "a.FinishDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineOperatingTime -- 取得機器運作時間(分鐘) -- Ann 2024-05-02
        public string GetMachineOperatingTime(int ShopId, int MachineId, string StartDate)
        {
            try
            {
                if (StartDate.Length <= 0) StartDate = DateTime.Now.ToString("yyyy-MM-dd");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT 
                            SUM(DATEDIFF(MINUTE, a.StartDate,     
                                CASE
                                    WHEN CONVERT(date, a.StartDate) = @StartDate AND FORMAT(a.FinishDate, 'yyyy-MM-dd') = FORMAT(DATEADD(day, 1, a.StartDate), 'yyyy-MM-dd') 
                                        THEN DATEADD(second, -1, DATEADD(day, 1, CAST(FORMAT(a.StartDate, 'yyyy-MM-dd') AS datetime)))
                                    WHEN CONVERT(date, a.StartDate) = @StartDate AND FORMAT(a.FinishDate, 'yyyy-MM-dd') = FORMAT(a.StartDate, 'yyyy-MM-dd') 
                                        THEN a.FinishDate
                                    ELSE
                                        NULL
                                END)) AS MinutesDifference
                            FROM MES.BarcodeProcess a 
                            INNER JOIN MES.Machine b ON a.MachineId = b.MachineId
                            INNER JOIN MES.WorkShop c ON b.ShopId = c.ShopId
                            WHERE c.CompanyId = @CompanyId
                            AND a.FinishDate IS NOT NULL
                            AND CONVERT(date, a.StartDate) = @StartDate";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("StartDate", StartDate);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineId", @" AND a.MachineId = @MachineId", MachineId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ShopId", @" AND c.ShopId = @ShopId", ShopId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWorkShop -- 取得車間資料 -- Ann 2024-05-03
        public string GetWorkShop(int ShopId, string ShopNo, string ShopName, string Status)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ShopId, a.ShopNo, a.ShopName, a.ShopDesc
                            FROM MES.WorkShop a 
                            WHERE a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ShopId", @" AND a.ShopId = @ShopId", ShopId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ShopNo", @" AND a.ShopNo LIKE '%' + @ShopNo + '%'", ShopNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ShopName", @" AND a.ShopName LIKE '%' + @ShopName + '%'", ShopName);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND a.Status = @Status", Status);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWorkShopMachine -- 取得特定車間內的機台 -- Ann 2024-05-03
        public string GetWorkShopMachine(int MachineId, int ShopId, string MachineNo, string MachineName, string MachineDesc, string Status)
        {
            try
            {
                if (ShopId <= 0) throw new SystemException("車間不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MachineId, a.ShopId, a.MachineNo, a.MachineName, a.MachineDesc
                            , b.ShopName
                            FROM MES.Machine a 
                            INNER JOIN MES.WorkShop b ON a.ShopId = b.ShopId
                            WHERE a.ShopId = @ShopId";
                    dynamicParameters.Add("ShopId", ShopId);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineId", @" AND a.MachineId = @MachineId", MachineId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineNo", @" AND a.MachineNo LIKE '%' + @MachineNo + '%'", MachineNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineName", @" AND a.MachineName LIKE '%' + @MachineName + '%'", MachineName);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineDesc", @" AND a.MachineDesc LIKE '%' + @MachineDesc + '%'", MachineDesc);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND a.Status = @Status", Status);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineStatus -- 取得特定機台稼動狀況 -- Ann 2024-05-07
        public string GetMachineStatus(int MachineId)
        {
            try
            {
                if (MachineId <= 0) throw new SystemException("機台不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 
                            CASE
                                WHEN DATEDIFF(HOUR, a.FinishDate, GETDATE()) <= 1 THEN 'Y'
                                ELSE 'N'
                            END AS TimeDifference
                            , (
                                SELECT TOP 1 1
                                FROM MES.BarcodeProcess x 
                                WHERE x.MachineId = a.MachineId
                                AND x.FinishDate IS NULL
                            ) BarcodeProcess
                            FROM MES.BarcodeProcess a 
                            WHERE a.MachineId = @MachineId
                            AND a.FinishDate IS NOT NULL
                            ORDER BY a.FinishDate DESC";
                    dynamicParameters.Add("MachineId", MachineId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineEffectivenessList -- 取得特定車間機台稼動狀況 -- Ann 2024-05-07
        public string GetMachineEffectivenessList(int ShopId, string StartDate, string EndDate)
        {
            try
            {
                string currentDate = DateTime.Now.ToString("yyyy-MM-dd");
                if (ShopId <= 0) throw new SystemException("車間不能為空!!");
                if (StartDate == "" && EndDate == "")
                {
                    StartDate = currentDate;
                    EndDate = currentDate;
                }
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MachineId, b.ShopName,a.MachineName,a.MachineDesc,c.*
                            FROM MES.Machine a
                                INNER JOIN MES.WorkShop b ON a.ShopId = b.ShopId
                                LEFT JOIN(SELECT x4.WoErpPrefix + '-' + x4.WoErpNo WipNo,
                                x5.MtlItemNo,x5.MtlItemName,x5.MtlItemDesc,
                                x8.BarcodeNo,
                                x2.ProcessAlias ProcessName,
                                FORMAT(x1.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate,
                                x6.UserName StartUser,
                                FORMAT(x1.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate,
                                x7.UserName FinishUser,
                                x1.MachineId,
                                x9.CustomerMtlItemNo
                                FROM MES.BarcodeProcess x1
                                INNER JOIN MES.MoProcess x2 ON x1.MoProcessId = x2.MoProcessId
                                INNER JOIN MES.ManufactureOrder x3 ON x2.MoId = x3.MoId
                                INNER JOIN MES.WipOrder x4 ON x3.WoId = x4.WoId
                                INNER JOIN PDM.MtlItem x5 ON x4.MtlItemId = x5.MtlItemId
                                INNER JOIN BAS.[User] x6 ON x1.StartUserId = x6.UserId
                                LEFT JOIN BAS.[User] x7 ON x1.FinishUserId = x7.UserId
                                INNER JOIN MES.Barcode x8 ON x1.BarcodeId = x8.BarcodeId
                                LEFT JOIN PDM.CustomerMtlItem x9 ON x9.MtlItemId = x5.MtlItemId
                                WHERE ( CONVERT(date, x1.StartDate) >= @StartDate  AND CONVERT(date, x1.StartDate) <= @EndDate )
                                ) c ON a.MachineId = c.MachineId
                            WHERE b.ShopId = @ShopId";
                    dynamicParameters.Add("ShopId", ShopId);
                    dynamicParameters.Add("StartDate", StartDate);
                    dynamicParameters.Add("EndDate", EndDate);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetRptMoInformation -- 取得生產異常資料 -- Ann 2024-05-17
        public string GetRptMoInformation(string WoErpFullNo, int ModeId, string CustomerShortName, string SearchKey, string ExpectedStart, string ExpectedEnd
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    var dynamicParameters = new DynamicParameters();
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    string mainSql = @"SELECT a.WipNo, a.MtlItemNo, a.MtlItemName, a.MtlItemSpec,
                                   FORMAT(b.ExpectedStart, 'yyyy-MM-dd') ExpectedStart,
                                   FORMAT(b.ExpectedEnd, 'yyyy-MM-dd') ExpectedEnd,
                                   e.CompanyNo,
                                   FORMAT(DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), 'yyyy-MM-dd HH:mm:ss') AS DateOfLastUpdate, 
                                   DATEDIFF(day, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) AS RemainingDay,
                                   ROUND(SUM(a.UnCompletedTime) / 3600.0, 2) AS RemainingHours,
                                   FORMAT(c.MfgOfLastUpdate, 'yyyy-MM-dd HH:mm:ss') MfgOfLastUpdate,
                                   DATEDIFF(hour, c.MfgOfLastUpdate, GETDATE()) AS MfgOfLastHours,
                                   CASE 
                                       WHEN DATEDIFF(hour, c.MfgOfLastUpdate, GETDATE()) > 2 THEN '已超過2小時未加工' 
                                       ELSE '2小時內有加工' 
                                   END AS mfg_status,
                                   CASE 
                                       WHEN DATEDIFF(hour, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) BETWEEN 0 AND 24 THEN '距離交貨日不足一日'
                                       WHEN DATEDIFF(hour, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) <= 0 THEN '已超過預計完工日'
                                       ELSE '正常加工中'
                                   END AS status1,f.ModeId,
                                   f.ModeDesc, ISNULL(g.CustomerShortName, '工單尚未綁定訂單') AS CustomerShortName
                            FROM MES.RptMoInformation a
                            INNER JOIN MES.WipOrder b ON a.WipNo = b.WoErpPrefix + '-' + b.WoErpNo
                            INNER JOIN (
                                SELECT c1.MoId, MAX(c1.StartDate) AS MfgOfLastUpdate
                                FROM MES.BarcodeProcess c1
                                GROUP BY c1.MoId
                            ) c ON a.MoId = c.MoId
                            INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId AND b.WoId=d.WoId
                            INNER JOIN BAS.Company e ON b.CompanyId = e.CompanyId
                            INNER JOIN MES.ProdMode f ON d.ModeId = f.ModeId
                            LEFT JOIN (
                                SELECT sd.SoDetailId, sc.CustomerShortName
                                FROM SCM.SoDetail sd 
                                INNER JOIN SCM.SaleOrder so ON sd.SoId = so.SoId
                                INNER JOIN SCM.Customer sc ON so.CustomerId = sc.CustomerId
                            ) g ON g.SoDetailId = b.SoDetailId
                            WHERE b.CompanyId = @CompanyId AND b.ActualEnd <= getdate() and b.WoStatus not in('Y','y')";

                    string whereClause = string.Empty;

                    if (!string.IsNullOrEmpty(WoErpFullNo))
                    {
                        whereClause += " AND (b.WoErpPrefix + '-' + b.WoErpNo +  '(' + CONVERT(VARCHAR(10), d.WoSeq) + ')') LIKE @WoErpFullNo";
                        dynamicParameters.Add("WoErpFullNo", $"%{WoErpFullNo}%");
                    }

                    if (ModeId > 0)
                    {
                        whereClause += " AND f.ModeId = @ModeId";
                        dynamicParameters.Add("ModeId", ModeId);
                    }

                    if (!string.IsNullOrEmpty(CustomerShortName))
                    {
                        whereClause += " AND g.CustomerShortName LIKE @CustomerShortName";
                        dynamicParameters.Add("CustomerShortName", $"%{CustomerShortName}%");
                    }

                    if (!string.IsNullOrEmpty(SearchKey))
                    {
                        whereClause += " AND (a.MtlItemNo LIKE @SearchKey OR a.MtlItemName LIKE @SearchKey)";
                        dynamicParameters.Add("SearchKey", $"%{SearchKey}%");
                    }

                    // 處理日期參數
                    if (!string.IsNullOrEmpty(ExpectedStart))
                    {
                        whereClause += " AND b.ExpectedEnd >= @StartDate";
                        dynamicParameters.Add("StartDate", DateTime.Parse(ExpectedStart));
                    }

                    if (!string.IsNullOrEmpty(ExpectedEnd))
                    {
                        whereClause += " AND b.ExpectedEnd <= @EndDate";
                        dynamicParameters.Add("EndDate", DateTime.Parse(ExpectedEnd).AddDays(1).AddSeconds(-1));
                    }

                    mainSql += whereClause;

                    mainSql += @" GROUP BY a.WipNo, a.MtlItemNo, a.MtlItemName, a.MtlItemSpec, b.ExpectedStart, b.ExpectedEnd, 
                         c.MfgOfLastUpdate, e.CompanyNo, f.ModeId, f.ModeDesc, g.CustomerShortName
                         HAVING DATEDIFF(hour, c.MfgOfLastUpdate, GETDATE()) > 2
                            OR DATEDIFF(hour, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) BETWEEN 0 AND 24
                            OR DATEDIFF(hour, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) <= 0";

                    // 添加分頁
                    string sql = mainSql + @" ORDER BY b.ExpectedEnd 
                                    OFFSET @PageSize * (@PageIndex - 1) ROWS
                                    FETCH NEXT @PageSize ROWS ONLY;";

                    dynamicParameters.Add("PageSize", PageSize);
                    dynamicParameters.Add("PageIndex", PageIndex);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    // 計算總筆數
                    string countSql = "SELECT COUNT(1) FROM (" + mainSql + ") AS CountQuery";
                    var TotalCount = sqlConnection.QuerySingle<int>(countSql, dynamicParameters);

                    return JsonConvert.SerializeObject(new
                    {
                        status = "success",
                        result,
                        TotalCount
                    });
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
                return JsonConvert.SerializeObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
            }
        }
        #endregion

        #region//GetErpView
        public string GetErpView(string ViewName, string Company)
        {
            try
            { 
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyNo = @CompanyNo";
                    dynamicParameters.Add("CompanyNo", Company);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];  
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT * FROM ";
                    sql += ViewName;

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region GetComponentTracking --取得產品上料資料 --GPAI20240604
        public string GetComponentTracking(int BarcodeId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeComponentId, d.BarcodeId, d.BarcodeNo AssemblyBarcodeIdNo, e.TrayNo AssemblyTrayNo, a.ComponentBarcodeId
                            , b.BarcodeNo ComponentBarcodeNo, b.LotNumberNo  ComponentLotNumberNo, b.MtlItemNo ComponentMtlItemNo, b.MtlItemName ComponentMtlItemName
                            , f.MoProcessId, f.ProcessAlias, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate, (h.UserNo + '-' + h.UserName) UserName
                            FROM MES.BarcodeComponent a
                            INNER JOIN ( select b1.BarcodeId, b1.BarcodeNo, b3.LotNumberNo, b4.MtlItemNo, b4.MtlItemName 
                                        from MES.Barcode b1 
                                        inner join SCM.LnBarcode b2 on b1.BarcodeNo = b2.BarcodeNo
                                        inner join SCM.LotNumber b3 on b2.LotNumberId = b3.LotNumberId
                                        inner join PDM.MtlItem b4 on b3.MtlItemId = b4.MtlItemId) b 
                                    ON a.ComponentBarcodeId = b.BarcodeId
                            INNER JOIN MES.Barcode d ON a.AssemblyBarcodeId = d.BarcodeId
                            LEFT JOIN MES.Tray e ON d.BarcodeNo = e.BarcodeNo
                            INNER JOIN MES.MoProcess f ON a.MoProcessId = f.MoProcessId
                            INNER JOIN BAS.[User] h ON a.CreateBy = h.UserId
                            WHERE a.AssemblyBarcodeId = @AssemblyBarcodeId1
                            UNION
                            SELECT a.BarcodeComponentId, d.BarcodeId, d.BarcodeNo AssemblyBarcodeIdNo, e.TrayNo AssemblyTrayNo
                            , a.ComponentBarcodeId, g.BarcodeNo ComponentBarcodeNo
                            , c.LotNumberNo, c.MtlItemNo LotMtlItemNo, c.MtlItemName LotMtlItemName
                            , f.MoProcessId, f.ProcessAlias, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate, (h.UserNo + '-' + h.UserName) UserName
                            FROM MES.BarcodeComponent a
                            LEFT JOIN ( select c1.LotNumberId, c1.LotNumberNo, c2.MtlItemNo, c2.MtlItemName
                                        from  SCM.LotNumber c1
                                        inner join PDM.MtlItem c2 on c1.MtlItemId = c2.MtlItemId) c 
                                    ON a.LotNumberId = c.LotNumberId
                            INNER JOIN MES.Barcode d ON a.AssemblyBarcodeId = d.BarcodeId
                            LEFT JOIN MES.Tray e ON d.BarcodeNo = e.BarcodeNo
                            INNER JOIN MES.MoProcess f ON a.MoProcessId = f.MoProcessId
                            LEFT JOIN MES.Barcode g ON a.ComponentBarcodeId = g.BarcodeId
                            INNER JOIN BAS.[User] h ON a.CreateBy = h.UserId
                            WHERE a.AssemblyBarcodeId = @AssemblyBarcodeId2";
                        dynamicParameters.Add("AssemblyBarcodeId1", BarcodeId);
                        dynamicParameters.Add("AssemblyBarcodeId2", BarcodeId);


                        var result = sqlConnection.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion

                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetMoUnitSearch --製令串查
        public string GetMoUnitSearch(string MoFullNo, int WoId)
        {
            try
            {

                List<MoUnitSearchResult> moUnitSearchResult = new List<MoUnitSearchResult>();
                List<MOCTLRresult> tlResult = new List<MOCTLRresult>();
                List<MOCTO2> mOCTO = new List<MOCTO2>();

                List<MoResult> moResult = new List<MoResult>();
                List<MRResult> mRResult = new List<MRResult>();
                List<MWEResult> mweresult = new List<MWEResult>();
                List<OSPresult> ospresult = new List<OSPresult>();
                List<OSRresult> osrresult = new List<OSRresult>();

                List<ACPTBRresult> aCPTBRresult = new List<ACPTBRresult>();
                List<ACPTDRresult> aCPTDRresult = new List<ACPTDRresult>();


                var WoErpFullNo = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //製令
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.WoId, (a.WoErpPrefix + '-' + a.WoErpNo) WoErpFullNo, a.MtlItemId, b.MtlItemNo
                                , b.MtlItemName, a.UomId, c.UomNo, a.PlanQty , FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate
                                , d.MoId, d.WoSeq, FORMAT(d.CreateDate, 'yyyy-MM-dd') CreateDate 
                                FROM MES.WipOrder a
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                INNER JOIN PDM.UnitOfMeasure c ON a.UomId = c.UomId
                                INNER JOIN MES.ManufactureOrder d ON d.WoId = a.WoId
                                WHERE a.WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var Moresult = sqlConnection.Query(sql, dynamicParameters);
                        moResult = sqlConnection.Query<MoResult>(sql, dynamicParameters).ToList();

                        if (Moresult.Count() > 0) {
                            foreach (var h in Moresult) {
                                WoErpFullNo = h.WoErpFullNo;
                            }
                        }
                        //if (Moresult.Count() <= 0) throw new SystemException("查無製令資料");
                        #endregion

                        #region //領料 MRID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT (a.MrErpPrefix + '-' + a.MrErpNo) MrFullErpNo, a.MrId, a.TransferStatus, a.ConfirmStatus, FORMAT(a.DocDate, 'yyyy-MM-dd') DocDate
                                , b.Quantity, b.Unit
                                , c.MtlItemNo, c.MtlItemName, b.MrSequence
                                FROM MES.MaterialRequisition a
                                INNER JOIN MES.MrDetail b ON b.MrId = a.MrId
                                INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                INNER JOIN PDM.UnitOfMeasure d ON b.UomId = d.UomId
								INNER JOIN MES.ManufactureOrder e ON b.MoId = e.MoId
                                WHERE e.WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var Mrresult = sqlConnection.Query(sql, dynamicParameters);
                        mRResult = sqlConnection.Query<MRResult>(sql, dynamicParameters).ToList();
                        // mrDetail = sqlConnection.Query<MrDetail>(sql, dynamicParameters).ToList();
                        //if (Moresult.Count() <= 0) throw new SystemException("查無製令資料");
                        #endregion

                        #region //入庫 MWEID5901
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MweId, (a.MweErpPrefix + '-' + a.MweErpNo) MweFullErpNo, a.DocDate, a.TransferStatus, a.ConfirmStatus
                                , b.ReceiptQty, d.UomNo
                                , c.MtlItemNo, c.MtlItemName, b.MweSeq
                                FROM MES.MoWarehouseEnry a
                                INNER JOIN MES.MweDetail b ON b.MweId = a.MweId
                                INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                INNER JOIN PDM.UnitOfMeasure d ON b.UomId = d.UomId
								INNER JOIN MES.ManufactureOrder e ON b.MoId = e.MoId
                                WHERE e.WoId = @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var MMweresult = sqlConnection.Query(sql, dynamicParameters);
                        mweresult = sqlConnection.Query<MWEResult>(sql, dynamicParameters).ToList();
                        //mweDetail = sqlConnection.Query<MweDetail>(sql, dynamicParameters).ToList();
                        //if (Moresult.Count() <= 0) throw new SystemException("查無製令資料");
                        #endregion

                        #region //託外生產
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.OspId, a.OspNo, a.[Status], b.OspQty
								, c.MoId, c.WoSeq, d.WoErpPrefix, d.WoErpNo, d.WoId
								, e.MtlItemNo, e.MtlItemName, e.PurchaseUomId, f.UomNo,  FORMAT(a.OspDate, 'yyyy-MM-dd') OspDate
								FROM MES.OutsourcingProduction a
								INNER JOIN MES.OspDetail b ON b.OspId = a.OspId
								INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
								INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
								INNER JOIN PDM.MtlItem e ON d.MtlItemId = e.MtlItemId
								INNER JOIN PDM.UnitOfMeasure f ON e.InventoryUomId = f.UomId
								WHERE d.WoId =  @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var Ospresult = sqlConnection.Query(sql, dynamicParameters);
                        ospresult = sqlConnection.Query<OSPresult>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //託外入庫5902
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.OsrId, (a.OsrErpPrefix + '-' + a.OsrErpNo) OsrErpFullNo, a.Quantity, a.TransferStatus, a.ConfirmStatus, FORMAT(a.DocumentDate, 'yyyy-MM-dd') DocDate
								, c.MoId, c.WoSeq, d.WoErpPrefix, d.WoErpNo, d.WoId
								, e.MtlItemNo, e.MtlItemName
								, g.OspNo, b.OsrSeq, a.OsrErpPrefix, a.OsrErpNo, h.UomNo
								FROM MES.OspReceipt a
								INNER JOIN MES.OspReceiptDetail b ON b.OsrId = a.OsrId
								INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
								INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
								INNER JOIN PDM.MtlItem e ON d.MtlItemId = e.MtlItemId
								INNER JOIN MES.OspDetail f ON b.OspDetailId = f.OspDetailId
								INNER JOIN MES.OutsourcingProduction g ON f.OspId = g.OspId
                                INNER JOIN PDM.UnitOfMeasure h ON b.UomId = h.UomId
								WHERE d.WoId =  @WoId";
                        dynamicParameters.Add("WoId", WoId);

                        var Osrresult = sqlConnection.Query(sql, dynamicParameters);
                        osrresult = sqlConnection.Query<OSRresult>(sql, dynamicParameters).ToList();

                        if (Osrresult.Count() > 0)
                        {
                            foreach (var i in Osrresult)
                            {
                                #region //應付憑單
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TB001, TB002, TB003, TA003, TA024
                                        FROM ACPTB a
                                        INNER JOIN ACPTA b ON (a.TB001 + '-' + a.TB002) = (b.TA001 + '-' + b.TA002)
                                        WHERE TB005 = @TB005
                                        AND TB006 = @TB006
                                        --AND TB007 = @TB007";
                                dynamicParameters.Add("TB005", i.OsrErpPrefix);
                                dynamicParameters.Add("TB006", i.OsrErpNo);
                                dynamicParameters.Add("TB007", i.OsrSeq);

                                var ACPTBresult = sqlConnection2.Query(sql, dynamicParameters);
                                //aCPTBRresult = sqlConnection2.Query<ACPTBRresult>(sql, dynamicParameters).ToList();

                                

                                if (ACPTBresult.Count() > 0)
                                {
                                    foreach (var j in ACPTBresult)
                                    {
                                        aCPTBRresult.Add(new ACPTBRresult
                                        {
                                            TB001 = j.TB001,
                                            TB002 = j.TB002,
                                            TB003 = j.TB003,
                                            TA003 = j.TA003,
                                            TA024 = j.TA024
                                        });


                                        #region //應付憑單
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.TD001, a.TD002, a.TD003, b.TC003, b.TC008
                                        FROM ACPTD a
                                        INNER JOIN ACPTC b ON (a.TD001 + '-' + a.TD002) = (b.TC001 + '-' + b.TC002)
                                        WHERE TD006 = @TD006
                                        AND TD007 = @TD007";
                                        dynamicParameters.Add("TD006", j.TB001);
                                        dynamicParameters.Add("TD007", j.TB002);

                                        var ACPTDRresult = sqlConnection2.Query(sql, dynamicParameters);
                                        aCPTDRresult = sqlConnection2.Query<ACPTDRresult>(sql, dynamicParameters).ToList();

                                        aCPTBRresult
                                    .Where(y => y.TB001 == j.TB001)
                                    .Where(y => y.TB002 == j.TB002)
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.ACPTDRresult = aCPTDRresult;
                                    });
                                    
                                        #endregion


                                    }
                                    
                                }
                                #endregion

                                osrresult
                                .Where(y => y.OsrId == i.OsrId)
                                .ToList()
                                    .ForEach(x =>
                                    {
                                        x.ACPTBRresult = aCPTBRresult;
                                    });
                            }

                            

                        }
                    

                        #endregion

                        #region //製令變更
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TO001, TO002,TO003,TO004,TO005, TO006, TO007, TO008, TO009, TO041
                                FROM MOCTO
                                WHERE (TO001 + '-' + TO002) = @MoFullNo";
                        dynamicParameters.Add("MoFullNo", WoErpFullNo);

                        var TOresult = sqlConnection2.Query(sql, dynamicParameters);
                        mOCTO = sqlConnection2.Query<MOCTO2>(sql, dynamicParameters).ToList();
                        //if (Moresult.Count() <= 0) throw new SystemException("查無製令資料");
                        #endregion

                        #region //托外退貨
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TL001, TL002, TL003, TL004, TL005, TL007, TL008, TL024, TK003, TK021
                                FROM MOCTL a
								INNER JOIN MOCTK b ON (a.TL001 + '-' + a.TL002) = (b.TK001 + '-' + b.TK002)
                                WHERE (TL015 + '-' + TL016) = @MoFullNo";
                        dynamicParameters.Add("MoFullNo", WoErpFullNo);

                        var TLresult = sqlConnection2.Query(sql, dynamicParameters);
                        tlResult = sqlConnection2.Query<MOCTLRresult>(sql, dynamicParameters).ToList();
                        //if (Moresult.Count() <= 0) throw new SystemException("查無製令資料");
                        #endregion

                        moUnitSearchResult.Add(new MoUnitSearchResult
                        {
                            WoId = WoId,
                            WoErpFullNo = WoErpFullNo
                        });

                        moUnitSearchResult
                                    .Where(y => y.WoId == WoId)
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.MoResult = moResult;
                                        x.MRResult = mRResult;
                                        x.MWEResult = mweresult;
                                        x.OSPresult = ospresult;
                                        x.OSRresult = osrresult;
                                        x.TLResult = tlResult;
                                        x.TOResult = mOCTO;
                                    });

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = moUnitSearchResult
                        });
                        #endregion
                    }
                }

                
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetOutsourcingDetail 托外單明細 GPAI 240705
        public string GetOutsourcingDetail(string OspStartDate, string OspEndDate, string OspCreatStartDate, string OspCreatEndDate, string OspNo, string SupplierNo, string SupplierShortName, string WoErpFullNo, string MtlItemNo, string MtlItemName, int ProcessAlias, string BackSttus, string OsrErpFullNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {


                List<OutsourcingResult> outsourcingResult = new List<OutsourcingResult>();


                var moid = 0;

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //製令
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.OspDetailId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", com.CompanyName CompanyName,b.OspNo OspNo, FORMAT(CONVERT(DATE,b.OspDate), 'yyyy-MM-dd') OspDate, FORMAT(CONVERT(DATE,b.CreateDate), 'yyyy-MM-dd') OspCreateDate, CONCAT(u1.UserNo,u1.UserName) OspUserName,
	                        c.SupplierNo SupplierNo,c.SupplierShortName SupplierShortName,c.SupplierName SupplierName,b.Status,
	                        b.OspDesc OspDesc,	CONCAT(e.WoErpPrefix,'-',e.WoErpNo,'(',d.WoSeq,')') WoErpFullNo, f.MtlItemNo MtlItemNo, f.MtlItemName MtlItemName, f.MtlItemSpec MtlItemSpec,
	                        a.OspQty OspQty, a.SuppliedQty SuppliedQty, a.ProcessCode ProcessCode, a.ProcessCodeName ProcessCodeName,
	                        FORMAT(CONVERT(DATE,b.CreateDate), 'yyyy-MM-dd') WoCreateDate, CONCAT(u2.UserNo,u2.UserName) WoUserName, FORMAT(CONVERT(DATE,a.ExpectedDate), 'yyyy-MM-dd') ExpectedDate,
	                        FORMAT(CONVERT(DATE,h.ReceiptDate), 'yyyy-MM-dd') ReceiptDate, h.OsrErpPrefix, h.OsrErpNo, h.TransferStatus OspTransferStatus, FORMAT(CONVERT(DATE,a.CreateDate), 'yyyy-MM-dd') OspDetailCreateDate
	                        , isnull(h.Remark,'') OspHRemark, isnull(g.OsrSeq,'') OsrSeq, isnull(g.ReceiptQty,'') ReceiptQty, isnull(g.Remark,'')OspBRemark
                            , i.ProcessAlias";
                    sqlQuery.mainTables =
                        @"FROM MES.OspDetail a
	                      left join MES.OutsourcingProduction b on a.OspId=b.OspId
	                      left join SCM.Supplier c on b.SupplierId=c.SupplierId
	                      left join MES.ManufactureOrder d on a.MoId=d.MoId
	                      left join MES.WipOrder e on d.WoId=e.WoId
	                      left join BAS.[User] u1 on b.CreateBy=u1.UserId
	                      left join BAS.[User] u2 on a.CreateBy=u2.UserId
	                      left join PDM.MtlItem f on e.MtlItemId=f.MtlItemId
	                      left join MES.OspReceiptDetail g on a.OspDetailId=g.OspDetailId
	                      left join MES.OspReceipt h on g.OsrId=h.OsrId
	                      left join BAS.Company com on com.CompanyId=b.CompanyId
	                      INNER JOIN MES.MoProcess i ON a.MoProcessId = i.MoProcessId
	                      INNER JOIN MES.Process i2 ON i.ProcessId=i2.ProcessId
                          ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.CompanyId = @CompanyId and b.Status in ('Y','P')";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    string currentDate = DateTime.Now.ToString("yyyy-MM-dd");
                    //dynamicParameters.Add("currentDate", currentDate);

                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspDate", @" AND  FORMAT(CONVERT(DATE,b.OspDate), 'yyyy-MM-dd') >= @OspDate", OspDate);//托外日
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspCreatDate", @" AND  FORMAT(CONVERT(DATE,b.CreateDate), 'yyyy-MM-dd') >= @OspDate", OspDate);//托外建單日
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspStartDate", @" AND b.OspDate >= @OspStartDate", OspStartDate.Length > 0 ? Convert.ToDateTime(OspStartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspEndDate", @" AND b.OspDate <= @OspEndDate", OspEndDate.Length > 0 ? Convert.ToDateTime(OspEndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspCreatStartDate", @" AND b.CreateDate >= @OspCreatStartDate", OspCreatStartDate.Length > 0 ? Convert.ToDateTime(OspCreatStartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspCreatEndDate", @" AND b.CreateDate <= @OspCreatEndDate", OspCreatEndDate.Length > 0 ? Convert.ToDateTime(OspCreatEndDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND e.WoErpPrefix + '-' + e.WoErpNo + '(' + CONVERT(VARCHAR(10), d.WoSeq) + ')' LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo); //至令
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspNo", @" AND b.OspNo = @OspNo", OspNo);//托外單	
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SupplierNo", @" AND c.SupplierNo = @SupplierNo", SupplierNo);//供應商編號
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SupplierShortName", @" AND c.SupplierShortName = @SupplierShortName", SupplierShortName);//簡稱
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND f.MtlItemNo = @MtlItemNo", MtlItemNo);//品號
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND f.MtlItemName = @MtlItemName ", MtlItemName);//品名
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessAlias", @" AND i2.ProcessId = @ProcessAlias  ", ProcessAlias);//製程名
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OsrErpFullNo", @" AND (h.OsrErpPrefix + '-' + h.OsrErpNo) LIKE '%' + @OsrErpFullNo + '%'", OsrErpFullNo);//判斷

                    

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "b.OspDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    outsourcingResult = BaseHelper.SqlQuery<OutsourcingResult>(sqlConnection, dynamicParameters, sqlQuery);

                    foreach (var item in outsourcingResult)
                    {
                        DateTime receiptDate = Convert.ToDateTime(item.ReceiptDate);
                        DateTime expectedDate = Convert.ToDateTime(item.ExpectedDate);

                        DateTime woCreateDate = Convert.ToDateTime(item.WoCreateDate);
                        DateTime ospCreateDate = Convert.ToDateTime(item.OspCreateDate);

                        var transferStatus = item.OspTransferStatus;

                        var ospTransferStatus = "";
                        var backStatus = "";
                        var backStatusRemark = "";
                        var ospTimes = 0.0; //WoCreateDate - ReceiptDate

                        TimeSpan dayTs1 = expectedDate - receiptDate;


                        TimeSpan dayTs2 = Convert.ToDateTime(currentDate) - ospCreateDate;

                        TimeSpan dayTs3 = (receiptDate.AddDays(1)) - ospCreateDate;


                        if (receiptDate == null || item.ReceiptDate == null)
                        {
                            ospTimes = dayTs2.TotalHours;
                        }
                        else
                        {
                            ospTimes = dayTs3.TotalHours ;

                        }


                        if (receiptDate == null || item.ReceiptDate == null) {
                            ospTransferStatus = "";
                        } else if (receiptDate != null && item.OspTransferStatus == "Y") {
                            ospTransferStatus = "已拋轉";
                        } else if (receiptDate != null && item.OspTransferStatus == "N") {
                            ospTransferStatus = "未拋轉";

                        }

                        if (receiptDate == null || item.ReceiptDate == null)
                        {
                            backStatus = "未回廠";
                        }
                        else if (dayTs1.TotalDays < 0)
                        {
                            backStatus = "逾期";
                            backStatusRemark = "逾期回廠" + (dayTs1.TotalDays*(-1)) + "日"; 
                        }
                        else if (dayTs1.TotalDays == 0)
                        {
                            backStatus = "準時";
                            backStatusRemark = "準時回廠";


                        }
                        else if (dayTs1.TotalDays > 0)
                        {
                            backStatus = "提前";
                            backStatusRemark = "提前回廠" + (dayTs1.TotalDays ) + "日";

                        }

                        outsourcingResult
                                   .Where(y => y.WoErpFullNo == item.WoErpFullNo)
                                   .Where(y => y.OspNo == item.OspNo)
                                   .ToList()
                                   .ForEach(x =>
                                   {
                                       x.OspTimes = ospTimes;
                                       x.OpsTransferStatus = ospTransferStatus;
                                       x.BackStatus = backStatus;
                                       x.BackStatusRemark = backStatusRemark;

                                   });

                    }

                    var lll = outsourcingResult;

                    if (BackSttus != "")
                    {
                        lll = outsourcingResult.Where(y => y.BackStatus == BackSttus).ToList();
                    }

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = lll
                    });
                    #endregion


                }


            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GeMoProgressDetail 製令加工進度 GPAI 240709     Jean 2025-01-15
        public string GeMoProgressDetail(string StartDate, string EndDate, string WoErpFullNo, string WoStatus, int ProdMode, string MtlItemNo, string MtlItemName
            , string MoStatus, string QuantityStatusQ, string ReceiptStatusQ, int MoId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {


                //List<MoProgressDetailResult> moProgressDetailResult = new List<MoProgressDetailResult>();
                //List<MoProgressDetailResult> moProgressDetailResult2 = new List<MoProgressDetailResult>();


                //var moid = 0;

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //製令
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "c.MoId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",b.CompanyName, 
                            CONCAT('[',a.WoStatus,']',s1.StatusName) as WoStatus,CONCAT(d.ModeNo,d.ModeName) Mode
                            ,CONCAT(a.WoErpPrefix,'-',a.WoErpNo,'(',c.WoSeq,')') WoErpFullNo
                            ,a.PlanQty ERPPlanQty,CONCAT(u1.UserNo,u1.UserName) WoCreater
                            ,e.MtlItemNo, e.MtlItemName, e.MtlItemDesc
                            ,ISNULL(FORMAT(CONVERT(DATE,a.ExpectedStart), 'yyyy-MM-dd'),'') ExpectedStart, ISNULL(FORMAT(CONVERT(DATE,a.ExpectedEnd), 'yyyy-MM-dd'),'') ExpectedEnd
                            ,ISNULL(FORMAT(CONVERT(DATE,a.ActualStart), 'yyyy-MM-dd'),'') ActualStart, ISNULL(FORMAT(CONVERT(DATE,a.ActualEnd), 'yyyy-MM-dd'),'') ActualEnd
                            ,ISNULL(FORMAT(CONVERT(DATE,c.CreateDate), 'yyyy-MM-dd'),'') MoCreateDay
                            ,CONCAT('[',c.Status,']',s2.StatusName) MoStatus
                            , CONCAT(u2.UserNo,u2.UserName) MoCreater
                            ,c.Quantity MoQuantity, isnull(a.RequisitionSetQty,0) RequisitionSetQty
                            ,CASE WHEN a.RequisitionSetQty<c.Quantity AND a.RequisitionSetQty > 0 THEN '未領足量'
                                  WHEN a.RequisitionSetQty=c.Quantity THEN '已領足'
                                  WHEN isnull(a.RequisitionSetQty,0)=0 THEN '未領料'
                                  WHEN a.RequisitionSetQty>c.Quantity THEN '領料異常' 
                                  END QuantityStatus
                            ,(SELECT COUNT(*) FROM MES.MoProcess Moc WHERE  Moc.MoId = c.MoId) MoTotalProcess
                            ,ISNULL(CONVERT(decimal(18,2), CONVERT(decimal(18,2), m1.ReceiptQtySum) / CONVERT(decimal(18,2), c.Quantity) * 100),0) ProcessProgress
                            ,ISNULL(m1.ReceiptQtySum,0) ReceiptQtySum
                            ,CASE WHEN isnull(m1.ReceiptQtySum,0)<c.Quantity AND c.CompleteQty > 0 THEN '入庫數不足制令產量'
                                  WHEN isnull(m1.ReceiptQtySum,0)=c.Quantity AND c.CompleteQty > 0 THEN '完工入庫'
                                  WHEN isnull(m1.ReceiptQtySum,0)>c.Quantity AND c.CompleteQty = 0 THEN '未做入庫'
                                  ELSE ''
                                  END ReceiptStatus
                                ,(
                                    SELECT  x.MoProcessId,x.SortNumber
                                        , x.ProcessId
                                        ,ISNULL(x.ProcessAlias, '') ProcessAlias
                                        ,ISNULL(r.NotStartQty,0) NotStartQty
                                        ,ISNULL(s.StartQty,0) StartQty
                                        ,ISNULL(t.WipQty,0) WipQty
                                        ,ISNULL(x.TotalPassQty, 0) TotalPassQty, ISNULL(x.TotalNgQty, 0) TotalNgQty, ISNULL(x.TotalScrapQty, 0) TotalScrapQty
                                        , CASE 
                                            WHEN ISNULL(x.TotalInputQty, 0) > 0
                                                THEN CONVERT(varchar, CONVERT(decimal(18,0), CONVERT(decimal(18,0), x.TotalPassQty) / CONVERT(decimal(18,0), x.TotalInputQty) * 100)) + '%'
                                                ELSE '0%'
                                            END PassRate

                                    FROM MES.MoProcess x
                                    LEFT JOIN (SELECT a.MoProcessId,ISNULL(SUM(b.BarcodeQty), 0) AS NotStartQty
                                                FROM MES.MoProcess a
                                                LEFT JOIN MES.Barcode b
                                                ON ((b.CurrentMoProcessId != a.MoProcessId AND b.NextMoProcessId = a.MoProcessId AND b.ParentBarcode IS NULL)
                                                    OR (a.SortNumber = 1 AND b.CurrentMoProcessId = a.MoProcessId AND b.NextMoProcessId = a.MoProcessId))
                                                WHERE 1=1 
                                                GROUP BY a.MoProcessId) r ON x.MoProcessId = r.MoProcessId
                                    LEFT JOIN (SELECT a.MoProcessId,ISNULL(SUM(b.StationQty), 0) AS StartQty
                                                FROM MES.MoProcess a
                                                LEFT JOIN MES.BarcodeProcess b
                                                ON b.MoProcessId = a.MoProcessId
                                                WHERE b.FinishDate IS NULL
                                                GROUP BY a.MoProcessId  
                                                ) s ON x.MoProcessId = s.MoProcessId
                                    LEFT JOIN (SELECT a.MoProcessId,ISNULL(SUM(x.BarcodeQty), 0) AS WipQty
                                                FROM MES.MoProcess a
                                                LEFT JOIN MES.Barcode x
                                                ON x.CurrentMoProcessId = a.MoProcessId AND x.NextMoProcessId != x.CurrentMoProcessId AND x.ParentBarcode IS NULL
                                                GROUP BY a.MoProcessId
                                                ) t ON x.MoProcessId = t.MoProcessId
                                    WHERE x.MoId = c.MoId
                                    ORDER BY x.SortNumber
                                    FOR JSON PATH, ROOT('data')
                                    ) AS ProcessDetail
                            ";
                    sqlQuery.mainTables =
                          @"FROM MES.WipOrder a
                            INNER JOIN BAS.Company b ON a.CompanyId=b.CompanyId
                            INNER JOIN MES.ManufactureOrder c ON a.WoId=c.WoId
                            LEFT JOIN MES.ProdMode d ON c.ModeId=d.ModeId
                            INNER JOIN PDM.MtlItem e ON a.MtlItemId=e.MtlItemId
                            INNER JOIN BAS.[Status] s1 ON s1.StatusNo=a.WoStatus AND s1.StatusSchema='WipOrder.WoStatus'
                            INNER JOIN BAS.[Status] s2 ON s2.StatusNo=c.[Status] AND s2.StatusSchema='ManufactureOrder.Status' 
                            LEFT JOIN BAS.[User] u1 ON a.UserId=u1.UserId
                            INNER JOIN BAS.[User] u2 ON c.CreateBy=u2.UserId
                            LEFT JOIN ( SELECT mw.MoId,SUM(mw.ReceiptQty)ReceiptQtySum
                                        FROM MES.MweDetail mw 
                                        GROUP BY mw.MoId
                                        ) m1 ON m1.MoId=c.MoId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND a.CompanyId = @CompanyId AND c.MoId is not null";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    //dynamicParameters.Add("currentDate", currentDate);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND a.WoErpPrefix + '-' + a.WoErpNo + '(' + CONVERT(VARCHAR(10), c.WoSeq) + ')' LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND c.CreateDate >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND c.CreateDate <= @EndDate", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoStatus", @" AND c.[Status] = @MoStatus", MoStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoStatus", @" AND a.WoStatus = @WoStatus", WoStatus);


                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProdMode", @" AND d.ModeId = @ProdMode", ProdMode);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND e.MtlItemNo = @MtlItemNo", MtlItemNo);//品號
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND e.MtlItemName = @MtlItemName ", MtlItemName);//品名

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND c.MoId = @MoId ", MoId);//品名 

                    sqlQuery.conditions = queryCondition;
                    //sqlQuery.groupBy = " GROUP BY c.MoId";
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.ExpectedEnd DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    //sqlQuery.distinct = true;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);
                    //string currentDate = DateTime.Now.ToString("yyyy-MM-dd");

                    //moProgressDetailResult = BaseHelper.SqlQuery<MoProgressDetailResult>(sqlConnection, dynamicParameters, sqlQuery);





                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion


                }


            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetBarcodeTrackQuery 條碼生產追溯 GPAI 240717
        public string GetBarcodeTrackQuery(string StartDate, string EndDate, string WoErpFullNo, string WoStatus, int ProdMode, string MtlItemNo, string MtlItemName
            , string MoStatus, string QuantityStatusQ, string ReceiptStatusQ, int MoId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {


                List<MoProgressDetailResult> moProgressDetailResult = new List<MoProgressDetailResult>();
                List<MoProgressDetailResult> moProgressDetailResult2 = new List<MoProgressDetailResult>();


                var moid = 0;

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //製令
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "c.MoId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",b.CompanyName, CONCAT('[',a.WoStatus,']',s1.StatusName) as WoStatus, CONCAT(u1.UserNo,u1.UserName) WoCreater, a.PlanQty ERPPlanQty
                            , CONCAT(d.ModeNo,d.ModeName) Mode, CONCAT(a.WoErpPrefix,'-',a.WoErpNo,'(',c.WoSeq,')') WoErpFullNo
                            ,e.MtlItemNo, e.MtlItemName, e.MtlItemDesc
                            ,FORMAT(CONVERT(DATE,a.ExpectedStart), 'yyyy-MM-dd') ExpectedStart, FORMAT(CONVERT(DATE,a.ExpectedEnd), 'yyyy-MM-dd') ExpectedEnd
                            ,FORMAT(CONVERT(DATE,a.ActualStart), 'yyyy-MM-dd') ActualStart, FORMAT(CONVERT(DATE,a.ActualEnd), 'yyyy-MM-dd') ActualEnd
                            ,FORMAT(CONVERT(DATE,c.CreateDate), 'yyyy-MM-dd') MoCreateDay
                            ,CONCAT('[',c.Status,']',s2.StatusName) MoStatus, CONCAT(u2.UserNo,u2.UserName) MoCreater
                            ,c.Quantity MoQuantity, isnull(a.RequisitionSetQty,0) RequisitionSetQty
                            ,case when a.RequisitionSetQty<c.Quantity AND a.RequisitionSetQty > 0 then '未領足量'
                                when a.RequisitionSetQty=c.Quantity then '已領足'
                                when isnull(a.RequisitionSetQty,0)=0 then '未領料'
                                when a.RequisitionSetQty>c.Quantity then '領料異常'end QuantityStatus
                            ,(SELECT COUNT(*) FROM MES.MoProcess Moc WHERE  Moc.MoId = c.MoId) MoTotalProcess    
                            --, isnull(dd.StationQty,0) StationQty, f.SortNumber
                            , c.Quantity, isnull(mw.ReceiptQty,0) ReceiptQty, c.CompleteQty
                            ";
                    sqlQuery.mainTables =
                        @"FROM MES.WipOrder a
                          INNER JOIN BAS.Company b ON a.CompanyId=b.CompanyId
                          INNER JOIN MES.ManufactureOrder c ON a.WoId=c.WoId
                          LEFT JOIN MES.ProdMode d ON c.ModeId=d.ModeId
                          INNER JOIN PDM.MtlItem e ON a.MtlItemId=e.MtlItemId
                         -- INNER JOIN MES.MoProcess f ON c.MoId=f.MoId 
                          INNER JOIN BAS.[Status] s1 ON s1.StatusNo=a.WoStatus AND s1.StatusSchema='WipOrder.WoStatus'
                          INNER JOIN BAS.[Status] s2 ON s2.StatusNo=c.[Status] AND s2.StatusSchema='ManufactureOrder.Status' 
                          LEFT JOIN BAS.[User] u1 ON a.UserId=u1.UserId
                          INNER JOIN BAS.[User] u2 ON c.CreateBy=u2.UserId
                          --LEFT join MES.BarcodeProcess dd ON dd.MoProcessId = f.MoProcessId and dd.MoId = c.MoId --**
                          LEFT join MES.MweDetail mw ON mw.MoId = c.MoId  AND mw.ConfirmStatus ='Y' --**";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND a.CompanyId = @CompanyId AND c.MoId is not null";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    //dynamicParameters.Add("currentDate", currentDate);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND a.WoErpPrefix + '-' + a.WoErpNo + '(' + CONVERT(VARCHAR(10), c.WoSeq) + ')' LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND c.CreateDate >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND c.CreateDate <= @EndDate", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoStatus", @" AND c.[Status] = @MoStatus", MoStatus);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoStatus", @" AND a.WoStatus = @WoStatus", WoStatus);


                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProdMode", @" AND d.ModeId = @ProdMode", ProdMode);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND e.MtlItemNo = @MtlItemNo", MtlItemNo);//品號
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND e.MtlItemName = @MtlItemName ", MtlItemName);//品名

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND c.MoId = @MoId ", MoId);//品名 


                    //領料狀態
                    if (QuantityStatusQ != "")
                    {
                        switch (QuantityStatusQ)
                        {
                            case "未領足量"://
                                queryCondition += @" AND a.RequisitionSetQty<c.Quantity AND a.RequisitionSetQty > 0";
                                break;
                            case "已領足":
                                queryCondition += @" AND a.RequisitionSetQty=c.Quantity";
                                break;
                            case "未領料":
                                queryCondition += @" AND isnull(a.RequisitionSetQty,0)=0";
                                break;
                            case "領料異常":
                                queryCondition += @" AND a.RequisitionSetQty>c.Quantity ";
                                break;
                            default:
                                break;
                        }
                    }
                    //入庫狀態
                    if (ReceiptStatusQ != "")
                    {
                        switch (ReceiptStatusQ)
                        {
                            case "入庫數不足制令產量"://
                                queryCondition += @" AND isnull(mw.ReceiptQty,0)<c.Quantity AND c.CompleteQty > 0";
                                break;
                            case "完工入庫":
                                queryCondition += @" AND isnull(mw.ReceiptQty,0)=c.Quantity AND c.CompleteQty > 0";
                                break;
                            case "未做入庫":
                                queryCondition += @" AND c.CompleteQty = 0 AND (isnull(mw.ReceiptQty,0) / c.Quantity) > 0";
                                break;
                            default:
                                break;
                        }
                    }

                    sqlQuery.conditions = queryCondition;
                    //sqlQuery.groupBy = " GROUP BY c.MoId";
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.ExpectedEnd DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    //sqlQuery.distinct = true;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);
                    string currentDate = DateTime.Now.ToString("yyyy-MM-dd");

                    moProgressDetailResult = BaseHelper.SqlQuery<MoProgressDetailResult>(sqlConnection, dynamicParameters, sqlQuery);

                    if (moProgressDetailResult.Count() > 0)
                    {

                        var StationQtySum = 0.0;
                        var ReceiptQtySum = 0.0;

                        var Quantity = 0;
                        var SortNumber = 0;
                        var Moid = 0;
                        var ReceiptStatus = "";

                        var MoTotalProcess = 0;

                        SortNumber = moProgressDetailResult.LastOrDefault().SortNumber;
                        Moid = moProgressDetailResult.FirstOrDefault().MoId;

                        foreach (var item2 in moProgressDetailResult)//ReceiptQty
                        {
                            StationQtySum += item2.StationQty;
                            ReceiptQtySum = item2.ReceiptQty;

                            Quantity = item2.MoQuantity;

                            ReceiptStatus = "";
                            MoTotalProcess = item2.MoTotalProcess;

                            Moid = item2.MoId;


                            if (ReceiptQtySum < Quantity && item2.CompleteQty > 0)
                            {
                                ReceiptStatus = "入庫數不足制令產量";
                            }
                            else if (ReceiptQtySum == Quantity && item2.CompleteQty > 0)
                            {
                                ReceiptStatus = "完工入庫";
                            }
                            else if (item2.CompleteQty == 0 && ((ReceiptQtySum / Quantity) * 100) > 0)
                            {
                                ReceiptStatus = "未做入庫";
                            }
                            else if (item2.CompleteQty == 0 && ((ReceiptQtySum / Quantity) * 100) == 0)
                            {
                                ReceiptStatus = "";
                            }


                            double bb = Math.Round((ReceiptQtySum / Quantity) * 100, 2);
                            moProgressDetailResult
                                .Where(y => y.MoId == Moid)
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.ProcessProgress = bb;//
                                    x.ReceiptStatus = ReceiptStatus;
                                    x.StationQtySum = StationQtySum;
                                    x.ReceiptQtySum = ReceiptQtySum;

                                });

                        }



                    }



                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = moProgressDetailResult
                    });
                    #endregion


                }


            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetOrderStockReport -- 訂單進度&庫存數量統計報表 -- Luca 2024.09.20 
        public string GetOrderStockReport(string LensModel, string LensModelName, string Unshipped
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {               
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "c.LensModel";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @"  ,c.LensModelName,ISNULL(c.OrderCount, 0) AS OrderCount
                                ,ISNULL(c.ShippedQty, 0) AS ShippedQty
                                ,ISNULL(c.UnshippedQty, 0) AS UnshippedQty
                                ,ISNULL(c.MainItemStock, 0) AS MainItemStock
                                ,(
                                    SELECT
                                    LTRIM(RTRIM(d.bomdMtlNo)) AS ComponentMtlItemNo,
                                    ISNULL(d.ComponentStock, 0) AS ComponentItemStock,
                                    ISNULL(d.UnissuedQty, 0) AS UnissuedQty,
                                    ISNULL(d.RequisitionQty, 0) AS RequisitionQty,
                                    ISNULL(d.ReceivedNotStocked, 0) AS ReceivedNotStocked
                                    FROM (
                                        SELECT a1.bomMtlNo, a1.bomdMtlNo,
                                        ISNULL(d1.InventoryQty, 0) AS ComponentStock,
                                        ISNULL(SUM(b1.需領用量) - SUM(b1.已領用量), 0) AS UnissuedQty,
                                        ISNULL(SUM(b1.已領用量), 0) AS RequisitionQty,
                                        ISNULL(SUM(c1.採購數量) - SUM(c1.已交數量), 0) AS ReceivedNotStocked
                                        FROM (
                                            SELECT bomMtl.MtlItemNo bomMtlNo , bomdMtl.MtlItemNo bomdMtlNo
                                            FROM PDM.BillOfMaterials bom
                                                LEFT JOIN PDM.BomDetail bomd ON bom.BomId=bomd.BomId
                                                LEFT JOIN PDM.MtlItem bomMtl ON bom.MtlItemId=bomMtl.MtlItemId
                                                LEFT JOIN PDM.MtlItem bomdMtl ON bomd.MtlItemId=bomdMtl.MtlItemId
                                            WHERE bom.ConfirmStatus='Y'
                                        )a1
                                        LEFT JOIN (
                                            SELECT wipMtl.MtlItemNo wipMtlNo, wipdMtl.MtlItemNo wipdMtlNo
                                            , SUM(wipd.DemandRequisitionQty) AS '需領用量'
                                            , SUM(wipd.RequisitionQty) AS '已領用量'
                                            FROM MES.WipOrder wip
                                                LEFT JOIN MES.WoDetail wipd ON wip.WoId=wipd.WoId
                                                LEFT JOIN PDM.MtlItem wipMtl ON wip.MtlItemId=wipMtl.MtlItemId
                                                LEFT JOIN PDM.MtlItem wipdMtl ON wipd.MtlItemId=wipdMtl.MtlItemId
                                            WHERE wip.ConfirmStatus='Y'
                                            GROUP BY wipMtl.MtlItemNo,wipdMtl.MtlItemNo
                                        ) b1 ON b1.wipMtlNo = a1.bomMtlNo AND b1.wipdMtlNo=a1.bomdMtlNo
                                        LEFT JOIN (
                                            SELECT podMtl.MtlItemNo podMtlNo
                                            , SUM(pod.Quantity) AS '採購數量'
                                            , SUM(pod.SiQty) AS '已交數量'
                                            FROM SCM.PurchaseOrder po
                                                LEFT JOIN SCM.PoDetail pod ON po.PoId=pod.PoId
                                                LEFT JOIN PDM.MtlItem podMtl ON pod.MtlItemId=podMtl.MtlItemId
                                            WHERE po.ConfirmStatus='Y'
                                            GROUP BY podMtl.MtlItemNo
                                        ) c1 ON c1.podMtlNo = a1.bomdMtlNo
                                        LEFT JOIN (
                                            SELECT iinvMtl.MtlItemNo iinvMtlNo,iinv.MtlItemId, ISNULL(SUM(iinv.InventoryQty), 0) AS InventoryQty
                                            FROM SCM.ItemInventory iinv
                                                LEFT JOIN PDM.MtlItem iinvMtl ON iinv.MtlItemId=iinvMtl.MtlItemId
                                                LEFT JOIN SCM.Inventory inv ON inv.InventoryId=iinv.InventoryId
                                            WHERE iinv.InventoryQty>0
                                            GROUP BY iinvMtl.MtlItemNo,iinv.MtlItemId
                                        ) d1 ON d1.iinvMtlNo = a1.bomdMtlNo
                                        GROUP BY a1.bomMtlNo, a1.bomdMtlNo,d1.InventoryQty
                                    ) d
                                    WHERE d.bomMtlNo=c.LensModel
                                    FOR JSON PATH, ROOT('data')
                                ) AS ComponentData";
                        sqlQuery.mainTables =
                          @" FROM (
                                SELECT sodMtl.MtlItemNo AS LensModel,sodMtl.MtlItemName AS LensModelName,
                                SUM(sod.SoQty) AS OrderCount,
                                SUM(sod.SiQty) AS ShippedQty,
                                SUM(sod.SoQty) - SUM(sod.SiQty) AS UnshippedQty,
                                ISNULL(x.InventoryQty, 0) AS MainItemStock,
                                so.CompanyId
                                FROM SCM.SaleOrder so
                                    LEFT JOIN SCM.SoDetail sod ON so.SoId=sod.SoId
                                    LEFT JOIN PDM.MtlItem sodMtl ON sod.MtlItemId=sodMtl.MtlItemId
                                    LEFT JOIN (
                                        SELECT iinv.MtlItemId, ISNULL(SUM(iinv.InventoryQty), 0) AS InventoryQty
                                        FROM SCM.ItemInventory iinv
                                            LEFT JOIN PDM.MtlItem iinvMtl ON iinv.MtlItemId=iinvMtl.MtlItemId
                                            LEFT JOIN SCM.Inventory inv ON inv.InventoryId=iinv.InventoryId
                                        WHERE iinv.InventoryQty>0
                                        GROUP BY iinv.MtlItemId
                                    ) x ON sod.MtlItemId=x.MtlItemId
                                WHERE so.ConfirmStatus='Y'
                                GROUP BY sodMtl.MtlItemNo,sodMtl.MtlItemName,so.CompanyId,x.InventoryQty
                            )c";
                        sqlQuery.auxTables = "";                        
                        string queryCondition = @"AND c.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "LensModel", @" AND c.LensModel LIKE '%' + @LensModel + '%'", LensModel);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "LensModelName", @" AND c.LensModelName LIKE '%' + @LensModelName + '%' ", LensModelName);

                        if (Unshipped == ">0")
                            {
                                queryCondition += " AND c.UnshippedQty > 0";
                            }
                            else if (Unshipped == "=0")
                            {
                                queryCondition += " AND c.UnshippedQty = 0";
                            }
                            
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "c.LensModel ASC";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;
                        var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion                    
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetItemOrderReport --品號訂單數量統計報表
        public string GetItemOrderReport(string MtlItemNo,string SaleNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "b.SoDetailId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @"  ,a.SoErpPrefix + '-' + a.SoErpNo + '(' + b.SoSequence + ')' AS SoInfo,
                            b1.MtlItemNo,b1.MtlItemName,
                            c.CustomerShortName,
                            b.PromiseDate,
                            b.SoQty,
                            b.SiQty,
                            CASE 
                                WHEN b.SiQty >= b.SoQty THEN '已出貨' ELSE '未出貨'
                            END AS SoStatus,
                            (
                                SELECT
                                ISNULL(d.WoErpPrefix + '-' + d.WoErpNo,'未綁工單') AS WipInfo,
                                ISNULL(d.PlanQty,-999) AS PlanQty,
                                ISNULL(d.RequisitionSetQty,-999) AS RequisitionSetQty,
                                ISNULL(d.StockInQty,-999) AS StockInQty,
                                CASE 
                                        WHEN b.SiQty >= b.SoQty THEN '已出貨'
                                        WHEN b.SiQty < b.SoQty AND d.RequisitionSetQty > 0 THEN '製造中'
                                        WHEN b.SiQty < b.SoQty AND (d.RequisitionSetQty = 0 OR d.RequisitionSetQty IS NULL) THEN '未加工'
                                    END AS Status
                                FROM MES.WipOrder d
                                WHERE d.SoDetailId=b.SoDetailId
                                FOR JSON PATH, ROOT('data')
                            ) AS ComponentData";
                    sqlQuery.mainTables =
                      @" FROM
                            SCM.SaleOrder a
                            INNER JOIN SCM.SoDetail b ON a.SoId = b.SoId
                            INNER JOIN PDM.MtlItem b1 ON b.MtlItemId = b1.MtlItemId
                            INNER JOIN SCM.Customer c ON a.CustomerId = c.CustomerId ";
                    sqlQuery.auxTables = "";
                    sqlQuery.distinct = true;
                    string queryCondition = @"AND c.CompanyId = @CompanyId AND a.ConfirmStatus='Y' ";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND b1.MtlItemNo= @MtlItemNo", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SaleNo", @" AND a.SoErpPrefix+'-'+a.SoErpNo+'('+b.SoSequence+')'  LIKE '%' + @SaleNo + '%' ", SaleNo);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.SoErpPrefix+'-'+a.SoErpNo+'('+b.SoSequence+')' ASC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;
                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetRptMoInformation2 -- 取得生產異常資料(業務用) -- GPai 2024-10-07
        public string GetRptMoInformation2(string WoErpFullNo, string ModeDesc, string CustomerShortName, string SearchKey, string ExpectedStart, string ExpectedEnd
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    string mainSql = @"SELECT a.MoId, (b.WoErpPrefix + '-' + b.WoErpNo ) AS WoErpFullNo, a.WoSeq,
                                       FORMAT(b.ExpectedStart, 'yyyy-MM-dd') ExpectedStart, FORMAT(b.ExpectedEnd, 'yyyy-MM-dd') ExpectedEnd, FORMAT(b.ActualStart, 'yyyy-MM-dd') ActualStart, FORMAT(b.ActualEnd, 'yyyy-MM-dd') ActualEnd,
                                       ISNULL(c.CustomerShortName, '工單尚未綁定訂單') AS CustomerShortName,
                                       d.ModeDesc,
                                       e.MtlItemNo, e.MtlItemName,
                                       ISNULL(f.BarcodeQty, '') AS LatestBarcodeQty,
                                       ISNULL(f.ProcessAlias, '') AS LatestProcess,
                                	   g.CompanyNo
                                       FROM MES.ManufactureOrder a
                                       INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                       LEFT JOIN (
                                           SELECT sd.SoDetailId, sc.CustomerShortName
                                           FROM SCM.SoDetail sd
                                           INNER JOIN SCM.SaleOrder so ON sd.SoId = so.SoId
                                           INNER JOIN SCM.Customer sc ON so.CustomerId = sc.CustomerId
                                       ) c ON c.SoDetailId = b.SoDetailId
                                       INNER JOIN MES.ProdMode d ON a.ModeId = d.ModeId
                                       INNER JOIN PDM.MtlItem e ON b.MtlItemId = e.MtlItemId
                                       OUTER APPLY (
                                           SELECT TOP 1 f1.BarcodeNo, f2.ProcessAlias, f1.BarcodeQty
                                           FROM MES.Barcode f1
                                       	   INNER JOIN MES.MoProcess f2 ON f1.CurrentMoProcessId = f2.MoProcessId
                                           WHERE f1.MoId = a.MoId
                                             AND f1.NextMoProcessId != -1
                                             AND f1.BarcodeStatus = 1
                                             AND f1.CurrentProdStatus != 'S'
                                             AND f1.BarcodeQty > 0
                                           ORDER BY f1.CurrentMoProcessId ASC
                                       ) f
                                       INNER JOIN BAS.Company g ON b.CompanyId = g.CompanyId
                                     WHERE b.WoStatus NOT IN ('Y', 'y')
                                     AND b.CompanyId = @CompanyId
                                     AND b.ActualEnd <= GETDATE()";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "WoErpFullNo", @" AND b.WoErpPrefix + '-' + b.WoErpNo  LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "ModeDesc", @" AND (d.ModeDesc LIKE '%' + @ModeDesc + '%')", ModeDesc);
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "CustomerShortName", @" AND (c.CustomerShortName LIKE '%' + @CustomerShortName + '%')", CustomerShortName);
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "SearchKey", @" AND (c.MtlItemNo LIKE '%' + @SearchKey + '%' OR c.MtlItemName LIKE '%' + @SearchKey + '%')", SearchKey);
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "ExpectedStart", @" AND b.ExpectedStart >= @ExpectedStart", ExpectedStart.Length > 0 ? Convert.ToDateTime(ExpectedStart).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "ExpectedEnd", @" AND b.ExpectedEnd <= @ExpectedEnd", ExpectedEnd.Length > 0 ? Convert.ToDateTime(ExpectedEnd).ToString("yyyy-MM-dd 23:59:59") : "");
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);



                    sql += mainSql + @" ORDER BY b.ExpectedEnd desc
                                        OFFSET @PageSize * (@PageIndex - 1) ROWS
                                        FETCH NEXT @PageSize ROWS ONLY;";
                    dynamicParameters.Add("PageSize", PageSize);
                    dynamicParameters.Add("PageIndex", PageIndex);

                    var result = sqlConnection.Query(sql, dynamicParameters);



                    var dynamicParameters2 = new DynamicParameters();

                    string sql2 = @"SELECT COUNT(1) AS TotalCount
                            FROM (" + mainSql + ") AS TotalQuery";
                    dynamicParameters2.Add("CompanyId", CurrentCompany);
                    dynamicParameters2.Add("WoErpFullNo", WoErpFullNo);
                    dynamicParameters2.Add("ModeDesc", ModeDesc);
                    dynamicParameters2.Add("SearchKey", SearchKey);
                    dynamicParameters2.Add("ExpectedStart", ExpectedStart);
                    dynamicParameters2.Add("ExpectedEnd", ExpectedEnd);
                    dynamicParameters2.Add("CustomerShortName", CustomerShortName);
                    dynamicParameters2.Add("PageSize", PageSize);
                    dynamicParameters2.Add("PageIndex", PageIndex);


                    var TotalCountResult = sqlConnection.Query(sql2, dynamicParameters2);

                    int TotalCount = 0;
                    foreach (var item in TotalCountResult)
                    {
                        TotalCount = item.TotalCount;
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        result,
                        TotalCount
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetInProcessGoodsDefectRateReport -- 在製品不良率報表 -- Jean 2025.02.08
        public string GetInProcessGoodsDefectRateReport(int ModeId, string MtlItemNo, string StartDate, string EndDate
            , string OrderBy, int PageIndex, int PageSize, int RedirectType)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    string mainSql = @"SELECT h1.CompanyId,h1.ModeId,h1.MtlItemNo,h1.MtlItemName
                                            ,h2.sumInputQty,h2.sumCompleteQty,h2.sumScrapQty
                                            ,h1.FinishDate01,h1.sumStationQty,h1.sumPassQty,h1.sumNgQty
                                            ,ISNULL(CONVERT(decimal(18,2), CONVERT(decimal(18,2), h1.sumPassQty) / CONVERT(decimal(18,2), h1.sumStationQty) * 100),0) PassRate
                                            ,(SELECT h3.sumNgQty,h3.CauseDesc
                                                FROM(
                                                    SELECT 
                                                        SUM(g3.NgQty)sumNgQty,g3.CauseNo,g3.CauseDesc
                                                    FROM (
                                                            SELECT 
                                                                f3.MtlItemNo,f3.MtlItemName
                                                                , CASE WHEN DATEPART(HOUR, a3.FinishDate) BETWEEN 0 AND 7
                                                                       THEN CONVERT(VARCHAR(10), DATEADD(DAY, -1, a3.FinishDate), 120)
                                                                       ELSE CONVERT(VARCHAR(10), a3.FinishDate, 120)
                                                                       END AS FinishDate01
                                                                    ,a3.NgQty,a3.CauseNo,z3.CauseDesc
                                                                    ,f3.CompanyId,f3.CompanyName,f3.ModeId
                                                            FROM MES.BarcodeProcess a3
                                                            INNER JOIN MES.Barcode b3 ON a3.BarcodeId=b3.BarcodeId
                                                            INNER JOIN QMS.DefectCause z3 ON z3.CauseNo=a3.CauseNo
                                                            INNER JOIN (
                                                                select q3.MoId,s3.MtlItemNo,s3.MtlItemName,q3.InputQty,q3.CompleteQty,q3.ScrapQty,w3.CompanyId,r3.CompanyName,t3.ModeId
                                                                FROM MES.ManufactureOrder q3     
                                                                INNER JOIN MES.WipOrder w3 ON q3.WoId=w3.WoId      
                                                                INNER JOIN PDM.MtlItem s3 ON w3.MtlItemId=s3.MtlItemId     
                                                                INNER JOIN BAS.Company r3 ON r3.CompanyId = w3.CompanyId
                                                                INNER JOIN MES.ProdMode t3 ON t3.ModeId=q3.ModeId
                                                            )f3 ON f3.MoId=b3.MoId
                                                            WHERE a3.NgQty!=0 AND f3.MtlItemNo=h1.MtlItemNo
                                                        )g3
                                                    WHERE g3.FinishDate01=h1.FinishDate01 AND g3.MtlItemNo=h1.MtlItemNo
                                                    GROUP BY g3.MtlItemNo,g3.FinishDate01,g3.CauseNo,g3.CauseDesc,g3.MtlItemName,g3.CompanyId,g3.CompanyName,g3.ModeId
                                                    )h3 FOR JSON PATH, ROOT('data')
                                                ) AS InvalidData
                                    FROM (
                                            SELECT g1.CompanyId,g1.ModeId,g1.MtlItemNo,g1.MtlItemName,g1.FinishDate01
                                                    ,SUM(g1.StationQty)sumStationQty,SUM(g1.PassQty)sumPassQty,SUM(g1.NgQty)sumNgQty
                                            FROM (SELECT f1.ModeId,f1.CompanyId,f1.MoId,f1.MtlItemNo,f1.MtlItemName,a1.FinishDate
                                                      , CASE WHEN DATEPART(HOUR, a1.FinishDate) BETWEEN 0 AND 7
                                                                       THEN CONVERT(VARCHAR(10), DATEADD(DAY, -1, a1.FinishDate), 120)
                                                                       ELSE CONVERT(VARCHAR(10), a1.FinishDate, 120)
                                                                       END AS FinishDate01
                                                            ,a1.StationQty,a1.PassQty,a1.NgQty
                                                    FROM MES.BarcodeProcess a1
                                                    INNER JOIN MES.Barcode b1 ON a1.BarcodeId=b1.BarcodeId
                                                    INNER JOIN (
                                                            SELECT q1.MoId,s1.MtlItemNo,s1.MtlItemName,q1.InputQty,q1.CompleteQty,q1.ScrapQty,w1.CompanyId,r1.CompanyName,t1.ModeId
                                                            FROM MES.ManufactureOrder q1     
                                                            INNER JOIN MES.WipOrder w1 ON q1.WoId=w1.WoId      
                                                            INNER JOIN PDM.MtlItem s1 ON w1.MtlItemId=s1.MtlItemId     
                                                            INNER JOIN BAS.Company r1 ON r1.CompanyId = w1.CompanyId
                                                            INNER JOIN MES.ProdMode t1 ON t1.ModeId=q1.ModeId
                                                            )f1 ON f1.MoId=b1.MoId   
                                            )g1
                                            GROUP BY g1.MtlItemNo,g1.FinishDate01,g1.MtlItemName,g1.ModeId,g1.CompanyId
                                    )h1
                                    INNER JOIN (
                                            SELECT sum(g2.InputQty)sumInputQty,sum(g2.CompleteQty)sumCompleteQty,sum(g2.ScrapQty)sumScrapQty,g2.MtlItemNo
                                            FROM(
                                                    SELECT DISTINCT c2.InputQty,c2.CompleteQty,c2.ScrapQty,e2.MtlItemNo,a2.MoId
                                                    FROM MES.BarcodeProcess a2
                                                    INNER JOIN MES.Barcode b2 ON a2.BarcodeId=b2.BarcodeId
                                                    INNER JOIN MES.ManufactureOrder c2 ON c2.MoId=a2.MoId
                                                    INNER JOIN MES.WipOrder d2 ON d2.WoId=c2.WoId      
                                                    INNER JOIN PDM.MtlItem e2 ON e2.MtlItemId=d2.MtlItemId
                                            )g2 
                                            GROUP BY g2.MtlItemNo
                                    )h2 ON h2.MtlItemNo=h1.MtlItemNo
                                        WHERE  h1.CompanyId= @CompanyId";

                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "ModeId", @" AND h1.ModeId = @ModeId", ModeId);
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "MtlItemNo", @" AND (h1.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR h1.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "StartDate", @" AND h1.FinishDate01 >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd") : "");
                    BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "EndDate", @" AND h1.FinishDate01 <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd") : "");

                    // mainSql += @" GROUP BY g.CompanyId,g.CompanyName,g.MtlItemName,g.MtlItemNo,h.FinishDate01,h.sumStationQty,h.sumPassQty,h.sumNgQty,g.ModeId";


                    if (RedirectType == 1)
                    {
                        sql += mainSql + @" ORDER BY h1.MtlItemNo,h1.FinishDate01
                                            OFFSET @PageSize * (@PageIndex - 1) ROWS
                                            FETCH NEXT @PageSize ROWS ONLY";
                        dynamicParameters.Add("PageSize", PageSize);
                        dynamicParameters.Add("PageIndex", PageIndex);
                    }
                    else if (RedirectType == 2)
                    {
                        sql += mainSql + @" ORDER BY h1.MtlItemNo,h1.FinishDate01";
                    }


                    //sql += mainSql + @" ORDER BY g.MtlItemNo,h.FinishDate01
                    //                       OFFSET @PageSize * (@PageIndex - 1) ROWS
                    //                      FETCH NEXT @PageSize ROWS ONLY";
                    //dynamicParameters.Add("PageSize", PageSize);
                    //dynamicParameters.Add("PageIndex", PageIndex);


                    var result = sqlConnection.Query(sql, dynamicParameters);

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT COUNT(1) AS TotalCount
                            FROM (" + mainSql + ") AS TotalQuery";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("ModeId", ModeId);
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);
                    dynamicParameters.Add("StartDate", StartDate);
                    dynamicParameters.Add("EndDate", EndDate);

                    var TotalCountResult = sqlConnection.Query(sql, dynamicParameters);


                    int TotalCount = 0;
                    foreach (var item in TotalCountResult)
                    {
                        TotalCount = item.TotalCount;
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        result,
                        TotalCount
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckOrderAndProduction 取得訂單與在製狀況 --kitty cat  2024-12-04
        public string GetCheckOrderAndProduction(string MtlItemNo)
        {
            try
            {
                if (MtlItemNo.Length <= 0) throw new SystemException("至少需有一個品號條件才能查詢!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"WITH CTE AS (
                                            SELECT 
                                            TD.TD001, TD.TD002, TD.TD004, TD.TD005, MA.MA003, TD.TD013, TD.TD008, TD.TD009,
                                            ISNULL(Inventory.TotalInventory, 0) AS TotalInventory, --庫存數
                                            ROW_NUMBER() OVER (PARTITION BY TD.TD004 ORDER BY TD.TD001, TD.TD002) AS RowNum
                                        FROM 
                                            COPTD TD
                                        JOIN 
                                            COPTC TC 
                                            ON TC.TC001 = TD.TD001 AND TC.TC002 = TD.TD002
                                        JOIN 
                                            COPMA MA 
                                            ON TC.TC004 = MA.MA001
                                        LEFT JOIN 
                                            (
                                                SELECT 
                                                    MC001, 
                                                    SUM(MC007) AS TotalInventory
                                                FROM 
                                                    INVMC
                                                WHERE 
                                                    MC002 NOT IN ('A07', 'B01', 'B02', 'B03', 'B04', 'B05', 'B06', 'C01', 'C02', 'C03', 'C99') --待報廢倉以及BC倉,皆不算在可用庫存
                                                GROUP BY 
                                                    MC001
                                            ) AS Inventory
                                            ON Inventory.MC001 = TD.TD004
                                        WHERE 
                                            TD.TD004 = @MtlItemNo
                                            AND TD.TD016 NOT IN ('Y', 'y')
                                    ),
                                    RankedData AS (
                                        SELECT 
                                            TA.TA001, TA.TA002, TA.TA006, TA.TA034, TA.TA015, TA.TA011, TA.TA013,
                                            TB.TB003, TB.TB004, TB.TB005, TB.TB010, TB.TB023,
                                            CASE 
                                                WHEN TB.TB010 IS NOT NULL AND TB.TB010 <> '' THEN TB.TB023
                                                ELSE TB.TB003
                                            END AS nTB003,
                                            CAST(ROUND(TA.TA015 / TB.TB004 * TB.TB005, 0) AS INT) AS NumberOfSets, --領料成套數
                                            ROW_NUMBER() OVER (PARTITION BY TA.TA001, TA.TA002, TA.TA006 ORDER BY 
                                                                CAST(ROUND(TA.TA015 / TB.TB004 * TB.TB005, 0) AS INT)) AS rn
                                        FROM 
                                            MOCTA TA
                                        JOIN 
                                            MOCTB TB
                                        ON 
                                            TA.TA001 = TB.TB001 AND 
                                            TA.TA002 = TB.TB002 AND 
                                            TA.TA006 = TB.TB014
                                        WHERE 
                                            TA.TA006 = @MtlItemNo
                                            AND TA.TA011 NOT IN ('Y', 'y')
                                            AND TA.TA013 NOT IN ('N', 'V')
                                    ),
                                    TotalStorageData AS (
                                        SELECT 
                                            TA.TA001, 
                                            TA.TA002, 
                                            TA.TA006,  
                                            CAST(ROUND(TA.TA017 + TA.TA018, 0) AS INT) AS TotalStorage --入庫數
                                        FROM 
                                            MOCTA TA
                                        WHERE 
                                            TA.TA006 = @MtlItemNo
                                            AND (TA.TA011 <> 'Y' AND TA.TA011 <> 'y')
                                            AND (TA.TA013 <> 'N' AND TA.TA013 <> 'V')
                                    )
                                    SELECT  
                                        C.TD001, C.TD002, C.TD004, C.TD005, C.MA003, C.TD013, C.TD008, C.TD009,
                                        ISNULL((C.TD008 - C.TD009), 0) AS UndeliveredVolume, --未交數
                                        CASE 
                                            WHEN C.RowNum = 1 THEN C.TotalInventory
                                            ELSE 0
                                        END AS TotalInventory, 
                                        ISNULL(SUM(RD.NumberOfSets - CAST(ROUND(ISNULL(TS.TotalStorage, 0), 0) AS INT)), 0) AS TotalInProgress --在製數
                                    FROM 
                                        CTE C
                                    LEFT JOIN 
                                        RankedData RD
                                        ON C.TD004 = RD.TA006 
                                        AND C.TD005 = RD.TA034
                                    LEFT JOIN 
                                        TotalStorageData TS
                                        ON RD.TA001 = TS.TA001 
                                        AND RD.TA002 = TS.TA002
                                        AND RD.TA006 = TS.TA006
                                    WHERE 
                                        RD.rn = 1 OR RD.rn IS NULL
                                    GROUP BY 
                                        C.TD001, C.TD002, C.TD004, C.TD005, C.MA003, C.TD013, C.TD008, C.TD009, C.RowNum, RD.TA006, RD.TA034, C.TotalInventory
                                                                            ";

                        dynamicParameters.Add("MtlItemNo", MtlItemNo);

                        List<CheckOrderAndProduction> checkOrderAndProductions = sqlConnection2.Query<CheckOrderAndProduction>(sql, dynamicParameters).ToList();

                        int i = 0;
                        foreach (var item in checkOrderAndProductions)
                        {
                            if (i == 0)
                            {
                                if ((item.TotalInventory + item.TotalInProgress) - item.UndeliveredVolume >= 0)
                                {
                                    checkOrderAndProductions[i].ManufacturingOrder = 0;
                                    checkOrderAndProductions[i].ExcessQuantity = Math.Abs((item.TotalInventory + item.TotalInProgress) - item.UndeliveredVolume);
                                }
                                else
                                {
                                    checkOrderAndProductions[i].ManufacturingOrder = Math.Abs((item.TotalInventory + item.TotalInProgress) - item.UndeliveredVolume);
                                    checkOrderAndProductions[i].ExcessQuantity = 0;
                                }
                            }
                            else
                            {
                                if (checkOrderAndProductions[i - 1].ExcessQuantity - item.UndeliveredVolume >= 0)
                                {
                                    checkOrderAndProductions[i].ManufacturingOrder = 0;
                                    checkOrderAndProductions[i].ExcessQuantity = Math.Abs(checkOrderAndProductions[i - 1].ExcessQuantity - item.UndeliveredVolume);
                                }
                                else
                                {
                                    checkOrderAndProductions[i].ManufacturingOrder = Math.Abs(checkOrderAndProductions[i - 1].ExcessQuantity - item.UndeliveredVolume);
                                    checkOrderAndProductions[i].ExcessQuantity = 0;
                                }
                            }
                            i++;
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = checkOrderAndProductions,
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMWEDetailReport 取得庫存明細 GPai 2025-01-07
        public string GetMWEDetailReport(string Company, string TypeOne, string TypeTwo, string MtlItemNo, string StartDate, string FinishDate)
        {
            try
            {
                // if (MtlItemNo.Length <= 0) throw new SystemException("至少需有一個品號條件才能查詢!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (Company == "")
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }
                    else
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyNo = @Company";
                        dynamicParameters.Add("Company", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }
                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {

                        DateTime startD = DateTime.Parse(StartDate);
                        DateTime finishD = DateTime.Parse(FinishDate);
                        string startDate = startD.ToString("yyyyMMdd");
                        string finishDate = finishD.ToString("yyyyMMdd");
                        string startMonth = startD.ToString("yyyyMM");

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT f1.MA002 TypeOneNo,f1.MA003 TypeOneName, f1.MA004, f2.MA002 TypeTwoNo,f2.MA003 TypeTwoName
                                ,b.MB001 MtlItemNo,b.MB002 MtlItemName,b.MB003 MtlItemSpec, b.MB004 UmoNo
                                ,a.MC002 MWENo, d.MC002 MWEName
                                , a.MC007 InventoryQuantity
                                FROM INVMC a
                                INNER JOIN INVMB AS b ON b.MB001=a.MC001  
                                LEFT JOIN INVLC AS c ON  c.LC001=a.MC001 AND c.LC002 = @StartMonth AND c.LC003=a.MC002
                                LEFT  JOIN CMSMC AS d ON  d.MC001=a.MC002 
                                LEFT  JOIN INVLB AS e ON a.MC001= e.LB001 AND e.LB002 = @StartMonth
                                LEFT  JOIN INVMA AS f1 ON (f1.MA001= '1' AND f1.MA002=b.MB005 )
                                LEFT  JOIN INVMA AS f2 ON (f2.MA001= '2' AND f2.MA002=b.MB006 )
                                LEFT  JOIN CMSMF AS i ON MF001= 'NT$'  
                                LEFT  JOIN INVLA AS j ON j.LA001=a.MC001 AND j.LA009=a.MC002
                                WHERE 1=1  
                                AND d.MC004='1' 
                                AND (j.LA004 BETWEEN @StartDate AND @FinishDate)
                                ";

                        dynamicParameters.Add("StartDate", startDate);
                        dynamicParameters.Add("FinishDate", finishDate);
                        dynamicParameters.Add("StartMonth", startMonth);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TypeOne", @" AND b.MB005 = @TypeOne  ", TypeOne);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TypeTwo", @" AND b.MB006 = @TypeTwo   ", TypeTwo);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND  b.MB001= @MtlItemNo  ", MtlItemNo);
                        sql += @"GROUP BY f1.MA002 ,f1.MA003 , f1.MA004,f2.MA002 ,f2.MA003 , f2.MA004, b.MB001 ,b.MB002 ,b.MB003 , b.MB004 ,a.MC002 , d.MC002 , a.MC007
                                 HAVING SUM(j.LA005 * j.LA011) >= 0
                                 ORDER BY  f1.MA002,b.MB001,d.MC002";

                        List<MWEDetailReportDetail> mWEDetailReportDetails = sqlConnection2.Query<MWEDetailReportDetail>(sql, dynamicParameters).ToList();



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = mWEDetailReportDetails,
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoMaterialsReport 取得製令材料再製明細 GPai 2025-01-07
        public string GetMoMaterialsReport(string Company, string MtlItemNo, string MtlItemName, string WoErpFullNo, string WoErpPrefix, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                // if (MtlItemNo.Length <= 0) throw new SystemException("至少需有一個品號條件才能查詢!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (Company == "")
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }
                    else
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyNo = @Company";
                        dynamicParameters.Add("Company", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }
                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {


                        string finishDate = CreateDate.ToString("yyyyMMdd");

                        dynamicParameters = new DynamicParameters();

                        sqlQuery.mainKey = "b.TA001, b.TA002";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", b.TA006, b.TA009, b.TA032
                              , e.MA002, b.TA021, d.MD002, b.TA015, b.TA017, b.TA020, c.MC002, ISNULL((b.TA026+'-'+ b.TA027),'-') AS TA026C
                              , ISNULL((b.TA024+'-'+ b.TA025),'-') AS TA024C, a.TB003, a.TB007, a.TB012, a.TB013, a.TB006, a.TB004, a.TB005
                              , (f.MB057+f.MB058+f.MB059+f.MB060) AS MB060C, g.MF005
                              ,b.TA044, b.TA045, a.TB021, a.TB019, b.TA034, b.TA035, a.TB021, a.TB023, a.TB025, b.TA007, a.TB001, a.TB002 
                              ,CASE 
    WHEN a.TB005 = 0 THEN 0
	WHEN (a.TB004 / b.TA015) > 1 AND i.MD007 is not Null  THEN ROUND(ISNULL((a.TB005 - (b.TA017 * (ISNULL(i.MD006, 1) / NULLIF(ISNULL(i.MD007, 1), 0)))),0),3)
    WHEN (a.TB004 / b.TA015) < 1 THEN a.TB005 - (ROUND(ISNULL((a.TB004 - (a.TB004 - (b.TA017 * (ISNULL(a.TB004, 1) / NULLIF(ISNULL(a.TB004, 1), 0))))), 0),3)*(a.TB004/b.TA015))
    WHEN (a.TB004 / b.TA015) = 1 THEN a.TB005 - (ROUND(ISNULL((a.TB004 - (a.TB004 - (b.TA017 * (ISNULL(a.TB004, 1) / NULLIF(ISNULL(a.TB004, 1), 0))))), 0),3)*(a.TB004/b.TA015))
    WHEN (a.TB004 / b.TA015) > 1 THEN ROUND(ISNULL((a.TB005 - (b.TA017 * (ISNULL(i.MD006, 1) / NULLIF(ISNULL(i.MD007, 1), 0)))),0),3)
    ELSE a.TB005 - (ROUND(ISNULL((a.TB004 - (a.TB004 - (b.TA017 * 
         (ISNULL(a.TB004, 1) / NULLIF(ISNULL(a.TB004, 1), 0))))), 0), 3) * 
         (a.TB004 / b.TA015))
END AS InProcessQty,  -- 在製數量

CASE 
    WHEN a.TB005 = 0 THEN 0
	WHEN (a.TB004 / b.TA015) > 1 AND i.MD007 is not Null  THEN ROUND(ISNULL((a.TB004 - (a.TB004 - (b.TA017 * (ISNULL(i.MD006, 1) / NULLIF(ISNULL(i.MD007, 1), 0))))), 0),3)
    WHEN (a.TB004 / b.TA015) < 1 THEN ROUND(ISNULL((a.TB004 - (a.TB004 - (b.TA017 * (ISNULL(a.TB004, 1) / NULLIF(ISNULL(a.TB004, 1), 0))))), 0),3)*(a.TB004/b.TA015)
    WHEN (a.TB004 / b.TA015) = 1 THEN a.TB005 - (ROUND(ISNULL((a.TB004 - (a.TB004 - (b.TA017 * (ISNULL(a.TB004, 1) / NULLIF(ISNULL(a.TB004, 1), 0))))), 0),3)*(a.TB004/b.TA015))
    WHEN (a.TB004 / b.TA015) > 1 THEN ROUND(ISNULL((a.TB004 - (a.TB004 - (b.TA017 * (ISNULL(i.MD006, 1) / NULLIF(ISNULL(i.MD007, 1), 0))))), 0),3)
    ELSE ROUND(ISNULL((a.TB004 - (a.TB004 - (b.TA017 * 
         (ISNULL(a.TB004, 1) / NULLIF(ISNULL(a.TB004, 1), 0))))), 0), 3) * 
         (a.TB004 / b.TA015)
END AS usedQty         -- 已耗用量
                              , b.TA022, b.TA046, b.TA048";
                        sqlQuery.mainTables =
                          @" FROM MOCTB AS a
                             INNER JOIN MOCTA AS b ON b.TA001 = a.TB001 AND b.TA002 = a.TB002
                             LEFT JOIN CMSMC AS c ON c.MC001 = b.TA020
                             LEFT JOIN CMSMD AS d ON d.MD001 = b.TA021 
                             LEFT JOIN PURMA AS e ON e.MA001 = b.TA032
                             LEFT JOIN INVMB AS f ON f.MB001 = a.TB003
                             LEFT JOIN CMSMF AS g ON g.MF001 = 'NT$' 
                             LEFT JOIN INVMA AS h ON h.MA001 = '1' AND h.MA002 = f.MB005
                             LEFT JOIN BOMMD AS i ON a.TB003 = i.MD003 and b.TA006 = i.MD001";
                        sqlQuery.auxTables = "";
                        sqlQuery.distinct = true;
                        string queryCondition = @" AND 1=1  
                                AND a.TB011 <> '4'  
                                AND (b.TA012 <> '' AND b.TA012 <= @FinishDate) 
                                AND ( (b.TA011 IN ('Y','y') AND b.TA014 > @FinishDate) OR b.TA011 NOT IN ('Y','y') )
                                AND b.TA013 = 'Y'";
                        dynamicParameters.Add("FinishDate", finishDate);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND  b.TA006 = @MtlItemNo  ", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND  b.TA034 = @MtlItemName  ", MtlItemName);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (b.TA001 + '-' + b.TA002 LIKE '%' + @WoErpFullNo + '%')  ", WoErpFullNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpPrefix", @" AND b.TA001 = @WoErpPrefix", WoErpPrefix);
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " b.TA001, b.TA002 DESC";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;
                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);


                        //sql = @"SELECT b.TA001, b.TA002, b.TA006, b.TA009, b.TA032
                        //        , e.MA002, b.TA021, d.MD002, b.TA015, b.TA020, c.MC002, b.TA026+'-'+ b.TA027 AS TA026C
                        //        , b.TA024+'-'+ b.TA025 AS TA024C, a.TB003, a.TB007, a.TB012, a.TB013, a.TB006, a.TB004
                        //        , (f.MB057+f.MB058+f.MB059+f.MB060) AS MB060C, g.MF005
                        //        ,b.TA044, b.TA045, a.TB021, a.TB019, b.TA034, b.TA035, a.TB021, a.TB023, a.TB025, b.TA007, a.TB001, a.TB002 
                        //        FROM MOCTB AS a
                        //        INNER JOIN MOCTA AS b ON b.TA001 = a.TB001 AND b.TA002 = a.TB002
                        //        LEFT JOIN CMSMC AS c ON c.MC001 = b.TA020
                        //        LEFT JOIN CMSMD AS d ON d.MD001 = b.TA021 
                        //        LEFT JOIN PURMA AS e ON e.MA001 = b.TA032
                        //        LEFT JOIN INVMB AS f ON f.MB001 = a.TB003
                        //        LEFT JOIN CMSMF AS g ON g.MF001 = 'NT$' 
                        //        LEFT JOIN INVMA AS h ON h.MA001 = '1' AND h.MA002 = f.MB005
                        //        WHERE 1=1  
                        //        AND a.TB011 <> '4'  
                        //        AND (b.TA012 <> '' AND b.TA012 <= @FinishDate) 
                        //        AND ( (b.TA011 IN ('Y','y') AND b.TA014 > @FinishDate) OR b.TA011 NOT IN ('Y','y') )
                        //        AND b.TA013 = 'Y'";
                        //dynamicParameters.Add("FinishDate", finishDate);
                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND  b.TA006 = @MtlItemNo  ", MtlItemNo);
                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND (b.TA001 + '-' + b.TA002 = @WoErpFullNo)  ", WoErpFullNo);

                        //sql += @" ORDER BY b.TA001, b.TA002, a.TB003 ";

                        //List<MWEDetailReportDetail> mWEDetailReportDetails = sqlConnection2.Query<MWEDetailReportDetail>(sql, dynamicParameters).ToList();



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result,
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetProjectOutCycle 托外進貨週期性報表 --Luca 2025-01-08
        public string GetProjectOutCycle(string Company, string StartReceiptDate, string EndReceiptDate, string ConfirmStatusProjectOutCycle, string CheckoutStatusProjectOutCycle)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (Company == "")
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }
                    else
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyNo = @Company";
                        dynamicParameters.Add("Company", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }



                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"
                        SELECT a.TH003,
                        a.TH001+'-'+a.TH002 AS TH00A,
                        d.MB002,
                        a.TH005,
                        c.MA002,
                        a.TH006,
                        j.NM002,
                        k.TypeName,
                        a.TH014,
                        a.TH033,
                        f.NA003,
                        a.TH009,
                        a.TH007,
                        a.TH008,
                        a.TH019,
                        a.TH021,
                        a.TH022,
                        a.TH034,
                        a.TH027,
                        a.TH020,
                        (a.TH027+a.TH020) AS TH02027,
                        a.TH031,
                        a.TH032,
                        (a.TH031+a.TH032) AS TH03132,
                        b.TI004,
                        b.TI005,
                        b.TI006,
                        b.TI018,
                        e.MC002,
                        b.TI057,
                        b.TI015,
                        ISNULL(i.MW002,'')AS MW002,
                        b.TI007,
                        b.TI019,
                        b.TI011,
                        b.TI016,
                        b.TI017,
                        b.TI012,
                        b.TI021,
                        b.TI022,
                        b.TI020,
                        b.TI050,
                        b.TI051,
                        b.TI049,
                        b.TI008,
                        b.TI023,
                        b.TI028,
                        b.TI024,
                        b.TI026,
                        (b.TI024*TI020*a.TH008) AS TI02420TH008,--計價數量(TI020) × 原幣加工單價(TI024) ± 其他加工費用／扣款
                        (b.TI046+TI047) AS TI04647,--本幣進貨費用 = 原幣加工單價 × 計價數量 × 匯率
                        b.TI044,--原未稅款金額
                        b.TI045,--原幣稅額
                        (b.TI044*TI020+b.TI045)TI0442045,--原幣金額合計
                        b.TI046,--本幣未稅金額
                        b.TI047,--本幣稅額
                        (b.TI046*b.TI020+b.TI047) TI0462047,--本幣金額合計
                        b.TI034,--逾期
                        CASE b.TI035 
                            WHEN '0' THEN N'免檢'
                            WHEN '1' THEN N'待驗'
                            WHEN '2' THEN N'合格'
                            WHEN '3' THEN N'不良'
                            WHEN '4' THEN N'特採'
                            ELSE N'未知狀態'
                        END AS TI035Status,--檢驗狀態
                        b.TI036,--驗退碼
                        b.TI013+'-'+b.TI014 AS TI01314,--製令
                        b.TI040,--備註
                        b.TI010,--批號
                        b.TI048,--急料
                        b.TI038,--結帳
                        h.MC003,--儲存位置
                        b.TI029+'-'+b.TI030 AS TI02930--應付憑單
                        FROM MOCTH a
                        LEFT JOIN MOCTI b ON a.TH001 = b.TI001 AND a.TH002 = b.TI002
                        LEFT JOIN PURMA c ON c.MA001 = a.TH005
                        LEFT JOIN CMSMB d ON d.MB001 = a.TH004
                        LEFT JOIN CMSMC e ON e.MC001 = b.TI009
                        LEFT JOIN CMSNA f ON f.NA002 = a.TH033 AND NA001='1'
                        LEFT JOIN CMSMF g ON g.MF001 = 'NT$'
                        LEFT JOIN INVMC h ON h.MC001 = b.TI004 AND h.MC002 = b.TI009
                        LEFT JOIN CMSMW i ON b.TI015 = i.MW001
                        LEFT JOIN CMSNM j ON j.NM001 = a.TH012
                        INNER JOIN OPENDATASOURCE('SQLOLEDB','Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[Type] k ON k.TypeNo COLLATE Chinese_Taiwan_Stroke_CS_AS =c.MA044 AND k.TypeSchema='Customer.Taxation'
                        WHERE 1=1
                ";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "StartReceiptDate", @" AND a.TH003 >= @StartReceiptDate ", StartReceiptDate);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "EndReceiptDate", @" AND a.TH003 <= @EndReceiptDate ", EndReceiptDate);
                        if (ConfirmStatusProjectOutCycle != "-1") BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ConfirmStatusProjectOutCycle", @" AND a.TH023 LIKE '%' + @ConfirmStatusProjectOutCycle + '%'", ConfirmStatusProjectOutCycle);
                        if (CheckoutStatusProjectOutCycle != "-1") BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "CheckoutStatusProjectOutCycle", @" AND a.TI038 LIKE '%' + @CheckoutStatusProjectOutCycle + '%' ", CheckoutStatusProjectOutCycle);


                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcessMenReport 取得人員製造狀況報表 GPai 2025-01-07
        public string GetProcessMenReport(string MtlItemNo, string MtlItemName, string WoErpFullNo
            , int MachineId, int UserId, int ModeId, int ProcessId, string StartDate, string FinishDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                // if (MtlItemNo.Length <= 0) throw new SystemException("至少需有一個品號條件才能查詢!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {


                        string finishDate = CreateDate.ToString("yyyyMMdd");

                        dynamicParameters = new DynamicParameters();

                        sqlQuery.mainKey = "a.BarcodeProcessId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", i.MtlItemNo, i.MtlItemName
                              , a.BarcodeProcessId, a.ProdStatus, j.StatusName, a.StationQty, a.StartDate, a.FinishDate, a.CycleTime, a.StartUserId, a.FinishUserId
                              , b.BarcodeNo
                              , (d.WoErpPrefix + '-' + d.WoErpNo +  '(' + CONVERT(VARCHAR(10), c.WoSeq) + ')') WoErpFullNo
                              , e.ProcessAlias
                              , (f.UserNo + '-' + f.UserName) StartUser
                              , (g.UserNo + '-' + g.UserName) FinishUser
                              , h.MachineNo, h.MachineName, h.MachineDesc
                              , c.ModeId, e.ProcessId";
                        sqlQuery.mainTables =
                          @" FROM MES.BarcodeProcess a
                             INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                             INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                             INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                             INNER JOIN MES.MoProcess e ON a.MoProcessId = e.MoProcessId
                             INNER JOIN BAS.[User] f ON a.StartUserId = f.UserId
                             INNER JOIN BAS.[User] g ON a.FinishUserId = g.UserId
                             INNER JOIN MES.Machine h ON a.MachineId = h.MachineId
                             INNER JOIN PDM.MtlItem i ON d.MtlItemId = i.MtlItemId
                             INNER JOIN BAS.[Status] j ON j.StatusNo = a.ProdStatus AND j.StatusSchema = 'BarcodeProcess.ProdStatus'";
                        sqlQuery.auxTables = "";
                        // sqlQuery.distinct = true;
                        string queryCondition = @" AND 1=1
                                            AND a.FinishDate IS NOT NULL";
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND i.MtlItemNo = @MtlItemNo  ", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND i.MtlItemName = @MtlItemName  ", MtlItemName);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (d.WoErpPrefix + '-' + d.WoErpNo +  '(' + CONVERT(VARCHAR(10), c.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'  ", WoErpFullNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineId", @" AND h.MachineId = @MachineId  ", MachineId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserId", @" AND f.UserId = @UserId  ", UserId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ModeId", @" AND c.ModeId = @ModeId  ", ModeId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessId", @" AND e.ProcessId = @ProcessId  ", ProcessId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.FinishDate >= @StartDate  ", StartDate);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FinishDate", @" AND a.FinishDate <= @FinishDate  ", FinishDate);

                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.FinishDate DESC";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;
                        var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);
                        

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result,
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetPendingPurchaseRequestReport 已請未採清單 -- Luca 2025-01-15
        public string GetPendingPurchaseRequestReport(string Company)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (Company == "")
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }
                    else
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyNo = @Company";
                        dynamicParameters.Add("Company", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"
                            -- 創建臨時表存儲BPM數據
                            CREATE TABLE #PUR_LIST_BPM (
                                purNo_BPM VARCHAR(20),
                                purNo_MES VARCHAR(20),
                                signName_BPM NVARCHAR(50),
                                signTime_BPM DATETIME,
                                signResult_BPM NVARCHAR(50),
                                signMessage_BPM NVARCHAR(4000),
                                signStatus_BPM NVARCHAR(50),
                                source_version VARCHAR(10)
                            );

                            -- 插入230706版本數據
                            INSERT INTO #PUR_LIST_BPM
                            SELECT 
                                c.ITEM16 AS BPM單號, 
                                c.ITEM126 AS MES單號, 
                                a11.UserName AS 代理人工號, 
                                DATEADD(MS, CONVERT(BIGINT, a.EndTime) % 60000,
                                    DATEADD(MI, CONVERT(BIGINT, a.EndTime) / 60000, '1970-01-01 08:00:00.000')) AS 結束時間,
                                CONCAT(a7.DISPLAY_NAME, 
                                    CASE 
                                        WHEN a.IapSignResult = 'agree' THEN '核准'
                                        WHEN a.IapSignResult = 'disagree' THEN '抽單'
                                        WHEN a.IapSignResult = 'retrieved' THEN '退回'
                                        WHEN a.IapSignResult = 'nocomment' THEN '未審核'
                                    END) AS 簽核結果,
                                CONCAT(a6.NOTE, a.IapSignMessage) AS 簽核意見,
                                CASE 
                                    WHEN a.State = 'complete' THEN '已完成'
                                    WHEN a.State = 'queue' THEN '待關卡人員認領中'
                                    WHEN a.State = 'retrieved' THEN '已抽單'
                                END AS 狀態,
                                '230706' AS source_version
                            FROM BPM.JMO.dbo.Task a
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a1 ON a.MemID = a1.MemID
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a11 ON a.ExeID = a11.MemID
                            LEFT JOIN BPM.JMO.dbo.Iap_GenInf a4 ON a4.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.Pro_GenInf a5 ON a5.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_INS a6 ON a6.TASK_ID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_STATE a7 ON a7.AST_ID = a6.AST_ID
                            LEFT JOIN BPM.JMO.dbo.Task_ArtIns b ON b.TskID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.ART01861688113918500_Ins c ON c.InsID = b.InsID
                            WHERE a.State NOT IN ('running', 'ready')
                            AND c.ITEM16 != ''
                            AND a.TskID >= (
                                SELECT MAX(z.TskID)
                                FROM BPM.JMO.dbo.Task z
                                WHERE z.RootID = a.RootID
                                AND z.ParentID = a.ParentID
                            )
                            AND ((a1.UserName = 'System Administrator' AND CONCAT(a4.Name, a5.Name) = 'EMAIL')
                                OR (a1.UserName != 'System Administrator'));

                            -- 插入230831版本數據
                            INSERT INTO #PUR_LIST_BPM
                            SELECT 
                                c.ITEM16 AS BPM單號, 
                                c.ITEM126 AS MES單號, 
                                a11.UserName AS 代理人工號,
                                DATEADD(MS, CONVERT(BIGINT, a.EndTime) % 60000,
                                    DATEADD(MI, CONVERT(BIGINT, a.EndTime) / 60000, '1970-01-01 08:00:00.000')) AS 結束時間,
                                CONCAT(a7.DISPLAY_NAME, 
                                    CASE 
                                        WHEN a.IapSignResult = 'agree' THEN '核准'
                                        WHEN a.IapSignResult = 'disagree' THEN '抽單'
                                        WHEN a.IapSignResult = 'retrieved' THEN '退回'
                                        WHEN a.IapSignResult = 'nocomment' THEN '未審核'
                                    END) AS 簽核結果,
                                CONCAT(a6.NOTE, a.IapSignMessage) AS 簽核意見,
                                CASE 
                                    WHEN a.State = 'complete' THEN '已完成'
                                    WHEN a.State = 'queue' THEN '待關卡人員認領中'
                                    WHEN a.State = 'retrieved' THEN '已抽單'
                                END AS 狀態,
                                '230831' AS source_version
                            FROM BPM.JMO.dbo.Task a
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a1 ON a.MemID = a1.MemID
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a11 ON a.ExeID = a11.MemID
                            LEFT JOIN BPM.JMO.dbo.Iap_GenInf a4 ON a4.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.Pro_GenInf a5 ON a5.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_INS a6 ON a6.TASK_ID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_STATE a7 ON a7.AST_ID = a6.AST_ID
                            LEFT JOIN BPM.JMO.dbo.Task_ArtIns b ON b.TskID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.ART02081692057679668_Ins c ON c.InsID = b.InsID
                            WHERE a.State NOT IN ('running', 'ready')
                            AND c.ITEM16 != ''
                            AND a.TskID >= (
                                SELECT MAX(z.TskID)
                                FROM BPM.JMO.dbo.Task z
                                WHERE z.RootID = a.RootID
                                AND z.ParentID = a.ParentID
                            )
                            AND ((a1.UserName = 'System Administrator' AND CONCAT(a4.Name, a5.Name) = 'EMAIL')
                                OR (a1.UserName != 'System Administrator'));

                            -- 插入230906版本數據
                            INSERT INTO #PUR_LIST_BPM
                            SELECT 
                                c.ITEM16 AS BPM單號, 
                                c.ITEM126 AS MES單號, 
                                a11.UserName AS 代理人工號,
                                DATEADD(MS, CONVERT(BIGINT, a.EndTime) % 60000,
                                    DATEADD(MI, CONVERT(BIGINT, a.EndTime) / 60000, '1970-01-01 08:00:00.000')) AS 結束時間,
                                CONCAT(a7.DISPLAY_NAME, 
                                    CASE 
                                        WHEN a.IapSignResult = 'agree' THEN '核准'
                                        WHEN a.IapSignResult = 'disagree' THEN '抽單'
                                        WHEN a.IapSignResult = 'retrieved' THEN '退回'
                                        WHEN a.IapSignResult = 'nocomment' THEN '未審核'
                                    END) AS 簽核結果,
                                CONCAT(a6.NOTE, a.IapSignMessage) AS 簽核意見,
                                CASE 
                                    WHEN a.State = 'complete' THEN '已完成'
                                    WHEN a.State = 'queue' THEN '待關卡人員認領中'
                                    WHEN a.State = 'retrieved' THEN '已抽單'
                                END AS 狀態,
                                '230906' AS source_version
                            FROM BPM.JMO.dbo.Task a
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a1 ON a.MemID = a1.MemID
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a11 ON a.ExeID = a11.MemID
                            LEFT JOIN BPM.JMO.dbo.Iap_GenInf a4 ON a4.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.Pro_GenInf a5 ON a5.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_INS a6 ON a6.TASK_ID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_STATE a7 ON a7.AST_ID = a6.AST_ID
                            LEFT JOIN BPM.JMO.dbo.Task_ArtIns b ON b.TskID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.ART02151693372222335_Ins c ON c.InsID = b.InsID
                            WHERE a.State NOT IN ('running', 'ready')
                            AND c.ITEM16 != ''
                            AND a.TskID >= (
                                SELECT MAX(z.TskID)
                                FROM BPM.JMO.dbo.Task z
                                WHERE z.RootID = a.RootID
                                AND z.ParentID = a.ParentID
                            )
                            AND ((a1.UserName = 'System Administrator' AND CONCAT(a4.Name, a5.Name) = 'EMAIL')
                                OR (a1.UserName != 'System Administrator'));

                            -- 插入240319版本數據
                            INSERT INTO #PUR_LIST_BPM
                            SELECT 
                                c.ITEM16 AS BPM單號, 
                                c.ITEM126 AS MES單號, 
                                a11.UserName AS 代理人工號,
                                DATEADD(MS, CONVERT(BIGINT, a.EndTime) % 60000,
                                    DATEADD(MI, CONVERT(BIGINT, a.EndTime) / 60000, '1970-01-01 08:00:00.000')) AS 結束時間,
                                CONCAT(a7.DISPLAY_NAME, 
                                    CASE 
                                        WHEN a.IapSignResult = 'agree' THEN '核准'
                                        WHEN a.IapSignResult = 'disagree' THEN '抽單'
                                        WHEN a.IapSignResult = 'retrieved' THEN '退回'
                                        WHEN a.IapSignResult = 'nocomment' THEN '未審核'
                                    END) AS 簽核結果,
                                CONCAT(a6.NOTE, a.IapSignMessage) AS 簽核意見,
                                CASE 
                                    WHEN a.State = 'complete' THEN '已完成'
                                    WHEN a.State = 'queue' THEN '待關卡人員認領中'
                                    WHEN a.State = 'retrieved' THEN '已抽單'
                                END AS 狀態,
                                '240319' AS source_version
                            FROM BPM.JMO.dbo.Task a
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a1 ON a.MemID = a1.MemID
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a11 ON a.ExeID = a11.MemID
                            LEFT JOIN BPM.JMO.dbo.Iap_GenInf a4 ON a4.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.Pro_GenInf a5 ON a5.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_INS a6 ON a6.TASK_ID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_STATE a7 ON a7.AST_ID = a6.AST_ID
                            LEFT JOIN BPM.JMO.dbo.Task_ArtIns b ON b.TskID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.ART02691709770730012_Ins c ON c.InsID = b.InsID
                            WHERE a.State NOT IN ('running', 'ready')
                            AND c.ITEM16 != ''
                            AND a.TskID >= (
                                SELECT MAX(z.TskID)
                                FROM BPM.JMO.dbo.Task z
                                WHERE z.RootID = a.RootID
                                AND z.ParentID = a.ParentID
                            )
                            AND ((a1.UserName = 'System Administrator' AND CONCAT(a4.Name, a5.Name) = 'EMAIL')
                                OR (a1.UserName != 'System Administrator'));

                            -- 插入250110版本數據
                            INSERT INTO #PUR_LIST_BPM
                            SELECT 
                                c.ITEM16 AS BPM單號, 
                                c.ITEM126 AS MES單號, 
                                a11.UserName AS 代理人工號,
                                DATEADD(MS, CONVERT(BIGINT, a.EndTime) % 60000,
                                    DATEADD(MI, CONVERT(BIGINT, a.EndTime) / 60000, '1970-01-01 08:00:00.000')) AS 結束時間,
                                CONCAT(a7.DISPLAY_NAME, 
                                    CASE 
                                        WHEN a.IapSignResult = 'agree' THEN '核准'
                                        WHEN a.IapSignResult = 'disagree' THEN '抽單'
                                        WHEN a.IapSignResult = 'retrieved' THEN '退回'
                                        WHEN a.IapSignResult = 'nocomment' THEN '未審核'
                                    END) AS 簽核結果,
                                CONCAT(a6.NOTE, a.IapSignMessage) AS 簽核意見,
                                CASE 
                                    WHEN a.State = 'complete' THEN '已完成'
                                    WHEN a.State = 'queue' THEN '待關卡人員認領中'
                                    WHEN a.State = 'retrieved' THEN '已抽單'
                                END AS 狀態,
                                '250110' AS source_version
                            FROM BPM.JMO.dbo.Task a
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a1 ON a.MemID = a1.MemID
                            LEFT JOIN BPM.JMO.dbo.Mem_GenInf a11 ON a.ExeID = a11.MemID
                            LEFT JOIN BPM.JMO.dbo.Iap_GenInf a4 ON a4.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.Pro_GenInf a5 ON a5.ProID = a.ProID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_INS a6 ON a6.TASK_ID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.PRO_SIGN_STATE a7 ON a7.AST_ID = a6.AST_ID
                            LEFT JOIN BPM.JMO.dbo.Task_ArtIns b ON b.TskID = a.TskID
                            LEFT JOIN BPM.JMO.dbo.ART00161720062813064_Ins c ON c.InsID = b.InsID
                            WHERE a.State NOT IN ('running', 'ready')
                            AND c.ITEM16 != ''
                            AND a.TskID >= (
                                SELECT MAX(z.TskID)
                                FROM BPM.JMO.dbo.Task z
                                WHERE z.RootID = a.RootID
                                AND z.ParentID = a.ParentID
                            )
                            AND ((a1.UserName = 'System Administrator' AND CONCAT(a4.Name, a5.Name) = 'EMAIL')
                                OR (a1.UserName != 'System Administrator'));

                            -- 創建EF表數據暫存
                            CREATE TABLE #PUR_LIST_EF (
                                resda001 VARCHAR(20),
                                purNo_ERP VARCHAR(20),
                                purNo_EF VARCHAR(20),
                                signName NVARCHAR(20),
                                signTime DATETIME,
                                signStatus int,
                                signResult int,
                                LinesignStatus int,
                                LinesignResult int
                            );

                            -- 插入EF數據
                            INSERT INTO #PUR_LIST_EF
                            SELECT 
                                v.resda001,
                                SUBSTRING(RIGHT(v.resda031, 21),1,4) + '-' + SUBSTRING(RIGHT(v.resda031, 11),1,11) AS purNo_ERP,
                                v.resda002 AS purNo_EF,
                                y.resak002 AS signName,
                                x.resdd012 AS signTime,
                                v.resda020 AS signStatus,
                                v.resda021 AS signResult,
                                x.resdd014 AS LinesignStatus,
                                x.resdd015 AS LinesignResult
                            FROM EFNETDB.dbo.resda v
                            LEFT JOIN EFNETDB.dbo.resdd x ON v.resda002 = x.resdd002 AND v.resda001 = x.resdd001
                            LEFT JOIN EFNETDB.dbo.resak y ON x.resdd008 = y.resak001
                            WHERE v.resda001 IN ('WEIPUR06', 'WEIAST10')
                            AND x.resdd008 IS NOT NULL
                            AND v.resda020 != 4
                            AND x.resdd015 != 3
                            AND v.resda021 != 3
                            AND x.resdd012 >= (
                                SELECT MAX(z.resdd012)
                                FROM EFNETDB.dbo.resdd z
                                WHERE x.resdd002 = z.resdd002
                                AND x.resdd001 = z.resdd001
                            );

                            -- 主查詢
                            WITH CombinedResults AS (
                                -- 一般請購查詢
                                SELECT 
                                    a.TA003 AS purchase_date,
                                    u.signTime_BPM AS approval_complete_time,
                                    '一般請購' AS document_type,
                                    d.TB001 + '-' + d.TB002 AS purchase_order_no,
                                    d.TB003 AS purchase_seq_no,
                                    a.UDF01 AS mes_no,
                                    a.UDF02 AS bpm_no,
                                    d.TB004 AS item_no,
                                    d.TB005 AS item_name,
                                    d.TB006 AS specification,
                                    d.TB009 AS purchase_qty,
                                    d.TB007 AS unit,
                                    CONVERT(VARCHAR, CONVERT(DATE, d.TB011, 120), 111) AS required_date,
                                    b.ME002 AS request_dept,
                                    e.MV002 AS requester,
                                    d.TB012 AS remarks,
                                    d.TB010 AS vendor_code,
                                    i.MA002 AS vendor_name,
                                    f.MV002 AS purchaser,
                                    g.MC002 AS warehouse_name
                                FROM PURTA a
                                LEFT JOIN CMSME b ON b.ME001 = a.TA004
                                INNER JOIN PURTB d ON a.TA001 + a.TA002 = d.TB001 + d.TB002
                                LEFT JOIN CMSMV e ON e.MV001 = d.CREATOR
                                LEFT JOIN CMSMV f ON f.MV001 = d.TB013
                                LEFT JOIN CMSMC g ON g.MC001 = d.TB008
                                LEFT JOIN PURMA i ON i.MA001 = d.TB010
                                LEFT JOIN #PUR_LIST_BPM u ON u.purNo_BPM = a.UDF02 AND u.purNo_MES = a.UDF01
                                WHERE u.signStatus_BPM IS NOT NULL
                                AND a.TA016 = '3'
                                AND (a.TA007 = 'N' OR d.TB039 = 'N')

                                UNION ALL

                                -- 資產請購查詢
                                SELECT 
                                    a.TI004 AS purchase_date,
                                    ef.signTime AS approval_complete_time,
                                    '資產請購' AS document_type,
                                    b.TJ001 + '-' + b.TJ002 AS purchase_order_no,
                                    b.TJ003 AS purchase_seq_no,
                                    NULL AS mes_no,
                                    NULL AS bpm_no,
                                    NULL AS item_no,
                                    b.TJ004 AS item_name,
                                    b.TJ005 AS specification,
                                    b.TJ007 AS purchase_qty,
                                    b.TJ006 AS unit,
                                    CONVERT(VARCHAR, CONVERT(DATE, b.TJ009, 120), 111) AS required_date,
                                    a1.ME002 AS request_dept,
                                    a2.MV002 AS requester,
                                    b.TJ018 AS remarks,
                                    b.TJ008 AS vendor_code,
                                    b1.MA002 AS vendor_name,
                                    b2.MV002 AS purchaser,
                                    NULL AS warehouse_name
                                FROM ASTTI a
                                LEFT JOIN CMSME a1 ON a1.ME001 = a.TI006
                                LEFT JOIN CMSMV a2 ON a2.MV001 = a.TI007
                                INNER JOIN ASTTJ b ON b.TJ001 + '-' + b.TJ002 = a.TI001 + '-' + a.TI002
                                LEFT JOIN PURMA b1 ON b1.MA001 = b.TJ008
                                LEFT JOIN CMSMV b2 ON b2.MV001 = b.TJ010
                                LEFT JOIN #PUR_LIST_EF ef ON ef.purNo_ERP = b.TJ001 + '-' + b.TJ002 
                                    AND ef.resda001 = 'WEIAST10'
                                WHERE ef.signStatus IS NOT NULL
                                AND a.TI013 = '3'
                                AND (a.TI010 = 'N' OR b.TJ021 = 'N')
                            )
                            SELECT *
                            FROM CombinedResults
                            ORDER BY document_type, purchase_order_no;

                            -- 清理臨時表
                            DROP TABLE #PUR_LIST_BPM;
                            DROP TABLE #PUR_LIST_EF;                       
                                            ";

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetRBPurchaseRequisitionProposal -- 粗胚建議請購报表 -- Jean 2025.01.21
        public string GetRBPurchaseRequisitionProposal(string MtlItemNo, string MtlItemName
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "i.MB001";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @",i.MB001 MtlItemNo,i.MB002 MtlItemName,i.MB003 MtlItemSpec,i.MB004 InventoryUnit
	                            ,i.MB005+T1.MA003 TypeOne,i.MB006+T2.MA003 TypeTwo,i.MB007+T3.MA003 TypeThree,i.MB008+T4.MA003 TypeFour
	                            ,i.MB039 MinReorderQuantity,i.MB040 ReorderMultiplier, CB.MC004 SafetyStockQuantity, CB.MC007 StockQuantity

	                            ,(CASE WHEN (i.MB039+(i.MB040*1)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*1)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*2)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*2)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*3)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*3)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*4)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*4)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*5)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*5)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*6)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*6)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*7)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*7)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*8)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*8)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*9)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*9)-CB.MC007)
		                            WHEN (i.MB039+(i.MB040*10)-CB.MC007)>CB.MC004 THEN (i.MB039+(i.MB040*10)-CB.MC007) 
                                    ELSE 0 
                                    END) RecommendedPurchaseQuantity";
                        sqlQuery.mainTables =
                              @"FROM INVMB i
	                            LEFT JOIN INVMA T1 ON i.MB005=T1.MA002
	                            LEFT JOIN INVMA T2 ON i.MB006=T2.MA002
	                            LEFT JOIN INVMA T3 ON i.MB007=T3.MA002
	                            LEFT JOIN INVMA T4 ON i.MB008=T4.MA002
	                            INNER JOIN (SELECT C.MC001,SUM(C.MC004) MC004,SUM(C.MC007) MC007 
				                            FROM INVMC C
				                            LEFT JOIN INVMB B ON B.MB001=C.MC001				
				                            GROUP BY C.MC001
	                                        ) CB ON CB.MC001=i.MB001";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND i.MB005='101' AND i.MB007='325'";

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND i.MB001 = @MtlItemNo", MtlItemNo);//品號
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND i.MB002 = @MtlItemName ", MtlItemName);//品名


                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "i.MB001";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetRBAnnualProcurementReport -- 年購粗胚明細 -- Jean 2025.01.23
        public string GetRBAnnualProcurementReport(string StartReqDate, string EndReqDate, string ReqName
            , string ReqNo, string ReqDepNo, string ReqUserNo, string SearchKey
            , string AccountingCategoryNo, string WarehouseCategoryNo, string BusinessCategoryNo, string ManagementCategoryNo
            , string PurUserNo, string PurVendorName
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "Q.MQ001,PA.TA002,PB.TB003";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @",PA.TA003 AS ReqDate, rtrim(Q.MQ001)+' '+Q.MQ002 AS ReqName, rtrim(PA.TA001)+'-'+PA.TA002 AS ReqNo
	                            ,(CASE WHEN PA.TA007='Y' THEN N'已確認'
		                               WHEN PA.TA007='N' THEN N'未確認'
		                               WHEN PA.TA007='V' THEN N'作廢' 
                                       END) AS ConfirmationCode
                                , PA.TA014 AS ConfirmationUserNo, ISNULL(CU1.MV002,CA1.MF002) AS ConfirmationUserName
	                            ,PA.TA004 AS ReqDepNo, DP.ME002 AS ReqDepName, PA.TA012 AS ReqUserNo, ISNULL(U1.MV002,U2.MF002) AS ReqUserName, PA.TA006 AS ReqRemark
	                            ,PB.TB003 AS ReqLineNo, PB.TB004 AS MtlItemNo, PB.TB005 AS MtlItemName, PB.TB006 AS MtlItemSpec
	                            ,CONCAT(G2.MB005, ISNULL(G2.MA1,'')) AS AccountingCategoryName,CONCAT(G2.MB006, ISNULL(G2.MA2,'')) AS WarehouseCategoryName
	                            ,CONCAT(G2.MB007, ISNULL(G2.MA3,'')) AS BusinessCategoryName,CONCAT(G2.MB008, ISNULL(G2.MA4,'')) AS ManagementCategoryName
	                            ,PB.TB007 AS ReqUnit, PB.TB009 AS ReqQty
	                            ,PB.TB043 AS ProjectCode, ISNULL(CB.NB002,'') AS ProjectName, PB.TB012 AS ReqLineRemark
	                            ,PA.CREATE_DATE AS ReqCreateDate,PA.CREATOR AS ReqCreateUserNo, ISNULL(U3.MV002,U4.MF002) AS ReqCreateUserName
	                            ,(CASE WHEN PB.TB039='N' THEN N'未結案'
		                            WHEN PB.TB039='Y' THEN N'自動結案'
		                            WHEN PB.TB039='y' THEN N'指定結案' END) AS CaseCloseCode
	                            ,(CASE WHEN PB.TB026='1' THEN N'內含'
		                            WHEN PB.TB026='2' THEN N'外加'
		                            WHEN PB.TB026='3' THEN N'零稅率'
		                            WHEN PB.TB026='4' THEN N'免稅'
		                            WHEN PB.TB026='9' THEN N'不計稅' END) AS TaxType
                                ,PB.TB016 AS CurrencyType, PC.TC006 AS ExchangeRate, PB.TB063 AS BusinessTaxRate
	                            ,PB.TB013 AS PurUserNo,ISNULL(U5.MV002,U6.MF002) AS PurUserName,PB.TB010 AS PurVendorNo, MA.MA002 AS PurVendorName
	                            ,PB.TB014 AS PurQty,PB.TB015 AS PurUnit,PB.TB016 AS PurCurrencyType,PB.TB017 AS PurPrice,PB.TB018 AS PurAmount
	                            ,(CASE WHEN PB.TB026='1' THEN ROUND((PB.TB018/(1+PB.TB063)),2)
		                            WHEN PB.TB026='2' THEN ROUND((PB.TB018*1),2)
		                            WHEN PB.TB026='3' THEN PB.TB018*PC.TC006
		                            WHEN PB.TB026='4' THEN PB.TB018*PC.TC006 ELSE PB.TB018 
                                    END) AS LocalCurrencyUntaxedPurAmount";
                        sqlQuery.mainTables =
                              @"FROM PURTA PA
	                            LEFT JOIN CMSMQ Q ON Q.MQ001=PA.TA001
	                            LEFT JOIN PURTB PB ON PA.TA001=PB.TB001 AND PA.TA002=PB.TB002
	                            
	                            LEFT JOIN CMSMV CU1 ON CU1.MV001=PA.TA014
	                            LEFT JOIN ADMMF CA1 ON CA1.MF001=PA.TA014
	                            LEFT JOIN PURMA MA ON PB.TB010=MA.MA001
	                            LEFT JOIN CMSMV U1 ON PA.TA012=U1.MV001
	                            LEFT JOIN ADMMF U2 ON PA.TA012=U2.MF001
	                            LEFT JOIN CMSME DP ON PA.TA004=DP.ME001
	                            LEFT JOIN CMSMV U3 ON PA.CREATOR=U3.MV001
	                            LEFT JOIN ADMMF U4 ON PA.CREATOR=U4.MF001
	                            LEFT JOIN CMSMV U5 ON PB.TB013=U5.MV001
	                            LEFT JOIN ADMMF U6 ON PB.TB013=U6.MF001
	                            LEFT JOIN PURTD PD ON PD.TD026=PB.TB001 AND PD.TD027=PB.TB002 AND PD.TD028=PB.TB003 AND PD.TD018='Y'
	                            LEFT JOIN PURTC PC ON PC.TC001=PD.TD001 AND PC.TC002=PD.TD002 AND PC.TC014='Y'
	                            LEFT JOIN CMSNB CB ON CB.NB001=PB.TB043
                                LEFT JOIN (SELECT I.TB004,i.MB001,i.MB002,i.MB003,i.MB005,T1.MA003 AS MA1,i.MB006,T2.MA003 AS MA2,i.MB007,T3.MA003 AS MA3,i.MB008,T4.MA003 AS MA4
				                            FROM PURTB I
				                            LEFT JOIN INVMB i ON I.TB004=i.MB001
				                            LEFT JOIN INVMA T1 ON i.MB005=T1.MA002
				                            LEFT JOIN INVMA T2 ON i.MB006=T2.MA002
				                            LEFT JOIN INVMA T3 ON i.MB007=T3.MA002
				                            LEFT JOIN INVMA T4 ON i.MB008=T4.MA002
			                                WHERE TB025='Y'
                                            GROUP BY I.TB004,i.MB001,i.MB002,i.MB003,i.MB005,T1.MA003,i.MB006,T2.MA003,i.MB007,T3.MA003,i.MB008,T4.MA003
			                            ) G2 ON G2.TB004=PB.TB004 ";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND PA.TA007='Y' AND PB.TB025='Y' AND G2.MB005='101' AND G2.MB007='325'
	                                                AND PA.CREATE_DATE >= DATEADD(YEAR,-1,GETDATE())";

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartReqDate", @" AND PA.TA003 >= @StartReqDate ", StartReqDate.Length > 0 ? Convert.ToDateTime(StartReqDate).ToString("yyyyMMdd") : "");//請購日期
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndReqDate", @" AND PA.TA003 <= @EndReqDate ", EndReqDate.Length > 0 ? Convert.ToDateTime(EndReqDate).ToString("yyyyMMdd") : ""); //請購日期                                            
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ReqName", @" AND rtrim(Q.MQ001)+' '+Q.MQ002 = @ReqName ", ReqName);//單據名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ReqNo", @" AND rtrim(PA.TA001)+'-'+PA.TA002 = @ReqNo ", ReqNo);//請購單號
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ReqDepNo", @" AND PA.TA004 = @ReqDepNo ", ReqDepNo);//請購部門
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ReqUserNo", @" AND PA.TA012 = @ReqUserNo ", ReqUserNo);//請購人員                                                     

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SearchKey", @" AND (PB.TB004 LIKE '%' + @SearchKey + '%' OR PB.TB005 LIKE '%' + @SearchKey + '%'OR PB.TB006 LIKE '%' + @SearchKey + '%')", SearchKey);

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "AccountingCategoryNo", @" AND G2.MB005 = @AccountingCategoryNo ", AccountingCategoryNo);//會計分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WarehouseCategoryNo", @" AND G2.MB006 = @WarehouseCategoryNo ", WarehouseCategoryNo);//倉管分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BusinessCategoryNo", @" AND G2.MB007 = @BusinessCategoryNo ", BusinessCategoryNo);//業務分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ManagementCategoryNo", @" AND G2.MB008 = @ManagementCategoryNo ", ManagementCategoryNo);//生管分類名稱

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PurUserNo", @" AND PB.TB013 = @PurUserNo ", PurUserNo);//採購人員
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PurVendorName", @" AND MA.MA002 = @PurVendorName ", PurVendorName);//廠商簡稱




                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "PA.TA003";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetIOTData -- 取得自動化資料表數據 -- GPAI 2025-01-09
        public string GetIOTData(string MachineType , string StartDate, string FinishDate
            , string OrderBy, int PageIndex, int PageSize)
        {

            if (MachineType == "") throw new SystemException("請選擇報表類別!");

            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        using (SqlConnection sqlConnection2 = new SqlConnection(AutomationConnectionStrings))
                        {
                            #region//取得自動化資料庫中的資料
                            dynamicParameters = new DynamicParameters();

                            switch (MachineType)
                            {
                                case "airtight":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MachineSN, a.Operater, a.MfgOrder, a.Process, a.Sup_LotCode, a.Sup_QRCode, a.StepOrder, a.Batch_Start_Time, a.Batch_End_Time
                                          , a.Machine_CT, a.Inspection_CT, a.Alarm_Duration, a.Inspection_StartTime, a.Barcode, a.OK_TrayCode, a.NG_TrayCode, a.Model
                                          , a.Pressure_kpa, a.Leak_Cm3, a.Result, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM AirLeak_RawData a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition1 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition1, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition1, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition1;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc, a.StepOrder DESC";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;

                                    break;
                                case "dispensing":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MachineSN, a.Operater, a.MfgOrder, a.Process, a.Sup_LotCode, a.Sup_QRCode, a.StepOrder, a.Batch_Start_Time, a.Batch_End_Time
                                          , a.Machine_CT, a.Inspection_CT, a.Alarm_Duration, a.Inspection_StartTime, a.Barcode, a.OK_TrayCode, a.NG_TrayCode, a.Model
                                          , a.Glue_g, a.Glue_LotCode, a.Glue_ExpirationTime, a.UV_s, a.UV_Illuminance, a.SpareCol, a.Result, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM GlueDispenser_RawData a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition2 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition2, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");
                                    StartDate = Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00");
                                    FinishDate = Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 00:00:00");

                                    sqlQuery.conditions = queryCondition2;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc, a.StepOrder DESC";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "laser":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MachineSN, a.Operater, a.MfgOrder, a.Process, a.Sup_LotCode, a.Sup_QRCode, a.StepOrder, a.Batch_Start_Time, a.Batch_End_Time
                                          , a.Machine_CT, a.Inspection_CT, a.Alarm_Duration, a.Inspection_StartTime, a.Barcode, a.OK_TrayCode, a.NG_TrayCode, a.Model
                                          , a.Laser_Size, a.Laser_Class, a.Result, a.RecordTime, a.SpareCol";
                                    sqlQuery.mainTables =
                                        @"FROM LaserEngraving_RawData a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition3 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition3, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition3, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition3;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc, a.StepOrder DESC";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "height":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MachineSN, a.Operater, a.MfgOrder, a.Process, a.Sup_LotCode, a.Sub_QRCode, a.StepOrder, a.Batch_Start_Time, a.Batch_End_Time
                                          , a.MachineCT, a.Inspection_CT, a.Alarm_Duration, a.Inspection_StartTime, a.Barcode, a.SpareCol, a.Model
                                          , a.L1_Max_Value, a.L1_Min_Value, a.Measurement_Value, a.Result, a.DelayTime, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM HeightTest_RawData a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition4 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition4, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition4, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition4;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc, a.StepOrder DESC";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "MTF":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", ISNULL(NULLIF(MeasurementSN, '--'), '') AS MeasurementSN,
                                            ISNULL(NULLIF(MachineSN, '--'), '') AS MachineSN,
                                            ISNULL(NULLIF(Operater, '--'), '') AS Operater,
                                            ISNULL(NULLIF(MfgOrder, '--'), '') AS MfgOrder,
                                            ISNULL(NULLIF(Process, '--'), '') AS Process,
                                            ISNULL(NULLIF(Sup_LotCode, '--'), '') AS Sup_LotCode,
                                            ISNULL(NULLIF(Sup_QRCode, '--'), '') AS Sup_QRCode,
                                            ISNULL(NULLIF(MTF_TraySN, '--'), '') AS MTF_TraySN,
                                            ISNULL(NULLIF(ProductSN, '--'), '') AS ProductSN,
                                            ISNULL(NULLIF(Location_X, '--'), '') AS Location_X,
                                            ISNULL(NULLIF(Location_Y, '--'), '') AS Location_Y,
                                            ISNULL(NULLIF(Class, '--'), '') AS Class,
                                            ISNULL(NULLIF(CheckFreq, '--'), '') AS CheckFreq,
                                            ISNULL(NULLIF(FBL, '--'), '') AS FBL,
                                            ISNULL(NULLIF(DOF_Index, '--'), '') AS DOF_Index,
                                            ISNULL(NULLIF(DOF_minus, '--'), '') AS DOF_minus,
                                            ISNULL(NULLIF(DOF_plus, '--'), '') AS DOF_plus,
                                            ISNULL(NULLIF(DOF_T, '--'), '') AS DOF_T,
                                            ISNULL(NULLIF(GDOF_Index, '--'), '') AS GDOF_Index,
                                            ISNULL(NULLIF(GDOF_minus, '--'), '') AS GDOF_minus,
                                            ISNULL(NULLIF(GDOF_plus, '--'), '') AS GDOF_plus,
                                            ISNULL(NULLIF(GDOF_T, '--'), '') AS GDOF_T,
                                            ISNULL(NULLIF(EFL, '--'), '') AS EFL,
                                            ISNULL(NULLIF(W_1S, '--'), '') AS W_1S,
                                            ISNULL(NULLIF(W_1T, '--'), '') AS W_1T,
                                            ISNULL(NULLIF(W_2S, '--'), '') AS W_2S,
                                            ISNULL(NULLIF(W_2T, '--'), '') AS W_2T,
                                            ISNULL(NULLIF(W_3S, '--'), '') AS W_3S,
                                            ISNULL(NULLIF(W_3T, '--'), '') AS W_3T,
                                            ISNULL(NULLIF(W_4S, '--'), '') AS W_4S,
                                            ISNULL(NULLIF(W_4T, '--'), '') AS W_4T,
                                            ISNULL(NULLIF(W_5S, '--'), '') AS W_5S,
                                            ISNULL(NULLIF(W_5T, '--'), '') AS W_5T,
                                            ISNULL(NULLIF(W_6S, '--'), '') AS W_6S,
                                            ISNULL(NULLIF(W_6T, '--'), '') AS W_6T,
                                            ISNULL(NULLIF(W_7S, '--'), '') AS W_7S,
                                            ISNULL(NULLIF(W_7T, '--'), '') AS W_7T,
                                            ISNULL(NULLIF(W_8S, '--'), '') AS W_8S,
                                            ISNULL(NULLIF(W_8T, '--'), '') AS W_8T,
                                            ISNULL(NULLIF(W_9S, '--'), '') AS W_9S,
                                            ISNULL(NULLIF(W_9T, '--'), '') AS W_9T,
                                            ISNULL(NULLIF(W_10S, '--'), '') AS W_10S,
                                            ISNULL(NULLIF(W_10T, '--'), '') AS W_10T,
                                            ISNULL(NULLIF(W_11S, '--'), '') AS W_11S,
                                            ISNULL(NULLIF(W_11T, '--'), '') AS W_11T,
                                            ISNULL(NULLIF(W_12S, '--'), '') AS W_12S,
                                            ISNULL(NULLIF(W_12T, '--'), '') AS W_12T,
                                            ISNULL(NULLIF(W_13S, '--'), '') AS W_13S,
                                            ISNULL(NULLIF(W_13T, '--'), '') AS W_13T,
                                            ISNULL(NULLIF(W_14S, '--'), '') AS W_14S,
                                            ISNULL(NULLIF(W_14T, '--'), '') AS W_14T,
                                            ISNULL(NULLIF(W_15S, '--'), '') AS W_15S,
                                            ISNULL(NULLIF(W_15T, '--'), '') AS W_15T,
                                            ISNULL(NULLIF(W_16S, '--'), '') AS W_16S,
                                            ISNULL(NULLIF(W_16T, '--'), '') AS W_16T,
                                            ISNULL(NULLIF(W_17S, '--'), '') AS W_17S,
                                            ISNULL(NULLIF(W_17T, '--'), '') AS W_17T,
                                            ISNULL(NULLIF(W1S_Peak, '--'), '') AS W1S_Peak,
                                            ISNULL(NULLIF(W1T_Peak, '--'), '') AS W1T_Peak,
                                            ISNULL(NULLIF(W2S_Peak, '--'), '') AS W2S_Peak,
                                            ISNULL(NULLIF(W2T_Peak, '--'), '') AS W2T_Peak,
                                            ISNULL(NULLIF(W3S_Peak, '--'), '') AS W3S_Peak,
                                            ISNULL(NULLIF(W3T_Peak, '--'), '') AS W3T_Peak,
                                            ISNULL(NULLIF(W4S_Peak, '--'), '') AS W4S_Peak,
                                            ISNULL(NULLIF(W4T_Peak, '--'), '') AS W4T_Peak,
                                            ISNULL(NULLIF(W5S_Peak, '--'), '') AS W5S_Peak,
                                            ISNULL(NULLIF(W5T_Peak, '--'), '') AS W5T_Peak,
                                            ISNULL(NULLIF(W6S_Peak, '--'), '') AS W6S_Peak,
                                            ISNULL(NULLIF(W6T_Peak, '--'), '') AS W6T_Peak,
                                            ISNULL(NULLIF(W7S_Peak, '--'), '') AS W7S_Peak,
                                            ISNULL(NULLIF(W7T_Peak, '--'), '') AS W7T_Peak,
                                            ISNULL(NULLIF(W8S_Peak, '--'), '') AS W8S_Peak,
                                            ISNULL(NULLIF(W8T_Peak, '--'), '') AS W8T_Peak,
                                            ISNULL(NULLIF(W9S_Peak, '--'), '') AS W9S_Peak,
                                            ISNULL(NULLIF(W9T_Peak, '--'), '') AS W9T_Peak,
                                            ISNULL(NULLIF(W10S_Peak, '--'), '') AS W10S_Peak,
                                            ISNULL(NULLIF(W10T_Peak, '--'), '') AS W10T_Peak,
                                            ISNULL(NULLIF(W11S_Peak, '--'), '') AS W11S_Peak,
                                            ISNULL(NULLIF(W11T_Peak, '--'), '') AS W11T_Peak,
                                            ISNULL(NULLIF(W12S_Peak, '--'), '') AS W12S_Peak,
                                            ISNULL(NULLIF(W12T_Peak, '--'), '') AS W12T_Peak,
                                            ISNULL(NULLIF(W13S_Peak, '--'), '') AS W13S_Peak,
                                            ISNULL(NULLIF(W13T_Peak, '--'), '') AS W13T_Peak,
                                            ISNULL(NULLIF(W14S_Peak, '--'), '') AS W14S_Peak,
                                            ISNULL(NULLIF(W14T_Peak, '--'), '') AS W14T_Peak,
                                            ISNULL(NULLIF(W15S_Peak, '--'), '') AS W15S_Peak,
                                            ISNULL(NULLIF(W15T_Peak, '--'), '') AS W15T_Peak,
                                            ISNULL(NULLIF(W16S_Peak, '--'), '') AS W16S_Peak,
                                            ISNULL(NULLIF(W16T_Peak, '--'), '') AS W16T_Peak,
                                            ISNULL(NULLIF(W17S_Peak, '--'), '') AS W17S_Peak,
                                            ISNULL(NULLIF(W17T_Peak, '--'), '') AS W17T_Peak,
                                            ISNULL(NULLIF(Date_Time, '--'), '') AS Date_Time,
                                            RecordTime,
                                            ISNULL(NULLIF(Spare_Col, '--'), '') AS Spare_Col";
                                    sqlQuery.mainTables =
                                        @"FROM AutoMTF_RawData a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition5 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition5, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition5, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition5;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc, a.RecordTime DESC";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "molding":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.Measurement_SN, a.HoleSN, a.Model, a.Thickness_Value, a.THK_Result, a.OutsideDiameter_Value, a.OD_Result, a.Operator, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM Molding_Measure_Machine a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition6 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition6, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition6, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition6;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "MTF_RawData#1":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MeasurementSN, a.MachineSN, a.Location_X, a.Location_Y, a.Class, a.CheckFreq, a.FBL,
                                            a.DOF_Index, a.DOF_minus, a.DOF_plus, a.DOF_T, a.GDOF_Index, a.GDOF_minus, a.GDOF_plus, a.GDOF_T,
                                            a.EFL, a.W_1S, a.W_1T, a.W_2S, a.W_2T, a.W_3S, a.W_3T, a.W_4S,
                                            a.W_4T, a.W_5S, a.W_5T, a.W_6S, a.W_6T, a.W_7S, a.W_7T, a.W_8S,
                                            a.W_8T, a.W_9S, a.W_9T, a.W_10S, a.W_10T, a.W_11S, a.W_11T, a.W_12S,
                                            a.W_12T, a.W_13S, a.W_13T, a.W_14S, a.W_14T, a.W_15S, a.W_15T, a.W_16S,
                                            a.W_16T, a.W_17S, a.W_17T, a.MTF_DateTime, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM MTF_RawData#1 a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition7 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition7, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition7, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition7;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "MTF_RawData#2":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MeasurementSN, a.MachineSN, a.Location_X, a.Location_Y, a.Class, a.CheckFreq, a.FBL,
                                            a.DOF_Index, a.DOF_minus, a.DOF_plus, a.DOF_T, a.GDOF_Index, a.GDOF_minus, a.GDOF_plus, a.GDOF_T,
                                            a.EFL, a.W_1S, a.W_1T, a.W_2S, a.W_2T, a.W_3S, a.W_3T, a.W_4S,
                                            a.W_4T, a.W_5S, a.W_5T, a.W_6S, a.W_6T, a.W_7S, a.W_7T, a.W_8S,
                                            a.W_8T, a.W_9S, a.W_9T, a.W_10S, a.W_10T, a.W_11S, a.W_11T, a.W_12S,
                                            a.W_12T, a.W_13S, a.W_13T, a.W_14S, a.W_14T, a.W_15S, a.W_15T, a.W_16S,
                                            a.W_16T, a.W_17S, a.W_17T, a.MTF_DateTime, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM MTF_RawData#2 a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition8 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition8, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition8, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition8;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "MTF_RawData#3":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MeasurementSN, a.MachineSN, a.Location_X, a.Location_Y, a.Class, a.CheckFreq, a.FBL,
                                            a.DOF_Index, a.DOF_minus, a.DOF_plus, a.DOF_T, a.GDOF_Index, a.GDOF_minus, a.GDOF_plus, a.GDOF_T,
                                            a.EFL, a.W_1S, a.W_1T, a.W_2S, a.W_2T, a.W_3S, a.W_3T, a.W_4S,
                                            a.W_4T, a.W_5S, a.W_5T, a.W_6S, a.W_6T, a.W_7S, a.W_7T, a.W_8S,
                                            a.W_8T, a.W_9S, a.W_9T, a.W_10S, a.W_10T, a.W_11S, a.W_11T, a.W_12S,
                                            a.W_12T, a.W_13S, a.W_13T, a.W_14S, a.W_14T, a.W_15S, a.W_15T, a.W_16S,
                                            a.W_16T, a.W_17S, a.W_17T, a.MTF_DateTime, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM MTF_RawData#3 a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition9 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition9, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition9, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition9;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "MTF_RawData#4":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MeasurementSN, a.MachineSN, a.Location_X, a.Location_Y, a.Class, a.CheckFreq, a.FBL,
                                            a.DOF_Index, a.DOF_minus, a.DOF_plus, a.DOF_T, a.GDOF_Index, a.GDOF_minus, a.GDOF_plus, a.GDOF_T,
                                            a.EFL, a.W_1S, a.W_1T, a.W_2S, a.W_2T, a.W_3S, a.W_3T, a.W_4S,
                                            a.W_4T, a.W_5S, a.W_5T, a.W_6S, a.W_6T, a.W_7S, a.W_7T, a.W_8S,
                                            a.W_8T, a.W_9S, a.W_9T, a.W_10S, a.W_10T, a.W_11S, a.W_11T, a.W_12S,
                                            a.W_12T, a.W_13S, a.W_13T, a.W_14S, a.W_14T, a.W_15S, a.W_15T, a.W_16S,
                                            a.W_16T, a.W_17S, a.W_17T, a.MTF_DateTime, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM MTF_RawData#4 a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition10 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition10, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition10, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition10;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;
                                case "MTF_RawData#5":
                                    sqlQuery.mainKey = "a.ID";
                                    sqlQuery.auxKey = "";
                                    sqlQuery.columns =
                                        @", a.MeasurementSN, a.MachineSN, a.Location_X, a.Location_Y, a.Class, a.CheckFreq, a.FBL,
                                            a.DOF_Index, a.DOF_minus, a.DOF_plus, a.DOF_T, a.GDOF_Index, a.GDOF_minus, a.GDOF_plus, a.GDOF_T,
                                            a.EFL, a.W_1S, a.W_1T, a.W_2S, a.W_2T, a.W_3S, a.W_3T, a.W_4S,
                                            a.W_4T, a.W_5S, a.W_5T, a.W_6S, a.W_6T, a.W_7S, a.W_7T, a.W_8S,
                                            a.W_8T, a.W_9S, a.W_9T, a.W_10S, a.W_10T, a.W_11S, a.W_11T, a.W_12S,
                                            a.W_12T, a.W_13S, a.W_13T, a.W_14S, a.W_14T, a.W_15S, a.W_15T, a.W_16S,
                                            a.W_16T, a.W_17S, a.W_17T, a.MTF_DateTime, a.RecordTime";
                                    sqlQuery.mainTables =
                                        @"FROM MTF_RawData#5 a ";
                                    sqlQuery.auxTables = "";
                                    string queryCondition11 = @" AND 1=1";

                                    BaseHelper.SqlParameter(ref queryCondition11, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                    BaseHelper.SqlParameter(ref queryCondition11, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                    sqlQuery.conditions = queryCondition11;
                                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                                    sqlQuery.pageIndex = PageIndex;
                                    sqlQuery.pageSize = PageSize;
                                    break;

                                case "C90_Log":

                                    using (SqlConnection sqlConnection3 = new SqlConnection(ETGAutomationConnectionStrings))
                                    {
                                        sqlQuery.mainKey = "a.ID";
                                        sqlQuery.auxKey = "";
                                        sqlQuery.columns =
                                            @", a.日期時間, a.流程卡號, a.QR_Code, a.前後蓋, a.螺絲, a.QR_Code版本
                                          , a.QR_Code週別, a.QR_Code重複, a.Dcut_Result, a.結果, a.RecordTime";
                                        sqlQuery.mainTables =
                                            @"FROM C90_Log a ";
                                        sqlQuery.auxTables = "";
                                        string queryCondition12 = @" AND 1=1";

                                        BaseHelper.SqlParameter(ref queryCondition12, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                                        BaseHelper.SqlParameter(ref queryCondition12, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                                        sqlQuery.conditions = queryCondition12;
                                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                                        sqlQuery.pageIndex = PageIndex;
                                        sqlQuery.pageSize = PageSize;


                                    }
                                    break;
                                default:
                                    break;
                            }
                            //var result = sqlConnection2.Query(sql, dynamicParameters);
                            var AutomationResult = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                            if (AutomationResult.Count() == 0) throw new SystemException("【自動化】查無IOT資訊!");
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                data = AutomationResult
                            });
                            #endregion

                        }

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetIOTData2 -- 取得自動化資料表數據-C90 -- GPAI 2025-01-09
        public string GetIOTData2(string MachineType, string StartDate, string FinishDate
            , string OrderBy, int PageIndex, int PageSize)
        {

            if (MachineType == "") throw new SystemException("請選擇報表類別!");

            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        using (SqlConnection sqlConnection2 = new SqlConnection(ETGAutomationConnectionStrings2))
                        {
                            #region//取得自動化資料庫中的資料
                            dynamicParameters = new DynamicParameters();

                            sqlQuery.mainKey = "a.ID";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.日期時間, a.流程卡號, a.QR_Code, a.前後蓋, a.螺絲, a.QR_Code版本
                                          , a.QR_Code週別, a.QR_Code重複, a.Dcut_Result, a.結果, a.RecordTime";
                            sqlQuery.mainTables =
                                @"FROM C90_Log a ";
                            sqlQuery.auxTables = "";
                            string queryCondition12 = @" AND 1=1";

                            BaseHelper.SqlParameter(ref queryCondition12, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                            BaseHelper.SqlParameter(ref queryCondition12, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                            sqlQuery.conditions = queryCondition12;
                            sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                            sqlQuery.pageIndex = PageIndex;
                            sqlQuery.pageSize = PageSize;

                            //var result = sqlConnection2.Query(sql, dynamicParameters);
                            var AutomationResult = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                            if (AutomationResult.Count() == 0) throw new SystemException("【自動化】查無IOT資訊!");
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                data = AutomationResult
                            });
                            #endregion

                        }

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetIOTData3 -- 取得自動化資料表數據-紘立MTF -- GPAI 2025-01-09
        public string GetIOTData3(string MachineType, string StartDate, string FinishDate
            , string OrderBy, int PageIndex, int PageSize)
        {

            if (MachineType == "") throw new SystemException("請選擇報表類別!");

            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        using (SqlConnection sqlConnection2 = new SqlConnection(AutomationConnectionStrings))
                        {
                            #region//取得自動化資料庫中的資料
                            dynamicParameters = new DynamicParameters();

                            sqlQuery.mainKey = "a.ID";
                            sqlQuery.auxKey = "";
                            sqlQuery.columns =
                                @", a.MeasurementSN, a.MachineSN, a.Operater, a.MfgOrder, a.Process, a.Sup_LotCode, a.Sup_QRCode, a.MTF_TraySN, a.ProductSN
                                  , a.Location_X, a.Location_Y, a.Class, a.CheckFreq, a.FBL, a.DOF_Index, a.DOF_minus, a.DOF_plus, a.DOF_T, a.GDOF_Index
                                  , a.GDOF_minus, a.GDOF_plus, a.GDOF_T, a.EFL, a.W_1S, a.W_1T, a.W_2S, a.W_2T, a.W_3S, a.W_3T
                                  , a.W_4S, a.W_4T, a.W_5S, a.W_5T, a.W_6S, a.W_6T, a.W_7S, a.W_7T, a.W_8S, a.W_8T
                                  , a.W_9S, a.W_9T, a.W_10S, a.W_10T, a.W_11S, a.W_11T, a.W_12S, a.W_12T, a.W_13S, a.W_13T
                                  , a.W_14S, a.W_14T, a.W_15S, a.W_15T, a.W_16S, a.W_16T, a.W_17S, a.W_17T, a.W1S_Peak, a.W1T_Peak
                                  , a.W2S_Peak, a.W2T_Peak, a.W3S_Peak, a.W3T_Peak, a.W4S_Peak, a.W4T_Peak, a.W5S_Peak, a.W5T_Peak, a.W6S_Peak, a.W6T_Peak
                                  , a.W7S_Peak, a.W7T_Peak, a.W8S_Peak, a.W8T_Peak, a.W9S_Peak, a.W9T_Peak, a.W10S_Peak, a.W10T_Peak, a.W11S_Peak, a.W11T_Peak
                                  , a.W12S_Peak, a.W12T_Peak, a.W13S_Peak, a.W13T_Peak, a.W14S_Peak, a.W14T_Peak, a.W15S_Peak, a.W15T_Peak, a.W16S_Peak, a.W16T_Peak
                                  , a.W17S_Peak, a.W17T_Peak, a.MTF_DateTime, a.RecordTime, a.Spare_Col";
                            sqlQuery.mainTables =
                                $@"FROM [{MachineType}] a";
                            sqlQuery.auxTables = "";
                            string queryCondition12 = @" AND 1=1";

                            BaseHelper.SqlParameter(ref queryCondition12, ref dynamicParameters, "StartDate", @" AND a.RecordTime >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                            BaseHelper.SqlParameter(ref queryCondition12, ref dynamicParameters, "FinishDate", @" AND a.RecordTime <= @FinishDate", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                            sqlQuery.conditions = queryCondition12;
                            sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.ID desc";
                            sqlQuery.pageIndex = PageIndex;
                            sqlQuery.pageSize = PageSize;

                            //var result = sqlConnection2.Query(sql, dynamicParameters);
                            var AutomationResult = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                            if (AutomationResult.Count() == 0) throw new SystemException("【自動化】查無IOT資訊!");
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                data = AutomationResult
                            });
                            #endregion

                        }

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetDepProfitLossStatement -- 成本趋势分析报表 -- Jean 2025.02.24
        public string GetDepProfitLossStatement(string Department, string FiscalYear
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<CostResult> CostResult = new List<CostResult>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "i.MB001";
                        sqlQuery.auxKey = "";
                        sql = @"
                                WITH MonthlyClassification AS (
                                    SELECT 
                                        x.CrateMonth,
                                        SUM(x.balanceAmount) sumbalanceAmount,
                                        x.classification
                                    FROM (
                                        SELECT DISTINCT 
                                            b.TB005 tb005,
                                            c.MA003 ma003,
                                            a.TA003 ta003,
                                            b.TB001 + '-' + b.TB002 + '-' + b.TB003 summonsNum,
                                            b.TB010 tb010,
                                            CAST((CASE WHEN b.TB004 = '-1' THEN 0 WHEN b.TB004 = '1' THEN b.TB015 END) AS DECIMAL(10, 2)) AS debitAmount,
                                            CAST((CASE WHEN b.TB004 = '1' THEN 0 WHEN b.TB004 = '-1' THEN b.TB015 END) AS DECIMAL(10, 2)) AS creditAmount,
                                            CAST((CASE WHEN b.TB004 = '-1' THEN 0 WHEN b.TB004 = '1' THEN b.TB015 END) AS DECIMAL(10, 2)) - 
                                            CAST((CASE WHEN b.TB004 = '1' THEN 0 WHEN b.TB004 = '-1' THEN b.TB015 END) AS DECIMAL(10, 2)) AS balanceAmount,
                                            b.TB006 tb006,
                                            d.ME002 me002,
                                            (CASE 
                                                WHEN b.TB005 IN ('700101', '700102', '710101', '710102', '700103' , '700104') THEN N'变-薪资支出'
                                                WHEN b.TB005 IN ('710103', '710104', '710105', '710108',  '710122', '710124', '710125', '710126') THEN N'变-制造人员福利'
                                                WHEN b.TB005 IN ('710120') THEN N'固-厂房租金'
                                                WHEN b.TB005 IN ('710115', '710117', '710123') THEN N'固-生产设备折旧'
                                                WHEN b.TB005 IN ('710112', '710114') THEN N'变-包装和耗材'
                                                WHEN b.TB005 IN ('710119') THEN N'变-能源消耗'
                                                WHEN b.TB005 IN ('710106', '710107', '710109', '710110', '710111', '710113', '710118', '710121') THEN N'变-其他成本'
                                                WHEN b.TB005 IN ('710116') THEN N'变-物料消耗'
                                            END) AS classification,
                                            LEFT(a.TA003, 6) CrateMonth
                                        FROM ACTTA a
                                        LEFT JOIN ACTTB b ON a.TA002 = b.TB002
                                        INNER JOIN ACTMA c ON b.TB005 = c.MA001
                                        INNER JOIN CMSME d ON d.ME001 = b.TB006
                                        WHERE b.TB005 >= '700101' AND b.TB005 <= '710127' 
                                                AND b.TB005 NOT IN('700105','700106','700107','700108','700109','710127')
                                                AND a.TA010 != 'V'
                                                AND a.TA006 != 'E'";
                        sql += @" AND b.TB006 IN(" + Department + ")";
                        sql += @" ) x
                                    GROUP BY 
                                        x.CrateMonth, x.classification
                                ),
                                GrandTotal AS (
                                    SELECT 
                                        m.classification,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '01' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Jan,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '02' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Feb,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '03' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Mar,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '04' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Apr,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '05' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS May,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '06' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Jun,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '07' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Jul,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '08' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Aug,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '09' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Sept,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '10' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Oct,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '11' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Nov,
                                        SUM(CASE WHEN m.CrateMonth = LEFT(m.CrateMonth, 4) + '12' THEN CAST(ROUND(m.sumbalanceAmount, 0) AS INT) ELSE 0 END) AS Dec,
                                        SUM(CAST(ROUND(m.sumbalanceAmount, 0) AS INT)) AS Total,
                                        CAST(SUM(m.sumbalanceAmount) * 1.0 / (SELECT SUM(sumbalanceAmount) FROM MonthlyClassification) * 100 AS DECIMAL(5, 2)) AS proportion
                                    FROM  MonthlyClassification m
                                    WHERE LEFT(m.CrateMonth, 4) = @FiscalYear
                                    GROUP BY m.classification
                                )

                               SELECT * FROM GrandTotal

                                UNION ALL

                                SELECT 
                                    N'总计',SUM(Jan),SUM(Feb),SUM(Mar),SUM(Apr),SUM(May),SUM(Jun),SUM(Jul),SUM(Aug),SUM(Sept),SUM(Oct),SUM(Nov),SUM(Dec),SUM(Total),SUM(proportion)
                                FROM GrandTotal

                                UNION ALL
                                SELECT 
                                    N'变动占比',SUM(Jan),SUM(Feb),SUM(Mar),SUM(Apr),SUM(May),SUM(Jun),SUM(Jul),SUM(Aug),SUM(Sept),SUM(Oct),SUM(Nov),SUM(Dec),SUM(Total),SUM(proportion)
                                FROM GrandTotal
                                WHERE LEFT(classification,1)=N'变'

                                UNION ALL
                                SELECT 
                                    N'固定占比',SUM(Jan),SUM(Feb),SUM(Mar),SUM(Apr),SUM(May),SUM(Jun),SUM(Jul),SUM(Aug),SUM(Sept),SUM(Oct),SUM(Nov),SUM(Dec),SUM(Total),SUM(proportion)
                                FROM GrandTotal
                                WHERE LEFT(classification,1)=N'固'";

                        dynamicParameters.Add("Department", Department);
                        dynamicParameters.Add("FiscalYear", FiscalYear);

                        //var result = sqlConnection2.Query(sql, dynamicParameters);
                        CostResult = sqlConnection2.Query<CostResult>(sql, dynamicParameters).ToList();

                        // 找到总计行和固定占比行/变动占比行
                        // 找到总计行和固定占比行/变动占比行
                        var totalRow = CostResult.FirstOrDefault(item => item.classification == "总计");
                        var variableRatioRow = CostResult.FirstOrDefault(item => item.classification == "变动占比");
                        var fixedRatioRow = CostResult.FirstOrDefault(item => item.classification == "固定占比");

                        CostResult newVariableRow = null;
                        if (totalRow != null && variableRatioRow != null)
                        {
                            string Variableclassification = "变动%";
                            decimal VariableShareJan = totalRow.Jan != 0 ? variableRatioRow.Jan / (decimal)totalRow.Jan * 100 : 0;
                            decimal VariableShareFeb = totalRow.Feb != 0 ? variableRatioRow.Feb / (decimal)totalRow.Feb * 100 : 0;
                            decimal VariableShareMar = totalRow.Mar != 0 ? variableRatioRow.Mar / (decimal)totalRow.Mar * 100 : 0;
                            decimal VariableShareApr = totalRow.Apr != 0 ? variableRatioRow.Apr / (decimal)totalRow.Apr * 100 : 0;
                            decimal VariableShareMay = totalRow.May != 0 ? variableRatioRow.May / (decimal)totalRow.May * 100 : 0;
                            decimal VariableShareJun = totalRow.Jun != 0 ? variableRatioRow.Jun / (decimal)totalRow.Jun * 100 : 0;
                            decimal VariableShareJul = totalRow.Jul != 0 ? variableRatioRow.Jul / (decimal)totalRow.Jul * 100 : 0;
                            decimal VariableShareAug = totalRow.Aug != 0 ? variableRatioRow.Aug / (decimal)totalRow.Aug * 100 : 0;
                            decimal VariableShareSept = totalRow.Sept != 0 ? variableRatioRow.Sept / (decimal)totalRow.Sept * 100 : 0;
                            decimal VariableShareOct = totalRow.Oct != 0 ? variableRatioRow.Oct / (decimal)totalRow.Oct * 100 : 0;
                            decimal VariableShareNov = totalRow.Nov != 0 ? variableRatioRow.Nov / (decimal)totalRow.Nov * 100 : 0;
                            decimal VariableShareDec = totalRow.Dec != 0 ? variableRatioRow.Dec / (decimal)totalRow.Dec * 100 : 0;
                            decimal VariableShareTotal = totalRow.Total != 0 ? variableRatioRow.Total / (decimal)totalRow.Total * 100 : 0;
                            decimal VariableShareProportion = 0;

                            newVariableRow = new CostResult
                            {
                                classification = Variableclassification,
                                Jan = Math.Round(VariableShareJan, 2),
                                Feb = Math.Round(VariableShareFeb, 2),
                                Mar = Math.Round(VariableShareMar, 2),
                                Apr = Math.Round(VariableShareApr, 2),
                                May = Math.Round(VariableShareMay, 2),
                                Jun = Math.Round(VariableShareJun, 2),
                                Jul = Math.Round(VariableShareJul, 2),
                                Aug = Math.Round(VariableShareAug, 2),
                                Sept = Math.Round(VariableShareSept, 2),
                                Oct = Math.Round(VariableShareOct, 2),
                                Nov = Math.Round(VariableShareNov, 2),
                                Dec = Math.Round(VariableShareDec, 2),
                                Total = Math.Round(VariableShareTotal, 2),
                                proportion = VariableShareProportion
                            };
                        }

                        CostResult newFixedRow = null;
                        if (totalRow != null && fixedRatioRow != null)
                        {
                            string Fixedclassification = "固定%";
                            decimal FixedShareJan = totalRow.Jan != 0 ? fixedRatioRow.Jan / (decimal)totalRow.Jan * 100 : 0;
                            decimal FixedShareFeb = totalRow.Feb != 0 ? fixedRatioRow.Feb / (decimal)totalRow.Feb * 100 : 0;
                            decimal FixedShareMar = totalRow.Mar != 0 ? fixedRatioRow.Mar / (decimal)totalRow.Mar * 100 : 0;
                            decimal FixedShareApr = totalRow.Apr != 0 ? fixedRatioRow.Apr / (decimal)totalRow.Apr * 100 : 0;
                            decimal FixedShareMay = totalRow.May != 0 ? fixedRatioRow.May / (decimal)totalRow.May * 100 : 0;
                            decimal FixedShareJun = totalRow.Jun != 0 ? fixedRatioRow.Jun / (decimal)totalRow.Jun * 100 : 0;
                            decimal FixedShareJul = totalRow.Jul != 0 ? fixedRatioRow.Jul / (decimal)totalRow.Jul * 100 : 0;
                            decimal FixedShareAug = totalRow.Aug != 0 ? fixedRatioRow.Aug / (decimal)totalRow.Aug * 100 : 0;
                            decimal FixedShareSept = totalRow.Sept != 0 ? fixedRatioRow.Sept / (decimal)totalRow.Sept * 100 : 0;
                            decimal FixedShareOct = totalRow.Oct != 0 ? fixedRatioRow.Oct / (decimal)totalRow.Oct * 100 : 0;
                            decimal FixedShareNov = totalRow.Nov != 0 ? fixedRatioRow.Nov / (decimal)totalRow.Nov * 100 : 0;
                            decimal FixedShareDec = totalRow.Dec != 0 ? fixedRatioRow.Dec / (decimal)totalRow.Dec * 100 : 0;
                            decimal FixedShareTotal = totalRow.Total != 0 ? fixedRatioRow.Total / (decimal)totalRow.Total * 100 : 0;
                            decimal FixedShareProportion = 0;

                            newFixedRow = new CostResult
                            {
                                classification = Fixedclassification,
                                Jan = Math.Round(FixedShareJan, 2),
                                Feb = Math.Round(FixedShareFeb, 2),
                                Mar = Math.Round(FixedShareMar, 2),
                                Apr = Math.Round(FixedShareApr, 2),
                                May = Math.Round(FixedShareMay, 2),
                                Jun = Math.Round(FixedShareJun, 2),
                                Jul = Math.Round(FixedShareJul, 2),
                                Aug = Math.Round(FixedShareAug, 2),
                                Sept = Math.Round(FixedShareSept, 2),
                                Oct = Math.Round(FixedShareOct, 2),
                                Nov = Math.Round(FixedShareNov, 2),
                                Dec = Math.Round(FixedShareDec, 2),
                                Total = Math.Round(FixedShareTotal, 2),
                                proportion = FixedShareProportion
                            };
                        }

                        // 插入变动%行到变动占比行后面
                        if (newVariableRow != null)
                        {
                            int variableRatioIndex = CostResult.FindIndex(item => item.classification == "变动占比");
                            if (variableRatioIndex != -1)
                            {
                                CostResult.Insert(variableRatioIndex + 1, newVariableRow);
                            }
                        }

                        // 插入固定%行到固定占比行后面
                        if (newFixedRow != null)
                        {
                            int fixedRatioIndex = CostResult.FindIndex(item => item.classification == "固定占比");
                            if (fixedRatioIndex != -1)
                            {
                                CostResult.Insert(fixedRatioIndex + 1, newFixedRow);
                            }
                        }



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = CostResult

                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCostAllocationTable -- 成本核算分配表 -- Jean 2025.03.04
        public string GetCostAllocationTable(string YearMonth
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<LaborCostResult> LaborCostResult = new List<LaborCostResult>();
                List<ManufacturCostResult> ManufacturCostResult = new List<ManufacturCostResult>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {

                        sql = @"
                                WITH ErpLineMapping_CTE AS (
                                    SELECT *
                                    FROM OPENDATASOURCE('SQLOLEDB', 'Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[ErpLineMapping]
                                ),

                                LineCategoryMaster_CTE AS (
                                    SELECT *
                                    FROM OPENDATASOURCE('SQLOLEDB', 'Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[LineCategoryMaster]
                                ),

                                Department_CTE AS (
                                    SELECT *
                                    FROM OPENDATASOURCE('SQLOLEDB', 'Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[Department]
                                ),

                                DepartmentLineMapping_CTE AS (
                                    SELECT *
                                    FROM OPENDATASOURCE('SQLOLEDB', 'Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[DepartmentLineMapping]
                                ),

                                FilteredCSTMC AS (
                                    SELECT *
                                    FROM CSTMC
                                    WHERE MC002 = @YearMonth
                                ),

                                CombinedTime_CTE AS (
                                    SELECT 
                                        d1.DisplayOrder,
                                        d1.PurposeType,
                                        d1.CategoryName,
                                        CAST(SUM(CASE WHEN c1.Remarks = N'有效' THEN a1.MC005 ELSE 0 END) AS DECIMAL(10, 2)) AS ManualOutput,
                                        CAST(SUM(CASE WHEN c1.Remarks = N'有效' THEN a1.MC006 ELSE 0 END) AS DECIMAL(10, 2)) AS EffectiveMachineOutput,
                                        CAST(SUM(CASE WHEN c1.Remarks = N'无效' THEN a1.MC006 ELSE 0 END) AS DECIMAL(10, 2)) AS DeadMachineOutput
                                    FROM 
                                        FilteredCSTMC a1
                                        INNER JOIN CMSMD b1 ON b1.MD001 = a1.MC001
                                        INNER JOIN ErpLineMapping_CTE c1 ON c1.ErpLineCode = a1.MC001 
                                        INNER JOIN LineCategoryMaster_CTE d1 ON d1.LcmId = c1.LcmId 
                                    GROUP BY 
                                        d1.PurposeType, d1.CategoryName, d1.DisplayOrder
                                ),

                                FactoryOverhead_CTE AS (
                                        SELECT  f2.Remarks, f2.LcmId, f2.PurposeType ,f2.effectiveness
                                            ,SUM(balanceAmount) FactoryOverhead
                                        FROM (
                                        SELECT 
                                            (CASE WHEN b2.TB004 = '1' THEN CAST(b2.TB007 AS DECIMAL(10, 2)) 
                                                WHEN b2.TB004 = '-1' THEN -CAST(b2.TB007 AS DECIMAL(10, 2))
                                                ELSE 0 END ) AS balanceAmount
                                            ,d2.Remarks, d2.LcmId, e2.PurposeType
                                            ,(CASE WHEN b2.TB005 IN ('710110','710115','710117','710120') THEN N'无效'
                                                ELSE  N'有效'
                                                END) AS effectiveness
                                        FROM ACTTA a2
                                        LEFT JOIN ACTTB b2 ON a2.TA002 = b2.TB002
                                        LEFT JOIN Department_CTE c2 ON c2.DepartmentNo = b2.TB006 
                                        LEFT JOIN DepartmentLineMapping_CTE d2 ON d2.DepartmentId = c2.DepartmentId 
                                        LEFT JOIN LineCategoryMaster_CTE e2 ON e2.LcmId = d2.LcmId 
                                        WHERE (b2.TB005 >= '710101' AND b2.TB005 <= '710127')
                                            AND ((LEFT(b2.TB006, 2) IN ('J5', 'J6', 'J7','J8')) OR (b2.TB006 IN  ( 'J310','J313', 'J312','J232', '000001', '000002')))
                                            AND a2.TA010 != 'V'
                                            AND a2.TA006 !='E'
                                            AND LEFT(a2.TA003, 6) = @YearMonth
                                        )f2
                                    GROUP BY f2.Remarks, f2.LcmId, f2.PurposeType ,f2.effectiveness
                                ),

                                ItemWithdrawalCost_CTE AS (
                                        SELECT f3.Remarks, f3.LcmId, f3.PurposeType, SUM(f3.tb011) ItemWithdrawalCost
                                        FROM (
                                            SELECT d3.Remarks, d3.LcmId, e3.PurposeType, 
                                            (CASE WHEN b3.TA001='1102' THEN -a3.TB011 ELSE a3.TB011 END) AS tb011
                                            FROM INVTB a3
                                            INNER JOIN INVTA b3 ON a3.TB001 = b3.TA001 AND a3.TB002 = b3.TA002
                                            LEFT JOIN Department_CTE c3 ON c3.DepartmentNo = b3.TA004
                                            LEFT JOIN DepartmentLineMapping_CTE d3 ON d3.DepartmentId = c3.DepartmentId
                                            LEFT JOIN LineCategoryMaster_CTE e3 ON e3.LcmId = d3.LcmId
                                            WHERE b3.TA001 IN ('1101', '1102','1112')
                                                AND a3.TB012 NOT IN ('B03', 'B08')
                                                AND b3.TA006 != 'V'
                                                AND b3.TA004 != 'J220'
                                                AND b3.TA013='Y'
                                                AND LEFT(b3.TA014, 6) = @YearMonth
                                        ) AS f3
                                        GROUP BY f3.Remarks, f3.LcmId, f3.PurposeType
                                )

                                SELECT i.DisplayOrder,i.PurposeType,i.CategoryName,i.EffectiveTime,i.DeadTime,i.MachineCapacity
                                       ,i.EffectiveCharge,i.InvalidCharge
                                       ,cast((i.EffectiveCharge+i.InvalidCharge/i.MachineCapacity*i.EffectiveTime)AS DECIMAL(10, 2)) AS EffectiveChargeDep01
                                       ,cast((i.InvalidCharge/i.MachineCapacity*i.DeadTime)AS DECIMAL(10, 2)) AS InvalidChargeDep01
                                       ,i.EffectiveCoayments,i.InvalidCoayments,i.EffectivePSE,i.InvalidPSE
       
                                FROM(
                                    SELECT 
                                        c.DisplayOrder
                                        ,c.PurposeType
                                        ,c.CategoryName
                                        ,CASE WHEN c.CategoryName IN (N'二次加工', N'自动化技术', N'钳工') THEN c.ManualOutput ELSE c.EffectiveMachineOutput END AS EffectiveTime
                                        ,c.DeadMachineOutput AS DeadTime
                                        ,(CASE WHEN c.CategoryName IN (N'二次加工', N'自动化技术', N'钳工') THEN c.ManualOutput ELSE c.EffectiveMachineOutput END + c.DeadMachineOutput) AS MachineCapacity
                                        ,(CASE WHEN c.DeadMachineOutput=0 THEN (d.FactoryOverhead+e.FactoryOverhead+ISNULL(f.ItemWithdrawalCost,0)) ELSE (d.FactoryOverhead+ISNULL(f.ItemWithdrawalCost,0)) END) AS EffectiveCharge
                                        ,(CASE WHEN c.DeadMachineOutput=0 THEN 0 ELSE e.FactoryOverhead END) AS InvalidCharge
                                        ,g.FactoryOverhead AS EffectiveCoayments
                                        ,h.FactoryOverhead AS InvalidCoayments
                                        ,((SELECT FactoryOverhead FROM FactoryOverhead_CTE WHERE effectiveness=N'有效' AND Remarks=N'全厂(共摊)')+ (SELECT ItemWithdrawalCost FROM ItemWithdrawalCost_CTE WHERE Remarks=N'全厂(共摊)')) AS EffectivePSE
                                        ,(SELECT FactoryOverhead FROM FactoryOverhead_CTE WHERE effectiveness=N'无效' AND Remarks=N'全厂(共摊)') AS InvalidPSE
                                    FROM CombinedTime_CTE c
                                    LEFT JOIN FactoryOverhead_CTE d ON d.LcmId=c.DisplayOrder AND d.effectiveness=N'有效'
                                    LEFT JOIN FactoryOverhead_CTE e ON e.LcmId=c.DisplayOrder AND e.effectiveness=N'无效'
                                    LEFT JOIN ItemWithdrawalCost_CTE f ON f.LcmId=c.DisplayOrder
                                    LEFT JOIN FactoryOverhead_CTE g ON g.PurposeType=c.PurposeType AND g.effectiveness=N'有效' AND g.Remarks IN (N'成型事业处(共摊)',N'模具事业处(共摊)')
                                    LEFT JOIN FactoryOverhead_CTE h ON h.PurposeType=c.PurposeType AND h.effectiveness=N'无效' AND h.Remarks IN (N'成型事业处(共摊)',N'模具事业处(共摊)')
                                )i
                                ORDER BY i.DisplayOrder";

                        string sql2 = @"
                                WITH ErpLineMapping_CTE AS (
                                    SELECT *
                                    FROM OPENDATASOURCE('SQLOLEDB', 'Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[ErpLineMapping]
                                ),

                                LineCategoryMaster_CTE AS (
                                    SELECT *
                                    FROM OPENDATASOURCE('SQLOLEDB', 'Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[LineCategoryMaster]
                                ),

                                Department_CTE AS (
                                    SELECT *
                                    FROM OPENDATASOURCE('SQLOLEDB', 'Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[Department]
                                    WHERE CompanyId='4'
                                ),

                                DepartmentLineMapping_CTE AS (
                                    SELECT *
                                    FROM OPENDATASOURCE('SQLOLEDB', 'Data Source=192.168.20.137;User ID=report;Password=report').BM.BAS.[DepartmentLineMapping]
                                ),

                                BalanceCalculation_CTE AS (
                                    SELECT 
                                        SUM(CASE WHEN b1.TB004 = '1' THEN CAST(b1.TB007 AS DECIMAL(10, 2)) 
                                                 WHEN b1.TB004 = '-1' THEN -CAST(b1.TB007 AS DECIMAL(10, 2))
                                                 ELSE 0 END ) AS balanceAmount,
                                        d1.Remarks,d1.LcmId,e1.PurposeType
                                    FROM ACTTA a1
                                    LEFT JOIN ACTTB b1 ON a1.TA002 = b1.TB002
                                    INNER JOIN Department_CTE c1 ON c1.DepartmentNo = b1.TB006 
                                    INNER JOIN DepartmentLineMapping_CTE d1 ON d1.DepartmentId = c1.DepartmentId 
                                    INNER JOIN LineCategoryMaster_CTE e1 ON e1.LcmId = d1.LcmId 
                                    WHERE b1.TB005 IN ('700101', '700102')
                                          AND LEFT(a1.TA003, 6) = @YearMonth
                                    GROUP BY d1.Remarks, d1.LcmId, e1.PurposeType
                                ),

                                PTsumManualOutput_CTE AS (
                                     SELECT d2.PurposeType,CAST(SUM(a2.MC005) AS DECIMAL(10, 2)) AS sumManualOutput  
                                     FROM CSTMC a2
                                     INNER JOIN CMSMD b2 ON b2.MD001 = a2.MC001
                                     INNER JOIN ErpLineMapping_CTE c2 ON c2.ErpLineCode = a2.MC001 
                                     INNER JOIN LineCategoryMaster_CTE d2 ON d2.LcmId = c2.LcmId 
                                     WHERE c2.Remarks = N'有效' 
                                           AND a2.MC002 = @YearMonth
                                     GROUP BY d2.PurposeType
                                ),

                                sumManualOutput_CTE AS (
                                     SELECT CAST(SUM(a3.MC005) AS DECIMAL(10, 2)) AS sumManualOutput  
                                     FROM CSTMC a3
                                     INNER JOIN CMSMD b3 ON b3.MD001 = a3.MC001
                                     INNER JOIN ErpLineMapping_CTE c3 ON c3.ErpLineCode = a3.MC001 
                                     INNER JOIN LineCategoryMaster_CTE d3 ON d3.LcmId = c3.LcmId 
                                     WHERE c3.Remarks = N'有效' 
                                           AND d3.LcmId !=3
                                           AND a3.MC002 = @YearMonth   
                                ),

                                AllHandsShared_CTE AS (
                                    SELECT balanceAmount
                                    FROM BalanceCalculation_CTE
                                    WHERE LcmId = 13
                                )


                                SELECT x.PurposeType
                                        ,x.CategoryName
                                        ,x.ManualOutput
                                        ,x.MachineOutput
                                        ,x.DirectLabor
                                        ,x.distributedLabour
                                        ,x.allHandsShared
                                        ,x.departmentalLabor01
                                        ,x.departmentalLabor02
                                        ,(x.DirectLabor+x.departmentalLabor01+x.departmentalLabor02) AS LaborCost 

                                FROM (
                                        SELECT 
                                            d.PurposeType,d.DisplayOrder
                                            ,d.CategoryName
                                            ,CAST(SUM(a.MC005) AS DECIMAL(10, 2)) AS ManualOutput
                                            ,CAST(SUM(a.MC006) AS DECIMAL(10, 2)) AS MachineOutput
                                            ,e.balanceAmount DirectLabor
                                            ,CASE WHEN d.PurposeType=N'成型事业处' THEN  ISNULL(f.balanceAmount,0) ELSE 0 END AS  distributedLabour 
                                            ,ISNULL(ah.balanceAmount,0) AS allHandsShared
                                            ,CASE WHEN d.PurposeType = N'成型事业处' THEN ISNULL(CAST(SUM(a.MC005) / g.sumManualOutput * f.balanceAmount AS DECIMAL(10, 2)),0) ELSE 0 END AS departmentalLabor01
                                            ,CASE WHEN d.CategoryName = N'二次加工' THEN 0 ELSE ISNULL(CAST(SUM(a.MC005) / smo.sumManualOutput * ah.balanceAmount AS DECIMAL(10, 2)),0) END AS departmentalLabor02
                                        FROM CSTMC a
                                        INNER JOIN CMSMD b ON b.MD001 = a.MC001
                                        INNER JOIN ErpLineMapping_CTE c ON c.ErpLineCode = a.MC001 
                                        INNER JOIN LineCategoryMaster_CTE d ON d.LcmId = c.LcmId 
                                        INNER JOIN BalanceCalculation_CTE e ON e.LcmId = d.LcmId
                                        LEFT JOIN BalanceCalculation_CTE f ON d.PurposeType = f.PurposeType AND f.LcmId=11
                                        LEFT JOIN PTsumManualOutput_CTE g ON d.PurposeType = g.PurposeType 
                                        CROSS JOIN AllHandsShared_CTE ah
                                        CROSS JOIN sumManualOutput_CTE smo
                                        WHERE c.Remarks = N'有效' 
                                            AND a.MC002 = @YearMonth 
                                        GROUP BY d.PurposeType, d.CategoryName, d.DisplayOrder, e.balanceAmount ,f.balanceAmount ,g.sumManualOutput ,ah.balanceAmount, smo.sumManualOutput
                                        )x
                                ORDER BY x.DisplayOrder";

                        dynamicParameters.Add("YearMonth", YearMonth);

                        //var result = sqlConnection2.Query(sql, dynamicParameters);

                        LaborCostResult = sqlConnection2.Query<LaborCostResult>(sql2, dynamicParameters).ToList();
                        ManufacturCostResult = sqlConnection2.Query<ManufacturCostResult>(sql, dynamicParameters).ToList();


                        //item先计算出需要求和列的值
                        decimal sumEffectiveTimeCX = 0;//成型事业处的有效机时合计
                        decimal sumDeadTimeCX = 0;//成型事业处的无效机时合计
                        decimal sumEffectiveTimeMJ = 0;//模具事业处的有效机时合计
                        decimal sumDeadTimeMJ = 0;//模具事业处的无效机时合计
                        decimal SPEffectiveTime = 0;//二次加工的有效机时
                        decimal sumEffectiveTime = 0;//有效机时合计
                        decimal sumDeadTime = 0;//无效机时合计

                        foreach (var item in ManufacturCostResult)
                        {

                            if (item.PurposeType == "成型事业处")
                            {

                                sumEffectiveTimeCX += item.EffectiveTime;//成型事业处的有效机时合计
                                sumDeadTimeCX += item.DeadTime;//成型事业处的无效机时合计

                            }
                            else if (item.PurposeType == "模具事业处")
                            {

                                sumEffectiveTimeMJ += item.EffectiveTime;//模具事业处的有效机时合计
                                sumDeadTimeMJ += item.DeadTime;//模具事业处的无效机时合计
                            }

                            if (item.CategoryName == "二次加工")
                            {
                                SPEffectiveTime = item.EffectiveTime;//二次加工的有效机时
                            }

                            sumEffectiveTime += item.EffectiveTime;//有效机时合计
                            sumDeadTime += item.DeadTime;// 无效机时合计


                        }

                        //计算各列值
                        decimal EffectiveChargeDep02 = 0;
                        decimal InvalidChargeDep02 = 0;
                        decimal EffectiveChargeDep03 = 0;
                        decimal InvalidChargeDep03 = 0;
                        decimal TotalEffectiveManufee = 0;
                        decimal TotalInvalidManufee = 0;
                        decimal TotalManufee = 0;
                        decimal InvalidUnitfee = 0;

                        foreach (var item2 in ManufacturCostResult)
                        {
                            //EffectiveChargeDep02 = item2.EffectiveCoayments / sumEffectiveTimeCX * item2.EffectiveTime
                            //               + item2.InvalidCoayments / (sumEffectiveTimeCX + sumDeadTimeCX) * item2.EffectiveTime;//计算有效分配部门制费(二)
                            //InvalidChargeDep02 = item2.InvalidCoayments / (sumEffectiveTimeCX + sumDeadTimeCX) * item2.DeadTime;//计算无效分配部门制费(二)

                            if (item2.PurposeType == "成型事业处")
                            {
                                EffectiveChargeDep02 = item2.EffectiveCoayments / sumEffectiveTimeCX * item2.EffectiveTime
                                           + item2.InvalidCoayments / (sumEffectiveTimeCX + sumDeadTimeCX) * item2.EffectiveTime;//计算有效分配部门制费(二)
                                InvalidChargeDep02 = item2.InvalidCoayments / (sumEffectiveTimeCX + sumDeadTimeCX) * item2.DeadTime;//计算无效分配部门制费(二)
                                
                            }
                            else if (item2.PurposeType == "模具事业处")
                            {

                                EffectiveChargeDep02 = item2.EffectiveCoayments / sumEffectiveTimeMJ * item2.EffectiveTime
                                           + item2.InvalidCoayments / (sumEffectiveTimeMJ + sumDeadTimeMJ) * item2.EffectiveTime;//计算有效分配部门制费(二)
                                InvalidChargeDep02 = item2.InvalidCoayments / (sumEffectiveTimeMJ + sumDeadTimeMJ) * item2.DeadTime;//计算无效分配部门制费(二)
                            }


                            if (item2.CategoryName == "二次加工")
                            {
                                EffectiveChargeDep03 = 0;
                            }
                            else
                            {

                                EffectiveChargeDep03 = item2.EffectivePSE / (sumEffectiveTime - SPEffectiveTime) * item2.EffectiveTime
                                                + item2.InvalidPSE / (sumEffectiveTime + sumDeadTime - SPEffectiveTime) * item2.EffectiveTime;//计算有效分配部门制费(三)
                            }
                            InvalidChargeDep03 = item2.InvalidPSE / (sumEffectiveTime + sumDeadTime - SPEffectiveTime) * item2.DeadTime;//计算无效分配部门制费(三)
                            TotalEffectiveManufee = item2.EffectiveChargeDep01 + EffectiveChargeDep02 + EffectiveChargeDep03;//计算有效制费合计
                            TotalInvalidManufee = item2.InvalidChargeDep01 + InvalidChargeDep02 + InvalidChargeDep03;//计算无效制费合计
                            TotalManufee = TotalEffectiveManufee + TotalInvalidManufee;//计算制费成本合计
                            if (item2.DeadTime == 0)//计算无效单位制费
                            {
                                InvalidUnitfee = 0;
                            }
                            else
                            {
                                InvalidUnitfee = TotalInvalidManufee / item2.DeadTime;
                            }

                            item2.EffectiveChargeDep02 = Math.Round(EffectiveChargeDep02, 2);
                            item2.InvalidChargeDep02 = Math.Round(InvalidChargeDep02, 2);
                            item2.EffectiveChargeDep03 = Math.Round(EffectiveChargeDep03, 2);
                            item2.InvalidChargeDep03 = Math.Round(InvalidChargeDep03, 2);
                            item2.TotalEffectiveManufee = Math.Round(TotalEffectiveManufee, 2);
                            item2.TotalInvalidManufee = Math.Round(TotalInvalidManufee, 2);
                            item2.TotalManufee = Math.Round(TotalManufee, 2);
                            item2.InvalidUnitfee = Math.Round(InvalidUnitfee, 2);

                        }

                        // 初始化LaborCostResult合计值
                        string totalPurposeType = "";
                        string totalCategoryName = "合计";
                        decimal totalManualOutput = 0;
                        decimal totalMachineOutput = 0;
                        decimal totalDirectLabor = 0;
                        decimal totaldistributedLabour = 0;
                        decimal totalallHandsShared = 0;
                        decimal totaldepartmentalLabor01 = 0;
                        decimal totaldepartmentalLabor02 = 0;
                        decimal totalLaborCost = 0;
                        decimal totalEffectiveChargeCost = 0;
                        decimal totalInvalidChargeCost = 0;
                        decimal totalLaborPerUnit = 0;
                        decimal totalEffectiveUnitCost = 0;
                        decimal totalTotalCost = 0;



                        for (int i = 0; i < LaborCostResult.Count; i++)
                        {
                            var item3 = LaborCostResult[i];
                            var item4 = ManufacturCostResult[i];

                            decimal LaborPerUnit = 0;
                            decimal EffectiveUnitCost = 0;
                            decimal TotalCost = 0;

                            LaborPerUnit = item3.LaborCost / item3.ManualOutput;
                            item3.LaborPerUnit = Math.Round(LaborPerUnit, 2);//人工成本
                            item3.EffectiveChargeCost = item4.TotalEffectiveManufee;//有效制费成本
                            item3.InvalidChargeCost = item4.TotalInvalidManufee;//无效制费成本
                            if (item3.MachineOutput == 0)
                            {
                                EffectiveUnitCost = item3.EffectiveChargeCost / item3.ManualOutput;
                            }
                            else
                            {
                                EffectiveUnitCost = item3.EffectiveChargeCost / item3.MachineOutput;
                            }

                            item3.EffectiveUnitCost = Math.Round(EffectiveUnitCost, 2);//有效单位制费
                            TotalCost = item3.LaborCost + item3.EffectiveChargeCost + item3.InvalidChargeCost;
                            item3.TotalCost = Math.Round(TotalCost, 2);//合计

                            // 累加LaborCostResult各项值
                            totalManualOutput += item3.ManualOutput;
                            totalMachineOutput += item3.MachineOutput;
                            totalDirectLabor += item3.DirectLabor;
                            totaldepartmentalLabor01 += item3.departmentalLabor01;
                            totaldepartmentalLabor02 += item3.departmentalLabor02;
                            totalLaborCost += item3.LaborCost;
                            totalEffectiveChargeCost += item3.EffectiveChargeCost;
                            totalInvalidChargeCost += item3.InvalidChargeCost;
                            totalTotalCost += item3.TotalCost;


                        }

                        if (LaborCostResult.Count > 0)
                        {
                            totaldistributedLabour = LaborCostResult[0].distributedLabour;
                            totalallHandsShared = LaborCostResult[0].allHandsShared;
                        }
                        LaborCostResult totalItem = new LaborCostResult
                        {
                            PurposeType = totalPurposeType,
                            CategoryName = totalCategoryName,
                            ManualOutput = totalManualOutput,
                            MachineOutput = totalMachineOutput,
                            DirectLabor = totalDirectLabor,
                            distributedLabour = totaldistributedLabour,
                            allHandsShared = totalallHandsShared,
                            departmentalLabor01 = totaldepartmentalLabor01,
                            departmentalLabor02 = totaldepartmentalLabor02,
                            LaborCost = totalLaborCost,
                            EffectiveChargeCost = totalEffectiveChargeCost,
                            InvalidChargeCost = totalInvalidChargeCost,
                            LaborPerUnit = totalLaborPerUnit,
                            EffectiveUnitCost = totalEffectiveUnitCost,
                            TotalCost = totalTotalCost,
                        };

                        // 将合计项添加到 LaborCostResult 集合中
                        LaborCostResult.Add(totalItem);


                        // 初始化ManufacturCostResult合计值
                        string totalPurposeType1 = "";
                        string totalCategoryName1 = "合计";
                        decimal totalEffectiveTime = 0;
                        decimal totalDeadTime = 0;
                        decimal totalMachineCapacity = 0;
                        decimal totalEffectiveCharge = 0;
                        decimal totalInvalidCharge = 0;
                        decimal totalEffectiveChargeDep01 = 0;
                        decimal totalInvalidChargeDep01 = 0;
                        decimal totalEffectiveCoayments = 0;
                        decimal totalInvalidCoayments = 0;
                        decimal totalEffectiveChargeDep02 = 0;
                        decimal totalInvalidChargeDep02 = 0;
                        decimal totalEffectivePSE = 0;
                        decimal totalInvalidPSE = 0;
                        decimal totalEffectiveChargeDep03 = 0;
                        decimal totalInvalidChargeDep03 = 0;
                        decimal totalTotalEffectiveManufee = 0;
                        decimal totalTotalInvalidManufee = 0;
                        decimal totalTotalManufee = 0;
                        decimal totalInvalidUnitfee = 0;

                        for (int i = 0; i < ManufacturCostResult.Count; i++)
                        {
                            var item5 = ManufacturCostResult[i];


                            //累加ManufacturCostResult各项值

                            totalEffectiveTime += item5.EffectiveTime;
                            totalDeadTime += item5.DeadTime;
                            totalMachineCapacity += item5.MachineCapacity;
                            totalEffectiveCharge += item5.EffectiveCharge;
                            totalInvalidCharge += item5.InvalidCharge;
                            totalEffectiveChargeDep01 += item5.EffectiveChargeDep01;
                            totalInvalidChargeDep01 += item5.InvalidChargeDep01;
                            totalEffectiveChargeDep02 += item5.EffectiveChargeDep02;
                            totalInvalidChargeDep02 += item5.InvalidChargeDep02;
                            totalEffectiveChargeDep03 += item5.EffectiveChargeDep03;
                            totalInvalidChargeDep03 += item5.InvalidChargeDep03;
                            totalTotalEffectiveManufee += item5.TotalEffectiveManufee;
                            totalTotalInvalidManufee += item5.TotalInvalidManufee;
                            totalTotalManufee += item5.TotalManufee;
                        }
                        if (ManufacturCostResult.Count > 0)
                        {
                            totalEffectivePSE = ManufacturCostResult[0].EffectivePSE;
                            totalInvalidPSE = ManufacturCostResult[0].InvalidPSE;
                            totalEffectiveCoayments = ManufacturCostResult[0].EffectiveCoayments + ManufacturCostResult[ManufacturCostResult.Count - 1].EffectiveCoayments;
                            totalInvalidCoayments = ManufacturCostResult[0].InvalidCoayments + ManufacturCostResult[ManufacturCostResult.Count - 1].InvalidCoayments;

                        }
                        ManufacturCostResult totalItem1 = new ManufacturCostResult
                        {
                            PurposeType = totalPurposeType1,
                            CategoryName = totalCategoryName1,
                            EffectiveTime = totalEffectiveTime,
                            DeadTime = totalDeadTime,
                            MachineCapacity = totalMachineCapacity,
                            EffectiveCharge = totalEffectiveCharge,
                            InvalidCharge = totalInvalidCharge,
                            EffectiveChargeDep01 = totalEffectiveChargeDep01,
                            InvalidChargeDep01 = totalInvalidChargeDep01,
                            EffectiveCoayments = totalEffectiveCoayments,
                            InvalidCoayments = totalInvalidCoayments,
                            EffectiveChargeDep02 = totalEffectiveChargeDep02,
                            InvalidChargeDep02 = totalInvalidChargeDep02,
                            EffectivePSE = totalEffectivePSE,
                            InvalidPSE = totalInvalidPSE,
                            EffectiveChargeDep03 = totalEffectiveChargeDep03,
                            InvalidChargeDep03 = totalInvalidChargeDep03,
                            TotalEffectiveManufee = totalTotalEffectiveManufee,
                            TotalInvalidManufee = totalTotalInvalidManufee,
                            TotalManufee = totalTotalManufee,
                            InvalidUnitfee = totalInvalidUnitfee
                        };

                        // 将合计项添加到 ManufacturCostResult 集合中
                        ManufacturCostResult.Add(totalItem1);







                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = new { LaborCostResult, ManufacturCostResult }

                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSalesCostDetails -- 晶彩銷售成本明細 -- Jean 2025.04.05
        public string GetSalesCostDetails(string RoErpPrefix, string RoErpNo, string CustomerNo
            , string SalesmenNo, string MtlItemNo, string StartDate, string EndDate
            , string AccountingCategoryNo, string WarehouseCategoryNo, string BusinessCategoryNo, string ManagementCategoryNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "G.TG001,G.TG002,H.TH003";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @",G.TG042 AS DocDate, G.TG003 AS SalesDate,  Q.MQ001+' '+Q.MQ002 AS DocName, G.TG001+'-'+G.TG002 AS DocNum, G.TG020 AS HeaderRemarks
                                ,(CASE WHEN G.TG023='Y' THEN '已確認'
                                    WHEN G.TG023='N' THEN '未確認'
                                    WHEN G.TG023='V' THEN '作廢' END) AS ConfirmationCode
                                ,G.TG043 AS ConfirmerID, ISNULL(A.MF002,V.MV002) AS ConfirmerName,
                                (CASE WHEN H.TH026='Y' THEN '已結案' WHEN H.TH026='N' THEN '未結案' END) AS CaseClosureCode
                                ,G.TG004 AS CustomerNum, C.MA002 AS CustomerAbbreviation
                                ,G.TG005 AS DepID, DEP.ME002 AS DepName, G.TG006 AS BusinessID, ISNULL(A1.MF002,V1.MV002) AS BusinessName
                                ,H.TH003 AS LineNum, H.TH004 AS ItemID, H.TH005 AS ItemName, H.TH006 AS ItemSpec
                                ,H2.MB005 AS AccountingCategoryNo, ISNULL(H2.MA1,'') AS AccountingCategoryName,H2.MB006 AS WarehouseCategoryNo, ISNULL(H2.MA2,'') AS WarehouseCategoryName
                                ,H2.MB007 AS BusinessCategoryNo, ISNULL(H2.MA3,'') AS BusinessCategoryName,H2.MB008 AS ManagementCategoryNo, ISNULL(H2.MA4,'') AS ManagementCategoryName
                                ,WH1.MC002 AS WarehouseName, 
                                (CASE
                                    WHEN G.TG017='1' THEN '內含'
                                    WHEN G.TG017='2' THEN '外加'
                                    WHEN G.TG017='3' THEN '零稅率'
                                    WHEN G.TG017='4' THEN '免稅'
                                    WHEN G.TG017='9' THEN '不計稅'
                                END) AS TaxType
                                , G.TG011 AS CurrencyType, G.TG012 AS ExRate, G.TG044 AS BusinessTaxRate,
                                H.TH008 AS Qty, H.TH009 AS Unite, H.TH012 AS Price, H.TH013 AS Amount,ISNULL(IA.LA012, 0) AS UnitCost
                                ,IA.LA017 AS MaterialCost, IA.LA018 AS LaborCost, IA.LA019 AS ManufacturingCost, IA.LA020 AS ProcessingCost, H.TH037 AS UntaxedLocalAmt
                                ,ISNULL(IA.LA013, 0) AS SalesCost, H.TH037-ISNULL(IA.LA013, 0) AS LocalUntaxedGP, H.TH018 AS ItemRemarks";
                        sqlQuery.mainTables =
                              @"FROM COPTH H
                                LEFT JOIN COPTG G ON H.TH001=G.TG001 AND H.TH002=G.TG002
                                LEFT JOIN CMSMQ Q ON Q.MQ001=G.TG001
                                LEFT JOIN ADMMF A ON A.MF001=G.TG043
                                LEFT JOIN CMSMV V ON V.MV001=G.TG043
                                LEFT JOIN COPMA C ON C.MA001=G.TG004
                                LEFT JOIN CMSME DEP ON DEP.ME001=G.TG005
                                LEFT JOIN ADMMF A1 ON A1.MF001=G.TG006
                                LEFT JOIN CMSMV V1 ON V1.MV001=G.TG006
                                LEFT JOIN CMSMC WH1 ON WH1.MC001=H.TH007
                                LEFT JOIN INVLA IA ON H.TH001 = IA.LA006 AND H.TH002 = IA.LA007 AND H.TH003 = IA.LA008
                                LEFT JOIN (SELECT H1.TH001,H1.TH002,H1.TH003,i.MB005,T1.MA003 AS MA1,i.MB006,T2.MA003 AS MA2,i.MB007,T3.MA003 AS MA3,i.MB008,T4.MA003 AS MA4
                                            FROM COPTH H1
                                            LEFT JOIN COPTG G ON H1.TH001=G.TG001 AND H1.TH002=G.TG002
                                            LEFT JOIN INVMB i ON H1.TH004=i.MB001
                                            LEFT JOIN INVMA T1 ON i.MB005=T1.MA002
                                            LEFT JOIN INVMA T2 ON i.MB006=T2.MA002
                                            LEFT JOIN INVMA T3 ON i.MB007=T3.MA002
                                            LEFT JOIN INVMA T4 ON i.MB008=T4.MA002
                                    WHERE G.TG023='Y' AND H1.TH020='Y'
                                    GROUP BY H1.TH001,H1.TH002,H1.TH003,i.MB005,T1.MA003,i.MB006,T2.MA003,i.MB007,T3.MA003,i.MB008,T4.MA003
                                    ) H2 ON H2.TH001=H.TH001 AND H2.TH002=H.TH002 AND H2.TH003=H.TH003 ";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND G.TG023='Y' AND H.TH020='Y'";

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "RoErpPrefix", @" AND Q.MQ001 = @RoErpPrefix", RoErpPrefix);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "RoErpNo", @" AND (G.TG001+'-'+G.TG002) LIKE '%' + @RoErpNo + '%'", RoErpNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerNo", @" AND G.TG004 = @CustomerNo", CustomerNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SalesmenNo", @" AND G.TG006 = @SalesmenNo", SalesmenNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (H.TH004 LIKE '%' + @MtlItemNo + '%' OR H.TH005 LIKE '%' + @MtlItemNo + '%' )", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND CONVERT(DATE, G.TG042, 112) >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND CONVERT(DATE, G.TG042, 112) <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "AccountingCategoryNo", @" AND H2.MB005 = @AccountingCategoryNo ", AccountingCategoryNo);//會計分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WarehouseCategoryNo", @" AND H2.MB006 = @WarehouseCategoryNo ", WarehouseCategoryNo);//倉管分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BusinessCategoryNo", @" AND H2.MB007 = @BusinessCategoryNo ", BusinessCategoryNo);//業務分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ManagementCategoryNo", @" AND H2.MB008 = @ManagementCategoryNo ", ManagementCategoryNo);//生管分類名稱


                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "G.TG042";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetShipmentCostDetails -- 晶彩出貨成本明細 -- Jean 2025.04.11
        public string GetShipmentCostDetails(string TsnErpPrefix, string TsnErpNo, string CustomerNo
            , string SalesmenNo, string MtlItemNo, string StartDate, string EndDate
            , string AccountingCategoryNo, string WarehouseCategoryNo, string BusinessCategoryNo, string ManagementCategoryNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "F.TF001,F.TF002,G.TG003";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @",F.TF024 AS DocDate, F.TF003 AS ChangeDate, Q.MQ001+' '+Q.MQ002 AS DocName, F.TF001+'-'+F.TF002 AS DocNum, F.TF014 AS HeaderRemarks
	                        ,(CASE WHEN F.TF020='Y' THEN '已確認'
		                        WHEN F.TF020='N' THEN '未確認'
		                        WHEN F.TF020='V' THEN '作廢' END) AS ConfirmationCode
                            ,F.TF025 AS ConfirmerID, ISNULL(A.MF002,V.MV002) AS ConfirmerName
                            ,(CASE WHEN G.TG024='Y' THEN '已結案'
		                        WHEN G.TG024='N' THEN '未結案' END) AS CaseClosureCode
                            ,(CASE WHEN F.TF004='1' THEN '客戶'
		                        WHEN F.TF004='2' THEN '廠商'
		                        WHEN F.TF004='3' THEN '人員'
		                        WHEN F.TF004='9' THEN '其它' END) AS ObjectName, F.TF005 AS ObjectID, F.TF006 AS ObjectAbbr
                            ,F.TF007 AS DepID, DEP.ME002 AS DepName, F.TF008 AS EmployeeID, ISNULL(A1.MF002,V1.MV002) AS EmployeeName
                            ,G.TG003 AS LineNum, G.TG004 AS ItemID, G.TG005 AS ItemName, G.TG006 AS ItemSpec
                            ,G2.MB005 AS AccountingCategoryNo, ISNULL(G2.MA1,'') AS AccountingCategoryName,G2.MB006 AS WarehouseCategoryNo, ISNULL(G2.MA2,'') AS WarehouseCategoryName
                            ,G2.MB007 AS BusinessCategoryNo, ISNULL(G2.MA3,'') AS BusinessCategoryName,G2.MB008 AS ManagementCategoryNo, ISNULL(G2.MA4,'') AS ManagementCategoryName
                            ,WH1.MC002 AS WarehouseTransferOut, WH2.MC002 AS WarehouseTransferIn
                            ,(CASE WHEN F.TF010='1' THEN '內含'
		                        WHEN F.TF010='2' THEN '外加'
		                        WHEN F.TF010='3' THEN '零稅率'
		                        WHEN F.TF010='4' THEN '免稅'
		                        WHEN F.TF010='9' THEN '不計稅' END) AS TaxType, F.TF011 AS CurrencyType, F.TF012 AS ExRate, G.TG042 AS BusinessTaxRate
                            ,G.TG009 AS Qty, G.TG010 AS Unite, G.TG012 AS Price, G.TG013 AS Amount, ISNULL(IA.LA012, 0) AS UnitCost
                            ,IA.LA017 AS MaterialCost, IA.LA018 AS LaborCost,IA.LA019 AS ManufacturingCost,IA.LA020 AS ProcessingCost
                            ,(case when F.TF010='1' then G.TG013/(1+G.TG042)
		                        when F.TF010='2' then G.TG013*1
		                        WHEN F.TF010='3' THEN G.TG013*F.TF012
		                        when F.TF010='4' then G.TG013*F.TF012 ELSE G.TG013 end) AS TempOutExTaxAmt, ISNULL(IA.LA013, 0) AS SalesCost
                            , (case when F.TF010='1' then (G.TG013/(1+G.TG042))-ISNULL(IA.LA013, 0) 
		                        when F.TF010='2' then (G.TG013*1)-ISNULL(IA.LA013, 0) 
		                        WHEN F.TF010='3' THEN (G.TG013*F.TF012)-ISNULL(IA.LA013, 0) 
		                        when F.TF010='4' then (G.TG013*F.TF012)-ISNULL(IA.LA013, 0) ELSE G.TG013-ISNULL(IA.LA013, 0) END) AS TempOutExTaxGP, G.TG019 AS ItemRemarks";
                        sqlQuery.mainTables =
                              @"FROM INVTG G
	                            LEFT JOIN INVTF F ON F.TF001=G.TG001 AND F.TF002=G.TG002
	                            LEFT JOIN CMSMQ Q ON Q.MQ001=F.TF001
	                            LEFT JOIN CMSME DEP ON DEP.ME001=F.TF007
	                            LEFT JOIN ADMMF A ON A.MF001=F.TF025
	                            LEFT JOIN CMSMV V ON V.MV001=F.TF025
	                            LEFT JOIN ADMMF A1 ON A1.MF001=F.TF008
	                            LEFT JOIN CMSMV V1 ON V1.MV001=F.TF008
	                            LEFT JOIN CMSMC WH1 ON WH1.MC001=G.TG007
	                            LEFT JOIN CMSMC WH2 ON WH2.MC001=G.TG008
	                            LEFT JOIN INVLA IA ON G.TG001 = IA.LA006 AND G.TG002 = IA.LA007 AND G.TG003 = IA.LA008 AND IA.LA005 ='-1'
	                            LEFT JOIN (SELECT G1.TG001,G1.TG002,G1.TG003,i.MB005,T1.MA003 AS MA1,i.MB006,T2.MA003 AS MA2,i.MB007,T3.MA003 AS MA3,i.MB008,T4.MA003 AS MA4
	                             FROM INVTG G1
		                            LEFT JOIN INVTF F ON F.TF001=G1.TG001 AND F.TF002=G1.TG002
		                            LEFT JOIN INVMB i ON G1.TG004=i.MB001
		                            LEFT JOIN INVMA T1 ON i.MB005=T1.MA002
		                            LEFT JOIN INVMA T2 ON i.MB006=T2.MA002
		                            LEFT JOIN INVMA T3 ON i.MB007=T3.MA002
		                            LEFT JOIN INVMA T4 ON i.MB008=T4.MA002
	                             WHERE F.TF020='Y' AND G1.TG022='Y'
	                             GROUP BY G1.TG001,G1.TG001,G1.TG002,G1.TG003,i.MB005,T1.MA003,i.MB006,T2.MA003,i.MB007,T3.MA003,i.MB008,T4.MA003
	                             ) G2 ON G2.TG001=G.TG001 AND G2.TG002=G.TG002 AND G2.TG003=G.TG003 ";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND F.TF020='Y' AND G.TG022='Y'";

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TsnErpPrefix", @" AND Q.MQ001 = @TsnErpPrefix", TsnErpPrefix);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TsnErpNo", @" AND (F.TF001+'-'+F.TF002) LIKE '%' + @TsnErpNo + '%'", TsnErpNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerNo", @" AND F.TF005 = @CustomerNo", CustomerNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SalesmenNo", @" AND F.TF008 = @SalesmenNo", SalesmenNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (G.TG004 LIKE '%' + @MtlItemNo + '%' OR G.TG005 LIKE '%' + @MtlItemNo + '%' )", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND CONVERT(DATE, F.TF024, 112) >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND CONVERT(DATE, F.TF024, 112) <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "AccountingCategoryNo", @" AND G2.MB005 = @AccountingCategoryNo ", AccountingCategoryNo);//會計分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WarehouseCategoryNo", @" AND G2.MB006 = @WarehouseCategoryNo ", WarehouseCategoryNo);//倉管分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BusinessCategoryNo", @" AND G2.MB007 = @BusinessCategoryNo ", BusinessCategoryNo);//業務分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ManagementCategoryNo", @" AND G2.MB008 = @ManagementCategoryNo ", ManagementCategoryNo);//生管分類名稱


                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "F.TF024";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetReimbursementCostDetails -- 晶彩歸還成本明細 -- Jean 2025.04.14
        public string GetReimbursementCostDetails(string TsrnErpPrefix, string TsrnErpNo, string CustomerNo
            , string SalesmenNo, string MtlItemNo, string StartDate, string EndDate
            , string AccountingCategoryNo, string WarehouseCategoryNo, string BusinessCategoryNo, string ManagementCategoryNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "H.TH001,H.TH002,I.TI003";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @",H.TH003 AS DocDate, Q1.MQ001+' '+Q1.MQ002 AS DocName, H.TH001+'-'+H.TH002 AS DocNum, H.TH014 AS HeaderRemarks
                                ,(CASE WHEN H.TH020='Y' THEN '已確認'
		                            WHEN H.TH020='N' THEN '已確認'
		                            WHEN H.TH020='Y' THEN '已確認' END) AS ConfirmationCode, H.TH024 AS ConfirmerID, ISNULL(A0.MF002,V0.MV002) AS ConfirmerName
                                ,(CASE WHEN H.TH004='1' THEN '客戶'
		                            WHEN H.TH004='2' THEN '廠商'
		                            WHEN H.TH004='3' THEN '人員'
		                            WHEN H.TH004='9' THEN '其它' END) AS ObjectName, H.TH005 AS ObjectID, H.TH006 AS ObjectAbbr
                                ,H.TH007 AS DepID, DEP.ME002 AS DepName, H.TH008 AS EmployeeID, ISNULL(A.MF002,V.MV002) AS EmployeeName
                                ,I.TI003 AS LineNum, I.TI004 AS ItemID, I.TI005 AS ItemName, I.TI006 AS ItemSpec
                                ,G2.MB005 AS AccountingCategoryNo, ISNULL(G2.MA1,'') AS AccountingCategoryName,G2.MB006 AS WarehouseCategoryNo, ISNULL(G2.MA2,'') AS WarehouseCategoryName
                                ,G2.MB007 AS BusinessCategoryNo, ISNULL(G2.MA3,'') AS BusinessCategoryName,G2.MB008 AS ManagementCategoryNo, ISNULL(G2.MA4,'') AS ManagementCategoryName
                                ,K2.MC002 AS WarehouseTransferIn, K1.MC002 AS WarehouseTransferOut
                                ,(CASE WHEN H.TH010='1' THEN '內含'
		                            WHEN H.TH010='2' THEN '外加'
		                            WHEN H.TH010='3' THEN '零稅率'
		                            WHEN H.TH010='4' THEN '免稅'
		                            WHEN H.TH010='9' THEN '不計稅' END) AS TaxType, H.TH011 AS CurrencyType, H.TH012 AS ExRate, H.TH025 AS BusinessTaxRate
                                ,(CASE WHEN I.TI034='1' THEN '贈品量' 
		                            WHEN I.TI034='2' THEN '備品量' END) AS GSType, I.TI035 AS GSQty, I.TI036 AS GSPackQty, I.TI038 AS BillingQty, I.TI039 PricingUnit, 
	                            I.TI009 AS Qty, I.TI010 AS Unite, I.TI012 AS Price, I.TI013 AS Amount, ISNULL(IA.LA012, 0) AS UnitCost,
	                            IA.LA017 AS MaterialCost,IA.LA018 AS LaborCost,IA.LA019 AS ManufacturingCost,IA.LA020 AS ProcessingCost,
	                            (case when H.TH010='1' then I.TI013/(1+H.TH025)
		                            when H.TH010='2' then I.TI013*1
		                            WHEN H.TH010='3' THEN I.TI013*H.TH012
		                            when H.TH010='4' then I.TI013*H.TH012 ELSE I.TI013 end) as UntaxedAmount, ISNULL(IA.LA013, 0) AS SalesCost, 
	                            (case when H.TH010='1' then (I.TI013/(1+H.TH025))-ISNULL(IA.LA013, 0) 
		                            when H.TH010='2' then (I.TI013*1)-ISNULL(IA.LA013, 0) 
		                            WHEN H.TH010='3' THEN (I.TI013*H.TH012)-ISNULL(IA.LA013, 0) 
		                            when H.TH010='4' then (I.TI013*H.TH012)-ISNULL(IA.LA013, 0) ELSE I.TI013-ISNULL(IA.LA013, 0) end) as UntaxedGP, I.TI021 AS ItemRemarks";
                        sqlQuery.mainTables =
                              @"FROM INVTI I
	                            LEFT JOIN INVTH H ON H.TH001=I.TI001 AND H.TH002=I.TI002
	                            LEFT JOIN INVLA IA ON I.TI004=IA.LA001 AND I.TI001=IA.LA006 AND I.TI002=IA.LA007 AND I.TI003=IA.LA008 AND IA.LA005='+1'
	                            LEFT JOIN CMSME DEP ON DEP.ME001=H.TH007
	                            LEFT JOIN ADMMF A0 ON A0.MF001=H.TH024
	                            LEFT JOIN CMSMV V0 ON V0.MV001=H.TH024
	                            LEFT JOIN ADMMF A ON A.MF001=H.TH008
	                            LEFT JOIN CMSMV V ON V.MV001=H.TH008
	                            LEFT JOIN CMSMC K1 ON I.TI007 = K1.MC001
	                            LEFT JOIN CMSMC K2 ON I.TI008 = K2.MC001
	                            LEFT JOIN CMSMQ Q1 ON Q1.MQ001=H.TH001
	                            LEFT JOIN CMSMQ Q2 ON Q2.MQ001=I.TI014
	                            LEFT JOIN ADMMF A1 ON A1.MF001=H.CREATOR
	                            LEFT JOIN CMSMV V1 ON V1.MV001=H.CREATOR
	                            LEFT JOIN ADMMF A2 ON A2.MF001=H.MODIFIER
	                            LEFT JOIN CMSMV V2 ON V2.MV001=H.MODIFIER
	                            LEFT JOIN (SELECT I.TI001,I.TI002,I.TI003,I.TI004,i.MB005,T1.MA003 AS MA1,i.MB006,T2.MA003 AS MA2,i.MB007,T3.MA003 AS MA3,i.MB008,T4.MA003 AS MA4
				                             FROM INVTI I
					                            LEFT JOIN INVTH H ON (H.TH001=I.TI001 AND H.TH002=I.TI002)
					                            LEFT JOIN INVMB i ON I.TI004=i.MB001
					                            LEFT JOIN INVMA T1 ON i.MB005=T1.MA002
					                            LEFT JOIN INVMA T2 ON i.MB006=T2.MA002
					                            LEFT JOIN INVMA T3 ON i.MB007=T3.MA002
					                            LEFT JOIN INVMA T4 ON i.MB008=T4.MA002
				                             WHERE H.TH020='Y' AND I.TI022='Y'
				                             GROUP BY I.TI001,I.TI002,I.TI003,I.TI004,i.MB005,T1.MA003,i.MB006,T2.MA003,i.MB007,T3.MA003,i.MB008,T4.MA003
			                            ) G2 ON G2.TI001=I.TI001 AND G2.TI002=I.TI002 AND G2.TI003=I.TI003 ";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND H.TH020='Y' AND I.TI022='Y' AND IA.LA005='+1'";

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TsrnErpPrefix", @" AND Q1.MQ001 = @TsrnErpPrefix", TsrnErpPrefix);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TsrnErpNo", @" AND (H.TH001+'-'+H.TH002) LIKE '%' + @TsrnErpNo + '%'", TsrnErpNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerNo", @" AND H.TH005 = @CustomerNo", CustomerNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SalesmenNo", @" AND H.TH008 = @SalesmenNo", SalesmenNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (I.TI004 LIKE '%' + @MtlItemNo + '%' OR I.TI005 LIKE '%' + @MtlItemNo + '%' )", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND CONVERT(DATE, H.TH003, 112) >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND CONVERT(DATE, H.TH003, 112) <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "AccountingCategoryNo", @" AND G2.MB005 = @AccountingCategoryNo ", AccountingCategoryNo);//會計分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WarehouseCategoryNo", @" AND G2.MB006 = @WarehouseCategoryNo ", WarehouseCategoryNo);//倉管分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BusinessCategoryNo", @" AND G2.MB007 = @BusinessCategoryNo ", BusinessCategoryNo);//業務分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ManagementCategoryNo", @" AND G2.MB008 = @ManagementCategoryNo ", ManagementCategoryNo);//生管分類名稱


                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "H.TH003";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetSalesReturnsAllowancesCostDetails -- 晶彩銷退/折讓成本明細 -- Jean 2025.04.14
        public string GetSalesReturnsAllowancesCostDetails(string RtErpPrefix, string RtErpNo, string CustomerNo
            , string SalesmenNo, string MtlItemNo, string StartDate, string EndDate
            , string AccountingCategoryNo, string WarehouseCategoryNo, string BusinessCategoryNo, string ManagementCategoryNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        sqlQuery.mainKey = "I.TI001,I.TI002,J.TJ003";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @",I.TI034 AS DocDate,I.TI003 AS SRDate,
	                        (CASE WHEN J.TJ030='1' THEN '銷退'
		                        WHEN J.TJ030='2' THEN '折讓' END) AS SRAType, Q.MQ001+' '+Q.MQ002 AS DocName,I.TI001+'-'+I.TI002 AS DocNum, I.TI020 AS HeaderRemarks,
	                        (CASE WHEN I.TI019='Y' THEN '已確認'
		                        WHEN I.TI019='N' THEN '未確認'
		                        WHEN I.TI019='V' THEN '作廢' END) AS ConfirmationCode, I.TI035 AS ConfirmerID, ISNULL(V5.MV002,A5.MF002) AS ConfirmerName,
	                        (CASE WHEN J.TJ024='Y' THEN '已結案'
		                        WHEN J.TJ024='N' THEN '未結案' END) AS CaseClosureCode, I.TI004 AS CustomerID,	C.MA002 AS CustomerAbbr,
	                        I.TI005 AS DepID, DEP.ME002 AS DepName, I.TI006 AS BusinessID, ISNULL(V4.MV002,A4.MF002) AS BusinessName, 
	                        J.TJ003 AS LineNum, J.TJ004 AS ItemID, J.TJ005 AS ItemName, J.TJ006 AS ItemSpec, 
		                        G2.MB005 AS AccountingCategoryNo, ISNULL(G2.MA1,'') AS AccountingCategoryName,G2.MB006 AS WarehouseCategoryNo, ISNULL(G2.MA2,'') AS WarehouseCategoryName, 
		                        G2.MB007 AS BusinessCategoryNo, ISNULL(G2.MA3,'') AS BusinessCategoryName,G2.MB008 AS ManagementCategoryNo, ISNULL(G2.MA4,'') AS ManagementCategoryName,
	                        K1.MC002 AS RIWarehouse,
	                        (CASE WHEN J.TJ041='1' THEN '贈品量'
	                        WHEN J.TJ041='2' THEN '備品量' END) AS GSType, J.TJ042 AS GSQty, J.TJ043 AS GSPackQty, J.TJ050 AS BillingQty, J.TJ051 AS PricingUnit,
	                        J.TJ007 AS Qty, J.TJ008 AS Unite, J.TJ011 AS Price, J.TJ012 AS Amount,ISNULL(IA.LA012, 0) AS UnitCost,
	                        IA.LA017 AS MaterialCost, IA.LA018 AS LaborCost,IA.LA019 AS ManufacturingCost,IA.LA020 AS ProcessingCost, J.TJ033 AS UntaxedLocalAmt,
	                        ISNULL(IA.LA013, 0) AS SalesCost, J.TJ033-ISNULL(IA.LA013, 0) AS LocalUntaxedGP, J.TJ023 AS ItemRemarks,
	                        I.CREATE_DATE AS DocCreatDate, I.CREATOR AS DocCreatUserID,ISNULL(V6.MV002,A6.MF002) AS DocCreatUserName,
	                        I.MODI_DATE AS DocUpDate, I.MODIFIER AS DocUpUserID,ISNULL(V7.MV002,A7.MF002) AS DocUpUserName";
                        sqlQuery.mainTables =
                              @"FROM COPTI I
	                            LEFT JOIN COPTJ J ON I.TI001=J.TJ001 AND I.TI002=J.TJ002
	                            LEFT JOIN CMSMQ Q ON Q.MQ001=I.TI001
	                            LEFT JOIN CMSME DEP ON DEP.ME001=I.TI005
	                            LEFT JOIN COPMA C ON C.MA001=I.TI004
	                            LEFT JOIN CMSMV E2 ON I.TI035 = E2.MV001
	                            LEFT JOIN CMSMC K1 ON J.TJ013 = K1.MC001
	                            LEFT JOIN ADMMF A3 ON A3.MF001=I.TI022
	                            LEFT JOIN CMSMV V3 ON V3.MV001=I.TI022
	                            LEFT JOIN ADMMF A4 ON A4.MF001=I.TI006
	                            LEFT JOIN CMSMV V4 ON V4.MV001=I.TI006
	                            LEFT JOIN ADMMF A5 ON A5.MF001=I.TI035
	                            LEFT JOIN CMSMV V5 ON V5.MV001=I.TI035
	                            LEFT JOIN ADMMF A6 ON A6.MF001=I.CREATOR
	                            LEFT JOIN CMSMV V6 ON V6.MV001=I.CREATOR
	                            LEFT JOIN ADMMF A7 ON A7.MF001=I.MODIFIER
	                            LEFT JOIN CMSMV V7 ON V7.MV001=I.MODIFIER
	                            LEFT JOIN INVLA IA ON J.TJ001 = IA.LA006 AND J.TJ002 = IA.LA007 AND J.TJ003 = IA.LA008
	                            LEFT JOIN (SELECT J.TJ001,J.TJ002,J.TJ003,J.TJ004,i.MB005,T1.MA003 AS MA1,i.MB006,T2.MA003 AS MA2,i.MB007,T3.MA003 AS MA3,i.MB008,T4.MA003 AS MA4
					                            FROM COPTI I
						                            LEFT JOIN COPTJ J ON I.TI001=J.TJ001 AND I.TI002=J.TJ002
						                            LEFT JOIN INVMB i ON J.TJ004=i.MB001
						                            LEFT JOIN INVMA T1 ON i.MB005=T1.MA002
						                            LEFT JOIN INVMA T2 ON i.MB006=T2.MA002
						                            LEFT JOIN INVMA T3 ON i.MB007=T3.MA002
						                            LEFT JOIN INVMA T4 ON i.MB008=T4.MA002
					                            WHERE I.TI019='Y' AND J.TJ021='Y'
					                            GROUP BY J.TJ001,J.TJ002,J.TJ003,J.TJ004,i.MB005,T1.MA003,i.MB006,T2.MA003,i.MB007,T3.MA003,i.MB008,T4.MA003
			                            ) G2 ON G2.TJ001=J.TJ001 AND G2.TJ002=J.TJ002 AND G2.TJ003=J.TJ003 ";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND I.TI019='Y' AND J.TJ021='Y' ";

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "RtErpPrefix", @" AND Q.MQ001 = @RtErpPrefix", RtErpPrefix);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "RtErpNo", @" AND (I.TI001+'-'+I.TI002) LIKE '%' + @RtErpNo + '%'", RtErpNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerNo", @" AND I.TI004 = @CustomerNo", CustomerNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SalesmenNo", @" AND I.TI006 = @SalesmenNo", SalesmenNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (J.TJ004 LIKE '%' + @MtlItemNo + '%' OR J.TJ005 LIKE '%' + @MtlItemNo + '%' )", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND CONVERT(DATE, I.TI034, 112) >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND CONVERT(DATE, I.TI034, 112) <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "AccountingCategoryNo", @" AND G2.MB005 = @AccountingCategoryNo ", AccountingCategoryNo);//會計分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WarehouseCategoryNo", @" AND G2.MB006 = @WarehouseCategoryNo ", WarehouseCategoryNo);//倉管分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BusinessCategoryNo", @" AND G2.MB007 = @BusinessCategoryNo ", BusinessCategoryNo);//業務分類名稱
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ManagementCategoryNo", @" AND G2.MB008 = @ManagementCategoryNo ", ManagementCategoryNo);//生管分類名稱


                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "I.TI034";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        var result = BaseHelper.SqlQuery(sqlConnection2, dynamicParameters, sqlQuery);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCustomerProduct -- 取得指定客戶的機種資料(可能有多個客戶) -- Jean 2025.04.29
        public string GetCustomerProduct(string CustomerNo, string ProductModel
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    //if (CurrentCompany <= 0) CurrentCompany = 4;
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        string mainSql = @"SELECT a.MA001
                                            ,a.MA001 CustomerNo,a.MA002 CustomerShortName,a.MA003 CustomerName,c.TD004 MtlItemNo,d.MB002 MtlItemName,d.MB003 MtlItemSpec
                                            ,SUM(c.TD008) CustomerOrderQty 
                                            ,d.MB004 UomNo
                                            ,ISNULL(e.ProductionQty,0) ProductionQty 
                                            ,ISNULL(f.InPutQty,0) InPutQty 
                                            ,ISNULL(g.ProvisionalQty,0) ProvisionalQty 
                                            ,ISNULL(h.SalesOrderQty,0) SalesOrderQty
                                            FROM COPMA a 
                                            INNER JOIN COPTC b ON a.MA001=b.TC004 
                                            INNER JOIN COPTD c ON b.TC001=c.TD001 AND b.TC002=c.TD002 AND c.TD021 = 'Y'        
                                            INNER JOIN INVMB d ON c.TD004=d.MB001 
                                            LEFT JOIN (SELECT a4.TA006,d4.MB002 ,d4.MB003 ,SUM(a4.TA015) AS ProductionQty
                                                        FROM MOCTA a4
                                                        INNER JOIN COPTD b4 ON a4.TA026 = b4.TD001 AND a4.TA027 = b4.TD002 AND a4.TA028 = b4.TD003
                                                        INNER JOIN COPTC c4 ON b4.TD001 = c4.TC001 AND b4.TD002 = c4.TC002
                                                        INNER JOIN INVMB d4 ON b4.TD004= d4.MB001
                                                        WHERE 1=1
                                                        AND a4.TA013 = 'Y'";
                                                        if (!string.IsNullOrEmpty(CustomerNo))
                                                        {
                                                            mainSql += " AND c4.TC004 IN @CustomerNo";
                                                        }
                                                        if (!string.IsNullOrEmpty(ProductModel))
                                                        {
                                                            mainSql += " AND (a4.TA006 LIKE '%' + @ProductModel + '%' OR d4.MB002 LIKE '%' + @ProductModel + '%')";
                                                        }

                                                    mainSql += @" GROUP BY a4.TA006,d4.MB002 ,d4.MB003
                                                                    ) e ON e.TA006=d.MB001
            
                                            LEFT JOIN (SELECT f1.TI004,g1.MB002 ,g1.MB003 ,SUM(f1.TI007) AS InPutQty
                                                        FROM MOCTI f1
                                                        INNER JOIN MOCTA e1 ON f1.TI013 = e1.TA001 AND f1.TI014 = e1.TA002
                                                        INNER JOIN COPTD c1 ON e1.TA026 = c1.TD001 AND e1.TA027 = c1.TD002 AND e1.TA028 = c1.TD003
                                                        INNER JOIN COPTC b1 ON c1.TD001 = b1.TC001 AND c1.TD002 = b1.TC002
                                                        INNER JOIN INVMB g1 ON f1.TI004= g1.MB001
                                                        WHERE 1=1
                                                            AND c1.TD021 = 'Y' 
                                                            AND e1.TA013 = 'Y'
                                                            AND f1.TI001 = '5901'";
                                                        if (!string.IsNullOrEmpty(CustomerNo))
                                                        {
                                                            mainSql += " AND b1.TC004 IN @CustomerNo";
                                                        }
                                                        if (!string.IsNullOrEmpty(ProductModel))
                                                        {
                                                            mainSql += " AND (c1.TD004 LIKE '%' + @ProductModel + '%' OR g1.MB002 LIKE '%' + @ProductModel + '%')";
                                                        }

                                                    mainSql += @" GROUP BY f1.TI004,g1.MB002,g1.MB003
                                                                    ) f ON f.TI004 = d.MB001
                                            LEFT JOIN (SELECT a2.TG004,e1.MB002,e1.MB003,SUM(a2.TG009)ProvisionalQty
                                                        FROM INVTG a2
                                                        LEFT JOIN COPTD b2 ON b2.TD001=a2.TG014 AND b2.TD002=a2.TG015 AND b2.TD003=a2.TG016
                                                        INNER JOIN COPTC c2 ON b2.TD001 = c2.TC001 AND b2.TD002 = c2.TC002
                                                        INNER JOIN INVMB e1 ON a2.TG004= e1.MB001
                                                        WHERE a2.TG022='Y'
                                                                AND a2.TG001 IN ('1301','1302')";
                                                        if (!string.IsNullOrEmpty(CustomerNo))
                                                        {
                                                            mainSql += " AND c2.TC004 IN @CustomerNo";
                                                        }
                                                        if (!string.IsNullOrEmpty(ProductModel))
                                                        {
                                                            mainSql += " AND (b2.TD004 LIKE '%' + @ProductModel + '%' OR e1.MB002 LIKE '%' + @ProductModel + '%')";
                                                        }

                                                    mainSql += @" GROUP BY a2.TG004,e1.MB002,e1.MB003) g ON g.TG004=d.MB001
                                            LEFT JOIN (SELECT a3.TH004,e1.MB002,e1.MB003,SUM(a3.TH008)SalesOrderQty
                                                    FROM COPTH a3
                                                    LEFT JOIN COPTD b3 ON b3.TD001=a3.TH014 AND b3.TD002=a3.TH015 AND b3.TD003=a3.TH016
                                                    INNER JOIN COPTC c3 ON b3.TD001 = c3.TC001 AND b3.TD002 = c3.TC002
                                                    INNER JOIN INVMB e1 ON a3.TH004= e1.MB001
                                                    WHERE a3.TH020='Y'
                                                         AND a3.TH001 IN ('2301','2302')";
                                                    if (!string.IsNullOrEmpty(CustomerNo))
                                                    {
                                                        mainSql += " AND c3.TC004 IN @CustomerNo";
                                                    }
                                                    if (!string.IsNullOrEmpty(ProductModel))
                                                    {
                                                        mainSql += " AND (b3.TD004 LIKE '%' + @ProductModel + '%' OR e1.MB002 LIKE '%' + @ProductModel + '%')";
                                                    }

                                                    mainSql += @" GROUP BY a3.TH004,e1.MB002,e1.MB003) h ON h.TH004=d.MB001
                                                                    WHERE 1=1";

                                                    string condition = "";
                                                    if (!string.IsNullOrEmpty(CustomerNo))
                                                    {
                                                        condition += " AND a.MA001 IN @CustomerNo";
                                                    }
                                                    if (!string.IsNullOrEmpty(ProductModel))
                                                    {
                                                        condition += " AND (c.TD004 LIKE '%' + @ProductModel + '%' OR d.MB002 LIKE '%' + @ProductModel + '%')";
                                                    }

                                    mainSql += condition;

                                    mainSql += @" GROUP BY a.MA001 ,a.MA002 ,a.MA003 ,c.TD004 ,d.MB002 ,d.MB003 ,f.InPutQty, g.ProvisionalQty, h.SalesOrderQty, d.MB004 ,e.ProductionQty";

                        string sql = mainSql + @" ORDER BY c.TD004 
                                                    OFFSET @PageSize * (@PageIndex - 1) ROWS
                                                    FETCH NEXT @PageSize ROWS ONLY;";

                        dynamicParameters.Add("CustomerNo", CustomerNo.Split(',').ToList());
                        dynamicParameters.Add("ProductModel", ProductModel);
                        dynamicParameters.Add("PageSize", PageSize);
                        dynamicParameters.Add("PageIndex", PageIndex);

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        // 計算總筆數
                        string countSql = "SELECT COUNT(1) FROM (" + mainSql + ") AS CountQuery";
                        var TotalCount = sqlConnection2.QuerySingle<int>(countSql, dynamicParameters);

                        return JsonConvert.SerializeObject(new
                        {
                            status = "success",
                            result,
                            TotalCount
                        });
                    }
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
                return JsonConvert.SerializeObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
            }
        }
        #endregion

        #region //GetSoDetailByMtlItem -- 訂單查詢頁面 -- Jean 2025.04.29
        public string GetSoDetailByMtlItem(string CustomerNo, string ProductModel
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    //if (CurrentCompany <= 0) CurrentCompany = 4;
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        string mainSql = @"SELECT a.MA001,b.TC001,b.TC002
                                            ,a.MA001 CustomerNo,a.MA002 CustomerShortName,a.MA003 CustomerName,c.TD004 MtlItemNo,d.MB002 MtlItemName,d.MB003 MtlItemSpec
                                            ,b.TC001+'-'+b.TC002 AS CustomerOrderNoPix 
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, b.TC003, 112), 23) CustomerOrderDate 
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, b.TC039, 112), 23) DocDate 
                                            ,ISNULL(SUM(c.TD008),0) CustomerOrderQty, c.TD010 UomNo  
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, c.TD013, 112), 23) EstimatedShipmentDate
                                            FROM COPMA a 
                                            INNER JOIN COPTC b ON a.MA001=b.TC004 
                                            INNER JOIN COPTD c ON b.TC001=c.TD001 AND b.TC002=c.TD002 AND c.TD021 = 'Y'   
                                            INNER JOIN INVMB d ON c.TD004=d.MB001
                                            WHERE 1=1";
                        if (!string.IsNullOrEmpty(CustomerNo))
                        {
                            mainSql += @" AND a.MA001 IN @CustomerNo";
                        }
                        if (!string.IsNullOrEmpty(ProductModel))
                        {
                            mainSql += @" AND (c.TD004 LIKE '%' + @ProductModel + '%' OR d.MB002 LIKE '%' + @ProductModel + '%')";
                        }

                        mainSql += @" GROUP BY a.MA001,a.MA002,a.MA003,c.TD004,d.MB002,d.MB003,b.TC001,b.TC002,b.TC003,c.TD013, b.TC039, c.TD010";

                        sql = mainSql + @" ORDER BY b.TC001+'-'+b.TC002
                                            OFFSET @PageSize * (@PageIndex - 1) ROWS
                                            FETCH NEXT @PageSize ROWS ONLY;";

                        dynamicParameters.Add("CustomerNo", CustomerNo.Split(',').ToList());
                        dynamicParameters.Add("ProductModel", ProductModel);
                        dynamicParameters.Add("PageSize", PageSize);
                        dynamicParameters.Add("PageIndex", PageIndex);

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        // 計算總筆數
                        string countSql = "SELECT COUNT(1) FROM (" + mainSql + ") AS CountQuery";
                        var TotalCount = sqlConnection2.QuerySingle<int>(countSql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result,
                            TotalCount
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProductionByMtlItem -- 生產歷程狀況 -- Jean 2025.04.29
        public string GetProductionByMtlItem(string ProductModel
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    //if (CurrentCompany <= 0) CurrentCompany = 4;
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    #endregion

                    string mainSql = @"SELECT e.MtlItemNo,e.MtlItemName,e.MtlItemSpec,a.WoErpPrefix+'-'+a.WoErpNo AS CustomerOrderNoPix 
                                        ,c.Quantity 
                                        ,ISNULL(m1.ReceiptQtySum,0)ReceiptQtySum 
                                        ,(CASE WHEN c.Status='N' THEN '新製令未開工' WHEN c.Status='A' THEN '加工中' WHEN c.Status='F' THEN '完工' END) AS ManOrderStatus 
                                        ,c.MoId
                                        ,(
                                            SELECT DISTINCT c1.SortNumber,c1.ProcessAlias,a1.BarcodeQty
                                            FROM MES.Barcode a1
                                            LEFT JOIN MES.BarcodeProcess b1 ON a1.CurrentMoProcessId=b1.MoProcessId
                                            LEFT JOIN MES.MoProcess c1 ON b1.MoProcessId=c1.MoProcessId
                                            WHERE a1.MoId = c.MoId
                                            ORDER BY c1.SortNumber
                                            FOR JSON PATH, ROOT('data')
                                            ) AS ProcessDetail
                                        FROM MES.WipOrder a
                                        INNER JOIN BAS.Company b ON a.CompanyId=b.CompanyId
                                        INNER JOIN MES.ManufactureOrder c ON a.WoId=c.WoId
                                        INNER JOIN PDM.MtlItem e ON a.MtlItemId=e.MtlItemId
                                        LEFT JOIN ( SELECT mw.MoId,SUM(mw.ReceiptQty)ReceiptQtySum
                                                    FROM MES.MweDetail mw 
                                                    GROUP BY mw.MoId
                                                    ) m1 ON m1.MoId=c.MoId
                                        WHERE ConfirmStatus='Y' 
                                            AND c.Status IN ('N','A')";
                    
                    if (!string.IsNullOrEmpty(ProductModel))
                    {
                        mainSql += @" AND (e.MtlItemNo LIKE '%' + @ProductModel + '%' OR e.MtlItemName LIKE '%' + @ProductModel + '%')";
                    }
                    
                    sql = mainSql + @" ORDER BY a.WoErpPrefix+'-'+a.WoErpNo
                                            OFFSET @PageSize * (@PageIndex - 1) ROWS
                                            FETCH NEXT @PageSize ROWS ONLY;";
                   
                    dynamicParameters.Add("ProductModel", ProductModel);
                    dynamicParameters.Add("PageSize", PageSize);
                    dynamicParameters.Add("PageIndex", PageIndex);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    // 計算總筆數
                    string countSql = "SELECT COUNT(1) FROM (" + mainSql + ") AS CountQuery";
                    var TotalCount = sqlConnection.QuerySingle<int>(countSql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result,
                        TotalCount
                    });
                    #endregion
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProductionStockInByMtlItem -- 生產入庫資料查詢 -- Jean 2025.04.29
        public string GetProductionStockInByMtlItem(string CustomerNo, string ProductModel
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    //if (CurrentCompany <= 0) CurrentCompany = 4;
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        string mainSql = @"SELECT c.TH001+'-'+c.TH002 AS MweErpNoPix 
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, c.TH029, 112), 23)MweErpDocDate 
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, c.TH003, 112), 23)MweErpReceiptDate 
                                            ,ISNULL(SUM(b.TI007),0) ReceiptQty 
                                            ,h.MC001 InventoryNo, h.MC002  InventoryName
                                            ,g.MA001 CustomerNo,g.MA002 CustomerShortName,g.MA003 CustomerName
                                            ,a.TA006 MtlItemNo,d.MB002 MtlItemName,d.MB003 MtlItemSpec
                                            FROM MOCTA a 
                                            LEFT JOIN MOCTI b ON a.TA001=b.TI013 AND a.TA002=b.TI014 
                                            LEFT JOIN MOCTH c ON b.TI001=c.TH001 AND b.TI002=c.TH002
                                            INNER JOIN INVMB d ON a.TA006=d.MB001
                                            LEFT JOIN COPTD e ON a.TA026=e.TD001 AND a.TA027=e.TD002 AND a.TA028=e.TD003
                                            LEFT JOIN COPTC f ON f.TC001=e.TD001 AND f.TC002=e.TD002
                                            INNER JOIN COPMA g ON g.MA001=f.TC004
                                            INNER JOIN CMSMC h ON b.TI009=h.MC001
                                            WHERE 1=1
                                            AND b.TI037='Y'
                                            AND a.TA013='Y'
                                            AND b.TI001 = '5901'";
                        if (!string.IsNullOrEmpty(CustomerNo))
                        {
                            mainSql += @" AND g.MA001 IN @CustomerNo";
                        }
                        if (!string.IsNullOrEmpty(ProductModel))
                        {
                            mainSql += @" AND (a.TA006 LIKE '%' + @ProductModel + '%' OR d.MB002 LIKE '%' + @ProductModel + '%')";
                        }

                        mainSql += @" GROUP BY c.TH001,c.TH002,c.TH029,c.TH003,h.MC002,g.MA001,g.MA002,g.MA003,a.TA006,d.MB002,d.MB003, h.MC001";

                        sql = mainSql + @" ORDER BY c.TH001+'-'+c.TH002
                                            OFFSET @PageSize * (@PageIndex - 1) ROWS
                                            FETCH NEXT @PageSize ROWS ONLY;";

                        dynamicParameters.Add("CustomerNo", CustomerNo.Split(',').ToList());
                        dynamicParameters.Add("ProductModel", ProductModel);
                        dynamicParameters.Add("PageSize", PageSize);
                        dynamicParameters.Add("PageIndex", PageIndex);

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        // 計算總筆數
                        string countSql = "SELECT COUNT(1) FROM (" + mainSql + ") AS CountQuery";
                        var TotalCount = sqlConnection2.QuerySingle<int>(countSql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result,
                            TotalCount
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetTempShippingNoteByMtlItem -- 暫出單資料查詢 -- Jean 2025.04.29
        public string GetTempShippingNoteByMtlItem(string CustomerNo, string ProductModel
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    //if (CurrentCompany <= 0) CurrentCompany = 4;
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        string mainSql = @"SELECT b.TF001+'-'+b.TF002 AS ProvisionalOrderNoPix 
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, b.TF024, 112), 23)ProvisionalDocDate 
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, b.TF003, 112), 23)ProvisionalOrderDate 
                                            ,ISNULL(SUM(a.TG009),0) ProvisionalOrderQty 
                                            ,h.MC001 InventoryNo, h.MC002  InventoryName
                                            ,g.MA001 CustomerNo,g.MA002 CustomerShortName,g.MA003 CustomerName
                                            ,a.TG004 MtlItemNo,c.MB002 MtlItemName,c.MB003 MtlItemSpec
                                            FROM INVTG a
                                            LEFT JOIN INVTF b ON a.TG001=b.TF001 AND a.TG002=b.TF002
                                            INNER JOIN INVMB c ON a.TG004=c.MB001
                                            LEFT JOIN COPTD e ON a.TG014=e.TD001 AND a.TG015=e.TD002 AND a.TG016=e.TD003
                                            LEFT JOIN COPTC f ON f.TC001=e.TD001 AND f.TC002=e.TD002
                                            INNER JOIN COPMA g ON g.MA001=f.TC004
                                            INNER JOIN CMSMC h ON a.TG007=h.MC001
                                            WHERE 1=1
                                            AND a.TG022='Y'
                                            AND e.TD021='Y'
                                            AND a.TG001 IN ('1301','1302')";
                        if (!string.IsNullOrEmpty(CustomerNo))
                        {
                            mainSql += @" AND g.MA001 IN @CustomerNo";
                        }
                        if (!string.IsNullOrEmpty(ProductModel))
                        {
                            mainSql += @" AND (a.TG004 LIKE '%' + @ProductModel + '%' OR c.MB002 LIKE '%' + @ProductModel + '%')";
                        }

                        mainSql += @" GROUP BY b.TF001,b.TF002,b.TF024,b.TF003,h.MC002,g.MA001,g.MA002,g.MA003,a.TG004,c.MB002,c.MB003,h.MC001";

                        sql = mainSql + @" ORDER BY b.TF001+'-'+b.TF002
                                            OFFSET @PageSize * (@PageIndex - 1) ROWS
                                            FETCH NEXT @PageSize ROWS ONLY;";

                        dynamicParameters.Add("CustomerNo", CustomerNo.Split(',').ToList());
                        dynamicParameters.Add("ProductModel", ProductModel);
                        dynamicParameters.Add("PageSize", PageSize);
                        dynamicParameters.Add("PageIndex", PageIndex);

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        // 計算總筆數
                        string countSql = "SELECT COUNT(1) FROM (" + mainSql + ") AS CountQuery";
                        var TotalCount = sqlConnection2.QuerySingle<int>(countSql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result,
                            TotalCount
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetShippingOrderByMtlItem -- 銷貨單資料查詢 -- Jean 2025.04.29
        public string GetShippingOrderByMtlItem(string CustomerNo, string ProductModel
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    //if (CurrentCompany <= 0) CurrentCompany = 4;
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {
                        string mainSql = @"SELECT b.TG001+'-'+b.TG002 AS ProvisionalOrderNoPix 
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, b.TG042, 112), 23)ProvisionalDocDate 
                                            ,CONVERT(VARCHAR(10), CONVERT(DATE, b.TG003, 112), 23)ProvisionalOrderDate 
                                            ,ISNULL(SUM(a.TH008),0) ProvisionalOrderQty 
                                            ,h.MC001 InventoryNo, h.MC002  InventoryName
                                            ,g.MA001 CustomerNo,g.MA002 CustomerShortName,g.MA003 CustomerName
                                            ,a.TH004 MtlItemNo,c.MB002 MtlItemName,c.MB003 MtlItemSpec
                                            FROM COPTH a
                                            LEFT JOIN COPTG b ON a.TH001=b.TG001 AND a.TH002=b.TG002
                                            INNER JOIN INVMB c ON a.TH004=c.MB001
                                            LEFT JOIN COPTD e ON a.TH014=e.TD001 AND a.TH015=e.TD002 AND a.TH016=e.TD003
                                            LEFT JOIN COPTC f ON f.TC001=e.TD001 AND f.TC002=e.TD002
                                            INNER JOIN COPMA g ON g.MA001=f.TC004
                                            INNER JOIN CMSMC h ON a.TH007=h.MC001
                                            WHERE 1=1
                                            AND a.TH020='Y'
                                            AND e.TD021='Y'
                                            AND a.TH001 IN ('2301','2302')";
                        if (!string.IsNullOrEmpty(CustomerNo))
                        {
                            mainSql += @" AND g.MA001 IN @CustomerNo";
                        }
                        if (!string.IsNullOrEmpty(ProductModel))
                        {
                            mainSql += @" AND (a.TH004 LIKE '%' + @ProductModel + '%' OR c.MB002 LIKE '%' + @ProductModel + '%')";
                        }

                        mainSql += @" GROUP BY b.TG001,b.TG002,b.TG042,b.TG003,h.MC002,g.MA001,g.MA002,g.MA003,a.TH004,c.MB002,c.MB003,h.MC001";

                        sql = mainSql + @" ORDER BY b.TG001+'-'+b.TG002
                                            OFFSET @PageSize * (@PageIndex - 1) ROWS
                                            FETCH NEXT @PageSize ROWS ONLY;";

                        dynamicParameters.Add("CustomerNo", CustomerNo.Split(',').ToList());
                        dynamicParameters.Add("ProductModel", ProductModel);
                        dynamicParameters.Add("PageSize", PageSize);
                        dynamicParameters.Add("PageIndex", PageIndex);

                        var result = sqlConnection2.Query(sql, dynamicParameters);

                        // 計算總筆數
                        string countSql = "SELECT COUNT(1) FROM (" + mainSql + ") AS CountQuery";
                        var TotalCount = sqlConnection2.QuerySingle<int>(countSql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result,
                            TotalCount
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPurchasePriceTrend 商品採購單價漲跌記錄 Shintokuro 2025-05-18
        public string GetPurchasePriceTrend(string MtlItemNo, string MtlItemName, string SupplierNo
            , string PriceDown, string PriceUp, string PriceKeep
            , string ChooseStartDate, string ChooseEndDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                string MESCompanyNo = "";
                string ErpDb = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        MESCompanyNo = item.ErpNo;
                        ErpDb = item.ErpDb;
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    var lastYear = DateTime.Now.Year - 1;
                    string startDate = new DateTime(lastYear, 1, 1).ToString("yyyyMMdd");
                    string endDate = new DateTime(lastYear, 12, 31).ToString("yyyyMMdd");

                    #region //托外單交期追蹤
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.TC001,a.TC002,a1.TD003";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a1.TD001+'-'+a1.TD002+'-'+a1.TD003 OderFull,a.TC004 +':'+a2.MA002 Supplier
                           ,a1.TD004 MtlItemNo,a1.TD005 MtlItemName,a1.TD010 price,a1.TD008 Qty
                           ,a1.TD010*a1.TD008 nowCost ,y1.TD010 lastPrice
                           ,y1.TD010*a1.TD008 lastCost
                           ,a1.TD010*a1.TD008 -  y1.TD010*a1.TD008 diffCost 
                           ";
                    sqlQuery.mainTables =
                        @"FROM PURTC a
                          INNER JOIN PURTD a1 on a.TC001 = a1.TD001 AND a.TC002 = a1.TD002  
                          INNER JOIN PURMA a2 on a.TC004 = a2.MA001  
                          OUTER APPLY (
                              SELECT TOP 1 x2.TD010
                              FROM PURTC x1
                              INNER JOIN PURTD x2 ON x1.TC001 = x2.TD001 AND x1.TC002 = x2.TD002  
                              WHERE 1=1 
                              AND x1.TC003 BETWEEN @startDate AND @endDate 
                              AND x1.TC004 = a.TC004 
                              AND x2.TD004 = a1.TD004
                              ORDER BY TC003 DESC
                          ) y1
                          ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a1.TD018 = 'Y'";
                    dynamicParameters.Add("startDate", startDate);
                    dynamicParameters.Add("endDate", endDate);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND a1.TD004 LIKE '%' + @MtlItemNo +'%' ", MtlItemNo);//托外單	
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND a1.TD005 LIKE  '%' + @MtlItemName +'%'", MtlItemName);//托外單	
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SupplierNo", @" AND a.TC004 = @SupplierNo", SupplierNo);//供應商編號

                    if(PriceUp.Length > 0 && PriceKeep.Length > 0 && PriceDown.Length > 0)
                    {

                    }
                    else if (PriceUp.Length > 0 && PriceKeep.Length > 0)
                    {
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PriceDown", @" AND a1.TD010*a1.TD008 -  y1.TD010*a1.TD008 >=0", PriceDown);

                    }
                    else if (PriceKeep.Length > 0 && PriceDown.Length > 0)
                    {
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PriceDown", @" AND a1.TD010*a1.TD008 -  y1.TD010*a1.TD008 <=0", PriceDown);

                    }
                    else if (PriceUp.Length > 0  && PriceDown.Length > 0)
                    {
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PriceDown", @" AND a1.TD010*a1.TD008 -  y1.TD010*a1.TD008 !=0", PriceDown);

                    }
                    else if (PriceDown.Length > 0)
                    {
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PriceDown", @" AND a1.TD010*a1.TD008 -  y1.TD010*a1.TD008 <0", PriceDown);
                    }
                    else if (PriceUp.Length > 0)
                    {
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PriceUp", @" AND a1.TD010*a1.TD008 -  y1.TD010*a1.TD008 >0", PriceUp);
                    }
                    else if (PriceKeep.Length > 0)
                    {
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PriceKeep", @" AND a1.TD010*a1.TD008 -  y1.TD010*a1.TD008 =0", PriceKeep);
                    }

                    if (!string.IsNullOrEmpty(ChooseStartDate) && !string.IsNullOrEmpty(ChooseEndDate))
                    {
                        DateTime start = Convert.ToDateTime(ChooseStartDate).Date; // 2025-05-01 00:00:00
                        DateTime end = Convert.ToDateTime(ChooseEndDate).Date.AddDays(1).AddSeconds(-1); // 2025-05-01 23:59:59

                        string startDateStr = start.ToString("yyyyMMdd");  // 例如: "20250501"
                        string endDateStr = end.ToString("yyyyMMdd");      // 例如: "20250501"

                        queryCondition += " AND a.TC003 BETWEEN @ChooseStartDate AND @ChooseEndDate ";
                        dynamicParameters.Add("ChooseStartDate", startDateStr);
                        dynamicParameters.Add("ChooseEndDate", endDateStr);
                    }

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.TC004,a.TC003 DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);


                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetPurchasePriceTrendSummary 商品採購單價漲跌記錄(彙總) Shintokuro 2025-05-18
        public string GetPurchasePriceTrendSummary(string PoPrefix, string SupplierNo)
        {
            try
            {
                string MESCompanyNo = "";
                string ErpDb = "";

                string PoPrefixStr = "";
                string SupplierStr = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        MESCompanyNo = item.ErpNo;
                        ErpDb = item.ErpDb;
                    }
                    #endregion
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    if (PoPrefix.Length > 0)
                    {
                        if (PoPrefix == "3302" || PoPrefix == "3308")
                        {
                            PoPrefixStr = $" AND a.TC001 in ( '3302','3308')";
                        }
                        else
                        {
                            PoPrefixStr = $" AND a.TC001 = '{PoPrefix}'";
                        }
                    }
                    if (SupplierNo.Length > 0)
                    {
                        SupplierStr = $" AND a.TC004 = '{SupplierNo}'";
                    }

                    #region //採購單資料彙總
                    dynamicParameters = new DynamicParameters();
                    sql = $@"
                                SELECT 
                                    m.YearMonth,
                                    FORMAT(ROUND(ISNULL(d.diffCostSum, 0)* 100, 2), 'N2') AS diffCostSum,
                                    CASE 
                                        WHEN d.diffCostPer IS NULL THEN '0'
                                        ELSE FORMAT(ROUND(d.diffCostPer * 100, 2), 'N2') + '%'
                                    END AS diffCostPer
                                FROM (
                                    SELECT 
                                        v.YearMonth
                                    FROM (VALUES 
                                        (FORMAT(GETDATE(), 'yyyy') + '01'),
                                        (FORMAT(GETDATE(), 'yyyy') + '02'),
                                        (FORMAT(GETDATE(), 'yyyy') + '03'),
                                        (FORMAT(GETDATE(), 'yyyy') + '04'),
                                        (FORMAT(GETDATE(), 'yyyy') + '05'),
                                        (FORMAT(GETDATE(), 'yyyy') + '06'),
                                        (FORMAT(GETDATE(), 'yyyy') + '07'),
                                        (FORMAT(GETDATE(), 'yyyy') + '08'),
                                        (FORMAT(GETDATE(), 'yyyy') + '09'),
                                        (FORMAT(GETDATE(), 'yyyy') + '10'),
                                        (FORMAT(GETDATE(), 'yyyy') + '11'),
                                        (FORMAT(GETDATE(), 'yyyy') + '12')
                                    ) v(YearMonth)
                                ) m
                                LEFT JOIN (
                                    SELECT 
                                        LEFT(a.TC003, 6) AS YearMonth,
                                        SUM((a1.TD010 - y1.TD010) * a1.TD008) AS diffCostSum,
                                        CASE 
                                            WHEN SUM(y1.TD010 * a1.TD008) = 0 THEN NULL
                                            ELSE SUM((a1.TD010 - y1.TD010) * a1.TD008) * 1.0 / SUM(y1.TD010 * a1.TD008)
                                        END AS diffCostPer
                                    FROM PURTC a 
                                    INNER JOIN PURTD a1 
                                        ON a.TC001 = a1.TD001 AND a.TC002 = a1.TD002 
                                    OUTER APPLY (
                                        SELECT TOP 1 x2.TD010
                                        FROM PURTC x1
                                        INNER JOIN PURTD x2 ON x1.TC001 = x2.TD001 AND x1.TC002 = x2.TD002  
                                        WHERE x1.TC003 BETWEEN CAST(YEAR(GETDATE()) - 1 AS VARCHAR) + '0101'AND CAST(YEAR(GETDATE()) - 1 AS VARCHAR) + '1231'
                                        AND x1.TC004 = a.TC004 
                                        AND x2.TD004 = a1.TD004
                                        ORDER BY x1.TC003 DESC
                                    ) y1
                                    WHERE a.TC003 BETWEEN FORMAT(GETDATE(), 'yyyy') + '0101' AND FORMAT(GETDATE(), 'yyyy') + '1231'
                                    AND y1.TD010 IS NOT NULL
                                    AND a1.TD010 != y1.TD010
                                    {PoPrefixStr}
                                    {SupplierStr}
                                    GROUP BY LEFT(a.TC003, 6)
                                ) d
                                ON m.YearMonth = d.YearMonth
                                ORDER BY m.YearMonth;
                        ";
                    dynamicParameters.Add("PoPrefix", PoPrefix.Length > 0 ? PoPrefix : null);
                    dynamicParameters.Add("SupplierNo", SupplierNo.Length > 0 ? SupplierNo : null);


                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");
                    #endregion


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetTransferDetailData 生產移轉明細資訊 
        public string GetTransferDetailData(int ModeId, string WoErpFullNo, string MtlItemName, string StartDate, string EndDate,
            int UserId, string BarcodeNo, string ProcessAlias, string ShopDesc, string MachineDesc, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                //List<TransferSummaryData> transferSummaryData = new List<TransferSummaryData>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                    FROM BAS.Company a
                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //搜尋生產移轉匯總資料
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeProcessId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", j.ModeName
                  , h.WoErpPrefix + '-' + h.WoErpNo WoErpFullNo
                  , g.WoSeq
                  , h.PlanQty
                  , e.ProcessAlias
                  , i.MtlItemName
                  , d.BarcodeNo
                  , f.StatusName
                  , a.StationQty
                  , a.PassQty
                  , a.NgQty
                  , a1.UserNo + ' ' + a1.UserName StartUser
                  , FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate
                  , a2.UserNo + ' ' + a2.UserName FinishUser
                  , FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                  , ISNULL(a.CycleTime, 0) CycleTime
                  , c.MachineDesc
                  , c1.ShopDesc
                  , ISNULL(ROUND(NULLIF(CONVERT(float, a.CycleTime), 0)/NULLIF(CONVERT(float, a.StationQty), 0), 2), 0) AvgCycleTimePerPiece
                  , b1.ShiftName
                  , ISNULL(t.TransferOutQty, 0) TransferOutQty
                  , ISNULL(t.TransferInQty, 0) TransferInQty
                  , CASE 
                      WHEN f.StatusName = '良品' 
                      THEN a.StationQty + ISNULL(t.TransferOutQty, 0) - ISNULL(t.TransferInQty, 0)
                      ELSE a.StationQty 
                    END OriginStationQty
                  , DATEPART(YEAR, a.FinishDate) FinishYear
                  , DATEPART(MONTH, a.FinishDate) FinishMonth
                  , DATEPART(DAY, a.FinishDate) FinishDay
                  
                  ";
                    sqlQuery.mainTables =
                        @"FROM (
                    SELECT 
                        COALESCE(o.BarcodeProcessId, i.BarcodeProcessId) AS BarcodeProcessId,
                        ISNULL(o.TransferOutQty, 0) AS TransferOutQty,
                        ISNULL(i.TransferInQty, 0) AS TransferInQty
                    FROM (
                        SELECT 
                            FromBarcodeProcessId AS BarcodeProcessId,
                            SUM(TransactionQty) AS TransferOutQty
                        FROM MES.BarcodeTransfer
                        GROUP BY FromBarcodeProcessId
                    ) o
                    FULL OUTER JOIN (
                        SELECT 
                            ToBarcodeProcessId AS BarcodeProcessId,
                            SUM(TransactionQty) AS TransferInQty
                        FROM MES.BarcodeTransfer
                        GROUP BY ToBarcodeProcessId
                    ) i ON o.BarcodeProcessId = i.BarcodeProcessId
                ) t
                RIGHT JOIN MES.BarcodeProcess a ON t.BarcodeProcessId = a.BarcodeProcessId
                INNER JOIN BAS.[User] a1 ON a1.UserId = a.StartUserId 
                LEFT JOIN BAS.[User] a2 ON a2.UserId = a.FinishUserId 
                LEFT JOIN MES.ProdModeShift b ON b.ModeShiftId = a.ModeShiftId 
                LEFT JOIN BAS.[Shift] b1 ON b1.ShiftId = b.ShiftId 
                LEFT JOIN MES.Machine c ON c.MachineId = a.MachineId 
                LEFT JOIN MES.WorkShop c1 ON c1.ShopId = c.ShopId 
                LEFT JOIN MES.Barcode d ON d.BarcodeId = a.BarcodeId 
                LEFT JOIN MES.MoProcess e ON e.MoProcessId = a.MoProcessId 
                LEFT JOIN MES.Process e1 ON e1.ProcessId = e.ProcessId 
                LEFT JOIN (SELECT * FROM BAS.[Status] WHERE StatusSchema = 'BarcodeProcess.ProdStatus') f ON f.StatusNo = a.ProdStatus 
                LEFT JOIN MES.ManufactureOrder g ON g.MoId = a.MoId 
                INNER JOIN MES.WipOrder h ON h.WoId = g.WoId 
                LEFT JOIN PDM.MtlItem i ON i.MtlItemId = h.MtlItemId 
                INNER JOIN MES.ProdMode j ON b.ModeId = j.ModeId
                  ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND c1.CompanyId = @CompanyId AND d.ParentBarcode IS NULL AND a2.UserId IS NOT NULL";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ModeId", @" AND j.ModeId = @ModeId", ModeId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND h.WoErpPrefix + '-' + h.WoErpNo LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND i.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessAlias", @" AND e.ProcessAlias LIKE '%' + @ProcessAlias + '%'", ProcessAlias);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopDesc", @" AND c1.ShopDesc LIKE '%' + @ShopDesc + '%'", ShopDesc);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineDesc", @" AND c.MachineDesc LIKE '%' + @MachineDesc + '%'", MachineDesc);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND d.BarcodeNo = @BarcodeNo", BarcodeNo);
                   // BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StatusName", @" AND f.StatusName = @StatusName", StatusName);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.FinishDate >= @StartDate ",
                        StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "2025-01-01 00:00:00");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.FinishDate <= @EndDate ",
                        EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserId", @" AND a2.UserId = @UserId", UserId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.FinishDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeBindingData 條碼綁定資訊 
        public string GetBarcodeBindingData(string MtlItemNo, string MtlItemName, string WoErpFullNo, string BatchBarcodeNo, string LensBarcodeNo, string ProcessAlias
            , string StartDate, string EndDate, string UserNo, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                    FROM BAS.Company a
                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //搜尋條碼綁定資訊
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", e.MtlItemNo
                  , e.MtlItemName
                  , b1.WoErpPrefix + '-' + b1.WoErpNo WoErpFullNo
                  , a2.BarcodeNo BatchBarcodeNo
                  , UPPER(a.BarcodeNo) LensBarcodeNo
                  , c.ProcessAlias
                  , FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate
                  , a2.BarcodeQty BatchBarcodeQty
                  , f.UserNo + f.UserName UserName
                  ";
                    sqlQuery.mainTables =
                        @"FROM MES.Barcode a
                          INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                          INNER JOIN MES.WipOrder b1 ON b.WoId = b1.WoId
                          INNER JOIN MES.MoProcess c ON a.CurrentMoProcessId = c.MoProcessId
                          INNER JOIN MES.Process d ON c.ProcessId = d.ProcessId
                          INNER JOIN PDM.MtlItem e ON b1.MtlItemId = e.MtlItemId
                          INNER JOIN MES.Barcode a2 ON a.ParentBarcode = a2.BarcodeId
                          INNER JOIN BAS.[User] f ON a.CreateBy = f.UserId
                  ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND a.ParentBarcode IS NOT NULL AND b1.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND e.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND e.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND b1.WoErpPrefix + '-' + b1.WoErpNo LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BatchBarcodeNo", @" AND a2.BarcodeNo LIKE '%' + @BatchBarcodeNo + '%'", BatchBarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "LensBarcodeNo", @" AND UPPER(a.BarcodeNo) LIKE '%' + UPPER(@LensBarcodeNo) + '%'", LensBarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessAlias", @" AND c.ProcessAlias LIKE '%' + @ProcessAlias + '%'", ProcessAlias);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserNo", @" AND (f.UserNo LIKE '%' + @UserNo + '%' OR f.UserName LIKE '%' + @UserNo + '%')", UserNo);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.CreateDate >= @StartDate ",
                        StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.CreateDate <= @EndDate ",
                        EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetAssembleRealTimeStatus 設備即時狀態 
        public string GetAssembleRealTimeStatus()
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(ETGAutomationConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"
                SELECT 
                    (Status_Update_Date + ' '+ Status_Update_Time)Update_Time,
                    MachineSN,
                    OperaterSN,
                    FlowCardSN1,
                    FlowCardSN2,
                    MMI_Version,
                    MC_Version,
                    Project_Name,
                    MMI_Open_Date,
                    MMI_Open_Time,
                    Machine_Status,
                    Finished_Quantity,
                    DiscardPart_Quantity,
                    Material_Quantity,
                    CircleTime,
                    TricoloredLight,
                    FORMAT(RecordTime, 'yyyy-MM-dd HH:mm:ss') AS RecordTime
                FROM vw_Assemble_RealTimeStatus
                WHERE 1=1
                ";

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineSN", @" AND MachineSN LIKE '%' + @MachineSN + '%'", MachineSN);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "OperaterSN", @" AND OperaterSN LIKE '%' + @OperaterSN + '%'", OperaterSN);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "FlowCardSN", @" AND (FlowCardSN1 LIKE '%' + @FlowCardSN + '%' OR FlowCardSN2 LIKE '%' + @FlowCardSN + '%')", FlowCardSN);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProjectName", @" AND Project_Name LIKE '%' + @ProjectName + '%'", ProjectName);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineStatus", @" AND Machine_Status = @MachineStatus", MachineStatus);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "StartDate", @" AND RecordTime >= @StartDate ",
                    //    StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "EndDate", @" AND RecordTime <= @EndDate ",
                    //    EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    // 添加排序
                    sql += " ORDER BY MachineSN";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetOspDetailSummary 托外單交期追蹤 Shintokuro 2025-05-18
        public string GetOspDetailSummary(string OspNo, string SupplierNo, string WoErpFullNo, string MtlItemNo, string MtlItemName
            , string OspCreatStartDate, string OspCreatEndDate, string Status, string DelayStatus, int UserId, int DepartmentId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //托外單交期追蹤
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "main.OspId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", main.* 
                            ,(
                                SELECT DISTINCT
                                    z5.MtlItemNo,
                                    z5.MtlItemName,
                                    z5.MtlItemSpec,
                                    z4.WoErpPrefix + '-' + z4.WoErpNo AS WoErpFull,
                                    y2.ProcessCodeNames
                                FROM MES.OutsourcingProduction z1
                                INNER JOIN MES.OspDetail z2 ON z1.OspId = z2.OspId
                                INNER JOIN MES.ManufactureOrder z3 ON z2.MoId = z3.MoId
                                INNER JOIN MES.WipOrder z4 ON z3.WoId = z4.WoId
                                INNER JOIN PDM.MtlItem z5 ON z4.MtlItemId = z5.MtlItemId
                                OUTER APPLY (
                                    SELECT x1.OspId, x2.MoId, STRING_AGG(x2.ProcessCodeName, ',') AS ProcessCodeNames
                                    FROM MES.OutsourcingProduction x1
                                    INNER JOIN MES.OspDetail x2 ON x1.OspId = x2.OspId
                                    WHERE x1.OspId = z1.OspId AND x2.MoId = z2.MoId
                                    GROUP BY x1.OspId, x2.MoId
                                ) y2
                                WHERE z1.OspId = main.OspId
                                FOR JSON PATH
                            ) AS DetailsJson
                            ";
                    sqlQuery.mainTables =
                        @"FROM
                            (
                            SELECT DISTINCT a.OspId,
                            a.OspNo
                            ,CONVERT(varchar, a.OspDate, 23) AS OspDate
                            ,CONVERT(varchar, y3.ExpectedDate, 23) AS ExpectedDate
                            ,CONVERT(varchar, y5.ReceiptDate, 23) AS ReceiptDate
                            -- 是否結案欄位
                            ,CASE 
                                WHEN y1.Qty = ISNULL(y4.ReceiptQty, 0) 
                                    THEN 'Y'
                                ELSE 'N'
                            END AS CloseStatus,
                            -- 是否逾期欄位（無論是否結案，只要實際入庫日/今天 > 預計日，就視為逾期）
                            CASE 
                                WHEN y3.ExpectedDate < ISNULL(y5.ReceiptDate, CAST(GETDATE() AS DATE))
                                    THEN '逾期' + CAST(DATEDIFF(DAY, y3.ExpectedDate, ISNULL(y5.ReceiptDate, GETDATE())) AS VARCHAR) + '天'
                                ELSE '未逾期'
                            END AS DelayStatus
                            ,y1.Qty,y6.TrueQty
                            ,y4.ReceiptQty,y7.TrueReceiptQty
                            ,b.SupplierNo +':'+ b.SupplierName Supperlier,a1.UserNo + ' '+ a1.UserName CreateUser
                            ,b.SupplierNo
                            ,a.CreateBy
                            ,a.DepartmentId 
                            FROM MES.OutsourcingProduction a
                            INNER JOIN SCM.Supplier b on a.SupplierId = b.SupplierId
                            INNER JOIN BAS.[User] a1 on a.CreateBy = a1.UserId
                            INNER JOIN BAS.Department a2 on a1.DepartmentId = a2.DepartmentId
                            OUTER APPLY(
                                SELECT x1.OspId,SUM(x2.OspQty) Qty
                                FROM MES.OutsourcingProduction x1
                                INNER JOIN MES.OspDetail x2 on x1.OspId = x2.OspId
                                WHERE x1.OspId = a.OspId
                                GROUP BY  x1.OspId
                            ) y1
                            OUTER APPLY(
                                SELECT x1.OspId,x2.MoId,STRING_AGG(x2.ProcessCodeName, ',') AS ProcessCodeNames
                                FROM MES.OutsourcingProduction x1
                                INNER JOIN MES.OspDetail x2 on x1.OspId = x2.OspId
                                WHERE y1.OspId = x1.OspId
                                GROUP BY  x1.OspId,x2.MoId
                            ) y2
                            OUTER APPLY(
                                SELECT TOP 1 x2.ExpectedDate
                                FROM MES.OutsourcingProduction x1
                                INNER JOIN MES.OspDetail x2 on x1.OspId = x2.OspId
                                WHERE x1.OspId = a.OspId
                                ORDER BY x2.ExpectedDate DESC
                            ) y3
                            OUTER APPLY(
                                SELECT x1.OspId,SUM(x5.ReceiptQty) ReceiptQty
                                FROM MES.OutsourcingProduction x1
                                INNER JOIN MES.OspDetail x2 on x1.OspId = x2.OspId
                                INNER JOIN MES.ManufactureOrder x3 on x2.MoId = x3.MoId
                                INNER JOIN MES.WipOrder x4 on x3.WoId = x4.WoId
                                INNER JOIN MES.OspReceiptDetail x5 on x2.OspDetailId = x5.OspDetailId
                                WHERE a.OspId =x1.OspId
                                GROUP BY x1.OspId
                            ) y4
                            OUTER APPLY(
                                SELECT TOP 1 x6.ReceiptDate
                                FROM MES.OutsourcingProduction x1
                                INNER JOIN MES.OspDetail x2 on x1.OspId = x2.OspId
                                INNER JOIN MES.ManufactureOrder x3 on x2.MoId = x3.MoId
                                INNER JOIN MES.WipOrder x4 on x3.WoId = x4.WoId
                                INNER JOIN MES.OspReceiptDetail x5 on x2.OspDetailId = x5.OspDetailId
                                INNER JOIN MES.OspReceipt x6 on x5.OsrId = x6.OsrId
                                WHERE a.OspId =x1.OspId
                                ORDER BY x6.ReceiptDate DESC
                            ) y5
                            OUTER APPLY(
                                SELECT SUM(z.OspQty) AS TrueQty
                                FROM (
                                    SELECT DISTINCT x2.OspQty, x2.MoId
                                    FROM MES.OutsourcingProduction x1
                                    INNER JOIN MES.OspDetail x2 ON x1.OspId = x2.OspId
                                    WHERE a.OspId =x1.OspId
                                ) z 
                            ) y6
                            OUTER APPLY(
                                SELECT SUM(z.ReceiptQty) AS TrueReceiptQty  FROM (
                                    SELECT DISTINCT x5.ReceiptQty,x1.OspId,x2.MoId
                                    FROM MES.OutsourcingProduction x1
                                    INNER JOIN MES.OspDetail x2 on x1.OspId = x2.OspId
                                    INNER JOIN MES.ManufactureOrder x3 on x2.MoId = x3.MoId
                                    INNER JOIN MES.WipOrder x4 on x3.WoId = x4.WoId
                                    INNER JOIN MES.OspReceiptDetail x5 on x2.OspDetailId = x5.OspDetailId
                                    WHERE a.OspId =x1.OspId
                                ) z
                            ) y7
                            INNER JOIN MES.ManufactureOrder c on y2.MoId = c.MoId
                            INNER JOIN MES.WipOrder c1 on c.WoId = c1.WoId
                            INNER JOIN PDM.MtlItem c2 on c1.MtlItemId = c2.MtlItemId
                            WHERE 1=1
                            AND c1.CompanyId = @CompanyId
                            AND a.[Status] != 'V'
                            ) main
                          ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"";
                    dynamicParameters.Add("CompanyId", CurrentCompany);


                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspDate", @" AND  FORMAT(CONVERT(DATE,b.OspDate), 'yyyy-MM-dd') >= @OspDate", OspDate);//托外日
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspCreatDate", @" AND  FORMAT(CONVERT(DATE,b.CreateDate), 'yyyy-MM-dd') >= @OspDate", OspDate);//托外建單日
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspStartDate", @" AND b.OspDate >= @OspStartDate", OspStartDate.Length > 0 ? Convert.ToDateTime(OspStartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspEndDate", @" AND b.OspDate <= @OspEndDate", OspEndDate.Length > 0 ? Convert.ToDateTime(OspEndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "OspNo", @" AND main.OspNo = @OspNo", OspNo);//托外單	
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SupplierNo", @" AND main.SupplierNo = @SupplierNo", SupplierNo);//供應商編號
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CreateBy", @" AND main.CreateBy = @CreateBy", UserId);//供應商編號
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DepartmentId", @" AND main.DepartmentId = @DepartmentId", DepartmentId);//供應商編號
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @"
                      AND EXISTS (
                        SELECT 1
                        FROM MES.OutsourcingProduction z1
                        INNER JOIN MES.OspDetail z2 ON z1.OspId = z2.OspId
                        INNER JOIN MES.ManufactureOrder z3 ON z2.MoId = z3.MoId
                        INNER JOIN MES.WipOrder z4 ON z3.WoId = z4.WoId
                        INNER JOIN PDM.MtlItem z5 ON z4.MtlItemId = z5.MtlItemId
                        WHERE z1.OspId = main.OspId
                          AND z4.WoErpPrefix +'-'+z4.WoErpNo = @WoErpFullNo
                      )
                    ", WoErpFullNo);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @"
                      AND EXISTS (
                        SELECT 1
                        FROM MES.OutsourcingProduction z1
                        INNER JOIN MES.OspDetail z2 ON z1.OspId = z2.OspId
                        INNER JOIN MES.ManufactureOrder z3 ON z2.MoId = z3.MoId
                        INNER JOIN MES.WipOrder z4 ON z3.WoId = z4.WoId
                        INNER JOIN PDM.MtlItem z5 ON z4.MtlItemId = z5.MtlItemId
                        WHERE z1.OspId = main.OspId
                          AND z5.MtlItemNo = @MtlItemNo
                      )
                    ", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @"
                      AND EXISTS (
                        SELECT 1
                        FROM MES.OutsourcingProduction z1
                        INNER JOIN MES.OspDetail z2 ON z1.OspId = z2.OspId
                        INNER JOIN MES.ManufactureOrder z3 ON z2.MoId = z3.MoId
                        INNER JOIN MES.WipOrder z4 ON z3.WoId = z4.WoId
                        INNER JOIN PDM.MtlItem z5 ON z4.MtlItemId = z5.MtlItemId
                        WHERE z1.OspId = main.OspId
                          AND z5.MtlItemName = @MtlItemName
                      )
                    ", MtlItemName);
                    if (DelayStatus.Length > 0)
                    {
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DelayStatus", @" AND main.DelayStatus != '未逾期'", DelayStatus);
                    }
                    if (Status.Length > 0)
                    {
                        switch (Status)
                        {
                            case "N":
                                BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND main.CloseStatus = @Status", Status);
                                break;
                            case "Y":
                                BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND main.CloseStatus = @Status", Status);
                                break;
                            case "N,Y":
                                break;
                        }
                    }


                    if (!string.IsNullOrEmpty(OspCreatStartDate) && !string.IsNullOrEmpty(OspCreatEndDate))
                    {
                        DateTime start = Convert.ToDateTime(OspCreatStartDate).Date; // 2025-05-01 00:00:00
                        DateTime end = Convert.ToDateTime(OspCreatEndDate).Date.AddDays(1).AddSeconds(-1); // 2025-05-01 23:59:59

                        queryCondition += " AND main.OspDate BETWEEN @OspCreatStartDate AND @OspCreatEndDate ";
                        dynamicParameters.Add("OspCreatStartDate", start);
                        dynamicParameters.Add("OspCreatEndDate", end);
                    }

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "main.OspDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);


                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion


                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetLCMObsoleteStockProvisionDetail -- JC實時庫存LCM呆滯提列  Jean 2025.05.30
        public string GetLCMObsoleteStockProvisionDetail(string MtlItemNo
            , string AccountingCategoryNo, string WarehouseCategoryNo, string BusinessCategoryNo, string ManagementCategoryNo
            , string OrderBy, int PageIndex, int PageSize, int RedirectType)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                    {

                        #region
                        
                        string mainSql = @"
                                    SELECT B.MB001 AS ItemID ,B.MB002 AS ItemName,B.MB003 AS ItemSpec, B.MB004 AS InventoryUnit, 
	                                    C.MC007 AS InventoryQty, ROUND(C.MC008,2) AS InventoryAmount, ROUND(C.MC008/C.MC007,2) AS UnitCost,
	                                    C.MC002 AS InventoryNo,WH.MC002 AS InventoryName, C.MC003 AS StorageLocation, 
	                                    CASE 
		                                    WHEN (C.MC002='A05' OR C.MC002='A06' OR C.MC002='A09' OR C.MC002='A10' OR C.MC002='A14' OR C.MC002='D01') 
				                                    THEN '呆滯全提'

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 THEN '30天以內'
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30	THEN '30天以內'
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30	THEN '30天以內'
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30	THEN '30天以內'

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN '31-90天'
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN '31-90天'
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN '31-90天'
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN '31-90天'

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN '91-180天'
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN '91-180天'	
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN '91-180天'
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN '91-180天'	

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN '181-270天'
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN '181-270天'	
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN '181-270天'
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN '181-270天'	

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(DAY,C.MC012,GETDATE())<=360	THEN '271-360天'
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(DAY,C.MC013,GETDATE())<=360	THEN '271-360天'	
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(DAY,C.MC012,GETDATE())<=360	THEN '271-360天'
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(DAY,C.MC013,GETDATE())<=360	THEN '271-360天'	

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>360 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN '361天-2年'
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>360 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN '361天-2年'
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>360 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN '361天-2年'
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>360 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN '361天-2年'

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN '2年-3年'
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN '2年-3年'
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN '2年-3年'
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN '2年-3年'

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 THEN '3年以上'
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 THEN '3年以上'
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 THEN '3年以上'
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 THEN '3年以上'

	                                    END AS InventoryAgeCondition,

	                                    CASE 
		                                    WHEN (C.MC002='A05' OR C.MC002='A06' OR C.MC002='A09' OR C.MC002='A10' OR C.MC002='A14' OR C.MC002='D01') 
				                                    THEN ROUND(C.MC008,2)*1

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' THEN ROUND(C.MC008,2)*0
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' THEN ROUND(C.MC008,2)*0
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' THEN ROUND(C.MC008,2)*0
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' THEN ROUND(C.MC008,2)*0

		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN ROUND(C.MC008,2)*0
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN ROUND(C.MC008,2)*0
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN ROUND(C.MC008,2)*0
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN ROUND(C.MC008,2)*0

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN ROUND(C.MC008,2)*0.05
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN ROUND(C.MC008,2)*0.05
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN ROUND(C.MC008,2)*0.05
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN ROUND(C.MC008,2)*0.05

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)*0
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)*0
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)*0
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)*0

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)*0.05
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)*0.05
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)*0.05
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)*0.05

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)*0.1

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)*0
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)*0	
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)*0
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)*0

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.1

		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.2
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.2
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.2
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.2

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.5
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.5
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.5
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)*0.5

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)*0
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)*0
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)*0
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)*0

		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)*0.5
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)*0.5
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)*0.5
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)*0.5

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)*0.8
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)*0.8
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)*0.8
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)*0.8

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN ROUND(C.MC008,2)*0.1
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN ROUND(C.MC008,2)*0.1

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN ROUND(C.MC008,2)*1

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN ROUND(C.MC008,2)*0.4
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN ROUND(C.MC008,2)*0.4
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN ROUND(C.MC008,2)*0.4
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN ROUND(C.MC008,2)*0.4

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN ROUND(C.MC008,2)*1

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 THEN ROUND(C.MC008,2)*1
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 THEN ROUND(C.MC008,2)*1

	                                    END AS StagnantProvisionAmt,

	                                    CASE 
		                                    WHEN (C.MC002='A05' OR C.MC002='A06' OR C.MC002='A09' OR C.MC002='A10' OR C.MC002='A14' OR C.MC002='D01') 
				                                    THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)

		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05)
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05)
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05)
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05)

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)

		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2)

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5)
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5)
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5)
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0)

		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5)

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8)
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8)
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8)
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 THEN ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1)

	                                    END AS InventoryNetAmount,

	                                    CASE 
		                                    WHEN (C.MC002='A05' OR C.MC002='A06' OR C.MC002='A09' OR C.MC002='A10' OR C.MC002='A14' OR C.MC002='D01') 
				                                    THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007

		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007

		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007

		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 THEN (ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007

	                                    END AS InventoryNetPrice,
	
	                                    CASE WHEN DD.TC016='1' THEN '內含'
		                                    WHEN DD.TC016='2' THEN '外加'
		                                    WHEN DD.TC016='3' THEN '零稅率'
		                                    WHEN DD.TC016='4' THEN '免稅'
		                                    WHEN DD.TC016='9' THEN '不計稅'	ELSE '' END AS TaxType, 
		                                    ISNULL(DD.TC008,'') AS CurrencyType,DD.TC009 AS ExRate, DD.TC041 AS BusinessTaxRate,
	                                    DD.TD011 AS RecentOrderPrice,
	                                    CASE WHEN DD.TC016='1' THEN DD.TD011/(1+DD.TC041)
		                                    WHEN DD.TC016='2' THEN DD.TD011*1
		                                    WHEN DD.TC016='3' THEN DD.TD011*DD.TC009
		                                    WHEN DD.TC016='4' THEN DD.TD011*DD.TC009 ELSE DD.TD011 END AS RecentOrdLocCurExTaxPrice,
	                                    CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
		                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
		                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
		                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END AS NetRealizablePrice,

	                                    CASE 
		                                    WHEN (C.MC002='A05' OR C.MC002='A06' OR C.MC002='A09' OR C.MC002='A10' OR C.MC002='A14' OR C.MC002='D01') 
				                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
							                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
							                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
							                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)

		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				/*101*/
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007)
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007)
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007)
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007)

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				/*102,103,106*/
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					/*105*/
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					/*101*/
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)

		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					/*103,106*/
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007)

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					/*102*/
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007)
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007)
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007)
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007)

		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007)

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007)
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007)
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007)
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				/*105*/ 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 
					                                    THEN (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007)
	                                    END AS UnitPriceVariance,

	                                    CASE 
		                                    WHEN (C.MC002='A05' OR C.MC002='A06' OR C.MC002='A09' OR C.MC002='A10' OR C.MC002='A14' OR C.MC002='D01') 
				                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
							                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
							                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
							                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)

		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)

		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.05))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.05))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.05))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.05))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.05))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.05))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.05))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.05))/C.MC007))*C.MC007,2)

		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)

		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.2))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.2))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.2))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.2))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.5))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.5))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.5))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.5))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0))/C.MC007))*C.MC007,2)

		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.5))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.5))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.5))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.5))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.8))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.8))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.8))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.8))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.1))/C.MC007))*C.MC007,2)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)

		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.4))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.4))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.4))/C.MC007))*C.MC007,2)
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*0.4))/C.MC007))*C.MC007,2)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)

		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 
					                                    THEN ROUND(((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((C.MC008-(C.MC008*1))/C.MC007))*C.MC007,2)
	                                    END AS VarianceAmount,

	                                    CASE 
		                                    WHEN (C.MC002='A05' OR C.MC002='A06' OR C.MC002='A09' OR C.MC002='A10' OR C.MC002='A14' OR C.MC002='D01') 
				                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
							                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
							                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
							                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN C.MC013='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN C.MC012='' AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN C.MC012>=C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN C.MC012<C.MC013 AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())<=30 OR B.MB005='104' 
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='105') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                      ELSE '' END)					
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>30 AND DATEDIFF(DAY,C.MC012,GETDATE())<=90	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>30 AND DATEDIFF(DAY,C.MC013,GETDATE())<=90	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.05))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>90 AND DATEDIFF(DAY,C.MC012,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>90 AND DATEDIFF(DAY,C.MC013,GETDATE())<=180	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='101' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='101' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='101' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='101' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.2))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')					
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>180 AND DATEDIFF(DAY,C.MC012,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>180 AND DATEDIFF(DAY,C.MC013,GETDATE())<=270
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.5))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='102' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 				
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='102' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='102' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC012,GETDATE())>270 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='102' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(DAY,C.MC013,GETDATE())>270 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=1	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.8))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>1 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=2	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>1 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=2	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN B.MB005='105' AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*0.4))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>2 AND DATEDIFF(YEAR,C.MC012,GETDATE())<=3	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>2 AND DATEDIFF(YEAR,C.MC013,GETDATE())<=3	
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC013='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01')  				
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012='' 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012>=C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC012,GETDATE())>3 
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
		                                    WHEN (B.MB005='101' OR B.MB005='102' OR B.MB005='103' OR B.MB005='105' OR B.MB005='106') AND C.MC012<C.MC013 
				                                    AND (C.MC002<>'A05' AND C.MC002<>'A06' AND C.MC002<>'A09' AND C.MC002<>'A10' AND C.MC002<>'A14' AND C.MC002<>'D01') 
				                                    AND DATEDIFF(YEAR,C.MC013,GETDATE())>3 
					                                    THEN (CASE WHEN (((CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)-((ROUND(C.MC008,2)-(ROUND(C.MC008,2)*1))/C.MC007))*C.MC007)<0
						                                     AND
						                                     (CASE WHEN DD.TC016='1' THEN (DD.TD011/(1+DD.TC041))*0.95
								                                    WHEN DD.TC016='2' THEN (DD.TD011*1)*0.95
								                                    WHEN DD.TC016='3' THEN (DD.TD011*DD.TC009)*0.95
								                                    WHEN DD.TC016='4' THEN (DD.TD011*DD.TC009)*0.95 ELSE DD.TD011*0.95 END)>0 THEN '計提LCM備抵損失'
						                                     ELSE '' END)					
	                                    END AS Decision,
	                                    B.MB005 AS AccountingCategoryNo, ISNULL(B1.MA1,'') AS AccountingCategoryName,B.MB006 AS WarehouseCategoryNo, ISNULL(B1.MA2,'') AS WarehouseCategoryName, 
	                                    B.MB007 AS BusinessCategoryNo, ISNULL(B1.MA3,'') AS BusinessCategoryName,B.MB008 AS ManagementCategoryNo, ISNULL(B1.MA4,'') AS ManagementCategoryName,
	                                    B.CREATE_DATE AS ProductCreatDate, B.CREATOR AS ProductCreatNo, ISNULL(V3.MV002,A3.MF002) AS ProductCreatName,
	                                    B.MODI_DATE AS ProductUpdateDate, B.MODIFIER AS ProductUpdateNo, ISNULL(V4.MV002,A4.MF002) AS ProductUpdateName,
	                                    C.MC012 AS  ReWarInDate, C.MC013 AS ReWarOutDate, 
	                                    C.CREATE_DATE AS ReWarCreatDate, C.CREATOR AS ReWarCreatNo, ISNULL(V1.MV002,A1.MF002) AS ReWarCreatName,
	                                    C.MODI_DATE AS ReWarUpdateDate,C.MODIFIER AS ReWarUpdateNo,ISNULL(V2.MV002,A2.MF002) AS ReWarUpdateName,
	                                    B.MB030 AS ProductEffectiveDate, B.MB031 AS ProductExpiryDate
                                    FROM INVMC C
	                                    LEFT JOIN INVMB B ON B.MB001=C.MC001
	                                    LEFT JOIN CMSMC WH ON C.MC002=WH.MC001
	                                    LEFT JOIN CMSMV V1 ON C.CREATOR=V1.MV001
	                                    LEFT JOIN ADMMF A1 ON C.CREATOR=A1.MF001
	                                    LEFT JOIN CMSMV V2 ON C.MODIFIER=V2.MV001
	                                    LEFT JOIN ADMMF A2 ON C.MODIFIER=A2.MF001
	                                    LEFT JOIN CMSMV V3 ON B.CREATOR=V3.MV001
	                                    LEFT JOIN ADMMF A3 ON B.CREATOR=A3.MF001
	                                    LEFT JOIN CMSMV V4 ON B.MODIFIER=V4.MV001
	                                    LEFT JOIN ADMMF A4 ON B.MODIFIER=A4.MF001
	                                    LEFT JOIN CMSMD D ON D.MD001=B.MB068
	                                    LEFT JOIN (
		                                    SELECT B.MB001,B.MB005,B.MB006,B.MB007,T1.MA003 AS MA1,T2.MA003 AS MA2, T3.MA003 AS MA3, T4.MA003 AS MA4 
			                                    FROM INVMB B
				                                    left join INVMA T1 on B.MB005=T1.MA002
				                                    left join INVMA T2 on B.MB006=T2.MA002
				                                    left join INVMA T3 on B.MB007=T3.MA002
				                                    left join INVMA T4 on B.MB008=T4.MA002
			                                    GROUP BY B.MB001,B.MB005,B.MB006,B.MB007,T1.MA003,T2.MA003, T3.MA003, T4.MA003
		                                    ) B1 ON B1.MB001=B.MB001
	
	                                    LEFT JOIN (
		                                    SELECT B.MB001,D.TD011,C.TC008,C.TC009,C.TC016,C.TC041 FROM INVMB B
			                                    LEFT JOIN COPTD D ON B.MB001=D.TD004 
				                                    AND CONVERT(datetime,D.CREATE_DATE+' '+D.CREATE_TIME)=(SELECT MAX(CONVERT(datetime,D1.CREATE_DATE+' '+D1.CREATE_TIME)) FROM COPTD D1 WHERE D1.TD004=B.MB001)
			                                    LEFT JOIN COPTC C ON C.TC001=D.TD001 AND C.TC002=D.TD002
		                                    WHERE C.TC027='Y'
		                                    GROUP BY B.MB001,D.TD011,C.TC008,C.TC009,C.TC016,C.TC041	
		                                    )DD ON DD.MB001=B.MB001
	
                                    WHERE C.MC007>0 
                                       ";
                        #endregion

                        BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "MtlItemNo", @" AND (B.MB001 LIKE '%' + @MtlItemNo + '%' OR B.MB002 LIKE '%' + @MtlItemNo + '%' )", MtlItemNo);
                        BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "AccountingCategoryNo", @" AND B.MB005 = @AccountingCategoryNo ", AccountingCategoryNo);//會計分類名稱
                        BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "WarehouseCategoryNo", @" AND B.MB006 = @WarehouseCategoryNo ", WarehouseCategoryNo);//倉管分類名稱
                        BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "BusinessCategoryNo", @" AND B.MB007 = @BusinessCategoryNo ", BusinessCategoryNo);//業務分類名稱
                        BaseHelper.SqlParameter(ref mainSql, ref dynamicParameters, "ManagementCategoryNo", @" AND B.MB008 = @ManagementCategoryNo ", ManagementCategoryNo);//生管分類名稱

                        string sql01 = "";

                        if (RedirectType == 1)
                        {
                            
                            sql01 += mainSql + @" ORDER BY B.MB001 
                                            OFFSET @PageSize * (@PageIndex - 1) ROWS
                                            FETCH NEXT @PageSize ROWS ONLY";
                            dynamicParameters.Add("PageSize", PageSize);
                            dynamicParameters.Add("PageIndex", PageIndex);
                        }
                        else if (RedirectType == 2)
                        {
                            sql01 += mainSql + @" ORDER BY B.MB001 ";
                        }



                        var result = sqlConnection2.Query(sql01, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT COUNT(1) AS TotalCount
                            FROM (" + mainSql + ") AS TotalQuery";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        dynamicParameters.Add("AccountingCategoryNo", AccountingCategoryNo);
                        dynamicParameters.Add("WarehouseCategoryNo", WarehouseCategoryNo);
                        dynamicParameters.Add("BusinessCategoryNo", BusinessCategoryNo);
                        dynamicParameters.Add("ManagementCategoryNo", ManagementCategoryNo);

                        var TotalCountResult = sqlConnection2.Query(sql, dynamicParameters);


                        int TotalCount = 0;
                        foreach (var item in TotalCountResult)
                        {
                            TotalCount = item.TotalCount;
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            result,
                            TotalCount
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion 

        #region //GetProductCostReport -- 產品成本分析表 -- Shintokuro 2025-06-15
        public string GetProductCostReport(string MtlItemNo, string StardDay, string EndDay)
        {
            try
            {
                string MESCompanyNo = "";
                string ErpDb = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        MESCompanyNo = item.ErpNo;
                        ErpDb = item.ErpDb;
                    }
                    #endregion

                }
                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {

                    #region //生產入庫明細表
                    dynamicParameters = new DynamicParameters();
                    sql = @"
                            SELECT 
                                LTRIM(RTRIM(a.MB001)) MtlItemNo, 
                                LTRIM(RTRIM(a.MB002)) MtlItemName,
                                LTRIM(RTRIM(a.MB003)) MtlItemSpec,
                                LTRIM(RTRIM(a.MB004)) UomNo, 
                                x.ProdInQty,
                                x.OutsourceInQty,
                                x.MaterialWIPReserve,
                                x.LaborWIPReserve,
                                x.MfgCostWIPReserve,
                                x.MaterialCost,
    
                                -- 單位材料成本（小數4位）
                                ROUND(x.UnitMaterialCost, 4) AS UnitMaterialCost,

                                -- 材料成本百分比（字串格式）
                                FORMAT(x.MaterialCostRate * 100, 'N2') + '%' AS MaterialCostRate,
                                x.LaborCost,

                                -- 單位人工成本（小數4位）
                                ROUND(x.UnitLaborCost, 4) AS UnitLaborCost,

                                -- 人工成本百分比（字串格式）
                                FORMAT(x.LaborCostRate * 100, 'N2') + '%' AS LaborCostRate,
                                x.MfgOverhead,

                                -- 單位製造成本（小數4位）
                                ROUND(x.UnitMfgCost, 4) AS UnitMfgCost,

                                -- 製造成本百分比（字串格式）
                                FORMAT(x.MfgCostRate * 100, 'N2') + '%' AS MfgCostRate,

                                x.TotalProdCost,

                                -- 單位總生產成本（小數4位）
                                ROUND(x.UnitProdCost, 4) AS UnitProdCost,

                                x.CurrStageLaborCost,
                                x.CurrStageMfgOverhead

                            FROM INVMB a
                            OUTER APPLY (
                                SELECT 
                                    SUM(TA012) AS ProdInQty,
                                    SUM(TA013) AS OutsourceInQty,
                                    SUM(TA023) AS MaterialWIPReserve,
                                    SUM(TA024) AS LaborWIPReserve,
                                    SUM(TA031) AS MfgCostWIPReserve,

                                    SUM(TA015 + TA008) AS MaterialCost,
                                    SUM(TA016 + TA009) AS LaborCost,
                                    SUM(TA017 + TA010) AS MfgOverhead,

                                    SUM(TA016 - TA019) AS CurrStageLaborCost,
                                    SUM(TA017 - TA020) AS CurrStageMfgOverhead,

                                    -- 成本與百分比計算（不四捨五入）
                                    CASE 
                                        WHEN (SUM(TA012) + SUM(TA013) + SUM(TA023)) = 0 THEN NULL
                                        ELSE SUM(TA015 + TA008) * 1.0 / (SUM(TA012) + SUM(TA013) + SUM(TA023)) 
                                    END AS UnitMaterialCost,

                                    CASE 
                                        WHEN (SUM(TA012) + SUM(TA013) + SUM(TA024)) = 0 THEN NULL
                                        ELSE SUM(TA016 + TA009) * 1.0 / (SUM(TA012) + SUM(TA013) + SUM(TA024))
                                    END AS UnitLaborCost,

                                    CASE 
                                        WHEN (SUM(TA012) + SUM(TA013) + SUM(TA024)) = 0 THEN NULL
                                        ELSE SUM(TA017 + TA010) * 1.0 / (SUM(TA012) + SUM(TA013) + SUM(TA024))
                                    END AS UnitMfgCost,

                                    (SUM(TA015 + TA008) + SUM(TA016 + TA009) + SUM(TA017 + TA010)) AS TotalProdCost,

                                    CASE 
                                        WHEN (SUM(TA015 + TA008) + SUM(TA016 + TA009) + SUM(TA017 + TA010)) = 0 THEN NULL
                                        ELSE SUM(TA015 + TA008) * 1.0 / (SUM(TA015 + TA008) + SUM(TA016 + TA009) + SUM(TA017 + TA010))
                                    END AS MaterialCostRate,

                                    CASE 
                                        WHEN (SUM(TA015 + TA008) + SUM(TA016 + TA009) + SUM(TA017 + TA010)) = 0 THEN NULL
                                        ELSE SUM(TA016 + TA009) * 1.0 / (SUM(TA015 + TA008) + SUM(TA016 + TA009) + SUM(TA017 + TA010))
                                    END AS LaborCostRate,

                                    CASE 
                                        WHEN (SUM(TA015 + TA008) + SUM(TA016 + TA009) + SUM(TA017 + TA010)) = 0 THEN NULL
                                        ELSE SUM(TA017 + TA010) * 1.0 / (SUM(TA015 + TA008) + SUM(TA016 + TA009) + SUM(TA017 + TA010))
                                    END AS MfgCostRate,

                                    CASE 
                                        WHEN (SUM(TA012) + SUM(TA013) + SUM(TA024)) = 0 THEN NULL
                                        ELSE (
                                            SUM(TA015 + TA008) + SUM(TA016 + TA009) + SUM(TA017 + TA010)
                                        ) * 1.0 / (SUM(TA012) + SUM(TA013) + SUM(TA024))
                                    END AS UnitProdCost

                                FROM CSTTA 
                                WHERE TA001 = a.MB001 AND TA002 BETWEEN  @StardDay AND @EndDay
                            ) x
                        WHERE a.MB001 LIKE '%' + @MtlItemNo + '%'
                          AND x.OutsourceInQty IS NOT NULL;

                            ";

                    if(StardDay != "" && EndDay == "")
                    {
                        EndDay = DateTime.Now.ToString("yyyyMM");
                    }
                    else if(StardDay == "" && EndDay == "")
                    {
                        EndDay = DateTime.Now.ToString("yyyyMM");
                    }
                    dynamicParameters.Add("StardDay", StardDay);
                    dynamicParameters.Add("EndDay", EndDay);
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }

            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }

            return jsonResponse.ToString();

        }
        #endregion

        #region //GetProductReceivingCost -- 產品入庫成本分析表 -- Shintokuro 2025-06-21
        public string GetProductReceivingCost(string MtlItemNo, string StardDay, string EndDay)
        {
            try
            {
                string MESCompanyNo = "";
                string ErpDb = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        MESCompanyNo = item.ErpNo;
                        ErpDb = item.ErpDb;
                    }
                    #endregion

                }
                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {

                    #region //產品入庫成本分析表
                    dynamicParameters = new DynamicParameters();
                    sql = @"
                           SELECT 
                             LTRIM(RTRIM(ME001)) MtlItemNo
                            ,LTRIM(RTRIM(MB002)) MtlItemName
                            ,LTRIM(RTRIM(MB003)) MtlItemSpec
                            ,LTRIM(RTRIM(MB004)) UomNo
                            ,(TA003+'-'+TA004) AS ErpFUllNo 
                            ,TA012 ProdInQty
                            ,TA013 OutsourceInQty
                            ,(TA012+TA013) AS TA012T
                            , (TA008+TA015-TA026+TA036) AS MaterialCost
                            ,(TA009+TA016-TA027+TA037) AS LaborCost
                            ,(TA010+TA017-TA028+TA038) AS MfgOverhead
                            , (TA011+TA018-TA029+TA039) AS ProcessingFee
                            ,(TA007+TA014-TA025+TA036+TA037+TA038+TA039) AS TotalProdCost 
                            ,FORMAT(ROUND(
                                (TA007 + TA014 - TA025 + TA036 + TA037 + TA038 + TA039) / NULLIF(TA012 + TA013, 0)
                            , 4), '0.####') AS UnitProdCost
                            FROM CSTME AS CSTME
                            INNER JOIN INVMB ON MB001=ME001  
                            INNER JOIN CSTTA ON TA001=ME001 AND TA002=ME002
                            Where ( (ME001 LIKE '%'+ @MtlItemNo +'%')  AND ME002 BETWEEN  @StardDay AND @EndDay  
                            AND ((TA012 <> 0) OR (TA013 <> 0 ))) 
                            ORDER BY ME001 
                            ";
                    if (StardDay != "" && EndDay == "")
                    {
                        EndDay = DateTime.Now.ToString("yyyyMM");
                    }
                    else if (StardDay == "" && EndDay == "")
                    {
                        EndDay = DateTime.Now.ToString("yyyyMM");
                    }
                    dynamicParameters.Add("StardDay", StardDay);
                    dynamicParameters.Add("EndDay", EndDay);
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }

            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }

            return jsonResponse.ToString();

        }
        #endregion

        #region //GetIOTQRData -- 取得自動化資料表數據-紘立MTF -QR -- GPAI 2025-07-21
        public string GetIOTQRData(string QRNos)
        {


            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        using (SqlConnection sqlConnection2 = new SqlConnection(AutomationConnectionStrings))
                        {
                            #region//取得自動化資料庫中的資料
                            dynamicParameters = new DynamicParameters();

                            dynamicParameters = new DynamicParameters();
                            sql = @"WITH QRList AS (
    SELECT TRIM(value) AS QR_Target
    FROM STRING_SPLIT(@QRNos, ',')
),
CombinedData AS (
    SELECT * FROM MTF_RawData#1
    UNION ALL
    SELECT * FROM MTF_RawData#2
    UNION ALL
    SELECT * FROM MTF_RawData#3
    UNION ALL
    SELECT * FROM MTF_RawData#4
    UNION ALL
    SELECT * FROM MTF_RawData#5
),
WithQR AS (
    SELECT 
        UPPER(SUBSTRING(MeasurementSN, CHARINDEX(':', MeasurementSN) + 1, LEN(MeasurementSN))) AS QR,
        *,
        ROW_NUMBER() OVER (PARTITION BY UPPER(SUBSTRING(MeasurementSN, CHARINDEX(':', MeasurementSN) + 1, LEN(MeasurementSN))) 
                           ORDER BY MTF_DateTime DESC) AS rn
    FROM CombinedData
    WHERE 
        MeasurementSN LIKE '%:%'
        AND Class NOT IN ('NG','--')
        AND MTF_DateTime >= '2025-01-01'
),
FilteredData AS (
    SELECT * FROM WithQR WHERE rn = 1
)

SELECT 
   ql.QR_Target AS QR, fd.ID, fd.MeasurementSN, fd.MachineSN, fd.Location_X, fd.Location_Y, fd.Class, fd.CheckFreq, fd.FBL, fd.DOF_Index,
   fd.DOF_minus, fd.DOF_plus, fd.DOF_T, fd.GDOF_Index, fd.GDOF_minus, fd.GDOF_plus, fd.GDOF_T, fd.EFL, fd.W_1S, fd.W_1T,
   fd.W_2S, fd.W_2T, fd.W_3S, fd.W_3T, fd.W_4S, fd.W_4T, fd.W_5S, fd.W_5T, fd.W_6S, fd.W_6T,
   fd.W_7S, fd.W_7T, fd.W_8S, fd.W_8T, fd.W_9S, fd.W_9T, fd.W_10S, fd.W_10T, fd.W_11S, fd.W_11T,
   fd.W_12S, fd.W_12T, fd.W_13S, fd.W_13T, fd.W_14S, fd.W_14T, fd.W_15S, fd.W_15T, fd.W_16S, fd.W_16T,
   fd.W_17S, fd.W_17T, fd.W1S_Peak, fd.W1T_Peak, fd.W2S_Peak, fd.W2T_Peak, fd.W3S_Peak, fd.W3T_Peak, fd.W4S_Peak, fd.W4T_Peak,
   fd.W5S_Peak, fd.W5T_Peak, fd.W6S_Peak, fd.W6T_Peak, fd.W7S_Peak, fd.W7T_Peak, fd.W8S_Peak, fd.W8T_Peak, fd.W9S_Peak, fd.W9T_Peak,
   fd.W10S_Peak, fd.W10T_Peak, fd.W11S_Peak, fd.W11T_Peak, fd.W12S_Peak, fd.W12T_Peak, fd.W13S_Peak, fd.W13T_Peak, fd.W14S_Peak, fd.W14T_Peak,
   fd.W15S_Peak, fd.W15T_Peak, fd.W16S_Peak, fd.W16T_Peak, fd.W17S_Peak, fd.W17T_Peak, fd.MTF_DateTime, fd.RecordTime,
   CASE WHEN fd.QR IS NOT NULL THEN 'Found' ELSE 'Not Found' END AS Status
FROM QRList ql
LEFT JOIN FilteredData fd ON ql.QR_Target = fd.QR
ORDER BY 
    CASE WHEN fd.QR IS NOT NULL THEN 0 ELSE 1 END,  -- 找到的排在前面
    ql.QR_Target;
                    ";
                            dynamicParameters.Add("QRNos", QRNos);
                            var result = sqlConnection2.Query(sql, dynamicParameters);

                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                result
                            });
                            #endregion

                        }

                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPoStatusReport -- 采购进货状况分析表 -- Shintokuro 2025-06-21
        public string GetPoStatusReport(string PoFullNo, string MtlItemNo, string SupplierNo, string CloseCode, string PoStatus, string DeliveryStatus, string StardDay, string EndDay
            , string OrderBy, int PageIndex , int PageSize , int RedirectType )
        {
            try
            { 
                string MESCompanyNo = "";
                string ErpDb = "";
                string sql01 = "";
                string sql02 = "";
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        MESCompanyNo = item.ErpNo;
                        ErpDb = item.ErpDb;
                    }
                    #endregion

                }
                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {

                    #region //產品入庫成本分析表
                    if (StardDay.Length > 0)
                    {
                        StardDay = DateTime.Parse(StardDay).ToString("yyyyMMdd");
                    }
                    if (EndDay.Length > 0)
                    {
                        EndDay = DateTime.Parse(EndDay).ToString("yyyyMMdd");
                    }
                    //結案狀態
                    string CloseCodeStr = "";
                    if (CloseCode.Length > 0)
                    {
                        foreach (var item in CloseCode.Split(','))
                        {
                            CloseCodeStr += $",'{item}'";
                        }
                        CloseCodeStr = CloseCodeStr.Substring(1);
                        CloseCodeStr = $" AND xx.CloseCode IN ({ CloseCodeStr})";
                    }
                    string PoStatusStr = "";
                    //交期狀態
                    if (PoStatus.Length > 0)
                    {
                        foreach (var item in PoStatus.Split(','))
                        {
                            PoStatusStr += $",'{item}'";
                        }
                        PoStatusStr = PoStatusStr.Substring(1);
                        PoStatusStr = $" AND xx.PoStatus IN ({ PoStatusStr})";
                    }
                    //進貨狀態
                    string DeliveryStatusStr = "";
                    if (DeliveryStatus.Length > 0)
                    {
                        foreach (var item in DeliveryStatus.Split(','))
                        {
                            DeliveryStatusStr += $",'{item}'";
                        }
                        DeliveryStatusStr = DeliveryStatusStr.Substring(1);
                        DeliveryStatusStr = $" AND xx.DeliveryStatus IN ({ DeliveryStatusStr})";
                    }

                    dynamicParameters = new DynamicParameters();
                    string mainSql = $@"
                                   SELECT *
                                    FROM(
                                         SELECT LTRIM(RTRIM(a.TD001))+'-' + LTRIM(RTRIM(a.TD002)) +'-' + LTRIM(RTRIM(a.TD003)) FullNo,a.TD012 DeliveryDate,y3.TG003 InDay
                                        ,CASE 
                                            WHEN a.TD012 < CONVERT(CHAR(8), GETDATE(), 112) THEN  -- 已過交期
                                                CASE 
                                                    WHEN y1.InTotalQty IS NULL THEN '未交貨且逾期'                 -- 未交貨且逾期
                                                    WHEN a.TD008 > y1.InTotalQty THEN '部分交貨仍逾期'               -- 部分交貨仍逾期
                                                    WHEN a.TD008 <= y1.InTotalQty AND y3.TG003 > a.TD012 THEN '交貨完成但逾期交'  -- 交貨完成但逾期交
                                                    ELSE '有交貨且準時完成'                                      -- 有交貨且準時完成
                                                END
                                            ELSE '尚未到交期'                                              -- 尚未到交期
                                         END AS DeliveryStatus
                                        ,CASE 
                                            WHEN ISNULL(y1.InTotalQty,0) = 0 THEN '尚無收貨紀錄' 
                                            WHEN ISNULL(y2.InPassQty,0)+ISNULL(y2.InReturnQty,0) != ISNULL(y1.InTotalQty,0) AND ISNULL(y1.InTotalQty,0) < a.TD008 THEN '部分已收貨部分檢驗中' 
                                            WHEN ISNULL(y2.InPassQty,0)+ISNULL(y2.InReturnQty,0) =  ISNULL(y1.InTotalQty,0) AND ISNULL(y1.InTotalQty,0) < a.TD008 THEN '部分已收貨部分入庫' 
                                            WHEN ISNULL(y2.InPassQty,0)+ISNULL(y2.InReturnQty,0) != ISNULL(y1.InTotalQty,0) AND ISNULL(y1.InTotalQty,0) >= a.TD008 THEN '全部收貨在檢驗中' 
                                         WHEN (ISNULL(y2.InPassQty,0)+ISNULL(y2.InReturnQty,0) =  ISNULL(y1.InTotalQty,0) AND ISNULL(y1.InTotalQty,0) >= a.TD008) THEN '全部已入庫' 
                                         END PoStatus
                                        ,ISNULL(a.TD008,0) PuQty,ISNULL(y1.InTotalQty,0) InTotalQty,ISNULL(y2.InPassQty,0) InPassQty,ISNULL(y2.InReturnQty,0) InReturnQty
                                        ,a.TD004 MtlItemNo,a.TD005 MtlItemName,a.TD006 MtlItemSpec,b.TC003 DocDate,b.TC004+':'+c.MA002 SupplierFull,a.TD016 CloseCode
                                         FROM PURTD a
                                         INNER JOIN PURTC b on a.TD001= b.TC001 AND a.TD002 = b.TC002
                                         INNER JOIN PURMA c on b.TC004 = c.MA001
                                         OUTER APPLY (
                                             SELECT SUM(x1.TH007) InTotalQty
                                             FROM PURTH x1
                                             WHERE x1.TH011 = a.TD001
                                             AND x1.TH012 = a.TD002
                                             AND x1.TH013  = a.TD003
                                             AND x1.TH030 != 'V'
                                         ) y1
                                         OUTER APPLY (
                                             SELECT SUM(x1.TH015) InPassQty,SUM(x1.TH017) InReturnQty
                                             FROM PURTH x1
                                             WHERE x1.TH011 = a.TD001
                                             AND x1.TH012 = a.TD002
                                             AND x1.TH013  = a.TD003
                                             AND x1.TH030 = 'Y'
                                         ) y2
                                          OUTER APPLY (
                                             SELECT TOP 1 TG003
                                             FROM PURTH x1
                                             INNER JOIN PURTG x2 on x1.TH001 = x2.TG001 AND x1.TH002 = x2.TG002
                                             WHERE x1.TH011 = a.TD001
                                             AND x1.TH012 = a.TD002
                                             AND x1.TH013  = a.TD003
                                             AND x1.TH030 != 'V'
                                             ORDER BY TG003 DESC
                                         ) y3
                                         WHERE a.TD018 = 'Y' 
                                         --AND (
                                         --   @CloseCode = '' OR 
                                         --   UPPER(a.TD016) = UPPER(@CloseCode)
                                         --)
                                         AND (b.TC004 = @SupplierNo OR @SupplierNo = '')
                                         AND (
                                            (@StardDay =  '' AND @EndDay = '') OR
                                            (@StardDay != '' AND @EndDay = '' AND b.TC003 >= @StardDay) OR
                                            (@StardDay =  '' AND @EndDay != '' AND b.TC003 <= @EndDay) OR
                                            (@StardDay != '' AND @EndDay != '' AND b.TC003 BETWEEN @StardDay AND @EndDay)
                                         ) 
                                         AND a.TD004 LIKE '%'+ @MtlItemNo +'%'
                                         AND LTRIM(RTRIM(a.TD001))+'-' + LTRIM(RTRIM(a.TD002)) +'-' + LTRIM(RTRIM(a.TD003)) LIKE '%'+ @PoFullNo +'%'

                                     ) xx
                                     WHERE 1=1
                                     {CloseCodeStr}
                                     {PoStatusStr}
                                     {DeliveryStatusStr}
                                     
                                    ";


                    dynamicParameters.Add("PoFullNo", PoFullNo);
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);
                    dynamicParameters.Add("SupplierNo", SupplierNo);
                    dynamicParameters.Add("StardDay", StardDay);
                    dynamicParameters.Add("EndDay", EndDay);
                    dynamicParameters.Add("CloseCode", CloseCode);
                    dynamicParameters.Add("PoStatus", PoStatusStr);
                    dynamicParameters.Add("DeliveryStatus", DeliveryStatusStr);

                    if (RedirectType == 1)
                    {
                        
                        sql01 += mainSql + @" ORDER BY xx.DeliveryDate DESC
                                            OFFSET @PageSize * (@PageIndex - 1) ROWS
                                            FETCH NEXT @PageSize ROWS ONLY";
                        dynamicParameters.Add("PageSize", PageSize);
                        dynamicParameters.Add("PageIndex", PageIndex);
                    }
                    else if (RedirectType == 2)
                    {
                        sql01 += mainSql + @" ORDER BY xx.DeliveryDate DESC";
                    }


                    var result = sqlConnection.Query(sql01, dynamicParameters);

                    dynamicParameters = new DynamicParameters();
                    sql02 = @"SELECT COUNT(1) AS TotalCount
                            FROM (" + mainSql + ") AS TotalQuery";
                    dynamicParameters.Add("PoFullNo", PoFullNo);
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);
                    dynamicParameters.Add("SupplierNo", SupplierNo);
                    dynamicParameters.Add("StardDay", StardDay);
                    dynamicParameters.Add("EndDay", EndDay);
                    dynamicParameters.Add("CloseCode", CloseCode);
                    dynamicParameters.Add("PoStatus", PoStatusStr);
                    dynamicParameters.Add("DeliveryStatus", DeliveryStatusStr);

                    var TotalCountResult = sqlConnection.Query(sql02, dynamicParameters);


                    int TotalCount = 0;
                    foreach (var item in TotalCountResult)
                    {
                        TotalCount = item.TotalCount;
                    }
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        result,
                        TotalCount
                    });
                    #endregion
                }

            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }

            return jsonResponse.ToString();

        }
        #endregion

        #endregion

        #region //Update
        #region //UpdateTimeout -- 更新頁面刷新時間 -- Ann 2023-11-23
        public string UpdateTimeout(string TypeSchema, string TypeNo)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //確認TIMEOUT類型資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM BAS.Type
                                    WHERE TypeSchema = @TypeSchema";
                            dynamicParameters.Add("TypeSchema", TypeSchema);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("類型資料錯誤!");
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE BAS.Type SET
                                    TypeNo = @TypeNo,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TypeSchema = @TypeSchema";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    TypeNo,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    TypeSchema
                                });

                            int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateExpectedEnd -- 更新預計完工日 -- Shinotokuro 2024-08-06
        public string UpdateExpectedEnd(string WipNo, string ExpectedEnd)
        {
            try
            {
                if (WipNo.Length <= 0) throw new SystemException("【MES系統】ERP製令不可為空,請重新確認");
                if (ExpectedEnd.Length <= 0) throw new SystemException("【MES系統】預計完工日不可為空,請重新確認");

                int rowsAffected = 0;
                string dateNow = DateTime.Now.ToString("yyyyMMdd");
                string timeNow = DateTime.Now.ToString("HH:mm:ss");
                string dateNowMonth = DateTime.Now.ToString("yyyyMM");
                string UserNo = "";

                string ErpNo = "";
                string ErpDbName = "";
                string WoErpPrefix = "";
                string WoErpNo = "";
                string ExpectedStart = "";
                string EndDateFormatted = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);

                        if (resultCompany.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //撈取使用者No
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "RptMoInformation");
                        dynamicParameters.Add("DetailCode", "update-date");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            UserNo = item.UserNo;
                        }
                        #endregion

                        #region //判斷製令是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.WoErpPrefix, a.WoErpNo, FORMAT(a.ExpectedStart, 'yyyy-MM-dd') ExpectedStart
                                FROM MES.WipOrder a
                                WHERE 1=1
                                AND a.WoErpPrefix = @WoErpPrefix
                                AND a.WoErpNo = @WoErpNo";
                        dynamicParameters.Add("WoErpPrefix", WipNo.Split('-')[0]);
                        dynamicParameters.Add("WoErpNo", WipNo.Split('-')[1]);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【MES系統】ERP製令找不到,請重新確認");

                        foreach (var item in result)
                        {
                            WoErpPrefix = item.WoErpPrefix;
                            WoErpNo = item.WoErpNo;
                            ExpectedStart = item.ExpectedStart;
                        }
                        #endregion


                        DateTime startDate = DateTime.Parse(ExpectedStart);
                        DateTime endDate = DateTime.Parse(ExpectedEnd);
                        if (startDate > endDate) throw new SystemException("【MES系統】預計完工日不可以小於預計開工日,請重新確認");
                        EndDateFormatted = endDate.ToString("yyyyMMdd");
                        #region //ERP單據預計完工日更新
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.WipOrder SET 
                                ExpectedEnd = @ExpectedEnd,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE 1=1
                                AND WoErpPrefix = @WoErpPrefix
                                AND WoErpNo = @WoErpNo";
                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            ExpectedEnd,
                            LastModifiedDate,
                            LastModifiedBy,
                            WoErpPrefix,
                            WoErpNo
                        });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {

                        #region //判斷製令是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.TA009, a.TA011
                                FROM MOCTA a
                                WHERE 1=1
                                AND a.TA001 = @WoErpPrefix
                                AND a.TA002 = @WoErpNo";
                        dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                        dynamicParameters.Add("WoErpNo", WoErpNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【ERP系統】ERP製令找不到,請重新確認");

                        foreach (var item in result)
                        {
                            ExpectedStart = item.TA009;
                            if (item.TA011 == "4" || item.TA011 == "5") throw new SystemException("【ERP系統】ERP製令已完工,不可以再修改");
                        }
                        #endregion

                        if (Convert.ToInt32(ExpectedStart) > Convert.ToInt32(EndDateFormatted)) throw new SystemException("【ERP系統】預計完工日不可以小於預計開工日,請重新確認");


                        #region //ERP單據預計完工日更新
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MOCTA SET 
                                MODIFIER = @MODIFIER,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODI_PRID = @MODI_PRID,
                                FLAG = FLAG + 1,
                                TA010 = @TA010
                                WHERE 1=1
                                AND TA001 = @TA001
                                AND TA002 = @TA002";
                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            MODIFIER = UserNo,
                            MODI_DATE = dateNow,
                            MODI_TIME = timeNow,
                            MODI_AP = BaseHelper.ClientComputer(),
                            MODI_PRID = "BM",
                            TA010 = EndDateFormatted,
                            TA001 = WoErpPrefix,
                            TA002 = WoErpNo
                        });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //FOR EIP API
        #region //GetProductionInProcessEIP -- 取得生產在製資料 -- GPAI 2024.03.15
        public string GetProductionInProcessEIP(int ModeId, string WoErpFullNo, string MtlItemNo, string BarcodeNo, string StartDate, string EndDate
            , string OrderBy, int PageIndex, int PageSize, int[] CustomerIds)
        {
            try
            {
                if (CustomerIds == null) throw new SystemException("客戶資料錯誤!");

                List<ManufactureOrder> allmanufactureOrders = new List<ManufactureOrder>();
                List<ManufactureOrder> manufactureOrders = new List<ManufactureOrder>();
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT a.ErpDb, a.CompanyId, b.CustomerId
                            FROM BAS.Company a
							INNER JOIN SCM.Customer b on a.CompanyId = b.CompanyId
                            WHERE b.CustomerId IN @CustomerIds";
                    dynamicParameters.Add("CustomerIds", CustomerIds);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");
                    #endregion

                    string[] MtlItemNos = null;
                    using (SqlConnection officialConnection = new SqlConnection(OfficialConnectionStrings))
                    {
                        #region //取得客戶篩選條件
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT a.MtlItemNo
                                FROM EIP.CustMtlItemFilter a
                                INNER JOIN EIP.[Member] b ON b.MemberId = a.MemberId
                                WHERE EXISTS (
	                                SELECT TOP 1 1 FROM EIP.CsCustomer aa 
	                                INNER JOIN EIP.CsCustomerDetail ab ON ab.CsCustId = aa.CsCustId
	                                WHERE aa.CsCustId = b.CsCustId
	                                AND ab.CustomerId IN @CustomerIds
                                )";
                        dynamicParameters.Add("CustomerIds", CustomerIds);
                        MtlItemNos = officialConnection.Query(sql, dynamicParameters).Select(s => { return (string)s.MtlItemNo; }).ToArray();
                        #endregion
                    }

                    foreach (var corp in companyResult)
                    {
                        #region //取得生產在製資料
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.MoId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.WoSeq, a.InputQty, a.Quantity
                            , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo, b.StockInQty, b.PlanQty, b.StockInQty,b.RequisitionSetQty
                            , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                            , (
                                SELECT a.WoSeq, x.MoProcessId
                                , b.WoErpPrefix + '-' + b.WoErpNo WoErpFullNo
                                , x.ProcessId, ISNULL(x.ProcessAlias, '') ProcessAlias, ISNULL(x.TotalInputQty, 0) TotalInputQty
                                , ISNULL(x.TotalPassQty, 0) TotalPassQty, ISNULL(x.TotalNgQty, 0) TotalNgQty
                                , ISNULL(x.TotalScrapQty, 0) TotalScrapQty, ISNULL(x.AlreadyQty, 0) AlreadyQty
                                , CASE 
                                    WHEN ISNULL(x.TotalInputQty, 0) > 0
                                        THEN CONVERT(varchar, CONVERT(decimal(18,0), CONVERT(decimal(18,0), x.TotalPassQty) / CONVERT(decimal(18,0), x.TotalInputQty) * 100)) + '%'
                                        ELSE '0%'
                                    END PassRate
                                FROM MES.MoProcess x
                                WHERE x.MoId = a.MoId
                                ORDER BY x.SortNumber
                                FOR JSON PATH, ROOT('data')
                            ) AS ProcessDetail";
                            sqlQuery.mainTables =
                                @"FROM MES.ManufactureOrder a
                                INNER JOIN MES.WipOrder b ON b.WoId = a.WoId
                                INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId
                                OUTER APPLY(
                                    SELECT TOP 1 x.MoProcessId
                                    FROM MES.MoProcess x
                                    WHERE x.MoId = a.MoId
                                ) d";
                        sqlQuery.auxTables = "";
                        string queryCondition = @" AND b.CompanyId = @CompanyId
                                                AND d.MoProcessId > 0
                                                AND EXISTS (
                                                    SELECT TOP 1 1 
                                                    FROM SCM.SaleOrder xa
                                                    INNER JOIN SCM.SoDetail xb ON xb.SoId = xa.SoId
                                                    AND xb.MtlItemId = b.MtlItemId
                                                    AND xa.CustomerId = @CustomerId
                                                )";
                        dynamicParameters.Add("CompanyId", corp.CompanyId);
                        dynamicParameters.Add("CustomerId", corp.CustomerId);

                        if (MtlItemNos.Any())
                        {
                            BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNos", @" AND c.MtlItemNo IN @MtlItemNos", MtlItemNos);
                        }

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ModeId", @" AND a.ModeId = @ModeId", ModeId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND b.WoErpPrefix + '-' + b.WoErpNo + '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')' LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (c.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR c.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" 
                                                                                            AND EXISTS (SELECT TOP 1 1 FROM MES.Barcode xa WHERE xa.MoId = a.MoId AND xa.BarcodeNo = @BarcodeNo)", BarcodeNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND b.DocDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND b.DocDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        manufactureOrders = BaseHelper.SqlQuery<ManufactureOrder>(sqlConnection, dynamicParameters, sqlQuery);

                        allmanufactureOrders.AddRange(manufactureOrders);
                        #endregion
                    }
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    data = allmanufactureOrders
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWipBarcodeCountDataEIP -- 取得條碼在製資料筆數 -- GPAI 2024.03.15
        public string GetWipBarcodeCountDataEIP(string MoProcessIdListString)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoProcessIdListString.Length <= 0) throw new SystemException("【製程】不能為空!");

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoProcessId, a.ProcessAlias
                            , b.WoSeq
                            , c.WoErpPrefix + '-' + c.WoErpNo WoErpFullNo
                            , NotStart.NotStartQty
                            , Start.StartQty
                            , Wip.WipQty
                            FROM MES.MoProcess a
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                            OUTER APPLY (
                                SELECT TOP 1 (
                                    SELECT ISNULL(SUM(x.BarcodeQty), 0) NotStartQty
                                    FROM MES.Barcode x
                                    WHERE (x.CurrentMoProcessId != a.MoProcessId AND x.NextMoProcessId = a.MoProcessId AND x.ParentBarcode IS NULL)
                                    OR (a.SortNumber = 1 AND x.CurrentMoProcessId = a.MoProcessId AND x.NextMoProcessId = a.MoProcessId)
                                    AND NOT EXISTS (
                                        SELECT TOP 1 1 FROM MES.BarcodeProcess xa
                                        WHERE xa.BarcodeId = x.BarcodeId AND xa.MoProcessId = a.MoProcessId AND x.ParentBarcode IS NULL
                                    )
                                ) NotStartQty
                            ) AS NotStart
                            OUTER APPLY (
                                SELECT TOP 1 (
                                    SELECT ISNULL(SUM(x.StationQty), 0) StartQty
                                    FROM MES.BarcodeProcess x 
                                    WHERE x.MoProcessId = a.MoProcessId
                                    AND x.FinishDate IS NULL
                                    GROUP BY x.StationQty
                                ) StartQty
                            ) AS Start
                            OUTER APPLY (
                                    SELECT TOP 1 (
                                    SELECT ISNULL(SUM(x.BarcodeQty), 0) WipQty
                                    FROM MES.Barcode x
                                    WHERE x.CurrentMoProcessId = a.MoProcessId AND x.NextMoProcessId != x.CurrentMoProcessId AND x.ParentBarcode IS NULL
                                ) WipQty
                            ) AS Wip
                            WHERE a.MoProcessId IN @MoProcessIdListStrings";
                    dynamicParameters.Add("MoProcessIdListStrings", MoProcessIdListString.Split(','));
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetTimeoutEIP -- 取得頁面刷新時間 -- GPAI 2024.03.15
        public string GetTimeoutEIP(string TypeSchema)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TypeId, a.TypeSchema, a.TypeNo
                            FROM BAS.[Type] a
                            WHERE a.TypeSchema = @TypeSchema";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TypeSchema", @" AND a.TypeSchema = @TypeSchema", TypeSchema);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcRecordEIP -- 取得量測記錄資料 -- GPAI 2024.03.15
        public string GetQcRecordEIP(int QcRecordId, string WoErpFullNo, string QcNoticeNo, string MtlItemNo, string MtlItemName
            , int QcTypeId, string CheckQcMeasureData, int UserId, string StartDate, string EndDate, string BarcodeNo, string QcType
            , string OrderBy, int PageIndex, int PageSize, int[] CustomerIds)
        {
            try
            {
                if (CustomerIds == null) throw new SystemException("客戶資料錯誤!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    string[] MtlItemNos = null;
                    using (SqlConnection officialConnection = new SqlConnection(OfficialConnectionStrings))
                    {
                        #region //取得客戶篩選條件
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT a.MtlItemNo
                                FROM EIP.CustMtlItemFilter a
                                INNER JOIN EIP.[Member] b ON b.MemberId = a.MemberId
                                WHERE EXISTS (
	                                SELECT TOP 1 1 FROM EIP.CsCustomer aa 
	                                INNER JOIN EIP.CsCustomerDetail ab ON ab.CsCustId = aa.CsCustId
	                                WHERE aa.CsCustId = b.CsCustId
	                                AND ab.CustomerId IN @CustomerIds
                                )";
                        dynamicParameters.Add("CustomerIds", CustomerIds);
                        MtlItemNos = officialConnection.Query(sql, dynamicParameters).Select(s => { return (string)s.MtlItemNo; }).ToArray();
                        #endregion
                    }

                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.QcRecordId, z.CustomerId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.QcNoticeId, a.QcTypeId, a.MoId, a.MoProcessId, ISNULL(a.PassQty, 0) PassQty, ISNULL(a.NgQty, 0) NgQty, a.SystemStatus
                        , a.QcStatus, a.QcUserId, ISNULL(a.Remark, '') Remark, FORMAT(a.CreateDate, 'yyyy-MM-dd') CreateDate, a.SpreadsheetData
                        , a.InputType, a.DefaultFileId, a.CheckQcMeasureData, ISNULL(a.DisallowanceReason, '') DisallowanceReason
                        , b.WoSeq
                        , (c.WoErpPrefix + '-' + c.WoErpNo) WoErpFullNo
                        , d.MtlItemNo, d.MtlItemName
                        , ISNULL(e.ProcessAlias, '') AS ProcessAlias
                        , ISNULL(f.StatusName, '') AS StatusName
                        , g.UserNo, g.UserName
                        , h.QcNoticeNo, h.QcNoticeQty
                        , (
                            SELECT (
                                SELECT xa.ControlId, xa.Cad2DFile
                                , xb.CustomerMtlItemNo, xb.CustomerCadControlId
                                , xc.CadFile
                                , xd.[FileName] + xd.FileExtension Cad2DFileFullName
                                , xe.[FileName] + xe.FileExtension CustomerCadFileFullName
                                FROM MES.RoutingItem x
                                INNER JOIN PDM.RdDesignControl xa ON x.ControlId = xa.ControlId
                                INNER JOIN PDM.RdDesign xb ON xa.DesignId = xb.DesignId
                                INNER JOIN PDM.CustomerCadControl xc ON xb.CustomerCadControlId = xc.ControlId
                                INNER JOIN BAS.[File] xd ON xa.Cad2DFile = xd.FileId
                                INNER JOIN BAS.[File] xe ON xc.CadFile = xe.FileId
                                WHERE x.RoutingItemId = j.RoutingItemId
                                FOR JSON PATH, ROOT('data')
                            ) CadInfoData
                            FROM MES.MoRouting j
                            WHERE j.MoId = a.MoId
                            FOR JSON PATH, ROOT('data')
                        ) CadInfo
                        , k.QcTypeNo, k.QcTypeName
                        , l.StatusName CheckQcMeasureDataName";
                    sqlQuery.mainTables =
                        @"FROM MES.QcRecord a
                        INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                        INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                        INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                        LEFT JOIN MES.MoProcess e ON a.MoProcessId = e.MoProcessId
                        LEFT JOIN BAS.[Status] f ON a.QcStatus = f.StatusNo AND f.StatusSchema = 'QcRecord.QcStatus'
                        INNER JOIN BAS.[User] g ON a.CreateBy = g.UserId
                        LEFT JOIN QMS.QcNotice h ON a.QcNoticeId = h.QcNoticeId
                        INNER JOIN QMS.QcType k ON a.QcTypeId = k.QcTypeId
                        INNER JOIN BAS.Status l ON a.CheckQcMeasureData = l.StatusNo AND l.StatusSchema = 'QcRecord.CheckQcMeasureData'
                        INNER JOIN BAS.Company y on c.CompanyId = y.CompanyId
                        INNER JOIN SCM.Customer z on y.CompanyId = z.CompanyId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND z.CustomerId IN @CustomerIds";
                    dynamicParameters.Add("CustomerIds", CustomerIds);

                    if (MtlItemNos.Any())
                    {
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNos", @" AND d.MtlItemNo IN @MtlItemNos", MtlItemNos);
                    }

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcRecordId", @" AND a.QcRecordId = @QcRecordId", QcRecordId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND (c.WoErpPrefix + '-' + c.WoErpNo +  '(' + CONVERT(VARCHAR(10), b.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcNoticeNo", @" AND h.QcNoticeNo LIKE '%' + @QcNoticeNo + '%'", QcNoticeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND d.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND d.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcTypeId", @" AND a.QcTypeId = @QcTypeId", QcTypeId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CheckQcMeasureData", @" AND a.CheckQcMeasureData = @CheckQcMeasureData", CheckQcMeasureData);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserId", @" AND a.CreateBy = @UserId", UserId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.CreateDate >= @StartDate", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.CreateDate <= @EndDate", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND EXISTS (SELECT TOP 1 1 FROM MES.QcBarcode x INNER JOIN MES.Barcode xa ON x.BarcodeId = xa.BarcodeId WHERE x.QcRecordId = a.QcRecordId AND xa.BarcodeNo LIKE '%' + @BarcodeNo + '%')", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcType", @" AND k.QcTypeNo = @QcType", QcType);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.QcRecordId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcMeasureDataEIP -- 取得量測詳細資料 -- GPAI 2024.03.15
        public string GetQcMeasureDataEIP(int QcRecordId, string BarcodeNo, string QcResult, string QcItemName, string MachineNumber)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QmdId, a.QcRecordId, a.QcItemId, a.BarcodeId, a.QmmDetailId
                            , ISNULL(CONVERT(VARCHAR(18), a.DesignValue), '') AS DesignValue
                            , ISNULL(CONVERT(VARCHAR(18), a.UpperTolerance), '') AS UpperTolerance
                            , ISNULL(CONVERT(VARCHAR(18), a.LowerTolerance), '') AS LowerTolerance
                            , ISNULL(a.ZAxis, '') AS ZAxis
                            , a.MeasureValue
                            , a.QcResult, a.CauseId, a.CauseDesc, a.Cavity, ISNULL(a.MakeCount, 0) 'MakeCount', a.Remark, a.QcItemDesc
                            , b.QcItemNo, b.QcItemName
                            , ISNULL(c.BarcodeNo, '') 'BarcodeNo', c.BarcodeQty
                            , (
                                SELECT (da.TypeName + ':' + d.ItemValue) ItemValue
                                FROM MES.BarcodeAttribute d
                                INNER JOIN BAS.[Type] da ON d.ItemNo = da.TypeNo AND da.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE d.BarcodeId = c.BarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , f.MachineName, f.MachineDesc
                            , g.CauseNo, g.CauseName
                            , ISNULL(h.UserNo, '') QcUserNo, ISNULL(h.UserName, '') QcUserName
                            , i.UserNo CreateUserNo, i.UserName CreateUserName
                            FROM QMS.QcMeasureData a
                            INNER JOIN QMS.QcItem b ON a.QcItemId = b.QcItemId
                            LEFT JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                            INNER JOIN QMS.QmmDetail e ON a.QmmDetailId = e.QmmDetailId
                            INNER JOIN MES.Machine f ON e.MachineId = f.MachineId
                            LEFT JOIN QMS.DefectCause g ON a.CauseId = g.CauseId
                            LEFT JOIN BAS.[User] h ON a.QcUserId = h.UserId
                            LEFT JOIN BAS.[User] i ON a.CreateBy = i.UserId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcRecordId", @" AND a.QcRecordId = @QcRecordId", QcRecordId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND (c.BarcodeNo LIKE '%' + @BarcodeNo + '%' OR a.Cavity LIKE '%' + @BarcodeNo + '%')", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcResult", @" AND a.QcResult = @QcResult", QcResult);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcItemName", @" AND b.QcItemName LIKE '%' + @QcItemName + '%'", QcItemName);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineNumber", @" AND e.MachineNumber = @MachineNumber", MachineNumber);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcRecordFileForPictureEIP -- 取得量測記錄檔案(限定PNG格式) -- GPAI 2024.03.15
        public string GetQcRecordFileForPictureEIP(int QcRecordId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.FileId, b.FileName, b.FileSize
                            FROM MES.QcRecordFile a
                            INNER JOIN BAS.[File] b ON a.FileId = b.FileId
                            WHERE a.QcRecordId = @QcRecordId
                            AND (b.FileExtension LIKE '%PNG%' OR b.FileExtension LIKE '%png%' OR b.FileExtension LIKE '%JPG%' OR b.FileExtension LIKE '%jpg%')";
                    dynamicParameters.Add("QcRecordId", QcRecordId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcRecordFileEIP -- 取得量測記錄檔案 -- GPAI 2024.03.15
        public string GetQcRecordFileEIP(int QcRecordId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT b.FileId, b.[FileName] + b.FileExtension FileName, b.FileSize
                            FROM MES.QcRecordFile a 
                            INNER JOIN BAS.[File] b ON a.FileId = b.FileId
                            WHERE a.QcRecordId = @QcRecordId";
                    dynamicParameters.Add("QcRecordId", QcRecordId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcBarcodeEIP -- 取得量測判定資料 -- GPAI 2024.03.15
        public string GetQcBarcodeEIP(int QcRecordId, string BarcodeNo, string QcStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (QcRecordId <= 0) throw new SystemException("量測單號不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.QcBarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.QcRecordId, a.BarcodeId, a.PassQty, a.NgQty, a.SystemStatus, a.QcStatus, a.Remark
                        , c.UserNo, c.UserName
                        , d.BarcodeNo
                        , f.StatusNo QcStatusNo, f.StatusName QcStatusName
                        , (
                            SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                            FROM MES.BarcodeAttribute x
                            INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE x.BarcodeId = a.BarcodeId
                            FOR JSON PATH, ROOT('data')
                        ) ItemValue";
                    sqlQuery.mainTables =
                        @"FROM MES.QcBarcode a 
                        INNER JOIN MES.QcRecord b ON a.QcRecordId = b.QcRecordId
                        INNER JOIN BAS.[User] c ON a.QcUserId = c.UserId
                        INNER JOIN MES.Barcode d ON a.BarcodeId = d.BarcodeId
                        LEFT JOIN MES.BarcodeAttribute e ON a.BarcodeId = e.BarcodeId AND e.ItemNo = 'Lettering'
                        INNER JOIN BAS.[Status] f ON a.QcStatus = f.StatusNo AND f.StatusSchema = 'BarcodeQcRecord.QcStatus'";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.QcRecordId = @QcRecordId";
                    dynamicParameters.Add("QcRecordId", QcRecordId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND (d.BarcodeNo LIKE '%' + @BarcodeNo + '%' OR e.ItemValue LIKE '%' + @BarcodeNo + '%')", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcStatus", @" AND a.QcStatus = @QcStatus", QcStatus);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.QcBarcodeId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQryProductionHistoryEIP //數量生產歷史
        public string GetQryProductionHistoryEIP(int MoId, int ProcessId, string ProdStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT b.ProcessAlias
                            , d.UserNo, d.UserName, a.ProdStatus, a.Quantity, a.CauseNo
                            , ISNULL(c.MachineName, '') AS MachineName
                            , ISNULL(c.MachineDesc, '') AS MachineDesc
                            , ISNULL(e.CauseName, '') AS CauseName
                            , FORMAT(a.InputDate, 'yyyy-MM-dd HH:mm:ss') AS InputDate
                            , s.StatusName AS ProdStatusName
                            FROM MES.MoProcessTransaction a
                            INNER JOIN MES.MoProcess b on b.MoId = a.MoId and b.MoProcessId = a.MoProcessId
                            INNER JOIN MES.Machine c on c.MachineId = a.MachineId
                            INNER JOIN BAS.[User] d on d.UserId  = a.CreateBy
                            INNER JOIN BAS.[Status] s ON s.StatusNo = a.ProdStatus AND s.StatusSchema = 'BarcodeProcess.ProdStatus'
                            LEFT JOIN QMS.DefectCause e ON e.CauseNo = a.CauseNo
                            WHERE a.MoId = @MoId 
                            AND b.ProcessId = @ProcessId";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("ProcessId", ProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProdStatus", @" and a.ProdStatus = @ProdStatus", ProdStatus);
                    sql += @" ORDER BY a.MoProcessId ASC";
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProductionHistoryEIP -- 取得生產歷史資料-- 
        public string GetProductionHistoryEIP(int MoProcessId, string ProdStatus, string BarcodeNo)
        {
            try
            {
                if (MoProcessId <= 0) throw new SystemException("製令製程編號不能為空!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT a.BarcodeProcessId, a.ProdStatus, a.CycleTime, a.MoProcessId, a.StationQty
                            , i.CauseNo, ISNULL(i.CauseName, '') CauseName
                            , FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                            , b.WoSeq
                            , c.WoErpPrefix + '-'+ c.WoErpNo WoErpFullNo
                            , d.BarcodeNo
                            , e.ProcessId, e.ProcessAlias
                            , ISNULL(f.MachineName, '') AS MachineName
                            , ISNULL(f.MachineDesc, '') AS MachineDesc 
                            , g.UserNo StartUserNo, g.UserName StartUserName
                            , h.UserNo FinishUserNo, h.UserName FinishUserName
                            , (
                                SELECT (ja.TypeName + ':' + j.ItemValue) ItemValue
                                FROM MES.BarcodeAttribute j
                                INNER JOIN BAS.[Type] ja ON j.ItemNo = ja.TypeNo AND ja.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE j.BarcodeId = a.BarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , s.StatusName AS ProdStatusName
                            FROM MES.BarcodeProcess a
                            INNER JOIN MES.ManufactureOrder b ON b.MoId = a.MoId
                            INNER JOIN MES.WipOrder c ON c.WoId = b.WoId
                            INNER JOIN MES.Barcode d ON d.BarcodeId = a.BarcodeId AND d.ParentBarcode IS NULL
                            INNER JOIN MES.MoProcess e ON e.MoProcessId = a.MoProcessId
                            LEFT JOIN MES.Machine f ON f.MachineId = a.MachineId
                            INNER JOIN BAS.[User] g ON g.UserId = a.StartUserId
                            INNER JOIN BAS.[User] h ON h.UserId = a.FinishUserId
                            LEFT JOIN QMS.DefectCause i ON i.CauseNo = a.CauseNo
                            INNER JOIN BAS.[Status] s ON s.StatusNo = a.ProdStatus AND s.StatusSchema = 'BarcodeProcess.ProdStatus'
                            WHERE a.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ProdStatus", @" AND a.ProdStatus = @ProdStatus", ProdStatus);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND d.BarcodeNo = @BarcodeNo", BarcodeNo);

                    sql += @" ORDER BY d.BarcodeNo";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeTrackingEIP -- 取得條碼追蹤資料 
        public string GetBarcodeTrackingEIP(int BarcodeId, string BarcodeNo
            , int[] CustomerIds, bool unValid
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (!unValid && CustomerIds == null) throw new SystemException("客戶資料錯誤!");
                if (BarcodeNo.Length <= 0) throw new SystemException("【產品條碼】不能為空!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //先檢查是否為TrayBarcode
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT BarcodeNo
                            FROM MES.Tray
                            WHERE TrayNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in TrayResult)
                    {
                        if (item.BarcodeNo == null) break;
                        BarcodeNo = item.BarcodeNo;
                    }
                    #endregion

                    string[] MtlItemNos = null;
                    if (CustomerIds != null)
                    {
                        using (SqlConnection officialConnection = new SqlConnection(OfficialConnectionStrings))
                        {
                            #region //取得客戶篩選條件
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT DISTINCT a.MtlItemNo
                                    FROM EIP.CustMtlItemFilter a
                                    INNER JOIN EIP.[Member] b ON b.MemberId = a.MemberId
                                    WHERE EXISTS (
	                                    SELECT TOP 1 1 FROM EIP.CsCustomer aa 
	                                    INNER JOIN EIP.CsCustomerDetail ab ON ab.CsCustId = aa.CsCustId
	                                    WHERE aa.CsCustId = b.CsCustId
	                                    AND ab.CustomerId IN @CustomerIds
                                    )";
                            dynamicParameters.Add("CustomerIds", CustomerIds);
                            MtlItemNos = officialConnection.Query(sql, dynamicParameters).Select(s => { return (string)s.MtlItemNo; }).ToArray();
                            #endregion
                        }
                    }

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeStatus, a.CurrentMoProcessId, a.BarcodeQty, a.CurrentProdStatus
                            , b.WoSeq
                            , c.WoErpPrefix + '-' + c.WoErpNo AS WoErpFullNo
                            , d.MtlItemNo
                            , j.StatusName AS BarcodeStatusName
                            , ISNULL(
                                (
                                    SELECT t.BarcodeProcessId, t.ProdStatus, t.CycleTime, t.MoProcessId, t.StationQty
                                    , FORMAT(t.StartDate, 'yyyy-MM-dd HH:mm:ss') AS StartDate
                                    , FORMAT(t.FinishDate, 'yyyy-MM-dd HH:mm:ss') AS FinishDate
                                    , u.ProcessAlias
                                    , ISNULL(v.MachineName, '') AS MachineName
                                    , ISNULL(v.MachineDesc, '') AS MachineDesc
                                    , w.UserNo StartUserNo, w.UserName AS StartUserName
                                    , x.UserNo FinishUserNo, x.UserName AS FinishUserName
                                    , z.TypeName + ':' + y.ItemValue AS AttributeVallue
                                    , xa.WoSeq
                                    , xb.WoErpPrefix + '-' + xb.WoErpNo AS WoErpFullNo
                                    , xc.StatusName AS ProdStatusName
                                    FROM MES.BarcodeProcess t
                                    INNER JOIN MES.MoProcess u ON u.MoProcessId = t.MoProcessId
                                    LEFT JOIN MES.Machine v ON v.MachineId = t.MachineId
                                    INNER JOIN BAS.[User] w ON w.UserId = t.StartUserId
                                    INNER JOIN BAS.[User] x ON x.UserId = t.FinishUserId
                                    INNER JOIN BAS.[Status] xc ON xc.StatusNo = t.ProdStatus AND xc.StatusSchema = 'BarcodeProcess.ProdStatus'
                                    LEFT JOIN MES.BarcodeProcessAttribute y ON y.BarcodeProcessId = t.BarcodeProcessId
                                    LEFT JOIN BAS.[Type] z ON z.TypeNo = y.ItemNo AND z.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    INNER JOIN MES.ManufactureOrder xa ON t.MoId = xa.MoId
                                    INNER JOIN MES.WipOrder xb ON xa.WoId = xb.WoId
                                    WHERE t.BarcodeId = a.BarcodeId
                                    ORDER BY t.StartDate
                                    FOR JSON PATH, ROOT('data')
                                ), '') ProcessDetail
                            , (
                                SELECT (ea.TypeName + ':' + e.ItemValue) ItemValue
                                FROM MES.BarcodeAttribute e
                                INNER JOIN BAS.[Type] ea ON e.ItemNo = ea.TypeNo AND ea.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE e.BarcodeId = a.BarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , e.TypeName AS CurrentProdStatusName
                            , f.ProcessAlias CurrentProcessName
                            , ISNULL(g.ProcessAlias, '無下製程') NextProcessName
                            , i.TrayNo
                            FROM MES.Barcode a
                            INNER JOIN MES.ManufactureOrder b ON b.MoId = a.MoId
                            INNER JOIN MES.WipOrder c ON c.WoId = b.WoId
                            INNER JOIN PDM.MtlItem d ON d.MtlItemId = c.MtlItemId
                            INNER JOIN BAS.[Type] e ON a.CurrentProdStatus = e.TypeNo AND TypeSchema = 'Barcode.CurrentProdStatus'
                            INNER JOIN MES.MoProcess f ON a.CurrentMoProcessId = f.MoProcessId
                            INNER JOIN BAS.[Status] j ON j.StatusNo = a.BarcodeStatus AND j.StatusSchema = 'Barcode.BarcodeStatus'
                            LEFT JOIN MES.MoProcess g ON a.NextMoProcessId = g.MoProcessId
                            LEFT JOIN MES.BarcodeAttribute h ON a.BarcodeId = h.BarcodeId AND h.ItemNo = 'Lettering'
                            LEFT JOIN MES.Tray i ON a.BarcodeNo = i.BarcodeNo
                            WHERE a.BarcodeNo = @BarcodeNo
                            --WHERE EXISTS (SELECT TOP 1 1
						    --      FROM MES.ManufactureOrder b1
                            --      INNER JOIN MES.Barcode b2 ON b1.MoId = b2.MoId
							--      WHERE c.WoId = b1.WoId
                            --      AND b2.BarcodeNo = a.BarcodeNo)
                            --      AND a.BarcodeNo LIKE '%' + @BarcodeNo + '%' OR h.ItemValue LIKE '%' + @BarcodeNo + '%'";
                    if (!unValid && CustomerIds != null)
                    {
                        sql += @" AND EXISTS (SELECT TOP 1 1 
                                FROM SCM.SaleOrder a1
                                INNER JOIN SCM.SoDetail a2 ON a1.SoId = a2.SoId
                                WHERE a1.CustomerId IN @CustomerIds
                                AND d.MtlItemId = a2.MtlItemId)";
                        dynamicParameters.Add("CustomerIds", CustomerIds);

                        if (MtlItemNos.Any())
                        {
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNos", @" AND d.MtlItemNo IN @MtlItemNos", MtlItemNos);
                        }
                    }
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeProcessEventEIP -- 取得條碼過站事件資料
        public string GetBarcodeProcessEventEIP(int UserId, string BarcodeNo, string ProcessEventName, string MtlItemNo, string StartDate, string FinishDate, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "TT.BarcodeNo";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns = @",TT.ProcessAlias,TT.BarcodeProcessDetail";
                    sqlQuery.mainTables = @"FROM
                                            (
                                              SELECT 
                                              DISTINCT  e.BarcodeNo
                                                ,d.ProcessAlias 
                                                ,(
                                                    SELECT  f1.TypeName, b1.ProcessEventName, g1.UserName,
                                                            FORMAT(a1.StartDate, 'yyyy-MM-dd HH:mm:ss') AS StartDate,
                                                            FORMAT(a1.FinishDate, 'yyyy-MM-dd HH:mm:ss') AS FinishDate
                                                    FROM MES.BarcodeProcessEvent a1
                                                    INNER JOIN MES.ProcessEventItem b1 ON a1.ProcessEventItemId = b1.ProcessEventItemId
                                                    INNER JOIN MES.BarcodeProcess c1 ON a1.BarcodeProcessId = c1.BarcodeProcessId
                                                    INNER JOIN MES.MoProcess d1 ON c1.MoProcessId = d1.MoProcessId
                                                    INNER JOIN MES.Barcode e1 ON e1.BarcodeId = c1.BarcodeId
                                                    INNER JOIN BAS.Type f1 ON f1.TypeNo = b1.ProcessEventType AND f1.TypeSchema = 'ProcessEventItem'
                                                    INNER JOIN BAS.[User] g1 ON g1.UserId = a1.LastModifiedBy
                                                    WHERE c1.BarcodeProcessId = c.BarcodeProcessId
                                                    FOR JSON PATH, ROOT('data')
                                                ) AS BarcodeProcessDetail
                                            FROM MES.BarcodeProcessEvent a
                                            INNER JOIN MES.ProcessEventItem b ON a.ProcessEventItemId = b.ProcessEventItemId
                                            INNER JOIN MES.BarcodeProcess c ON a.BarcodeProcessId = c.BarcodeProcessId
                                            INNER JOIN MES.MoProcess d ON c.MoProcessId = d.MoProcessId
                                            INNER JOIN MES.Barcode e ON e.BarcodeId = c.BarcodeId
                                            INNER JOIN BAS.Type f ON f.TypeNo = b.ProcessEventType AND f.TypeSchema = 'ProcessEventItem'
                                            WHERE e.BarcodeNo = @BarcodeNo AND e.ParentBarcode IS NULL

                                            ) TT";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND e.BarcodeNo=@BarcodeNo";
                    //dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND c.StartDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FinishDate", @" AND c.FinishDate <= @FinishDate ", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");

                    //sqlQuery.conditions = queryCondition;
                    //sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;
                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWoDataEIP -- 基礎過站資訊 -- Chia Yuan -- 2024.03.21
        public string GetWoDataEIP(int ProcessId, string WoErpFullNo, string MtlItemNo, string StartDate, string EndDate, int[] CustomerIds, string BarcodeNo, string Status, string isNewFinish
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (CustomerIds == null) throw new SystemException("客戶資料錯誤!");

                List<EtergeWoData> etergeWoData = new List<EtergeWoData>();
                List<EtergeWoDataDetail> etergeWoDataDetail = new List<EtergeWoDataDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //取得公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT a.CompanyId, a.ErpDb, b.CustomerId
                            FROM BAS.Company a
                            INNER JOIN SCM.Customer b ON b.CompanyId = a.CompanyId
                            WHERE b.CustomerId IN @CustomerIds";
                    dynamicParameters.Add("CustomerIds", CustomerIds);
                    var resultCompany = sqlConnection.Query(sql, dynamicParameters).ToList();
                    #endregion

                    if (resultCompany.Count() <= 0) throw new SystemException("客戶資料錯誤!");

                    foreach (var corp in resultCompany)
                    {
                        string[] MtlItemNos = null;
                        using (SqlConnection officialConnection = new SqlConnection(OfficialConnectionStrings))
                        {
                            #region //取得客戶篩選條件
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT DISTINCT a.MtlItemNo
                                    FROM EIP.CustMtlItemFilter a
                                    INNER JOIN EIP.[Member] b ON b.MemberId = a.MemberId
                                    WHERE EXISTS (
	                                    SELECT TOP 1 1 FROM EIP.CsCustomer aa 
	                                    INNER JOIN EIP.CsCustomerDetail ab ON ab.CsCustId = aa.CsCustId
	                                    WHERE aa.CsCustId = b.CsCustId
	                                    AND ab.CustomerId IN @CustomerIds
                                    )";
                            dynamicParameters.Add("CustomerIds", CustomerIds);
                            MtlItemNos = officialConnection.Query(sql, dynamicParameters).Select(s => { return (string)s.MtlItemNo; }).ToArray();
                            #endregion
                        }

                        #region //搜尋製令所有條碼過站資訊
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.BarcodeProcessId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", b1.WoErpPrefix + '-' + b1.WoErpNo AS WoErpFullNo
                            , b.MoId, b.[Status] AS MoStatus
                            , c.BarcodeId, c.BarcodeNo 
                            , d.MoProcessId, d.ProcessAlias
                            , a.StationQty, a.PassQty, a.NgQty, a.CycleTime
                            , FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') AS StartDate
                            , FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') AS FinishDate, a.ProdStatus AS BarcodeStatus
                            , e.UserNo + '-' + e.UserName AS StarUser
                            , f.UserNo + '-' + f.UserName AS FinishUser
                            , g.MachineNo, g.MachineName, g.MachineDesc
                            , h.MtlItemId, h.MtlItemNo, h.MtlItemName, h.MtlItemSpec
                            , i.ProcessId, i.ProcessName, a.ROWNUM, ISNULL(a.CauseNo,'') AS CauseNo
						    ,  FORMAT(LAG(a.FinishDate) OVER ( PARTITION BY a.BarcodeId ORDER BY a.BarcodeProcessId ), 'yyyy-MM-dd HH:mm:ss') AS LastStopFinish 
						    , (DATEDIFF (SECOND, FORMAT(LAG(a.FinishDate) OVER ( PARTITION BY a.BarcodeId ORDER BY a.BarcodeProcessId ), 'yyyy-MM-dd HH:mm:ss'),a.StartDate)) AS WaitTime";
                        sqlQuery.mainTables =
                            @"FROM (
                                SELECT ROW_NUMBER() OVER (PARTITION BY MoProcessId, BarcodeId ORDER BY FinishDate DESC) AS ROWNUM
                                , a.BarcodeProcessId, a.MoId, a.BarcodeId, a.MoProcessId, a.StartUserId, a.FinishUserId, a.MachineId, a.CauseNo
                                , a.StationQty, a.PassQty, a.NgQty, a.CycleTime, a.ProdStatus
                                , a.FinishDate, a.StartDate
                                FROM MES.BarcodeProcess a
                            ) AS a
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            INNER JOIN MES.WipOrder b1 ON b.WoId = b1.WoId
                            INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId AND c.ParentBarcode IS NULL
                            INNER JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                            INNER JOIN BAS.[User] e ON a.StartUserId = e.UserId
                            LEFT JOIN BAS.[User] f ON a.FinishUserId = f.UserId
                            INNER JOIN MES.Machine g ON a.MachineId = g.MachineId
                            INNER JOIN PDM.MtlItem h ON b1.MtlItemId = h.MtlItemId AND h.CompanyId = b1.CompanyId
                            INNER JOIN MES.Process i ON d.ProcessId = i.ProcessId AND i.CompanyId = b1.CompanyId";
                        sqlQuery.auxTables = "";
                        string queryCondition = @" AND b1.CompanyId = @CompanyId 
                                                   AND a.FinishDate >= a.StartDate
                                                   AND EXISTS (
                                                        SELECT TOP 1 1 
                                                        FROM SCM.SaleOrder xa
                                                        INNER JOIN SCM.SoDetail xb ON xb.SoId = xa.SoId
                                                        AND xb.MtlItemId = b1.MtlItemId
                                                        AND xa.CustomerId = @CustomerId
                                                   )";
                        dynamicParameters.Add("CompanyId", corp.CompanyId);
                        dynamicParameters.Add("CustomerId", corp.CustomerId);

                        if (MtlItemNos.Any())
                        {
                            BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNos", @" AND h.MtlItemNo IN @MtlItemNos", MtlItemNos);
                        }

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ProcessId", @" AND d.ProcessId = @ProcessId", ProcessId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "WoErpFullNo", @" AND b1.WoErpPrefix + '-' + b1.WoErpNo LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND (h.MtlItemNo LIKE '%' + @MtlItemNo + '%' OR h.MtlItemName LIKE '%' + @MtlItemNo + '%')", MtlItemNo);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.FinishDate >= @StartDate ", StartDate.Length > 0 ? (Convert.ToDateTime(StartDate).AddDays(-1)).ToString("yyyy-MM-dd 08:00:00") : "");
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.FinishDate <= @EndDate ", EndDate.Length > 0 ? (Convert.ToDateTime(EndDate).AddDays(1)).ToString("yyyy-MM-dd 07:59:59") : "");
                        //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserId", @" AND f.UserId = @UserId ", UserId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.ProdStatus IN @Status ", Status.Split(','));
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "isNewFinish", @" AND a.ROWNUM = @isNewFinish ", isNewFinish);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND c.BarcodeNo = @BarcodeNo ", BarcodeNo);

                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.BarcodeId, a.BarcodeProcessId";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        etergeWoDataDetail.AddRange(BaseHelper.SqlQuery<EtergeWoDataDetail>(sqlConnection, dynamicParameters, sqlQuery).ToList());
                        #endregion

                        var barcodeProcessIds = etergeWoDataDetail.Select(s => s.BarcodeProcessId).ToList();

                        #region //找原始過站數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId,a.BarcodeProcessId,a1.ProcessAlias,a.StationQty, isnull(b.TransactionQty,0) FromQty, isnull(c.TransactionQty,0) ToQty,
                                       a.StationQty + isnull(b.TransactionQty,0) - isnull(c.TransactionQty,0) OrignQty
                                       , b.FromBarcodeId FromFromBarcodeId, b.ToBarcodeId FromToBarcodeId
									   , c.FromBarcodeId ToFromBarcodeId, c.ToBarcodeId ToToBarcodeId, a.CycleTime
                                 FROM (
                                         SELECT ROW_NUMBER() OVER (PARTITION BY MoProcessId, BarcodeId ORDER BY BarcodeProcessId DESC) AS ROWNUM,*
                                         FROM MES.BarcodeProcess 
                                      ) AS  a
                                 INNER JOIN MES.MoProcess a1 ON a.MoProcessId = a1.MoProcessId
                                 LEFT JOIN MES.BarcodeTransfer b ON a.BarcodeProcessId = b.FromBarcodeProcessId
                                 LEFT JOIN MES.BarcodeTransfer c ON a.BarcodeProcessId = c.ToBarcodeProcessId
                                 WHERE a.BarcodeProcessId IN @BarcodeProcessIds 
								 ORDER BY a.BarcodeProcessId, a1.MoProcessId, b.TransactionId DESC , c.TransactionId DESC";
                        dynamicParameters.Add("BarcodeProcessIds", barcodeProcessIds);
                        var orignQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //判斷是否最新最新過站
                        foreach (var item in etergeWoDataDetail)
                        {
                            var isnewfinish = "";
                            var orignqty = 0;
                            var finishDay = item.FinishDate;
                            var workDay = "";

                            if (Convert.ToDateTime(finishDay) >= Convert.ToDateTime(Convert.ToDateTime(finishDay).ToString("yyyy-MM-dd 00:00:00")) && Convert.ToDateTime(finishDay) <= Convert.ToDateTime(Convert.ToDateTime(finishDay).ToString("yyyy-MM-dd 08:00:00")))
                            {
                                workDay = Convert.ToDateTime(finishDay).AddDays(-1).ToString("yyyy-MM-dd");
                            }
                            else
                            {
                                workDay = Convert.ToDateTime(finishDay).ToString("yyyy-MM-dd");
                            }

                            if (item.ROWNUM == 1)
                            {
                                isnewfinish = "Y";
                            }
                            else
                            {
                                isnewfinish = "N";
                            }


                            var value = etergeWoDataDetail.Find(x => x.BarcodeProcessId == item.BarcodeProcessId);
                            if (value != null)
                            {
                                value.isNewFinish = isnewfinish;
                                value.WorkDay = workDay;
                            }

                            if (orignQtyResult.Count() > 0)
                            {

                                foreach (var item2 in orignQtyResult)
                                {
                                    if (item2.CycleTime > 0)
                                    {
                                        if (item.BarcodeProcessId == item2.BarcodeProcessId)
                                        {
                                            int FromFromBarcodeId = item2.FromFromBarcodeId ?? -1;
                                            int FromToBarcodeId = item2.FromToBarcodeId ?? -1; ;
                                            int ToFromBarcodeId = item2.ToFromBarcodeId ?? -1; ;
                                            int ToToBarcodeId = item2.ToToBarcodeId ?? -1; ;

                                            //判定條碼是否有非良品條碼
                                            sql = @"SELECT BarcodeId, CurrentProdStatus
                                            FROM MES.Barcode
                                            WHERE CurrentProdStatus = 'F'";
                                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "FromFromBarcodeId", @" AND (BarcodeId = @FromFromBarcodeId ", FromFromBarcodeId);
                                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "FromToBarcodeId", @" OR BarcodeId = @FromToBarcodeId) ", FromToBarcodeId);
                                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ToFromBarcodeId", @" AND (BarcodeId = @ToFromBarcodeId ", ToFromBarcodeId);
                                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ToToBarcodeId", @" OR BarcodeId = @ToToBarcodeId) ", ToToBarcodeId);

                                            var barcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                            if (barcodeResult.Count() > 0)
                                            {

                                                if (orignQtyResult.Count() == 1)
                                                {
                                                    orignqty = item2.StationQty;
                                                }
                                                else
                                                {
                                                    orignqty = item2.StationQty + item2.FromQty + item2.ToQty;

                                                }

                                            }
                                            else
                                            {
                                                if (orignQtyResult.Count() == 1)
                                                {
                                                    orignqty = item2.StationQty;
                                                }
                                                else
                                                {
                                                    orignqty = item2.StationQty + item2.FromQty + item2.ToQty;

                                                }

                                            }

                                            var value2 = etergeWoDataDetail.Find(x => x.BarcodeProcessId == item2.BarcodeProcessId);
                                            if (value2 != null)
                                            {
                                                value2.StationQty = orignqty;
                                            }

                                        }
                                    }
                                    else
                                    {
                                        if (item2.OrignQty == 0 && item2.CycleTime == 0 && item.BarcodeStatus == "P")
                                        {
                                            etergeWoDataDetail = etergeWoDataDetail.Where(x => x.BarcodeProcessId != item2.BarcodeProcessId).ToList();
                                        }
                                    }

                                }

                            }

                        }
                        #endregion

                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = etergeWoDataDetail
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWipBarcodeEIP -- 取得特定站別在製條碼 -- 
        public string GetWipBarcodeEIP(int MoProcessId, string WipStatus, string BarcodeNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (MoProcessId <= 0) throw new SystemException("製令製程不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    if (WipStatus == "未開工")
                    {
                        sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                                , b.ProcessAlias CurrentProcessAlias
                                , ISNULL(d.ProcessAlias, '已完工') NextProcessAlias
                                , e.TypeName CurrentProdStatusName
                                , f.StatusName BarcodeStatusName
                                , g.TrayNo
                                , (
                                    SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                    FROM MES.BarcodeAttribute x
                                    INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    WHERE x.BarcodeId = a.BarcodeId
                                    FOR JSON PATH, ROOT('data')
                                ) ItemValue
                                FROM MES.Barcode a
                                INNER JOIN MES.MoProcess b ON b.MoProcessId = a.CurrentMoProcessId
                                LEFT JOIN MES.MoProcess d ON a.NextMoProcessId = d.MoProcessId
                                INNER JOIN BAS.[Type] e ON a.CurrentProdStatus  = e.TypeNo AND e.TypeSchema = 'Barcode.CurrentProdStatus'
                                INNER JOIN BAS.[Status] f ON a.BarcodeStatus = f.StatusNo AND f.StatusSchema = 'Barcode.BarcodeStatus'
                                LEFT JOIN MES.Tray g ON a.BarcodeNo = g.BarcodeNo
                                WHERE (a.CurrentMoProcessId != @MoProcessId AND a.NextMoProcessId = @MoProcessId AND a.ParentBarcode IS NULL)
                                OR (b.SortNumber = 1 AND a.CurrentMoProcessId = @MoProcessId AND a.NextMoProcessId = @MoProcessId)
                                AND NOT EXISTS (
                                    SELECT TOP 1 1 FROM MES.BarcodeProcess c
                                    WHERE c.BarcodeId = a.BarcodeId AND c.MoProcessId = b.MoProcessId AND a.ParentBarcode IS NULL
                                )";
                        if (!string.IsNullOrWhiteSpace(BarcodeNo))
                        {
                            sql += @" AND a.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        }
                        sql += @" ORDER BY a.BarcodeId DESC";
                    }
                    else if (WipStatus == "開工中")
                    {
                        sql = @"SELECT b.BarcodeNo, b.BarcodeQty, b.CurrentProdStatus, b.BarcodeStatus
                                , c.ProcessAlias CurrentProcessAlias
                                , ISNULL(d.ProcessAlias, '已完工') NextProcessAlias
                                , e.TypeName CurrentProdStatusName
                                , f.StatusName BarcodeStatusName
                                , g.TrayNo
                                , (
                                    SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                    FROM MES.BarcodeAttribute x
                                    INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    WHERE x.BarcodeId = a.BarcodeId
                                    FOR JSON PATH, ROOT('data')
                                ) ItemValue
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId AND b.ParentBarcode IS NULL
                                INNER JOIN MES.MoProcess c ON c.MoProcessId = b.CurrentMoProcessId
                                LEFT JOIN MES.MoProcess d ON b.NextMoProcessId = d.MoProcessId
                                INNER JOIN BAS.[Type] e ON b.CurrentProdStatus  = e.TypeNo AND e.TypeSchema = 'Barcode.CurrentProdStatus'
                                INNER JOIN BAS.[Status] f ON b.BarcodeStatus = f.StatusNo AND f.StatusSchema = 'Barcode.BarcodeStatus'
                                LEFT JOIN MES.Tray g ON b.BarcodeNo = g.BarcodeNo
                                WHERE a.MoProcessId = @MoProcessId
                                AND a.FinishDate IS NULL";

                        if (!string.IsNullOrWhiteSpace(BarcodeNo))
                        {
                            sql += @" AND b.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        }
                        sql += @" ORDER BY b.BarcodeId DESC";
                    }
                    else if (WipStatus == "已完工")
                    {
                        sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                                , b.ProcessAlias CurrentProcessAlias
                                , ISNULL(c.ProcessAlias, '已完工') NextProcessAlias
                                , d.TypeName CurrentProdStatusName
                                , e.StatusName BarcodeStatusName
                                , f.TrayNo
                                , (
                                    SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                    FROM MES.BarcodeAttribute x
                                    INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    WHERE x.BarcodeId = a.BarcodeId
                                    FOR JSON PATH, ROOT('data')
                                ) ItemValue
                                FROM MES.Barcode a
                                INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
                                LEFT JOIN MES.MoProcess c ON a.NextMoProcessId = c.MoProcessId
                                INNER JOIN BAS.[Type] d ON a.CurrentProdStatus  = d.TypeNo AND d.TypeSchema = 'Barcode.CurrentProdStatus'
                                INNER JOIN BAS.[Status] e ON a.BarcodeStatus = e.StatusNo AND e.StatusSchema = 'Barcode.BarcodeStatus'
                                LEFT JOIN MES.Tray f ON a.BarcodeNo = f.BarcodeNo
                                WHERE a.CurrentMoProcessId = @MoProcessId AND a.NextMoProcessId != a.CurrentMoProcessId AND a.ParentBarcode IS NULL";

                        if (!string.IsNullOrWhiteSpace(BarcodeNo))
                        {
                            sql += @" AND a.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        }
                        sql += @" ORDER BY a.BarcodeId DESC";
                    }
                    else
                    {
                        throw new SystemException("查詢方式不被允許!!");
                    }

                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion

        #region //API
        #region //RptMoInformationNotifier -- 查詢現況生產異常名單及進行推播程序 -- Ann 2024-05-16
        public string RptMoInformationNotifier(string Company, string ActualStart)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (ActualStart.Length <= 0) throw new SystemException("【日期範圍】不能為空!");

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyId
                                FROM BAS.Company a
                                WHERE a.CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!!");

                        foreach (var item in companyResult)
                        {
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        #region //Insert DB && Search DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"DECLARE @WipNo nvarchar(32);
                                DECLARE @MoId int;
                                DECLARE @Quantity int;
                                DECLARE @MtlItemNo nvarchar(32);
                                DECLARE @MtlItemName nvarchar(200);
                                DECLARE @MtlItemSpec nvarchar(32);
                                DECLARE @BarcodeQty int;
                                DECLARE @CurrentProcessId int;
                                DECLARE @CurrentProcess nvarchar(32);
                                DECLARE @CurrentSortNumber int;
                                DECLARE @Counter int = 1;
                                DECLARE @NewSortNumber int = 0;
                                DECLARE @SortNumberCnt int = 1;

                                --先delete 舊資料
                                DELETE a 
                                FROM MES.RptMoInformation a 
                                INNER JOIN PDM.MtlItem b ON a.MtlItemNo = b.MtlItemNo
                                WHERE b.CompanyId = @CompanyId;

                                DECLARE WipInformation CURSOR FOR
	                                SELECT a.WoErpPrefix + '-' + a.WoErpNo WipNo,
		                                   b.MoId,b.Quantity,
		                                   c.MtlItemNo,c.MtlItemName,c.MtlItemSpec,
		                                   SUM(e.BarcodeQty) BarcodeQty,
		                                   e.NextMoProcessId CurrentProcessId,
		                                   n1.ProcessAlias CurrentProcess,
		                                   n1.SortNumber CurrentSortNumber
	                                  FROM MES.WipOrder a
		                                   LEFT JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
		                                   INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
		                                   LEFT JOIN (SELECT x.MoId,
							                                 x.BarcodeId,
							                                 x.BarcodeNo,
							                                 x.BarcodeQty,
							                                 CASE WHEN x1.FinishDate IS NOT NULL 
						  		                                  THEN x.NextMoProcessId
							                                 ELSE x.CurrentMoProcessId
							                                 END NextMoProcessId
						                                FROM MES.Barcode x
							                                 INNER JOIN MES.BarcodeProcess x1 ON x.CurrentMoProcessId = x1.BarcodeProcessId) e ON b.MoId = e.MoId
		                                   LEFT JOIN MES.MoProcess n1 ON e.NextMoProcessId = n1.MoProcessId
	                                 WHERE a.CompanyId = @CompanyId
	                                   AND a.ActualStart >= @ActualStart
	                                 GROUP BY a.WoErpPrefix + '-' + a.WoErpNo,
		                                   b.MoId,b.Quantity,
		                                   c.MtlItemNo,c.MtlItemName,c.MtlItemSpec,
		                                   n1.ProcessAlias,
		                                   n1.SortNumber,
		                                   e.NextMoProcessId;

                                OPEN WipInformation;
                                FETCH NEXT FROM WipInformation INTO @WipNo,@MoId,@Quantity,@MtlItemNo,@MtlItemName,@MtlItemSpec,@BarcodeQty,@CurrentProcessId,@CurrentProcess,@CurrentSortNumber;
                                WHILE @@FETCH_STATUS = 0
                                BEGIN

                                  --重設SortNumber
                                  SET @NewSortNumber = @CurrentSortNumber;
                                  SET @SortNumberCnt = 1;
                                  --PRINT 'Level 1 @NewSortNumber=' + CAST(@NewSortNumber AS nvarchar(10)) + ' SortNumberCnt = ' + CAST(@SortNumberCnt AS nvarchar(10))

                                  WHILE @SortNumberCnt != 0
                                  BEGIN
                                    DECLARE @UnCompletedProcess nvarchar(32);
	                                DECLARE @UnCompletedProcessId int;
                                    DECLARE @CycleTime int;
	                                DECLARE @MoveTime int;

                                    DECLARE ProcessCycleTime CURSOR FOR
                                      SELECT a.MoProcessId UnCompletedProcessId,a.ProcessAlias UnCompletedProcess,
	                                         c.CycleTime,c.MoveTime
                                        FROM MES.MoProcess a
		                                     INNER JOIN MES.MoRouting b ON a.MoId = b.MoId
		                                     INNER JOIN MES.RoutingItemProcess c ON b.RoutingItemId = c.RoutingItemId AND a.RoutingProcessId = c.RoutingProcessId
	                                   WHERE a.MoId = @MoId
		                                 AND a.SortNumber = @NewSortNumber;

	                                OPEN ProcessCycleTime;
	                                FETCH ProcessCycleTime INTO @UnCompletedProcessId, @UnCompletedProcess,@CycleTime, @MoveTime;
	                                WHILE @@FETCH_STATUS = 0
	                                BEGIN
	                                  INSERT INTO MES.RptMoInformation(WipNo,MoId,BarcodeQty,MtlItemNo,MtlItemName,MtlItemSpec,
	                                                                   CurrentProcess,CurrentProcessId,
									                                   UnCompletedProcess,UnCompletedProcessId,UnCompletedTime)
								                                VALUES(@WipNo,@MoId,@BarcodeQty,@MtlItemNo,@MtlItemName,@MtlItemSpec,
								                                       @CurrentProcess,@CurrentProcessId,
									                                   @UnCompletedProcess,@UnCompletedProcessId,(@BarcodeQty * @CycleTime) + @MoveTime)

	                                  FETCH NEXT FROM ProcessCycleTime INTO @UnCompletedProcessId, @UnCompletedProcess,@CycleTime, @MoveTime;
	                                END
	                                CLOSE ProcessCycleTime;
                                    DEALLOCATE ProcessCycleTime;

	                                SELECT @SortNumberCnt = COUNT(1)
	                                  FROM MES.MoProcess
	                                 WHERE MoId = @MoId
	                                   AND SortNumber = @NewSortNumber;

	                                IF @SortNumberCnt != 0 
	                                BEGIN
	                                SET @NewSortNumber = @NewSortNumber + 1;
	                                END

                                  END

                                  FETCH NEXT FROM WipInformation INTO @WipNo,@MoId,@Quantity,@MtlItemNo,@MtlItemName,@MtlItemSpec,@BarcodeQty,@CurrentProcessId,@CurrentProcess,@CurrentSortNumber;
                                END

                                CLOSE WipInformation;
                                DEALLOCATE WipInformation;

                                SELECT  a.WipNo, a.MtlItemNo, a.MtlItemName, a.MtlItemSpec, a.LastSyncDate,
                                        b.ExpectedStart, b.ExpectedEnd,
		                                e.CompanyNo,
                                        DATEADD(second, SUM(a.UnCompletedTime), GETDATE()) AS DateOfLastUpdate, 
                                        DATEDIFF(day, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) AS RemainingDay,
                                        ROUND(SUM(a.UnCompletedTime) / 3600.0, 2) AS RemainingHours,
                                        c.MfgOfLastUpdate,
                                        DATEDIFF(hour, c.MfgOfLastUpdate, GETDATE()) AS MfgOfLastHours,
                                        CASE 
                                            WHEN DATEDIFF(hour, c.MfgOfLastUpdate, GETDATE()) > 2 THEN '已超過2小時未加工' 
                                            ELSE '2小時內有加工' 
                                        END AS mfg_status,
                                        CASE 
                                            WHEN DATEDIFF(hour, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) BETWEEN 0 AND 24 THEN '距離交貨日不足一日'
                                            WHEN DATEDIFF(hour, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) <= 0 THEN '已超過預計完工日'
                                            ELSE '正常加工中'
                                        END AS status1
                                FROM MES.RptMoInformation a
                                INNER JOIN MES.WipOrder b ON a.WipNo = b.WoErpPrefix + '-' + b.WoErpNo
                                INNER JOIN (
                                    SELECT c1.MoId, MAX(c1.StartDate) AS MfgOfLastUpdate
                                    FROM MES.BarcodeProcess c1
                                    GROUP BY c1.MoId
                                ) c ON a.MoId = c.MoId
                                INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                                INNER JOIN BAS.Company e ON b.CompanyId = e.CompanyId
                                WHERE b.CompanyId = @CompanyId
                                GROUP BY a.WipNo, a.MtlItemNo, a.MtlItemName, a.MtlItemSpec, b.ExpectedStart, b.ExpectedEnd, c.MfgOfLastUpdate, e.CompanyNo, a.LastSyncDate
                                HAVING DATEDIFF(hour, c.MfgOfLastUpdate, GETDATE()) > 2
                                    OR DATEDIFF(hour, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) BETWEEN 0 AND 24
                                    OR DATEDIFF(hour, DATEADD(second, SUM(a.UnCompletedTime), GETDATE()), b.ExpectedEnd) <= 0";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("ActualStart", ActualStart);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //MAMO推播
                        if (result.Count() > 0)
                        {
                            string PushType = "Channel";
                            string SendId = "";
                            string ChannelNo = "";

                            #region //取得推播群組
                            switch (CurrentCompany)
                            {
                                case 2:
                                    ChannelNo = "(中揚)生產進度異常通知群";
                                    break;
                                case 4:
                                    ChannelNo = "(晶彩)生產進度異常通知群";
                                    break;
                                default:
                                    throw new SystemException("此公司別尚未設定MAMO推播群組!!");
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.ChannelId
                                    FROM MAMO.Channels a 
                                    WHERE a.ChannelNo = @ChannelNo";
                            dynamicParameters.Add("ChannelNo", ChannelNo);

                            var ChannelsResult = sqlConnection.Query(sql, dynamicParameters);

                            if (ChannelsResult.Count() <= 0) throw new SystemException("此公司別尚未設定MAMO推播群組!!");

                            foreach (var item in ChannelsResult)
                            {
                                int channelId = item.ChannelId;
                                SendId = channelId.ToString();
                            }
                            #endregion

                            #region //組傳送文字格式
                            //string barcodeInfoDesc = "|#|製令|品號|品名|預計開工|預計完工|提醒|警告狀態|連結|\n";
                            //barcodeInfoDesc += "|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|\n";
                            //int row = 1;
                            //foreach (var item in result)
                            //{
                            //    string reportUrl = "[查看](https://bm.zy-tech.com.tw/MesReport/ProductionInProcess?WoErpFullNo=" + item.WipNo + ")";
                            //    //string status = item.status1 == "正常加工中" ? item.status1 : "<font color=red>" + item.status1 + "</font>";
                            //    barcodeInfoDesc += "|" + row + ".|" + item.WipNo + "|" + item.MtlItemNo + "|" + item.MtlItemName + "|"
                            //        + item.ExpectedStart + "|" + item.ExpectedEnd + "|" + item.mfg_status + "|" + item.status1 + "|" + reportUrl + "|\n";
                            //    row++;
                            //}

                            string reportUrl = "[查看異常報表](https://bm.zy-tech.com.tw/MesReport/RptMoInformation?CompanyNo=" + Company + ")";

                            string Content = "### 【生產進度異常通知】\n" +
                                             "##### 排程啟動時間: " + CreateDate.ToString() + "\n" +
                                             "##### 起始時間範圍: " + ActualStart.ToString() + "\n" +
                                             reportUrl + "\n";
                            #endregion

                            #region //標記
                            List<string> Tags = new List<string>();
                            #endregion

                            #region //檔案
                            List<int> Files = new List<int>();
                            #endregion

                            #region //Push
                            string MamoResult = mamoHelper.SendMessage(Company, 986, PushType, SendId, Content, Tags, Files);

                            JObject MamoResultJson = JObject.Parse(MamoResult);
                            if (MamoResultJson["status"].ToString() != "success")
                            {
                                throw new SystemException(MamoResultJson["msg"].ToString());
                            }
                            #endregion
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //MoProgressDetailNotInventoryMamoEIP 製令完工未入庫，發mamo訊息通知 -- WuTc -- 2024-07-31
        public string MoProgressDetailNotInventoryMamoEIP(string Company)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司資訊
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.CompanyNo, a.CompanyId
                                FROM BAS.Company a 
                                WHERE a.CompanyNo = @Company";
                    dynamicParameters.Add("Company", Company);

                    var CompanyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (CompanyResult.Count() <= 0) throw new SystemException("公司資料錯誤!!");

                    string CompanyNo = "";
                    int CompanyId = 0;
                    foreach (var item in CompanyResult)
                    {
                        CompanyNo = item.CompanyNo;
                        CompanyId = item.CompanyId;
                    }
                    #endregion

                    #region //取得資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT mf.MoId, pm.ModeNo, pm.ModeName, wo.WoErpPrefix, wo.WoErpNo, mf.WoSeq
                                , mt.MtlItemNo, mt.MtlItemName, mt.MtlItemDesc
                                , FORMAT( CONVERT( DATE, mf.CreateDate ), 'yyyy-MM-dd' ) MoCreateDay
                                , mf.Quantity, mf.CompleteQty
	                            , ( SELECT SUM( mwd.ReceiptQty ) FROM MES.MweDetail mwd WHERE mwd.MoId = mf.MoId ) InventoryQty
	                            FROM MES.ManufactureOrder mf
	                            INNER JOIN MES.MweDetail mw ON mf.MoId = mw.MoId AND mw.ConfirmStatus ='Y'
	                            LEFT JOIN MES.ProdMode pm ON pm.ModeId = mf.ModeId
	                            INNER JOIN MES.WipOrder wo ON mf.WoId = wo.WoId
	                            INNER JOIN PDM.MtlItem mt ON wo.MtlItemId = mt.MtlItemId
	                            WHERE wo.CompanyId = 4 AND mf.CreateDate > '2024-01-01' AND mf.CompleteQty > 0 
	                            AND mf.CompleteQty > ( SELECT SUM( mwd.ReceiptQty ) FROM MES.MweDetail mwd WHERE mwd.MoId = mf.MoId )";

                    dynamicParameters.Add("CompanyId", Company);

                    sql += @"   ORDER BY mf.MoId DESC";
                    #endregion

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        #region //MAMO推播通知
                        string Content = "";
                        string moInfoDesc = "| 製令 | 品號 | 品名 | 完工數 | 入庫數 | 完工待入庫 |\n| :-- | :-- |\n";

                        foreach (var item in result)
                        {
                            int DiffQty = Convert.ToInt16(item.CompleteQty) - Convert.ToInt16(item.InventoryQty);
                            moInfoDesc += "| " + item.WoErpPrefix + "-" + item.WoErpNo + "(" + item.WoSeq + ")" + " | " + item.MtlItemNo + " | " + item.MtlItemName + " | " + item.CompleteQty + " | " + item.InventoryQty + " | " + DiffQty + " |\n";
                        }

                        Content = "### 【製令完工未入庫通知】\n" + moInfoDesc + "\n";

                        string SendId = "";
                        string ChannelNo = "";
                        #region //取得推播群組
                        switch (CurrentCompany)
                        {
                            case 2:
                                throw new SystemException("此公司別尚未設定MAMO推播群組!!");
                                //ChannelNo = "";
                                //break;
                            case 4:
                                ChannelNo = "【晶彩】已完工未入庫通知群";
                                break;
                            default:
                                throw new SystemException("此公司別尚未設定MAMO推播群組!!");
                        }

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.ChannelId
                                    FROM MAMO.Channels a 
                                    WHERE a.ChannelNo = @ChannelNo";
                        dynamicParameters.Add("ChannelNo", ChannelNo);

                        var ChannelsResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ChannelsResult.Count() <= 0) throw new SystemException("此公司別尚未設定MAMO推播群組!!");

                        foreach (var item in ChannelsResult)
                        {
                            int channelId = item.ChannelId;
                            SendId = channelId.ToString();
                        }
                        #endregion

                        #region //取得標記USER資料(原送測人員部門)
                        List<string> Tags = new List<string>();
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.UserId
                                , b.UserNo, b.UserName
                                FROM MAMO.ChannelMembers a
                                INNER JOIN BAS.[User] b ON a.UserId = b.UserId
                                WHERE a.ChannelId = @SendId";
                        dynamicParameters.Add("SendId", SendId);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in UserResult)
                        {
                            Tags.Add(item.UserNo);
                        }
                        #endregion

                        List<int> Files = new List<int>();

                        string MamoResult = mamoHelper.SendMessage(CompanyNo, CurrentUser, "Channel", SendId, Content, Tags, Files);

                        JObject MamoResultJson = JObject.Parse(MamoResult);
                        if (MamoResultJson["status"].ToString() != "success")
                        {
                            throw new SystemException(MamoResultJson["msg"].ToString());
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = MamoResult
                        });
                        #endregion
                    }
                    else
                    {
                        throw new SystemException("查無資料！");
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //MrDetailAbnormalEIP 領料異常，發mamo訊息通知 -- WuTc -- 2024-08-01
        public string MrDetailAbnormalEIP(string Company)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司資訊
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.CompanyNo, a.CompanyId
                                FROM BAS.Company a
                                WHERE a.CompanyNo = @Company";
                    dynamicParameters.Add("Company", Company);

                    var CompanyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (CompanyResult.Count() <= 0) throw new SystemException("公司資料錯誤!!");

                    string CompanyNo = "";
                    int CompanyId = 0;
                    foreach (var item in CompanyResult)
                    {
                        CompanyNo = item.CompanyNo;
                        CompanyId = item.CompanyId;
                    }
                    #endregion

                    #region //取得資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT wo.WoId, mf.MoId, wo.PlanQty, wo.RequisitionSetQty, wd.DemandRequisitionQty, wd.RequisitionQty
	                        , mt.MtlItemNo, mt.MtlItemName, mt.MtlItemDesc, st.StatusName, wo.ConfirmStatus, s.UserName
	                        , wo.WoErpPrefix, wo.WoErpNo, mf.WoSeq
	                        FROM MES.WipOrder wo
	                        INNER JOIN MES.ManufactureOrder mf ON wo.WoId = mf.WoId AND wo.CompanyId = 4 AND wo.ConfirmStatus != 'Y'
	                        LEFT JOIN ( SELECT SUM(DemandRequisitionQty) DemandRequisitionQty,SUM(RequisitionQty) RequisitionQty, WoId
				                        FROM MES.WoDetail
				                        GROUP BY WoId) wd ON wo.WoId = wd.WoId
	                        INNER JOIN PDM.MtlItem mt ON wo.MtlItemId = mt.MtlItemId
	                        INNER JOIN BAS.[Status] st ON mf.[Status] = st.StatusNo AND st.StatusSchema='ManufactureOrder.Status'
	                        INNER JOIN BAS.[User] s on mf.CreateBy = s.UserId
	                        WHERE  wo.RequisitionSetQty > wo.PlanQty OR wd.RequisitionQty > wd.DemandRequisitionQty";

                    dynamicParameters.Add("CompanyId", CompanyId);

                    sql += @"   ORDER BY wo.WoId DESC";
                    #endregion

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        #region //MAMO推播通知
                        string Content = "";
                        string moInfoDesc = "| 製令 | 品號 | 品名 | 預計產量(套) | 實際領料(套) | 需領用量 | 已領用量 | 製令狀態 |\n| :-- | :-- |\n";

                        foreach (var item in result)
                        {
                            moInfoDesc += "| " + item.WoErpPrefix + "-" + item.WoErpNo + "(" + item.WoSeq + ")" + " | " + item.MtlItemNo + " | " + item.MtlItemName + " | " + item.PlanQty + " | " + item.RequisitionSetQty + " | " + item.DemandRequisitionQty + " | " + item.RequisitionQty + " | " + item.StatusName + " |\n";
                        }

                        Content = "### 【領料異常通知】\n" + moInfoDesc + "\n" + " - PS. 製令用量=預計產量*單位用量/底數\n";

                        string SendId = "";
                        string ChannelNo = "";
                        #region //取得推播群組
                        switch (CurrentCompany)
                        {
                            case 2:
                                throw new SystemException("此公司別尚未設定MAMO推播群組!!");
                            //ChannelNo = "";
                            //break;
                            case 4:
                                ChannelNo = "【晶彩】領料異常通知群";
                                break;
                            default:
                                throw new SystemException("此公司別尚未設定MAMO推播群組!!");
                        }

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.ChannelId
                                    FROM MAMO.Channels a 
                                    WHERE a.ChannelNo = @ChannelNo";
                        dynamicParameters.Add("ChannelNo", ChannelNo);

                        var ChannelsResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ChannelsResult.Count() <= 0) throw new SystemException("此公司別尚未設定MAMO推播群組!!");

                        foreach (var item in ChannelsResult)
                        {
                            int channelId = item.ChannelId;
                            SendId = channelId.ToString();
                        }
                        #endregion

                        #region //取得標記USER資料(原送測人員部門)
                        List<string> Tags = new List<string>();
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.UserId
                                , b.UserNo, b.UserName
                                FROM MAMO.ChannelMembers a
                                INNER JOIN BAS.[User] b ON a.UserId = b.UserId
                                WHERE a.ChannelId = @SendId";
                        dynamicParameters.Add("SendId", SendId);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in UserResult)
                        {
                            Tags.Add(item.UserNo);
                        }
                        #endregion

                        List<int> Files = new List<int>();

                        string MamoResult = mamoHelper.SendMessage(CompanyNo, CurrentUser, "Channel", SendId, Content, Tags, Files);

                        JObject MamoResultJson = JObject.Parse(MamoResult);
                        if (MamoResultJson["status"].ToString() != "success")
                        {
                            throw new SystemException(MamoResultJson["msg"].ToString());
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = MamoResult
                        });
                        #endregion
                    }
                    else
                    {
                        throw new SystemException("查無資料！");
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion
        #endregion

        #region //階層條碼用
        #region //GetBarcodeStatusInfo -- 取得該條碼下階層條碼(FOR Parent) -- GPAI 2024.10.29
        public string GetBarcodeStatusInfo(int BarcodeId)
        {
            try
            {

              
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion


                    dynamicParameters = new DynamicParameters();
                    sql = @"DECLARE @InputBarcode INT = @BarcodeId;
                            DECLARE @CurrentBarcode INT;
                            DECLARE @ParentBarcode INT;
                            
                            -- 建立表變量來存儲結果
                            DECLARE @BarcodeResults TABLE (
                                BarcodeId INT,
                                BarcodeNo NVARCHAR(100),
                                ParentBarcode INT,
                                BarcodeQty INT,
                                isLeaf NVARCHAR(100)
                            );
                            
                            INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, ParentBarcode, BarcodeQty,isLeaf)
                            SELECT 
                                BarcodeId,
                                BarcodeNo,
                                ParentBarcode,
                                BarcodeQty,
                                isLeaf
                            FROM MES.Barcode
                            WHERE BarcodeId = @InputBarcode;
                           
                            SET @CurrentBarcode = @InputBarcode;
                            SET @ParentBarcode = (SELECT TOP 1 ParentBarcode FROM MES.Barcode WHERE BarcodeId = @CurrentBarcode);
                            
                            -- 向下查找下層條碼
                            WHILE @CurrentBarcode IS NOT NULL
                            BEGIN
                                -- 所有下層條碼
                                INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, ParentBarcode, BarcodeQty, isLeaf)
                                SELECT 
                                    BarcodeId,
                                    BarcodeNo,
                                    ParentBarcode,
                                    BarcodeQty,
                                    isLeaf
                                FROM MES.Barcode
                                WHERE ParentBarcode = @CurrentBarcode;
                            
                                SET @CurrentBarcode = (SELECT TOP 1 BarcodeId FROM MES.Barcode WHERE ParentBarcode = @CurrentBarcode);
                            
                                IF @CurrentBarcode IS NULL
                                    BREAK;
                            END
                            
                            -- 查同ParentBarcode其他條碼
                            INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, ParentBarcode, BarcodeQty, isLeaf)
                            SELECT 
                                BarcodeId,
                                BarcodeNo,
                                ParentBarcode,
                                BarcodeQty,
                                isLeaf
                            FROM MES.Barcode
                            WHERE ParentBarcode = @ParentBarcode 
                              AND BarcodeId <> @InputBarcode;  -- 排除查詢的條碼
                            
                            -- 顯示所有條碼資料
                            SELECT 
                                BarcodeId,
                                BarcodeNo,
                                ParentBarcode,
                                BarcodeQty,
                                isLeaf
                            FROM @BarcodeResults
                            ORDER BY isLeaf;
                            ";
                    dynamicParameters.Add("BarcodeId", BarcodeId);


                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion

                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeStatusInfo -- 取得該條碼上下階層包裝條碼(FOR PACKAGE) -- GPAI 2024.10.29
        public string GetBarcodeStatusInfo2(int BarcodeId)
        {
            try
            {


                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpDb
                            FROM BAS.Company a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion


                    dynamicParameters = new DynamicParameters();
                    sql = @"DECLARE @InputBarcode INT = @BarcodeId;
                            DECLARE @CurrentBarcode INT;
                            DECLARE @PrevBarcodeId INT;
                            
                            -- 建立表變量來存儲結果
                            DECLARE @BarcodeResults TABLE (
                                BarcodeId INT,
                                BarcodeNo NVARCHAR(100),
                                PrevBarcodeId INT,
                                BarcodeQty INT,
                                isLeaf NVARCHAR(100)
                            );
                            
                            INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, PrevBarcodeId, BarcodeQty,isLeaf)
                            SELECT 
                                BarcodeId,
                                BarcodeNo,
                                PrevBarcodeId,
                                BarcodeQty,
                                isLeaf
                            FROM MES.Barcode
                            WHERE BarcodeId = @InputBarcode;
                            
                            -- PrevBarcodeId
                            SET @PrevBarcodeId = (SELECT PrevBarcodeId FROM MES.Barcode WHERE BarcodeId = @InputBarcode);
                            
                            -- 向上找所有上層條碼
                            SET @CurrentBarcode = @PrevBarcodeId; 
                            
                            WHILE @CurrentBarcode IS NOT NULL
                            BEGIN
                                -- 上層條碼
                                INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, PrevBarcodeId, BarcodeQty, isLeaf)
                                SELECT 
                                    BarcodeId,
                                    BarcodeNo,
                                    PrevBarcodeId,
                                    BarcodeQty,
                                    isLeaf
                                FROM MES.Barcode
                                WHERE BarcodeId = @CurrentBarcode;
                            
                                SET @CurrentBarcode = (SELECT PrevBarcodeId FROM MES.Barcode WHERE BarcodeId = @CurrentBarcode);
                            END
                            
                            SET @CurrentBarcode = @InputBarcode;
                            
                            -- 向下查找下層條碼
                            WHILE @CurrentBarcode IS NOT NULL
                            BEGIN
                                -- 所有下層條碼
                                INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, PrevBarcodeId, BarcodeQty, isLeaf)
                                SELECT 
                                    BarcodeId,
                                    BarcodeNo,
                                    PrevBarcodeId,
                                    BarcodeQty,
                                    isLeaf
                                FROM MES.Barcode
                                WHERE PrevBarcodeId = @CurrentBarcode;
                            
                                SET @CurrentBarcode = (SELECT TOP 1 BarcodeId FROM MES.Barcode WHERE PrevBarcodeId = @CurrentBarcode);
                            
                                IF @CurrentBarcode IS NULL
                                    BREAK;
                            END
                            
                            -- 查同ParentBarcode其他條碼
                            INSERT INTO @BarcodeResults (BarcodeId, BarcodeNo, PrevBarcodeId, BarcodeQty, isLeaf)
                            SELECT 
                                BarcodeId,
                                BarcodeNo,
                                PrevBarcodeId,
                                BarcodeQty,
                                isLeaf
                            FROM MES.Barcode
                            WHERE PrevBarcodeId = @PrevBarcodeId
                              AND BarcodeId <> @InputBarcode;  -- 排除查詢的條碼
                            
                            -- 顯示所有條碼資料
                            SELECT 
                                BarcodeId,
                                BarcodeNo,
                                PrevBarcodeId,
                                BarcodeQty,
                                isLeaf
                            FROM @BarcodeResults
                            ORDER BY isLeaf;

                            ";
                    dynamicParameters.Add("BarcodeId", BarcodeId);


                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion

                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion


        #endregion

        #region//Mail樣版
        public string SendQcMail(string SettingSchema, string SettingNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //Mail資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MailSubject, a.MailContent
            , b.Host, b.Port, b.SendMode, b.Account, b.Password
            , ISNULL(c.MailFrom, '') MailFrom, ISNULL(d.MailTo, '') MailTo, ISNULL(e.MailCc, '') MailCc, ISNULL(f.MailBcc, '') MailBcc
            FROM BAS.Mail a
            LEFT JOIN BAS.MailServer b ON b.ServerId = a.ServerId
            OUTER APPLY (
                SELECT STUFF((
                    SELECT ';' + CASE WHEN ca.ContactId IS NULL THEN 
                        CASE cc.JobType 
                            WHEN '管理制' THEN cd.DepartmentName + cc.Job + '-' + cc.UserName + ':' + cc.Email
                            ELSE cd.DepartmentName + '-' + cc.UserName + ':' + cc.Email
                        END
                    ELSE cb.ContactName + ':' + cb.Email END
                    FROM BAS.MailUser ca
                    LEFT JOIN BAS.MailContact cb ON ca.ContactId = cb.ContactId
                    LEFT JOIN BAS.[User] cc ON ca.UserId = cc.UserId AND cc.[Status] = 'A'
                    LEFT JOIN BAS.Department cd ON cc.DepartmentId = cd.DepartmentId
                    WHERE ca.MailId = a.MailId
                    AND ca.MailUserType = 'F'
                    FOR XML PATH('')
                ), 1, 1, '') MailFrom
            ) c
            OUTER APPLY (
                SELECT STUFF((
                    SELECT ';' + CASE WHEN da.ContactId IS NULL THEN 
                        CASE dc.JobType 
                            WHEN '管理制' THEN dd.DepartmentName + dc.Job + '-' + dc.UserName + ':' + dc.Email
                            ELSE dd.DepartmentName + '-' + dc.UserName + ':' + dc.Email
                        END
                    ELSE db.ContactName + ':' + db.Email END
                    FROM BAS.MailUser da
                    LEFT JOIN BAS.MailContact db ON da.ContactId = db.ContactId
                    LEFT JOIN BAS.[User] dc ON da.UserId = dc.UserId AND dc.[Status] = 'A'
                    LEFT JOIN BAS.Department dd ON dc.DepartmentId = dd.DepartmentId
                    WHERE da.MailId = a.MailId
                    AND da.MailUserType = 'T'
                    FOR XML PATH('')
                ), 1, 1, '') MailTo
            ) d
            OUTER APPLY (
                SELECT STUFF((
                    SELECT ';' + CASE WHEN ea.ContactId IS NULL THEN 
                        CASE ec.JobType 
                            WHEN '管理制' THEN ed.DepartmentName + ec.Job + '-' + ec.UserName + ':' + ec.Email
                            ELSE ed.DepartmentName + '-' + ec.UserName + ':' + ec.Email
                        END
                    ELSE eb.ContactName + ':' + eb.Email END
                    FROM BAS.MailUser ea
                    LEFT JOIN BAS.MailContact eb ON ea.ContactId = eb.ContactId
                    LEFT JOIN BAS.[User] ec ON ea.UserId = ec.UserId AND ec.[Status] = 'A'
                    LEFT JOIN BAS.Department ed ON ec.DepartmentId = ed.DepartmentId
                    WHERE ea.MailId = a.MailId
                    AND ea.MailUserType = 'C'
                    FOR XML PATH('')
                ), 1, 1, '') MailCc
            ) e
            OUTER APPLY (
                SELECT STUFF((
                    SELECT ';' + CASE WHEN fa.ContactId IS NULL THEN 
                        CASE fc.JobType 
                            WHEN '管理制' THEN fd.DepartmentName + fc.Job + '-' + fc.UserName + ':' + fc.Email
                            ELSE fd.DepartmentName + '-' + fc.UserName + ':' + fc.Email
                        END
                    ELSE fb.ContactName + ':' + fb.Email END
                    FROM BAS.MailUser fa
                    LEFT JOIN BAS.MailContact fb ON fa.ContactId = fb.ContactId
                    LEFT JOIN BAS.[User] fc ON fa.UserId = fc.UserId AND fc.[Status] = 'A'
                    LEFT JOIN BAS.Department fd ON fc.DepartmentId = fd.DepartmentId
                    WHERE fa.MailId = a.MailId
                    AND fa.MailUserType = 'B'
                    FOR XML PATH('')
                ), 1, 1, '') MailBcc
            ) f
            WHERE a.MailId IN (
                SELECT z.MailId
                FROM BAS.MailSendSetting z
                WHERE z.SettingSchema = @SettingSchema
                AND z.SettingNo = @SettingNo
            )";
                    dynamicParameters.Add("SettingSchema", SettingSchema);
                    dynamicParameters.Add("SettingNo", SettingNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion
    }
}