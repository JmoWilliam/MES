using Dapper;
using Helpers;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using NLog;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Runtime.Serialization.Formatters.Binary;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Transactions;
using System.Web;
using System.Threading;


namespace MESDA
{
    public class ProductionHistoryDA
    {
        public string MainConnectionStrings = "";
        public string ErpConnectionStrings = "";
        public string HrmConnectionStrings = "";
        public string AutomationConnectionStrings = "";
        public int CurrentCompany = -1;
        public int CurrentUser = -1;
        public int CreateBy = -1;
        public int LastModifiedBy = -1;
        public DateTime CreateDate = default(DateTime);
        public DateTime LastModifiedDate = default(DateTime);

        public string sql = "";
        public JObject jsonResponse = new JObject();
        public Logger logger = LogManager.GetCurrentClassLogger();
        public DynamicParameters dynamicParameters = new DynamicParameters();
        public SqlQuery sqlQuery = new SqlQuery();
        public MamoHelper mamoHelper = new MamoHelper();


        public ProductionHistoryDA()
        {
            MainConnectionStrings = ConfigurationManager.AppSettings["MainDb"];
            ErpConnectionStrings = ConfigurationManager.AppSettings["ErpDb"];
            HrmConnectionStrings = ConfigurationManager.AppSettings["HrmDb"];
            AutomationConnectionStrings = ConfigurationManager.AppSettings["AutomationDB"];
            GetUserInfo();

            CreateDate = DateTime.Now;
            LastModifiedDate = DateTime.Now;

            dynamicParameters = new DynamicParameters();
            sqlQuery = new SqlQuery();
        }

        #region //GetUserInfo 取得使用者資訊
        private void GetUserInfo()
        {
            try
            {
                CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["UserCompany"]);
                CurrentUser = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                CreateBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                LastModifiedBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);

                if (HttpContext.Current.Session["CompanySwitch"] != null)
                {
                    if (HttpContext.Current.Session["CompanySwitch"].ToString() == "manual")
                    {
                        CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["CompanyId"]);
                    }
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }
        }
        #endregion

        #region //Get
        #region //MES過站資料收集之用途
        #region //GetManufactureOrder -- 查詢製令資訊 -- Ann 2022-12-01
        public string GetManufactureOrder(int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoId, a.Quantity, a.WoSeq, a.ModeId
                            , b.WoErpPrefix, b.WoErpNo
                            , c.MtlItemNo, c.MtlItemName
                            , f.ModeId
                            , g.ModeNo, g.ModeName, g.BarcodeCtrl
                            , (
                              SELECT TOP 1 1
                              FROM MES.BarcodePrint h
                              INNER JOIN MES.MoSetting ha ON h.MoSettingId = ha.MoSettingId
                              WHERE ha.MoId = a.MoId
                            ) BarcodePrint
                            , (
                              SELECT TOP 1 1
                              FROM MES.MrBarcodeRegister i
                              INNER JOIN MES.MrDetail ia ON i.MrDetailId = ia.MrDetailId
                              WHERE ia.MoId = a.MoId
                            ) MrBarcodeRegister
                            , h.BarcodeCtrl, h.LotStatus
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b ON a.WoId=b.WoId
                            INNER JOIN  PDM.MtlItem c ON b.MtlItemId=c.MtlItemId
                            LEFT JOIN MES.MoRouting d ON a.MoId = d.MoId
                            LEFT JOIN MES.RoutingItem e ON d.RoutingItemId = e.RoutingItemId
                            LEFT JOIN MES.Routing f ON e.RoutingId = f.RoutingId
                            LEFT JOIN MES.ProdMode g ON f.ModeId = g.ModeId
                            INNER JOIN MES.MoSetting h ON a.MoId = h.MoId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWorkShop -- 取得車間資料 -- Ding 2022.09.06
        public string GetWorkShop(int CompanyId, int ShopId, string ShopNo, string ShopName, string Status
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.ShopId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.ShopNo, a.ShopName, a.ShopDesc, a.Location, a.Floor, a.Status";
                    sqlQuery.mainTables =
                        @"FROM MES.WorkShop a";
                    sqlQuery.auxTables = "";
                    string queryCondition = " AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopId", @" AND a.ShopId = @ShopId", ShopId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopNo", @" AND a.ShopNo LIKE '%' + @ShopNo + '%'", ShopNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopName", @" AND a.ShopName LIKE '%' + @ShopName + '%'", ShopName);
                    if (Status.Length > 0) BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND a.Status IN @Status", Status.Split(','));
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.ShopId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineByDevice 取得機台資訊(平板用)
        public string GetMachineByDevice(string DeviceIdentifierCode, int ShopId, string MachineName, string MachineNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            //DeviceIdentifierCode = "192.168.20.114"; //測試用
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //查詢此IP是否有設定任何一筆紀錄
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.DeviceAuthority
                            FROM MES.Device a
                            WHERE a.DeviceIdentifierCode = @DeviceIdentifierCode
                            AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("DeviceIdentifierCode", DeviceIdentifierCode);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var DeviceResult = sqlConnection.Query(sql, dynamicParameters);

                    if (DeviceResult.Count() <= 0)
                    {
                        DeviceIdentifierCode = "192.168.20.114";
                    }

                    string DeviceAuthority = DeviceResult.FirstOrDefault().DeviceAuthority;
                    #endregion

                    if (DeviceAuthority == "H")
                    {
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.MachineId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.MachineNo, a.MachineName, a.MachineDesc
                            , b.ShopId, b.ShopNo, b.ShopName";
                        sqlQuery.mainTables =
                            @"FROM MES.Machine a 
                            INNER JOIN MES.WorkShop b ON a.ShopId = b.ShopId";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopId", @" AND a.ShopId = @ShopId", ShopId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineName", @" AND (a.MachineName LIKE '%' + @MachineName + '%' OR a.MachineDesc LIKE '%' + @MachineName + '%')", MachineName);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineNo", @" AND a.MachineNo = @MachineNo", MachineNo);

                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MachineId";
                    }
                    else
                    {
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.MachineId, a.DeviceId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", b.DeviceIdentifierCode
                        , c.MachineNo, c.MachineName, c.MachineDesc
                        , d.ShopId, d.ShopNo, d.ShopName";
                        sqlQuery.mainTables =
                            @"FROM MES.DeviceMachine a
                        INNER JOIN MES.Device b ON a.DeviceId = b.DeviceId
                        INNER JOIN MES.Machine c ON a.MachineId = c.MachineId
                        INNER JOIN MES.WorkShop d ON c.ShopId = d.ShopId";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND d.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DeviceIdentifierCode", @" AND b.DeviceIdentifierCode = @DeviceIdentifierCode", DeviceIdentifierCode);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopId", @" AND d.ShopId = @ShopId", ShopId);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineName", @" AND (c.MachineName LIKE '%' + @MachineName + '%' OR c.MachineDesc LIKE '%' + @MachineName + '%')", MachineName);
                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineNo", @" AND c.MachineNo = @MachineNo", MachineNo);

                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MachineId, a.DeviceId";
                    }

                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoByProcess 製令對應製程資訊
        public string GetMoByProcess(int MoId, int MachineId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT  a.MoProcessId, a.MoId, a.ProcessId, a.ProcessAlias,a1.ModeId
                            , c.MachineId, c.[Status], a.ConsumeFlag
                            FROM MES.MoProcess a
                            INNER JOIN MES.ManufactureOrder a1 on a.MoId =a1.MoId
                            INNER JOIN MES.ProcessParameter b ON a.ProcessId=b.ProcessId AND a1.ModeId =b.ModeId
                            INNER JOIN MES.ProcessMachine c ON b.ParameterId=c.ParameterId
                            WHERE 1=1
                            AND c.[Status] = 'A'";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineId", @" AND c.MachineId = @MachineId", MachineId);

                    sql += @" ORDER BY a.MoProcessId";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessForVehicle 製令對應製程資訊(物料載盤用)
        public string GetMoProcessForVehicle(int MoId, int MachineId, string WoErpFullNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (WoErpFullNo.Length > 0)
                    {
                        if (WoErpFullNo.IndexOf("-") != -1)
                        {
                            if (WoErpFullNo.IndexOf("(") == -1)
                            {
                                throw new SystemException("【製令】請將括號也一起輸入!!");
                            }
                        }
                        else
                        {
                            MoId = Convert.ToInt32(WoErpFullNo);
                            WoErpFullNo = "";
                        }
                    }

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoProcessId, a.MoId, a.ProcessId, a.ProcessAlias
                            , b.ModeId, b.WoSeq
                            , c.VehicleFlag
                            , d.WoErpPrefix, d.WoErpNo
                            FROM MES.MoProcess a 
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            INNER JOIN MES.MoSetting c ON a.MoId = c.MoId
                            INNER JOIN MES.WipOrder d ON b.WoId = d.WoId
                            WHERE EXISTS (
                                SELECT TOP 1 1
                                FROM MES.MoMtlSetting x 
                                WHERE x.MoProcessId = a.MoProcessId
                            )";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND (d.WoErpPrefix + '-' + d.WoErpNo +  '(' + CONVERT(VARCHAR(10), b.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);

                    sql += @" ORDER BY a.MoProcessId";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcess 取得製程資訊
        public string GetProcess(int MoProcessId)
        {
            try
            {
                if (MoProcessId == -1) throw new Exception("MoProcessId不可為空");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.MoProcessId, a.MoId, a.ProcessId, a.ProcessAlias, a.RoutingProcessId, a.PackageFlag
                            , (
                                SELECT TOP 1 1
                                FROM MES.MoProcessItem x
                                WHERE x.MoProcessId = a.MoProcessId
                            ) MoProcessItemId
                            FROM MES.MoProcess a
                            LEFT JOIN MES.MoProcessItem b ON a.MoProcessId = b.MoProcessId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachine 取得機台資訊
        public string GetMachine(int MachineId)
        {
            try
            {
                if (MachineId == -1) throw new Exception("MachineId不可為空");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.MachineId, a.ShopId, a.MachineName, a.MachineDesc
                            FROM MES.Machine a
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineId", @" AND a.MachineId = @MachineId", MachineId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineNo 取得機台資訊
        public string GetMachineNo(string MachineNo)
        {
            try
            {
                if (MachineNo.Equals("")) throw new Exception("MachineNo不可為空");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.MachineId, a.MachineName, a.MachineDesc
                            FROM MES.Machine a
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineNo", @" AND a.MachineNo = @MachineNo", MachineNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetUser -- 取得登入者資訊
        public string GetUser(int UserId)
        {
            try
            {
                if (UserId == -1) throw new Exception("UserId不可為空");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                   dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.UserId,a.UserNo, a.UserName, a.Email, a.Password, a.Status, c.CompanyId
                            FROM BAS.[User] a
                            INNER JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                            INNER JOIN BAS.Company c ON b.CompanyId = c.CompanyId
                            WHERE 1=1";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UserId", @" AND a.UserId = @UserId", UserId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    if (result.Count() <= 0) throw new SystemException("查無此帳號資料");
                    foreach (var item in result)
                    {
                        if (item.Status == "S") throw new SystemException("該帳號已經停止使用");
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcessQty -- 取得待加工數
        public string GetProcessQty(int MoProcessId)
        {
            try
            {
                if (MoProcessId == -1) throw new Exception("MoProcessId 不可為空");
                int ProcessQty = 0;
                int MaterUnWorkQty = 0;
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT c.BarcodeCtrl,a.SortNumber,a.MoId,c.LotStatus,c.Source
                              FROM MES.MoProcess a
                                   INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
	                               INNER JOIN MES.MoSetting c ON b.MoId = c.MoId
                             WHERE a.MoProcessId = @MoProcessId";

                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);
                    if (MoSettingResult.Count() <= 0) throw new SystemException("找不到Mo Setting資料!");
                    string BarcodeCtrl = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeCtrl;
                    string LotStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).LotStatus;
                    int SortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);
                    string Source = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Source;
                    int MoId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoId);

                    if (BarcodeCtrl.Equals("Y"))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoProcessId,a.MoProcessId,ISNULL(b.ProcessQty,0) ProcessQty
                                  FROM MES.MoProcess a
                                       LEFT JOIN (SELECT x.NextMoProcessId,SUM(x.BarcodeQty) ProcessQty
	                                                FROM MES.Barcode x
				                                   WHERE x.BarcodeStatus = 1
				                                     AND EXISTS(SELECT 1
					                                              FROM MES.BarcodeProcess z
								                                 WHERE x.BarcodeId = z.BarcodeId
								                                   AND z.MoId = x.MoId)
                                                     AND x.MoId = @MoId
				                                   GROUP BY x.NextMoProcessId) b ON a.MoProcessId = b.NextMoProcessId
                                 WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        dynamicParameters.Add("MoId", MoId);

                        var ProcessQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in ProcessQtyResult)
                        {
                            ProcessQty = Convert.ToInt32(item.ProcessQty);
                            if (SortNumber.Equals(1))
                            {
                                if (Source == "MR")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT ISNULL(SUM(c.BarcodeQty), 0) UnWorkQty
                                            FROM MES.MrDetail a
                                                INNER JOIN MES.MrBarcodeRegister b ON a.MrDetailId = b.MrDetailId
                                                INNER JOIN MES.Barcode c ON b.BarcodeNo = c.BarcodeNo ANd c.MoId = a.MoId
                                            WHERE a.MoId = @MoId
                                            AND NOT EXISTS(SELECT 1
                                                            FROM MES.BarcodeProcess d
                                                            WHERE c.BarcodeId = d.BarcodeId
                                                                AND c.MoId = d.MoId)";
                                    dynamicParameters.Add("MoId", MoId);
                                    var MaterUnWorkQtyResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (MaterUnWorkQtyResult.Count() > 0)
                                    {
                                        MaterUnWorkQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).UnWorkQty);
                                    }
                                }
                                else if (Source == "BP")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT ISNULL(SUM(b.BarcodeQty), 0) UnWorkQty
                                            FROM MES.BarcodePrint a 
                                            INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                            WHERE b.MoId = @MoId
                                            AND NOT EXISTS(
                                                SELECT 1
                                                FROM MES.BarcodeProcess c
                                                WHERE c.BarcodeId = b.BarcodeId
                                                AND c.MoId = b.MoId
                                            )";
                                    dynamicParameters.Add("MoId", MoId);
                                    var MaterUnWorkQtyResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (MaterUnWorkQtyResult.Count() > 0)
                                    {
                                        MaterUnWorkQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).UnWorkQty);
                                    }
                                }
                                else {
                                    throw new SystemException("製令條碼來源錯誤!!");
                                }
                                
                                ProcessQty = ProcessQty + MaterUnWorkQty;
                            }
                        }
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT " + ProcessQty.ToString() + " AS ProcessQty ";
                        var unCompleteResult = sqlConnection.Query(sql, dynamicParameters);

                        if (unCompleteResult.Count() <= 0) throw new SystemException("找不到未完工數量資訊, 請洽系統開發室!");

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = unCompleteResult
                        });
                        #endregion
                    }
                    else
                    {
                        //模造類
                        double AllowQty = 0;
                        int ThisQty = 0;
                        int ReturnQty = 0;

                        #region Get 當站過站數累計數量ThiSQty & MoProcess SortNumber
                        // 過站數量不可只計算良品數
                        sql = @"SELECT a.SortNumber,
                                   SUM(ISNULL(b.Quantity,0)) ThisQty
                              FROM MES.MoProcess a
                                   LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                             WHERE a.MoProcessId = @MoProcessId
                             GROUP BY a.SortNumber ";

                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var ThisQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (ThisQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料!");
                        ThisQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ThisQty);
                        #endregion

                        #region //取得是否有指回此站數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(SUM(Quantity),0) ReturnQty
                              FROM MES.MoProcessTransaction 
                             WHERE NextMoProcessId = @MoProcessId
                               AND ProdStatus = 'F'";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var ReturnQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (ReturnQtyResult.Count() > 0)
                        {
                            ReturnQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ReturnQty);
                        }
                        #endregion

                        if (SortNumber.Equals(1))
                        {
                            //首站, 抓取製令開立數量(未來可能改成領料數量)
                            //sql = @"SELECT SUM(ROUND(a.ActualQuantity / (d.RequisitionQty / e.PlanQty), 0)) Quantity
                            //        FROM MES.MrDetail a
                            //        INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                            //        INNER JOIN MES.MoMtlSetting c ON a.MoId = c.MoId
                            //        INNER JOIN MES.WoDetail d ON c.WoDetailId = d.WoDetailId
                            //        INNER JOIN MES.WipOrder e ON d.WoId = e.WoId
                            //        WHERE a.MoId = @MoId
                            //        AND b.ConfirmStatus = 'Y'";

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemId, ISNULL(SUM(a.ActualQuantity), 0) AS Quantity
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    WHERE a.MoId = @MoId
                                      AND b.ConfirmStatus = 'Y'
                                      AND (
                                        SELECT COUNT(DISTINCT MtlItemId)
                                        FROM MES.MrDetail
                                        WHERE MrId = a.MrId
                                        AND MoId = a.MoId
                                        GROUP BY MtlItemId
                                      ) = 1
                                    GROUP BY a.MtlItemId";

                            dynamicParameters.Add("MoId", MoId);
                            var AllowQtyResult = sqlConnection.Query(sql, dynamicParameters);
                            if (AllowQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料");

                            foreach (var item in AllowQtyResult)
                            {
                                int MtlItemId = item.MtlItemId;
                                double currentAllowQty = 0;
                                currentAllowQty = item.Quantity;

                                #region //計算單位用量換算，固定用PCS計算
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.DemandRequisitionQty
                                        , b.PlanQty
                                        FROM MES.WoDetail a 
                                        INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                        INNER JOIN MES.ManufactureOrder c ON b.WoId = c.WoId
                                        WHERE a.MtlItemId = @MtlItemId
                                        AND c.MoId = @MoId";
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                dynamicParameters.Add("MoId", MoId);

                                var WoDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                double DemandRequisitionQty = -1;
                                double PlanQty = -1;
                                foreach (var item2 in WoDetailResult)
                                {
                                    DemandRequisitionQty = item2.DemandRequisitionQty;
                                    PlanQty = item2.PlanQty;
                                }

                                double UnitConsumption = DemandRequisitionQty / PlanQty;

                                AllowQty += (int)Math.Round(Convert.ToDouble(currentAllowQty) / UnitConsumption, MidpointRounding.AwayFromZero);
                                #endregion
                            }
                        }
                        else
                        {
                            //非首站, 抓取上一站Pass數量, 但如果上一站非必過站, 則再往前站抓
                            sql = @"SELECT SUM(ISNULL(b.Quantity,0)) Quantity, a.SortNumber
                                  FROM MES.MoProcess a
                                       LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId AND b.ProdStatus = 'P'
                                 WHERE a.MoId = @MoId
                                   AND a.SortNumber = (SELECT MAX(a1.SortNumber)
                                                         FROM MES.MoProcess a1
						                                WHERE a.MoId = a1.MoId
						                                  AND a1.SortNumber < @SortNumber
						                                  AND a1.NecessityStatus != 'N')
                                 GROUP BY a.SortNumber";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("SortNumber", SortNumber);
                            var AllowQtyResult = sqlConnection.Query(sql, dynamicParameters);
                            if (AllowQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料");
                            AllowQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Quantity);
                            int PreNecessitySort = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);

                            if (PreNecessitySort - SortNumber > 1)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT SUM(ISNULL(b.Quantity,0)) Quantity
                                      FROM MES.MoProcess a
                                           LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                                     WHERE a.MoId = @MoId
                                       AND b.ProdStatus = 'P'
                                       AND a.SortNumber > @CurrentSortNumber 
                                       AND a.SortNumber < @PreNecessitySort ";
                                dynamicParameters.Add("CurrentSortNumber", SortNumber);
                                dynamicParameters.Add("PreNecessitySort", PreNecessitySort);

                                var NonNecessityResult = sqlConnection.Query(sql, dynamicParameters);
                                if (NonNecessityResult.Count() >= 0)
                                {
                                    AllowQty = AllowQty - Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Quantity);
                                }
                            }

                        }

                        sql = @"SELECT @AllowQty + @ReturnQty - @ThisQty AS ProcessQty";
                        dynamicParameters.Add("AllowQty", AllowQty);
                        dynamicParameters.Add("ReturnQty", ReturnQty);
                        dynamicParameters.Add("ThisQty", ThisQty);
                        var unCompleteResult = sqlConnection.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = unCompleteResult
                        });
                        #endregion
                    }

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetMfgOrderProcess -- 取得製令生產製程設定
        public string GetMfgOrderProcess(int MoId, int MoProcessId, int ModeId)
        {
            try
            {
                if (MoId == -1) throw new Exception("MoId 不可為空");
                if (MoProcessId == -1) throw new Exception("MoProcessId 不可為空");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.MoId
                            , b.ProcessId, b.MoProcessId
                            , c.PostCollectionStatus, c.PreCollectionStatus, c.ProcessCheckStatus
                            , c.PassingMode, c.NgToBarcode
                            , d.BarcodeCtrl
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.MoProcess b ON a.MoId=b.MoId
                            INNER JOIN MES.ProcessParameter c ON b.ProcessId=c.ProcessId
                            INNER JOIN MES.ProdMode d ON a.ModeId=d.ModeId
                            WHERE 1=1";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND b.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ModeId", @" AND c.ModeId = @ModeId", ModeId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeProcess -- 取得製令條碼歷程(進階功能用 設定非加工狀態) -- Ann 2022-12-27
        public string GetBarcodeProcess(int BarcodeProcessId, int MoId, int BarcodeId, string BarcodeNo, int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷是否為Tray盤條碼
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT b.TrayBarcode
                            FROM MES.MoProcess a
                            INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                            WHERE a.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var trayBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in trayBarcodeResult)
                    {
                        if (item.TrayBarcode == "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo
                                    FROM MES.Tray a
                                    WHERE a.TrayNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var trayBarcodeNoResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in trayBarcodeNoResult)
                            {
                                BarcodeNo = item2.BarcodeNo;
                            }
                        }
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.BarcodeProcessId, a.BarcodeId BarcodeId, a.MoId, a.MachineId, a.MoProcessId, a.ProdStatus, b.BarcodeQty StationQty
                            , a.PassQty, a.NgQty, a.NgBarcodeId, a.CauseNo, FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                            , a.ModeShiftId, a.CycleTime, a.StartUserId, a.FinishUserId
                            , b.BarcodeNo, b.BarcodeQty, b.BarcodeStatus, b.NextMoProcessId, b.CurrentProdStatus
                            , (
                                SELECT (ca.TypeName + ':' + c.ItemValue) ItemValue
                                , CASE WHEN LEN(LTRIM(RTRIM(c.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(c.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                                FROM MES.BarcodeAttribute c
                                INNER JOIN BAS.[Type] ca ON c.ItemNo = ca.TypeNo AND ca.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE c.BarcodeId = b.BarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , d.ProcessAlias
                            , ISNULL(e.ProcessAlias, '已無下製程') NextMoProcessAlias
                            , f.NgToBarcode, f.TrayBarcode
                            , g.TrayNo
                            , (
                                SELECT TOP 1 1
                                FROM MES.Barcode x 
                                INNER JOIN MES.Barcode xa ON x.ParentBarcode = xa.BarcodeId
                                WHERE xa.BarcodeNo = b.BarcodeNo
                            ) MinBarcodes
                            FROM(
                                SELECT ROW_NUMBER() OVER (PARTITION BY BarcodeId ORDER BY FinishDate DESC) AS ROWNUM
                                , MoProcessId, BarcodeId, MoId, FinishDate, StationQty, BarcodeProcessId, MachineId, ProdStatus, PassQty
                                , NgQty, NgBarcodeId, StartDate, ModeShiftId, CycleTime, StartUserId, FinishUserId, CauseNo
                                FROM MES.BarcodeProcess x 
                                WHERE x.MoProcessId = @MoProcessId
                                AND NOT EXISTS (
                                    SELECT TOP 1 1 FROM MES.BarcodeProcess z 
                                    WHERE z.BarcodeId = x.BarcodeId
                                    AND z.FinishDate IS NULL
                                )
                            ) a
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId AND a.MoProcessId = b.CurrentMoProcessId
                            INNER JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                            LEFT JOIN MES.MoProcess e ON b.NextMoProcessId = e.MoProcessId
                            INNER JOIN MES.MoSetting f ON a.MoId = f.MoId
                            LEFT JOIN MES.Tray g ON b.BarcodeNo = g.BarcodeNo
                            WHERE a.FinishDate IS NOT NULL 
                            AND a.StationQty > 0
                            AND (b.BarcodeStatus IN('1','0'))
                            AND (b.ParentBarcode IS NULL OR b.ParentBarcode = -1)
                            AND ROWNUM = 1
                            AND d.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeProcessId", @" AND a.BarcodeProcessId = @BarcodeProcessId", BarcodeProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeId", @" AND a.BarcodeId = @BarcodeId", BarcodeId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND b.BarcodeNo = @BarcodeNo", BarcodeNo);
                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND d.MoProcessId = @MoProcessId", MoProcessId);

                    sql += @" ORDER BY a.BarcodeId";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMfgMtlSetting -- 取得該站製令上料設定 -- Ann 2022-12-27
        public string GetMfgMtlSetting(int ModeId, string ModeNo, string ModeName, string Status
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.ModeId, a.CompanyId, a.ModeNo, a.ModeName, a.ModeDesc, a.Status
                            FROM Mes.ProdMode a
                            WHERE a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ModeId", @" AND a.ModeId = @ModeId", ModeId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ModeNo", @" AND a.ModeNo LIKE '%' + @ModeNo + '%'", ModeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ModeName", @" AND (a.ModeName LIKE '%' + @ModeName + '%' OR a.ModeDesc LIKE '%' + @ModeName + '%')", ModeName);
                    if (Status.Length > 0) BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND a.Status IN @Status", Status.Split(','));

                    sql += @" ORDER BY a.ModeId";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetDeviceMachine -- 取得設備機台設定 -- William 2022-07-06
        public string GetDeviceMachine(int WarehouseId, int LocationId, string LocationNo, string LocationName, string Status
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.LocationId, a.WarehouseId, a.LocationNo, a.LocationName, a.LocationDesc, a.Status
                            FROM MES.WarehouseLocation a
                            INNER JOIN MES.Warehouse b on a.WarehouseId = b.WarehouseId
                            INNER JOIN MES.WorkShop c on b.ShopId = c.ShopId
                            WHERE c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WarehouseId", @" AND a.WarehouseId = @WarehouseId", WarehouseId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "LocationId", @" AND a.LocationId = @LocationId", LocationId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "LocationNo", @" AND a.LocationNo LIKE '%' + @LocationNo + '%'", LocationNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "LocationName", @" AND a.LocationName LIKE '%' + @LocationName + '%'", LocationName);
                    if (Status.Length > 0) BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND a.Status IN @Status", Status.Split(','));

                    sql += @" ORDER BY a.LocationId";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcessBarcodeInfo -- 取得加工條碼資訊 -- Ann 2022-10-17
        public string GetProcessBarcodeInfo(string BarcodeNo, int MoProcessId)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【條碼】不能為空!");
                if (MoProcessId <= 0) throw new SystemException("【製程】不能為空!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.BarcodeId
                            , a.BarcodeQty
                            , b.PassQty, b.NgQty, FORMAT(b.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate
                            , ISNULL(FORMAT(b.FinishDate, 'yyyy-MM-dd HH:mm:ss'), '') FinishDate
                            , c.ItemValue, c.ItemSeq
                            FROM MES.Barcode a
                            INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                            LEFT JOIN MES.BarcodeProcessAttribute c ON a.BarcodeProcessId = c.BarcodeProcessId
                            WHERE 1=1";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND b.MoProcessId = @MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetActiveBarcode -- 取得尚未完工條碼 -- Ann 2022-10-20
        public string GetActiveBarcode(int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT a.BarcodeId, a.BarcodeNo, a.BarcodeQty
                            , ISNULL(FORMAT(b.StartDate, 'yyyy-MM-dd HH:mm:ss'), '') StartDate, ISNULL(FORMAT(b.FinishDate, 'yyyy-MM-dd HH:mm:ss'), '') FinishDate
                            , ISNULL(c.ItemValue, '') ItemValue
                            , d.NgToBarcode, d.TrayBarcode, d.LotStatus
                            , h.TrayNo
                            , (
                                SELECT (ea.TypeName + ':' + e.ItemValue) ItemValue
                                , CASE WHEN LEN(LTRIM(RTRIM(e.DateCode))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(e.DateCode)) as date), 'yyyy-MM-dd') ELSE NULL END DateCode
                                FROM MES.BarcodeAttribute e
                                INNER JOIN BAS.[Type] ea ON e.ItemNo = ea.TypeNo AND ea.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE e.BarcodeId = a.BarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , (
                                SELECT TOP 1 1
                                FROM MES.Barcode x 
                                INNER JOIN MES.Barcode xa ON x.ParentBarcode = xa.BarcodeId
                                WHERE xa.BarcodeNo = a.BarcodeNo
                            ) MinBarcodes
                            FROM MES.Barcode a
                            INNER JOIN MES.BarcodeProcess b ON a.CurrentMoProcessId = b.MoProcessId AND a.BarcodeId = b.BarcodeId
                            LEFT JOIN MES.BarcodeProcessAttribute c ON b.BarcodeProcessId = c.BarcodeProcessId
                            INNER JOIN MES.MoSetting d ON a.MoId = d.MoId
                            LEFT JOIN MES.Tray h ON a.BarcodeNo = h.BarcodeNo
                            WHERE b.MoProcessId = @MoProcessId
                            AND b.FinishDate IS NULL";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetLetteringInfo -- 取得刻字相關設定 -- Ann 2022-10-20
        public string GetLetteringInfo(int MoProcessId, string ItemNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT a.BarcodeNo, a.BarcodeQty
                            , ISNULL(FORMAT(b.StartDate, 'yyyy-MM-dd HH:mm:ss'), '') StartDate, ISNULL(FORMAT(b.FinishDate, 'yyyy-MM-dd HH:mm:ss'), '') FinishDate
                            , g.ItemNo, g.ChkUnique
                            , ISNULL(h.ItemValue, '') ItemValue
                            FROM MES.Barcode a
                            INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                            INNER JOIN MES.MoProcess c ON b.MoProcessId = c.MoProcessId
                            INNER JOIN MES.MoRouting d ON c.MoRoutingId = d.MoRoutingId
                            INNER JOIN MES.RoutingItem e ON d.RoutingItemId = e.RoutingItemId
                            INNER JOIN MES.RoutingProcess f ON e.RoutingId = f.RoutingId AND c.ProcessId = f.ProcessId
                            LEFT JOIN MES.RoutingProcessItem g ON f.RoutingProcessId = g.RoutingProcessId
                            LEFT JOIN MES.BarcodeProcessAttribute h ON b.BarcodeProcessId = h.BarcodeProcessId
                            WHERE b.MoProcessId = @MoProcessId AND b.FinishDate IS NOT NULL";
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ItemNo", @" AND g.ItemNo = @ItemNo", ItemNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeProcessId -- 取得製令歷程資料ID -- Ann 2022-10-24
        public string GetBarcodeProcessId(int BarcodeId, int MoProcessId, string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.BarcodeProcessId
                            FROM MES.BarcodeProcess a
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                            WHERE b.BarcodeNo = @BarcodeNo AND MoProcessId = @MoProcessId
                            ORDER BY BarcodeProcessId DESC";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeLettering -- 取得刻字號 -- Ann 2022-10-26
        public string GetBarcodeLettering(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ISNULL(a.ItemValue, '') ItemValue, ItemSeq
                            FROM MES.BarcodeAttribute a
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                            WHERE b.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessItem -- 取得製程屬性設定資料 -- Ann 2022-10-27
        public string GetMoProcessItem(int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT b.ItemNo, b.ChkUnique
                            , c.TypeName
                            FROM MES.MoProcess a
                            INNER JOIN MES.MoProcessItem b ON a.MoProcessId = b.MoProcessId
                            INNER JOIN BAS.[Type] c ON b.ItemNo = c.TypeNo AND c.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE a.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeProcessAttribute -- 取得屬性綁定設定資料 -- Ann 2022-10-28
        public string GetBarcodeProcessAttribute(int MoProcessId, string ItemNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeProcessId
                            , b.BarcodeNo, b.BarcodeQty
                            , FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                            , ISNULL(c.ItemNo, null) ItemNo, ISNULL(c.ItemValue, null) ItemValue
                            , d.NgToBarcode, d.TrayBarcode
                            , (
                                SELECT TOP 1 x.ItemValue
                                FROM MES.BarcodeAttribute x
                                WHERE x.MoId = a.MoId
                                AND x.BarcodeId = a.BarcodeId
                                AND x.ItemValue IS NOT NULL
                            ) CheckItemValue
                            , f.TrayNo
                            FROM MES.BarcodeProcess a
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId AND a.MoProcessId = b.CurrentMoProcessId
                            LEFT JOIN MES.BarcodeAttribute c ON a.BarcodeId = c.BarcodeId AND c.ItemNo = @ItemNo
                            INNER JOIN MES.MoSetting d ON a.MoId = d.MoId
                            LEFT JOIN MES.Tray f ON b.BarcodeNo = f.BarcodeNo
                            WHERE a.MoProcessId = @MoProcessId AND a.FinishDate IS NOT NULL AND b.CurrentProdStatus = 'P'
                            ORDER BY a.BarcodeId, a.FinishDate DESC";
                    dynamicParameters.Add("ItemNo", ItemNo);
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetJigBarcode -- 取得治具綁定資料 -- Ann 2022-10-31
        public string GetJigBarcode(int MoProcessId, string JigNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.JigId, a.MoProcessId
                            , c.JigNo, c.JigName
                            , (
                              SELECT COUNT(1) Count
                              FROM MES.JigBarcode d
                              WHERE d.JigId = a.JigId
                              AND d.BarcodeNo IS NOT NULL
                            ) Count
                            FROM MES.JigBarcode a
                            INNER JOIN MES.MachineJig b ON a.JigId = b.JigId
                            INNER JOIN MES.Jig c ON a.JigId = c.JigId
                            WHERE 1=1";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "JigNo", @" AND c.JigNo = @JigNo", JigNo);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("JigNo", JigNo);

                    sql += " GROUP BY a.JigId, a.MoProcessId, c.JigNo, c.JigName";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetJigBarcodeDetail -- 取得治具綁定條碼資料 -- Ann 2022-10-31
        public string GetJigBarcodeDetail(int JigId, string JigNo, int MoProcessId, string WorkingFlag)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.JigBarcodeId, a.JigId, a.BarcodeNo, a.MoProcessId, a.WorkingFlag
                            , b.JigNo, b.JigName
                            FROM MES.JigBarcode a
                            INNER JOIN MES.Jig b ON a.JigId = b.JigId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "JigId", @" AND a.JigId = @JigId", JigId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "JigNo", @" AND b.JigNo = @JigNo", JigNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WorkingFlag", @" AND a.WorkingFlag = @WorkingFlag", WorkingFlag);

                    sql += @" ORDER BY a.CreateDate DESC";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeProcessEvent -- 取得產品事件資料 -- Ann 2022-11-03
        public string GetBarcodeProcessEvent(int MoProcessId, string BarcodeNo, int ModeId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT d.PreCollectionStatus, d.PostCollectionStatus
                            , FORMAT(b.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, ISNULL(FORMAT(b.FinishDate, 'yyyy-MM-dd HH:mm:ss'), '') FinishDate
                            , a.BarcodeNo, a.BarcodeQty
                            , f.ProcessEventNo, e.StartDate EventStartDate, e.FinishDate EventFinishDate, e.CycleTime
                            FROM MES.Barcode a
							INNER JOIN MES.BarcodeProcess b ON b.BarcodeId = a.BarcodeId
							INNER JOIN MES.MoProcess c ON c.MoProcessId = b.MoProcessId
                            INNER JOIN MES.ProcessParameter d ON d.ProcessId = c.ProcessId
                            LEFT JOIN MES.BarcodeProcessEvent e ON e.BarcodeProcessId = a.BarcodeProcessId
							LEFT JOIN MES.ProcessEventItem f ON f.ProcessEventItemId = e.ProcessEventItemId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND b.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ModeId", @" AND d.ModeId = @ModeId", ModeId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoMtlSettingForMTL -- 取得當前製令上料相關設定資料 -- Ann 2022-11-11
        public string GetMoMtlSettingForMTL(int MoId, int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //先確認此製令用料是否有設定需綁定製程
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BindType
                            FROM MES.MoMtlSetting a 
                            WHERE a.MoId = @MoId
                            AND a.MoProcessId IS NOT NULL
                            AND a.BindType != 'N'";
                    dynamicParameters.Add("MoId", MoId);

                    var MoMtlSettingResult = sqlConnection.Query(sql, dynamicParameters);

                    string BindType = "";
                    if (MoMtlSettingResult.Count() > 0)
                    {
                        foreach (var item in MoMtlSettingResult)
                        {
                            BindType = item.BindType;
                        }
                    }
                    else
                    {
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = ""
                        });

                        return jsonResponse.ToString();
                    }
                    #endregion

                    int row = 0;
                    if (BindType == "B")
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT Count(1) BarcodeComponent
                                , (
                                  SELECT Count(1) Count
                                  FROM MES.BarcodeComponent d
                                  INNER JOIN MES.Barcode da ON d.ComponentBarcodeId = da.BarcodeId
                                  WHERE da.MoId = c.MoId
                                ) RegisterCount
                                FROM MES.MrBarcodeRegister a
                                LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                LEFT JOIN MES.MrDetail c ON a.MrDetailId = c.MrDetailId
                                WHERE c.MoId = @MoId
                                GROUP BY c.MoId";
                        dynamicParameters.Add("MoId", MoId);
                        var mtlCountResult = sqlConnection.Query(sql, dynamicParameters);
                        row = mtlCountResult.Count();
                    }
                    else if (BindType == "L")
                    {
                        row++;
                    }

                    if (row > 0)
                    {
                        if (BindType == "B")
                        {
                            sql = @"SELECT a.BarcodeNo, a.BarcodeQty
                                    , d.MtlItemNo, d.MtlItemName
                                    , (
                                        SELECT eb.MtlItemNo ,eb.MtlItemName
                                        FROM MES.MoMtlSetting e
                                        INNER JOIN MES.WoDetail ea ON e.WoDetailId = ea.WoDetailId
                                        INNER JOIN PDM.MtlItem eb ON ea.MtlItemId = eb.MtlItemId
                                        WHERE e.MoId = a.MoId
                                        AND e.BarcodeCtrl = 'Y' AND e.ProcessBinding = 'Y' AND e.MoProcessId = @MoProcessId
                                        FOR JSON PATH, ROOT('data')
                                    ) MoMtlSetting
                                    , (
                                        SELECT eb.MtlItemNo ,eb.MtlItemName
                                        FROM MES.MoMtlSetting e
                                        INNER JOIN MES.WoDetail ea ON e.WoDetailId = ea.WoDetailId
                                        INNER JOIN PDM.MtlItem eb ON ea.MtlItemId = eb.MtlItemId
                                        WHERE e.MoId = a.MoId
                                        AND e.BarcodeCtrl = 'Y' AND e.ProcessBinding = 'Y'
                                        FOR JSON PATH, ROOT('data')
                                    ) MoMtlSettingNotBind
                                    , (
                                        SELECT TOP 1 1
                                        FROM MES.MoProcess x
                                        WHERE x.MoProcessId = a.CurrentMoProcessId
                                        AND x.SortNumber = (
                                            SELECT MAX(xa.SortNumber) MaxSortNumber
                                            FROM MES.MoProcess xa
                                            WHERE xa.MoId = x.MoId
                                        )
                                    ) FinalMoProcessCheck
                                    , FORMAT(f.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(f.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                                    , g.TrayBarcode
                                    , h.TrayNo
                                    FROM MES.Barcode a
                                    LEFT JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                    LEFT JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                    LEFT JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                    INNER JOIN MES.BarcodeProcess f ON a.BarcodeId = f.BarcodeId AND a.CurrentMoProcessId = f.MoProcessId
                                    INNER JOIN MES.MoSetting g ON a.MoId = g.MoId
                                    LEFT JOIN MES.Tray h ON a.BarcodeNo = h.BarcodeNo
                                    WHERE 1=1";
                        }
                        else if (BindType == "L")
                        {
                            sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.ParentBarcode
                                    , d.MtlItemNo, d.MtlItemName
                                    , (
                                        SELECT eb.MtlItemNo ,eb.MtlItemName
                                        FROM MES.MoMtlSetting e
                                        INNER JOIN MES.WoDetail ea ON e.WoDetailId = ea.WoDetailId
                                        INNER JOIN PDM.MtlItem eb ON ea.MtlItemId = eb.MtlItemId
                                        WHERE e.MoId = a.MoId
                                        AND e.ProcessBinding = 'Y' AND e.MoProcessId = @MoProcessId
                                        FOR JSON PATH, ROOT('data')
                                    ) MoMtlSetting
                                    , (
                                        SELECT eb.MtlItemNo ,eb.MtlItemName
                                        FROM MES.MoMtlSetting e
                                        INNER JOIN MES.WoDetail ea ON e.WoDetailId = ea.WoDetailId
                                        INNER JOIN PDM.MtlItem eb ON ea.MtlItemId = eb.MtlItemId
                                        WHERE e.MoId = a.MoId
                                        AND e.ProcessBinding = 'Y'
                                        FOR JSON PATH, ROOT('data')
                                    ) MoMtlSettingNotBind
                                    , (
                                        SELECT TOP 1 1
                                        FROM MES.MoProcess x
                                        WHERE x.MoProcessId = a.CurrentMoProcessId
                                        AND x.SortNumber = (
                                            SELECT MAX(xa.SortNumber) MaxSortNumber
                                            FROM MES.MoProcess xa
                                            WHERE xa.MoId = x.MoId
                                        )
                                    ) FinalMoProcessCheck
                                    , FORMAT(f.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(f.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                                    , g.TrayBarcode
                                    , h.TrayNo
                                    FROM MES.Barcode a
                                    LEFT JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                    LEFT JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                    LEFT JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                    INNER JOIN MES.BarcodeProcess f ON a.BarcodeId = f.BarcodeId AND a.CurrentMoProcessId = f.MoProcessId
                                    INNER JOIN MES.MoSetting g ON a.MoId = g.MoId
                                    LEFT JOIN MES.Tray h ON a.BarcodeNo = h.BarcodeNo
                                    WHERE 1=1";
                        }

                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND f.MoProcessId = @MoProcessId", MoProcessId);

                        sql += @" ORDER BY f.CreateDate DESC";

                        var result = sqlConnection.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoMtlSettingForMTL02 -- 取得當前製令上料相關設定資料 -- Ann 2024-05-14
        public string GetMoMtlSettingForMTL02(int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeQty
                            , b.TrayBarcode, b.VehicleFlag
                            , c.TrayNo
                            , (
                                SELECT TOP 1 FORMAT(x.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate
                                , FORMAT(x.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                                FROM MES.BarcodeProcess x 
                                WHERE x.BarcodeId = a.BarcodeId
                                AND x.MoProcessId = a.CurrentMoProcessId
                                ORDER BY x.CreateDate DESC
                                FOR JSON PATH, ROOT('data')
                            ) BarcodeProcess
                            FROM MES.Barcode a 
                            INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                            LEFT JOIN MES.Tray c ON a.BarcodeNo = c.BarcodeNo
                            INNER JOIN MES.MoProcess d ON a.CurrentMoProcessId = d.MoProcessId
                            INNER JOIN MES.Process e ON d.ProcessId = e.ProcessId
                            WHERE a.CurrentMoProcessId = @MoProcessId
                            AND a.ParentBarcode IS NULL
                            AND a.CurrentProdStatus = 'P'
                            AND (
                                EXISTS (
                                    SELECT TOP 1 1
                                    FROM MES.BarcodeProcess x 
                                    WHERE x.BarcodeId = a.BarcodeId
                                    AND x.MoProcessId = a.CurrentMoProcessId
                                    AND x.FinishDate IS NULL
                                )
                                AND EXISTS (
                                    SELECT TOP 1 1
                                    FROM MES.MoMtlSetting x 
                                    WHERE x.MoId = a.MoId
                                    AND x.MainBarcode = 'N'
                                    AND x.ProcessBinding = 'Y'
                                    AND x.MoProcessId = a.CurrentMoProcessId
                                    AND x.BindType != 'N'
                                )
                            OR e.ProcessNo = 'JMO-IE-0072'
                            )";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoMtlSettingForMoId -- 取得當前製令上料相關設定資料 -- Ann 2022-11-11--
        public string GetMoMtlSettingForMoId(int MoId, int MoProcessId, string AssemblyBarcodeNo)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("製令不能為空!!");
                if (MoProcessId <= 0) throw new SystemException("製令製程不能為空!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT a.BindType 
                            , c.MtlItemId, c.MtlItemNo, c.MtlItemName
                            , (
                                SELECT COUNT(1) Count
                                FROM MES.MrBarcodeRegister x
                                INNER JOIN MES.MrDetail xa ON x.MrDetailId = xa.MrDetailId
                                WHERE xa.MoId = a.MoId AND xa.MtlItemId = b.MtlItemId
                            ) RegisterCount
                            , (
                                SELECT COUNT(1) Count
                                FROM MES.MrBarcodeReRegister x
                                INNER JOIN MES.MrDetail xa ON x.MrDetailId = xa.MrDetailId
                                WHERE xa.MoId = a.MoId AND xa.MtlItemId = b.MtlItemId
                            ) ReRegisterCount
                            , (
                                SELECT COUNT(1) Count FROM MES.BarcodeComponent x 
                                INNER JOIN MES.Barcode xa ON x.AssemblyBarcodeId = xa.BarcodeId
                                INNER JOIN MES.Barcode xb ON x.ComponentBarcodeId = xb.BarcodeId
                                INNER JOIN MES.MrBarcodeRegister xc ON xb.BarcodeNo = xc.BarcodeNo
                                INNER JOIN MES.MrDetail xd ON xc.MrDetailId = xd.MrDetailId
                                WHERE xa.BarcodeNo = @AssemblyBarcodeNo
                                AND xd.MtlItemId = b.MtlItemId
                            ) BarcodeComponent
                            , (
                                SELECT COUNT(1) Count FROM MES.BarcodeComponent x 
                                INNER JOIN MES.Barcode xa ON x.AssemblyBarcodeId = xa.BarcodeId
                                INNER JOIN MES.Barcode xb ON x.ComponentBarcodeId = xb.BarcodeId
                                INNER JOIN MES.MrBarcodeReRegister xc ON xb.BarcodeNo = xc.BarcodeNo
                                INNER JOIN MES.MrDetail xd ON xc.MrDetailId = xd.MrDetailId
                                WHERE xa.BarcodeNo = @AssemblyBarcodeNo
                                AND xd.MtlItemId = b.MtlItemId
                            ) ReBarcodeComponent
                            , (
                                SELECT TOP 1 xb.LotNumberNo
                                FROM MES.BarcodeComponent x 
                                INNER JOIN MES.Barcode xa ON x.AssemblyBarcodeId = xa.BarcodeId
                                INNER JOIN SCM.LotNumber xb ON x.LotNumberId = xb.LotNumberId
                                INNER JOIN MES.MrDetail xc ON xb.MtlItemId = xc.MtlItemId
                                INNER JOIN MES.MaterialRequisition xd ON xc.MrId = xd.MrId
                                WHERE xa.BarcodeNo = @AssemblyBarcodeNo
                                AND xc.MtlItemId = b.MtlItemId
                                AND xd.DocType != '56'
                            ) LotBarcodeComponent
                            FROM MES.MoMtlSetting a
                            INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                            INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                            WHERE a.MoId = @MoId
                            AND a.ProcessBinding = 'Y'
                            AND a.MoProcessId = @MoProcessId
                            AND a.MainBarcode != 'Y'";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("AssemblyBarcodeNo", AssemblyBarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessMaterials -- 取得當前製令製程需上料之物料 -- Ann 2024-05-30
        public string GetMoProcessMaterials(int MoId, int MoProcessId, string AssemblyBarcodeNo)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("製令不能為空!!");
                if (MoProcessId <= 0) throw new SystemException("製令製程不能為空!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT a.BindType 
                            , c.MtlItemId, c.MtlItemNo, c.MtlItemName
                            , (
                                SELECT TOP 1 xb.LotNumberNo
                                FROM MES.BarcodeComponent x 
                                INNER JOIN MES.Barcode xa ON x.AssemblyBarcodeId = xa.BarcodeId
                                INNER JOIN SCM.LotNumber xb ON x.LotNumberId = xb.LotNumberId
                                INNER JOIN MES.MrDetail xc ON xb.MtlItemId = xc.MtlItemId
                                INNER JOIN MES.MaterialRequisition xd ON xc.MrId = xd.MrId
                                WHERE xa.BarcodeNo = @AssemblyBarcodeNo
                                AND xc.MtlItemId = b.MtlItemId
                                AND xd.DocType != '56'
                            ) LotBarcodeComponent
                            FROM MES.MoMtlSetting a
                            INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                            INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                            WHERE a.MoId = @MoId
                            AND a.ProcessBinding = 'Y'
                            AND a.MoProcessId = @MoProcessId
                            AND a.MainBarcode != 'Y'";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("AssemblyBarcodeNo", AssemblyBarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeComponent -- 取得被綁定之物料資料 -- Ann 2022-11-12
        public string GetBarcodeComponent(int MoId, int MtlItemId)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("製令不能為空!!");
                if (MtlItemId <= 0) throw new SystemException("品號ID不能為空!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //先找出此製令且此品號之所有領料單條碼，並DISTINCT
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT x.BarcodeNo
                            FROM MES.MrBarcodeRegister x
                            INNER JOIN MES.MrDetail xa ON x.MrDetailId = xa.MrDetailId
                            WHERE xa.MoId = @MoId AND xa.MtlItemId = @MtlItemId";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    var BarcodeNoResult = sqlConnection.Query(sql, dynamicParameters);

                    if (BarcodeNoResult.Count() <= 0) throw new SystemException("查無條碼資料!!");
                    #endregion

                    #region //依據找出來的條碼篩出最新領料單與退料料單並比較日期
                    List<int> MrDetailIdList = new List<int>();
                    foreach (var item in BarcodeNoResult)
                    {
                        #region //領料單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MrDetailId, a.CreateDate
                                FROM MES.MrBarcodeRegister a
                                WHERE a.BarcodeNo = @BarcodeNo
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("BarcodeNo", item.BarcodeNo);

                        var RegisterCreateDateResult = sqlConnection.Query(sql, dynamicParameters);

                        int MrDetailId = -1;
                        DateTime RegisterCreateDate = new DateTime();
                        foreach (var item2 in RegisterCreateDateResult)
                        {
                            MrDetailId = item2.MrDetailId;
                            RegisterCreateDate = item2.CreateDate;
                        }
                        #endregion

                        #region //退料單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.CreateDate
                                FROM MES.MrBarcodeReRegister a
                                WHERE a.BarcodeNo = @BarcodeNo
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("BarcodeNo", item.BarcodeNo);

                        var ReRegisterCreateDateResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ReRegisterCreateDateResult.Count() <= 0 && MrDetailIdList.IndexOf(MrDetailId) == -1)
                        {
                            MrDetailIdList.Add(MrDetailId);
                        }
                        else
                        {
                            DateTime ReRegisterCreateDate = new DateTime();
                            foreach (var item2 in ReRegisterCreateDateResult)
                            {
                                ReRegisterCreateDate = item2.CreateDate;
                            }

                            int DateResult = DateTime.Compare(RegisterCreateDate, ReRegisterCreateDate);
                            if (DateResult > 0 && MrDetailIdList.IndexOf(MrDetailId) == -1)
                            {
                                MrDetailIdList.Add(MrDetailId);
                            }
                        }
                        #endregion
                    }
                    #endregion

                    #region //組合MrDetail
                    string MrDeatailString = "";
                    int i = 0;
                    foreach (var item in MrDetailIdList)
                    {
                        if (i != MrDetailIdList.Count() - 1)
                        {
                            MrDeatailString = MrDeatailString + item.ToString() + ",";
                        }
                        else
                        {
                            MrDeatailString = MrDeatailString + item.ToString();
                        }

                        i++;
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeComponentId
                            , b.BarcodeNo, b.BarcodeQty
                            , e.ItemNo
                            , f.MtlItemId, f.MtlItemNo, f.MtlItemName
                            , (
                                SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                FROM MES.BarcodeAttribute x
                                INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE x.BarcodeId = a.ComponentBarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            FROM MES.BarcodeComponent a
                            INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                            INNER JOIN MES.MrBarcodeRegister c ON b.BarcodeNo = c.BarcodeNo
                            INNER JOIN MES.MrDetail d ON c.MrDetailId = d.MrDetailId
                            LEFT JOIN MES.BarcodeComponentAttribute e ON a.BarcodeComponentId = e.BarcodeComponentId
                            INNER JOIN PDM.MtlItem f ON d.MtlItemId = f.MtlItemId
                            WHERE d.MtlItemId = @MtlItemId AND d.MoId = @MoId AND d.MrDetailId IN (" + MrDeatailString + ")";
                    sql += @"GROUP BY a.BarcodeComponentId, a.ComponentBarcodeId, a.CreateDate
                            , b.BarcodeNo, b.BarcodeQty
                            , e.ItemNo
                            , f.MtlItemId, f.MtlItemNo, f.MtlItemName
                            ORDER BY a.CreateDate DESC";

                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeComponentL -- 取得上料批號模式資料 -- Ann 2024-05-10
        public string GetBarcodeComponentL(string AssemblyBarcodeNo, int ComponentMtlItemId)
        {
            try
            {
                if (AssemblyBarcodeNo.Length <= 0) throw new SystemException("主條碼不能為空!!");
                if (ComponentMtlItemId <= 0) throw new SystemException("物料ID不能為空!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeComponentId
                            , c.LotNumberNo
                            , e.Quantity
                            FROM MES.BarcodeComponent a 
                            INNER JOIN MES.Barcode b ON a.AssemblyBarcodeId = b.BarcodeId
                            INNER JOIN SCM.LotNumber c ON a.LotNumberId = c.LotNumberId
                            INNER JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                            INNER JOIN MES.MrDetail e ON d.MoId = e.MoId AND c.MtlItemId = e.MtlItemId AND e.LotNumber = c.LotNumberNo
                            WHERE b.BarcodeNo = @AssemblyBarcodeNo
                            AND c.MtlItemId = @ComponentMtlItemId";
                    dynamicParameters.Add("AssemblyBarcodeNo", AssemblyBarcodeNo);
                    dynamicParameters.Add("ComponentMtlItemId", ComponentMtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeComponentByLN -- 取得上料條碼資料By批號條碼 -- Ann 2024-05-28
        public string GetBarcodeComponentByLN(string AssemblyBarcodeNo, int ComponentMtlItemId)
        {
            try
            {
                if (AssemblyBarcodeNo.Length <= 0) throw new SystemException("主條碼不能為空!!");
                if (ComponentMtlItemId <= 0) throw new SystemException("物料ID不能為空!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeComponentId
                            , b.BarcodeNo, b.BarcodeQty
                            , d.MtlItemId
                            , f.ItemNo
                            , g.MtlItemNo, g.MtlItemName
                            , (
                                SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                FROM MES.BarcodeAttribute x
                                INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE x.BarcodeId = a.ComponentBarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            FROM MES.BarcodeComponent a 
                            INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                            INNER JOIN SCM.LnBarcode c ON b.BarcodeNo = c.BarcodeNo
                            INNER JOIN SCM.LotNumber d ON c.LotNumberId = d.LotNumberId
                            INNER JOIN MES.Barcode e ON a.AssemblyBarcodeId = e.BarcodeId
                            LEFT JOIN MES.BarcodeComponentAttribute f ON a.BarcodeComponentId = f.BarcodeComponentId
                            INNER JOIN PDM.MtlItem g ON d.MtlItemId = g.MtlItemId
                            WHERE e.BarcodeNo = @AssemblyBarcodeNo
                            AND d.MtlItemId = @ComponentMtlItemId
                            ORDER BY a.CreateDate DESC";
                    dynamicParameters.Add("AssemblyBarcodeNo", AssemblyBarcodeNo);
                    dynamicParameters.Add("ComponentMtlItemId", ComponentMtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoMtlSettingAttribute -- 取得物料屬性設定資料 -- Ann 2022-11-14
        public string GetMoMtlSettingAttribute(int MoId, int MtlItemId)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("製令不能為空!!");
                if (MtlItemId <= 0) throw new SystemException("品號ID不能為空!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoMtlSettingId, a.ItemNo, a.ItemName, a.ChkUnique, a.ChkRange
                            FROM MES.MoMtlSettingAttribute a
                            INNER JOIN MES.MoMtlSetting b ON a.MoMtlSettingId = b.MoMtlSettingId
                            INNER JOIN MES.WoDetail c ON b.WoDetailId = c.WoDetailId
                            WHERE b.MoId = @MoId
                            AND c.MtlItemId = @MtlItemId";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeComponentAttribute -- 取得物料屬性綁定資料 -- Ann 2022-11-14
        public string GetBarcodeComponentAttribute(int MoId, int MtlItemId)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("製令不能為空!!");
                if (MtlItemId <= 0) throw new SystemException("品號ID不能為空!!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //先找出此製令且此品號之所有領料單條碼，並DISTINCT
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT x.BarcodeNo
                            FROM MES.MrBarcodeRegister x
                            INNER JOIN MES.MrDetail xa ON x.MrDetailId = xa.MrDetailId
                            WHERE xa.MoId = @MoId AND xa.MtlItemId = @MtlItemId";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    var BarcodeNoResult = sqlConnection.Query(sql, dynamicParameters);
                    #endregion

                    #region //依據找出來的條碼篩出最新領料單與退料料單並比較日期
                    List<int> MrDetailIdList = new List<int>();
                    foreach (var item in BarcodeNoResult)
                    {
                        #region //領料單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MrDetailId, a.CreateDate
                                FROM MES.MrBarcodeRegister a
                                WHERE a.BarcodeNo = @BarcodeNo
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("BarcodeNo", item.BarcodeNo);

                        var RegisterCreateDateResult = sqlConnection.Query(sql, dynamicParameters);

                        int MrDetailId = -1;
                        DateTime RegisterCreateDate = new DateTime();
                        foreach (var item2 in RegisterCreateDateResult)
                        {
                            MrDetailId = item2.MrDetailId;
                            RegisterCreateDate = item2.CreateDate;
                        }
                        #endregion

                        #region //退料單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.CreateDate
                                FROM MES.MrBarcodeReRegister a
                                WHERE a.BarcodeNo = @BarcodeNo
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("BarcodeNo", item.BarcodeNo);

                        var ReRegisterCreateDateResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ReRegisterCreateDateResult.Count() <= 0 && MrDetailIdList.IndexOf(MrDetailId) == -1)
                        {
                            MrDetailIdList.Add(MrDetailId);
                        }
                        else
                        {
                            DateTime ReRegisterCreateDate = new DateTime();
                            foreach (var item2 in ReRegisterCreateDateResult)
                            {
                                ReRegisterCreateDate = item2.CreateDate;
                            }

                            int DateResult = DateTime.Compare(RegisterCreateDate, ReRegisterCreateDate);
                            if (DateResult > 0 && MrDetailIdList.IndexOf(MrDetailId) == -1)
                            {
                                MrDetailIdList.Add(MrDetailId);
                            }
                        }
                        #endregion
                    }
                    #endregion

                    #region //組合MrDetail
                    string MrDeatailString = "";
                    int i = 0;
                    foreach (var item in MrDetailIdList)
                    {
                        if (i != MrDetailIdList.Count() - 1)
                        {
                            MrDeatailString = MrDeatailString + item.ToString() + ",";
                        }
                        else
                        {
                            MrDeatailString = MrDeatailString + item.ToString();
                        }

                        i++;
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeComponentId
                            , b.BarcodeNo
                            , e.ItemNo, e.ItemValue
                            , f.MtlItemNo, f.MtlItemName
                            FROM MES.BarcodeComponent a
                            INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                            INNER JOIN MES.MrBarcodeRegister c ON b.BarcodeNo = c.BarcodeNo
                            INNER JOIN MES.MrDetail d ON c.MrDetailId = d.MrDetailId
                            LEFT JOIN MES.BarcodeComponentAttribute e ON a.BarcodeComponentId = e.BarcodeComponentId
                            INNER JOIN PDM.MtlItem f ON d.MtlItemId = f.MtlItemId
                            WHERE d.MoId = @MoId AND d.MtlItemId = @MtlItemId
                            AND d.MrDetailId IN (" + MrDeatailString + ")" +
                            "ORDER BY a.CreateDate DESC";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcess -- 取得製令製程資訊 -- Ann 2022-12-23
        public string GetMoProcess(int MoProcessId, int MoId, string WoErpFullNo)
        {
            try
            {
                if (WoErpFullNo.Length > 0)
                {
                    if (WoErpFullNo.IndexOf("-") != -1)
                    {
                        if (WoErpFullNo.IndexOf("(") == -1)
                        {
                            throw new SystemException("【製令】請將括號也一起輸入!!");
                        }
                    }
                    else
                    {
                        MoId = Convert.ToInt32(WoErpFullNo);
                        WoErpFullNo = "";
                    }
                }


                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoProcessId, a.MoId, a.MoRoutingId, a.RoutingProcessId, a.ProcessId, a.SortNumber, a.ProcessAlias
                            , a.RoutingItemProcessDesc, a.Remark, a.DisplayStatus, a.NecessityStatus, a.OspFlag, a.ProcessCheckStatus
                            , a.ProcessCheckType, a.TotalInputQty, a.TotalPassQty, a.TotalNgQty, a.TotalScrapQty, a.WipQty
                            , b.UserNo, b.UserName
                            , c.NgToBarcode, c.VehicleFlag
                            , d.WoSeq
                            , e.WoErpPrefix, e.WoErpNo
                            FROM MES.MoProcess a
                            INNER JOIN BAS.[User] b ON a.LastModifiedBy = b.UserId
                            INNER JOIN MES.MoSetting c ON a.MoId = c.MoId
                            INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                            INNER JOIN MES.WipOrder e ON d.WoId = e.WoId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WoErpFullNo", @" AND (e.WoErpPrefix + '-' + e.WoErpNo +  '(' + CONVERT(VARCHAR(10), d.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'", WoErpFullNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetLabelPrintMachine -- 取得標籤機列表 -- Ann 2023-05-22
        public string GetLabelPrintMachine()
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.LabelPrintId, a.LabelPrintNo, a.LabelPrintName, a.LabelPrintIp
                            FROM MES.LabelPrintMachine a
                            WHERE a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetKeyence -- 取得Keyence設備資料 -- Ann 2023-05-30
        public string GetKeyence(int KeyenceId, string Status)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.KeyenceId, KeyenceNo, KeyenceDesc, KeyenceIP, KeyencePort, [Status]
                            FROM MES.Keyence a
                            WHERE a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "KeyenceId", @" AND a.KeyenceId = @KeyenceId", KeyenceId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND a.Status = @Status", Status);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessTransaction -- 取得數量過站歷程 -- Ann 2022-12-30
        public string GetMoProcessTransaction(int TransactionId, int MoId, int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT * 
                            FROM (SELECT a.TransactionId, a.MoId, a.LineId, a.MachineId, a.MoProcessId
                                , a.NextMoProcessId, a.ProdStatus, a.Quantity, FORMAT(a.InputDate, 'yyyy-MM-dd HH:mm:ss') InputDate
                                , b.ProcessAlias
                                , c.CauseNo, c.CauseName
                                , d.ProcessAlias NextProcessAlias
                                , e.UserNo, e.UserName
                                FROM MES.MoProcessTransaction a
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                LEFT JOIN QMS.DefectCause c ON a.CauseNo = c.CauseNo
                                LEFT JOIN MES.MoProcess d ON a.NextMoProcessId = d.MoProcessId
                                INNER JOIN BAS.[User] e ON a.CreateBy = e.UserId
                                WHERE a.Quantity > 0) x
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TransactionId", @" AND x.TransactionId = @TransactionId", TransactionId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND x.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND x.MoProcessId = @MoProcessId", MoProcessId);

                    sql += @" ORDER BY x.InputDate DESC";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetProcessMachine -- 取得製程參數機台相關資訊 -- Ann 2023-05-04
        public string GetProcessMachine(int MoProcessId, int MachineId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.KeyenceFlag, a.KeyenceId
                            FROM MES.ProcessMachine a
                            INNER JOIN MES.ProcessParameter b ON a.ParameterId = b.ParameterId
                            INNER JOIN MES.MoProcess c ON b.ProcessId = c.ProcessId
                            INNER JOIN MES.ManufactureOrder d ON c.MoId = d.MoId AND b.ModeId = d.ModeId
                            WHERE a.MachineId = @MachineId
                            AND c.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MachineId", MachineId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeInfo -- 取得指定條碼資訊(批量) -- Ann 2023-05-04
        public string GetBarcodeInfo(string BarcodeList)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeNo, a.BarcodeQty
                            , b.StatusName
                            FROM MES.Barcode a
                            INNER JOIN BAS.[Status] b ON a.BarcodeStatus = b.StatusNo AND b.StatusSchema = 'Barcode.BarcodeStatus'
                            WHERE a.BarcodeNo IN (@BarcodeList)";
                    dynamicParameters.Add("BarcodeList", BarcodeList);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcode -- 取得條碼資料 -- Ann 2023-07-24
        public string GetBarcode(string BarcodeNo, int MoId, int MoProcessId, int PrintCount, string BarcodeStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                if (BarcodeNo.Length <= 0 && MoId <= 0) throw new SystemException("條碼及製令不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認是否為TrayBarcode
                    if (MoId > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TrayBarcode
                                FROM MES.MoSetting a 
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in MoSettingResult)
                        {
                            if (item.TrayBarcode == "Y")
                            {
                                #region //取得Barcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo
                                        FROM MES.Tray a 
                                        WHERE a.TrayNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item2 in TrayResult)
                                {
                                    if (item2.BarcodeNo == null) throw new SystemException("此Tray尚未綁定Barcode!!");
                                    BarcodeNo = item2.BarcodeNo;
                                }
                                #endregion
                            }
                        }
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId, a.MoId, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                        , a.PrintCount, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate
                        , b.ProcessAlias CurrentProcessAlias
                        , c.ProcessAlias NextProcessAlias
                        , d.StatusNo BarcodeStatusNo, d.StatusName BarcodeStatusName
                        , e.TypeNo CurrentProdStatusNo, e.TypeName CurrentProdStatusName
                        , f.UserNo, f.UserName
                        , (
                            SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                            , ('日期:' + FORMAT(x.DateCode, 'yyyy-MM-dd')) DateCode
                            FROM MES.BarcodeAttribute x
                            INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE x.BarcodeId = a.BarcodeId
                            FOR JSON PATH, ROOT('data')
                        ) ItemValue
                        , (
                            SELECT TOP 1 1
                            FROM MES.Barcode x 
                            INNER JOIN MES.Barcode xa ON x.ParentBarcode = xa.BarcodeId
                            WHERE xa.BarcodeNo = a.BarcodeNo
                        ) MinBarcodes";
                    sqlQuery.mainTables =
                        @"FROM MES.Barcode a
                        INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
                        LEFT JOIN MES.MoProcess c ON a.NextMoProcessId = c.MoProcessId
                        INNER JOIN BAS.[Status] d ON a.BarcodeStatus = d.StatusNo AND d.StatusSchema = 'Barcode.BarcodeStatus'
                        INNER JOIN BAS.[Type] e ON a.CurrentProdStatus = e.TypeNo AND e.TypeSchema = 'Barcode.CurrentProdStatus'
                        INNER JOIN BAS.[User] f ON a.CreateBy = f.UserId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "PrintCount", @" AND a.PrintCount = @PrintCount", PrintCount);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo LIKE '%' + @BarcodeNo + '%'", BarcodeNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeStatus", @" AND a.BarcodeStatus = @BarcodeStatus", BarcodeStatus);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CreateDate, a.BarcodeNo DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    if (result.Count() <= 0 && BarcodeNo.Length > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.PrintStatus
                                FROM MES.BarcodePrint a 
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        result = sqlConnection.Query(sql, dynamicParameters);
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeQty -- 取得條碼資料 -- Ann 2023-07-24
        public string GetBarcodeQty(string BarcodeNo, int MoId)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("條碼及製令不能為空!!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認是否為TrayBarcode
                    if (MoId > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TrayBarcode
                                FROM MES.MoSetting a 
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in MoSettingResult)
                        {
                            if (item.TrayBarcode == "Y")
                            {
                                #region //取得Barcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo
                                        FROM MES.Tray a 
                                        WHERE a.TrayNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item2 in TrayResult)
                                {
                                    if (item2.BarcodeNo == null) throw new SystemException("此Tray尚未綁定Barcode!!");
                                    BarcodeNo = item2.BarcodeNo;
                                }
                                #endregion
                            }
                        }
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeQty
                            FROM MES.Barcode a 
                            WHERE a.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    if (result.Count() <= 0 && BarcodeNo.Length > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.PrintStatus
                                FROM MES.BarcodePrint a 
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        result = sqlConnection.Query(sql, dynamicParameters);
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessQty -- 取得製令製程過站數量資料(數量過站產條碼用) -- Ann 2023-07-24
        public string GetMoProcessQty(int MoProcessId, int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TotalPassQty - ISNULL((
                                SELECT SUM(x.MweBarcodeQty)
                                FROM MES.MweBarcode x 
                                INNER JOIN MES.MweDetail xa ON x.MweDetailId = xa.MweDetailId
                                INNER JOIN MES.Barcode xb ON x.BarcodeId = xb.BarcodeId
                                WHERE xa.MoId = a.MoId
                                AND xb.CurrentProdStatus != 'S'
                            ), 0) TotalPassQty
                            , b.LotQty, b.BarcodePrefix, b.BarcodePostfix, b.SequenceLen
                            , (
                                SELECT ISNULL(SUM(x.BarcodeQty), 0)
                                FROM MES.Barcode x 
                                WHERE x.MoId = a.MoId
                                AND x.CurrentProdStatus = 'P'
                                AND x.BarcodeStatus != '8'
                            ) PassBindQty
                            , (
                                SELECT ISNULL(SUM(x.BarcodeQty), 0)
                                FROM MES.Barcode x 
                                WHERE x.MoId = a.MoId
                                AND x.CurrentProdStatus = 'S'
                                AND x.BarcodeStatus != '8'
                            ) ScrapBindQty
                            , (
                                SELECT SUM(x.TotalScrapQty) 
                                FROM MES.MoProcess x
                                WHERE x.MoId = a.MoId
                            ) - ISNULL((
                                SELECT SUM(x.MweBarcodeQty)
                                FROM MES.MweBarcode x 
                                INNER JOIN MES.MweDetail xa ON x.MweDetailId = xa.MweDetailId
                                INNER JOIN MES.Barcode xb ON x.BarcodeId = xb.BarcodeId
                                WHERE xa.MoId = a.MoId
                                AND xb.CurrentProdStatus = 'S'
                            ), 0) TotalScrapQty
                            FROM MES.MoProcess a 
                            INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                            WHERE a.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeMoprocess -- 取得模仁條碼製程資料 -- Daiyi 2023-03-28
        public string GetBarcodeMoprocess(int NextMoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoId, a.BarcodeId, a.BarcodeNo, a.CurrentMoProcessId, b.ProcessAlias
                            , a.BarcodeQty, a.NextMoProcessId, b1.ProcessAlias AS NextMoProcessName
                            , CASE WHEN a.CurrentProdStatus = 'P' THEN '良品' WHEN a.CurrentProdStatus = 'F' THEN '不良品' WHEN a.CurrentProdStatus = 'S' THEN '報廢' END CurrentProdStatus
                            , a.BarcodeStatus, ISNULL(c.ItemValue, '') ItemValue
                            FROM MES.Barcode a
                            LEFT JOIN MES.MoProcess b ON b.MoId = a.MoId AND b.MoProcessId = a.CurrentMoProcessId
                            LEFT JOIN MES.MoProcess b1 ON b1.MoId = a.MoId AND b1.MoProcessId = a.NextMoProcessId
                            LEFT JOIN MES.BarcodeAttribute c ON c.BarcodeId = a.BarcodeId
                            WHERE a.NextMoProcessId = @NextMoProcessId";
                    dynamicParameters.Add("NextMoProcessId", NextMoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPackageBarcodes -- 取得包裝條碼資料 -- Gpai 2023-04-19
        public string GetPackageBarcodes(int MoProcessId) 
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT PackageBarcodeId,PackageBarcodeNo,Quantity
                            FROM MES.PackageBarcode 
                            WHERE [Status] = '1' AND CompanyId = @CompanyId AND MoProcessId = @MoProcessId
                            ORDER BY PackageBarcodeId DESC";
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPackageProductBarcodes -- 取得該包裝條碼的產品條碼資料 -- Gpai 2023-04-19
        public string GetPackageProductBarcodes(int PackageBarcodeId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.PbrId,b.PackageBarcodeNo,c.BarcodeNo,c.BarcodeQty
                            FROM MES.PackageBarcodeReference a
                            INNER JOIN MES.PackageBarcode b ON b.PackageBarcodeId = a.PackageBarcodeId
                            INNER JOIN MES.Barcode c ON c.BarcodeId = a.BarcodeId
                            WHERE b.PackageBarcodeId = @PackageBarcodeId";
                    dynamicParameters.Add("PackageBarcodeId", PackageBarcodeId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetJigData --取得治具資訊
        public string GetJigData(string Company, string JigNo, string WorkingFlag)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region//GetJigData --取得治具資訊

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.MoProcessId,a.CreateBy,b.JigId
                            FROM MES.JigBarcode a
                            INNER JOIN MES.Jig b ON a.JigId=b.JigId
                            INNER JOIN BAS.Company c ON b.CompanyId=c.CompanyId
                            WHERE b.JigNo=@JigNo
                            AND a.WorkingFlag=@WorkingFlag
                            AND c.CompanyNo=@Company
                            ORDER BY a.JigBarcodeId DESC
                        ";
                    dynamicParameters.Add("JigNo", JigNo);
                    dynamicParameters.Add("WorkingFlag", WorkingFlag);
                    dynamicParameters.Add("Company", Company);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() != 1) throw new SystemException("查無此治具");
                    int MoProcessId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoProcessId;
                    int JigId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JigId;
                    #endregion

                    #region//查詢銑床報工資訊
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.MillProgLogId
                            FROM MES.MillProgramWork a
                            INNER JOIN MES.MillProgramLog b ON a.MillProgLogId=b.MillProgLogId
                            WHERE a.MoProcessId=@MoProcessId AND b.JigId=@JigId AND a.[Status]='S'
                            ORDER BY MillProgramWorkId DESC                            
                        ";
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("JigId", JigId);
                    var MillProgResult = sqlConnection.Query(sql, dynamicParameters);
                    if (MillProgResult.Count() != 1) throw new SystemException("查無銑床報工資訊");
                    int MillProgLogId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MillProgLogId;
                    #endregion

                    #region//呼叫銑床上拋
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT MillPrtData
                        FROM MES.MillProgramResponsest
                        WHERE MillProgLogId=@MillProgLogId
                        ";
                    dynamicParameters.Add("MillProgLogId", MillProgLogId);
                    var MillPrtDataResult = sqlConnection.Query(sql, dynamicParameters);
                    if (MillPrtDataResult.Count() <= 0) throw new SystemException("查無銑床編程");

                    foreach (var item in MillPrtDataResult)
                    {
                        string IotResult = MillNcUpAsync(item.MillPrtData);
                        if (JObject.Parse(IotResult)["status"].ToString() != @"Success")
                        {
                            throw new SystemException("銑床編程上拋失敗");
                        }
                        else
                        {
                            #region//修改銑床機台刀具資訊 //拋轉機台之後的狀態改成 A
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MillProgramWork SET
                                    [Status]='A',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MillProgLogId = @MillProgLogId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MillProgLogId
                                });
                            int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            if (rowsAffected != 1) throw new SystemException("【銑床編程上拋】修改失敗!");
                            #endregion
                        }
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT
                                SUBSTRING(
                                        a.MillPrtData, 
                                        1, 
                                        CHARINDEX('(', a.MillPrtData + '\') - 1
                                    ) AS MillPrtData
                                FROM (
                                    SELECT
                                        RIGHT(
                                        MillPrtData, 
                                        CHARINDEX('\', REVERSE(MillPrtData)) - 1
                                        ) AS MillPrtData,MillProgLogId
                                    FROM MES.MillProgramResponsest
                                ) a
                        WHERE a.MillProgLogId=@MillProgLogId
                        ";
                    dynamicParameters.Add("MillProgLogId", MillProgLogId);
                    var MillPrtDataNameResult = sqlConnection.Query(sql, dynamicParameters);
                    if (MillPrtDataNameResult.Count() <= 0) throw new SystemException("查無銑床編程");

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result,
                        data2 = MillPrtDataNameResult
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetJigBarcodeData --取得特定治具，所綁定的條碼資訊
        public string GetJigBarcodeData(string JigNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT REPLACE(STUFF(
                                (SELECT ', ' + CAST(a.JigBarcodeId AS VARCHAR(100))
                                FROM MES.JigBarcode a
                                    INNER JOIN MES.Jig b ON a.JigId = b.JigId
                                    INNER JOIN BAS.Company c ON b.CompanyId = c.CompanyId
                                    INNER JOIN MES.MachineJig d ON d.JigId = b.JigId
                                WHERE b.JigNo = @JigNo
                                FOR XML PATH('')), 1, 2, ''),' ','') AS JigBarcodeIdData
                            ";
                    dynamicParameters.Add("JigNo", JigNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() != 1) throw new SystemException("查無此治具綁定條碼資訊");
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCollectionStatus --取得加工事件收集狀態 --GPai 20230731
        public string GetCollectionStatus(int ModeId, int MoProcessId, string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeId, a.BarcodeNo, d.ModeId, b.MoProcessId, d.PreCollectionStatus, d.PostCollectionStatus
                            , FORMAT(b.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, ISNULL(FORMAT(b.FinishDate, 'yyyy-MM-dd HH:mm:ss'), '') FinishDate
                            , a.BarcodeNo, a.BarcodeQty
                            FROM MES.Barcode a
							INNER JOIN MES.BarcodeProcess b ON b.BarcodeId = a.BarcodeId
							INNER JOIN MES.MoProcess c ON c.MoProcessId = b.MoProcessId
                            INNER JOIN MES.ProcessParameter d ON d.ProcessId = c.ProcessId
                            WHERE 1=1
                            AND d.ModeId = @ModeId
                            AND b.MoProcessId = @MoProcessId
                            ";
                    dynamicParameters.Add("ModeId", ModeId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    //if (result.Count() <= 0) throw new SystemException("查無加工事件收集狀態");
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetUnfinishManEvent --取得該人員未完成事件 --GPai 20230801
        public string GetUnfinishManEvent()
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.UserEventId, a.UserEventItemId, FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate, a.OperationTime
                            FROM MES.UserEvent a
                            WHERE a.Operator = @Operator AND a.FinishDate IS NULL
                            ORDER BY a.UserEventId DESC";
                    dynamicParameters.Add("Operator", CreateBy);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeEven --取得該條碼加工事件 --GPai 20230816
        public string GetBarcodeEven(int ModeId, int MoProcessId, string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeEventId, a.BarcodeProcessId, a.ProcessEventItemId, FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate, a.CycleTime
                            , c.ProcessEventItemId, c.ProcessEventName, c.ProcessEventType
                            , e.ModeId, e.PreCollectionStatus, e.PostCollectionStatus
                            , f.BarcodeId, f.BarcodeNo
                            FROM MES.BarcodeProcessEvent a
                            INNER JOIN MES.BarcodeProcess b ON b.BarcodeProcessId = a.BarcodeProcessId
                            INNER JOIN MES.ProcessEventItem c on c.ProcessEventItemId = a.ProcessEventItemId
                            INNER JOIN MES.MoProcess d ON d.MoProcessId = b.MoProcessId
                            INNER JOIN MES.ProcessParameter e ON e.ProcessId = d.ProcessId
                            INNER JOIN MES.Barcode f on f.BarcodeId = b.BarcodeId
                            WHERE 1=1
                            AND e.ModeId = @ModeId
                            AND b.MoProcessId = @MoProcessId
                            AND f.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("ModeId", ModeId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetUnfinishBarcodeEven --取得該條碼未完成事件 --GPai 20230816
        public string GetUnfinishBarcodeEven(int ModeId, int MoProcessId, string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BarcodeEventId, a.BarcodeProcessId, a.ProcessEventItemId, FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate, a.CycleTime
                            , c.ProcessEventItemId, c.ProcessEventName, c.ProcessEventType
                            , e.ModeId, e.PreCollectionStatus, e.PostCollectionStatus
                            , f.BarcodeId, f.BarcodeNo
                            FROM MES.BarcodeProcessEvent a
                            INNER JOIN MES.BarcodeProcess b ON b.BarcodeProcessId = a.BarcodeProcessId
                            INNER JOIN MES.ProcessEventItem c on c.ProcessEventItemId = a.ProcessEventItemId
                            INNER JOIN MES.MoProcess d ON d.MoProcessId = b.MoProcessId
                            INNER JOIN MES.ProcessParameter e ON e.ProcessId = d.ProcessId
                            INNER JOIN MES.Barcode f on f.BarcodeId = b.BarcodeId
                            WHERE 1=1
                            AND e.ModeId = @ModeId
                            AND b.MoProcessId = @MoProcessId
                            AND a.FinishDate IS NULL ";
                    dynamicParameters.Add("ModeId", ModeId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    //dynamicParameters.Add("BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND f.BarcodeNo = @BarcodeNo", BarcodeNo);


                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetUnfinishMachineEvent --取得該機台未完成事件 --GPai 20230817
        public string GetUnfinishMachineEvent(int MachineId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MachineEventId, a.MachineEventItemId, FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate, a.OperationTime
                            FROM MES.MachineEvent a
                            INNER JOIN MES.MachineEventItem b ON b.MachineEventItemId = a.MachineEventItemId
                            WHERE a.FinishDate IS NULL AND b.MachineId = @MachineId";
                    dynamicParameters.Add("MachineId", MachineId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeLetteringChangeInfo -- 取得刻號置換紀錄 -- Yi 2023-09-19
        public string GetBarcodeLetteringChangeInfo(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 c.BarcodeNo, b.ItemValue, b.ItemSeq
                            , d.ProcessAttrLogId, d.BarcodeId, d.MoId, d.Status
                            , ISNULL(FORMAT(d.CreateDate, 'yyyy-MM-dd HH:mm:ss'), '') StartDate, ISNULL(FORMAT(d.LastModifiedDate, 'yyyy-MM-dd HH:mm:ss'), '') FinishDate
                            FROM MES.BarcodeProcessAttributeLog a
                            INNER JOIN MES.BarcodeAttribute b ON a.NewBarcodeId = b.BarcodeId
                            INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                            LEFT JOIN MES.BpalDetail d ON a.ProcessAttrLogId = d.ProcessAttrLogId AND c.BarcodeId = d.BarcodeId
                            WHERE a.NewItemNo = 'Lettering'
                            AND (d.[Status] != 'Y' OR d.[Status] IS NULL)
                            AND c.BarcodeNo = @BarcodeNo
                            ORDER BY a.CreateDate DESC";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeRelevantData -- NG條碼改刻字，查詢條碼相關資訊 -- Yi 2023-09-20
        public string GetBarcodeRelevantData(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoId, a.WoSeq, a.ModeId
                            , b.WoErpPrefix, b.WoErpNo
                            , c.MtlItemNo, c.MtlItemName
                            , d.BarcodeId, d.BarcodeNo
                            , e.ItemValue, e.ItemSeq
                            FROM MES.ManufactureOrder a
                            INNER JOIN MES.WipOrder b ON a.WoId=b.WoId
                            INNER JOIN PDM.MtlItem c ON b.MtlItemId=c.MtlItemId
                            INNER JOIN MES.Barcode d ON a.MoId = d.MoId
                            INNER JOIN MES.BarcodeAttribute e ON d.BarcodeId = e.BarcodeId
                            WHERE e.ItemNo = 'Lettering'
                            AND d.BarcodeNo = @BarcodeNo
                            ORDER BY e.CreateDate DESC";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND d.BarcodeNo = @BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeTracking -- 取得條碼追蹤資料 -- Ann 2023-11-29
        public string GetBarcodeTracking(int BarcodeId, string BarcodeNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (BarcodeNo.Length <= 0) throw new SystemException("【產品條碼】不能為空!");

                    #region //先檢查是否為TrayBarcode
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT BarcodeNo
                            FROM MES.Tray
                            WHERE TrayNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in TrayResult)
                    {
                        if (item.BarcodeNo == null) break;
                        BarcodeNo = item.BarcodeNo;
                    }
                    #endregion

                    sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeStatus, a.CurrentMoProcessId, a.BarcodeQty, a.CurrentProdStatus
                            , b.WoSeq
                            , c.WoErpPrefix + '-' + c.WoErpNo WoErpFullNo
                            , d.MtlItemNo
                            , ISNULL(
                                (
                                    SELECT t.BarcodeProcessId, t.ProdStatus, t.CycleTime, t.MoProcessId, t.StationQty
                                    , FORMAT(t.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(t.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                                    , u.ProcessAlias
                                    , ISNULL(v.MachineName, '') MachineName
                                    , w.UserNo StartUserNo, w.UserName StartUserName
                                    , x.UserNo FinishUserNo, x.UserName FinishUserName
                                    , z.TypeName + ':' + y.ItemValue AttributeVallue
                                    , xa.WoSeq
                                    , xb.WoErpPrefix + '-' + xb.WoErpNo WoErpFullNo
                                    FROM MES.BarcodeProcess t
                                    INNER JOIN MES.MoProcess u ON u.MoProcessId = t.MoProcessId
                                    LEFT JOIN MES.Machine v ON v.MachineId = t.MachineId
                                    INNER JOIN BAS.[User] w ON w.UserId = t.StartUserId
                                    INNER JOIN BAS.[User] x ON x.UserId = t.FinishUserId
                                    LEFT JOIN MES.BarcodeProcessAttribute y ON y.BarcodeProcessId = t.BarcodeProcessId
                                    LEFT JOIN BAS.[Type] z ON z.TypeNo = y.ItemNo AND z.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    INNER JOIN MES.ManufactureOrder xa ON t.MoId = xa.MoId
                                    INNER JOIN MES.WipOrder xb ON xa.WoId = xb.WoId
                                    WHERE t.BarcodeId = a.BarcodeId
                                    ORDER BY t.StartDate
                                    FOR JSON PATH, ROOT('data')
                                ), '') ProcessDetail
                            , (
                            SELECT (ea.TypeName + ':' + e.ItemValue) ItemValue
                            FROM MES.BarcodeAttribute e
                            INNER JOIN BAS.[Type] ea ON e.ItemNo = ea.TypeNo AND ea.TypeSchema = 'RoutingProcessItem.ItemNo'
                            WHERE e.BarcodeId = a.BarcodeId
                            FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , e.TypeName CurrentProdStatusName
                            , f.ProcessAlias CurrentProcessName
                            , ISNULL(g.ProcessAlias, '無下製程') NextProcessName
                            , i.TrayNo
                            FROM MES.Barcode a
                            INNER JOIN MES.ManufactureOrder b ON b.MoId = a.MoId
                            INNER JOIN MES.WipOrder c ON c.WoId = b.WoId
                            INNER JOIN PDM.MtlItem d ON d.MtlItemId = c.MtlItemId
                            INNER JOIN BAS.[Type] e ON a.CurrentProdStatus = e.TypeNo AND TypeSchema = 'Barcode.CurrentProdStatus'
                            INNER JOIN MES.MoProcess f ON a.CurrentMoProcessId = f.MoProcessId
                            LEFT JOIN MES.MoProcess g ON a.NextMoProcessId = g.MoProcessId
                            LEFT JOIN MES.BarcodeAttribute h ON a.BarcodeId = h.BarcodeId AND h.ItemNo = 'Lettering'
                            LEFT JOIN MES.Tray i ON a.BarcodeNo = i.BarcodeNo
                            WHERE a.BarcodeNo LIKE '%" + BarcodeNo + "%' OR h.ItemValue LIKE '%" + BarcodeNo + "%'";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetAllowQcBarcode -- 取得可送測條碼資訊 -- Ann 2023-01-23
        public string GetAllowQcBarcode(int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoProcessId <= 0) throw new SystemException("【製令製程】不能為空!");

                    sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeQty
                            , b.StatusNo BarcodeStatusNo, b.StatusName BarcodeStatusName
                            , (
                                SELECT (xa.TypeName + ':' + x.ItemValue) ItemValue
                                FROM MES.BarcodeAttribute x
                                INNER JOIN BAS.[Type] xa ON x.ItemNo = xa.TypeNo AND xa.TypeSchema = 'RoutingProcessItem.ItemNo'
                                WHERE x.BarcodeId = a.BarcodeId
                                FOR JSON PATH, ROOT('data')
                            ) ItemValue
                            , (
                                SELECT TOP 1 1
                                FROM MES.BarcodeProcess x 
                                WHERE x.BarcodeId = a.BarcodeId
                                AND x.FinishDate IS NULL
                                AND x.MoProcessId = a.CurrentMoProcessId
                            ) BarcodeProcessNull
                            , (
                                SELECT TOP 1 1
                                FROM MES.BarcodeProcess x 
                                WHERE x.BarcodeId = a.BarcodeId
                                AND x.MoProcessId = a.CurrentMoProcessId
                            ) BarcodeProcess
                            FROM MES.Barcode a 
                            INNER JOIN BAS.[Status] b ON a.BarcodeStatus = b.StatusNo AND b.StatusSchema = 'Barcode.BarcodeStatus'
                            WHERE a.CurrentMoProcessId = @MoProcessId
                            AND a.BarcodeStatus IN ('1','0')
                            AND a.CurrentProdStatus = 'P'";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMinBarcodes -- 取得鏡頭條碼資料 -- Ann 2024-05-13
        public string GetMinBarcodes(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (BarcodeNo.Length <= 0) throw new SystemException("【主條碼】不能為空!");

                    sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.BarcodeQty, a.BarcodeStatus, a.CurrentProdStatus
                            FROM MES.Barcode a 
                            INNER JOIN MES.Barcode b ON a.ParentBarcode = b.BarcodeId
                            WHERE b.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMaterials -- 取得需上料之物料資料 -- Ann 2024-05-23
        public string GetMaterials(int MoProcessId, string VehicleNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoProcessId <= 0) throw new SystemException("【製令製程】不能為空!");

                    sql = @"SELECT a.BindType
                            , c.MtlItemId, c.MtlItemNo, c.MtlItemName
                            , (
                                SELECT TOP 1 1
                                FROM MES.VehicleDetail x 
                                INNER JOIN MES.Vehicle xa ON x.VehicleId = xa.VehicleId
                                INNER JOIN SCM.LnBarcode xb ON x.BarcodeNo = xb.BarcodeNo
                                INNER JOIN SCM.LotNumber xc ON xb.LotNumberId = xc.LotNumberId AND xc.MtlItemId = b.MtlItemId
                                WHERE xa.VehicleNo = @VehicleNo
                                AND x.ExpirationDate IS NULL
                                AND x.[Status] = 'A'
                                AND xc.MtlItemId = b.MtlItemId
                            ) BindStatusB
                            , (
                                SELECT TOP 1 1
                                FROM MES.VehicleDetail x 
                                INNER JOIN MES.Vehicle xa ON x.VehicleId = xa.VehicleId
                                INNER JOIN SCM.LotNumber xb ON x.LotNumberId = xb.LotNumberId AND xb.MtlItemId = b.MtlItemId
                                WHERE xa.VehicleNo = @VehicleNo
                                AND x.ExpirationDate IS NULL
                                AND x.[Status] = 'A'
                                AND xb.MtlItemId = b.MtlItemId
                            ) BindStatusL
                            FROM MES.MoMtlSetting a 
                            INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                            INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                            WHERE a.MoProcessId = @MoProcessId
                            AND a.MainBarcode = 'N'
                            AND a.ProcessBinding = 'Y'";
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("VehicleNo", VehicleNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetVehicleDetail -- 取得載盤詳細資料 -- Ann 2024-05-23
        public string GetVehicleDetail(string VehicleNo, int MoProcessId, string BindType, int MtlItemId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (VehicleNo.Length <= 0) throw new SystemException("【載盤】不能為空!");
                    if (MoProcessId <= 0) throw new SystemException("【製令製程】不能為空!");
                    if (MtlItemId <= 0) throw new SystemException("【品號】不能為空!");

                    switch (BindType)
                    {
                        case "B":
                            sql = @"SELECT a.VdId, a.VehicleId, a.BarcodeNo, a.LotNumberId
                                    , c.BarcodeQty
                                    FROM MES.VehicleDetail a 
                                    INNER JOIN MES.Vehicle b ON a.VehicleId = b.VehicleId
                                    INNER JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo
                                    WHERE b.VehicleNo = @VehicleNo
                                    AND a.MoProcessId = @MoProcessId
                                    AND a.ExpirationDate IS NULL 
                                    AND a.[Status] = 'A'
                                    AND a.MtlItemId = @MtlItemId";
                            break;
                        case "L":
                            sql = @"SELECT a.VdId, a.VehicleId, a.BarcodeNo, a.LotNumberId
                                    , c.LotNumberNo
                                    , e.LotQty
                                    FROM MES.VehicleDetail a 
                                    INNER JOIN MES.Vehicle b ON a.VehicleId = b.VehicleId
                                    INNER JOIN SCM.LotNumber c ON a.LotNumberId = c.LotNumberId
                                    INNER JOIN MES.MoProcess d ON a.MoProcessId = d.MoProcessId
                                    INNER JOIN MES.MoSetting e ON d.MoId = e.MoId
                                    WHERE b.VehicleNo = @VehicleNo
                                    AND a.MoProcessId = @MoProcessId
                                    AND a.ExpirationDate IS NULL 
                                    AND a.[Status] = 'A'
                                    AND a.BarcodeNo IS NULL
                                    AND c.MtlItemId = @MtlItemId";
                            break;
                        default:
                            throw new SystemException("上料方式錯誤!!");
                    }

                    dynamicParameters.Add("VehicleNo", VehicleNo);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMachineConsumeLog -- 取得機台點膠資料 -- Ann 2024-06-17
        public string GetMachineConsumeLog(int MoId, int MachineId)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                if (MachineId <= 0) throw new SystemException("【機台】不能為空!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 b.MachineConsumeLogId
                            , e.MoMtlSettingId
							, b.EXPs, b.MaxDispenseQty, b.AllowDispenseQty
                            , FORMAT(b.BindDate, 'yyyy-MM-dd') BindDate
							, FORMAT(b.OpeningDate, 'yyyy-MM-dd') OpeningDate
                            FROM MES.Machine a 
                            LEFT JOIN MES.MachineConsumeLog b ON a.MachineId = b.MachineId AND b.UnBindDate IS NULL 
                            LEFT JOIN SCM.LotNumber c ON b.LotNumberId = c.LotNumberId
                            LEFT JOIN MES.WoDetail d ON c.MtlItemId = d.MtlItemId
                            LEFT JOIN MES.MoMtlSetting e ON d.WoDetailId = e.WoDetailId AND e.MoId = @MoId
                            LEFT JOIN PDM.MtlItem f ON c.MtlItemId = f.MtlItemId
                            WHERE a.MachineId = @MachineId 
                            AND (
                                b.MachineId IS NULL 
                                OR (b.MachineId IS NOT NULL AND e.MoId IS NOT NULL)
                            )
                            ORDER BY b.MachineConsumeLogId DESC ";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MachineId", MachineId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckProcessJump -- 確認製程是否有前製程尚未完成 -- Ann 2024-07-29
        public string GetCheckProcessJump(int MoId, int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MoProcessId <= 0) throw new SystemException("【製令製程】不能為空!");

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.ProcessAlias
                            FROM MES.MoProcess a
                            WHERE a.MoId = @MoId
                            AND a.NecessityStatus = 'Y'
                            AND a.SortNumber < (
                                SELECT a1.SortNumber
                                FROM MES.MoProcess a1
                                WHERE a1.MoProcessId = @MoProcessId
                            )
                            AND NOT EXISTS(
                                SELECT 1
                                FROM MES.BarcodeProcess b
                                WHERE a.MoProcessId = b.MoProcessId
                            )
                            ORDER BY a.SortNumber";
                    //sql = @"SELECT (
                    //            SELECT TOP 1 SortedResults.ProcessAlias
                    //            FROM (
                    //                SELECT TOP 1 PERCENT *
                    //                FROM MES.MoProcess xa 
                    //                WHERE xa.SortNumber < a.SortNumber
                    //                AND xa.NecessityStatus = 'Y'
                    //                AND xa.MoId = a.MoId
                    //                ORDER BY xa.SortNumber DESC
                    //            ) AS SortedResults
                    //            WHERE NOT EXISTS (
                    //                SELECT TOP 1 1 
                    //                FROM MES.BarcodeProcess xb 
                    //                WHERE xb.MoProcessId = SortedResults.MoProcessId
                    //            )
                    //        ) ProcessAlias
                    //        FROM MES.MoProcess a 
                    //        WHERE a.MoProcessId = @MoProcessId
                    //        AND NOT EXISTS(
                    //            SELECT TOP 1 1 FROM MES.BarcodeProcess x 
                    //            WHERE x.MoProcessId = a.MoProcessId
                    //        )
                    //        AND EXISTS (
                    //            SELECT TOP 1 1 FROM MES.Barcode x 
                    //            WHERE x.NextMoProcessId = a.MoProcessId
                    //        )
                    //        ";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetRoutingItemQcItem -- 取得途程量測資料 -- Ann 2025-05-08
        public string GetRoutingItemQcItem(int MoProcessId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.RoutingItemQcItemId, a.RoutingItemId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance, a.QmmDetailId
                            , c.QcItemNo, c.QcItemName, c.QcItemDesc
                            , d.MachineNumber QcMachineNumber
                            , e.MachineDesc QcMachineName
                            , f.QcClassName
                            , g.QcGroupName
                            FROM MES.RoutingItemQcItem a 
                            INNER JOIN MES.MoRouting b ON a.RoutingItemId = b.RoutingItemId
                            INNER JOIN QMS.QcItem c ON a.QcItemId = c.QcItemId
                            LEFT JOIN QMS.QmmDetail d ON a.QmmDetailId = d.QmmDetailId
                            LEFT JOIN MES.Machine e ON d.MachineId = e.MachineId
                            INNER JOIN QMS.QcClass f ON c.QcClassId = f.QcClassId
                            INNER JOIN QMS.QcGroup g ON f.QcGroupId = g.QcGroupId
                            INNER JOIN MES.RoutingItemProcess h ON a.ItemProcessId = h.ItemProcessId
                            INNER JOIN MES.RoutingProcess i ON h.RoutingProcessId = i.RoutingProcessId
                            INNER JOIN MES.MoProcess j ON i.ProcessId = j.ProcessId AND j.MoId = b.MoId
                            WHERE j.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcReceiptTemplate -- 取得量測樣板 -- Ann 2025-05-09
        public string GetQcReceiptTemplate(int TemplateId, int ModeId, string TemplateName)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TemplateId, a.CompanyId, a.ModeId, a.TemplateName
                            FROM MES.QcReceiptTemplate a 
                            WHERE a.CompanyId = @CompanyId
                            AND a.[Status] = 'A'";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TemplateId", @" AND a.TemplateId = @TemplateId", TemplateId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "ModeId", @" AND a.ModeId = @ModeId", ModeId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TemplateName", @" AND a.TemplateName LIKE '%' + @TemplateName + '%'", TemplateName);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcReceiptTemplateDetail -- 取得量測樣板詳細資料 -- Ann 2025-05-09
        public string GetQcReceiptTemplateDetail(int DetailIdDetailId, int TemplateId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.DetailId, a.TemplateId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance, a.QmmDetailId
                            , b.TemplateName
                            , c.QcItemNo, c.QcItemName, c.QcItemDesc
                            , d.QcClassName
                            , e.QcGroupName
                            , f.MachineNumber
                            , g.MachineDesc MachineName
                            FROM MES.QcReceiptTemplateDetail a 
                            INNER JOIN MES.QcReceiptTemplate b ON a.TemplateId = b.TemplateId AND b.[Status] = 'A'
                            INNER JOIN QMS.QcItem c ON a.QcItemId = c.QcItemId
                            INNER JOIN QMS.QcClass d ON c.QcClassId = d.QcClassId
                            INNER JOIN QMS.QcGroup e ON d.QcGroupId = e.QcGroupId
                            LEFT JOIN QMS.QmmDetail f ON a.QmmDetailId = f.QmmDetailId
                            LEFT JOIN MES.Machine g ON f.MachineId = g.MachineId
                            WHERE b.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "DetailIdDetailId", @" AND a.DetailIdDetailId = @DetailIdDetailId", DetailIdDetailId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TemplateId", @" AND a.TemplateId = @TemplateId", TemplateId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetInProcessBarcode -- 取得在製條碼 -- GPAI 2025-02-03
        public string GetInProcessBarcode(string WoErpFullNo, int MoProcessId, string StartDate, string FinishDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "A.BarcodeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @" , A.BarcodeNo, A.BarcodeQty, A.CurrentProdStatus, A.BarcodeStatus, A.CurrentMoProcessId
		                   , A.MoId, A.WoId, A.WoSeq
		                   , A.WoErpFullNo
		                   , A.ModeNo, A.ModeName, A.ModeDesc
		                   , A.BarcodeProcessId, A.StartDate, A.FinishDate, A.StartUserId, A.StartUserName, A.FinishUserId ,A.FinishUserName
		                   , A.MoProcessId
		                   , A.ProcessId, A.ProcessName, A.ProcessNo";
                    sqlQuery.mainTables =
                        @"FROM (
                          SELECT 
                              a.BarcodeId, a.BarcodeNo, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus, a.CurrentMoProcessId
	                      	, b.MoId, b.WoId, b.WoSeq
	                      	, (c.WoErpPrefix + '-' + c.WoErpNo +  '(' + CONVERT(VARCHAR(10), b.WoSeq) + ')') WoErpFullNo
	                      	, d.ModeNo, d.ModeName, d.ModeDesc
	                      	, e.BarcodeProcessId, e.StartDate, e.FinishDate, e.StartUserId, (h1.UserNo + '-' + h1.UserName) StartUserName, e.FinishUserId ,(h2.UserNo + '-' + h2.UserName) FinishUserName
	                      	, f.MoProcessId
	                      	, g.ProcessId, g.ProcessName, g.ProcessNo
                            , ROW_NUMBER() OVER (PARTITION BY a.BarcodeId ORDER BY e.BarcodeProcessId DESC, a.CurrentMoProcessId DESC) AS rn
                          FROM MES.Barcode a
                          INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                          INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                          INNER JOIN MES.ProdMode d ON b.ModeId = d.ModeId
                          INNER JOIN MES.BarcodeProcess e ON a.BarcodeId = e.BarcodeId
                          INNER JOIN MES.MoProcess f ON f.MoId = b.MoId
                          INNER JOIN MES.Process g ON f.ProcessId = g.ProcessId
	                      INNER JOIN BAS.[User] h1 ON e.StartUserId = h1.UserId
	                      INNER JOIN BAS.[User] h2 ON e.FinishUserId = h2.UserId
                          WHERE a.BarcodeStatus NOT IN ('7', '8', '10')  AND a.CurrentProdStatus != 'S'
                          	AND (c.WoErpPrefix + '-' + c.WoErpNo +  '(' + CONVERT(VARCHAR(10), b.WoSeq) + ')') LIKE '%' + @WoErpFullNo + '%'
                          ) AS A";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND rn = 1";
                    dynamicParameters.Add("WoErpFullNo", WoErpFullNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoProcessId", @" AND A.MoProcessId <= @MoProcessId ", MoProcessId);

                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND A.StartDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND A.StartDate <= @EndDate ", FinishDate.Length > 0 ? Convert.ToDateTime(FinishDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "A.BarcodeId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWorOrderMaterial -- 取得制令所属工单材料 -- Jean 2025-05-29
        public string GetWorOrderMaterial(int MoId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MoId,c.MtlItemId,d.MtlItemNo,d.MtlItemName,d.MtlItemSpec,b.CompanyId,d.MtlItemNo +' '+d.MtlItemName AS PixMtlItem
                            FROM MES.ManufactureOrder a
                            LEFT JOIN MES.WipOrder b ON a.WoId=b.WoId
                            LEFT JOIN MES.WoDetail c ON c.WoId=b.WoId
                            LEFT JOIN PDM.MtlItem d ON d.MtlItemId=c.MtlItemId
                            WHERE b.CompanyId=@CompanyId AND a.MoId=@MoId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("MoId", MoId);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetMaterialFeedingRecord  -- 取得投料记录  Jean 2025-06-03
        public string GetMaterialFeedingRecord(int MatFeedRegId, int MachineId, int MoId, string FeedDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try

            {

                FeedDate = DateTime.Parse(FeedDate).ToString("yyyyMMdd");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MatFeedRegId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",a.MachineId,b.MachineNo,b.MachineName
                            ,a.MoId,e.WoErpPrefix+'-'+e.WoErpNo WoErpPrefix
                            ,a.MaterialId,d.MtlItemNo,d.MtlItemName,d.MtlItemSpec
                            ,a.MatInRegQty,a.UomId,f.UomNo,f.UomName,a.Status,a.FeedDate,a.Remarks
                          ";
                    sqlQuery.mainTables =
                        @"FROM MES.MaterialFeedReg a
                            INNER JOIN MES.Machine b ON b.MachineId=a.MachineId
                            INNER JOIN MES.ManufactureOrder c ON c.MoId=a.MoId
                            INNER JOIN MES.WipOrder e ON e.WoId=c.WoId
                            INNER JOIN PDM.MtlItem d ON d.MtlItemId=a.MaterialId
                            INNER JOIN PDM.UnitOfMeasure f ON f.UomId=a.UomId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.Status='A'";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MachineId", @" AND a.MachineId= @MachineId", MachineId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MoId", @" AND a.MoId =@MoId", MoId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "FeedDate", @" AND CONVERT(varchar(10), a.FeedDate, 112)=@FeedDate", FeedDate);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MatFeedRegId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;
                    //sqlQuery.distinct = true;


                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion

        #region //編程
        #region//GetCncProgramWorkFiles -- 取得編程程式 -- Ding 2023-02-15
        public string GetCncProgramWorkFiles(int CompanyId, int MoProcessId, int MachineId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    int CncProgramWorkId = -1;
                    sql = @" SELECT MAX(a.CncProgramWorkId) CncProgramWorkId
                             FROM MES.CncProgramWork a
                             INNER JOIN MES.MoProcess b ON a.MoProcessId=b.MoProcessId
                             INNER JOIN MES.ManufactureOrder c ON c.MoId=b.MoId
                             INNER JOIN MES.WipOrder d ON d.WoId=c.WoId
                             WHERE 1=1
                             AND a.MoProcessId=@MoProcessId AND a.MachineId=@MachineId";
                    //dynamicParameters.Add("CompanyId", CompanyId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("MachineId", MachineId);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    foreach (var item in result)
                    {
                        CncProgramWorkId = item.CncProgramWorkId;
                    }

                    sql = @" SELECT a.CncProgramWorkId,a.MoProcessId,a.MachineId,b.FileId,b.NcName, c.[FileName], c.FileExtension,c.FileContent
                          FROM MES.CncProgramWork a
                          INNER JOIN MES.CncProgramWorkFiles b ON a.CncProgramWorkId=b.CncProgramWorkId
                          INNER JOIN BAS.[File] c ON c.FileId=b.FileId 
                          WHERE b.FileType=1 AND a.CncProgramWorkId=@CncProgramWorkId";
                    dynamicParameters.Add("CncProgramWorkId", CncProgramWorkId);
                    result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetSkyMarsMachine --取得SkyMars 機台資訊
        public string GetSkyMarsMachine(int MachineId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @" SELECT *
                            FROM MES.SkyMarsMachine 
                            WHERE MachineId=@MachineId";
                    dynamicParameters.Add("MachineId", MachineId);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() != 1) throw new SystemException("查無【SkyMars 機台資訊】，請重新輸入!");

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //工程檢/出貨檢共用
        #region //GetBarcodeProcessIPQC -- 取得條碼過站歷程資訊 -- Ann 2022-10-04
        public string GetBarcodeProcessIPQC(string BarcodeNo, int MoProcessId)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【條碼】不能為空!");
                if (MoProcessId <= 0) throw new SystemException("【製程】不能為空!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷品異單是否已經判定完成
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT JudgeStatus
                            FROM QMS.AqBarcode a
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                            WHERE b.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    if (result.Count() > 0)
                    {
                        foreach (var item in result)
                        {
                            if (item.JudgeStatus == null) throw new SystemException("此條碼尚有品異單未判定!");
                        }
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.BarcodeProcessId, a.BarcodeId, a.MoId, a.MachineId, a.ProdStatus, a.StationQty, a.PassQty, a.NgQty
                            , FORMAT(a.StartDate, 'yyyy-MM-dd HH:mm:ss') StartDate, FORMAT(a.FinishDate, 'yyyy-MM-dd HH:mm:ss') FinishDate
                            , a.ModeShiftId, a.CycleTime
                            , c.ShiftName
                            , d.MachineNo, d.MachineName
                            , e.UserNo StartUserNo, e.UserName StartUserName
                            , f.UserNo FinishUserNo, f.UserName FinishUserName
                            , g.ItemValue, g.ItemSeq
                            , j.MtlItemNo, j.MtlItemName
                            , k.QcBarcodeId, k.QcStatus
                            FROM MES.BarcodeProcess a
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId AND b.CurrentMoProcessId = a.MoProcessId
                            LEFT JOIN BAS.Shift c ON a.ModeShiftId = c.ShiftId
                            LEFT JOIN MES.Machine d ON a.MachineId = d.MachineId
                            INNER JOIN BAS.[User] e ON a.StartUserId = e.UserId
                            INNER JOIN BAS.[User] f ON a.FinishUserId = f.UserId
                            LEFT JOIN MES.BarcodeProcessAttribute g ON a.BarcodeProcessId = g.BarcodeProcessId
                            INNER JOIN MES.ManufactureOrder h ON b.MoId = h.MoId
                            INNER JOIN MES.WipOrder i ON h.WoId = i.WoId
                            INNER JOIN PDM.MtlItem j ON i.MtlItemId = j.MtlItemId
                            LEFT JOIN MES.QcBarcode k ON k.BarcodeProcessId = a.BarcodeProcessId
                            AND k.QcBarcodeId = (
                              SELECT TOP 1 ka.QcBarcodeId
                              FROM MES.QcBarcode ka
                              WHERE ka.BarcodeProcessId = a.BarcodeProcessId
                              ORDER BY ka.CreateDate DESC
                            )
                            WHERE b.CurrentProdStatus = 'P' AND a.FinishDate IS NOT NULL";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND b.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);

                    sql += @" ORDER BY a.FinishDate DESC";

                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result2
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetIpqcQcNoticeItemSpec -- 取得工程檢量測項目及標準值公差 -- Ann 2022-02-14
        public string GetIpqcQcNoticeItemSpec(int MoProcessId, string QcNoticeType, string Status, int QcNoticeItemSpecId, int QcItemId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //查詢RoutingProcessId
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.RoutingProcessId
                            FROM MES.MoProcess a
                            WHERE a.MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var RoutingProcessIdResult = sqlConnection.Query(sql, dynamicParameters);

                    if (RoutingProcessIdResult.Count() <= 0) throw new SystemException("【此製令製程】資料錯誤!");

                    int RoutingProcessId = -1;
                    foreach (var item in RoutingProcessIdResult)
                    {
                        if (item.RoutingProcessId == null) throw new SystemException("此製程非原途程站別，無法進行工程檢!");
                        RoutingProcessId = item.RoutingProcessId;
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT a.QcNoticeItemSpecId, a.QcNoticeId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance
                            , a.MakeCount, a.ProductQcCount, a.QcUomId, a.Depth, a.Remark, a.[Status]
                            , b.QcNoticeNo, b.QcNoticeQty, b.QcNoticeType, b.ResetFlag, b.ControlId
                            , f.QcItemNo, f.QcItemName, f.QcItemDesc, f.Remark QcItemRemark, f.QcItemType
                            , g.QcUomNo UomNo, g.QcUomName UomName
                            , (
                                SELECT ja.QcMachineModeId, ja.QcMachineModeNo, ja.QcMachineModeDesc, ja.QcMachineModeName, ja.QcMachineModeNumber
                                FROM QMS.QiDetail j
                                INNER JOIN QMS.QcMachineMode ja ON j.QcMachineModeId = ja.QcMachineModeId
                                WHERE j.QcItemId = a.QcItemId
                                FOR JSON PATH, ROOT('data')
                            ) MachineInfo
                            FROM QMS.QcNoticeItemSpec a
                            INNER JOIN QMS.QcNotice b ON a.QcNoticeId = b.QcNoticeId
                            INNER JOIN MES.RoutingItem c ON b.ControlId = c.ControlId
                            INNER JOIN MES.Routing d ON c.RoutingId = d.RoutingId
                            INNER JOIN MES.RoutingProcess e ON d.RoutingId = e.RoutingId
                            INNER JOIN QMS.QcItem f ON a.QcItemId = f.QcItemId
                            INNER JOIN QMS.UnitOfQcMeasure g ON a.QcUomId = g.QcUomId
                            INNER JOIN QMS.QcClass h ON f.QcClassId = h.QcClassId
                            INNER JOIN QMS.QcGroup i ON h.QcGroupId = i.QcGroupId
                            WHERE i.CompanyId = @CompanyId
                            AND b.RoutingProcessId = @RoutingProcessId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("RoutingProcessId", RoutingProcessId);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeType", @" AND b.QcNoticeType = @QcNoticeType", QcNoticeType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND b.Status = @Status", Status);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeItemSpecId", @" AND a.QcNoticeItemSpecId = @QcNoticeItemSpecId", QcNoticeItemSpecId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcItemId", @" AND a.QcItemId = @QcItemId", QcItemId);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeProcessSeq -- 取得該站可工程檢數量 -- Ann 2022-10-05
        public string GetBarcodeProcessSeq(int MoId, int MoProcessId)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                if (MoProcessId <= 0) throw new SystemException("【製程】不能為空!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT COUNT(1) Count
                            FROM MES.Barcode a
                            INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId 
                            AND b.MoId = @MoId AND b.MoProcessId = @MoProcessId
                            AND a.CurrentMoProcessId = b.MoProcessId";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetTempQcMeasureData -- 取得工程檢/出貨檢暫存資料 -- Ann 2022-10-07
        public string GetTempQcMeasureData(string BarcodeNo, int MoProcessId, string Status, int MoId, string QcNoticeType)
        {
            try
            {
                if (Status.Length <= 0) throw new SystemException("【狀態】不能為空!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TempQmdId, a.QcNoticeItemSpecId, a.BarcodeId, a.QmmDetailId, a.MeasureValue, a.MakeCount, a.[Status], a.Remark
                            , FORMAT(a.CreateDate, 'yyyy-MM-dd HH:ss:mm') CreateDate, a.CreateBy, a.LastModifiedBy, a.MoProcessId
                            , d.BarcodeNo
                            , e.QcMachineModeId
                            , f.QcItemId, f.QcItemName, f.QcItemType
                            , g.MachineDesc
                            , h.UserNo CreateUserNo, h.UserName CreateUserName
                            FROM QMS.TempQcMeasureData a
                            INNER JOIN QMS.QcNoticeItemSpec b ON a.QcNoticeItemSpecId = b.QcNoticeItemSpecId
                            INNER JOIN QMS.QcNotice c ON b.QcNoticeId = c.QcNoticeId
                            LEFT JOIN MES.Barcode d ON a.BarcodeId = d.BarcodeId
                            INNER JOIN QMS.QmmDetail e ON a.QmmDetailId = e.QmmDetailId
                            INNER JOIN QMS.QcItem f ON b.QcItemId = f.QcItemId
                            INNER JOIN MES.Machine g ON e.MachineId = g.MachineId
                            INNER JOIN BAS.[User] h ON a.CreateBy = h.UserId
                            WHERE a.Status = @Status";
                    dynamicParameters.Add("Status", Status);

                    if (BarcodeNo.Length <= 0)
                    {
                        sql += @" AND a.BarcodeId IS NULL";
                    }

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND d.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoProcessId", @" AND a.MoProcessId = @MoProcessId", MoProcessId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeType", @" AND c.QcNoticeType = @QcNoticeType", QcNoticeType);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcRecordProcess -- 取得工程檢/出貨檢歷程資料 -- Ann 2022-10-13
        public string GetQcRecordProcess(int MoId, int MoProcessId, string BarcodeNo, int QcNoticeItemSpecId, int MakeCount
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.QmdId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MeasureValue, a.MakeCount, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate, a.QcResult
                        , b.Depth, b.DesignValue, b.UpperTolerance, b.LowerTolerance
                        , f.UserNo MeasureUserNo, f.UserName MeasureUserName
                        , g.UserNo CncUserNo, g.UserName CncUserName";
                    sqlQuery.mainTables =
                        @"FROM QMS.QcMeasureData a
                        INNER JOIN QMS.QcNoticeItemSpec b ON a.QcNoticeItemSpecId = b.QcNoticeItemSpecId
                        INNER JOIN MES.QcRecord c ON a.QcRecordId = c.QcRecordId
                        LEFT JOIN MES.QcBarcode d ON c.QcRecordId = d.QcRecordId AND d.BarcodeId = a.BarcodeId
                        LEFT JOIN MES.Barcode e ON d.BarcodeId = e.BarcodeId
                        INNER JOIN BAS.[User] f ON a.CreateBy = f.UserId
                        INNER JOIN BAS.[User] g ON b.CreateBy = g.UserId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"";

                    if (BarcodeNo.Length <= 0) queryCondition += @" AND a.BarcodeId IS NULL";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "QcNoticeItemSpecId", @" AND a.QcNoticeItemSpecId = @QcNoticeItemSpecId", QcNoticeItemSpecId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MakeCount", @" AND a.MakeCount = @MakeCount", MakeCount);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BarcodeNo", @" AND e.BarcodeNo = @BarcodeNo", BarcodeNo);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.QcRecordId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcMeasureDataSeq -- 取得工程檢項目歷程次數 -- Ann 2022-10-13
        public string GetQcMeasureDataSeq(int MoId, int MoProcessId, string BarcodeNo, int QcNoticeItemSpecId, int MakeCount, string Cavity)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT Count(1) Count
                            FROM QMS.QcMeasureData a
                            INNER JOIN MES.QcRecord b ON a.QcRecordId = b.QcRecordId
                            INNER JOIN MES.QcBarcode c ON b.QcRecordId = c.QcRecordId AND a.BarcodeId = c.BarcodeId
                            INNER JOIN MES.Barcode d ON c.BarcodeId = d.BarcodeId
                            INNER JOIN QMS.QcNoticeItemSpec e ON a.QcNoticeItemSpecId = e.QcNoticeItemSpecId
                            INNER JOIN QMS.QcNotice f ON e.QcNoticeId = f.QcNoticeId
                            WHERE a.QcNoticeItemSpecId = @QcNoticeItemSpecId AND a.MakeCount = @MakeCount
                            AND b.MoId = @MoId AND b.MoProcessId = @MoProcessId AND d.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("QcNoticeItemSpecId", QcNoticeItemSpecId);
                    dynamicParameters.Add("MakeCount", MakeCount);
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Cavity", @" AND a.Cavity = @Cavity", Cavity);

                    if (BarcodeNo.Length <= 0) sql += @" AND a.BarcodeId IS NULL";

                    var result = sqlConnection.Query(sql, dynamicParameters);


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetFilePathSetting -- 取得量測上傳路徑 -- Ann 2022-11-21
        public string GetFilePathSetting(int QcMachineModeId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.FilePathSettingId, a.QcMachineModeId, a.ItemNo, a.[Status]
                            FROM QMS.FilePathSetting a
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcMachineModeId", @" AND a.QcMachineModeId = @QcMachineModeId", QcMachineModeId);

                    var result = sqlConnection.Query(sql, dynamicParameters);


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeForLettering -- 取得條碼資訊FOR刻號 -- Ann 2022-11-21
        public string GetBarcodeForLettering(string ItemValue)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT c.BarcodeNo
                            FROM MES.BarcodeProcessAttribute a
                            INNER JOIN MES.BarcodeProcess b ON a.BarcodeProcessId = b.BarcodeProcessId
                            INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                            WHERE a.ItemNo = 'Lettering' AND a.ItemValue = @ItemValue";
                    dynamicParameters.Add("ItemValue", ItemValue);
                    
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcFile -- 取得量測數據上傳檔案 -- Ann 2022-12-20
        public string GetQcFile(int QcFileId, int QcNoticeId, int QcNoticeItemSpecId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (QcNoticeItemSpecId > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.QcNoticeId
                                FROM QMS.QcNoticeItemSpec a
                                WHERE QcNoticeItemSpecId = @QcNoticeItemSpecId";
                        dynamicParameters.Add("QcNoticeItemSpecId", QcNoticeItemSpecId);

                        var qcNoticeIdResult = sqlConnection.Query(sql, dynamicParameters);

                        if (qcNoticeIdResult.Count() <= 0) throw new SystemException("查無此通知單號");
                        foreach (var item in qcNoticeIdResult)
                        {
                            QcNoticeId = item.QcNoticeId;
                        }
                    }

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.QcFileId, a.FileId, a.QcNoticeId
                            , b.[FileName] ,b.FileContent, b.FileExtension, b.FileSize
                            FROM QMS.QcFile a
                            INNER JOIN BAS.[File] b ON a.FileId = b.FileId
                            INNER JOIN QMS.QcNotice c ON a.QcNoticeId = c.QcNoticeId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcFileId", @" AND a.QcFileId = @QcFileId", QcFileId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeId", @" AND a.QcNoticeId = @QcNoticeId", QcNoticeId);

                    sql += @" ORDER BY a.CreateDate DESC";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQmmDetail -- 取得量測機台詳細資料 -- Ann 2023-02-20
        public string GetQmmDetail(int QmmDetailId, int MachineId, string MachineNumber)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QmmDetailId, a.MachineNumber, a.QcMachineModeId
                            , b.QcMachineModeNo, b.QcMachineModeName, b.QcMachineModeDesc
                            , b.QcMachineModeNo + ' ' + b.QcMachineModeName QcMachineModeWithNo
                            , c.MachineNo, c.MachineName, c.MachineDesc
                            , (c.MachineNo + ' ' + c.MachineName) MachineWithNo
                            FROM QMS.QmmDetail a
                            INNER JOIN QMS.QcMachineMode b ON a.QcMachineModeId = b.QcMachineModeId
                            INNER JOIN MES.Machine c ON a.MachineId = c.MachineId
                            INNER JOIN MES.WorkShop d ON c.ShopId = d.ShopId
                            WHERE d.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineId", @" AND a.MachineId = @MachineId", MachineId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QmmDetailId", @" AND a.QmmDetailId = @QmmDetailId", QmmDetailId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MachineNumber", @" AND a.MachineNumber = @MachineNumber", MachineNumber);

                    sql += @" ORDER BY a.CreateDate DESC";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //出貨檢
        #region //GetOQcBarcode -- 取得出貨檢條碼資訊 -- Ann 2022-11-23
        public string GetOQcBarcode(string BarcodeNo, int MoId, string QcType)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷品異單是否已經判定完成
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT JudgeStatus
                            FROM QMS.AqBarcode a
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                            WHERE b.BarcodeNo = @BarcodeNo";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    var aqBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                    if (aqBarcodeResult.Count() > 0)
                    {
                        foreach (var item in aqBarcodeResult)
                        {
                            if (item.JudgeStatus == null) throw new SystemException("此條碼尚有品異單未判定!");
                        }
                    }
                    #endregion

                    #region //判斷此條碼是否可以進行出貨檢
                    sql = @"SELECT a.QcRecordId, a.QcStatus QcRecordQcStatus
                            , b.QcBarcodeId, b.QcStatus QcBarcodeQcStatus
                            FROM MES.QcRecord a
                            INNER JOIN MES.QcBarcode b ON a.QcRecordId = b.QcRecordId
                            INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                            WHERE c.BarcodeNo = @BarcodeNo AND a.MoId = @MoId AND a.QcType = @QcType";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("QcType", QcType);

                    var oqcResult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in oqcResult)
                    {
                        if (item.QcBarcodeId == null && item.QcRecordQcStatus != "M") throw new SystemException("此製令已有出貨檢紀錄，無法繼續上傳!");
                        else if (item.QcBarcodeId != null && item.QcBarcodeQcStatus != "M") throw new SystemException("此條碼已有出貨檢紀錄，無法重複上傳!");
                    }
                    #endregion

                    sql = @"SELECT TOP 1 a.BarcodeId
                            , c.ItemValue, c.ItemSeq
                            , f.MtlItemName
                            FROM MES.Barcode a
                            INNER JOIN MES.BarcodeProcess b ON a.CurrentMoProcessId = b.MoProcessId AND a.BarcodeId = b.BarcodeId
                            LEFT JOIN MES.BarcodeProcessAttribute c ON b.BarcodeProcessId = c.BarcodeProcessId AND c.ItemNo = 'Lettering'
                            INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                            INNER JOIN MES.WipOrder e ON d.WoId = e.WoId
                            INNER JOIN PDM.MtlItem f ON e.MtlItemId = f.MtlItemId
                            WHERE a.BarcodeStatus != '1' AND a.CurrentProdStatus = 'P'";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND a.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    sql += @" ORDER BY b.CreateDate DESC";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetOQcMeasureDataSeq -- 取得出貨檢項目歷程次數 -- Ann 2022-10-13
        public string GetOQcMeasureDataSeq(int MoId, string BarcodeNo, int QcNoticeItemSpecId, int MakeCount, string Cavity)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT Count(1) Count
                            FROM QMS.QcMeasureData a
                            INNER JOIN QMS.QcNoticeItemSpec b ON a.QcNoticeItemSpecId = b.QcNoticeItemSpecId
                            INNER JOIN QMS.QcNotice c ON b.QcNoticeId = c.QcNoticeId
                            INNER JOIN MES.QcRecord d ON a.QcRecordId = d.QcRecordId
                            LEFT JOIN MES.QcBarcode e ON d.QcRecordId = e.QcRecordId AND e.BarcodeId = a.BarcodeId
                            LEFT JOIN MES.Barcode f ON e.BarcodeId = f.BarcodeId
                            WHERE 1=1";
                    if (BarcodeNo.Length <= 0) sql += @" AND a.BarcodeId IS NULL";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeItemSpecId", @" AND a.QcNoticeItemSpecId = @QcNoticeItemSpecId", QcNoticeItemSpecId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MakeCount", @" AND a.MakeCount = @MakeCount", MakeCount);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BarcodeNo", @" AND f.BarcodeNo = @BarcodeNo", BarcodeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Cavity", @" AND a.Cavity = @Cavity", Cavity);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND d.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetOqcQcNoticeItemSpec -- 取得出貨檢/試產檢 量測項目 -- Ann 2023-02-14
        public string GetOqcQcNoticeItemSpec(int MoId, string QcNoticeType, string Status, int QcNoticeItemSpecId, int QcItemId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QcNoticeItemSpecId, a.QcNoticeId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance
                            , a.MakeCount, a.ProductQcCount, a.QcUomId, a.Depth, a.Remark, a.[Status]
                            , b.QcNoticeNo, b.QcNoticeQty, b.QcNoticeType, b.ResetFlag, b.ControlId
                            , g.QcItemNo, g.QcItemName, g.QcItemDesc, g.Remark QcItemRemark, g.QcItemType
                            , h.QcUomNo UomNo, h.QcUomName UomName
                            , (
                                SELECT ka.QcMachineModeId, ka.QcMachineModeNo, ka.QcMachineModeDesc, ka.QcMachineModeName, ka.QcMachineModeNumber
                                FROM QMS.QiDetail k
                                INNER JOIN QMS.QcMachineMode ka ON k.QcMachineModeId = ka.QcMachineModeId
                                WHERE k.QcItemId = a.QcItemId
                                FOR JSON PATH, ROOT('data')
                            ) MachineInfo
                            FROM QMS.QcNoticeItemSpec a
                            INNER JOIN QMS.QcNotice b ON a.QcNoticeId = b.QcNoticeId
                            INNER JOIN PDM.RdDesignControl c ON b.ControlId = c.ControlId
                            INNER JOIN PDM.RdDesign d ON c.DesignId = d.DesignId
                            INNER JOIN MES.WipOrder e ON d.MtlItemId = e.MtlItemId
                            INNER JOIN MES.ManufactureOrder f ON e.WoId = f.WoId
                            INNER JOIN QMS.QcItem g ON a.QcItemId = g.QcItemId
                            INNER JOIN QMS.UnitOfQcMeasure h ON a.QcUomId = h.QcUomId
                            INNER JOIN QMS.QcClass i ON g.QcClassId = i.QcClassId
                            INNER JOIN QMS.QcGroup j ON i.QcGroupId = j.QcGroupId
                            WHERE j.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND f.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeType", @" AND b.QcNoticeType = @QcNoticeType", QcNoticeType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND b.Status = @Status", Status);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeItemSpecId", @" AND a.QcNoticeItemSpecId = @QcNoticeItemSpecId", QcNoticeItemSpecId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcItemId", @" AND a.QcItemId = @QcItemId", QcItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //全吋檢
        #region //GetTqcQcNoticeItemSpec -- 取得全吋檢量測項目 -- Ann 2023-02-17
        public string GetTqcQcNoticeItemSpec(int MoId, string QcNoticeType, string Status, int QcNoticeItemSpecId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QcNoticeItemSpecId, a.QcNoticeId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance
                            , a.MakeCount, a.ProductQcCount, a.QcUomId, a.Depth, a.Remark, a.[Status]
                            , b.QcNoticeNo, b.QcNoticeQty, b.QcNoticeType, b.ResetFlag, b.ControlId
                            , c.QcItemNo, c.QcItemName, c.QcItemDesc, c.Remark QcItemRemark, c.QcItemType
                            , d.QcUomNo UomNo, d.QcUomName UomName
                            , (
                                SELECT ga.QcMachineModeId, ga.QcMachineModeNo, ga.QcMachineModeDesc, ga.QcMachineModeName, ga.QcMachineModeNumber
                                FROM QMS.QiDetail g
                                INNER JOIN QMS.QcMachineMode ga ON g.QcMachineModeId = ga.QcMachineModeId
                                WHERE g.QcItemId = a.QcItemId
                                FOR JSON PATH, ROOT('data')
                            ) MachineInfo
                            FROM QMS.QcNoticeItemSpec a
                            INNER JOIN QMS.QcNotice b ON a.QcNoticeId = b.QcNoticeId
                            INNER JOIN QMS.QcItem c ON a.QcItemId = c.QcItemId
                            INNER JOIN QMS.UnitOfQcMeasure d ON a.QcUomId = d.QcUomId
                            INNER JOIN QMS.QcClass e ON c.QcClassId = e.QcClassId
                            INNER JOIN QMS.QcGroup f ON e.QcGroupId = f.QcGroupId
                            WHERE f.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND b.MoId = @MoId", MoId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeType", @" AND b.QcNoticeType = @QcNoticeType", QcNoticeType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Status", @" AND b.Status = @Status", Status);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "QcNoticeItemSpecId", @" AND a.QcNoticeItemSpecId = @QcNoticeItemSpecId", QcNoticeItemSpecId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //高度計

        #region //GetBarcodeProcessBarcode -- 取得該站完工可檢條碼 -- GPai 20231110
        public string GetBarcodeProcessBarcode(int MoId, int MoProcessId)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                if (MoProcessId <= 0) throw new SystemException("【製程】不能為空!");
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT *
                            FROM MES.Barcode a
                            INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId 
                            AND b.MoId = @MoId AND b.MoProcessId = @MoProcessId
                            AND a.CurrentMoProcessId = b.MoProcessId AND b.FinishDate IS NOT NULL";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result = sqlConnection.Query(sql, dynamicParameters);


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region GetQcNoticeQcItem//取得編程資料量測項目
        public string GetQcNoticeQcItem(int MoId)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                var qcnoticeId = 0;
                
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //最新IPQC量測單
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.MoId, a.QcNoticeId,a.ControlId,a.RoutingProcessId,a.MoId,a.QcNoticeType,a.QcNoticeNo,a.QcNoticeQty,a.Remark,a.Status,a.DepartmentId,a.ResetFlag
                            ,d.MtlItemNo,d.MtlItemName
                            ,f.WoErpPrefix,f.WoErpNo,e.WoSeq
                            ,h.TypeDesc
                            ,j.ProcessAlias,i.UserName,FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate
                            ,k.DepartmentNo, k.DepartmentName
                            ,l.MtlItemNo WoMtlItemNo, l.MtlItemName WOMtlItemName 
							FROM QMS.QcNotice a
                             LEFT JOIN PDM.RdDesignControl b ON a.ControlId=b.ControlId
                             LEFT JOIN PDM.RdDesign c ON b.DesignId=c.DesignId
                             LEFT JOIN PDM.MtlItem d ON c.MtlItemId=d.MtlItemId
                             LEFT JOIN MES.ManufactureOrder e ON a.MoId=e.MoId
                             LEFT JOIN MES.WipOrder f ON e.WoId=f.WoId 
                             LEFT JOIN (
                                SELECT *
                                FROM BAS.[Type]
                                WHERE TypeSchema = 'QMS' 
                             )h ON a.QcNoticeType=h.TypeName
                             LEFT JOIN BAS.[User] i ON a.CreateBy=i.UserId
                             LEFT JOIN MES.RoutingProcess j ON a.RoutingProcessId=j.RoutingProcessId
                             LEFT JOIN BAS.Department k ON a.DepartmentId = k.DepartmentId
                             LEFT JOIN PDM.MtlItem l ON l.MtlItemId = f.MtlItemId
							 WHERE a.MoId = @MoId /*AND a.QcNoticeType = 'IPQC'*/
							 ORDER BY a.QcNoticeId DESC";
                    dynamicParameters.Add("MoId", MoId);

                    var qcNoticeresult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in qcNoticeresult) {
                        qcnoticeId = item.QcNoticeId;
                    }
                    #endregion

                    #region //量測項目
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QcNoticeItemSpecId ,a.QcNoticeId,a.DesignValue,a.UpperTolerance,a.LowerTolerance,a.MakeCount,a.ProductQcCount,a.Depth,a.Remark,a.CreateDate
                            ,b.QcItemId,b.QcItemName,b.QcItemType
                            ,c.QcUomId,c.QcUomName
							FROM QMS.QcNoticeItemSpec a
                            LEFT JOIN QMS.QcItem b ON a.QcItemId=b.QcItemId
                            LEFT JOIN QMS.UnitOfQcMeasure c ON a.QcUomId=c.QcUomId
							WHERE a.QcNoticeId = @QcNoticeId";
                    dynamicParameters.Add("QcNoticeId", qcnoticeId);

                    var qcNoticeItemresult = sqlConnection.Query(sql, dynamicParameters);
                    #endregion


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = qcNoticeItemresult
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetQcAltimeter --取得量測高度計機台
        public string GetQcAltimeter(string DeviceIdentifierCode, int ShopId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //查詢此IP是否有設定任何一筆紀錄
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1
                            FROM MES.Device a
                            WHERE a.DeviceIdentifierCode = @DeviceIdentifierCode
                            AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("DeviceIdentifierCode", DeviceIdentifierCode);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var DeviceResult = sqlConnection.Query(sql, dynamicParameters);

                    if (DeviceResult.Count() <= 0)
                    {
                        DeviceIdentifierCode = "192.168.20.114";
                    }
                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "b.MachineId, f.DeviceId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", f.DeviceIdentifierCode, b.MachineNo, b.MachineName, b.MachineDesc
                          , a.QmmDetailId, a.MachineNumber, a.QcMachineModeId, (a.MachineNumber + ' ' + b.MachineDesc)QcMachine, c.QcMachineModeName
                          , d.ShopId, d.ShopNo, d.ShopName
                          , f.DeviceName";
                    sqlQuery.mainTables =
                        @"FROM QMS.QmmDetail a
                        INNER JOIN MES.Machine b ON a.MachineId = b.MachineId
                        INNER JOIN QMS.QcMachineMode c ON a.QcMachineModeId = c.QcMachineModeId
						INNER JOIN MES.WorkShop d ON b.ShopId = d.ShopId
						INNER JOIN MES.DeviceMachine e ON a.MachineId = e.MachineId
						INNER JOIN MES.Device f ON e.DeviceId = f.DeviceId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.QcMachineModeId IN (7,30,31,32,45) AND c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DeviceIdentifierCode", @" AND f.DeviceIdentifierCode = @DeviceIdentifierCode", DeviceIdentifierCode);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ShopId", @" AND d.ShopId = @ShopId", ShopId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "b.MachineId, f.DeviceId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    //dynamicParameters = new DynamicParameters();
                    //sql = @"SELECT a.QmmDetailId, b.MachineId, a.MachineNumber, b.MachineNo, b.MachineDesc, a.QcMachineModeId, c.QcMachineModeName
                    //        , (a.MachineNumber + ' ' + b.MachineDesc) QcMachine
                    //        FROM QMS.QmmDetail a
                    //        INNER JOIN MES.Machine b ON a.MachineId = b.MachineId
                    //        INNER JOIN QMS.QcMachineMode c ON a.QcMachineModeId = c.QcMachineModeId
                    //        WHERE a.QcMachineModeId IN (7,30,31,32,45) AND c.CompanyId = @CompanyId";
                    //dynamicParameters.Add("CompanyId", CurrentCompany);
                    //var result = sqlConnection.Query(sql, dynamicParameters);


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetAltimeterData --取得高度計數據 --GPai 20231113
        public string GetAltimeterData(int MoId, int MoProcessId, string MeasurementNo)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                if (MoProcessId <= 0) throw new SystemException("【製程】不能為空!");
                if (MeasurementNo == "") throw new SystemException("【機台】不能為空!");

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //取得數據
                    string postUrl = "http://192.168.134.123:9527/api/Height/PostCreate";
                    JObject postDataJson = new JObject();
                    postDataJson = JObject.FromObject(new
                    {
                        Measurement_ID = MeasurementNo,//量測設備ID
                        Measurement_Read = 1// 1(以此判斷是否量測)
                    });
                    string postData = postDataJson.ToString();
                    UTF8Encoding uTF8 = new UTF8Encoding();
                    var result = BaseHelper.PostWebRequest(postUrl, postData, uTF8);
                    var resultJson = JToken.Parse(result);
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = resultJson
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region GetQcNoticeQcItemValue //取得量測項目設定值
        public string GetQcNoticeQcItemValue(int QcNoticeId, int QcItemId)
        {
            try
            {
                if (QcItemId <= 0) throw new SystemException("【量測項目】不能為空!");
                if (QcNoticeId <= 0) throw new SystemException("【量測單號】不能為空!");
                var qcnoticeId = 0;

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //最新IPQC量測單
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QcNoticeItemSpecId ,a.QcNoticeId,a.DesignValue,a.UpperTolerance,a.LowerTolerance,a.MakeCount,a.ProductQcCount,a.Depth,a.Remark,a.CreateDate
                            ,b.QcItemId,b.QcItemName,b.QcItemType
                            ,c.QcUomId,c.QcUomName
							FROM QMS.QcNoticeItemSpec a
                            LEFT JOIN QMS.QcItem b ON a.QcItemId=b.QcItemId
                            LEFT JOIN QMS.UnitOfQcMeasure c ON a.QcUomId=c.QcUomId
							WHERE a.QcNoticeId = @QcNoticeId AND a.QcItemId = @QcItemId ";

                    dynamicParameters.Add("QcNoticeId", QcNoticeId);
                    dynamicParameters.Add("QcItemId", QcItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion


        #endregion

        #region //物料載盤
        #region //GetVehicle -- 取得載盤資料 -- Ann 2024-05-22
        public string GetVehicle(string VehicleNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.VehicleId, a.CompanyId, a.VehicleNo, a.Remark, a.[Status]
                            FROM MES.Vehicle a 
                            WHERE a.VehicleNo = @VehicleNo
                            AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("VehicleNo", VehicleNo);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion
        #endregion

        #region //Add
        #region //過站
        #region //AddBarcodeProcessAttribute-- 新增製程屬性資料 -- Ann 2022-10-24
        public string AddBarcodeProcessAttribute(string BarcodeProcessAttributeData)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        var BarcodeProcessAttributeJson = JObject.Parse(BarcodeProcessAttributeData);

                        if (BarcodeProcessAttributeJson["BarcodeProcessAttributeInfo"].Count() <= 0) throw new SystemException("【條碼】不能為空!");

                        int UserId = CreateBy;
                        int rowsAffected = 0;
                        foreach (var item in BarcodeProcessAttributeJson["BarcodeProcessAttributeInfo"])
                        {
                            bool LetteringBool = false; //判斷此次刻字為UPDATE還是INSERT

                            if (item["ItemValue"].ToString().Length <= 0) throw new SystemException("【條碼屬性】不能為空!");
                            if (item["ChkUnique"].ToString().Length <= 0) throw new SystemException("【是否檢核重複值】不能為空!");
                            if (item["DateCode"].ToString().Length <= 0) throw new SystemException("【屬性日期】不能為空!");

                            #region //判斷製令歷程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MoId, BarcodeId
                                    FROM MES.BarcodeProcess
                                    WHERE BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.Add("BarcodeProcessId", Convert.ToInt32(item["BarcodeProcessId"]));

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("製令歷程資料錯誤!");

                            int MoId = -1;
                            int BarcodeId = -1;
                            foreach (var item2 in result)
                            {
                                MoId = item2.MoId;
                                BarcodeId = item2.BarcodeId;
                            }
                            #endregion

                            int ItemSeq = -1;
                            string MoItemPartNo = "";
                            if (item["ItemNo"].ToString() == "Lettering")
                            {
                                var intFlag = int.TryParse(item["ItemValue"].ToString(), out int stringToInt);
                                if (intFlag == false) throw new SystemException("刷取後的刻字資料錯誤，請洽系統開發室確認!");

                                #region //判斷刻字資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 MoItemPartSortNumber, MoItemPartNo
                                        FROM MES.MoItemPart
                                        WHERE MoItemPartId = @MoItemPartId
                                        AND MoId = @MoId";
                                dynamicParameters.Add("MoItemPartId", item["ItemValue"].ToString());
                                dynamicParameters.Add("MoId", MoId);

                                var result2 = sqlConnection.Query(sql, dynamicParameters);
                                if (result2.Count() <= 0) throw new SystemException("刻字資料錯誤!");

                                foreach (var item2 in result2)
                                {
                                    ItemSeq = item2.MoItemPartSortNumber;
                                    MoItemPartNo = item2.MoItemPartNo;
                                    item["ItemValue"] = MoItemPartNo;
                                }
                                #endregion
                            }

                            #region //判斷Type資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TypeName
                                    FROM BAS.[Type] a
                                    WHERE a.TypeSchema = 'RoutingProcessItem.ItemNo'
                                    AND a.TypeNo = @TypeNo";
                            dynamicParameters.Add("TypeNo", item["ItemNo"].ToString());

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("屬性設定資料錯誤!");

                            string TypeName = "";
                            foreach (var item2 in result3)
                            {
                                TypeName = item2.TypeName;
                            }
                            #endregion

                            #region //判斷此屬性是否已被綁定
                            if (item["ChkUnique"].ToString() == "Y")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeAttrId, a.ItemNo
                                        FROM MES.BarcodeAttribute a
                                        WHERE a.ItemValue = @ItemValue
                                        AND a.MoId = @MoId";
                                dynamicParameters.Add("ItemValue", item["ItemValue"].ToString());
                                dynamicParameters.Add("MoId", MoId);

                                var result4 = sqlConnection.Query(sql, dynamicParameters);
                                if (result4.Count() > 0)
                                {
                                    foreach (var item2 in result4)
                                    {
                                        if (item2.ItemNo != "Lettering") throw new SystemException("屬性【" + TypeName + "】重複，無法新增!");

                                        #region //同製令情況，UPDATE原綁定此刻字之BarcodeAttribute
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.BarcodeAttribute
                                                SET BarcodeId = @BarcodeId
                                                WHERE BarcodeAttrId = @BarcodeAttrId";
                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeId,
                                            item2.BarcodeAttrId
                                        });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        LetteringBool = true;
                                    }
                                }
                            }
                            #endregion

                            #region //檢查DateCode日期是否大於今天日期
                            DateTime dateCode = DateTime.Parse(item["DateCode"].ToString());
                            DateTime today = DateTime.Now;

                            if (dateCode > today) throw new SystemException("屬性日期不能大於今天日期!!");
                            #endregion

                            #region //INSERT MES.BarcodeProcessAttribute
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeProcessAttribute (BarcodeProcessId, ItemNo, ItemValue, ItemSeq
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.ProcessAttrId
                                    VALUES (@BarcodeProcessId, @ItemNo, @ItemValue, @ItemSeq
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeProcessId = Convert.ToInt32(item["BarcodeProcessId"]),
                                    ItemNo = item["ItemNo"].ToString(),
                                    ItemValue = item["ItemValue"].ToString(),
                                    ItemSeq = ItemSeq != -1 ? ItemSeq : (int?)null,
                                    DateCode = item["DateCode"].ToString(),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion

                            if (LetteringBool == false)
                            {
                                #region //檢查此條碼是否已綁定過相同製程相同屬性之資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 a.BarcodeAttrId
                                        FROM MES.BarcodeAttribute a
                                        WHERE a.BarcodeId = @BarcodeId
                                        AND a.ItemNo = @ItemNo
                                        ORDER BY a.CreateDate DESC";
                                dynamicParameters.Add("BarcodeId", BarcodeId);
                                dynamicParameters.Add("ItemNo", item["ItemNo"].ToString());

                                var BarcodeAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                if (BarcodeAttributeResult.Count() > 0)
                                {
                                    foreach (var item2 in BarcodeAttributeResult)
                                    {
                                        #region //UPDATE MES.BarcodeAttribute
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.BarcodeAttribute SET
                                                MoId = @MoId,
                                                ItemValue = @ItemValue,
                                                ItemSeq = @ItemSeq,
                                                DateCode = @DateCode
                                                WHERE BarcodeAttrId = @BarcodeAttrId";
                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MoId,
                                            ItemValue = item["ItemValue"].ToString(),
                                            ItemSeq = ItemSeq != -1 ? ItemSeq : (int?)null,
                                            DateCode = item["DateCode"].ToString(),
                                            item2.BarcodeAttrId
                                        });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                                else
                                {
                                    #region //INSERT MES.BarcodeAttribute
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodeAttribute (MoId, BarcodeId, ItemNo, ItemValue, ItemSeq, DateCode
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.BarcodeAttrId
                                            VALUES (@MoId, @BarcodeId, @ItemNo, @ItemValue, @ItemSeq, @DateCode
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MoId,
                                            BarcodeId,
                                            ItemNo = item["ItemNo"].ToString(),
                                            ItemValue = item["ItemValue"].ToString(),
                                            ItemSeq = ItemSeq != -1 ? ItemSeq : (int?)null,
                                            DateCode = item["DateCode"].ToString(),
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion
                                }
                                #endregion
                            }
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion 

        #region //AddJigBarcode-- 新增製令治具 -- Ann 2022-10-31
        public string AddJigBarcode(int JigId, string JigNo, string BarcodeNo, int MoProcessId, int MachineId)
        {
            try
            {
                int UserId = CreateBy;
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int JigLimit = -1;
                        if (JigId <= 0)
                        {
                            JigNo = JigNo.ToUpper(); //強制轉成大寫
                            #region //判斷治具資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 JigId, JigLimit
                                    FROM MES.Jig
                                    WHERE JigNo = @JigNo";
                            dynamicParameters.Add("JigNo", JigNo);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("治具資料有誤!");

                            foreach (var item in result)
                            {
                                JigId = item.JigId;
                                JigLimit = item.JigLimit;
                            }
                            #endregion
                        }
                        else
                        {
                            #region //判斷治具資料是否有誤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 JigLimit
                                    FROM MES.Jig
                                    WHERE JigId = @JigId";
                            dynamicParameters.Add("JigId", JigId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("治具資料有誤!");

                            foreach (var item in result)
                            {
                                JigLimit = item.JigLimit;
                            }
                            #endregion
                        }

                        int n;
                        int MoId = -1;
                        bool isNumeric = int.TryParse(BarcodeNo, out n);

                        #region //找MOID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId
                                    FROM MES.MoProcess a
                                    WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var moProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (moProcessResult.Count() <= 0) throw new SystemException("查無此製令製程資訊!");

                        foreach (var item in moProcessResult)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        if (isNumeric == true)
                        {
                            #region //判斷是否為刻字過站
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT d.BarcodeNo
                                    FROM MES.MoItemPart a
                                    INNER JOIN MES.BarcodeProcessAttribute b ON a.MoItemPartNo = b.ItemValue AND b.ItemNo = 'Lettering'
                                    INNER JOIN MES.BarcodeProcess c ON c.BarcodeProcessId = b.BarcodeProcessId
                                    INNER JOIN MES.Barcode d ON c.BarcodeId = d.BarcodeId
                                    WHERE a.MoItemPartId = @MoItemPartId
                                    AND a.MoId = @MoId";

                            dynamicParameters.Add("MoItemPartId", BarcodeNo);
                            dynamicParameters.Add("MoId", MoId);
                            var AttributeResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in AttributeResult)
                            {
                                BarcodeNo = item.BarcodeNo;
                            }
                            #endregion
                        }

                        #region //確認是否為Tray模式
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TrayBarcode, a.Source
                                FROM MES.MoSetting a
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);
                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                        string TrayBarcode = "";
                        string Source = "";
                        foreach (var item in MoSettingResult)
                        {
                            TrayBarcode = item.TrayBarcode;
                            Source = item.Source;
                        }

                        if (TrayBarcode == "Y" && Source == "MR")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo, a.TrayNo
                                    FROM MES.Tray a
                                    WHERE a.TrayNo = @TrayNo";
                            dynamicParameters.Add("TrayNo", BarcodeNo);

                            var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TrayResult.Count() < 0) throw new SystemException("查無此Tray盤資訊!");

                            string TrayNo = "";
                            foreach (var item in TrayResult)
                            {
                                if (item.BarcodeNo == null) throw new SystemException("此Tray盤尚未綁定條碼!");
                                TrayNo = item.TrayNo;
                                BarcodeNo = item.BarcodeNo;
                            }
                        }
                        #endregion

                        #region //檢查此條碼是否已經綁定治具
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.JigBarcode
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        if (result4.Count() > 0) throw new SystemException("此條碼已綁定治具!");
                        #endregion

                        #region //檢查此治具是否已達最大條碼數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT COUNT(1) Count
                                FROM MES.JigBarcode a
                                WHERE a.JigId = @JigId AND a.BarcodeNo IS NOT NULL";
                        dynamicParameters.Add("JigId", JigId);

                        var result5 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result5)
                        {
                            if (item.Count + 1 > JigLimit) throw new SystemException("此治具可容納條碼數量已滿!");
                        }
                        #endregion

                        #region //檢查製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ProcessAlias
                                FROM MES.MoProcess a
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result6 = sqlConnection.Query(sql, dynamicParameters);
                        if (result6.Count() <= 0) throw new SystemException("製令製程資料有誤!");

                        string ProcessAlias = "";
                        foreach (var item in result6)
                        {
                            ProcessAlias = item.ProcessAlias;
                        }
                        #endregion

                        #region //檢查綁定製程是否相同
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.ProcessId JigBarcodeProcessId
                                , c.ProcessId CurrentProcessId
                                , d.ProcessName
                                , e.WoSeq
                                , f.WoErpPrefix, f.WoErpNo
                                FROM MES.JigBarcode a
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                INNER JOIN MES.MoProcess c ON c.MoProcessId = @MoProcessId
                                INNER JOIN MES.Process d ON b.ProcessId = d.ProcessId
                                INNER JOIN MES.ManufactureOrder e ON b.MoId = e.MoId
                                INNER JOIN MES.WipOrder f ON e.WoId = f.WoId
                                WHERE a.JigId = @JigId";
                        dynamicParameters.Add("JigId", JigId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result7 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result7)
                        {
                            if (item.JigBarcodeProcessId != item.CurrentProcessId) throw new SystemException("此治具已綁定在製令【" + item.WoErpPrefix + "-" + item.WoErpNo + "(" + item.WoSeq + ")" + "】【" + item.ProcessName + "】站別!");
                        }
                        #endregion

                        #region //確認機台資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Machine a
                                WHERE a.MachineId = @MachineId";
                        dynamicParameters.Add("MachineId", MachineId);

                        var MachineResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MachineResult.Count() <= 0) throw new SystemException("機台資料錯誤!!");
                        #endregion

                        #region //確認此治具是否可以在此機台上加工
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MachineJig a
                                WHERE a.JigId = @JigId";
                        dynamicParameters.Add("JigId", JigId);

                        var MachineJigResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MachineJigResult.Count() <= 0) throw new SystemException("此治具不可在此機台加工!!");
                        #endregion

                        #region //default 過站邏輯驗證 預設參數
                        Boolean NewBarcode = false;
                        Boolean bInput = true; //條碼目前狀態 加工中 或 完工  
                        string LotStatus = "N";//製令是否為批量製令
                        string sAutoCompleted = "N";//該站是否自動完工
                        string BarcodeCtrl = "N"; //判斷數量過站

                        int BarcodeId = -1;
                        int BarcodeProcessId = -1;
                        int CurrentMoProcessId = -1;//條碼目前的站別
                        int CurrentSortNumber = 0; //條碼當前製程序號, 預設第一站
                        int ProcessSortNumber = 0; //登入站別MoProcess的SortNumber
                        int NextMoProcessId = -1;//條碼下一站
                        int NextSortNumber = -1;//下一站製程序號
                        int BarcodeQty = -1;
                        int ModeId = -1; //生產模式
                        int ModeShiftId = -1; //班別
                        int FirstMoProcessId = -1; //首站MoProcessId
                        string ProcessCheckStatus = ""; //是否需做工程檢
                        string ProcessCheckType = ""; //若要工程檢, 抽檢或全檢
                        string FirstProcessAlias = ""; //首站Alias Name
                        string BarcodeStatus = "1";
                        string CurrentProcessAlias = "", NextProcessAlias = "";
                        string CurrentProdStatus = "";
                        Boolean JumpFlag = false;
                        #endregion

                        #region //Validation & Get Data 過站邏輯驗證

                        #region //取得MoId
                        dynamicParameters = new DynamicParameters();

                        sql = @"SELECT MoId, SortNumber
                          FROM MES.MoProcess
                         WHERE MoProcessId = @MoProcessId";

                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var MoResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MoResult.Count() > 0)
                        {
                            MoId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoId);
                            ProcessSortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);
                        }
                        #endregion

                        #region //檢核條碼是否在此製程有委外, 若委外需使用託外收貨
                        dynamicParameters = new DynamicParameters();

                        sql = @"SELECT a.OspNo
                          FROM MES.OutsourcingProduction a
                               INNER JOIN MES.OspDetail b ON a.OspId = b.OspId
	                           INNER JOIN MES.OspBarcode c ON b.OspDetailId = c.OspDetailId
                         WHERE c.BarcodeNo = @BarcodeNo
                           AND b.MoProcessId = @MoProcessId";

                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var OspResult = sqlConnection.Query(sql, dynamicParameters);
                        if (OspResult.Count() > 0)
                        {
                            string OspNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).OspNo;
                            throw new SystemException("此條碼當站已託外生產, 託外單號為:" + OspNo);
                        }
                        #endregion

                        #region //MO Validation & get MO Informations
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MoProcessId,b.ProcessId,b.MoProcessId,
                                       c.PostCollectionStatus,c.PreCollectionStatus,
                                       c.PassingMode,c.NgToBarcode,
                                       d.BarcodeCtrl,e.LotStatus,f.FirstMoProcessId,f.FirstProcessAlias,
                                       a.ModeId
                                  FROM MES.ManufactureOrder a
                                       INNER JOIN MES.MoProcess b ON a.MoId=b.MoId
                                       INNER JOIN MES.ProcessParameter c ON b.ProcessId=c.ProcessId and a.ModeId = c.ModeId
                                       INNER JOIN MES.ProdMode d ON a.ModeId=d.ModeId
                                       LEFT JOIN MES.MoSetting e ON a.MoId=e.MoId
                                       LEFT JOIN (SELECT x.MoProcessId FirstMoProcessId,x.ProcessAlias FirstProcessAlias,x.MoId 
                                                    FROM MES.MoProcess x  
                                                   WHERE x.SortNumber = 1) f ON f.MoId = a.MoId
                                 WHERE a.MoId = @MoId
                                   AND b.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var MoResult1 = sqlConnection.Query(sql, dynamicParameters);
                        if (MoResult1.Count() <= 0) throw new SystemException("製令相關資訊不存在!");
                        foreach (var item in MoResult1)
                        {
                            sAutoCompleted = item.PassingMode;
                            BarcodeCtrl = item.BarcodeCtrl; //Y代表為條碼過站, N代表無法用條碼過站(模造使用)
                            LotStatus = item.LotStatus; //是否批量製令
                            FirstMoProcessId = item.FirstMoProcessId;
                            FirstProcessAlias = item.FirstProcessAlias;
                            ModeId = item.ModeId;
                        }
                        #endregion

                        #region //發料檢核
                        dynamicParameters = new DynamicParameters();
                        if (LotStatus.Equals("N") && BarcodeCtrl.Equals("Y"))
                        {
                            sql = @"SELECT a.BarcodeRegisterId,a.BarcodeNo,b.WoErpPrefix,b.WoErpNo
                                      FROM MES.MrBarcodeRegister a
                                           INNER JOIN MES.MrDetail b ON a.MrDetailId=b.MrDetailId
                                     WHERE a.BarcodeNo = @BarcodeNo
                                       AND b.MoId = @MoId";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("MoId", MoId);

                            var BarcodeMtlResult = sqlConnection.Query(sql, dynamicParameters);
                            if (BarcodeMtlResult.Count() <= 0) throw new SystemException("該條碼【" + BarcodeNo + "】找不到發料資料!");
                            BarcodeQty = 1; //By PCS生產
                        }
                        else if (LotStatus.Equals("Y") && BarcodeCtrl.Equals("Y"))
                        {
                            sql = @"SELECT a.PrintId,c.MoId,a.BarcodeNo,BarcodeQty
                                      FROM MES.BarcodePrint a
                                           INNER JOIN MES.MoSetting b ON a.MoSettingId=b.MoSettingId
                                           INNER JOIN MES.ManufactureOrder c ON b.MoId=c.MoId
                                 WHERE a.BarcodeNo = @BarcodeNo
                                   AND c.MoId = @MoId";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("MoId", MoId);

                            var BarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);
                            if (BarcodePrintResult.Count() <= 0) throw new SystemException("該條碼【" + BarcodeNo + "】不在製令條碼標籤設定!");
                            foreach (var item in BarcodePrintResult)
                            {
                                BarcodeQty = Convert.ToInt32(item.BarcodeQty);
                            }
                        }
                        else if (BarcodeCtrl.Equals("N")) //模造等數量發料檢查
                        {
                            //是否檢核ERP有沒有發料, 再與User討論
                        }
                        else
                        {
                            throw new SystemException("發料檢查例外狀況!");
                        }


                        #endregion

                        #region //Barcode Validation & get Barcode Informations
                        if (BarcodeCtrl.Equals("Y"))
                        {
                            #region //條碼控管模式

                            #region //判斷條碼目前是否在品異單
                            sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                    FROM QMS.AqBarcode a
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    INNER JOIN QMS.Abnormalquality c ON a.AbnormalqualityId = c.AbnormalqualityId AND b.MoId = c.MoId
                                    WHERE b.BarcodeNo = @BarcodeNo
                                    Order By a.LastModifiedDate DESC
                                ";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                if (JudgeStatus == null)
                                {
                                    throw new SystemException("該條碼【" + BarcodeNo + "】目前在品異單判定中，不可以輸入");
                                }
                                else if (JudgeStatus == "S")
                                {
                                    throw new SystemException("該條碼【" + BarcodeNo + "】目前判定不良品，不可以輸入");
                                }
                            }
                            #endregion

                            #region //條碼製程檢核與取出條碼相關資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId,a.CurrentMoProcessId,a.NextMoProcessId,a.BarcodeQty,a.BarcodeProcessId,
                                       b.SortNumber CurrentSortNumber, ISNULL(c.SortNumber,1) NextSortNumber,
                                       a.BarcodeStatus,a.CurrentProdStatus,
                                       b.ProcessAlias CurrentProcessAlias, ISNULL(c.ProcessAlias,'') NextProcessAlias 
                                  FROM MES.Barcode a
                                       LEFT JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
                                       LEFT JOIN MES.MoProcess c ON a.NextMoProcessId = c.MoProcessId
                                       LEFT JOIN MES.ProcessParameter d ON b.ProcessId = d.ProcessId AND d.ModeId = @ModeId
                                 WHERE a.BarcodeNo = @BarcodeNo";

                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("ModeId", ModeId);

                            var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (BarcodeResult.Count() > 0) //有找到Barcode
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.BarcodeProcessId,b.MoProcessId
                                      FROM MES.Barcode a
                                           LEFT JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId
                                     WHERE a.BarcodeNo = @BarcodeNo 
                                       AND b.MoProcessId = a.CurrentMoProcessId
                                       AND b.FinishDate IS NULL ";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                if (BarcodeProcessResult.Count() > 0) //找到BarcodeProcess, 代表已有開工資料
                                {
                                    bInput = false;
                                    foreach (var item in BarcodeProcessResult)
                                    {
                                        BarcodeProcessId = Convert.ToInt32(item.BarcodeProcessId);
                                    }
                                }

                                foreach (var item in BarcodeResult)
                                {
                                    NewBarcode = false;
                                    BarcodeId = Convert.ToInt32(item.BarcodeId);
                                    CurrentMoProcessId = Convert.ToInt32(item.CurrentMoProcessId);
                                    NextMoProcessId = Convert.ToInt32(item.NextMoProcessId);
                                    CurrentSortNumber = Convert.ToInt32(item.CurrentSortNumber);
                                    NextSortNumber = Convert.ToInt32(item.NextSortNumber);
                                    CurrentProcessAlias = item.CurrentProcessAlias.ToString();
                                    NextProcessAlias = item.NextProcessAlias.ToString();
                                    BarcodeStatus = item.BarcodeStatus.ToString();
                                    CurrentProdStatus = item.CurrentProdStatus.ToString();

                                    if (!BarcodeStatus.Equals("1")) throw new SystemException("條碼狀態非生產中!");

                                    #region //判斷該條碼品異單是否有指定返回製程

                                    #endregion

                                    if (bInput)
                                    {
                                        //如果MoProcessId != NextMoProcessId, 再判斷是否可以跳至此站別
                                        if (!MoProcessId.Equals(NextMoProcessId))
                                        {
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT 1 
                                                  FROM MES.MoProcess a
                                                 WHERE a.SortNumber > @CurrentSortNumber 
                                                   AND a.SortNumber < (SELECT a1.SortNumber
                                                                         FROM MES.MoProcess a1
                                                                        WHERE a1.MoProcessId = @MoProcessId)
                                                   AND a.NecessityStatus = 'Y'
                                                   AND a.MoId = @MoId";
                                            dynamicParameters.Add("CurrentSortNumber", CurrentSortNumber);
                                            dynamicParameters.Add("MoProcessId", MoProcessId);
                                            dynamicParameters.Add("MoId", MoId);
                                            var ProcessJumpResult = sqlConnection.Query(sql, dynamicParameters);
                                            if (ProcessJumpResult.Count() > 0)
                                            {
                                                JumpFlag = false;
                                            }
                                            else
                                            {
                                                if (ProcessSortNumber - CurrentSortNumber > 1)
                                                {
                                                    JumpFlag = true;
                                                }
                                                else
                                                {
                                                    JumpFlag = false;
                                                }
                                            }

                                            if (!JumpFlag)
                                            {
                                                throw new SystemException("條碼製程應為【" + NextProcessAlias + "】");
                                            }

                                            if (!MoProcessId.Equals(NextMoProcessId) && !JumpFlag) throw new SystemException("該條碼製程為【" + NextProcessAlias + "】");

                                            if (!MoProcessId.Equals(NextMoProcessId) && CurrentSortNumber.Equals(NextSortNumber)) throw new SystemException("該條碼製程為【" + NextProcessAlias + "】");

                                            if (MoProcessId.Equals(CurrentMoProcessId)) throw new SystemException("該條碼製程為【" + NextProcessAlias + "】");

                                        }
                                    }
                                    else
                                    {
                                        //完工應該一律檢查MoProcessId 是不是等於目前條碼Next即可
                                        if (!MoProcessId.Equals(CurrentMoProcessId))
                                        {

                                            throw new SystemException("條碼製程應為【" + CurrentProcessAlias + "】!");
                                        }
                                    }
                                }

                            }
                            else //找不到Barcode
                            {
                                NewBarcode = true;
                                if (!MoProcessId.Equals(FirstMoProcessId)) throw new SystemException("製程錯誤, 應做首站製程!");
                                bInput = true;
                            }

                            if (!bInput)
                            {
                                #region //抓取NextMoProcessId, 以品異單返回為優先
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.AbnormalqualityNo,b.JudgeReturnMoProcessId,b.JudgeReturnNextMoProcessId,
                                       a.MoProcessId
                                  FROM QMS.Abnormalquality a
                                       INNER JOIN QMS.AqBarcode b ON a.AbnormalqualityId = b.AbnormalqualityId
	                                   INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                                 WHERE a.AbnormalqualityId = b.AbnormalqualityId
                                   AND b.CreateDate = (SELECT MAX(b2.CreateDate)
                                                         FROM QMS.AqBarcode b2
						                                WHERE b.BarcodeId = b2.BarcodeId)
                                   AND b.JudgeReturnMoProcessId = @MoProcessId
                                   AND c.BarcodeNo = @BarcodeNo
                                   AND b.JudgeStatus = 'RW'
                                   AND c.CurrentProdStatus = 'P'";

                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                var AqBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                if (AqBarcodeResult.Count() > 0)
                                {
                                    NextMoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeReturnNextMoProcessId);
                                }
                                else
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MoProcessId
                                      FROM MES.MoProcess a
                                     WHERE a.MoId = @MoId
                                       AND a.SortNumber = (SELECT MIN(a1.SortNumber)
                                                             FROM MES.MoProcess a1
						                                    WHERE a.MoId = a1.MoId
						                                      AND a1.SortNumber > (SELECT a2.SortNumber 
						                                                             FROM MES.MoProcess a2 
												                                    WHERE a2.MoProcessId = @MoProcessId))";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("MoProcessId", MoProcessId);
                                    var NextProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item in NextProcessResult)
                                    {
                                        NextMoProcessId = Convert.ToInt32(item.MoProcessId);
                                    }
                                }
                                #endregion

                            }
                            #endregion

                            #region //判斷BarcodeProcess裡此MoProcess裡有沒有CurrentProdStatus = 'F','SR','RW'
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT 1
                              FROM MES.MoProcess a
                                   INNER JOIN MES.BarcodeProcess b ON a.MoProcessId = b.MoProcessId
                                   INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                             WHERE a.MoProcessId = @MoProcessId
                               AND c.CurrentProdStatus IN ('F','SR','RW')";

                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var CurrentProdStatusCheck = sqlConnection.Query(sql, dynamicParameters);
                            if (CurrentProdStatusCheck.Count() > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT 1
                                  FROM MES.Barcode a                                   
                                 WHERE a.NextMoProcessId = @MoProcessId
                                   AND a.CurrentProdStatus IN ('SR','RW','P')
                                   AND a.BarcodeNo = @BarcodeNo";

                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                var BarcodeProdStatus = sqlConnection.Query(sql, dynamicParameters);
                                if (BarcodeProdStatus.Count() == 0)
                                {
                                    throw new SystemException("此製程存在不良品未處理結束, 不可繼續加工!");
                                }
                            }
                            #endregion

                            #endregion
                        }

                        #endregion

                        #region //確認是否有做工程檢, 確認是否有做製程屬性資料維護(穴號/刻字)
                        #region //取得MoId

                        #region //先用MoProcessId 找出RoutingProcessId
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT e.RoutingProcessId
                        //              FROM MES.ManufactureOrder a
                        //                   INNER JOIN MES.MoRouting b ON a.MoId = b.MoId
                        //                INNER JOIN MES.MoProcess c ON a.MoId = c.MoId
                        //                INNER JOIN MES.RoutingItem d ON b.RoutingItemId = d.RoutingItemId
                        //                INNER JOIN MES.RoutingProcess e ON d.RoutingId = e.RoutingId AND c.ProcessId = e.ProcessId
                        //             WHERE c.MoProcessId = @CurrentMoProcessId";
                        //dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                        //var RoutingProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        //if (RoutingProcessResult.Count() <= 0) throw new SystemException("工程檢製程找不到途程設定!!!");
                        //int RoutingProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).RoutingProcessId);

                        #endregion

                        dynamicParameters = new DynamicParameters();

                        sql = @"SELECT ProcessCheckStatus, ProcessCheckType
                          FROM MES.MoProcess
                         WHERE MoProcessId = @CurrentMoProcessId";

                        dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                        var ProcessCheckResult = sqlConnection.Query(sql, dynamicParameters);
                        if (ProcessCheckResult.Count() > 0)
                        {
                            ProcessCheckStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessCheckStatus;
                            ProcessCheckType = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessCheckType;
                        }
                        #endregion

                        //MoProcess.ProcessCheckStatus = 'Y'才要檢核, 檢核後需判斷ProcessCheckType 1(全檢),2(抽檢)
                        if (BarcodeCtrl.Equals("Y") && bInput && !FirstMoProcessId.Equals(MoProcessId))
                        {
                            #region //前置程需做工程檢, 所以要檢核前置程工程檢結果
                            if (ProcessCheckStatus.Equals("Y")) //前置程需做工程檢, 所以要檢核前置程工程檢結果
                            {
                                if (ProcessCheckType.Equals("1"))
                                {
                                    //全檢檢核
                                    #region //檢核工程檢資訊, 如果找不到前置程工程檢為Pass or 品異單放行則報錯
                                    //找出此Barcode最後一次完工FinishDate is not null的BarcodeProcessId, 看有沒有做工程檢
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.QcNoticeId,a.ResetFlag,ISNULL(b.QcStatus,'N') QcStatus,
                                           ISNULL(c.QcStatus,'N') BarcodeQcStatus,
                                           ISNULL(e.JudgeStatus,'N') JudgeStatus
                                      FROM QMS.QcNotice a
                                           LEFT JOIN MES.QcRecord b ON a.QcNoticeId = b.QcNoticeId
	                                       LEFT JOIN MES.QcBarcode c ON b.QcRecordId = c.QcRecordId
	                                       LEFT JOIN MES.Barcode d ON c.BarcodeId = d.BarcodeId
	                                       LEFT JOIN QMS.AqBarcode e ON c.QcBarcodeId = e.QcBarcodeId
                                     WHERE a.RoutingProcessId = @RoutingProcessId
                                       AND d.BarcodeNo = @BarcodeNo
                                       AND a.QcNoticeType = 'IPQC'
                                       AND a.Status != 'C'";
                                    /* AND b.CreateDate = (SELECT MAX(b1.CreateDate)
                                    FROM MES.QcRecord b1
                                    WHERE b1.QcNoticeId = b.QcNoticeId)*/

                                    //dynamicParameters.Add("RoutingProcessId", RoutingProcessId);
                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                    var QcStatusResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (QcStatusResult.Count() == 0)
                                    {
                                        throw new SystemException("前置程【" + CurrentProcessAlias + "】未設定工程檢送測通知單或此條碼未量測,此製程不可加工!");
                                    }
                                    else
                                    {
                                        if (sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeQcStatus != "P")
                                        {
                                            if (sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeQcStatus == "N") throw new SystemException("工程檢尚未量測!!!");

                                            string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                            if (!JudgeStatus.Equals("R") && !JudgeStatus.Equals("M")) //品異特採與誤判視同良品
                                            {
                                                throw new SystemException("前置程【" + CurrentProcessAlias + "】量測結果不是良品, 不可過站!");
                                            }
                                        }

                                        #region //若有送測通知單, 且此站條碼皆已過站, 則更新送測通知單狀態為C(Completed)
                                        //無法判斷, 做在完全入庫後再更新這種通知單再關閉即可
                                        #endregion
                                    }
                                    #endregion
                                }
                                else
                                {
                                    //抽檢檢核
                                    #region //檢核工程檢資訊, 如果找不到前置程工程檢為Pass or 品異單放行則報錯

                                    //找出此Barcode最後一次完工FinishDate is not null的BarcodeProcessId, 看有沒有做工程檢
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.QcNoticeId,a.ResetFlag,ISNULL(b.QcStatus,'N') QcStatus,
                                           ISNULL(c.QcStatus,'N') BarcodeQcStatus,
                                           ISNULL(e.JudgeStatus,'N') JudgeStatus
                                      FROM QMS.QcNotice a
                                           LEFT JOIN MES.QcRecord b ON a.QcNoticeId = b.QcNoticeId
	                                                                AND b.CreateDate = (SELECT MAX(b1.CreateDate)
								                                                          FROM MES.QcRecord b1
													                                     WHERE b1.QcNoticeId = b.QcNoticeId)
	                                       LEFT JOIN MES.QcBarcode c ON b.QcRecordId = c.QcRecordId
	                                       LEFT JOIN MES.Barcode d ON c.BarcodeId = d.BarcodeId
	                                       LEFT JOIN QMS.AqBarcode e ON c.QcBarcodeId = e.QcBarcodeId
                                     WHERE a.RoutingProcessId = @RoutingProcessId
                                       AND a.QcNoticeType = 'IPQC'
                                       AND a.Status != 'C'";

                                    //dynamicParameters.Add("RoutingProcessId", RoutingProcessId);
                                    var QcStatusResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (QcStatusResult.Count() == 0)
                                    {
                                        throw new SystemException("前置程【" + CurrentProcessAlias + "】未設定工程檢送測通知單或此條碼未量測,此製程不可加工!");
                                    }
                                    else
                                    {
                                        int QcNoticeId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).QcNoticeId);
                                        string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                        string ResetFlag = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ResetFlag;

                                        if (sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeQcStatus == "N") throw new SystemException("工程檢尚未量測!!!");

                                        if (sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeQcStatus != "P")
                                        {
                                            if (!JudgeStatus.Equals("R") && !JudgeStatus.Equals("M")) //品異特採與誤判視同良品
                                            {
                                                throw new SystemException("前置程【" + CurrentProcessAlias + "】量測結果不是良品, 不可過站!");
                                            }
                                        }

                                        #region //若有送測通知單, 則更新送測通知單狀態為C(Completed)
                                        if (ResetFlag.Equals("Y"))
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"UPDATE QMS.QcNotice 
                                               SET Status = 'C',
                                               LastModifiedDate = @LastModifiedDate,
                                               LastModifiedBy = @LastModifiedBy
                                             WHERE QcNoticeId = @QcNoticeId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    QcNoticeId,
                                                    LastModifiedDate = DateTime.Now,
                                                    LastModifiedBy
                                                });
                                            int UpdateQcNotice = sqlConnection.Execute(sql, dynamicParameters);

                                        }
                                        #endregion
                                    }
                                    #endregion
                                }
                            }
                            #endregion

                            #region //確認前置程是否有設定製程屬性
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT g.ItemNo,h.TypeDesc
                                      FROM MES.WipOrder a
                                           LEFT JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
	                                       LEFT JOIN MES.MoProcess c ON b.MoId = c.MoId
	                                       LEFT JOIN MES.MoRouting d ON b.MoId = d.MoId
	                                       LEFT JOIN MES.RoutingItem e ON d.RoutingItemId = e.RoutingItemId
	                                       LEFT JOIN MES.RoutingProcess f ON f.RoutingId = e.RoutingId 
	                                                                      AND c.ProcessId = f.ProcessId
									                                      AND c.SortNumber = f.SortNumber
                                           INNER JOIN MES.RoutingProcessItem g ON f.RoutingProcessId = g.RoutingProcessId
	                                       INNER JOIN BAS.[Type] h ON g.ItemNo = h.TypeNo AND h.TypeSchema = 'RoutingProcessItem.ItemNo'
                                     WHERE c.MoProcessId = @CurrentMoProcessId";

                            dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                            var ProcessAttributeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (ProcessAttributeResult.Count() > 0)
                            {
                                string AttributeItemNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ItemNo;
                                string AttributeItemName = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TypeDesc;

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT c.BarcodeNo
                                          FROM MES.BarcodeProcess a
                                               INNER JOIN MES.BarcodeProcessAttribute b ON a.BarcodeProcessId = b.BarcodeProcessId
	                                           INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                         WHERE a.MoProcessId = @CurrentMoProcessId
                                           AND c.BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                var BarcodeProcessItemAttributeResult = sqlConnection.Query(sql, dynamicParameters);
                                if (BarcodeProcessItemAttributeResult.Count() == 0) throw new SystemException("條碼前製程需維護【" + AttributeItemName + "】尚未維護!");
                            }
                            #endregion

                        }

                        #endregion

                        #region //取出班別ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ModeShiftId
                                  FROM MES.ProdModeShift a
                                       INNER JOIN BAS.[Shift] b ON a.ShiftId = b.ShiftId
                                WHERE a.ModeId = @ModeId
                                AND ((format(CONVERT(datetime,CONVERT(VARCHAR(10),CONVERT(DATE,GETDATE()),120) + ' ' + @CurrentTime),'HH:mm') between b.WorkBeginTime and b.WorkEndTime) or
                                     (format(dateadd(hour,12,CONVERT(datetime,CONVERT(VARCHAR(10),CONVERT(DATE,GETDATE()),120) + ' ' + @CurrentTime)),'HH:mm') between b.WorkBeginTime and b.WorkEndTime)
                                    )";
                        dynamicParameters.Add("ModeId", ModeId);
                        dynamicParameters.Add("CurrentTime", DateTime.Now.ToString("HH:mm"));

                        var resultShift = sqlConnection.Query(sql, dynamicParameters);
                        if (resultShift.Count() <= 0) throw new SystemException("找不到班別!");

                        foreach (var item in resultShift)
                        {
                            ModeShiftId = Convert.ToInt32(item.ModeShiftId);
                        }
                        #endregion

                        #endregion

                        #region //判斷此條碼加工狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                WHERE a.FinishDate IS NULL
                                AND b.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result8 = sqlConnection.Query(sql, dynamicParameters);
                        if (result8.Count() > 0) throw new SystemException("此條碼目前加工中，無法綁定!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.JigBarcode (JigId, BarcodeNo, MoProcessId, WorkingFlag
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.JigBarcodeId, INSERTED.JigId
                                VALUES (@JigId, @BarcodeNo, @MoProcessId, @WorkingFlag
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                JigId,
                                BarcodeNo,
                                MoProcessId,
                                WorkingFlag = "N",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult,
                            bInput
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddLotNgBarcodeProcess-- 新增批量NG條碼過站 -- Ann 2022-11-04
        public string AddLotNgBarcodeProcess(string BarcodeNo, string NgBarcodeNo, int NgBarcodeQty, string CauseId, int MoId, int MachineId, string CauseNo, int MoProcessId, string MinBarcodes)
        {
            try
            {
                int UserId = CreateBy;
                int rowsAffected = 0;
                string NgToBarcode = "";
                int BarcodeQty = -1;
                int CurrentMoProcessId = -1;
                int NextMoProcessId = -1;
                int ModeShiftId = -1;
                int LotBarcodeQty = -1;
                int BarcodeProcessId = -1;
                int StationQty = -1;
                int ScrapQty = 0;
                int WipQty = 0;
                string CurrentProdStatus = "F";
                string BarcodeStatus = "";
                int BarcodeId = -1;
                string OriCurrentProdStatus = "";
                string TrayBarcode = "";
                CauseNo = CauseNo.ToUpper();
                int LotQty = 0;
                int MoSettingId = 0;
                string BarcodePrefix = "";
                int SequenceLen = 0;
                string BarcodePostfix = "";
                string seq = "";
                string NewBarcodePrint = "";
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //取得製令用料設定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoSettingId, a.NgToBarcode, a.TrayBarcode, a.LotQty
                                , a.BarcodePrefix, a.SequenceLen, a.BarcodePostfix
                                FROM MES.MoSetting a
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MoSettingResult.Count() <= 0) throw new SystemException("找不到製令用料設定!");

                        foreach (var item in MoSettingResult)
                        {
                            NgToBarcode = item.NgToBarcode;
                            TrayBarcode = item.TrayBarcode;
                            LotQty = item.LotQty;
                            MoSettingId = item.MoSettingId;
                            BarcodePrefix = item.BarcodePrefix;
                            SequenceLen = item.SequenceLen;
                            BarcodePostfix = item.BarcodePostfix;
                        }
                        #endregion

                        #region //確認製令製程資料正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ProcessAlias, a.MoId
                                FROM MES.MoProcess a
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var moProcessIdResult = sqlConnection.Query(sql, dynamicParameters);
                        if (moProcessIdResult.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                        string ProcessAlias = "";
                        foreach (var item in moProcessIdResult)
                        {
                            ProcessAlias = item.ProcessAlias;
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //若需刷取NG條碼，則確認NG條碼資料
                        if (NgToBarcode.Equals("Y"))
                        {
                            #region //TrayBarcode Mode
                            if (TrayBarcode == "Y")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo
                                        FROM MES.Tray a 
                                        WHERE a.TrayNo = @TrayNo";
                                dynamicParameters.Add("TrayNo", NgBarcodeNo);

                                var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in TrayResult)
                                {
                                    if (item.BarcodeNo != null)
                                    {
                                        NgBarcodeNo = item.BarcodeNo;
                                    }
                                    else
                                    {
                                        #region //取得目前最大命名格式
                                        seq = GetNewBarcodeNo(BarcodePrefix, SequenceLen, BarcodePostfix);
                                        seq = seq.PadLeft(SequenceLen, '0');
                                        NewBarcodePrint = BarcodePrefix + seq + BarcodePostfix;
                                        #region //取得最大序列號條碼
                                        string GetNewBarcodeNo(string thisBarcodePrefix, int thisSequenceLen, string thisBarcodePostfix)
                                        {
                                            string NewBarcodeNo = "";
                                            #region //找此BARCODE格式最大號
                                            #region //組模糊查詢字串
                                            string SearchLikeStrig = "";
                                            for (int j = 1; j <= thisSequenceLen; j++)
                                            {
                                                SearchLikeStrig += "_";
                                            }
                                            #endregion

                                            string queryModal = "";
                                            if (thisBarcodePrefix.IndexOf("[") != -1)
                                            {
                                                char[] prefixList = thisBarcodePrefix.ToCharArray();

                                                for (int i = 0; i < prefixList.Length; i++)
                                                {
                                                    if (prefixList[i] == '[') queryModal += "|";
                                                    queryModal += prefixList[i];
                                                }

                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                        FROM MES.BarcodePrint
                                                        WHERE BarcodeNo LIKE '%" + queryModal + SearchLikeStrig + thisBarcodePostfix + "%' ESCAPE '|'";
                                            }
                                            else if (thisBarcodePostfix.IndexOf("[") != -1)
                                            {
                                                char[] postfixList = thisBarcodePostfix.ToCharArray();

                                                for (int i = 0; i < postfixList.Length; i++)
                                                {
                                                    if (postfixList[i] == '[') queryModal += "|";
                                                    queryModal += postfixList[i];
                                                }

                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                        FROM MES.BarcodePrint
                                                        WHERE BarcodeNo LIKE '%" + thisBarcodePrefix + SearchLikeStrig + queryModal + "%' ESCAPE '|'";
                                            }
                                            else
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                        FROM MES.BarcodePrint
                                                        WHERE BarcodeNo LIKE '" + thisBarcodePrefix + SearchLikeStrig + thisBarcodePostfix + "%'";
                                            }

                                            var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                            foreach (var item2 in BarcodeResult)
                                            {
                                                string MaxBarcodeNo = item2.MaxBarcodeNo;
                                                if (item2.MaxBarcodeNo == null)
                                                {
                                                    seq = "1".PadLeft(SequenceLen, '0');
                                                }
                                                else
                                                {
                                                    #region //拆解BarcodeNo順序
                                                    string thisSeq = "";
                                                    if (thisBarcodePostfix != "")
                                                    {
                                                        thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "").Replace(thisBarcodePostfix, "");
                                                    }
                                                    else
                                                    {
                                                        thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "");
                                                    }
                                                    seq = (Convert.ToInt32(thisSeq) + 1).ToString().PadLeft(SequenceLen, '0');
                                                    #endregion
                                                }

                                                NewBarcodeNo = thisBarcodePrefix + seq + thisBarcodePostfix;
                                            }
                                            #endregion

                                            return seq;
                                        }
                                        #endregion
                                        #endregion

                                        #region //新增MES.BarcodePrint F Barcode
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.BarcodePrint (BarcodeNo, BarcodeQty, MoSettingId, ParentBarcode, PrintCnt, PrintStatus
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.PrintId, INSERTED.BarcodeQty
                                                VALUES (@BarcodeNo, @BarcodeQty, @MoSettingId, @ParentBarcode, @PrintCnt, @PrintStatus
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";

                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeNo = NewBarcodePrint,
                                            BarcodeQty = 0,
                                            MoSettingId,
                                            ParentBarcode = "",
                                            PrintCnt = 0,
                                            PrintStatus = "F",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //Tray綁定Barcode
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Tray
                                                SET BarcodeNo = @BarcodeNo
                                                WHERE TrayNo = @TrayNo";
                                        dynamicParameters.Add("BarcodeNo", NewBarcodePrint);
                                        dynamicParameters.Add("TrayNo", NgBarcodeNo);

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        NgBarcodeNo = NewBarcodePrint;
                                    }
                                }
                            }
                            #endregion

                            #region //判斷NG條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeQty CurrentNgBarcodeQty
                                    , c.CurrentMoProcessId, c.NextMoProcessId, ISNULL(c.CurrentProdStatus, 'F') CurrentProdStatus
                                    , d.ProcessAlias
                                    FROM MES.BarcodePrint a
                                    INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                    LEFT JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo
                                    LEFT JOIN MES.MoProcess d ON c.CurrentMoProcessId = d.MoProcessId
                                    WHERE a.BarcodeNo = @BarcodeNo
                                    AND b.MoId = @MoId
                                    AND a.PrintStatus = 'F'";
                            dynamicParameters.Add("BarcodeNo", NgBarcodeNo);
                            dynamicParameters.Add("MoId", MoId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("NG條碼【" + NgBarcodeNo + "】資料有誤!");

                            int CurrentNgBarcodeQty = -1;
                            foreach (var item in result)
                            {
                                CurrentNgBarcodeQty = item.CurrentNgBarcodeQty;
                                if (item.CurrentMoProcessId != null && item.CurrentMoProcessId != MoProcessId) throw new SystemException("該NG條碼目前站別為【" + item.ProcessAlias + "】!");
                                if (item.CurrentProdStatus != "F") throw new SystemException("該條碼目前狀態非【不良品】，無法綁定NG數量!!");
                            }
                            #endregion
                        }
                        #endregion

                        #region //判斷NG原因是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM QMS.DefectCause a
                                WHERE a.CauseNo = @CauseNo";
                        dynamicParameters.Add("CauseNo", CauseNo);

                        var CauseResult = sqlConnection.Query(sql, dynamicParameters);

                        if (CauseResult.Count() <= 0) throw new SystemException("NG原因資料有誤!");
                        #endregion

                        #region //判斷機台資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Machine a
                                WHERE a.MachineId = @MachineId";
                        dynamicParameters.Add("MachineId", MachineId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        if (result2.Count() <= 0) throw new SystemException("機台資料有誤!");
                        #endregion

                        #region //確認原始批量條碼資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeQty, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeStatus, a.CurrentProdStatus OriCurrentProdStatus
                                , b.BarcodeProcessId, b.StationQty, b.ModeShiftId
                                , c.BarcodeQty LotBarcodeQty
                                      FROM MES.Barcode a
                                           INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                           INNER JOIN MES.BarcodePrint c ON a.BarcodeNo = c.BarcodeNo
                                     WHERE a.BarcodeNo = @BarcodeNo
                                UNION ALL
                                SELECT a.BarcodeId, a.BarcodeQty, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeStatus, a.CurrentProdStatus OriCurrentProdStatus
                                       , b.BarcodeProcessId, b.StationQty, b.ModeShiftId
                                       , c.BarcodeQty LotBarcodeQty
                                      FROM MES.Barcode a
                                           INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                           INNER JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo
                                     WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        if (result3.Count() <= 0) throw new SystemException("條碼【" + BarcodeNo + "】資訊有誤!");

                        foreach (var item in result3)
                        {
                            BarcodeId = item.BarcodeId;
                            BarcodeQty = item.BarcodeQty;
                            CurrentMoProcessId = item.CurrentMoProcessId;
                            NextMoProcessId = item.NextMoProcessId;
                            ModeShiftId = item.ModeShiftId;
                            LotBarcodeQty = item.LotBarcodeQty;
                            BarcodeProcessId = item.BarcodeProcessId;
                            StationQty = item.StationQty;
                            BarcodeStatus = item.BarcodeStatus;
                            OriCurrentProdStatus = item.OriCurrentProdStatus;

                            if (NgBarcodeQty > BarcodeQty) throw new SystemException("NG條碼數量不能大於原先條碼數量!");
                        }
                        #endregion

                        #region //INSERT OR UPDATE MES.Barcode

                        #region //若需刷NG條碼則使用NG條碼, 否則一站使用一張虛擬NG條碼
                        if (!NgToBarcode.Equals("Y"))
                        {
                            #region // 先判斷此製程有沒有未必庫的NG條碼, 如果有就延用, 如果沒有產生一筆新的
                            //1.先找出此製程有沒有NG碼
                            //2.如果有NG碼, 要判斷NG條碼是否已入庫
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.BarcodeNo,b.CurrentProdStatus,b.BarcodeStatus,
                                           SUM(a.StationQty) StationQty
                                      FROM MES.BarcodeProcess a
                                           INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                     WHERE a.MoProcessId = @MoProcessId
                                       AND b.CurrentProdStatus = 'S'
                                       GROUP BY b.BarcodeNo,b.CurrentProdStatus,b.BarcodeStatus
                                        ORDER BY b.BarcodeNo DESC";

                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            var NgBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if(NgBarcodeResult.Count() <= 0)
                            {
                                NgBarcodeNo = CurrentMoProcessId.ToString() + "NG001";
                            }
                            else
                            {
                                NgBarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;
                                //找看有沒有報廢未入庫的條碼
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT 1
                                          FROM MES.BarcodeProcess a
                                               INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                         WHERE a.MoProcessId = @MoProcessId
                                           AND b.CurrentProdStatus = 'S'
                                           AND b.BarcodeStatus = '0'
                                            ORDER BY b.CreateDate DESC";

                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                var Ng8BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                if(Ng8BarcodeResult.Count() <= 0)
                                {
                                    int NgSequence = Convert.ToInt32(NgBarcodeNo.Substring(NgBarcodeNo.Length - 3, 3)) + 1;
                                    NgBarcodeNo = NgBarcodeNo.Substring(0, NgBarcodeNo.Length - 3) + NgSequence.ToString().PadLeft(3, '0');
                                }
                            }

                            #endregion

                            
                            CurrentProdStatus = "S";
                        }
                        #endregion

                        #region //NG條碼流程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId NgBarcodeId, a.BarcodeQty
                                FROM MES.Barcode a
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", NgBarcodeNo);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);

                        int NgBarcodeId = -1;
                        if (result4.Count() <= 0)
                        {
                            #region //INSERT
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeId
                                    VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeNo = NgBarcodeNo,
                                    CurrentMoProcessId,
                                    NextMoProcessId = NgToBarcode.Equals("Y") ? NextMoProcessId : -1,
                                    MoId,
                                    BarcodeQty = NgBarcodeQty,
                                    BarcodeProcessId = -1,
                                    CurrentProdStatus = NgToBarcode.Equals("Y") ? "F" : "S",
                                    BarcodeStatus = NgToBarcode.Equals("Y") ? "1" : "0",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();

                            foreach (var item in insertResult)
                            {
                                NgBarcodeId = item.BarcodeId;
                            }
                            #endregion
                        }
                        else
                        {
                            #region //UPDATE
                            foreach (var item in result4)
                            {
                                NgBarcodeId = item.NgBarcodeId;

                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        CurrentMoProcessId = @CurrentMoProcessId,
                                        NextMoProcessId = @NextMoProcessId,
                                        MoId = @MoId,
                                        BarcodeQty = @BarcodeQty,
                                        CurrentProdStatus = @CurrentProdStatus,
                                        BarcodeStatus = @BarcodeStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        CurrentMoProcessId,
                                        NextMoProcessId,
                                        MoId,
                                        BarcodeQty = item.BarcodeQty + NgBarcodeQty,
                                        CurrentProdStatus = NgToBarcode.Equals("Y") ? "F" : "S",
                                        BarcodeStatus = NgToBarcode.Equals("Y") ? "1" : "0",
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeNo = NgBarcodeNo
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            }
                            #endregion
                        }
                        #endregion

                        #endregion

                        #region //INSERT MES.BarcodeProcess
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, CauseNo
                                , StartDate, FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeProcessId, INSERTED.BarcodeId
                                VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @CauseNo
                                , @StartDate, @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeId = NgBarcodeId,
                                MoId,
                                MachineId,
                                MoProcessId = CurrentMoProcessId,
                                ProdStatus = NgToBarcode.Equals("Y") ? "F" : "S",
                                StationQty = NgBarcodeQty,
                                PassQty = 0,
                                NgQty = NgBarcodeQty,
                                CauseNo,
                                StartDate = CreateDate,
                                FinishDate = LastModifiedDate,
                                ModeShiftId,
                                CycleTime = 0,
                                StartUserId = CreateBy,
                                FinishUserId = LastModifiedBy,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();

                        int ToBarcodeProcessId = -1;
                        foreach (var item in insertResult2)
                        {
                            ToBarcodeProcessId = item.BarcodeProcessId;
                        }
                        #endregion

                        #region //確認是否有鏡頭條碼註冊在此條碼上
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Barcode a 
                                INNER JOIN MES.Barcode b ON a.ParentBarcode = b.BarcodeId
                                WHERE b.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        var MinBarcodesResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MinBarcodesResult.Count() > 0)
                        {
                            if (MinBarcodes.Length <= 0) throw new SystemException("此條碼有被鏡頭條碼註冊，需輸入鏡頭條碼來進行NG拆盤");

                            #region //更新鏡頭條碼ParentBarcode、狀態
                            List<string> minBarcodeIds = MinBarcodes.Split(',').ToList<string>();
                            foreach (var item in minBarcodeIds)
                            {
                                #region //先確認鏡頭條碼資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.BarcodeStatus, a.CurrentProdStatus, a.CurrentMoProcessId, a.ParentBarcode
                                        FROM MES.Barcode a 
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", item);

                                var MinBarcodesResult2 = sqlConnection.Query(sql, dynamicParameters);

                                if (MinBarcodesResult2.Count() <= 0) throw new SystemException("鏡頭條碼【" + item + "】資料錯誤!!");

                                string minBarcodeNo = "";
                                foreach (var item2 in MinBarcodesResult2)
                                {
                                    if (item2.BarcodeStatus != "1" && item2.BarcodeStatus != "0") throw new SystemException("鏡頭條碼【" + item + "】狀態錯誤!!");
                                    if (item2.CurrentProdStatus != "P") throw new SystemException("鏡頭條碼【" + item + "】非良品!!");
                                    //if (item2.CurrentMoProcessId != MoProcessId) throw new SystemException("鏡頭條碼【" + item + "】製程錯誤!!");
                                    if (item2.ParentBarcode != BarcodeId) throw new SystemException("鏡頭條碼【" + item + "】與主條碼註冊資料錯誤!!");
                                    minBarcodeNo = item2.BarcodeNo;
                                }
                                #endregion

                                #region //Update MinBarcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        ParentBarcode = @NgBarcodeId,
                                        CurrentProdStatus = 'F',
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        NgBarcodeId,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeNo = minBarcodeNo
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion
                        }
                        #endregion

                        #region //UPDATE 原本MES.Barcode BarcodeQty
                        //if (BarcodeQty - NgBarcodeQty == 0)
                        //{
                        //    BarcodeStatus = "0";
                        //    NextMoProcessId = -1;
                        //}
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty - @NgBarcodeQty,
                                BarcodeStatus = @BarcodeStatus,
                                NextMoProcessId = @NextMoProcessId,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                NgBarcodeQty,
                                BarcodeStatus,
                                NextMoProcessId,
                                LastModifiedDate,
                                LastModifiedBy = UserId,
                                BarcodeNo
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //UPDATE原本的BarcodeProcess StationQty
                        dynamicParameters = new DynamicParameters();
                        if (BarcodeQty - NgBarcodeQty == 0)
                        {
                            sql = @"UPDATE MES.BarcodeProcess SET
                                    StationQty = StationQty - @NgBarcodeQty,
                                    PassQty = PassQty - @NgBarcodeQty,
                                    FinishDate = @FinishDate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NgBarcodeQty,
                                    FinishDate = DateTime.Now,
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    BarcodeProcessId
                                });
                        }
                        else
                        {
                            sql = @"UPDATE MES.BarcodeProcess SET
                                    StationQty = StationQty - @NgBarcodeQty,
                                    PassQty = PassQty - @NgBarcodeQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NgBarcodeQty,
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    BarcodeProcessId
                                });
                        }

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //重新計算條碼狀態報表資料
                        UpdateMoQtyInformation(MoId);
                        #endregion

                        #region //INSERT MES.BarcodeTransfer
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeTransfer (FromBarcodeProcessId, ToBarcodeProcessId, TransactionDate, FromBarcodeId, ToBarcodeId, TransactionQty
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.TransactionId
                                VALUES (@FromBarcodeProcessId, @ToBarcodeProcessId, @TransactionDate, @FromBarcodeId, @ToBarcodeId, @TransactionQty
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FromBarcodeProcessId = BarcodeProcessId,
                                ToBarcodeProcessId,
                                TransactionDate = CreateDate,
                                FromBarcodeId = BarcodeId,
                                ToBarcodeId = NgBarcodeId,
                                TransactionQty = NgBarcodeQty,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult3.Count();
                        #endregion

                        #region //INSERT MES.AdvancedLog
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.AdvancedLog (BarcodeId, MoProcessId, OriNextMoProcessId, NextMoProcessId, OriQty, Qty, OriCurrentProdStatus, CurrentProdStatus, CauseNo
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@BarcodeId, @MoProcessId, @OriNextMoProcessId, @NextMoProcessId, @OriQty, @Qty, @OriCurrentProdStatus, @CurrentProdStatus, @CauseNo
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeId,
                                MoProcessId,
                                OriNextMoProcessId = NextMoProcessId,
                                NextMoProcessId,
                                OriQty = StationQty,
                                Qty = StationQty - NgBarcodeQty,
                                OriCurrentProdStatus,
                                CurrentProdStatus = NgToBarcode == "Y" ? "F" : "S",
                                CauseNo,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBarcodeComponent-- 新增物料元件資料 -- Ann 2022-11-12
        public string AddBarcodeComponent(string AssemblyBarcodeNo, string ComponentBarcodeNo, int MoProcessId)
        {
            try
            {
                if (AssemblyBarcodeNo.Length <= 0) throw new SystemException("【主條碼】不能為空!");
                if (ComponentBarcodeNo.Length <= 0) throw new SystemException("【物料條碼】不能為空!");
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷主條碼資訊是否正確
                        //若條碼來源為BP, 判斷在BarcodePrint, 否則判斷在MrDetail MainBarcode = 'Y'
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.Source, a.MoId
                                  FROM MES.MoProcess a
                                       INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                 WHERE a.MoProcessId = @MoProcessId ";

                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var MtlSettingResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlSettingResult.Count() <= 0) throw new SystemException("找不到製令用料設定!");
                        string Source = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Source;
                        int MoId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoId;

                        if (Source.Equals("BP"))
                        {
                            sql = @"SELECT a.BarcodeId AssemblyBarcodeId, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeQty
                                    , 'Y' MainBarcode
                                    FROM MES.Barcode a
                                    INNER JOIN MES.BarcodeProcess b ON a.CurrentMoProcessId = b.MoProcessId AND a.BarcodeId = b.BarcodeId
                                    INNER JOIN MES.BarcodePrint c ON a.BarcodeNo = c.BarcodeNo
                                    WHERE a.BarcodeNo = @BarcodeNo AND b.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", AssemblyBarcodeNo);
                        }
                        else
                        {
                            sql = @"SELECT a.BarcodeId AssemblyBarcodeId, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeQty
                                    , e.MainBarcode
                                    FROM MES.Barcode a
                                    INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                    INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                    INNER JOIN MES.WoDetail d ON c.MtlItemId = d.MtlItemId
                                    INNER JOIN MES.MoMtlSetting e ON d.WoDetailId = e.WoDetailId AND e.MoId = a.MoId
                                    INNER JOIN MES.BarcodeProcess f ON a.BarcodeId = f.BarcodeId AND a.CurrentMoProcessId = f.MoProcessId
                                    WHERE a.BarcodeNo = @BarcodeNo AND f.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", AssemblyBarcodeNo);
                        }

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("主條碼資料錯誤!");

                        int AssemblyBarcodeId = -1;
                        int CurrentMoProcessId = -1;
                        int NextMoProcessId = -1;
                        int BarcodeQty = -1;
                        foreach (var item in result)
                        {
                            if (item.MainBarcode != "Y") throw new SystemException("此條碼非主條碼!");

                            AssemblyBarcodeId = item.AssemblyBarcodeId;
                            CurrentMoProcessId = item.CurrentMoProcessId;
                            NextMoProcessId = item.NextMoProcessId;
                            BarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //判斷綁定條碼資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT c.MainBarcode
                                , e.BarcodeId, e.BarcodeStatus
                                FROM MES.MrBarcodeRegister a
                                INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                INNER JOIN MES.MoMtlSetting c ON b.MoId = c.MoId
                                INNER JOIN MES.WoDetail d ON c.WoDetailId = d.WoDetailId AND d.MtlItemId = b.MtlItemId
                                INNER JOIN MES.Barcode e ON a.BarcodeNo = e.BarcodeNo AND e.MoId = @MoId
                                WHERE e.BarcodeNo = @BarcodeNo
                                AND b.MoId = @MoId";
                        dynamicParameters.Add("BarcodeNo", ComponentBarcodeNo);
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("綁定條碼資料錯誤!");

                        Boolean newBarcode = false;
                        int ComponentBarcodeId = -1;
                        foreach (var item in result2)
                        {
                            if (item.MainBarcode != "N") throw new SystemException("此條碼為主條碼，無法用於綁定上料!");

                            if (item.BarcodeId == null) newBarcode = true;
                            else
                            {
                                if (item.BarcodeStatus != "3") throw new SystemException("此條碼狀態無法進行上料綁定!");
                                ComponentBarcodeId = item.BarcodeId;
                            }
                        }
                        #endregion

                        #region //判斷主條碼與綁定條碼關係是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT d.MoProcessId BindMoProcessId
                                , e.ProcessAlias
                                FROM MES.MrBarcodeRegister a
                                INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                INNER JOIN MES.WoDetail c ON b.MtlItemId = c.MtlItemId
                                INNER JOIN MES.MoMtlSetting d ON c.WoDetailId = d.WoDetailId AND d.MoId = b.MoId
                                INNER JOIN MES.MoProcess e ON d.MoId = e.MoId
                                WHERE a.BarcodeNo = @BarcodeNo
                                AND b.MoId = @MoId";
                        dynamicParameters.Add("BarcodeNo", ComponentBarcodeNo);
                        dynamicParameters.Add("MoId", MoId);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        if (result4.Count() <= 0) throw new SystemException("此條碼不能與主條碼【" + AssemblyBarcodeNo + "】進行綁定!");

                        foreach (var item in result4)
                        {
                            if (item.BindMoProcessId != MoProcessId) throw new SystemException("請於【" + item.ProcessAlias + "】進行上料綁定!!");
                        }
                        #endregion

                        int UserId = CreateBy;
                        int rowsAffected = 0;
                        if (newBarcode == true)
                        {
                            //新增Barcode 與主條碼內容相同
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId
                                    , CurrentProdStatus, BarcodeStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeId
                                    VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId
                                    , @CurrentProdStatus, @BarcodeStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeNo = ComponentBarcodeNo,
                                    CurrentMoProcessId = -1,
                                    NextMoProcessId = -1,
                                    MoId,
                                    BarcodeQty,
                                    BarcodeProcessId = -1,
                                    CurrentProdStatus = "P",
                                    BarcodeStatus = "1", //定義一個Status = "投入產品生產中"
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();

                            foreach (var item in insertResult)
                            {
                                ComponentBarcodeId = item.BarcodeId;
                            }
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    CurrentMoProcessId = @CurrentMoProcessId,
                                    NextMoProcessId = @NextMoProcessId,
                                    BarcodeStatus = '4',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    CurrentMoProcessId,
                                    NextMoProcessId,
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    BarcodeNo = ComponentBarcodeNo
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeComponent (AssemblyBarcodeId, ComponentBarcodeId, MoProcessId
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeComponentId
                                VALUES (@AssemblyBarcodeId, @ComponentBarcodeId, @MoProcessId
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                AssemblyBarcodeId,
                                ComponentBarcodeId,
                                MoProcessId,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion 

        #region //AddBarcodeComponentL-- 新增物料元件資料(批號) -- Ann 2024-05-13
        public string AddBarcodeComponentL(string AssemblyBarcodeNo, string LotNumber, int MoProcessId, int ComponentMtlItemId)
        {
            try
            {
                int rowsAffected = 0;
                if (AssemblyBarcodeNo.Length <= 0) throw new SystemException("【主條碼】不能為空!");
                if (LotNumber.Length <= 0) throw new SystemException("【批號】不能為空!");
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷主條碼資訊是否正確
                        //若條碼來源為BP, 判斷在BarcodePrint, 否則判斷在MrDetail MainBarcode = 'Y'
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.Source, a.MoId
                                  FROM MES.MoProcess a
                                       INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                 WHERE a.MoProcessId = @MoProcessId ";

                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var MtlSettingResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlSettingResult.Count() <= 0) throw new SystemException("找不到製令用料設定!");
                        string Source = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Source;
                        int MoId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoId;

                        if (Source.Equals("BP"))
                        {
                            sql = @"SELECT a.BarcodeId AssemblyBarcodeId, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeQty
                                    , 'Y' MainBarcode
                                    FROM MES.Barcode a
                                    INNER JOIN MES.BarcodeProcess b ON a.CurrentMoProcessId = b.MoProcessId AND a.BarcodeId = b.BarcodeId
                                    INNER JOIN MES.BarcodePrint c ON a.BarcodeNo = c.BarcodeNo
                                    WHERE a.BarcodeNo = @BarcodeNo AND b.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", AssemblyBarcodeNo);
                        }
                        else
                        {
                            sql = @"SELECT a.BarcodeId AssemblyBarcodeId, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeQty
                                    , e.MainBarcode
                                    FROM MES.Barcode a
                                    INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                    INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                    INNER JOIN MES.WoDetail d ON c.MtlItemId = d.MtlItemId
                                    INNER JOIN MES.MoMtlSetting e ON d.WoDetailId = e.WoDetailId AND e.MoId = a.MoId
                                    INNER JOIN MES.BarcodeProcess f ON a.BarcodeId = f.BarcodeId AND a.CurrentMoProcessId = f.MoProcessId
                                    WHERE a.BarcodeNo = @BarcodeNo AND f.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", AssemblyBarcodeNo);
                        }

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("主條碼資料錯誤!");

                        int AssemblyBarcodeId = -1;
                        int CurrentMoProcessId = -1;
                        int NextMoProcessId = -1;
                        int BarcodeQty = -1;
                        foreach (var item in result)
                        {
                            if (item.MainBarcode != "Y") throw new SystemException("此條碼非主條碼!");

                            AssemblyBarcodeId = item.AssemblyBarcodeId;
                            CurrentMoProcessId = item.CurrentMoProcessId;
                            NextMoProcessId = item.NextMoProcessId;
                            BarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //確認批號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.LotNumberId 
                                , c.MoProcessId BindMoProcessId
                                , e.ProcessAlias
                                FROM SCM.LotNumber a 
                                INNER JOIN MES.MrDetail b ON a.LotNumberNo = b.LotNumber AND a.MtlItemId = b.MtlItemId
                                INNER JOIN MES.MoMtlSetting c ON c.MoId = b.MoId
                                INNER JOIN MES.WoDetail d ON c.WoDetailId = d.WoDetailId AND d.MtlItemId = b.MtlItemId
                                INNER JOIN MES.MoProcess e ON c.MoProcessId = e.MoProcessId
                                WHERE a.LotNumberNo = @LotNumber
                                AND b.MoId = @MoId
                                AND b.MtlItemId = @ComponentMtlItemId";
                        dynamicParameters.Add("LotNumber", LotNumber);
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("ComponentMtlItemId", ComponentMtlItemId);

                        var LotNumberResult = sqlConnection.Query(sql, dynamicParameters);

                        if (LotNumberResult.Count() <= 0) throw new SystemException("【批號】資料錯誤!!");

                        int LotNumberId = -1;
                        foreach (var item in LotNumberResult)
                        {
                            if (item.BindMoProcessId != MoProcessId) throw new SystemException("請於【" + item.ProcessAlias + "】進行上料綁定!!");
                            LotNumberId = item.LotNumberId;
                        }
                        #endregion

                        #region //確認此批號沒有被同一個主件綁定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.ProcessAlias
                                , d.WoErpPrefix + '-' + d.WoErpNo WoErpFullNo
                                FROM MES.BarcodeComponent a 
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
                                INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                WHERE a.AssemblyBarcodeId = @AssemblyBarcodeId
                                AND a.LotNumberId = @LotNumberId";
                        dynamicParameters.Add("AssemblyBarcodeId", AssemblyBarcodeId);
                        dynamicParameters.Add("LotNumberId", LotNumberId);

                        var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in BarcodeComponentResult)
                        {
                            throw new SystemException("此批號已被相同主料重複綁定!!<br>製令:【" + item.WoErpFullNo + "】<br>製程:【" + item.ProcessAlias + "】");
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeComponent (AssemblyBarcodeId, LotNumberId, MoProcessId
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeComponentId
                                VALUES (@AssemblyBarcodeId, @LotNumberId, @MoProcessId
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                AssemblyBarcodeId,
                                LotNumberId,
                                MoProcessId,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion 

        #region //AddBarcodeComponentAttribute-- 新增上料元件屬性資料 -- Ann 2022-11-14
        public string AddBarcodeComponentAttribute(string BarcodeComponentAttributeData)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        var BarcodeComponentAttributeJson = JObject.Parse(BarcodeComponentAttributeData);

                        if (BarcodeComponentAttributeJson["BarcodeComponentAttributeInfo"].Count() <= 0) throw new SystemException("【條碼】不能為空!");

                        int UserId = CreateBy;
                        int rowsAffected = 0;
                        foreach (var item in BarcodeComponentAttributeJson["BarcodeComponentAttributeInfo"])
                        {
                            if (item["ItemValue"].ToString().Length <= 0) throw new SystemException("【條碼屬性】不能為空!");
                            if (item["ChkUnique"].ToString().Length <= 0) throw new SystemException("【是否檢核重複值】不能為空!");

                            #region //判斷元件資料是否正確
                            DynamicParameters dynamicParameters = new DynamicParameters();
                            sql = @"SELECT c.MrDetailId
                                    FROM MES.BarcodeComponent a
                                    INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                    INNER JOIN MES.MrBarcodeRegister c ON b.BarcodeNo = c.BarcodeNo
                                    WHERE a.BarcodeComponentId = @BarcodeComponentId";
                            dynamicParameters.Add("BarcodeComponentId", Convert.ToInt32(item["BarcodeComponentId"]));

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("製令歷程資料錯誤!");

                            int MrDetailId = -1;
                            foreach (var item2 in result)
                            {
                                MrDetailId = item2.MrDetailId;
                            }
                            #endregion

                            #region //判斷Type資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TypeName
                                    FROM BAS.[Type] a
                                    WHERE a.TypeSchema = 'MoMtlSettingAttribute.ItemNo'
                                    AND a.TypeNo = @TypeNo";
                            dynamicParameters.Add("TypeNo", item["ItemNo"].ToString());

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("屬性設定資料錯誤!");

                            string TypeName = "";
                            foreach (var item2 in result3)
                            {
                                TypeName = item2.TypeName;
                            }
                            #endregion

                            #region //判斷此屬性是否已被綁定
                            if (item["ChkUnique"].ToString() == "Y")
                            {
                                if (item["ChkRange"].ToString() == "Y")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponentAttribute
                                            WHERE ItemNo = @ItemNo
                                            AND ItemValue = @ItemValue";
                                    dynamicParameters.Add("ItemNo", item["ItemNo"].ToString());
                                    dynamicParameters.Add("ItemValue", item["ItemValue"].ToString());

                                    var result4 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result4.Count() > 0) throw new SystemException("屬性【" + TypeName + "】重複，無法新增!");
                                }
                                else
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeComponentAttribute a
                                            INNER JOIN MES.BarcodeComponent b ON a.BarcodeComponentId = b.BarcodeComponentId
                                            INNER JOIN MES.Barcode c ON b.ComponentBarcodeId = c.BarcodeId
                                            INNER JOIN MES.MrBarcodeRegister d ON c.BarcodeNo = d.BarcodeNo
                                            WHERE a.ItemNo = @ItemNo AND a.ItemValue = @ItemValue
                                            AND d.MrDetailId = @MrDetailId";
                                    dynamicParameters.Add("ItemNo", item["ItemNo"].ToString());
                                    dynamicParameters.Add("ItemValue", item["ItemValue"].ToString());
                                    dynamicParameters.Add("MrDetailId", MrDetailId);

                                    var result4 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result4.Count() > 0) throw new SystemException("屬性【" + TypeName + "】重複，無法新增!");
                                }
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeComponentAttribute (BarcodeComponentId, ItemNo, ItemValue
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeComponentId, INSERTED.ItemNo
                                    VALUES (@BarcodeComponentId, @ItemNo, @ItemValue
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeComponentId = Convert.ToInt32(item["BarcodeComponentId"]),
                                    ItemNo = item["ItemNo"].ToString(),
                                    ItemValue = item["ItemValue"].ToString(),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddLotBarcodeQtyMerge-- 新增批量條碼拆併盤資料 -- Ann 2022-11-24
        public string AddLotBarcodeQtyMerge(int MoId, string FromBarcodeNo, string ToBarcodeNo, int TransactionQty, string MinBarcodes)
        {
            try
            {
                if (TransactionQty <= 0) throw new SystemException("【拆併數量】不能為空!");
                if (FromBarcodeNo == ToBarcodeNo) throw new SystemException("來源及目標條碼不能相同!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        #region //判斷製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MoSettingId, b.LotStatus, b.LotQty, b.NgToBarcode, b.TrayBarcode, b.Source
                                    , b.BarcodePrefix, b.SequenceLen, b.BarcodePostfix
                                FROM MES.ManufactureOrder a
                                     INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令資料錯誤!");
                        int LotQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).LotQty);
                        string NgToBarcode = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NgToBarcode;
                        string TrayBarcode = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TrayBarcode;
                        string LotStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).LotStatus;
                        string Source = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Source;
                        string BarcodePrefix = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodePrefix;
                        int SequenceLen = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SequenceLen;
                        string BarcodePostfix = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodePostfix;
                        int MoSettingId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoSettingId;
                        #endregion

                        #region //若TrayBarcode為Y, 則replace fromBarcode & ToBarcode
                        bool newToBarcode = false;
                        if (TrayBarcode.Equals("Y"))
                        {
                            #region //來源Tray
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayId,a.TrayNo,a.BarcodeNo,a.TrayCapacity
                                        , b.CurrentMoProcessId, b.NextMoProcessId, b.BarcodeStatus, b.CurrentProdStatus
                                        FROM MES.Tray a
                                            INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                    WHERE a.TrayNo = @TrayNo
                                        AND a.[Status] = 'A'
                                        AND a.CompanyId = @CompanyId";

                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("TrayNo", FromBarcodeNo);
                            var FromBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (FromBarcodeResult.Count() <= 0) throw new SystemException("該Tray盤Barcode資料錯誤,找不到對應資料!");
                            FromBarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;
                            int FromCurrentMoProcessId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentMoProcessId;
                            int FromNextMoProcessId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NextMoProcessId;
                            string FromCurrentProdStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentProdStatus;
                            #endregion

                            #region //目標Tray
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayId,a.TrayNo,a.BarcodeNo,a.TrayCapacity
                                        FROM MES.Tray a
                                            LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                        WHERE a.TrayNo = @TrayNo
                                            AND a.[Status] = 'A'
                                            AND a.CompanyId = @CompanyId";

                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("TrayNo", ToBarcodeNo);
                            var ToBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (ToBarcodeResult.Count() <= 0) throw new SystemException("該Tray盤Barcode資料錯誤,找不到對應資料!");

                            int ToTrayId = -1;
                            foreach (var item in ToBarcodeResult)
                            {
                                ToTrayId = item.TrayId;

                                if (item.BarcodeNo == null)
                                {
                                    newToBarcode = true;

                                    #region //自動建立BarcodePrint
                                    #region //取得最大序列號條碼
                                    string seq = "";
                                    seq = GetNewBarcodeNo(BarcodePrefix, SequenceLen, BarcodePostfix).PadLeft(SequenceLen, '0');
                                    ToBarcodeNo = BarcodePrefix + seq + BarcodePostfix;
                                    string GetNewBarcodeNo(string thisBarcodePrefix, int thisSequenceLen, string thisBarcodePostfix)
                                    {
                                        string NewBarcodeNo = "";
                                        #region //找此BARCODE格式最大號
                                        #region //組模糊查詢字串
                                        string SearchLikeStrig = "";
                                        for (int j = 1; j <= thisSequenceLen; j++)
                                        {
                                            SearchLikeStrig += "_";
                                        }
                                        #endregion

                                        string queryModal = "";
                                        if (thisBarcodePrefix.IndexOf("[") != -1)
                                        {
                                            char[] prefixList = thisBarcodePrefix.ToCharArray();

                                            for (int i = 0; i < prefixList.Length; i++)
                                            {
                                                if (prefixList[i] == '[') queryModal += "|";
                                                queryModal += prefixList[i];
                                            }

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                    FROM MES.BarcodePrint
                                                    WHERE BarcodeNo LIKE '%" + queryModal + SearchLikeStrig + thisBarcodePostfix + "%' ESCAPE '|'";
                                        }
                                        else if (thisBarcodePostfix.IndexOf("[") != -1)
                                        {
                                            char[] postfixList = thisBarcodePostfix.ToCharArray();

                                            for (int i = 0; i < postfixList.Length; i++)
                                            {
                                                if (postfixList[i] == '[') queryModal += "|";
                                                queryModal += postfixList[i];
                                            }

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                    FROM MES.BarcodePrint
                                                    WHERE BarcodeNo LIKE '%" + thisBarcodePrefix + SearchLikeStrig + queryModal + "%' ESCAPE '|'";
                                        }
                                        else
                                        {
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                    FROM MES.BarcodePrint
                                                    WHERE BarcodeNo LIKE '" + thisBarcodePrefix + SearchLikeStrig + thisBarcodePostfix + "%'";
                                        }

                                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                        foreach (var item2 in BarcodeResult)
                                        {
                                            string MaxBarcodeNo = item2.MaxBarcodeNo;
                                            if (item2.MaxBarcodeNo == null)
                                            {
                                                seq = "1".PadLeft(SequenceLen, '0');
                                            }
                                            else
                                            {
                                                #region //拆解BarcodeNo順序
                                                string thisSeq = "";
                                                if (thisBarcodePostfix != "")
                                                {
                                                    thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "").Replace(thisBarcodePostfix, "");
                                                }
                                                else
                                                {
                                                    thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "");
                                                }
                                                seq = (Convert.ToInt32(thisSeq) + 1).ToString().PadLeft(SequenceLen, '0');
                                                #endregion
                                            }

                                            NewBarcodeNo = thisBarcodePrefix + seq + thisBarcodePostfix;
                                        }
                                        #endregion

                                        return seq;
                                    }
                                    #endregion

                                    #region //INSERT MES.BarcodePrint
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodePrint (BarcodeNo, BarcodeQty, MoSettingId, ParentBarcode, PrintCnt, PrintStatus
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.BarcodeNo
                                            VALUES (@BarcodeNo, @BarcodeQty, @MoSettingId, @ParentBarcode, @PrintCnt, @PrintStatus
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeNo = ToBarcodeNo,
                                            BarcodeQty = 0,
                                            MoSettingId,
                                            ParentBarcode = "",
                                            PrintCnt = 0,
                                            PrintStatus = "P",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                    #endregion
                                }
                                else
                                {
                                    ToBarcodeNo = item.BarcodeNo;
                                }
                            }

                            #region //註冊TrayBarcode
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Tray SET
                                    BarcodeNo = @ToBarcodeNo,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TrayId = @ToTrayId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ToBarcodeNo,
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    ToTrayId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                            #endregion
                        }

                        #endregion

                        #region //確認來源條碼狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeStatus
                                FROM MES.Barcode a
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);

                        var BarcodeStatusResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeStatusResult.Count() <= 0) throw new SystemException("來源條碼(" + FromBarcodeNo + ")資料錯誤!!");

                        foreach (var item in BarcodeStatusResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("來源條碼(" + FromBarcodeNo + ")目前狀態不可更改!!");
                        }
                        #endregion

                        #region //確認目標條碼狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeStatus
                                FROM MES.Barcode a
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", ToBarcodeNo);

                        var BarcodeStatusResult2 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in BarcodeStatusResult2)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("目標條碼(" + ToBarcodeNo + ")目前狀態不可更改!!");
                        }
                        #endregion

                        #region //判斷來源條碼是否被包裝條碼綁定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.[Status], b.PackageBarcodeNo
                                , c.BarcodeStatus
                                FROM MES.PackageBarcodeReference a 
                                INNER JOIN MES.PackageBarcode b ON a.PackageBarcodeId = b.PackageBarcodeId
                                INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                WHERE c.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);

                        var PackageBarcodeReferenceResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in PackageBarcodeReferenceResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("來源條碼(" + FromBarcodeNo + ")目前狀態不可更改!!");
                            if (item.Status != "3") throw new SystemException("來源條碼(" + FromBarcodeNo + ")目前被包裝條碼(" + item.PackageBarcodeNo + ")綁定，無法更改!!");
                        }
                        #endregion

                        #region //判斷目標條碼是否被包裝條碼綁定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.[Status], b.PackageBarcodeNo
                                , c.BarcodeStatus
                                FROM MES.PackageBarcodeReference a 
                                INNER JOIN MES.PackageBarcode b ON a.PackageBarcodeId = b.PackageBarcodeId
                                INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                WHERE c.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", ToBarcodeNo);

                        PackageBarcodeReferenceResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in PackageBarcodeReferenceResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("目標條碼(" + ToBarcodeNo + ")目前狀態不可更改!!");
                            if (item.Status != "3") throw new SystemException("目標條碼(" + ToBarcodeNo + ")目前被包裝條碼(" + item.PackageBarcodeNo + ")綁定，無法更改!!");
                        }
                        #endregion

                        #region //將條碼轉成大寫
                        FromBarcodeNo = FromBarcodeNo.ToString().ToUpper();
                        ToBarcodeNo = ToBarcodeNo.ToString().ToUpper();
                        #endregion

                        #region //判斷來源條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId FromBarcodeId, a.BarcodeQty FromBarcodeQty, a.CurrentProdStatus, a.CurrentMoProcessId FromBarcodeMoProcessId, a.NextMoProcessId FromBarcodeNextMoProcessId, a.BarcodeStatus FromBarcodeStatus
                                , b.FinishDate, b.MachineId, b.ModeShiftId, NextMoProcessId
                                FROM MES.Barcode a
                                INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                WHERE a.BarcodeNo = @FromBarcodeNo
                                AND a.MoId = @MoId";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("來源條碼資料錯誤!");

                        int FromBarcodeId = -1;
                        int FromBarcodeMoProcessId = -1;
                        int FromBarcodeNextMoProcessId = -1;
                        int MachineId = -1;
                        int ModeShiftId = -1;
                        int FromBarcodeQty = -1;
                        int NextMoProcessId = -1;
                        string FromBarcodeStatus = "";
                        foreach (var item in result2)
                        {
                            if (TransactionQty > item.FromBarcodeQty) throw new SystemException("拆併數量不能超過來源條碼數量(" + item.FromBarcodeQty + ")!");
                            if (TransactionQty == item.FromBarcodeQty) FromBarcodeQty = 0;
                            if (item.CurrentProdStatus != "P") throw new SystemException("來源條碼目前狀態非良品(P)!");
                            if (item.FinishDate == null) throw new SystemException("來源條碼目前尚在加工中!");
                            FromBarcodeId = item.FromBarcodeId;
                            FromBarcodeMoProcessId = item.FromBarcodeMoProcessId;
                            FromBarcodeNextMoProcessId = item.FromBarcodeNextMoProcessId;
                            MachineId = item.MachineId;
                            ModeShiftId = item.ModeShiftId;
                            NextMoProcessId = Convert.ToInt32(item.NextMoProcessId);
                            FromBarcodeStatus = item.FromBarcodeStatus;
                        }
                        #endregion

                        #region //判斷目標條碼資料是否正確
                        dynamicParameters = new DynamicParameters();

                        if (LotStatus == "Y" && Source == "BP")
                        {
                            sql = @"SELECT a.BarcodeQty BarcodePrintQty, a.PrintStatus
                                    , b.BarcodeId ToBarcodeId, b.MoId, b.CurrentProdStatus, b.CurrentMoProcessId ToBarcodeMoProcessId
                                    , c.FinishDate
                                    FROM MES.BarcodePrint a
                                    LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                    LEFT JOIN MES.BarcodeProcess c ON b.BarcodeId = c.BarcodeId AND b.CurrentMoProcessId = c.MoProcessId
                                    WHERE a.BarcodeNo = @ToBarcodeNo";
                            dynamicParameters.Add("ToBarcodeNo", ToBarcodeNo);
                        }
                        else
                        {
                            sql = @"SELECT a.BarcodeQty, a.BarcodeId ToBarcodeId, a.MoId, a.CurrentProdStatus, a.CurrentMoProcessId ToBarcodeMoProcessId
                                    , b.FinishDate
                                    FROM MES.Barcode a
                                    INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                    WHERE a.BarcodeNo = @ToBarcodeNo";
                            dynamicParameters.Add("ToBarcodeNo", ToBarcodeNo);
                        }

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() <= 0) throw new SystemException("目標條碼資料錯誤!");

                        int ToBarcodeId = -1;
                        foreach (var item in result3)
                        {
                            if (item.ToBarcodeId == null)
                            {
                                if (item.PrintStatus != "P") throw new SystemException("目標條碼目前狀態非良品(P)!");
                                #region //INSERT BARCODE
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeId ToBarcodeId, INSERTED.BarcodeQty ToBarcodeQty
                                        VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = ToBarcodeNo,
                                        CurrentMoProcessId = FromBarcodeMoProcessId,
                                        NextMoProcessId = FromBarcodeNextMoProcessId,
                                        MoId,
                                        BarcodeQty = item.BarcodePrintQty,
                                        BarcodeProcessId = -1,
                                        CurrentProdStatus = "P",
                                        BarcodeStatus = FromBarcodeStatus,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult2.Count();

                                int ToBarcodeQty = -1;
                                foreach (var item2 in insertResult2)
                                {
                                    ToBarcodeId = item2.ToBarcodeId;
                                    ToBarcodeQty = item2.ToBarcodeQty;
                                }
                                #endregion

                                #region //先找出目前所有歷屆必要過站製程
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoProcessId
                                        FROM MES.MoProcess a 
                                        WHERE a.MoId = @MoId
                                        AND (
                                            a.SortNumber < (
                                                SELECT x.SortNumber FROM MES.MoProcess x 
                                            WHERE x.MoProcessId = @MoProcessId)
                                        )
                                        AND a.NecessityStatus = 'Y'";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MoProcessId", FromBarcodeMoProcessId);

                                var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                #endregion

                                #region //補足過站歷程相關資料
                                DateTime CurrentCreateDate = CreateDate;
                                DateTime CurrentLastModifiedDate = LastModifiedDate;
                                foreach (var item2 in MoProcessResult)
                                {
                                    CurrentCreateDate = CurrentCreateDate.AddMinutes(-10);
                                    CurrentLastModifiedDate = CurrentLastModifiedDate.AddMinutes(-11);

                                    #region //取得來此製程班別及機台
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.MachineId, a.ModeShiftId
                                            FROM MES.BarcodeProcess a 
                                            WHERE MoProcessId = @MoProcessId";
                                    dynamicParameters.Add("MoProcessId", item2.MoProcessId);

                                    var NewBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                    int CurrentMachineId = -1;
                                    int CurrentModeShiftId = -1;
                                    foreach (var item3 in NewBarcodeProcessResult)
                                    {
                                        CurrentMachineId = item3.MachineId;
                                        CurrentModeShiftId = item3.ModeShiftId;
                                    }
                                    #endregion

                                    #region //INSERT MES.BarcodeProcess
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, StartDate
                                            , FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.BarcodeProcessId
                                            VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @StartDate
                                            , @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeId = ToBarcodeId,
                                            MoId,
                                            MachineId = CurrentMachineId,
                                            item2.MoProcessId,
                                            ProdStatus = "P",
                                            StationQty = 0,
                                            PassQty = 0,
                                            NgQty = 0,
                                            StartDate = CreateDate,
                                            FinishDate = CurrentLastModifiedDate,
                                            ModeShiftId = CurrentModeShiftId,
                                            CycleTime = 0,
                                            StartUserId = UserId,
                                            FinishUserId = UserId,
                                            CreateDate = CurrentCreateDate,
                                            LastModifiedDate = CurrentLastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult2.Count();

                                    int CurrentBarcodeProcessId = -1;
                                    foreach (var item3 in insertResult2)
                                    {
                                        CurrentBarcodeProcessId = item3.BarcodeProcessId;
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //INSERT BarcodeProcess (目前站別)
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty
                                        , StartDate, FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeId ToBarcodeId
                                        VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty
                                        , @StartDate, @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeId = ToBarcodeId,
                                        MoId,
                                        MachineId,
                                        MoProcessId = FromBarcodeMoProcessId,
                                        ProdStatus = "P",
                                        StationQty = ToBarcodeQty,
                                        PassQty = ToBarcodeQty,
                                        NgQty = 0,
                                        StartDate = CreateDate,
                                        FinishDate = CreateDate,
                                        ModeShiftId,
                                        CycleTime = 0,
                                        StartUserId = CreateBy,
                                        FinishUserId = CreateBy,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult3.Count();
                                #endregion
                            }
                            else
                            {
                                if (item.CurrentProdStatus != "P") throw new SystemException("目標條碼目前狀態非良品(P)!");
                                if (item.FinishDate == null && item.BarcodePrintQty != 0) throw new SystemException("目標條碼目前非完工狀態!");
                                if (item.ToBarcodeMoProcessId != FromBarcodeMoProcessId) throw new SystemException("來源條碼與目標條碼製程不同!");
                                ToBarcodeId = item.ToBarcodeId;
                            }
                        }
                        #endregion

                        #region //更新來源條碼 Barcode & BarcodeProcess
                        if (FromBarcodeQty != 0 && NextMoProcessId != -1)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    NextMoProcessId = @NextMoProcessId,
                                    BarcodeQty = BarcodeQty - @TransactionQty,
                                    BarcodeStatus = @BarcodeStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @FromBarcodeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NextMoProcessId = FromBarcodeQty != 0 ? FromBarcodeNextMoProcessId : -1,
                                    TransactionQty,
                                    BarcodeStatus = FromBarcodeQty != 0 ? "1" : "0",
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    FromBarcodeId
                                });
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    BarcodeQty = BarcodeQty - @TransactionQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @FromBarcodeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    TransactionQty,
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    FromBarcodeId
                                });
                        }

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeProcess SET
                                StationQty = StationQty - @TransactionQty,
                                PassQty = PassQty - @TransactionQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                FROM MES.BarcodeProcess a
                                WHERE a.BarcodeId = @FromBarcodeId
                                  AND a.MoProcessId = @FromBarcodeMoProcessId
                                  AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                        FROM MES.BarcodeProcess a1
                                                       WHERE a1.BarcodeId = a.BarcodeId
                                                         AND a1.MoProcessId = a.MoProcessId)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                FromBarcodeId,
                                FromBarcodeMoProcessId,
                                LastModifiedDate,
                                LastModifiedBy = UserId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //取得來源條碼BarcodeProcessId
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeProcessId
                                    FROM MES.BarcodeProcess a 
                                WHERE a.BarcodeId = @FromBarcodeId
                                  AND a.MoProcessId = @FromBarcodeMoProcessId
                                  AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                        FROM MES.BarcodeProcess a1
                                                       WHERE a1.BarcodeId = a.BarcodeId
                                                         AND a1.MoProcessId = a.MoProcessId)";
                        dynamicParameters.Add("FromBarcodeId", FromBarcodeId);
                        dynamicParameters.Add("FromBarcodeMoProcessId", FromBarcodeMoProcessId);

                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeProcessResult.Count() <= 0) throw new SystemException("取得來源條碼過站歷程資料錯誤!!");

                        int FromBarcodeProcessId = -1;
                        foreach (var item in BarcodeProcessResult)
                        {
                            FromBarcodeProcessId = item.BarcodeProcessId;
                        }
                        #endregion

                        #region //取得目標條碼BarcodeProcessId
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeProcessId FROM MES.BarcodeProcess a 
                                WHERE a.BarcodeId = @ToBarcodeId
                                  AND a.MoProcessId = @ToBarcodeMoProcessId
                                  AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                        FROM MES.BarcodeProcess a1
                                                       WHERE a1.BarcodeId = a.BarcodeId
                                                         AND a1.MoProcessId = a.MoProcessId)";
                        dynamicParameters.Add("ToBarcodeId", ToBarcodeId);
                        dynamicParameters.Add("ToBarcodeMoProcessId", FromBarcodeMoProcessId);

                        var ToBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ToBarcodeProcessResult.Count() <= 0) throw new SystemException("取得來源條碼過站歷程資料錯誤!!");

                        int ToBarcodeProcessId = -1;
                        foreach (var item in ToBarcodeProcessResult)
                        {
                            ToBarcodeProcessId = item.BarcodeProcessId;
                        }
                        #endregion

                        #region //更新目標條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty + @TransactionQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @ToBarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                LastModifiedDate,
                                LastModifiedBy = UserId,
                                ToBarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeProcess SET
                                StationQty = StationQty + @TransactionQty,
                                PassQty = PassQty + @TransactionQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                FROM MES.BarcodeProcess a
                                WHERE a.BarcodeId = @ToBarcodeId
                                  AND a.MoProcessId = @FromBarcodeMoProcessId
                                  AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                        FROM MES.BarcodeProcess a1
                                                       WHERE a1.BarcodeId = a.BarcodeId
                                                         AND a1.MoProcessId = a.MoProcessId)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                ToBarcodeId,
                                FromBarcodeMoProcessId,
                                LastModifiedDate,
                                LastModifiedBy = UserId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //確認是否有鏡頭條碼註冊在來源條碼上
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Barcode a 
                                INNER JOIN MES.Barcode b ON a.ParentBarcode = b.BarcodeId
                                WHERE b.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);
                        var MinBarcodesResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MinBarcodesResult.Count() > 0)
                        {
                            if (MinBarcodes.Length <= 0) throw new SystemException("此條碼有被鏡頭條碼註冊，需輸入鏡頭條碼來進行NG拆盤");

                            #region //更新鏡頭條碼ParentBarcode、狀態
                            List<string> minBarcodeIds = MinBarcodes.Split(',').ToList<string>();
                            foreach (var item in minBarcodeIds)
                            {
                                #region //先確認鏡頭條碼資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.BarcodeStatus, a.CurrentProdStatus, a.CurrentMoProcessId, a.ParentBarcode
                                        FROM MES.Barcode a 
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", item);

                                var MinBarcodesResult2 = sqlConnection.Query(sql, dynamicParameters);

                                if (MinBarcodesResult2.Count() <= 0) throw new SystemException("鏡頭條碼【" + item + "】資料錯誤!!");

                                string minBarcodeNo = "";
                                foreach (var item2 in MinBarcodesResult2)
                                {
                                    if (item2.BarcodeStatus != "1" && item2.BarcodeStatus != "0") throw new SystemException("鏡頭條碼【" + item + "】狀態錯誤!!");
                                    if (item2.CurrentProdStatus != "P") throw new SystemException("鏡頭條碼【" + item + "】目前狀態非良品!!");
                                    //if (item2.CurrentMoProcessId != FromBarcodeMoProcessId) throw new SystemException("鏡頭條碼【" + item + "】製程錯誤!!");
                                    if (item2.ParentBarcode != FromBarcodeId) throw new SystemException("鏡頭條碼【" + item + "】與主條碼註冊資料錯誤!!");
                                    minBarcodeNo = item2.BarcodeNo;
                                }
                                #endregion

                                #region //Update MinBarcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        ParentBarcode = @ToBarcodeId,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ToBarcodeId,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeNo = minBarcodeNo
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion
                        }
                        #endregion

                        #region //INSERT BarcodeTransfer
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeTransfer (FromBarcodeProcessId, ToBarcodeProcessId, TransactionDate, FromBarcodeId, ToBarcodeId, TransactionQty
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@FromBarcodeProcessId, @ToBarcodeProcessId, @TransactionDate, @FromBarcodeId, @ToBarcodeId, @TransactionQty
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FromBarcodeProcessId,
                                ToBarcodeProcessId,
                                TransactionDate = CreateDate,
                                FromBarcodeId,
                                ToBarcodeId,
                                TransactionQty,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();
                        #endregion

                        #region //檢核更新後數量是否正確

                        #region //確認此條碼是否為BarcodePrint
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodePrint a
                                WHERE BarcodeNo = @FromBarcodeNo";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);

                        var BarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodePrintResult.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT BarcodeQty 
                                      FROM MES.Barcode
                                     WHERE BarcodeId in(@FromBarcodeId,@ToBarcodeId)
                                       AND (BarcodeQty < 0 or BarcodeQty > @LotQty) ";
                            dynamicParameters.Add("FromBarcodeId", FromBarcodeId);
                            dynamicParameters.Add("ToBarcodeId", ToBarcodeId);
                            dynamicParameters.Add("LotQty", LotQty);

                            var QtyResult = sqlConnection.Query(sql, dynamicParameters);
                            if (QtyResult.Count() > 0) throw new SystemException("合併前後條碼超出批量數量!");
                        }
                        #endregion

                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddEmptyBarcode-- 新增批量空良品條碼 -- Ann 2023-05-18
        public string AddEmptyBarcode(string FromBarcodeNo, int MoId, string NewTrayBarcode)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        #region //判斷製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.TrayBarcode
                                FROM MES.ManufactureOrder a 
                                INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ManufactureOrderResult.Count() <= 0) throw new SystemException("製令資料有誤!!");

                        string TrayBarcode = "";
                        foreach (var item in ManufactureOrderResult)
                        {
                            TrayBarcode = item.TrayBarcode;
                        }
                        #endregion

                        if (TrayBarcode == "Y")
                        {
                            #region //判斷新Tray盤資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo
                                    FROM MES.Tray a
                                    WHERE a.TrayNo = @NewTrayBarcode";
                            dynamicParameters.Add("NewTrayBarcode", NewTrayBarcode);

                            var NewTrayResult = sqlConnection.Query(sql, dynamicParameters);

                            if (NewTrayResult.Count() <= 0) throw new SystemException("查無此Tray盤【" + NewTrayBarcode + "】資料!!");

                            foreach (var item in NewTrayResult)
                            {
                                if (item.BarcodeNo != null) throw new SystemException("此Tray盤【" + NewTrayBarcode + "】已被其他條碼綁定!!");
                            }
                            #endregion

                            #region //判斷TrayBarcode
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo
                                    FROM MES.Tray a
                                    WHERE a.TrayNo = @FromBarcodeNo";
                            dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);

                            var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TrayResult.Count() <= 0) throw new SystemException("查無此Tray盤【" + FromBarcodeNo + "】資料!!");

                            foreach (var item in TrayResult)
                            {
                                FromBarcodeNo = item.BarcodeNo;
                            }
                            #endregion
                        }

                        #region //判斷來源條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CurrentMoProcessId, a.NextMoProcessId, a.MoId, a.BarcodeProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                , d.MtlItemNo
                                , e.MoSettingId
                                , f.FinishDate, f.MachineId, f.ModeShiftId
                                FROM MES.Barcode a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                INNER JOIN MES.MoSetting e ON a.MoId = e.MoId
                                INNER JOIN MES.BarcodeProcess f ON a.BarcodeId = f.BarcodeId AND a.CurrentMoProcessId = f.MoProcessId
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BarcodeResult.Count() <= 0) throw new SystemException("來源條碼資料錯誤!");

                        int CurrentMoProcessId = -1;
                        int NextMoProcessId = -1;
                        int BarcodeProcessId = -1;
                        string CurrentProdStatus = "";
                        string BarcodeStatus = "";
                        string MtlItemNo = "";
                        int MoSettingId = -1;
                        int MachineId = -1;
                        int ModeShiftId = -1;
                        foreach (var item in BarcodeResult)
                        {
                            if (item.CurrentProdStatus != "P") throw new SystemException("來源條碼狀態無法併盤!!");
                            if (item.FinishDate == null) throw new SystemException("來源條碼目前尚在加工中!");
                            CurrentMoProcessId = item.CurrentMoProcessId;
                            NextMoProcessId = item.NextMoProcessId;
                            MoId = item.MoId;
                            BarcodeProcessId = item.BarcodeProcessId;
                            CurrentProdStatus = item.CurrentProdStatus;
                            BarcodeStatus = item.BarcodeStatus;
                            MtlItemNo = item.MtlItemNo;
                            MtlItemNo = MtlItemNo.ToUpper();
                            MoSettingId = item.MoSettingId;
                            MachineId = item.MachineId;
                            ModeShiftId = item.ModeShiftId;
                        }
                        #endregion

                        #region //找此BARCODE格式最大號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(BarcodeNo))), '000'), 3)) + 1 CurrentNum
                                FROM MES.Barcode
                                WHERE BarcodeNo LIKE '%" + MtlItemNo + "%'";
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodeCountResult = sqlConnection.Query(sql, dynamicParameters);

                        int CurrentNum = 0;
                        foreach (var item in BarcodeCountResult)
                        {
                            CurrentNum = item.CurrentNum;
                        }

                        string seq = CurrentNum.ToString().PadLeft(3, '0');
                        string NewBarcodeNo = (MtlItemNo + "-" + seq).ToUpper();
                        #endregion

                        #region //INSERT MES.BarcodePrint
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodePrint (BarcodeNo, BarcodeQty, MoSettingId, ParentBarcode, PrintCnt, PrintStatus
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeNo
                                VALUES (@BarcodeNo, @BarcodeQty, @MoSettingId, @ParentBarcode, @PrintCnt, @PrintStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo = NewBarcodeNo,
                                BarcodeQty = 0,
                                MoSettingId,
                                ParentBarcode = "",
                                PrintCnt = 0,
                                PrintStatus = "P",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        string NewOutputBarcodeNo = "";
                        foreach (var item in insertResult)
                        {
                            NewOutputBarcodeNo = item.BarcodeNo;
                        }

                        rowsAffected += insertResult.Count();
                        #endregion

                        #region //INSERT MES.Barcode
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeNo, INSERTED.BarcodeId
                                VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo = NewBarcodeNo,
                                CurrentMoProcessId,
                                NextMoProcessId,
                                MoId,
                                BarcodeQty = 0,
                                BarcodeProcessId,
                                CurrentProdStatus,
                                BarcodeStatus,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();

                        int BarcodeId = -1;
                        string BarcodeNo = "";
                        foreach (var item in insertResult)
                        {
                            BarcodeId = item.BarcodeId;
                            BarcodeNo = item.BarcodeNo;
                        }
                        #endregion

                        #region //先找出目前所有歷屆必要過站製程(含目前製程)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoProcessId
                                FROM MES.MoProcess a 
                                WHERE a.MoId = @MoId
                                AND (
                                    a.SortNumber < (
                                        SELECT x.SortNumber FROM MES.MoProcess x 
                                    WHERE x.MoProcessId = @MoProcessId)
                                    OR a.SortNumber = (
                                        SELECT x.SortNumber FROM MES.MoProcess x 
                                    WHERE x.MoProcessId = @MoProcessId)
                                )";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MoProcessId", CurrentMoProcessId);

                        var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //補足過站歷程相關資料
                        DateTime CurrentCreateDate = CreateDate;
                        DateTime CurrentLastModifiedDate = LastModifiedDate;
                        foreach (var item in MoProcessResult)
                        {
                            CurrentCreateDate = CurrentCreateDate.AddMinutes(10);
                            CurrentLastModifiedDate = CurrentLastModifiedDate.AddMinutes(11);

                            #region //取得來此製程班別及機台
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.MachineId, a.ModeShiftId
                                    FROM MES.BarcodeProcess a 
                                    WHERE MoProcessId = @MoProcessId
                                    AND a.MachineId IS NOT NULL
                                    AND a.ModeShiftId IS NOT NULL";
                            dynamicParameters.Add("MoProcessId", item.MoProcessId);

                            var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            int CurrentMachineId = -1;
                            int CurrentModeShiftId = -1;
                            foreach (var item2 in BarcodeProcessResult)
                            {
                                CurrentMachineId = item2.MachineId;
                                CurrentModeShiftId = item2.ModeShiftId;
                            }
                            #endregion

                            #region //INSERT MES.BarcodeProcess
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, StartDate
                                    , FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeProcessId
                                    VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @StartDate
                                    , @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeId,
                                    MoId,
                                    MachineId = CurrentMachineId,
                                    item.MoProcessId,
                                    ProdStatus = "P",
                                    StationQty = 0,
                                    PassQty = 0,
                                    NgQty = 0,
                                    StartDate = CreateDate,
                                    FinishDate = CurrentLastModifiedDate,
                                    ModeShiftId = CurrentModeShiftId,
                                    CycleTime = 0,
                                    StartUserId = UserId,
                                    FinishUserId = UserId,
                                    CreateDate = CurrentCreateDate,
                                    LastModifiedDate = CurrentLastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();

                            int CurrentBarcodeProcessId = -1;
                            foreach (var item2 in insertResult2)
                            {
                                CurrentBarcodeProcessId = item2.BarcodeProcessId;
                            }
                            #endregion

                            #region //補足BarcodeProcessAttribute資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ItemNo, a.ItemValue, a.ItemSeq
                                    FROM MES.BarcodeProcessAttribute a 
                                    INNER JOIN MES.BarcodeProcess b ON a.BarcodeProcessId = b.BarcodeProcessId
                                    INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                                    WHERE c.BarcodeNo = @BarcodeNo
                                    AND b.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("BarcodeNo", FromBarcodeNo);
                            dynamicParameters.Add("MoProcessId", item.MoProcessId);

                            var BarcodeProcessAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in BarcodeProcessAttributeResult)
                            {
                                #region //INSERT MES.BarcodeProcessAttribute
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeProcessAttribute (BarcodeProcessId, ItemNo, ItemValue, ItemSeq
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeProcessId
                                        VALUES (@BarcodeProcessId, @ItemNo, @ItemValue, @ItemSeq
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeProcessId = CurrentBarcodeProcessId,
                                        item2.ItemNo,
                                        item2.ItemValue,
                                        item2.ItemSeq,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                #endregion
                            }
                            #endregion
                        }
                        #endregion

                        #region //若來源條碼有綁定屬性，自動延續
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ItemNo, a.ItemValue
                                FROM MES.BarcodeAttribute a 
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                WHERE a.MoId = @MoId
                                AND b.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);

                        var BarcodeAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in BarcodeAttributeResult)
                        {
                            #region //INSERT MES.BarcodeAttribute
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeAttribute (MoId, BarcodeId, ItemNo, ItemValue, ItemSeq
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MoId
                                    VALUES (@MoId, @BarcodeId, @ItemNo, @ItemValue, @ItemSeq
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoId,
                                    BarcodeId,
                                    item.ItemNo,
                                    item.ItemValue,
                                    item.ItemSeq,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion
                        }
                        #endregion

                        #region //若為Tray模式，將新產條碼自動綁定到新Tray盤上
                        if (TrayBarcode == "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Tray SET
                                    BarcodeNo = @BarcodeNo,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TrayNo = @NewTrayBarcode";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  BarcodeNo,
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  NewTrayBarcode
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = TrayBarcode == "N" ? NewOutputBarcodeNo : NewTrayBarcode
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBindBarcode-- 新增條碼(數量過站產生條碼用) -- Ann 2023-07-24
        public string AddBindBarcode(int MoProcessId, string BarcodePrefix, string BarcodePostfix, int SequenceLen, int MachineId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        #region //判斷製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId, a.SortNumber
                                , b.LotQty, b.BarcodePrefix, b.BarcodePostfix, b.SequenceLen, b.BarcodeCtrl, b.OutputBarcodeFlag
                                , c.ModeId
                                , a.TotalPassQty - ISNULL((
                                    SELECT SUM(x.MweBarcodeQty)
                                    FROM MES.MweBarcode x 
                                    INNER JOIN MES.MweDetail xa ON x.MweDetailId = xa.MweDetailId
                                    INNER JOIN MES.Barcode xb ON x.BarcodeId = xb.BarcodeId
                                    WHERE xa.MoId = a.MoId
                                    AND xb.CurrentProdStatus != 'S'
                                ), 0) TotalPassQty
                                , (
                                    SELECT ISNULL(SUM(x.BarcodeQty), 0)
                                    FROM MES.Barcode x 
                                    WHERE x.MoId = a.MoId
                                    AND x.CurrentProdStatus = 'P'
                                    AND x.BarcodeStatus != '8'
                                ) PassBindQty
                                , (
                                    SELECT ISNULL(SUM(x.BarcodeQty), 0)
                                    FROM MES.Barcode x 
                                    WHERE x.MoId = a.MoId
                                    AND x.CurrentProdStatus = 'S'
                                    AND x.BarcodeStatus != '8'
                                ) ScrapBindQty
                                , (
                                    SELECT SUM(x.TotalScrapQty) 
                                    FROM MES.MoProcess x
                                    WHERE x.MoId = a.MoId
                                ) - ISNULL((
                                    SELECT SUM(x.MweBarcodeQty)
                                    FROM MES.MweBarcode x 
                                    INNER JOIN MES.MweDetail xa ON x.MweDetailId = xa.MweDetailId
                                    INNER JOIN MES.Barcode xb ON x.BarcodeId = xb.BarcodeId
                                    WHERE xa.MoId = a.MoId
                                    AND xb.CurrentProdStatus = 'S'
                                ), 0) TotalScrapQty
                                FROM MES.MoProcess a
                                INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                INNER JOIN MES.ManufactureOrder c ON a.MoId = c.MoId
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoProcessResult.Count() <= 0) throw new SystemException("製令製程資料有誤!!");

                        int LotQty = -1;
                        int TotalPassQty = -1;
                        int PassBindQty = -1;
                        int TotalScrapQty = -1;
                        int ScrapBindQty = -1;
                        int MoId = -1;
                        int ModeId = -1;
                        int SortNumber = -1;
                        foreach (var item in MoProcessResult)
                        {
                            if (item.BarcodeCtrl != "N") throw new SystemException("此功能僅開放用於數量過站模式!!");
                            if (item.OutputBarcodeFlag != "Y") throw new SystemException("尚未啟用【製程中產生新條碼】功能參數!!");
                            if ((item.TotalPassQty - item.PassBindQty <= 0) && (item.TotalScrapQty - item.ScrapBindQty <= 0)) throw new SystemException("已無剩餘數量可以產生新條碼!!");
                            LotQty = item.LotQty;
                            TotalPassQty = item.TotalPassQty;
                            PassBindQty = item.PassBindQty;
                            TotalScrapQty = item.TotalScrapQty;
                            ScrapBindQty = item.ScrapBindQty;
                            MoId = item.MoId;
                            ModeId = item.ModeId;
                            SortNumber = item.SortNumber;
                        }
                        #endregion

                        #region //確認此製程是否為最後一站
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcess
                                WHERE MoId = @MoId
                                AND SortNumber > @SortNumber
                                AND NecessityStatus = 'Y'";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("SortNumber", SortNumber);

                        var CheckSortNumberResult = sqlConnection.Query(sql, dynamicParameters);

                        if (CheckSortNumberResult.Count() > 0) throw new SystemException("此製程非製令最後一站!!");
                        #endregion

                        #region //取出班別ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ModeShiftId
                                  FROM MES.ProdModeShift a
                                       INNER JOIN BAS.[Shift] b ON a.ShiftId = b.ShiftId
                                WHERE a.ModeId = @ModeId
                                AND ((format(CONVERT(datetime,CONVERT(VARCHAR(10),CONVERT(DATE,GETDATE()),120) + ' ' + @CurrentTime),'HH:mm') between b.WorkBeginTime and b.WorkEndTime) or
                                     (format(dateadd(hour,12,CONVERT(datetime,CONVERT(VARCHAR(10),CONVERT(DATE,GETDATE()),120) + ' ' + @CurrentTime)),'HH:mm') between b.WorkBeginTime and b.WorkEndTime)
                                    )";
                        dynamicParameters.Add("ModeId", ModeId);
                        dynamicParameters.Add("CurrentTime", DateTime.Now.ToString("HH:mm"));

                        var resultShift = sqlConnection.Query(sql, dynamicParameters);
                        if (resultShift.Count() <= 0) throw new SystemException("找不到班別!");

                        int ModeShiftId = -1;
                        foreach (var item in resultShift)
                        {
                            ModeShiftId = Convert.ToInt32(item.ModeShiftId);
                        }
                        #endregion

                        #region //判斷此編碼格式是否有中文
                        string pattern = "[\u4e00-\u9fbb]";
                        if (Regex.IsMatch(BarcodePrefix, pattern) || Regex.IsMatch(BarcodePostfix, pattern)) throw new SystemException("條碼命名格式不能有中文!!");
                        #endregion

                        #region //計算是否有剩餘尾數盤，有的話則先加上去再處理後面數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeQty, a.CurrentProdStatus
                                FROM MES.Barcode a
                                WHERE a.CurrentMoProcessId = @MoProcessId
                                AND a.BarcodeStatus = '0'
                                AND a.BarcodeQty < @LotQty
                                AND NOT EXISTS (
                                    SELECT TOP 1 1
                                    FROM MES.BarcodeAttribute x 
                                    WHERE x.BarcodeId = a.BarcodeId
                                    AND x.MoId = a.MoId
                                )";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        dynamicParameters.Add("LotQty", LotQty);
                        dynamicParameters.Add("CreateDate", DateTime.Now.ToString("yyyy-MM-dd"));

                        var LotBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        int NotBindPassQty = TotalPassQty - PassBindQty;
                        int NotBindScrapQty = TotalScrapQty - ScrapBindQty;
                        foreach (var item in LotBarcodeResult)
                        {
                            if (item.CurrentProdStatus == "P")
                            {
                                NotBindPassQty = CalculateMantissa(item.CurrentProdStatus, NotBindPassQty, item.BarcodeId, item.BarcodeQty);
                            }
                            else if (item.CurrentProdStatus == "S")
                            {
                                NotBindScrapQty = CalculateMantissa(item.CurrentProdStatus, NotBindScrapQty, item.BarcodeId, item.BarcodeQty);
                            }
                            else
                            {
                                throw new SystemException("此狀態無法使用新增條碼功能!!");
                            }
                        }
                        #endregion

                        #region //處理產生條碼部分
                        CalculateLotBarcode("P", NotBindPassQty);
                        CalculateLotBarcode("S", NotBindScrapQty);
                        #endregion

                        int CalculateMantissa(string JudgeFlag, int NotBindQty, int BarcodeId, int BarcodeQty)
                        {
                            if (NotBindQty <= 0) return NotBindQty;

                            if (NotBindQty >= LotQty)
                            {
                                #region //UPDATE MES.Barcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        BarcodeQty = @LotQty,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        LotQty,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //UPDATE MES.BarcodeProcess
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.BarcodeProcess SET
                                        StationQty = @LotQty,
                                        PassQty = @PassQty,
                                        NgQty = @NgQty,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeId = @BarcodeId
                                        AND MoProcessId = @MoProcessId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        LotQty,
                                        PassQty = JudgeFlag == "P" ? LotQty : 0,
                                        NgQty = JudgeFlag == "S" ? LotQty : 0,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeId,
                                        MoProcessId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                NotBindQty -= (LotQty - BarcodeQty);

                                return NotBindQty;
                            }
                            else
                            {
                                //計算此BARCODE還差多少數量
                                int AleardyQty = LotQty - BarcodeQty;
                                if (NotBindQty >= AleardyQty)
                                {
                                    NotBindQty -= AleardyQty;
                                }
                                else
                                {
                                    AleardyQty = NotBindQty;
                                    NotBindQty = 0;
                                }

                                #region //UPDATE MES.Barcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        BarcodeQty += @AleardyQty,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AleardyQty,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //UPDATE MES.BarcodeProcess
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.BarcodeProcess SET
                                        StationQty += @AleardyQty,
                                        PassQty += @PassQty,
                                        NgQty += @NgQty,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeId = @BarcodeId
                                        AND MoProcessId = @MoProcessId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AleardyQty,
                                        PassQty = JudgeFlag == "P" ? AleardyQty : 0,
                                        NgQty = JudgeFlag == "S" ? AleardyQty : 0,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeId,
                                        MoProcessId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                return NotBindQty;
                            }
                        }

                        void CalculateLotBarcode(string JudgeFlag, int NotBindQty)
                        {
                            if (NotBindQty <= 0) return;

                            #region //計算可產生盤數與尾數
                            int LotCount = NotBindQty / LotQty;
                            int Remainder = NotBindQty % LotQty;
                            #endregion

                            #region //新增盤數條碼資料
                            for (int i = 1; i <= LotCount; i++)
                            {
                                string NewBarcodeNo = GetNewBarcodeNo(JudgeFlag, BarcodePrefix, SequenceLen, BarcodePostfix);

                                #region //INSERT MES.Barcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeId
                                        VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = NewBarcodeNo,
                                        CurrentMoProcessId = MoProcessId,
                                        NextMoProcessId = -1,
                                        MoId,
                                        BarcodeQty = LotQty,
                                        BarcodeProcessId = -1,
                                        CurrentProdStatus = JudgeFlag,
                                        BarcodeStatus = "0",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();

                                int BarcodeId = -1;
                                foreach (var item in insertResult)
                                {
                                    BarcodeId = item.BarcodeId;
                                }
                                #endregion

                                #region //INSERT MES.BarcodeProcess
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, StartDate
                                        , FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeProcessId
                                        VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @StartDate
                                        , @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeId,
                                        MoId,
                                        MachineId,
                                        MoProcessId,
                                        ProdStatus = JudgeFlag,
                                        StationQty = LotQty,
                                        PassQty = JudgeFlag == "P" ? LotQty : 0,
                                        NgQty = JudgeFlag == "S" ? LotQty : 0,
                                        StartDate = CreateDate,
                                        FinishDate = CreateDate,
                                        ModeShiftId,
                                        CycleTime = 0,
                                        StartUserId = UserId,
                                        FinishUserId = UserId,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                #endregion
                            }
                            #endregion

                            #region //新增尾數盤
                            if (Remainder > 0)
                            {
                                string NewBarcodeNo = GetNewBarcodeNo(JudgeFlag, BarcodePrefix, SequenceLen, BarcodePostfix);

                                #region //INSERT MES.Barcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeId
                                        VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = NewBarcodeNo,
                                        CurrentMoProcessId = MoProcessId,
                                        NextMoProcessId = -1,
                                        MoId,
                                        BarcodeQty = Remainder,
                                        BarcodeProcessId = -1,
                                        CurrentProdStatus = JudgeFlag,
                                        BarcodeStatus = "0",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult2.Count();

                                int BarcodeId = -1;
                                foreach (var item in insertResult2)
                                {
                                    BarcodeId = item.BarcodeId;
                                }
                                #endregion

                                #region //INSERT MES.BarcodeProcess
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, StartDate
                                        , FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeProcessId
                                        VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @StartDate
                                        , @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeId,
                                        MoId,
                                        MachineId,
                                        MoProcessId,
                                        ProdStatus = JudgeFlag,
                                        StationQty = Remainder,
                                        PassQty = JudgeFlag == "P" ? Remainder : 0,
                                        NgQty = JudgeFlag == "S" ? Remainder : 0,
                                        StartDate = CreateDate,
                                        FinishDate = CreateDate,
                                        ModeShiftId,
                                        CycleTime = 0,
                                        StartUserId = UserId,
                                        FinishUserId = UserId,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult3.Count();
                                #endregion
                            }
                            #endregion
                        }

                        string GetNewBarcodeNo(string JudgeFlag, string thisBarcodePrefix, int thisSequenceLen, string thisBarcodePostfix)
                        {
                            string NewBarcodeNo = "";
                            #region //找此BARCODE格式最大號
                            #region //組模糊查詢字串
                            string SearchLikeStrig = "";
                            for (int j = 1; j <= thisSequenceLen; j++)
                            {
                                SearchLikeStrig += "_";
                            }
                            #endregion

                            if (JudgeFlag == "S")
                            {
                                thisBarcodePrefix = MoProcessId.ToString() + "NG";
                                thisBarcodePostfix = "";
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                    FROM MES.Barcode
                                    WHERE BarcodeNo LIKE '%" + thisBarcodePrefix + SearchLikeStrig + thisBarcodePostfix + "%'";

                            var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            string seq = "";
                            foreach (var item in BarcodeResult)
                            {
                                string MaxBarcodeNo = item.MaxBarcodeNo;
                                if (item.MaxBarcodeNo == null)
                                {
                                    seq = "1".PadLeft(SequenceLen, '0');
                                }
                                else
                                {
                                    #region //拆解BarcodeNo順序
                                    string thisSeq = "";
                                    if (thisBarcodePostfix.Length > 0)
                                    {
                                        thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "").Replace(thisBarcodePostfix, "");
                                    }
                                    else
                                    {
                                        thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "");
                                    }
                                    //if (JudgeFlag == "P") thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "").Replace(thisBarcodePostfix, "");
                                    //else thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "");
                                    seq = (Convert.ToInt32(thisSeq) + 1).ToString().PadLeft(SequenceLen, '0');
                                    #endregion
                                }

                                NewBarcodeNo = thisBarcodePrefix + seq + thisBarcodePostfix;
                            }
                            #endregion

                            return NewBarcodeNo;
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddPackageBarcode --新增包裝條碼 --Gpai 2022-04-20
        public string AddPackageBarcode(int MoProcessId, int MoId, string CreatDate)
        {
            try
            {
                int UserId = CreateBy;
                int LastPackageBarcodeId = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷該站是否可包裝
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT PackageFlag FROM MES.MoProcess WHERE MoProcessId = @MoProcessId AND PackageFlag = 'Y'";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result0 = sqlConnection.Query(sql, dynamicParameters);
                        if (result0.Count() <= 0) throw new SystemException("該站無法包裝!");
                        #endregion

                        #region //取得該製令包裝條碼並取得最新ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT PackageBarcodeId, PackageBarcodeNo
                                FROM MES.PackageBarcode
                                WHERE MoProcessId = @MoProcessId
                                ORDER BY PackageBarcodeId DESC";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            LastPackageBarcodeId = 0;
                        }
                        else
                        {
                            var packageBarcodeNoPrefix = result.First().PackageBarcodeNo.Substring(0, result.First().PackageBarcodeNo.Length - 3);
                            string maxBarcodeNo = result.First().PackageBarcodeNo;
                            var maxBarcodeNo2 = maxBarcodeNo.Substring(packageBarcodeNoPrefix.Length, 3);
                            var maxBarcodeNum = int.Parse(maxBarcodeNo2) + 1;
                            LastPackageBarcodeId = maxBarcodeNum;

                        }
                        #endregion

                        #region //新增包裝條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.PackageBarcode (CompanyId, PackageBarcodeNo, MoProcessId, Quantity,
                                [Status], CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.PackageBarcodeId
                                VALUES (@CompanyId, @PackageBarcodeNo, @MoProcessId, @Quantity,
                                @Status, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        int NextPackageBarcodeId = (LastPackageBarcodeId + 1);
                        string ttttf = string.Format("{0:000}", NextPackageBarcodeId); 
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                PackageBarcodeNo = "P-" + MoId + "-" + CreatDate + "-" + ttttf,
                                MoProcessId,
                                Quantity = 0,
                                Status = '1',
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region // AddPackageProductBarcode --新增該包裝條碼產品條碼 --Gpai 2022-04-20
        public string AddPackageProductBarcode(int PackageBarcodeId, string BarcodeList, int MoId, int CurrenMoProcess)
        {
            try
            {
                int UserId = CreateBy;
                int BarcodeId = 0;
                var BarcodeNoList = BarcodeList.Split(',');
                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {



                        foreach (var barcodeNo in BarcodeNoList)
                        {
                            string BarcodeNo = barcodeNo;
                            string No = "";
                            string TrayNo = "";

                            #region //判斷是否為Tray盤條碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT BarcodeNo
                                FROM MES.Tray
                                WHERE TrayNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var result0 = sqlConnection.Query(sql, dynamicParameters);
                            if (result0.Count() > 0)
                            {
                                TrayNo = result0.First().BarcodeNo;
                            }
                            else
                            {
                                No = BarcodeNo;
                            }
                            #endregion

                            #region //判斷該條碼是否屬於該製令底下
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.CurrentProdStatus, a.BarcodeQty, b.TrayBarcode, a.BarcodeStatus
                                FROM MES.Barcode a
                                INNER JOIN MES.MoSetting b ON b.MoId = a.MoId
                                WHERE b.MoId = @MoId AND a.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("BarcodeNo", TrayNo != "" ? TrayNo : No);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("條碼不屬於該製令，請重新輸入!");
                            if (result.First().TrayBarcode != "Y")
                            {
                                if (TrayNo != "") throw new SystemException("該製令不可刷Tray盤條碼，請重新輸入!");
                            }
                            //判斷該條碼是否良品
                            if (result.First().CurrentProdStatus != "P") throw new SystemException("該產品非良品，請重新輸入!");
                            if (result.First().BarcodeStatus == "8") throw new SystemException("該產品已入庫，請重新輸入!");
                            BarcodeId = result.First().BarcodeId;
                            #endregion

                            #region //判斷該條碼是否被綁過
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.PackageBarcodeId,b.PackageBarcodeNo,b.Status,c.BarcodeId,c.BarcodeNo,c.CurrentMoProcessId
                                FROM MES.PackageBarcodeReference a
                                INNER JOIN MES.PackageBarcode b ON b.PackageBarcodeId = a.PackageBarcodeId
                                INNER JOIN MES.Barcode c ON c.BarcodeId = a.BarcodeId
                                WHERE c.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", No);
                            var result1 = sqlConnection.Query(sql, dynamicParameters);
                            if (result1.Count() > 0)
                            {
                                foreach (var i in result1)
                                {
                                    if (i.PackageBarcodeId == PackageBarcodeId)
                                    {
                                        if (i.Status == "1") throw new SystemException("條碼已包裝，請重新輸入!");
                                        if (i.Status == "2") throw new SystemException("條碼已包裝，請重新輸入!");
                                    }
                                    else
                                    {
                                        if (i.Status == "1") throw new SystemException("條碼已包裝，請重新輸入!");
                                        if (i.Status == "2") throw new SystemException("條碼已包裝，請重新輸入!");
                                    }

                                }

                            }
                            #endregion

                            #region //判斷條碼是否完工
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 *
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId AND a.MoProcessId = b.CurrentMoProcessId
                                WHERE b.BarcodeNo = @BarcodeNo
                                AND a.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", No);
                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0) throw new SystemException("條碼未完工，請重新輸入!");

                            #endregion

                            #region //是否與包裝同製程
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT *
                                FROM MES.PackageBarcode a
                                LEFT JOIN MES.Barcode b ON b.CurrentMoProcessId = a.MoProcessId
                                WHERE a.PackageBarcodeId = @PackageBarcodeId AND b.CurrentMoProcessId = @CurrentMoProcessId";
                            dynamicParameters.Add("PackageBarcodeId", PackageBarcodeId);
                            dynamicParameters.Add("CurrentMoProcessId", CurrenMoProcess);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("條碼與包裝需同製程，請重新輸入!");
                            #endregion

                            #region //新增產品條碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.PackageBarcodeReference (PackageBarcodeId, BarcodeId, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.PbrId
                                VALUES (@PackageBarcodeId, @BarcodeId,
                                @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    PackageBarcodeId,
                                    BarcodeId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            rowsAffected += insertResult.Count();
                            //更新產品條碼數


                        }
                        UpdatePackageBarcodeProductQty(PackageBarcodeId);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region // AddPackageTrayProductBarcode --新增該包裝條碼產品條碼 --Gpai 2022-04-20
        public string AddPackageTrayProductBarcode(int PackageBarcodeId, string BarcodeList, int MoId, int CurrenMoProcess)
        {
            try
            {
                int UserId = CreateBy;
                int BarcodeId = 0;
                var BarcodeNoList = BarcodeList.Split(',');
                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {



                        foreach (var barcodeNo in BarcodeNoList)
                        {
                            string BarcodeNo = barcodeNo;
                            string No = "";
                            string TrayNo = "";

                            #region //判斷是否為Tray盤條碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT BarcodeNo
                                FROM MES.Tray
                                WHERE TrayNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var result0 = sqlConnection.Query(sql, dynamicParameters);
                            if (result0.Count() > 0)
                            {
                                TrayNo = result0.First().BarcodeNo;
                            }
                            else
                            {
                                No = BarcodeNo;
                            }
                            #endregion

                            #region //判斷該條碼是否屬於該製令底下
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.CurrentProdStatus, a.BarcodeQty, b.TrayBarcode, a.BarcodeStatus
                                FROM MES.Barcode a
                                INNER JOIN MES.MoSetting b ON b.MoId = a.MoId
                                WHERE b.MoId = @MoId AND a.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("BarcodeNo", TrayNo != "" ? TrayNo : No);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("條碼不屬於該製令，請重新輸入!");
                            if (result.First().TrayBarcode != "Y")
                            {
                                if (TrayNo != "") throw new SystemException("該製令不可刷Tray盤條碼，請重新輸入!");
                            }
                            //判斷該條碼是否良品
                            if (result.First().CurrentProdStatus != "P") throw new SystemException("該產品非良品，請重新輸入!");
                            if (result.First().BarcodeStatus == "8") throw new SystemException("該產品已入庫，請重新輸入!");
                            BarcodeId = result.First().BarcodeId;
                            #endregion

                            #region //判斷該條碼是否被綁過
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.PackageBarcodeId,b.PackageBarcodeNo,b.Status,c.BarcodeId,c.BarcodeNo,c.CurrentMoProcessId
                                FROM MES.PackageBarcodeReference a
                                INNER JOIN MES.PackageBarcode b ON b.PackageBarcodeId = a.PackageBarcodeId
                                INNER JOIN MES.Barcode c ON c.BarcodeId = a.BarcodeId
                                WHERE c.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", No);
                            var result1 = sqlConnection.Query(sql, dynamicParameters);
                            if (result1.Count() > 0)
                            {
                                foreach (var i in result1)
                                {
                                    if (i.PackageBarcodeId == PackageBarcodeId)
                                    {
                                        if (i.Status == "1") throw new SystemException("條碼已包裝，請重新輸入!");
                                        if (i.Status == "2") throw new SystemException("條碼已包裝，請重新輸入!");
                                    }
                                    else
                                    {
                                        if (i.Status == "1") throw new SystemException("條碼已包裝，請重新輸入!");
                                        if (i.Status == "2") throw new SystemException("條碼已包裝，請重新輸入!");
                                    }

                                }

                            }
                            #endregion

                            #region //判斷條碼是否完工
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 *
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId AND a.MoProcessId = b.CurrentMoProcessId
                                WHERE b.BarcodeNo = @BarcodeNo
                                AND a.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", No);
                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0) throw new SystemException("條碼未完工，請重新輸入!");

                            #endregion

                            #region //是否與包裝同製程
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT *
                                FROM MES.PackageBarcode a
                                LEFT JOIN MES.Barcode b ON b.CurrentMoProcessId = a.MoProcessId
                                WHERE a.PackageBarcodeId = @PackageBarcodeId AND b.CurrentMoProcessId = @CurrentMoProcessId";
                            dynamicParameters.Add("PackageBarcodeId", PackageBarcodeId);
                            dynamicParameters.Add("CurrentMoProcessId", CurrenMoProcess);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("條碼與包裝需同製程，請重新輸入!");
                            #endregion

                            #region //新增產品條碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.PackageBarcodeReference (PackageBarcodeId, BarcodeId, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.PbrId
                                VALUES (@PackageBarcodeId, @BarcodeId,
                                @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    PackageBarcodeId,
                                    BarcodeId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            rowsAffected += insertResult.Count();
                            //更新產品條碼數


                        }
                        UpdatePackageBarcodeProductQty(PackageBarcodeId);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddStartCoutTime --新增事件開始資料(機台/加工) GPai 20230803
        public string AddStartCoutTime(int EventItemId, int BarcodeId, int MoProcessId, string StartTime, string CountType)
        {
            try
            {
                var UserId = CreateBy;
                int StartBarcodeProcessId = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region // 確認事件資料
                        switch (CountType)
                        {
                            case "machineTime":
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT * 
                                FROM MES.MachineEventItem
                                WHERE MachineEventItemId = @MachineEventItemId";
                                dynamicParameters.Add("MachineEventItemId", EventItemId);
                                break;
                            case "before":
                            case "after":
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT * 
                                FROM MES.ProcessEventItem
                                WHERE ProcessEventItemId = @ProcessEventItemId";
                                dynamicParameters.Add("ProcessEventItemId", EventItemId);
                                break;

                        }
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("查無事件資料!");
                        #endregion

                        if (BarcodeId > 0)
                        {
                            #region //條碼生產過站資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.BarcodeProcessId
                            FROM MES.BarcodeProcess a
                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                            WHERE b.BarcodeId = @BarcodeId AND MoProcessId = @MoProcessId
                            ORDER BY BarcodeProcessId DESC";
                            dynamicParameters.Add("BarcodeId", BarcodeId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var barcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            if (barcodeProcessResult.Count() <= 0) throw new SystemException("查無過站資訊!");
                            StartBarcodeProcessId = barcodeProcessResult.First().BarcodeProcessId;
                            #endregion

                        }


                        #region //新增
                        switch (CountType)
                        {
                            case "machineTime":
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.MachineEvent (MachineEventItemId, StartDate, Operator, CreateDate, CreateBy)
                                OUTPUT INSERTED.MachineEventId EventId
                                VALUES (@MachineEventItemId, @StartDate, @Operator,
                                @CreateDate, @CreateBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MachineEventItemId = EventItemId,
                                        StartDate = StartTime,
                                        Operator = UserId,
                                        //BarcodeId,
                                        CreateDate,
                                        //LastModifiedDate,
                                        CreateBy = UserId,
                                        //LastModifiedBy = UserId
                                    });
                                break;
                            case "before":
                            case "after":
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeProcessEvent (ProcessEventItemId, BarcodeProcessId, StartDate, OperatorId, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeEventId EventId
                                VALUES (@ProcessEventItemId, @BarcodeProcessId, @StartDate, @OperatorId,
                                @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ProcessEventItemId = EventItemId,
                                        BarcodeProcessId = StartBarcodeProcessId,
                                        StartDate = StartTime,
                                        OperatorId = UserId,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });
                                break;

                        }

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddManStartCoutTime --新增事件開始資料(人員) GPai20230803
        public string AddManStartCoutTime(int EventItemId, string StartTime, string CountType)
        {
            try
            {
                var UserId = CreateBy;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region // 確認事件資料
                        switch (CountType)
                        {
                            case "manTime":
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT * 
                                FROM MES.UserEventItem
                                WHERE UserEventItemId = @UserEventItemId";
                                dynamicParameters.Add("UserEventItemId", EventItemId);
                                break;
                                

                        }
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("查無事件資料!");
                        #endregion


                        #region //確認該人員是否有未結束事件
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                    FROM MES.UserEvent a
                                    WHERE a.Operator = @Operator AND a.FinishDate IS NULL
                                    ORDER BY a.UserEventId DESC";
                        dynamicParameters.Add("Operator", UserId);

                        var userEventResult = sqlConnection.Query(sql, dynamicParameters);
                        if (userEventResult.Count() > 1) throw new SystemException("該人員有超過一件以上未結束事件!");
                        #endregion

                        #region //新增
                        switch (CountType)
                        {
                            case "manTime":
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.UserEvent (UserEventItemId, StartDate, Operator, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.UserEventId EventId
                                VALUES (@UserEventItemId, @StartDate, @Operator,
                                @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        UserEventItemId = EventItemId,
                                        StartDate = StartTime,
                                        Operator = UserId,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });
                                break;
                        }

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //物料載盤
        #region //AddVehicleDetail-- 新增物料載盤詳細資料 -- Ann 2024-05-24
        public string AddVehicleDetail(string VehicleNo, int MoProcessId, string BarcodeNo, string LotNumberNo, string BindType, int MtlItemId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            int UserId = CreateBy;
                            int rowsAffected = 0;

                            #region //判斷載盤資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.VehicleId, a.[Status]
                                    FROM MES.Vehicle a 
                                    WHERE a.VehicleNo = @VehicleNo
                                    AND a.CompanyId = @CompanyId";
                            dynamicParameters.Add("VehicleNo", VehicleNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var VehicleResult = sqlConnection.Query(sql, dynamicParameters);

                            if (VehicleResult.Count() <= 0) throw new SystemException("載盤資料錯誤!!");

                            int VehicleId = -1;
                            foreach (var item in VehicleResult)
                            {
                                if (item.Status != "A") throw new SystemException("載盤目前狀態非啟用中!!");
                                VehicleId = item.VehicleId;
                            }
                            #endregion

                            #region //判斷製令製程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoId
                                    FROM MES.MoProcess a 
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MoProcessResult.Count() <= 0) throw new SystemException("製令製程資料錯誤!!");

                            int MoId = -1;
                            foreach (var item in MoProcessResult)
                            {
                                MoId = item.MoId;
                            }
                            #endregion

                            #region //檢查物料品號是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemNo, a.TransferStatus
                                    FROM PDM.MtlItem a 
                                    WHERE a.MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var MtlItemResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MtlItemResult.Count() <= 0) throw new SystemException("物料品號資料錯誤!!");

                            string MtlItemNo = "";
                            foreach (var item in MtlItemResult)
                            {
                                if (item.TransferStatus != "Y") throw new SystemException("此品號尚未拋轉到ERP，無法使用!!");
                                MtlItemNo = item.MtlItemNo;
                            }
                            #endregion

                            #region //檢核此物料是否尚未註冊載盤
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.VehicleDetail a  
                                    WHERE a.VehicleId = @VehicleId 
                                    AND a.MoProcessId = @MoProcessId
                                    AND a.MtlItemId = @MtlItemId
                                    AND (a.ExpirationDate IS NULL OR a.[Status] = 'A')";
                            dynamicParameters.Add("VehicleId", VehicleId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var VehicleDetailCheckResult = sqlConnection.Query(sql, dynamicParameters);

                            if (VehicleDetailCheckResult.Count() > 0) throw new SystemException("此物料已註冊!!");
                            #endregion

                            #region //檢核此載盤是否已在別的製程註冊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.VehicleId, b.ProcessAlias, (d.WoErpPrefix + '-' + d.WoErpNo) WoErpFullNo
                                    FROM MES.VehicleDetail a 
									INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
									INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
									INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                    WHERE a.VehicleId = @VehicleId
                                    AND a.MoProcessId != @MoProcessId
                                    AND (a.ExpirationDate IS NULL OR a.[Status] != 'S')";
                            dynamicParameters.Add("VehicleId", VehicleId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var VehicleDetailMoProcessCheckResult = sqlConnection.Query(sql, dynamicParameters);

                            if (VehicleDetailMoProcessCheckResult.Count() > 0) throw new SystemException("此載盤已在其他製程綁定物料!! 製令: " + VehicleDetailMoProcessCheckResult.FirstOrDefault().WoErpFullNo + " 製程: " + VehicleDetailMoProcessCheckResult.FirstOrDefault().ProcessAlias);
                            #endregion

                            #region //檢查相對應之物料條件
                            int LotNumberId = -1;
                            if (BindType == "B")
                            {
                                #region //檢查條碼是否符合相關上料必備條件
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.LotNumberId, b.LotNumberNo
                                        FROM SCM.LnBarcode a 
                                        INNER JOIN SCM.LotNumber b ON a.LotNumberId = b.LotNumberId
                                        INNER JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo
                                        INNER JOIN MES.WoDetail d ON b.MtlItemId = d.MtlItemId
                                        INNER JOIN MES.MoMtlSetting e ON e.WoDetailId = d.WoDetailId
                                        WHERE a.BarcodeNo = @BarcodeNo
                                        AND e.MoId = @MoId
                                        AND (
                                            (c.MoId IS NULL AND c.BarcodeStatus = '8')
                                            OR 
                                            (c.MoId = e.MoId AND c.BarcodeStatus = '3')
                                        )
                                        AND c.CurrentProdStatus = 'P'
                                        AND e.BindType = 'B'
                                        AND e.ProcessBinding = 'Y'
                                        AND e.MoProcessId = @MoProcessId
                                        AND b.MtlItemId = @MtlItemId";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                dynamicParameters.Add("MtlItemId", MtlItemId);

                                var LnBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                if (LnBarcodeResult.Count() <= 0) throw new SystemException("此條碼不符合上料所需條件!!");

                                foreach (var item in LnBarcodeResult)
                                {
                                    LotNumberId = item.LotNumberId;
                                    LotNumberNo = item.LotNumberNo;
                                }
                                #endregion

                                #region //檢核領料單是否已綁定此批號
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.MrDetail a 
                                        WHERE a.MoId = @MoId
                                        AND a.MtlItemId = @MtlItemId
                                        AND a.LotNumber = @LotNumberNo";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                dynamicParameters.Add("LotNumberNo", LotNumberNo);

                                var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MrDetailResult.Count() <= 0) throw new SystemException("此條碼批號【" + LotNumberNo + "】尚未綁定製令領料單!!");
                                #endregion

                                #region //檢核此條碼批號是否已被載盤綁定
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.VehicleNo
                                        FROM MES.VehicleDetail a
                                        INNER JOIN MES.Vehicle b ON a.VehicleId = b.VehicleId 
                                        WHERE a.VehicleId = @VehicleId
                                        AND a.MoProcessId = @MoProcessId
                                        AND (a.BarcodeNo = @BarcodeNo OR a.LotNumberId = @LotNumberId)
                                        AND (a.ExpirationDate IS NULL OR a.[Status] != 'S')";
                                dynamicParameters.Add("VehicleId", VehicleId);
                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                dynamicParameters.Add("LotNumberId", LotNumberId);

                                var VehicleDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                if (VehicleDetailResult.Count() > 0)
                                {
                                    foreach (var item in VehicleDetailResult)
                                    {
                                        throw new SystemException("此條碼批號【" + LotNumberNo + "】已被綁定在物料盤【" + item.VehicleNo + "】!!");
                                    }
                                }
                                #endregion
                            }
                            else if (BindType == "L")
                            {
                                #region //檢查批號是否符合上料所需相關條件
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT d.LotNumberId
                                        FROM MES.MrDetail a 
                                        INNER JOIN MES.MoMtlSetting b ON a.MoId = b.MoId
                                        INNER JOIN MES.WoDetail c ON b.WoDetailId = c.WoDetailId AND c.MtlItemId = a.MtlItemId
                                        INNER JOIN SCM.LotNumber d ON a.MtlItemId = d.MtlItemId AND a.LotNumber = d.LotNumberNo
                                        WHERE a.MoId = @MoId 
                                        AND a.MtlItemId = @MtlItemId 
                                        AND a.LotNumber = @LotNumberNo 
                                        AND b.BindType = 'L'
                                        AND b.ProcessBinding = 'Y'
                                        AND b.MoProcessId = @MoProcessId";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                dynamicParameters.Add("LotNumberNo", LotNumberNo);
                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MrDetailResult.Count() <= 0) throw new SystemException("此批號不符合上料所需條件!!");

                                foreach (var item in MrDetailResult)
                                {
                                    LotNumberId = item.LotNumberId;
                                }
                                #endregion
                            }
                            else
                            {
                                throw new SystemException("上料類型錯誤!!");
                            }
                            #endregion

                            #region //檢核此條碼批號還未被上料設定綁定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeComponent a 
                                    LEFT JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                    WHERE b.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                            if (BarcodeComponentResult.Count() > 0) throw new SystemException("此批號條碼已被註冊上料!!");
                            #endregion

                            #region //INSERT MES.VehicleDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.VehicleDetail (VehicleId, MoProcessId, MtlItemId, BarcodeNo, LotNumberId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@VehicleId, @MoProcessId, @MtlItemId, @BarcodeNo, @LotNumberId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    VehicleId,
                                    MoProcessId,
                                    MtlItemId,
                                    BarcodeNo = BarcodeNo.Length > 0 ? BarcodeNo : null,
                                    LotNumberId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //UPDATE MES.Barcode
                            if (BarcodeNo.Length > 0)
                            {
                                #region //取得此製令第一站
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MoProcessId
                                        FROM MES.MoProcess a 
                                        WHERE a.MoId = @MoId
                                        ANd a.SortNumber = (
                                            SELECT MIN(x.SortNumber)
                                            FROM MES.MoProcess x 
                                            WHERE x.MoId = a.MoId
                                            AND x.NecessityStatus = 'Y'
                                        )";
                                dynamicParameters.Add("MoId", MoId);

                                var MoProcessIdResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MoProcessIdResult.Count() <= 0) throw new SystemException("製令製程錯誤!!");

                                int minMoProcessId = -1;
                                foreach (var item in MoProcessIdResult)
                                {
                                    minMoProcessId = item.MoProcessId;
                                }
                                #endregion

                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        CurrentMoProcessId = @minMoProcessId,
                                        NextMoProcessId = @minMoProcessId,
                                        MoId = @MoId,
                                        BarcodeStatus = '1',
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MoId,
                                        minMoProcessId,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeNo
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            }
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion 

        #region //AddMtfProcessTemp -- MTF量測參數暫存新增 -- Luca 2024.09.09
        public void AddMtfProcessTemp(int BarcodeProcessId, int MachineId, string StartDate, string FinishDate)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {  
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MtfProcessTemp (BarcodeProcessId, MachineId, StartDate, FinishDate
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MtfProcessTempId
                                VALUES (@BarcodeProcessId, @MachineId, @StartDate, @FinishDate
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeProcessId,
                                MachineId,
                                StartDate,
                                FinishDate,                                
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        int rowsAffected = insertResult.Count();
                        if (rowsAffected != 1) throw new SystemException("MTF量測參數暫存新增失敗!");

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }            
        }
        #endregion

        #region //AddMaterialFeedReg -- 新增投料登记 Jean 2025-06-02
        public string AddMaterialFeedReg(int MachineId, int MoId, int MaterialId, double MatInRegQty, int UomId, string Remarks)
        {
            try 
            {
                if (MachineId <= 0) throw new SystemException("【機台】不能為空!");
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                if (MaterialId <= 0) throw new SystemException("【材料】不能為空!");
                if (MatInRegQty == 0) throw new SystemException("【投料數量】不能為0!");
                if (UomId <= 0) throw new SystemException("【單位】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();


                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MaterialFeedReg ( MachineId, MoId, MaterialId, MatInRegQty, UomId, Remarks, Status, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MatFeedRegId
                                VALUES (@MachineId, @MoId, @MaterialId, @MatInRegQty, @UomId , @Remarks ,'A', @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MachineId,
                                MoId,
                                MaterialId,
                                MatInRegQty,
                                UomId,
                                Remarks,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion



        #endregion

        #region //工程檢
        #region //AddTempQcMeasureData-- 新增工程檢量測備份資料 -- Ann 2022-10-06
        public string AddTempQcMeasureData(string TempQcItemData, int MoId)
        {
            try
            {
                if (TempQcItemData.Length <= 0) throw new SystemException("【量測資料】不能為空!");
                int UserId = CreateBy;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder a
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoIdResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoIdResult.Count() <= 0) throw new SystemException("製令資料錯誤!");
                        #endregion

                        var TempQcItemJson = JObject.Parse(TempQcItemData);
                        int rowsAffected = 0;
                        dynamicParameters = new DynamicParameters();

                        List<int> barcodeIdList = new List<int>();
                        int BarcodeId = -1;
                        bool firstbool = false;
                        foreach (var item in TempQcItemJson["tempQcItemInfo"])
                        {
                            if (item["MeasureValue"].ToString().Length <= 0) throw new SystemException("量測值不能為空!");
                            #region //判斷量測設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QcNoticeItemSpec
                                    WHERE QcNoticeItemSpecId = @QcNoticeItemSpecId";
                            dynamicParameters.Add("QcNoticeItemSpecId", Convert.ToInt32(item["QcNoticeItemSpecId"]));

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("量測設定資料錯誤!");
                            #endregion

                            #region //判斷製令製程資料是否正確
                            if (item["MoProcessId"] != null)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcess
                                    WHERE MoProcessId = @MoProcessId";
                                dynamicParameters.Add("MoProcessId", Convert.ToInt32(item["MoProcessId"]));

                                var result2 = sqlConnection.Query(sql, dynamicParameters);
                                if (result2.Count() <= 0) throw new SystemException("製令製程資料錯誤!");
                            }
                            #endregion

                            #region //判斷條碼資料是否正確
                            if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 BarcodeId
                                        FROM MES.Barcode
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item["BarcodeNo"].ToString());

                                var result3 = sqlConnection.Query(sql, dynamicParameters);
                                if (result3.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                                foreach (var item2 in result3)
                                {
                                    BarcodeId = item2.BarcodeId;
                                }

                                if (!barcodeIdList.Contains(BarcodeId))
                                {
                                    #region //先將原本的暫存資料刪除(有條碼)
                                    dynamicParameters = new DynamicParameters();
                                    if (item["MoProcessId"] != null)
                                    {
                                        sql = @"DELETE QMS.TempQcMeasureData
                                                WHERE BarcodeId = @BarcodeId
                                                AND MoProcessId = @MoProcessId";
                                        dynamicParameters.Add("BarcodeId", BarcodeId);
                                        dynamicParameters.Add("MoProcessId", Convert.ToInt32(item["MoProcessId"]));
                                    }
                                    else
                                    {
                                        sql = @"DELETE QMS.TempQcMeasureData
                                                WHERE BarcodeId = @BarcodeId
                                                AND MoProcessId IS NULL";
                                        dynamicParameters.Add("BarcodeId", BarcodeId);
                                    }

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    barcodeIdList.Add(BarcodeId);
                                }
                            }
                            else
                            {
                                if (firstbool == false)
                                {
                                    #region //先將原本的暫存資料刪除(無條碼)
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE QMS.TempQcMeasureData
                                        WHERE QcNoticeItemSpecId = @QcNoticeItemSpecId
                                        AND BarcodeId IS NULL";
                                    dynamicParameters.Add("QcNoticeItemSpecId", Convert.ToInt32(item["QcNoticeItemSpecId"]));

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    firstbool = true;
                                }
                            }
                            #endregion

                            #region //判斷量測項目資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QcItem
                                    WHERE QcItemId = @QcItemId";
                            dynamicParameters.Add("QcItemId", Convert.ToInt32(item["QcItemId"]));

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("量測項目資料錯誤!");
                            #endregion

                            #region //判斷量測機型資料是否正確
                            if (Convert.ToInt32(item["QcMachineModeId"]) > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM QMS.QcMachineMode
                                        WHERE QcMachineModeId = @QcMachineModeId";
                                dynamicParameters.Add("QcMachineModeId", Convert.ToInt32(item["QcMachineModeId"]));

                                var result5 = sqlConnection.Query(sql, dynamicParameters);
                                if (result5.Count() <= 0) throw new SystemException("量測機型資料錯誤!");
                            }
                            #endregion

                            #region //判斷量測機台資料是否正確
                            if (Convert.ToInt32(item["QmmDetailId"]) > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM QMS.QmmDetail
                                        WHERE QmmDetailId = @QmmDetailId";
                                dynamicParameters.Add("QmmDetailId", Convert.ToInt32(item["QmmDetailId"]));

                                var result6 = sqlConnection.Query(sql, dynamicParameters);
                                if (result6.Count() <= 0) throw new SystemException("量測機台資料錯誤!");
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO QMS.TempQcMeasureData (QcNoticeItemSpecId, BarcodeId, MoId, MoProcessId, QmmDetailId, MeasureValue, MakeCount, Status, Remark
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.TempQmdId
                                    VALUES (@QcNoticeItemSpecId, @BarcodeId, @MoId, @MoProcessId, @QmmDetailId, @MeasureValue, @MakeCount, @Status, @Remark
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcNoticeItemSpecId = Convert.ToInt32(item["QcNoticeItemSpecId"]),
                                    BarcodeId = BarcodeId > 0 ? BarcodeId : (int?)null,
                                    MoId,
                                    MoProcessId = item["MoProcessId"] != null ? Convert.ToInt32(item["MoProcessId"]) : (int?)null,
                                    QmmDetailId = Convert.ToInt32(item["QmmDetailId"]) > 0 ? Convert.ToInt32(item["QmmDetailId"]) : (int?)null,
                                    MeasureValue = item["MeasureValue"].ToString(),
                                    Status = "A",
                                    MakeCount = Convert.ToInt32(item["MakeCount"]),
                                    Remark = item["Remark"].ToString(),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = Convert.ToInt32(item["CreateUserId"]) == UserId ? UserId : Convert.ToInt32(item["CreateUserId"]),
                                    LastModifiedBy = Convert.ToInt32(item["CreateUserId"]) == UserId ? LastModifiedBy : Convert.ToInt32(item["CreateUserId"])
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddQcRecord-- 新增工程檢紀錄 + 上傳量測數據 + 自動建立品異單 -- Ann 2022-10-07
        public string AddQcRecord(string BarcodeQcRecordData, int MoId, int? MoProcessId, string TempQcItemData)
        {
            try
            {
                if (BarcodeQcRecordData.Length <= 0) throw new SystemException("【上傳數據】不能為空!");
                int ProgrammerUserId = -1;
                var barcodeQcRecordJson = JObject.Parse(BarcodeQcRecordData);
                Dictionary<string, int> qcRecord = new Dictionary<string, int>();
                Dictionary<int, int> qcBarcodeList = new Dictionary<int, int>();
                List<int?> barcodeIdList = new List<int?>();
                int rowsAffected = 0;
                int? BarcodeId = -1;
                int BarcodeProcessId = -1;
                int qcRecordCount = 0;
                int qcRecordId = -1;
                string ProcessCheckType = "";
                int QcNoticeId = -1;
                string qcCauseJsonString = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //建立QcRecord
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        foreach (var item in barcodeQcRecordJson["barcodeQcRecordInfo"])
                        {
                            QcNoticeId = Convert.ToInt32(item["QcNoticeId"]);
                            if (item["QcStatus"].ToString().Length <= 0) throw new SystemException("【人員判斷】不能為空!");

                            #region //判斷量測通知單資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QcNotice
                                    WHERE QcNoticeId = @QcNoticeId";
                            dynamicParameters.Add("QcNoticeId", Convert.ToInt32(item["QcNoticeId"]));

                            var qcNoticeResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //判斷條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 BarcodeId, BarcodeQty
                                    FROM MES.Barcode
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", item["BarcodeNo"].ToString());

                            var result7 = sqlConnection.Query(sql, dynamicParameters);
                            if (result7.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                            int BarcodeQty = -1;
                            foreach (var item2 in result7)
                            {
                                BarcodeId = item2.BarcodeId;
                                BarcodeQty = item2.BarcodeQty;
                                barcodeIdList.Add(BarcodeId);
                            }
                            #endregion

                            if (item["SubResponsibleDeptId"].ToString().Length > 0)
                            {
                                #region //判斷副責任單位資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM BAS.Department
                                        WHERE DepartmentId = @DepartmentId";
                                dynamicParameters.Add("DepartmentId", Convert.ToInt32(item["SubResponsibleDeptId"]));

                                var result9 = sqlConnection.Query(sql, dynamicParameters);
                                if (result9.Count() <= 0) throw new SystemException("副責任單位資料錯誤!");
                                #endregion
                            }

                            if (item["SubResponsibleUserId"].ToString().Length > 0)
                            {
                                #region //判斷副責任者資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM BAS.[User]
                                        WHERE UserId = @UserId";
                                dynamicParameters.Add("UserId", Convert.ToInt32(item["SubResponsibleUserId"]));

                                var result10 = sqlConnection.Query(sql, dynamicParameters);
                                if (result10.Count() <= 0) throw new SystemException("副責任者資料錯誤!");
                                #endregion
                            }

                            #region //判斷製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.ManufactureOrder
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var result11 = sqlConnection.Query(sql, dynamicParameters);
                            if (result11.Count() <= 0) throw new SystemException("製令資料錯誤!");
                            #endregion

                            #region //判斷製令製程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ProcessCheckType
                                    FROM MES.MoProcess
                                    WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var result12 = sqlConnection.Query(sql, dynamicParameters);
                            if (result12.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                            foreach (var item2 in result12)
                            {
                                ProcessCheckType = item2.ProcessCheckType;
                            }
                            #endregion

                            #region //取得BarcodeProcess資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.BarcodeProcessId, a.PassQty, a.NgQty
                                    , b.QcBarcodeId, b.QcStatus
                                    FROM MES.BarcodeProcess a
                                    LEFT JOIN MES.QcBarcode b ON b.BarcodeProcessId = a.BarcodeProcessId
                                    AND b.QcBarcodeId = (
                                      SELECT TOP 1 ba.QcBarcodeId
                                      FROM MES.QcBarcode ba
                                      WHERE ba.BarcodeProcessId = a.BarcodeProcessId
                                      ORDER BY ba.CreateDate DESC
                                    )
                                    INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                    WHERE a.MoId = @MoId
                                    AND a.MoProcessId = @MoProcessId
                                    AND a.BarcodeId = @BarcodeId
                                    AND a.FinishDate IS NOT NULL
                                    AND c.CurrentProdStatus = 'P'
                                    ORDER BY a.FinishDate DESC";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            dynamicParameters.Add("BarcodeId", BarcodeId);

                            var result13 = sqlConnection.Query(sql, dynamicParameters);
                            if (result13.Count() <= 0) throw new SystemException("製令歷程資料錯誤!");

                            int barcodeProcessPassQty = -1;
                            int barcodeProcessNgQty = -1;
                            foreach (var item2 in result13)
                            {
                                if (item2.QcStatus != null && item2.QcStatus != "M")
                                {
                                    throw new SystemException("此條碼無法重複上傳量測數據!");
                                }
                                else
                                {
                                    BarcodeProcessId = item2.BarcodeProcessId;
                                    barcodeProcessPassQty = item2.PassQty;
                                    barcodeProcessNgQty = item2.NgQty;
                                }
                            }
                            #endregion

                            #region //若迴圈第一次，建立QcRecord
                            if (qcRecordCount == 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.QcRecord (QcNoticeId, QcType, MoId, MoProcessId, PassQty, NgQty
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.QcRecordId
                                        VALUES (@QcNoticeId, @QcType, @MoId, @MoProcessId, @PassQty, @NgQty
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        QcNoticeId = Convert.ToInt32(item["QcNoticeId"]),
                                        QcType = "IPQC",
                                        MoId,
                                        MoProcessId,
                                        PassQty = barcodeProcessPassQty,
                                        NgQty = barcodeProcessNgQty,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                if (insertResult.Count() <= 0) throw new SystemException("建立QcRecord資料失敗!");

                                rowsAffected += insertResult.Count();

                                foreach (var item2 in insertResult)
                                {
                                    qcRecordId = item2.QcRecordId;
                                    qcRecord.Add(item["BarcodeNo"].ToString(), item2.QcRecordId);
                                }
                            }
                            #endregion

                            #region //INSERT MES.QcBarcode
                            int PassQty = -1;
                            int NgQty = -1;
                            if (item["QcStatus"].ToString() == "P")
                            {
                                PassQty = BarcodeQty;
                                NgQty = 0;
                            }
                            else
                            {
                                PassQty = 0;
                                NgQty = BarcodeQty;
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.QcBarcode (QcRecordId, BarcodeProcessId, BarcodeId, PassQty, NgQty, SystemStatus, QcStatus, QcUserId, Status, Remark
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.QcBarcodeId, INSERTED.BarcodeId
                                    VALUES (@QcRecordId, @BarcodeProcessId, @BarcodeId, @PassQty, @NgQty, @SystemStatus, @QcStatus, @QcUserId, @Status, @Remark
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcRecordId = qcRecordId,
                                    BarcodeProcessId,
                                    BarcodeId,
                                    PassQty,
                                    NgQty,
                                    SystemStatus = "N",
                                    QcStatus = item["QcStatus"].ToString(),
                                    QcUserId = CreateBy,
                                    Status = "Y",
                                    Remark = item["Remark"].ToString(),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item2 in insertResult2)
                            {
                                qcBarcodeList.Add(item2.QcBarcodeId, item2.BarcodeId);
                            }
                            #endregion

                            qcRecordCount++;
                        }
                        #endregion

                        #region //上傳量測數據
                        var tempQcItemJson = JObject.Parse(TempQcItemData);
                        List<QcNgCode> qcNgCodes = new List<QcNgCode>();
                        foreach (var item in tempQcItemJson["tempQcItemInfo"])
                        {
                            if (item["MeasureValue"].ToString().Length <= 0) throw new SystemException("量測值不能為空!");
                            if (item["QcResult"].ToString() == "F" && (item["NgCode"] == null || item["NgCodeDesc"] == null)) throw new SystemException("條碼【" + item["BarcodeNo"].ToString() + "】之項目【" + item["QcItemName"].ToString() + "】尚未維護異常原因!");

                            #region //判斷量測設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 CreateBy
                                    FROM QMS.QcNoticeItemSpec
                                    WHERE QcNoticeItemSpecId = @QcNoticeItemSpecId";
                            dynamicParameters.Add("QcNoticeItemSpecId", Convert.ToInt32(item["QcNoticeItemSpecId"]));

                            var qcNoticeItemSpecResult = sqlConnection.Query(sql, dynamicParameters);
                            if (qcNoticeItemSpecResult.Count() <= 0) throw new SystemException("量測設定資料錯誤!");

                            foreach (var item2 in qcNoticeItemSpecResult)
                            {
                                ProgrammerUserId = item2.CreateBy;
                            }
                            #endregion

                            #region //判斷量測項目資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.QcItemId
                                    FROM QMS.QcItem a
                                    WHERE a.QcItemId = @QcItemId";
                            dynamicParameters.Add("QcItemId", Convert.ToInt32(item["QcItemId"]));

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("量測項目資料錯誤!");

                            int QcItemId = -1;
                            foreach (var item2 in result2)
                            {
                                QcItemId = item2.QcItemId;
                            }
                            #endregion

                            #region //判斷量測機型資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QcMachineMode
                                    WHERE QcMachineModeId = @QcMachineModeId";
                            dynamicParameters.Add("QcMachineModeId", Convert.ToInt32(item["QcMachineModeId"]));

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("量測機型資料錯誤!");
                            #endregion

                            #region //判斷量測機台資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QmmDetail
                                    WHERE QmmDetailId = @QmmDetailId";
                            dynamicParameters.Add("QmmDetailId", Convert.ToInt32(item["QmmDetailId"]));

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("量測機台資料錯誤!");
                            #endregion

                            #region //判斷條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT BarcodeId
                                    FROM MES.Barcode
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", item["BarcodeNo"].ToString());

                            var result5 = sqlConnection.Query(sql, dynamicParameters);
                            if (result5.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                            foreach (var item2 in result5)
                            {
                                BarcodeId = item2.BarcodeId;
                            }
                            #endregion

                            int CauseId = -1;
                            if (item["QcResult"].ToString() == "F")
                            {
                                #region //判斷異常原因資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.CauseId
                                        FROM QMS.DefectCause a
                                        WHERE a.CauseNo = @CauseNo";
                                dynamicParameters.Add("CauseNo", item["NgCode"].ToString());

                                var CauseResult = sqlConnection.Query(sql, dynamicParameters);
                                if (CauseResult.Count() <= 0) throw new SystemException("異常原因資料錯誤!");

                                foreach (var item2 in CauseResult)
                                {
                                    CauseId = item2.CauseId;
                                }
                                #endregion

                                #region //維護異常原因項目modal
                                QcNgCode qcNgCode = new QcNgCode
                                {
                                    BarcodeId = BarcodeId,
                                    QcItemId = QcItemId,
                                    CauseId = CauseId,
                                    CauseDesc = item["NgCodeDesc"].ToString()
                                };

                                qcNgCodes.Add(qcNgCode);
                                #endregion
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO QMS.QcMeasureData (QcRecordId, QcNoticeItemSpecId, BarcodeId, QmmDetailId, MeasureValue, QcResult, CauseId, CauseDesc, MakeCount, Remark
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@QcRecordId, @QcNoticeItemSpecId, @BarcodeId, @QmmDetailId, @MeasureValue, @QcResult, @CauseId, @CauseDesc, @MakeCount, @Remark
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcRecordId = qcRecordId,
                                    QcNoticeItemSpecId = Convert.ToInt32(item["QcNoticeItemSpecId"]),
                                    BarcodeId,
                                    QmmDetailId = Convert.ToInt32(item["QmmDetailId"]),
                                    MeasureValue = item["MeasureValue"].ToString(),
                                    QcResult = item["QcResult"].ToString(),
                                    CauseId = CauseId > 0 ? CauseId : (int?)null,
                                    CauseDesc = item["NgCodeDesc"] != null ? item["NgCodeDesc"].ToString() : "",
                                    MakeCount = Convert.ToDouble(item["MakeCount"]),
                                    Remark = item["Remark"].ToString(),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = Convert.ToInt32(item["CreateUserId"]) == CreateBy ? CreateBy : Convert.ToInt32(item["CreateUserId"]),
                                    LastModifiedBy = Convert.ToInt32(item["CreateUserId"]) == CreateBy ? LastModifiedBy : Convert.ToInt32(item["CreateUserId"])
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }

                        if (qcNgCodes.Count() > 0)
                        {
                            qcCauseJsonString = JsonConvert.SerializeObject(qcNgCodes);
                            qcCauseJsonString = "{\"data\":" + qcCauseJsonString + "}";
                        }
                        #endregion

                        #region //處理判定後結果
                        List<AqBarcode> aqBarcodes = new List<AqBarcode>();

                        #region //迴圈判定
                        foreach (var item in qcBarcodeList)
                        {
                            foreach (var item2 in barcodeQcRecordJson["barcodeQcRecordInfo"])
                            {
                                #region //取得條碼ID
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT BarcodeNo
                                        FROM MES.Barcode
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", item.Value);

                                var barcodeInfoResult = sqlConnection.Query(sql, dynamicParameters);
                                if (barcodeInfoResult.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                                string BarcodeNo = "";
                                foreach (var item3 in barcodeInfoResult)
                                {
                                    BarcodeNo = item3.BarcodeNo;
                                }
                                #endregion

                                if (item2["BarcodeNo"].ToString() == BarcodeNo && item2["QcStatus"].ToString() == "F")
                                {
                                    #region //自動建立品異單流程
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.QcRecordId, a.QcType, a.MoId, a.MoProcessId, a.CreateBy
                                            , b.DepartmentId ResponsibleDeptId
                                            , c.BarcodeProcessId
                                            FROM MES.QcRecord a
                                            INNER JOIN BAS.[User] b ON a.CreateBy = b.UserId
                                            INNER JOIN MES.QcBarcode c ON a.QcRecordId = c.QcRecordId
                                            WHERE a.QcRecordId = @QcRecordId
                                            AND c.QcBarcodeId = @QcBarcodeId";
                                    dynamicParameters.Add("QcRecordId", qcRecordId);
                                    dynamicParameters.Add("QcBarcodeId", item.Key);

                                    var result = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item3 in result)
                                    {
                                        BarcodeProcessId = item3.BarcodeProcessId;
                                        AqBarcode aqBarcode = new AqBarcode
                                        {
                                            QcType = "IPQC",
                                            MoId = MoId,
                                            QcRecordId = item3.QcRecordId,
                                            QcBarcodeId = item.Key,
                                            BarcodeId = item.Value,
                                            ConformUserId = item2["ConformUserId"].ToString().Length > 0 ? Convert.ToInt32(item2["ConformUserId"]) : (int?)null,
                                            ResponsibleDeptId = item3.ResponsibleDeptId,
                                            ResponsibleUserId = item3.CreateBy,
                                            SubResponsibleDeptId = item2["SubResponsibleDeptId"].ToString().Length > 0 ? Convert.ToInt32(item2["SubResponsibleDeptId"]) : (int?)null,
                                            SubResponsibleUserId = item2["SubResponsibleUserId"].ToString().Length > 0 ? Convert.ToInt32(item2["SubResponsibleUserId"]) : (int?)null,
                                            ProgrammerUserId = ProgrammerUserId,
                                            MoProcessId = MoProcessId,
                                            DocDate = CreateDate
                                        };

                                        aqBarcodes.Add(aqBarcode);
                                    }

                                    #region //開始建立品異單
                                    string AbnormalqualityData = JsonConvert.SerializeObject(aqBarcodes);
                                    AbnormalqualityData = "{\"data\":" + AbnormalqualityData + "}";
                                    string AbnormalProjectList = qcCauseJsonString;

                                    dynamicParameters = new DynamicParameters();

                                    int AbnormalqualityId = 0;
                                    int? QcBarcodeId = 0;
                                    int? nullData = null;
                                    string QcType = "";
                                    var ConformUserId = nullData;
                                    var SubResponsibleDeptId = nullData;
                                    var SubResponsibleUserId = nullData;
                                    //var ProgrammerUserId = nullData;
                                    var ResponsibleSupervisorId = nullData;
                                    string DocDate = DateTime.Now.ToString("yyyyMM");


                                    var AbnormalqualityJson = JObject.Parse(AbnormalqualityData);
                                    var AbnormalProjectListJson = JObject.Parse(AbnormalProjectList);

                                    int ResponsibleUserId = -1;
                                    #region //品異單單頭建立
                                    foreach (var abnorItem in AbnormalqualityJson["data"])
                                    {
                                        if (Convert.ToInt32(abnorItem["MoId"]) <= 0) throw new SystemException("【製令】不能為空!");
                                        if (Convert.ToInt32(abnorItem["ResponsibleDeptId"]) <= 0) throw new SystemException("【責任單位】不能為空!");
                                        if (Convert.ToInt32(abnorItem["ResponsibleUserId"]) <= 0) throw new SystemException("【責任者】不能為空!");
                                        if (Convert.ToString(abnorItem["QcType"]) != "PVTQC")
                                        {
                                            if (Convert.ToInt32(abnorItem["BarcodeId"]) <= 0) throw new SystemException("【條碼】不能為空!");

                                            if (Convert.ToString(abnorItem["QcType"]) != "NON")
                                            {
                                                if (Convert.ToInt32(abnorItem["QcBarcodeId"]) <= 0) throw new SystemException("【檢驗紀錄編號】不能為空!");
                                            }


                                            #region //判斷條碼是否有進品異
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT a.AqBarcodeId,a.ProcessStatus,a.JudgeStatus
                                                    FROM QMS.AqBarcode a
								                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("BarcodeId", Convert.ToInt32(abnorItem["BarcodeId"]));
                                            var resultJudgeStatus = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultJudgeStatus.Count() > 0)
                                            {
                                                string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                                string ProcessStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessStatus;
                                                int AqBarcodeId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).AqBarcodeId;
                                                if (JudgeStatus == "RW")
                                                {
                                                    if (ProcessStatus == "I")
                                                    {
                                                        #region //資料更新
                                                        dynamicParameters = new DynamicParameters();
                                                        sql = @"UPDATE QMS.AqBarcode SET
                                                                ProcessStatus = @ProcessStatus,
                                                                LastModifiedBy = @LastModifiedBy,
                                                                LastModifiedDate = @LastModifiedDate
                                                                WHERE AqBarcodeId = @AqBarcodeId";
                                                        dynamicParameters.AddDynamicParams(
                                                          new
                                                          {
                                                              ProcessStatus = "V",
                                                              ConformUserId,
                                                              LastModifiedBy,
                                                              LastModifiedDate,
                                                              AqBarcodeId
                                                          });
                                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                        #endregion
                                                    }
                                                }
                                            }
                                            #endregion
                                        }

                                        MoId = Convert.ToInt32(abnorItem["MoId"]);
                                        QcType = Convert.ToString(abnorItem["QcType"]);
                                        if (QcType == "IPQC" || QcType == "NON")
                                        {
                                            MoProcessId = Convert.ToInt32(abnorItem["MoProcessId"]);
                                        }
                                        else
                                        {
                                            MoProcessId = null;
                                        }
                                        //DocDate = abnorItem["Docate"].ToString();
                                        ResponsibleUserId = Convert.ToInt32(abnorItem["ResponsibleUserId"]);
                                    }


                                    #region //單號自動取號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(AbnormalqualityNo))), '000'), 3)) + 1 CurrentNum
                                            FROM QMS.Abnormalquality
								            WHERE AbnormalqualityNo NOT LIKE '%[A-Za-z]%'
                                            AND AbnormalqualityNo LIKE '202311%'";
                                    int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                                    string AbnormalqualityNo = DocDate + string.Format("{0:000}", currentNum);
                                    #endregion

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO QMS.Abnormalquality (CompanyId, MoId, MoProcessId, AbnormalqualityNo, AbnormalqualityStatus, DocDate, QcType
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.AbnormalqualityId
                                            VALUES (@CompanyId, @MoId, @MoProcessId, @AbnormalqualityNo, @AbnormalqualityStatus, @DocDate, @QcType
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            CompanyId = CurrentCompany,
                                            MoId,
                                            MoProcessId,
                                            AbnormalqualityNo,
                                            AbnormalqualityStatus = "F",
                                            DocDate = DateTime.Now.ToString("yyyyMMdd"),
                                            QcType,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = ResponsibleUserId,
                                            LastModifiedBy = ResponsibleUserId
                                        });
                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected += insertResult.Count();

                                    //取出單頭Id
                                    foreach (var AbnormalqualityItem in insertResult)
                                    {
                                        AbnormalqualityId = AbnormalqualityItem.AbnormalqualityId;
                                    }
                                    #endregion

                                    #region //品異單單身 - 異常條碼建立
                                    foreach (var abnorJsonItem in AbnormalqualityJson["data"])
                                    {

                                        if (QcType != "PVTQC")
                                        {
                                            if (QcType == "IPQC")
                                            {
                                                #region //判斷條碼是否存在
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                                        FROM MES.Barcode a
                                                        INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                                INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                                        WHERE a.BarcodeId = @BarcodeId
                                                        --AND a.BarcodeStatus = '1' 
                                                        AND　c.FinishDate is not null";
                                                dynamicParameters.Add("BarcodeId", Convert.ToInt32(abnorJsonItem["BarcodeId"]));
                                                var result1 = sqlConnection.Query(sql, dynamicParameters);
                                                if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(abnorJsonItem["BarcodeId"]) + "】不存在，請重新輸入!");
                                                #endregion
                                            }
                                            else if (QcType == "OQC")
                                            {
                                                #region //判斷條碼是否存在
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                                        FROM MES.Barcode a
                                                        INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                                INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                                        WHERE a.BarcodeId = @BarcodeId
                                                        AND　c.FinishDate is not null";
                                                dynamicParameters.Add("BarcodeId", Convert.ToInt32(abnorJsonItem["BarcodeId"]));
                                                var result1 = sqlConnection.Query(sql, dynamicParameters);
                                                if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(abnorJsonItem["BarcodeId"]) + "】不存在，請重新輸入!");
                                                #endregion
                                            }

                                            #region //判斷條碼目前是否在品異單
                                            sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                                    FROM QMS.AqBarcode a
                                                    WHERE a.BarcodeId =@BarcodeId
                                                    Order By a.LastModifiedDate DESC
                                                    ";
                                            dynamicParameters.Add("BarcodeId", Convert.ToInt32(abnorJsonItem["BarcodeId"]));
                                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                                            if (result2.Count() > 0)
                                            {
                                                //判斷品異單判斷結果,如果有值且不是S代表已經判定完成,如果條碼有異常可以開立新的品異單
                                                string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                                if (JudgeStatus == null)
                                                {
                                                    throw new SystemException("【條碼Id:" + Convert.ToInt32(abnorJsonItem["BarcodeId"]) + "】目前在品異單判定中，不可以開立品異單");
                                                }
                                                else if (JudgeStatus == "S")
                                                {
                                                    throw new SystemException("【條碼Id:" + Convert.ToInt32(abnorJsonItem["BarcodeId"]) + "】目前判定不良品，不可以開立品異單");
                                                }
                                            }
                                            #endregion
                                        }

                                        #region //判斷資料是否存在
                                        #region //資料 - NOT NULL

                                        #region //判斷檢驗紀錄編號是否存在
                                        if (QcType != "PVTQC")
                                        {
                                            if (QcType != "NON")
                                            {
                                                sql = @"SELECT TOP 1 1
                                                        FROM MES.QcBarcode a
                                                        WHERE a.QcBarcodeId = @QcBarcodeId";
                                                dynamicParameters.Add("QcBarcodeId", Convert.ToInt32(abnorJsonItem["QcBarcodeId"]));
                                                var resultQcBarcodeId = sqlConnection.Query(sql, dynamicParameters);
                                                if (resultQcBarcodeId.Count() <= 0) throw new SystemException("【檢驗紀錄編號:" + abnorJsonItem["QcRecordId"].ToString() + "】不存在，請重新輸入!");
                                            }
                                        }
                                        #endregion

                                        #region //判斷責任單位是否存在
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                                FROM BAS.[User] a
                                                INNER JOIN BAS.Department b on a.DepartmentId = b.DepartmentId
                                                WHERE b.DepartmentId = @ResponsibleDeptId";
                                        dynamicParameters.Add("ResponsibleDeptId", Convert.ToInt32(abnorJsonItem["ResponsibleDeptId"]));

                                        var UserResult = sqlConnection.Query(sql, dynamicParameters);
                                        if (UserResult.Count() <= 0) throw new SystemException("【責任單位】不存在，請重新輸入!");
                                        #endregion

                                        #region //判斷責任者是否存在
                                        dynamicParameters = new DynamicParameters();

                                        sql = @"SELECT TOP 1 1
                                                FROM BAS.[User] a
                                                WHERE a.UserId = @ResponsibleUserId
                                                AND a.Status = 'A'";
                                        dynamicParameters.Add("ResponsibleUserId", Convert.ToInt32(abnorJsonItem["ResponsibleUserId"]));

                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() <= 0) throw new SystemException("【責任者】不存在，請重新輸入!");
                                        #endregion
                                        #endregion

                                        #region //資料 - NULL
                                        #region //判斷合致對象是否存在
                                        if (abnorJsonItem["ConformUserId"].ToString() != "")
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"SELECT TOP 1 1
                                                    FROM BAS.[User] a
                                                    WHERE a.UserId = @ConformUserId
                                                    AND a.Status = 'A'";
                                            dynamicParameters.Add("ConformUserId", Convert.ToInt32(abnorJsonItem["ConformUserId"]));

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() <= 0) throw new SystemException("【合致對象】不存在，請重新輸入!");
                                            ConformUserId = Convert.ToInt32(abnorJsonItem["ConformUserId"]);
                                        }
                                        #endregion

                                        #region //判斷副責任單位是否存在
                                        if (abnorJsonItem["SubResponsibleDeptId"].ToString() != "")
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"SELECT TOP 1 1
                                                    FROM BAS.Department a
                                                    WHERE a.DepartmentId = @SubResponsibleDeptId";
                                            dynamicParameters.Add("SubResponsibleDeptId", Convert.ToInt32(abnorJsonItem["SubResponsibleDeptId"]));

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() <= 0) throw new SystemException("【副責任單位】不存在，請重新輸入!");
                                            SubResponsibleDeptId = Convert.ToInt32(abnorJsonItem["SubResponsibleDeptId"]);
                                        }
                                        #endregion

                                        #region //判斷副責任者是否存在
                                        if (abnorJsonItem["SubResponsibleUserId"].ToString() != "")
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"SELECT TOP 1 1
                                                    FROM BAS.[User] a
                                                    WHERE a.UserId = @SubResponsibleUserId
                                                    AND a.Status = 'A'";
                                            dynamicParameters.Add("SubResponsibleUserId", Convert.ToInt32(abnorJsonItem["SubResponsibleUserId"]));

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() <= 0) throw new SystemException("【副責任者】不存在，請重新輸入!");

                                            SubResponsibleUserId = Convert.ToInt32(abnorJsonItem["SubResponsibleUserId"]);

                                        }
                                        #endregion

                                        #region //判斷編程者是否存在
                                        if (abnorJsonItem["ProgrammerUserId"].ToString() != "")
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"SELECT TOP 1 1
                                                    FROM BAS.[User] a
                                                    WHERE a.UserId = @ProgrammerUserId
                                                    AND a.Status = 'A'";
                                            dynamicParameters.Add("ProgrammerUserId", Convert.ToInt32(abnorJsonItem["ProgrammerUserId"]));

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() <= 0) throw new SystemException("【編程者】不存在，請重新輸入!");

                                            ProgrammerUserId = Convert.ToInt32(abnorJsonItem["ProgrammerUserId"]);

                                        }
                                        #endregion
                                        #endregion
                                        #endregion

                                        if (QcType != "PVTQC")
                                        {
                                            #region //更新異常條碼目前狀態
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    CurrentProdStatus = 'F',
                                                    LastModifiedBy = @LastModifiedBy,
                                                    LastModifiedDate = @LastModifiedDate
                                                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.AddDynamicParams(
                                              new
                                              {
                                                  LastModifiedBy,
                                                  LastModifiedDate,
                                                  BarcodeId = Convert.ToInt32(abnorJsonItem["BarcodeId"])
                                              });
                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion

                                            BarcodeId = Convert.ToInt32(abnorJsonItem["BarcodeId"]);
                                            if (QcType == "NON")
                                            {
                                                if (abnorJsonItem["QcBarcodeId"].Count() == 0)
                                                {
                                                    QcBarcodeId = nullData;
                                                }
                                            }
                                            else
                                            {
                                                QcBarcodeId = Convert.ToInt32(abnorJsonItem["QcBarcodeId"]);
                                            }

                                        }
                                        else
                                        {
                                            BarcodeId = (int?)null;
                                            QcBarcodeId = nullData;
                                        }

                                        #region //新增 - 品異單單身
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO QMS.AqBarcode (AbnormalqualityId, BarcodeId, QcBarcodeId, DefectCauseId, DefectCauseDesc, ConformUserId, 
                                                ResponsibleDeptId, ResponsibleUserId, SubResponsibleDeptId, SubResponsibleUserId, ProgrammerUserId, 
                                                RepairCauseId, RepairCauseDesc, RepairCauseUserId,AqBarcodeStatus
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.AqBarcodeId
                                                VALUES (@AbnormalqualityId, @BarcodeId, @QcBarcodeId, @DefectCauseId, @DefectCauseDesc, @ConformUserId, 
                                                @ResponsibleDeptId, @ResponsibleUserId, @SubResponsibleDeptId, @SubResponsibleUserId, @ProgrammerUserId, 
                                                @RepairCauseId, @RepairCauseDesc, @RepairCauseUserId, @AqBarcodeStatus, 
                                                @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                AbnormalqualityId,
                                                BarcodeId,
                                                QcBarcodeId,
                                                DefectCauseId = nullData,
                                                DefectCauseDesc = nullData,
                                                ConformUserId,
                                                ResponsibleDeptId = Convert.ToInt32(abnorJsonItem["ResponsibleDeptId"]),
                                                ResponsibleUserId = Convert.ToInt32(abnorJsonItem["ResponsibleUserId"]),
                                                SubResponsibleDeptId,
                                                SubResponsibleUserId,
                                                ProgrammerUserId,
                                                RepairCauseId = nullData,
                                                RepairCauseDesc = nullData,
                                                RepairCauseUserId = nullData,
                                                AqBarcodeStatus = 1,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });
                                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult2.Count();

                                        int AqBarcodeId = 0;
                                        foreach (var abnorJsonItem2 in insertResult2)
                                        {
                                            AqBarcodeId = abnorJsonItem2.AqBarcodeId;
                                        }
                                        #endregion

                                        foreach (var item4 in AbnormalProjectListJson["data"])
                                        {
                                            if (BarcodeId == Convert.ToInt32(item4["BarcodeId"]))
                                            {
                                                if (Convert.ToInt32(item4["CauseId"]) <= 0) throw new SystemException("【不良代碼】不能為空!");
                                                if (item4["CauseDesc"].ToString().Length > 100) throw new SystemException("【不良原因】長度錯誤!");

                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO QMS.AqQcItem (AqBarcodeId, QcItemId, DefectCauseId, DefectCauseDesc, RepairCauseId, RepairCauseDesc
                                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                        OUTPUT INSERTED.AqQcItemId
                                                        VALUES (@AqBarcodeId, @QcItemId, @DefectCauseId, @DefectCauseDesc, @RepairCauseId, @RepairCauseDesc
                                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        AqBarcodeId,
                                                        QcItemId = Convert.ToInt32(item4["QcItemId"]),
                                                        DefectCauseId = Convert.ToInt32(item4["CauseId"]),
                                                        DefectCauseDesc = item4["CauseDesc"].ToString(),
                                                        RepairCauseId = nullData,
                                                        RepairCauseDesc = nullData,
                                                        CreateDate,
                                                        LastModifiedDate,
                                                        CreateBy = ResponsibleUserId,
                                                        LastModifiedBy = ResponsibleUserId
                                                    });
                                                var insertAqQcItemResult = sqlConnection.Query(sql, dynamicParameters);
                                                rowsAffected += insertAqQcItemResult.Count();
                                            }
                                        }

                                    }
                                    #endregion
                                    #endregion

                                    #endregion

                                    #region //更改MES.Barode狀態
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            CurrentProdStatus = @CurrentProdStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeNo = @BarcodeNo";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          CurrentProdStatus = "F",
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          BarcodeNo
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //呼叫UpdateBarcodeProcessStatus更新MoProcess Quantity資訊
                                    UpdateMoQtyInformation(MoId);
                                    #endregion
                                }
                                else if (item2["BarcodeNo"].ToString() == BarcodeNo && item2["QcStatus"].ToString() == "R") //若判定為R(需補正，當站返修)
                                {
                                    #region //取得此次紀錄BarcodeProcessId
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.BarcodeProcessId, a.BarcodeId
                                            , b.QcBarcodeId, b.QcStatus
                                            FROM MES.BarcodeProcess a
                                            LEFT JOIN MES.QcBarcode b ON b.BarcodeProcessId = a.BarcodeProcessId
                                            AND b.QcBarcodeId = (
                                              SELECT TOP 1 ba.QcBarcodeId
                                              FROM MES.QcBarcode ba
                                              WHERE ba.BarcodeProcessId = a.BarcodeProcessId
                                              ORDER BY ba.CreateDate DESC
                                            )
                                            INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                            WHERE a.MoId = @MoId
                                            AND a.MoProcessId = @MoProcessId
                                            AND a.BarcodeId = @BarcodeId
                                            AND a.FinishDate IS NOT NULL
                                            AND c.CurrentProdStatus = 'P'
                                            ORDER BY a.FinishDate DESC";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("MoProcessId", MoProcessId);
                                    dynamicParameters.Add("BarcodeId", BarcodeId);

                                    var result13 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result13.Count() <= 0) throw new SystemException("製令歷程資料錯誤!");

                                    foreach (var item3 in result13)
                                    {
                                        BarcodeId = item3.BarcodeId;
                                        BarcodeProcessId = item3.BarcodeProcessId;
                                    }
                                    #endregion

                                    #region //更改MES.Barode狀態
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            NextMoProcessId = @NextMoProcessId,
                                            CurrentProdStatus = @CurrentProdStatus,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeNo = @BarcodeNo";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          NextMoProcessId = MoProcessId,
                                          CurrentProdStatus = "SR",
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          BarcodeNo
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //call 編程API

                                    #endregion

                                    #region //呼叫UpdateMoQtyInformation更新MoProcess Quantity資訊
                                    UpdateMoQtyInformation(MoId);
                                    #endregion
                                }
                                else if (item2["BarcodeNo"].ToString() == BarcodeNo && item2["QcStatus"].ToString() == "P") //良品
                                {
                                    #region //判斷是否為最後一站
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.SortNumber CurrentSortNumber
                                            FROM MES.MoProcess a
                                            WHERE a.MoProcessId = @MoProcessId";
                                    dynamicParameters.Add("MoProcessId", MoProcessId);

                                    var result = sqlConnection.Query(sql, dynamicParameters);

                                    int CurrentSortNumber = -1;
                                    foreach (var item3 in result)
                                    {
                                        CurrentSortNumber = item3.CurrentSortNumber;
                                    }

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MAX(a.SortNumber) MaxSortNumber
                                            FROM MES.MoProcess a
                                            WHERE MoId = @MoId";
                                    dynamicParameters.Add("MoId", MoId);

                                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                                    int MaxSortNumber = -1;
                                    foreach (var item3 in result2)
                                    {
                                        MaxSortNumber = item3.MaxSortNumber;
                                    }

                                    if (CurrentSortNumber == MaxSortNumber)
                                    {
                                        if (ProcessCheckType == "1") //全檢
                                        {
                                            //只更新此條碼
                                            #region //UPDATE BARCODE BarcodeStatus、NEXT PROCESS
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    BarcodeStatus = @BarcodeStatus,
                                                    NextMoProcessId = @NextMoProcessId,
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE BarcodeNo = @BarcodeNo";
                                            dynamicParameters.AddDynamicParams(
                                              new
                                              {
                                                  BarcodeStatus = "0",
                                                  NextMoProcessId = -1,
                                                  LastModifiedDate,
                                                  LastModifiedBy,
                                                  BarcodeNo = item.Key
                                              });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                        else if (ProcessCheckType == "2") //抽檢
                                        {
                                            //更新整張製令條碼
                                            #region //UPDATE BARCODE BarcodeStatus、NEXT PROCESS
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    BarcodeStatus = @BarcodeStatus,
                                                    NextMoProcessId = @NextMoProcessId,
                                                    LastModifiedDate = @LastModifiedDate,
                                                    LastModifiedBy = @LastModifiedBy
                                                    WHERE MoId = @MoId
                                                    AND CurrentMoProcessId = @CurrentMoProcessId";
                                            dynamicParameters.AddDynamicParams(
                                              new
                                              {
                                                  BarcodeStatus = "0",
                                                  NextMoProcessId = -1,
                                                  LastModifiedDate,
                                                  LastModifiedBy,
                                                  MoId,
                                                  CurrentMoProcessId = MoProcessId
                                              });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                    }
                                    #endregion
                                }
                                else if (item2["BarcodeNo"].ToString() == BarcodeNo && item2["QcStatus"].ToString() == "M")
                                {
                                    #region //將MES.QcBarcode Status UPDATE為N
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.QcBarcode SET
                                            Status = 'N',
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE QcBarcodeId = @QcBarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          QcBarcodeId = item.Key
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                        }
                        #endregion

                        #endregion

                        #region //將量測暫存資料狀態改為S
                        foreach (var barcodeId in barcodeIdList.ToArray())
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE QMS.TempQcMeasureData SET
                                    Status = @Status,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @BarcodeId
                                    AND MoProcessId = @MoProcessId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  Status = "S",
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  BarcodeId,
                                  MoProcessId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion
                    }
                    transactionScope.Complete();
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddQcFile-- 新增量測檔案 -- Ann 2022-10-19
        public string AddQcFile(int MoId, int MoProcessId, byte[] FileContent, string FileName, string FileExtension, int FileSize, string ClientIP, string Source, int QcNoticeItemSpecId)
        {
            try
            {
                //MoProcessId = 342;
                if (FileContent.Length <= 0) throw new SystemException("【檔案Binary】不能為空!");
                if (FileName.Length <= 0) throw new SystemException("【檔案名稱】不能為空!");
                if (FileExtension.Length <= 0) throw new SystemException("【檔案副檔名】不能為空!");
                if (FileSize <= 0) throw new SystemException("【檔案大小】不能為空!");

                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷製令資料是否有誤
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令資料有誤!");
                        #endregion

                        #region //判斷製令製程資料是否有誤
                        if (MoProcessId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcess
                                    WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("製令製程資料有誤!");
                        }
                        #endregion

                        #region //判斷量測項目資料是否有誤
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT QcNoticeId
                                FROM QMS.QcNoticeItemSpec
                                WHERE QcNoticeItemSpecId = @QcNoticeItemSpecId";
                        dynamicParameters.Add("QcNoticeItemSpecId", QcNoticeItemSpecId);

                        var qcNoticeItemSpecResult = sqlConnection.Query(sql, dynamicParameters);
                        if (qcNoticeItemSpecResult.Count() <= 0) throw new SystemException("量測項目資料有誤!");

                        int QcNoticeId = -1;
                        foreach (var item in qcNoticeItemSpecResult)
                        {
                            QcNoticeId = item.QcNoticeId;
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO BAS.[File] (CompanyId, FileName, FileContent, FileExtension, FileSize, ClientIP, Source, DeleteStatus
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.FileId
                                VALUES (@CompanyId, @FileName, CONVERT(varbinary(max),@FileContent), @FileExtension, @FileSize, @ClientIP, @Source, @DeleteStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                FileName,
                                FileContent,
                                FileExtension,
                                FileSize,
                                ClientIP,
                                Source,
                                DeleteStatus = "N",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();

                        int FileId = -1;
                        foreach (var item in insertResult)
                        {
                            FileId = item.FileId;
                        }

                        #region //上傳至QMS.QcFile
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO QMS.QcFile (FileId, QcNoticeId
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.QcFileId
                                VALUES (@FileId, @QcNoticeId
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FileId,
                                QcNoticeId,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();
                        #endregion
                    }
                    transactionScope.Complete();
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddQcRecord -- 新增量測紀錄單頭 -- Ann 2024-01-03
        public string AddQcRecord(int QcNoticeId, int QcTypeId, int MoId, int MoProcessId, int QmmDetailId, int QcItemId, string Remark, int CurrentFileId, string QcDepartment, string MachineNumber
            , string LotNumber, string QcRecordFile, string InputType, string ServerPath, string ServerPath2, string CheckQcMeasureData, string SupportAqFlag, string ResolveFile
            , string BarcodeList, string ResolveFileJson, string QcRecordFileByNas, string QcMeasureDataJson, string SourcePage, string QcItemJson)
        {
            try
            {
                string ErpDbName = "";
                string CompanyNo = "";
                List<SpreadsheetModel> spreadsheetModels = new List<SpreadsheetModel>();
                List<Sheets> sheetss = new List<Sheets>();
                List<Data> datas = new List<Data>();
                Dictionary<string, string> BarcodeInfo = new Dictionary<string, string>();
                #region //初始化Data
                Data data = new Data();
                data = new Data()
                {
                    cell = "A1",
                    css = "imported_class1",
                    format = "text",
                    value = "序號",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "B1",
                    css = "imported_class2",
                    format = "text",
                    value = "球標",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "C1",
                    css = "imported_class2",
                    format = "text",
                    value = "檢測項目",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "D1",
                    css = "imported_class3",
                    format = "text",
                    value = "檢測備註",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "E1",
                    css = "imported_class4",
                    format = "text",
                    value = "量測設備",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "F1",
                    css = "imported_class5",
                    format = "text",
                    value = "設計值",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "G1",
                    css = "imported_class6",
                    format = "text",
                    value = "上限",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "H1",
                    css = "imported_class7",
                    format = "text",
                    value = "下限",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "I1",
                    css = "imported_class8",
                    format = "text",
                    value = "單位",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "J1",
                    css = "imported_class8",
                    format = "text",
                    value = "Z軸",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "K1",
                    css = "imported_class9",
                    format = "text",
                    value = "量測人員",
                };
                datas.Add(data);

                data = new Data()
                {
                    cell = "L1",
                    css = "imported_class10",
                    format = "text",
                    value = "量測工時",
                };
                datas.Add(data);
                #endregion

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyNo, a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                            CompanyNo = item.CompanyNo;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            if (InputType.Length < 0) throw new SystemException("【輸入方式】不能為空!");

                            //客制化判斷 > 膜分光量測站
                            if (SourcePage == "ViewQcDataPotNumber" && string.IsNullOrWhiteSpace(LotNumber)) throw new SystemException("【批號】不能為空!");

                            #region //判斷MES製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ModeId
                                    , (b.WoErpPrefix + '-' + b.WoErpNo + '(' + CONVERT(varchar(10), a.WoSeq) + ')') WoErpFullNo
                                    , b.WoErpPrefix, b.WoErpNo
                                    , c.MtlItemId, c.MtlItemNo, c.MtlItemName
                                    FROM MES.ManufactureOrder a 
                                    INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                    INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("MES製令資料錯誤!");

                            string WoErpFullNo = "";
                            string MtlItemNo = "";
                            string MtlItemName = "";
                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            int ModeId = -1;
                            int MtlItemId = -1;
                            foreach (var item in result)
                            {
                                WoErpFullNo = item.WoErpFullNo;
                                MtlItemNo = item.MtlItemNo;
                                MtlItemName = item.MtlItemName;
                                WoErpPrefix = item.WoErpPrefix;
                                WoErpNo = item.WoErpNo;
                                ModeId = item.ModeId;
                                MtlItemId = item.MtlItemId;
                            }
                            #endregion

                            #region //判斷ERP製令狀態是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TA011, TA013
                                    FROM MOCTA
                                    WHERE TA001 = @TA001
                                    AND TA002 = @TA002";
                            dynamicParameters.Add("TA001", WoErpPrefix);
                            dynamicParameters.Add("TA002", WoErpNo);

                            var MOCTAResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (MOCTAResult.Count() <= 0) throw new SystemException("ERP製令資料錯誤!!");

                            foreach (var item in MOCTAResult)
                            {
                                if (SupportAqFlag == "Y" && (item.TA011 == "Y" || item.TA011 == "y" || item.TA013 == "V")) throw new SystemException("ERP製令狀態無法開立!!");
                            }
                            #endregion

                            #region //判斷量測類型資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ModeId, a.QcTypeNo, a.QcTypeName, a.SupportAqFlag, a.SupportProcessFlag
                                    FROM QMS.QcType a 
                                    WHERE a.QcTypeId = @QcTypeId";
                            dynamicParameters.Add("QcTypeId", QcTypeId);

                            var QcTypeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (QcTypeResult.Count() <= 0) throw new SystemException("量測類型資料不能為空!!");

                            string QcTypeNo = "";
                            string QcTypeName = "";
                            string SupportProcessFlag = "";
                            foreach (var item in QcTypeResult)
                            {
                                if (item.SupportProcessFlag == "Y" && MoProcessId <= 0) throw new SystemException("【量測製程】不能為空!");
                                QcTypeNo = item.QcTypeNo;
                                QcTypeName = item.QcTypeName;
                                SupportProcessFlag = item.SupportProcessFlag;
                            }
                            #endregion

                            #region //若為工程檢，檢查之前是否有未上傳的量測單
                            if (QcTypeNo == "IPQC")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.QcRecord a 
                                        WHERE a.MoProcessId = @MoProcessId 
                                        AND a.CheckQcMeasureData != 'Y'
                                        AND a.CheckQcMeasureData != 'P'
                                        AND a.CheckQcMeasureData != 'F'
                                        AND a.QcTypeId = @QcTypeId";
                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                dynamicParameters.Add("QcTypeId", QcTypeId);

                                var QcRecordResult2 = sqlConnection.Query(sql, dynamicParameters);

                                //if (QcRecordResult2.Count() > 0) throw new SystemException("此製令製程尚有未上傳之量測單據，無法開立新單據");
                            }
                            #endregion

                            #region //若為出貨檢，不可重複上傳
                            if (QcTypeNo == "OQC")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.QcRecord a 
                                        WHERE a.MoId = @MoId
                                        AND a.QcTypeId = @QcTypeId";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("QcTypeId", QcTypeId);

                                var QcRecordResult2 = sqlConnection.Query(sql, dynamicParameters);

                                //if (QcRecordResult2.Count() > 0) throw new SystemException("此製令已有出貨檢量測單據，無法重複建立!!");
                            }
                            #endregion

                            #region //檢查此批送測條碼是否有未量測完畢之單據
                            string[] BarcodeIdList = BarcodeList.Split(',');
                            foreach (var item in BarcodeIdList)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.QcRecordId
                                        , c.BarcodeNo
                                        FROM MES.QcReceiptBarcode a 
                                        INNER JOIN MES.QcRecord b ON a.QcRecordId = b.QcRecordId
                                        INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                        INNER JOIN MES.ManufactureOrder d ON b.MoId = d.MoId
                                        INNER JOIN MES.ProdMode e ON d.ModeId = e.ModeId
                                        WHERE b.CheckQcMeasureData != 'Y'
                                        AND b.CheckQcMeasureData != 'P'
                                        AND b.CheckQcMeasureData != 'F'
                                        AND c.BarcodeId = @BarcodeId
                                        AND e.CompanyId = @CompanyId";
                                dynamicParameters.Add("BarcodeId", item);
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var QcReceiptBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                if (QcReceiptBarcodeResult.Count() > 0)
                                {
                                    foreach (var item2 in QcReceiptBarcodeResult)
                                    {
                                        throw new SystemException("條碼【" + item2.BarcodeNo + "】尚有量測單據【" + item2.QcRecordId + "】未完成，無法重複送測!!");
                                    }
                                }
                            }

                            #endregion

                            #region //確認量測機台資料是否正確
                            string MachineName = "";
                            if (MachineNumber.Length > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 b.MachineName
                                        FROM QMS.QmmDetail a 
                                        INNER JOIN MES.Machine b ON a.MachineId = b.MachineId
                                        INNER JOIN QMS.QcMachineMode c ON a.QcMachineModeId = c.QcMachineModeId
                                        WHERE a.MachineNumber = @MachineNumber
                                        AND c.CompanyId = @CompanyId";
                                dynamicParameters.Add("MachineNumber", MachineNumber);
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var QmmDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                if (QmmDetailResult.Count() <= 0) throw new SystemException("量測機台資料錯誤!!");

                                foreach (var item in QmmDetailResult)
                                {
                                    MachineName = item.MachineName;
                                }
                            }
                            #endregion

                            string ProcessAlias = "";
                            int SortNumber = 0;
                            if (MoProcessId > 0)
                            {
                                #region //判斷製程資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT ProcessAlias, SortNumber
                                        FROM MES.MoProcess
                                        WHERE MoProcessId = @MoProcessId";
                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                if (MoProcessResult.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                                foreach (var item in MoProcessResult)
                                {
                                    ProcessAlias = item.ProcessAlias;
                                    SortNumber = item.SortNumber;
                                }
                                #endregion
                            }

                            #region //取得預設SpreadsheetData
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.DefaultSpreadsheetData
                                    FROM MES.QcRecord a";

                            var DefaultFileIdResult = sqlConnection.Query(sql, dynamicParameters);

                            string DefaultSpreadsheetData = "";
                            foreach (var item in DefaultFileIdResult)
                            {
                                DefaultSpreadsheetData = item.DefaultSpreadsheetData;
                            }
                            #endregion

                            #region //建立CheckQcMeasureData
                            CheckQcMeasureData = string.IsNullOrWhiteSpace(CheckQcMeasureData) ? "A" : CheckQcMeasureData;
                            #endregion

                            #region //INSERT MES.QcRecord
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.QcRecord (QcNoticeId, QcTypeId, InputType, MoId, MoProcessId, Remark, DefaultFileId, CurrentFileId, DefaultSpreadsheetData, CheckQcMeasureData, SupportAqFlag, SupportProcessFlag, ResolveFileJson, RequestDate
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.QcRecordId
                                    VALUES (@QcNoticeId, @QcTypeId, @InputType, @MoId, @MoProcessId, @Remark, @DefaultFileId, @CurrentFileId, @DefaultSpreadsheetData, @CheckQcMeasureData, @SupportAqFlag, @SupportProcessFlag, @ResolveFileJson, @RequestDate
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcNoticeId = QcNoticeId <= 0 ? (int?)null : QcNoticeId,
                                    QcTypeId,
                                    InputType,
                                    MoId,
                                    MoProcessId = MoProcessId > 0 ? MoProcessId : (int?)null,
                                    Remark,
                                    DefaultFileId = -1,
                                    CurrentFileId,
                                    DefaultSpreadsheetData,
                                    CheckQcMeasureData,
                                    SupportAqFlag,
                                    SupportProcessFlag,
                                    ResolveFileJson,
                                    RequestDate = CreateDate,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            int rowsAffected = insertResult.Count();

                            int QcRecordId = -1;
                            foreach (var item in insertResult)
                            {
                                QcRecordId = item.QcRecordId;
                            }
                            #endregion

                            #region //INSERT MES.QcRecordFile
                            if (QcRecordFile.Length > 0)
                            {
                                var qcRecordFileList = QcRecordFile.Split(',');

                                foreach (var qcRecordFileId in qcRecordFileList)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.QcRecordFile (QcRecordId, FileId
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.QcRecordFileId, INSERTED.QcRecordId, INSERTED.FileId
                                            VALUES (@QcRecordId, @FileId
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            QcRecordId,
                                            FileId = qcRecordFileId,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                }
                            }
                            #endregion

                            #region //INSERT MES.QcRecordFile By NAS
                            if (QcRecordFileByNas.Length > 0)
                            {
                                JObject uploadFileJson = JObject.Parse(QcRecordFileByNas);

                                foreach (var item in uploadFileJson["uploadFileInfo"])
                                {
                                    string fileType = item["FileType"]?.ToString() ?? "other";
                                    string inputType = item["InputType"]?.ToString() ?? null;
                                    string barcodeId = item["BarcodeId"]?.ToString() ?? null;

                                    //SplitCoating (SC) 分光鍍膜 file-management
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.QcRecordFile (QcRecordId, FileType, InputType, BarcodeId, PhysicalPath, LotNumber
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.QcRecordFileId, INSERTED.QcRecordId, INSERTED.FileId
                                            VALUES (@QcRecordId, @FileType, @InputType, @BarcodeId, @PhysicalPath, @LotNumber
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            QcRecordId,
                                            FileType = fileType,
                                            InputType = inputType,
                                            BarcodeId = barcodeId,
                                            PhysicalPath = item["FilePath"].ToString(),
                                            LotNumber = LotNumber ?? null,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    insertResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected += insertResult.Count();
                                }
                            }
                            #endregion

                            #region //INSERT QMS.QcMeasureData
                            if (QcMeasureDataJson.Length > 0)
                            {
                                #region //取得量測項目
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.QcItemId, a.QcItemNo, a.QcItemName, a.QcType, ISNULL(b.QcItemDesc, a.QcItemDesc) QcItemDesc, b.*
                                        FROM QMS.QcItem a
                                        OUTER APPLY (
	                                        SELECT aa.QcItemDesc, aa.DesignValue, aa.UpperTolerance, aa.LowerTolerance, aa.SortNumber
	                                        , ab.QmmDetailId, ab.MachineNumber
	                                        , ac.MachineNo, ac.MachineName, ad.ShopName 
	                                        FROM PDM.MtlQcItem aa
	                                        INNER JOIN QMS.QmmDetail ab ON ab.QmmDetailId = aa.QmmDetailId
	                                        INNER JOIN MES.Machine ac ON ac.MachineId = ab.MachineId
	                                        INNER JOIN MES.WorkShop ad ON ad.ShopId = ac.ShopId AND ad.CompanyId = @CompanyId
	                                        WHERE aa.QcItemId = a.QcItemId
	                                        AND ad.CompanyId = @CompanyId
	                                        AND aa.MtlItemId = @MtlItemId
                                        ) b
                                        WHERE a.QcItemId = @QcItemId";
                                dynamicParameters.Add("CompanyId", CurrentCompany);
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                dynamicParameters.Add("QcItemId", QcItemId);
                                var resultQcItem = sqlConnection.Query(sql, dynamicParameters);
                                if (!resultQcItem.Any()) throw new SystemException("【量測項目】資料錯誤!");
                                string QcItemDesc = string.Empty;
                                string DesignValue = string.Empty;
                                string UpperTolerance = string.Empty;
                                string LowerTolerance = string.Empty;
                                foreach (var item in resultQcItem)
                                {
                                    QcItemDesc = item.QcItemDesc;
                                    DesignValue = item.DesignValue ?? "OK";
                                    UpperTolerance = item.UpperTolerance;
                                    LowerTolerance = item.LowerTolerance;
                                    QmmDetailId = item.QmmDetailId ?? QmmDetailId;
                                }
                                #endregion

                                JObject qcMeasureData = JObject.Parse(QcMeasureDataJson);

                                foreach (var item in qcMeasureData["data"])
                                {
                                    int.TryParse(item["BarcodeId"]?.ToString(), out int BarcodeId);
                                    string MeasureValue = item["MeasureValue"]?.ToString() ?? "";

                                    #region //新增量測資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO QMS.QcMeasureData (QcRecordId, QcItemId, QcItemDesc, DesignValue, BarcodeId, QmmDetailId, MeasureValue, QcResult, LotNumber
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.QmdId
                                            VALUES (@QcRecordId, @QcItemId, @QcItemDesc, @DesignValue, @BarcodeId, @QmmDetailId, @MeasureValue, @QcResult, @LotNumber
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            QcRecordId,
                                            QcItemId,
                                            QcItemDesc,
                                            DesignValue,
                                            BarcodeId,
                                            QmmDetailId,
                                            MeasureValue,
                                            QcResult = MeasureValue == "OK" ? "P" : "F",
                                            LotNumber = LotNumber ?? null,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    insertResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected += insertResult.Count();
                                    #endregion
                                }
                            }
                            #endregion

                            #region //INSERT ResolveFile
                            if (ResolveFile.Length > 0)
                            {
                                var resolveFileList = ResolveFile.Split(',');

                                foreach (var resolveFileId in resolveFileList)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.QcRecordFile (QcRecordId, FileType, FileId
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.QcRecordFileId, INSERTED.QcRecordId, INSERTED.FileId
                                            VALUES (@QcRecordId, @FileType, @FileId
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            QcRecordId,
                                            FileType = "resolve",
                                            FileId = resolveFileId,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                }
                            }
                            #endregion

                            #region //將量測EXCEL先存回實體路徑並重新讀取
                            string FileName = "";
                            if (CurrentFileId > 0)
                            {
                                #region //取得原本加密檔案資料，並重新上傳
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.FileId, a.FileContent, a.FileName, a.FileExtension, a.FileSize, a.ClientIP, a.Source
                                        FROM BAS.[File] a
                                        WHERE a.FileId = @FileId";
                                dynamicParameters.Add("FileId", CurrentFileId);

                                var FileResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in FileResult)
                                {
                                    FileName = item.FileName;
                                    ServerPath = Path.Combine(ServerPath, item.FileName + "-" + item.FileId + item.FileExtension);
                                    byte[] fileContent = (byte[])item.FileContent;
                                    File.WriteAllBytes(ServerPath, fileContent); // Requires System.IO

                                    #region //將檔案重新上傳
                                    System.Net.WebClient wc = new System.Net.WebClient();
                                    byte[] newFilebytes = wc.DownloadData(ServerPath);

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO BAS.[File] (CompanyId, FileName, FileContent, FileExtension, FileSize
                                            , ClientIP, Source, DeleteStatus
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.FileId
                                            VALUES (@CompanyId, @FileName, @FileContent, @FileExtension, @FileSize
                                            , @ClientIP, @Source, @DeleteStatus
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            CompanyId = CurrentCompany,
                                            item.FileName,
                                            FileContent = newFilebytes,
                                            item.FileExtension,
                                            item.FileSize,
                                            item.ClientIP,
                                            item.Source,
                                            DeleteStatus = "N",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });
                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    int newFileId = -1;
                                    foreach (var item2 in insertResult)
                                    {
                                        newFileId = item2.FileId;
                                    }
                                    #endregion

                                    #region //UPDATE原本FileId
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.QcRecord SET
                                            CurrentFileId = @CurrentFileId,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE QcRecordId = @QcRecordId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            CurrentFileId = newFileId,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            QcRecordId
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //刪除實體檔案
                                    File.Delete(ServerPath);
                                    #endregion
                                }
                                #endregion
                            }
                            #endregion

                            #region //建立量測單據Spreadsheet DATA
                            if (!string.IsNullOrWhiteSpace(QcItemJson) && QcItemJson.ToString() != "[]")
                            {
                                List<QcItemJson> qcItemJson = JsonConvert.DeserializeObject<List<QcItemJson>>(QcItemJson);
                                int row = 2;
                                foreach (var item in qcItemJson)
                                {
                                    #region //若有機台，整理序號格式
                                    string QcItemNo = "";
                                    if (item.QcMachineNumber.Length > 0)
                                    {
                                        #region //確認量測機資料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT b.MachineDesc MachineName
                                                FROM QMS.QmmDetail a 
                                                INNER JOIN MES.Machine b ON a.MachineId = b.MachineId
                                                INNER JOIN QMS.QcMachineMode c ON a.QcMachineModeId = c.QcMachineModeId
                                                WHERE a.MachineNumber = @MachineNumber
                                                AND c.CompanyId = @CompanyId";
                                        dynamicParameters.Add("MachineNumber", item.QcMachineNumber);
                                        dynamicParameters.Add("CompanyId", CurrentCompany);

                                        var machineResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (machineResult.Count() <= 0) throw new SystemException($"機台【{item.QcMachineNumber}】查無資料!");

                                        item.QcMachineName = machineResult.FirstOrDefault().MachineName;
                                        #endregion

                                        QcItemNo = item.QcItemNo;
                                        string firstPart = QcItemNo.Substring(0, 3);
                                        string secondPart = QcItemNo.Substring(3, 4);
                                        QcItemNo = firstPart + item.QcMachineNumber + secondPart;
                                    }
                                    #endregion

                                    #region //設定量測項目、備註、上下限
                                    data = new Data()
                                    {
                                        cell = "A" + row,
                                        css = "",
                                        format = "text",
                                        value = QcItemNo.Length > 0 ? QcItemNo : item.QcItemNo,
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "B" + row,
                                        css = "",
                                        format = "text",
                                        value = "",
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "C" + row,
                                        css = "",
                                        format = "text",
                                        value = item.QcItemName,
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "D" + row,
                                        css = "",
                                        format = "text",
                                        value = item.QcItemDesc,
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "E" + row,
                                        css = "",
                                        format = "text",
                                        value = item.QcMachineName,
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "F" + row,
                                        css = "",
                                        format = "text",
                                        value = item.DesignValue != null ? item.DesignValue.ToString() : "",
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "G" + row,
                                        css = "",
                                        format = "text",
                                        value = item.UpperTolerance != null ? item.UpperTolerance.ToString() : "",
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "H" + row,
                                        css = "",
                                        format = "text",
                                        value = item.LowerTolerance != null ? item.LowerTolerance.ToString() : "",
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "I" + row,
                                        css = "",
                                        format = "text",
                                        value = "",
                                    };
                                    datas.Add(data);

                                    row++;
                                    #endregion
                                }
                            }
                            else if (QcDepartment == "Y" && QcTypeNo == "IPQC")
                            {
                                #region //取得預設量測項目資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance, a.Remark
                                        , ISNULL(a.QcItemDesc, '') QcItemDesc, a.BallMark, a.Unit, a.QmmDetailId
                                        , b.QcItemNo, b.QcItemName, b.QcItemDesc OriQcItemDesc
                                        , c.MachineNumber
                                        FROM MES.MoProcessQcItem a 
                                        INNER JOIN QMS.QcItem b ON a.QcItemId = b.QcItemId
                                        LEFT JOIN QMS.QmmDetail c ON a.QmmDetailId = c.QmmDetailId
                                        WHERE a.MoProcessId = @MoProcessId";
                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                var QcItemResult = sqlConnection.Query(sql, dynamicParameters);

                                if (QcItemResult.Count() <= 0)
                                {
                                    sql = @"SELECT a.RoutingItemQcItemId, a.RoutingItemId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance
                                            , a.Remark, ISNULL(a.QcItemDesc, '') QcItemDesc, a.BallMark, a.Unit, a.QmmDetailId
                                            , e.QcItemNo, e.QcItemName, e.QcItemDesc OriQcItemDesc
                                            , g.MachineNumber
                                            , h.MachineDesc
                                            FROM MES.RoutingItemQcItem a 
                                            INNER JOIN MES.RoutingItemProcess b ON a.ItemProcessId = b.ItemProcessId
                                            INNER JOIN MES.RoutingProcess c ON b.RoutingProcessId = c.RoutingProcessId
                                            INNER JOIN MES.MoProcess d ON c.ProcessId = d.ProcessId
                                            INNER JOIN QMS.QcItem e ON a.QcItemId = e.QcItemId
                                            INNER JOIN MES.MoRouting f ON d.MoId = f.MoId AND f.RoutingItemId = a.RoutingItemId
                                            LEFT JOIN QMS.QmmDetail g ON a.QmmDetailId = g.QmmDetailId
                                            LEFT JOIN MES.Machine h ON g.MachineId = h.MachineId
                                            WHERE d.MoProcessId = @MoProcessId";
                                    dynamicParameters.Add("MoProcessId", MoProcessId);

                                    QcItemResult = sqlConnection.Query(sql, dynamicParameters);
                                }

                                if (QcItemResult.Count() > 0)
                                {
                                    int row = 2;
                                    foreach (var item in QcItemResult)
                                    {
                                        #region //若有機台，整理序號格式
                                        string QcItemNo = "";
                                        if (MachineNumber.Length > 0)
                                        {
                                            QcItemNo = item.QcItemNo;
                                            string firstPart = QcItemNo.Substring(0, 3);
                                            string secondPart = QcItemNo.Substring(3, 4);
                                            QcItemNo = firstPart + MachineNumber + secondPart;
                                        }
                                        else
                                        {
                                            if (item.MachineNumber != null)
                                            {
                                                QcItemNo = item.QcItemNo;
                                                string firstPart = QcItemNo.Substring(0, 3);
                                                string secondPart = QcItemNo.Substring(3, 4);
                                                QcItemNo = firstPart + item.MachineNumber + secondPart;
                                                MachineName = item.MachineDesc;
                                            }
                                        }
                                        #endregion

                                        #region //設定量測項目、備註、上下限
                                        data = new Data()
                                        {
                                            cell = "A" + row,
                                            css = "",
                                            format = "text",
                                            value = QcItemNo.Length > 0 ? QcItemNo : item.QcItemNo,
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "B" + row,
                                            css = "",
                                            format = "text",
                                            value = item.BallMark != null ? item.BallMark.ToString() : "",
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "C" + row,
                                            css = "",
                                            format = "text",
                                            value = item.QcItemName,
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "D" + row,
                                            css = "",
                                            format = "text",
                                            value = item.QcItemDesc.Length > 0 ? item.QcItemDesc : item.OriQcItemDesc,
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "E" + row,
                                            css = "",
                                            format = "text",
                                            value = MachineName,
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "F" + row,
                                            css = "",
                                            format = "text",
                                            value = item.DesignValue != null ? item.DesignValue.ToString() : "",
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "G" + row,
                                            css = "",
                                            format = "text",
                                            value = item.UpperTolerance != null ? item.UpperTolerance.ToString() : "",
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "H" + row,
                                            css = "",
                                            format = "text",
                                            value = item.LowerTolerance != null ? item.LowerTolerance.ToString() : "",
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "I" + row,
                                            css = "",
                                            format = "text",
                                            value = item.Unit != null ? item.Unit.ToString() : "",
                                        };
                                        datas.Add(data);

                                        row++;
                                        #endregion
                                    }
                                }
                                else
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.ParameterQcItemId, a.ParameterId, a.QcItemId, ISNULL(a.QcItemDesc, '') QcItemDesc
                                            , ISNULL(a.DesignValue, 0) DesignValue, ISNULL(a.UpperTolerance, 0) UpperTolerance
                                            , ISNULL(a.LowerTolerance, 0) LowerTolerance, ISNULL(a.Remark, '') Remark
                                            , a.BallMark, a.Unit, a.QmmDetailId
                                            , e.QcItemNo, e.QcItemName, e.QcItemDesc OriQcItemDesc
                                            , f.MachineNumber
                                            , g.MachineDesc
                                            FROM MES.ProcessParameterQcItem a 
                                            INNER JOIN MES.ProcessParameter b ON a.ParameterId = b.ParameterId
                                            INNER JOIN MES.MoProcess c ON b.ProcessId = c.ProcessId
                                            INNER JOIN MES.ManufactureOrder d ON c.MoId = d.MoId AND b.ModeId = d.ModeId
                                            INNER JOIN QMS.QcItem e ON a.QcItemId = e.QcItemId
                                            LEFT JOIN QMS.QmmDetail f ON a.QmmDetailId = f.QmmDetailId 
                                            LEFT JOIN MES.Machine g ON f.MachineId = g.MachineId
                                            WHERE c.MoProcessId = @MoProcessId";
                                    dynamicParameters.Add("MoProcessId", MoProcessId);

                                    var ProcessParameterQcItemResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (ProcessParameterQcItemResult.Count() <= 0) throw new SystemException("此製程尚未設定量測項目，無法新增!!");

                                    int row = 2;
                                    foreach (var item in ProcessParameterQcItemResult)
                                    {
                                        #region //若有機台，整理序號格式
                                        string QcItemNo = "";
                                        if (MachineNumber.Length > 0)
                                        {
                                            QcItemNo = item.QcItemNo;
                                            string firstPart = QcItemNo.Substring(0, 3);
                                            string secondPart = QcItemNo.Substring(3, 4);
                                            QcItemNo = firstPart + MachineNumber + secondPart;
                                        }
                                        else
                                        {
                                            if (item.MachineNumber != null)
                                            {
                                                QcItemNo = item.QcItemNo;
                                                string firstPart = QcItemNo.Substring(0, 3);
                                                string secondPart = QcItemNo.Substring(3, 4);
                                                QcItemNo = firstPart + item.MachineNumber + secondPart;
                                                MachineName = item.MachineDesc;
                                            }
                                        }
                                        #endregion

                                        #region //設定量測項目、備註、上下限
                                        data = new Data()
                                        {
                                            cell = "A" + row,
                                            css = "",
                                            format = "text",
                                            value = QcItemNo.Length > 0 ? QcItemNo : item.QcItemNo,
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "B" + row,
                                            css = "",
                                            format = "text",
                                            value = item.BallMark != null ? item.BallMark.ToString() : "",
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "C" + row,
                                            css = "",
                                            format = "text",
                                            value = item.QcItemName,
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "D" + row,
                                            css = "",
                                            format = "text",
                                            value = item.QcItemDesc.Length > 0 ? item.QcItemDesc : item.OriQcItemDesc,
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "E" + row,
                                            css = "",
                                            format = "text",
                                            value = MachineName,
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "F" + row,
                                            css = "",
                                            format = "text",
                                            value = item.DesignValue != null ? item.DesignValue.ToString() : "",
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "G" + row,
                                            css = "",
                                            format = "text",
                                            value = item.UpperTolerance != null ? item.UpperTolerance.ToString() : "",
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "H" + row,
                                            css = "",
                                            format = "text",
                                            value = item.LowerTolerance != null ? item.LowerTolerance.ToString() : "",
                                        };
                                        datas.Add(data);

                                        data = new Data()
                                        {
                                            cell = "I" + row,
                                            css = "",
                                            format = "text",
                                            value = item.Unit != null ? item.Unit.ToString() : "",
                                        };
                                        datas.Add(data);

                                        row++;
                                        #endregion
                                    }
                                }
                                #endregion
                            }
                            else if (QcDepartment == "Y" && QcTypeNo == "OQC")
                            {
                                #region //取得品號允收標準
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MtlQcItemId, a.MtlItemId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance
                                        , a.QcItemDesc, a.SortNumber, a.BallMark, a.Unit, a.QmmDetailId
                                        , b.QcItemNo, b.QcItemName, b.QcItemDesc OriQcItemDesc
                                        , c.MachineNumber
                                        , d.MachineDesc
                                        FROM PDM.MtlQcItem a
                                        INNER JOIN QMS.QcItem b ON a.QcItemId = b.QcItemId
                                        LEFT JOIN QMS.QmmDetail c ON a.QmmDetailId = c.QmmDetailId
                                        LEFT JOIN MES.Machine d ON c.MachineId = d.MachineId
                                        WHERE a.MtlItemId = @MtlItemId
                                        AND a.[Status] = 'A' 
                                        ORDER BY a.SortNumber";
                                dynamicParameters.Add("MtlItemId", MtlItemId);

                                var MtlQcItemResult = sqlConnection.Query(sql, dynamicParameters);
                                #endregion

                                #region //設定單身量測標準
                                int row = 2;
                                foreach (var item in MtlQcItemResult)
                                {
                                    #region //若有機台，整理序號格式
                                    string QcItemNo = "";
                                    if (MachineNumber.Length > 0)
                                    {
                                        QcItemNo = item.QcItemNo;
                                        string firstPart = QcItemNo.Substring(0, 3);
                                        string secondPart = QcItemNo.Substring(3, 4);
                                        QcItemNo = firstPart + MachineNumber + secondPart;
                                    }
                                    else
                                    {
                                        if (item.MachineNumber != null)
                                        {
                                            QcItemNo = item.QcItemNo;
                                            string firstPart = QcItemNo.Substring(0, 3);
                                            string secondPart = QcItemNo.Substring(3, 4);
                                            QcItemNo = firstPart + item.MachineNumber + secondPart;
                                            MachineName = item.MachineDesc;
                                        }
                                    }
                                    #endregion

                                    #region //設定量測項目、備註、上下限
                                    data = new Data()
                                    {
                                        cell = "A" + row,
                                        css = "",
                                        format = "text",
                                        value = QcItemNo.Length > 0 ? QcItemNo : item.QcItemNo,
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "B" + row,
                                        css = "",
                                        format = "text",
                                        value = item.BallMark != null ? item.BallMark.ToString() : "",
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "C" + row,
                                        css = "",
                                        format = "text",
                                        value = item.QcItemName,
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "D" + row,
                                        css = "",
                                        format = "text",
                                        value = item.QcItemDesc.Length > 0 ? item.QcItemDesc : item.OriQcItemDesc,
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "E" + row,
                                        css = "",
                                        format = "text",
                                        value = MachineName,
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "F" + row,
                                        css = "",
                                        format = "text",
                                        value = item.DesignValue != null ? item.DesignValue.ToString() : "",
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "G" + row,
                                        css = "",
                                        format = "text",
                                        value = item.UpperTolerance != null ? item.UpperTolerance.ToString() : "",
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "H" + row,
                                        css = "",
                                        format = "text",
                                        value = item.LowerTolerance != null ? item.LowerTolerance.ToString() : "",
                                    };
                                    datas.Add(data);

                                    data = new Data()
                                    {
                                        cell = "I" + row,
                                        css = "",
                                        format = "text",
                                        value = item.Unit != null ? item.Unit.ToString() : "",
                                    };
                                    datas.Add(data);

                                    row++;
                                    #endregion
                                }
                                #endregion
                            }

                            #region //處理條碼部分
                            int startIndex = 13;
                            bool checkLettering = true;
                            if (BarcodeList.Length > 0)
                            {
                                List<string> ItemSeqList = new List<string>();
                                foreach (var barcodeId in BarcodeIdList)
                                {
                                    #region //確認條碼正確性
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeNo, a.CurrentProdStatus, a.BarcodeStatus
                                            , ISNULL(b.ItemValue, '') ItemValue, ISNULL(b.ItemSeq, -1) ItemSeq
                                            FROM MES.Barcode a 
                                            LEFT JOIN MES.BarcodeAttribute b ON a.BarcodeId = b.BarcodeId AND b.ItemNo = 'Lettering'
                                            WHERE a.BarcodeId = @BarcodeId
                                            ORDER BY b.ItemSeq";
                                    dynamicParameters.Add("BarcodeId", barcodeId);

                                    var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeResult.Count() <= 0) throw new SystemException("條碼資料錯誤!!");

                                    foreach (var item in BarcodeResult)
                                    {
                                        if (item.CurrentProdStatus != "P") throw new SystemException("條碼【" + item.BarcodeNo + "】狀態非良品，不可送測!!");
                                        if (item.BarcodeStatus != "0" && item.BarcodeStatus != "1") throw new SystemException("條碼【" + item.BarcodeNo + "】目前非在製中，無法送測!!");
                                        if (item.ItemSeq <= 0)
                                        {
                                            if (CurrentCompany == 4 || CurrentCompany == 2)
                                            {
                                                #region //若無刻字，檢查此製程及之前製程是否需要維護刻字屬性
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TOP 1 1
                                                        FROM MES.MoProcessItem a 
                                                        INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                                        WHERE b.MoId = @MoId
                                                        AND b.SortNumber <= @SortNumber
                                                        AND a.ItemNo = 'Lettering'";
                                                dynamicParameters.Add("MoId", MoId);
                                                dynamicParameters.Add("SortNumber", SortNumber);

                                                var MoProcessItemResult = sqlConnection.Query(sql, dynamicParameters);

                                                if (MoProcessItemResult.Count() > 0) throw new SystemException("條碼【" + item.BarcodeNo + "】尚未綁定刻字，無法送測!!");
                                                #endregion

                                                checkLettering = false;
                                            }
                                            else
                                            {
                                                throw new SystemException("條碼【" + item.BarcodeNo + "】尚未綁定刻字，無法送測!!");
                                            }
                                        }
                                        ItemSeqList.Add(item.ItemSeq.ToString());
                                        BarcodeInfo.Add(item.BarcodeNo, item.ItemValue);
                                    }
                                    #endregion
                                }

                                #region //綁定SpreadsheetData
                                if (checkLettering == true)
                                {
                                    for (var i = 0; i < ItemSeqList.Count(); i++)
                                    {
                                        string cell = Convert.ToChar(64 + startIndex + i).ToString();

                                        data = new Data()
                                        {
                                            cell = cell + "1",
                                            css = "",
                                            format = "text",
                                            value = ItemSeqList[i],
                                        };
                                        datas.Add(data);
                                    }
                                }
                                else
                                {
                                    int i = 0;
                                    foreach (var item in BarcodeInfo)
                                    {
                                        string cell = Convert.ToChar(64 + startIndex + i).ToString();

                                        data = new Data()
                                        {
                                            cell = cell + "1",
                                            css = "",
                                            format = "text",
                                            value = item.Key,
                                        };
                                        datas.Add(data);
                                        i++;
                                    }
                                }
                                #endregion
                            }
                            else
                            {
                                // 排除鍍膜分光量測站
                                if (SourcePage != "ViewQcDataPotNumber") throw new SystemException("至少需綁定一顆條碼才能送檢!!");
                            }
                            #endregion

                            #region //整合Spreadsheet格式
                            Sheets sheets = new Sheets()
                            {
                                name = "sheet1",
                                data = datas
                            };
                            sheetss.Add(sheets);

                            SpreadsheetModel spreadsheetModel = new SpreadsheetModel()
                            {
                                sheets = sheetss
                            };

                            string SpreadsheetData = JsonConvert.SerializeObject(spreadsheetModel);

                            // 排除鍍膜分光量測站
                            if (SourcePage != "ViewQcDataPotNumber") 
                            {
                                #region //更新至QcRecord SpreadsheetData
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.QcRecord SET
                                        SpreadsheetData = @SpreadsheetData,
                                        InputType = @InputType,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE QcRecordId = @QcRecordId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        SpreadsheetData,
                                        InputType = checkLettering == true ? "Lettering" : "BarcodeNo",
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        QcRecordId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion
                            #endregion

                            #region //統整回傳前端資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.QcRecordId, a.CurrentFileId
                                    , (
                                        SELECT x.FileId
                                        FROM MES.QcRecordFile x
                                        WHERE x.QcRecordId = a.QcRecordId
                                        FOR JSON PATH, ROOT('data')
                                    ) QcRecordFile
                                    FROM MES.QcRecord a
                                    WHERE a.QcRecordId = @QcRecordId";
                            dynamicParameters.Add("QcRecordId", QcRecordId);

                            var QcRecordResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //取得使用者相關資訊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UserId, b.DepartmentNo, b.DepartmentName
                                    FROM BAS.[User] a 
                                    INNER JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                                    WHERE UserId = @UserId";
                            dynamicParameters.Add("UserId", CurrentUser);

                            var UserResult = sqlConnection.Query(sql, dynamicParameters);

                            if (UserResult.Count() <= 0) throw new SystemException("使用者資訊錯誤!!");

                            string DepartmentNo = "";
                            string DepartmentName = "";
                            foreach (var item in UserResult)
                            {
                                DepartmentNo = item.DepartmentNo;
                                DepartmentName = item.DepartmentName;
                            }
                            #endregion

                            #region //MAMO推播
                            if (QcDepartment == "Y")
                            {
                                string Company = CompanyNo;
                                string PushType = "Channel";

                                #region //取得推播群組
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.ChannelId
                                        FROM MES.QcMamoChannel a 
                                        WHERE a.ModeId = @ModeId
                                        AND a.PushType = 'A'";
                                dynamicParameters.Add("ModeId", ModeId);

                                var QcMamoChannelResult = sqlConnection.Query(sql, dynamicParameters);

                                if (QcMamoChannelResult.Count() <= 0) throw new SystemException("此生產模式尚未設定【送測】推播群組，請洽資訊人員協助!!");

                                string SendId = "";
                                foreach (var item in QcMamoChannelResult)
                                {
                                    int channelId = item.ChannelId;
                                    SendId = channelId.ToString();
                                }
                                #endregion

                                #region //組傳送文字格式
                                string barcodeInfoDesc = "| 條碼 | 刻字 |\n| :-- | :-- |\n";
                                int count = 0;
                                foreach (var item in BarcodeInfo)
                                {
                                    barcodeInfoDesc += "| " + item.Key + " | " + item.Value + " |\n";
                                    count++;

                                    #region //取得條碼資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeId
                                            FROM MES.Barcode a
                                            WHERE a.BarcodeNo = @BarcodeNo";
                                    dynamicParameters.Add("BarcodeNo", item.Key);

                                    var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeResult.Count() <= 0) throw new SystemException("查無此條碼【" + item.Key + "】資訊!!");

                                    int BarcodeId = -1;
                                    foreach (var item2 in BarcodeResult)
                                    {
                                        BarcodeId = item2.BarcodeId;
                                    }
                                    #endregion

                                    #region //新增送測條碼清單
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.QcReceiptBarcode (QcRecordId, BarcodeId
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.QrbId
                                            VALUES (@QcRecordId, @BarcodeId
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            QcRecordId,
                                            BarcodeId,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy
                                        });

                                    var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion
                                }

                                string Content = "### 【新送測需求通知】:\n" +
                                                 "##### 製令: " + WoErpFullNo + "\n" +
                                                 "##### 品號: " + MtlItemNo + "\n" +
                                                 "##### 品名: " + MtlItemName + "\n" +
                                                 "##### 製程: " + ProcessAlias + "\n" +
                                                 "##### 送檢時間: " + CreateDate.ToString() + "\n" +
                                                 "- 量測類型: " + QcTypeNo + QcTypeName + "\n" +
                                                 "- 送檢單位: " + DepartmentNo + " " + DepartmentName + "\n" +
                                                 "- 量測單據連結如下:\n" +
                                                 "https://bm.zy-tech.com.tw/QcDataManagement/QcDataManagement?QcRecordId=" + QcRecordId + "\n" +
                                                 "- 送測條碼:\n" + barcodeInfoDesc + "\n";
                                #endregion

                                #region //取得標記USER資料
                                List<string> Tags = new List<string>();
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.UserId
                                        , b.UserNo, b.UserName
                                        FROM MAMO.ChannelMembers a 
                                        INNER JOIN BAS.[User] b ON a.UserId = b.UserId
                                        INNER JOIN BAS.Department c ON b.DepartmentId = c.DepartmentId
                                        WHERE a.ChannelId = @SendId
                                        AND (c.DepartmentName LIKE '%品保%' OR c.DepartmentName LIKE '%品管%')
                                        AND c.CompanyId = @CompanyId
                                        AND c.Status = 'A'";
                                dynamicParameters.Add("SendId", SendId);
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var ChannelMembersResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item in ChannelMembersResult)
                                {
                                    Tags.Add(item.UserNo);
                                }
                                #endregion

                                #region //Files
                                List<int> Files = new List<int>();
                                #endregion

                                string MamoResult = mamoHelper.SendMessage(Company, CurrentUser, PushType, SendId, Content, Tags, Files);

                                JObject MamoResultJson = JObject.Parse(MamoResult);
                                if (MamoResultJson["status"].ToString() != "success")
                                {
                                    throw new SystemException(MamoResultJson["msg"].ToString());
                                }
                            }
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)",
                                data = QcRecordResult
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //出貨檢
        #region //AddTempOQcMeasureData-- 新增出貨檢量測備份資料 -- Ann 2022-11-23
        public string AddTempOQcMeasureData(string TempOQcItemData)
        {
            try
            {
                if (TempOQcItemData.Length <= 0) throw new SystemException("【量測資料】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        var TempOQcItemJson = JObject.Parse(TempOQcItemData);
                        int rowsAffected = 0;
                        int BarcodeId = -1;
                        dynamicParameters = new DynamicParameters();

                        List<int> barcodeIdList = new List<int>();
                        foreach (var item in TempOQcItemJson["tempQcItemInfo"])
                        {
                            if (item["MeasureValue"].ToString().Length <= 0) throw new SystemException("量測值不能為空!");

                            #region //判斷量測設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MoId
                                    FROM QMS.ShippingQcItemSpec
                                    WHERE ShippingQcSpecId = @ShippingQcSpecId";
                            dynamicParameters.Add("ShippingQcSpecId", Convert.ToInt32(item["ShippingQcSpecId"]));

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("量測設定資料錯誤!");

                            int MoId = -1;
                            foreach (var item2 in result)
                            {
                                MoId = item2.MoId;
                            }
                            #endregion

                            #region //判斷條碼資料是否正確
                            if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 BarcodeId
                                        FROM MES.Barcode
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item["BarcodeNo"].ToString());

                                var result2 = sqlConnection.Query(sql, dynamicParameters);
                                if (result2.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                                foreach (var item2 in result2)
                                {
                                    BarcodeId = item2.BarcodeId;
                                }

                                if (!barcodeIdList.Contains(BarcodeId))
                                {
                                    #region //先將原本的暫存資料刪除
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE QMS.TempOQcMeasureData
                                            WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", BarcodeId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    barcodeIdList.Add(BarcodeId);
                                }
                            }
                            else
                            {
                                #region //先將原本的暫存資料刪除
                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE QMS.TempOQcMeasureData
                                        WHERE ShippingQcSpecId = @ShippingQcSpecId
                                        AND BarcodeId IS NULL";
                                dynamicParameters.Add("ShippingQcSpecId", Convert.ToInt32(item["ShippingQcSpecId"]));

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //判斷量測項目資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QcItem
                                    WHERE QcItemId = @QcItemId";
                            dynamicParameters.Add("QcItemId", Convert.ToInt32(item["QcItemId"]));

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("量測項目資料錯誤!");
                            #endregion

                            #region //判斷量測機型資料是否正確
                            if (Convert.ToInt32(item["QcMachineModeId"]) > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM QMS.QcMachineMode
                                        WHERE QcMachineModeId = @QcMachineModeId";
                                dynamicParameters.Add("QcMachineModeId", Convert.ToInt32(item["QcMachineModeId"]));

                                var result4 = sqlConnection.Query(sql, dynamicParameters);
                                if (result4.Count() <= 0) throw new SystemException("量測機型資料錯誤!");
                            }
                            #endregion

                            #region //判斷量測機台資料是否正確
                            if (Convert.ToInt32(item["QmmDetailId"]) > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM QMS.QmmDetail
                                        WHERE QmmDetailId = @QmmDetailId";
                                dynamicParameters.Add("QmmDetailId", Convert.ToInt32(item["QmmDetailId"]));

                                var result5 = sqlConnection.Query(sql, dynamicParameters);
                                if (result5.Count() <= 0) throw new SystemException("量測機台資料錯誤!");
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO QMS.TempOQcMeasureData (ShippingQcSpecId, BarcodeId, QmmDetailId, MeasureValue, MakeCount, Status, Remark
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.TempOQmdId
                                    VALUES (@ShippingQcSpecId, @BarcodeId, @QmmDetailId, @MeasureValue, @MakeCount, @Status, @Remark
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ShippingQcSpecId = Convert.ToInt32(item["ShippingQcSpecId"]),
                                    BarcodeId = BarcodeId > 0 ? BarcodeId : (int?)null,
                                    QmmDetailId = Convert.ToInt32(item["QmmDetailId"]) > 0 ? Convert.ToInt32(item["QmmDetailId"]) : (int?)null,
                                    MeasureValue = item["MeasureValue"].ToString(),
                                    Status = "A",
                                    MakeCount = Convert.ToInt32(item["MakeCount"]),
                                    Remark = item["Remark"].ToString(),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = Convert.ToInt32(item["CreateUserId"]) == CreateBy ? CreateBy : Convert.ToInt32(item["CreateUserId"]),
                                    LastModifiedBy = Convert.ToInt32(item["CreateUserId"]) == CreateBy ? LastModifiedBy : Convert.ToInt32(item["CreateUserId"])
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBarcodeOQcRecord-- 新增出貨檢/試產檢紀錄 + 上傳量測數據 + 自動建立品異單 -- Ann 2022-11-23
        public string AddBarcodeOQcRecord(string BarcodeQcRecordData, int MoId, string TempOQcItemData, string QcType)
        {
            try
            {
                if (BarcodeQcRecordData.Length <= 0) throw new SystemException("【出貨檢/試產檢數據】不能為空!");
                if (QcType != "OQC" && QcType != "PVTQC") throw new SystemException("【量測數據類型】資料錯誤!");
                int ProgrammerUserId = -1;
                var barcodeQcRecordJson = JObject.Parse(BarcodeQcRecordData);
                Dictionary<string, int> qcRecord = new Dictionary<string, int>();
                Dictionary<int, int?> qcBarcodeList = new Dictionary<int, int?>();
                List<int?> barcodeIdList = new List<int?>();
                int rowsAffected = 0;
                int? BarcodeId = -1;
                int BarcodeProcessId = -1;
                int BarcodeQty = -1;
                string jsonString = "";
                int QcRecordId = -1;
                int qcRecordCount = 0;
                List<QcNgCode> qcNgCodes = new List<QcNgCode>();
                string qcCauseJsonString = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //建立BarcodeQcRecord
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        foreach (var item in barcodeQcRecordJson["barcodeQcRecordInfo"])
                        {
                            if (item["QcStatus"].ToString().Length <= 0) throw new SystemException("【人員判斷】不能為空!");

                            if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null")
                            {
                                #region //判斷條碼資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 BarcodeId, BarcodeQty
                                        FROM MES.Barcode
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item["BarcodeNo"].ToString());

                                var result7 = sqlConnection.Query(sql, dynamicParameters);
                                if (result7.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                                foreach (var item2 in result7)
                                {
                                    BarcodeId = item2.BarcodeId;
                                    BarcodeQty = item2.BarcodeQty;
                                    barcodeIdList.Add(BarcodeId);
                                }
                                #endregion
                            }

                            if (item["SubResponsibleDeptId"].ToString().Length > 0)
                            {
                                #region //判斷副責任單位資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM BAS.Department
                                        WHERE DepartmentId = @DepartmentId";
                                dynamicParameters.Add("DepartmentId", Convert.ToInt32(item["SubResponsibleDeptId"]));

                                var result9 = sqlConnection.Query(sql, dynamicParameters);
                                if (result9.Count() <= 0) throw new SystemException("副責任單位資料錯誤!");
                                #endregion
                            }

                            if (item["SubResponsibleUserId"].ToString().Length > 0)
                            {
                                #region //判斷副責任者資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM BAS.[User]
                                        WHERE UserId = @UserId";
                                dynamicParameters.Add("UserId", Convert.ToInt32(item["SubResponsibleUserId"]));

                                var result10 = sqlConnection.Query(sql, dynamicParameters);
                                if (result10.Count() <= 0) throw new SystemException("副責任者資料錯誤!");
                                #endregion
                            }

                            #region //判斷製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.ManufactureOrder
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var result11 = sqlConnection.Query(sql, dynamicParameters);
                            if (result11.Count() <= 0) throw new SystemException("製令資料錯誤!");
                            #endregion

                            #region //若迴圈第一次，建立QcRecord
                            if (qcRecordCount == 0)
                            {
                                Boolean barcodeFlag = false;
                                if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null") barcodeFlag = true;
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.QcRecord (QcNoticeId, QcType, MoId, MoProcessId
                                        , SystemStatus, QcStatus, QcUserId, Remark
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.QcRecordId
                                        VALUES (@QcNoticeId, @QcType, @MoId, @MoProcessId
                                        , @SystemStatus, @QcStatus, @QcUserId, @Remark
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        QcNoticeId = Convert.ToInt32(item["QcNoticeId"]),
                                        QcType,
                                        MoId,
                                        MoProcessId = (int?)null,
                                        SystemStatus = barcodeFlag == false ? "N" : "",
                                        QcStatus = barcodeFlag == false ? item["QcStatus"].ToString() : "",
                                        QcUserId = barcodeFlag == false ? CreateBy : (int?)null,
                                        Remark = barcodeFlag == false ? item["Remark"].ToString() : "",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();

                                foreach (var item2 in insertResult)
                                {
                                    QcRecordId = item2.QcRecordId;
                                    qcRecord.Add(item["BarcodeNo"].ToString(), item2.QcRecordId);
                                }
                            }
                            #endregion

                            #region //INSERT MES.QcBarcode
                            if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null")
                            {
                                int PassQty = -1;
                                int NgQty = -1;
                                if (item["QcStatus"].ToString() == "P")
                                {
                                    PassQty = BarcodeQty;
                                    NgQty = 0;
                                }
                                else
                                {
                                    PassQty = 0;
                                    NgQty = BarcodeQty;
                                }

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.QcBarcode (QcRecordId, BarcodeProcessId, BarcodeId, PassQty, NgQty, SystemStatus, QcStatus, QcUserId, Remark, Status
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.QcBarcodeId, INSERTED.BarcodeId
                                        VALUES (@QcRecordId, @BarcodeProcessId, @BarcodeId, @PassQty, @NgQty, @SystemStatus, @QcStatus, @QcUserId, @Remark, @Status
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcRecordId,
                                    BarcodeProcessId = (int?)null,
                                    BarcodeId,
                                    PassQty,
                                    NgQty,
                                    SystemStatus = "N",
                                    QcStatus = item["QcStatus"].ToString(),
                                    QcUserId = CreateBy,
                                    Remark = item["Remark"].ToString(),
                                    Status = "Y",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                                var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item2 in insertResult2)
                                {
                                    qcBarcodeList.Add(item2.QcBarcodeId, item2.BarcodeId);
                                }
                            }
                            else
                            {
                                qcBarcodeList.Add(-1, BarcodeId);
                            }
                            #endregion

                            qcRecordCount++;
                        }
                        #endregion

                        #region //上傳量測數據
                        var tempQcItemJson = JObject.Parse(TempOQcItemData);
                        foreach (var item in tempQcItemJson["tempQcItemInfo"])
                        {
                            if (item["MeasureValue"].ToString().Length <= 0) throw new SystemException("量測值不能為空!");
                            if (item["QcResult"].ToString() == "F" && (item["NgCode"] == null || item["NgCodeDesc"] == null)) throw new SystemException("條碼【" + item["BarcodeNo"].ToString() + "】之項目【" + item["QcItemName"].ToString() + "】尚未維護異常原因!");

                            #region //判斷量測設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 CreateBy
                                    FROM QMS.QcNoticeItemSpec
                                    WHERE QcNoticeItemSpecId = @QcNoticeItemSpecId";
                            dynamicParameters.Add("QcNoticeItemSpecId", Convert.ToInt32(item["QcNoticeItemSpecId"]));

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("量測設定資料錯誤!");

                            foreach (var item2 in result)
                            {
                                ProgrammerUserId = item2.CreateBy;
                            }
                            #endregion

                            #region //判斷量測項目資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.QcItemId
                                    FROM QMS.QcItem a
                                    WHERE a.QcItemId = @QcItemId";
                            dynamicParameters.Add("QcItemId", Convert.ToInt32(item["QcItemId"]));

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("量測項目資料錯誤!");

                            int QcItemId = -1;
                            foreach (var item2 in result2)
                            {
                                QcItemId = item2.QcItemId;
                            }
                            #endregion

                            #region //判斷量測機型資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QcMachineMode
                                    WHERE QcMachineModeId = @QcMachineModeId";
                            dynamicParameters.Add("QcMachineModeId", Convert.ToInt32(item["QcMachineModeId"]));

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("量測機型資料錯誤!");
                            #endregion

                            #region //判斷量測機台資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QmmDetail
                                    WHERE QmmDetailId = @QmmDetailId";
                            dynamicParameters.Add("QmmDetailId", Convert.ToInt32(item["QmmDetailId"]));

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("量測機台資料錯誤!");
                            #endregion

                            #region //判斷條碼資料是否正確
                            if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT BarcodeId
                                        FROM MES.Barcode
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item["BarcodeNo"].ToString());

                                var result5 = sqlConnection.Query(sql, dynamicParameters);
                                if (result5.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                                foreach (var item2 in result5)
                                {
                                    BarcodeId = item2.BarcodeId;
                                }
                            }
                            else
                            {
                                BarcodeId = -1;
                            }
                            #endregion

                            int CauseId = -1;
                            if (item["QcResult"].ToString() == "F")
                            {
                                #region //判斷異常原因資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.CauseId
                                        FROM QMS.DefectCause a
                                        WHERE a.CauseNo = @CauseNo";
                                dynamicParameters.Add("CauseNo", item["NgCode"].ToString());

                                var CauseResult = sqlConnection.Query(sql, dynamicParameters);
                                if (CauseResult.Count() <= 0) throw new SystemException("異常原因資料錯誤!");

                                foreach (var item2 in CauseResult)
                                {
                                    CauseId = item2.CauseId;
                                }
                                #endregion

                                #region //維護異常原因項目modal
                                QcNgCode qcNgCode = new QcNgCode
                                {
                                    BarcodeId = BarcodeId,
                                    QcItemId = QcItemId,
                                    CauseId = CauseId,
                                    CauseDesc = item["NgCodeDesc"].ToString()
                                };

                                qcNgCodes.Add(qcNgCode);
                                #endregion
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO QMS.QcMeasureData (QcRecordId, QcNoticeItemSpecId, BarcodeId, QmmDetailId, MeasureValue, QcResult, CauseId, CauseDesc, MakeCount, Remark
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@QcRecordId, @QcNoticeItemSpecId, @BarcodeId, @QmmDetailId, @MeasureValue, @QcResult, @CauseId, @CauseDesc, @MakeCount, @Remark
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcRecordId,
                                    QcNoticeItemSpecId = Convert.ToInt32(item["QcNoticeItemSpecId"]),
                                    BarcodeId = BarcodeId > 0 ? BarcodeId : (int?)null,
                                    QmmDetailId = Convert.ToInt32(item["QmmDetailId"]),
                                    MeasureValue = item["MeasureValue"].ToString(),
                                    QcResult = item["QcResult"].ToString(),
                                    CauseId = CauseId > 0 ? CauseId : (int?)null,
                                    CauseDesc = item["NgCodeDesc"] != null ? item["NgCodeDesc"].ToString() : "",
                                    MakeCount = Convert.ToDouble(item["MakeCount"]),
                                    Remark = item["Remark"].ToString(),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = Convert.ToInt32(item["CreateUserId"]) == CreateBy ? CreateBy : Convert.ToInt32(item["CreateUserId"]),
                                    LastModifiedBy = Convert.ToInt32(item["CreateUserId"]) == CreateBy ? LastModifiedBy : Convert.ToInt32(item["CreateUserId"])
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }

                        if (qcNgCodes.Count() > 0)
                        {
                            qcCauseJsonString = JsonConvert.SerializeObject(qcNgCodes);
                            qcCauseJsonString = "{\"data\":" + qcCauseJsonString + "}";
                        }
                        #endregion

                        #region //處理出貨檢判定後結果
                        List<AqBarcode> aqBarcodes = new List<AqBarcode>();
                        #region //迴圈判定
                        foreach (var item in qcBarcodeList)
                        {
                            foreach (var item2 in barcodeQcRecordJson["barcodeQcRecordInfo"])
                            {
                                #region //取得BARCODE資訊
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT BarcodeNo
                                        FROM MES.Barcode
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", item.Value);

                                var barcodeInfoResult = sqlConnection.Query(sql, dynamicParameters);

                                string BarcodeNo = "";
                                foreach (var item3 in barcodeInfoResult)
                                {
                                    BarcodeNo = item3.BarcodeNo;
                                }
                                #endregion

                                if ((item2["BarcodeNo"].ToString() == BarcodeNo || item2["BarcodeNo"].ToString() == "null") && item2["QcStatus"].ToString() == "F")
                                {
                                    #region //自動建立品異單流程
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.QcRecordId, a.QcType, a.MoId, a.MoProcessId, a.CreateBy
                                            , b.DepartmentId ResponsibleDeptId
                                            FROM MES.QcRecord a
                                            INNER JOIN BAS.[User] b ON a.CreateBy = b.UserId
                                            WHERE a.QcRecordId = @QcRecordId";
                                    dynamicParameters.Add("QcRecordId", QcRecordId);

                                    var result = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item3 in result)
                                    {
                                        AqBarcode aqBarcode = new AqBarcode
                                        {
                                            QcType = QcType,
                                            MoId = MoId,
                                            QcRecordId = item3.QcRecordId,
                                            QcBarcodeId = item.Key > 0 ? item.Key : (int?)null,
                                            BarcodeId = item.Value,
                                            ConformUserId = item2["ConformUserId"].ToString().Length > 0 ? Convert.ToInt32(item2["ConformUserId"]) : (int?)null,
                                            ResponsibleDeptId = item3.ResponsibleDeptId,
                                            ResponsibleUserId = item3.CreateBy,
                                            SubResponsibleDeptId = item2["SubResponsibleDeptId"].ToString().Length > 0 ? Convert.ToInt32(item2["SubResponsibleDeptId"]) : (int?)null,
                                            SubResponsibleUserId = item2["SubResponsibleUserId"].ToString().Length > 0 ? Convert.ToInt32(item2["SubResponsibleUserId"]) : (int?)null,
                                            ProgrammerUserId = ProgrammerUserId,
                                            MoProcessId = null,
                                            DocDate = CreateDate
                                        };

                                        aqBarcodes.Add(aqBarcode);
                                    }
                                    #endregion

                                    #region //開始建立品異單
                                    string AbnormalqualityData = JsonConvert.SerializeObject(aqBarcodes);
                                    AbnormalqualityData = "{\"data\":" + AbnormalqualityData + "}";
                                    string AbnormalProjectList = qcCauseJsonString;

                                    dynamicParameters = new DynamicParameters();

                                    int AbnormalqualityId = 0;
                                    int? QcBarcodeId = 0;
                                    int? nullData = null;
                                    var ConformUserId = nullData;
                                    var SubResponsibleDeptId = nullData;
                                    var SubResponsibleUserId = nullData;
                                    //var ProgrammerUserId = nullData;
                                    var ResponsibleSupervisorId = nullData;
                                    string DocDate = DateTime.Now.ToString("yyyyMM");
                                    int? MoProcessId = null;

                                    var AbnormalqualityJson = JObject.Parse(AbnormalqualityData);
                                    var AbnormalProjectListJson = JObject.Parse(AbnormalProjectList);

                                    int ResponsibleUserId = -1;
                                    #region //品異單單頭建立
                                    foreach (var abnorItem in AbnormalqualityJson["data"])
                                    {
                                        if (Convert.ToInt32(abnorItem["MoId"]) <= 0) throw new SystemException("【製令】不能為空!");
                                        if (Convert.ToInt32(abnorItem["ResponsibleDeptId"]) <= 0) throw new SystemException("【責任單位】不能為空!");
                                        if (Convert.ToInt32(abnorItem["ResponsibleUserId"]) <= 0) throw new SystemException("【責任者】不能為空!");
                                        if (Convert.ToString(abnorItem["QcType"]) != "PVTQC")
                                        {
                                            if (Convert.ToInt32(abnorItem["BarcodeId"]) <= 0) throw new SystemException("【條碼】不能為空!");

                                            if (Convert.ToString(abnorItem["QcType"]) != "NON")
                                            {
                                                if (Convert.ToInt32(abnorItem["QcBarcodeId"]) <= 0) throw new SystemException("【檢驗紀錄編號】不能為空!");
                                            }


                                            #region //判斷條碼是否有進品異
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT a.AqBarcodeId,a.ProcessStatus,a.JudgeStatus
                                                    FROM QMS.AqBarcode a
								                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.Add("BarcodeId", Convert.ToInt32(abnorItem["BarcodeId"]));
                                            var resultJudgeStatus = sqlConnection.Query(sql, dynamicParameters);
                                            if (resultJudgeStatus.Count() > 0)
                                            {
                                                string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                                string ProcessStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessStatus;
                                                int AqBarcodeId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).AqBarcodeId;
                                                if (JudgeStatus == "RW")
                                                {
                                                    if (ProcessStatus == "I")
                                                    {
                                                        #region //資料更新
                                                        dynamicParameters = new DynamicParameters();
                                                        sql = @"UPDATE QMS.AqBarcode SET
                                                                ProcessStatus = @ProcessStatus,
                                                                LastModifiedBy = @LastModifiedBy,
                                                                LastModifiedDate = @LastModifiedDate
                                                                WHERE AqBarcodeId = @AqBarcodeId";
                                                        dynamicParameters.AddDynamicParams(
                                                          new
                                                          {
                                                              ProcessStatus = "V",
                                                              ConformUserId,
                                                              LastModifiedBy,
                                                              LastModifiedDate,
                                                              AqBarcodeId
                                                          });
                                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                        #endregion
                                                    }
                                                }
                                            }
                                            #endregion
                                        }

                                        MoId = Convert.ToInt32(abnorItem["MoId"]);
                                        QcType = Convert.ToString(abnorItem["QcType"]);
                                        //DocDate = abnorItem["Docate"].ToString();
                                        ResponsibleUserId = Convert.ToInt32(abnorItem["ResponsibleUserId"]);
                                    }


                                    #region //單號自動取號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(AbnormalqualityNo))), '000'), 3)) + 1 CurrentNum
                                            FROM QMS.Abnormalquality
								            WHERE AbnormalqualityNo NOT LIKE '%[A-Za-z]%'";
                                    int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                                    string AbnormalqualityNo = DocDate + string.Format("{0:000}", currentNum);
                                    #endregion

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO QMS.Abnormalquality (CompanyId, MoId, MoProcessId, AbnormalqualityNo, AbnormalqualityStatus, DocDate, QcType
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.AbnormalqualityId
                                            VALUES (@CompanyId, @MoId, @MoProcessId, @AbnormalqualityNo, @AbnormalqualityStatus, @DocDate, @QcType
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            CompanyId = CurrentCompany,
                                            MoId,
                                            MoProcessId,
                                            AbnormalqualityNo,
                                            AbnormalqualityStatus = "F",
                                            DocDate = DateTime.Now.ToString("yyyyMMdd"),
                                            QcType,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = ResponsibleUserId,
                                            LastModifiedBy = ResponsibleUserId
                                        });
                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected += insertResult.Count();

                                    //取出單頭Id
                                    foreach (var AbnormalqualityItem in insertResult)
                                    {
                                        AbnormalqualityId = AbnormalqualityItem.AbnormalqualityId;
                                    }
                                    #endregion

                                    #region //品異單單身 - 異常條碼建立
                                    foreach (var abnorJsonItem in AbnormalqualityJson["data"])
                                    {

                                        if (QcType != "PVTQC")
                                        {
                                            if (QcType == "IPQC")
                                            {
                                                #region //判斷條碼是否存在
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                                        FROM MES.Barcode a
                                                        INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                                INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                                        WHERE a.BarcodeId = @BarcodeId
                                                        --AND a.BarcodeStatus = '1' 
                                                        AND　c.FinishDate is not null";
                                                dynamicParameters.Add("BarcodeId", Convert.ToInt32(abnorJsonItem["BarcodeId"]));
                                                var result1 = sqlConnection.Query(sql, dynamicParameters);
                                                if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(abnorJsonItem["BarcodeId"]) + "】不存在，請重新輸入!");
                                                #endregion
                                            }
                                            else if (QcType == "OQC")
                                            {
                                                #region //判斷條碼是否存在
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                                        FROM MES.Barcode a
                                                        INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                                INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                                        WHERE a.BarcodeId = @BarcodeId
                                                        AND　c.FinishDate is not null";
                                                dynamicParameters.Add("BarcodeId", Convert.ToInt32(abnorJsonItem["BarcodeId"]));
                                                var result1 = sqlConnection.Query(sql, dynamicParameters);
                                                if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(abnorJsonItem["BarcodeId"]) + "】不存在，請重新輸入!");
                                                #endregion
                                            }


                                            #region //判斷條碼目前是否在品異單
                                            sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                                    FROM QMS.AqBarcode a
                                                    WHERE a.BarcodeId =@BarcodeId
                                                    Order By a.LastModifiedDate DESC
                                                    ";
                                            dynamicParameters.Add("BarcodeId", Convert.ToInt32(abnorJsonItem["BarcodeId"]));
                                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                                            if (result2.Count() > 0)
                                            {
                                                //判斷品異單判斷結果,如果有值且不是S代表已經判定完成,如果條碼有異常可以開立新的品異單
                                                string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                                if (JudgeStatus == null)
                                                {
                                                    throw new SystemException("【條碼Id:" + Convert.ToInt32(abnorJsonItem["BarcodeId"]) + "】目前在品異單判定中，不可以開立品異單");
                                                }
                                                else if (JudgeStatus == "S")
                                                {
                                                    throw new SystemException("【條碼Id:" + Convert.ToInt32(abnorJsonItem["BarcodeId"]) + "】目前判定不良品，不可以開立品異單");
                                                }
                                            }
                                            #endregion
                                        }

                                        #region //判斷資料是否存在
                                        #region //資料 - NOT NULL

                                        #region //判斷檢驗紀錄編號是否存在
                                        if (QcType != "PVTQC")
                                        {
                                            if (QcType != "NON")
                                            {
                                                sql = @"SELECT TOP 1 1
                                                        FROM MES.QcBarcode a
                                                        WHERE a.QcBarcodeId = @QcBarcodeId";
                                                dynamicParameters.Add("QcBarcodeId", Convert.ToInt32(abnorJsonItem["QcBarcodeId"]));
                                                var resultQcBarcodeId = sqlConnection.Query(sql, dynamicParameters);
                                                if (resultQcBarcodeId.Count() <= 0) throw new SystemException("【檢驗紀錄編號:" + abnorJsonItem["QcRecordId"].ToString() + "】不存在，請重新輸入!");
                                            }
                                        }
                                        #endregion

                                        #region //判斷責任單位是否存在
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                                FROM BAS.[User] a
                                                INNER JOIN BAS.Department b on a.DepartmentId = b.DepartmentId
                                                WHERE b.DepartmentId = @ResponsibleDeptId";
                                        dynamicParameters.Add("ResponsibleDeptId", Convert.ToInt32(abnorJsonItem["ResponsibleDeptId"]));

                                        var UserResult = sqlConnection.Query(sql, dynamicParameters);
                                        if (UserResult.Count() <= 0) throw new SystemException("【責任單位】不存在，請重新輸入!");
                                        #endregion

                                        #region //判斷責任者是否存在
                                        dynamicParameters = new DynamicParameters();

                                        sql = @"SELECT TOP 1 1
                                                FROM BAS.[User] a
                                                WHERE a.UserId = @ResponsibleUserId
                                                AND a.Status = 'A'";
                                        dynamicParameters.Add("ResponsibleUserId", Convert.ToInt32(abnorJsonItem["ResponsibleUserId"]));

                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() <= 0) throw new SystemException("【責任者】不存在，請重新輸入!");
                                        #endregion
                                        #endregion

                                        #region //資料 - NULL
                                        #region //判斷合致對象是否存在
                                        if (abnorJsonItem["ConformUserId"].ToString() != "")
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"SELECT TOP 1 1
                                                    FROM BAS.[User] a
                                                    WHERE a.UserId = @ConformUserId
                                                    AND a.Status = 'A'";
                                            dynamicParameters.Add("ConformUserId", Convert.ToInt32(abnorJsonItem["ConformUserId"]));

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() <= 0) throw new SystemException("【合致對象】不存在，請重新輸入!");
                                            ConformUserId = Convert.ToInt32(abnorJsonItem["ConformUserId"]);
                                        }
                                        #endregion

                                        #region //判斷副責任單位是否存在
                                        if (abnorJsonItem["SubResponsibleDeptId"].ToString() != "")
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"SELECT TOP 1 1
                                                    FROM BAS.Department a
                                                    WHERE a.DepartmentId = @SubResponsibleDeptId";
                                            dynamicParameters.Add("SubResponsibleDeptId", Convert.ToInt32(abnorJsonItem["SubResponsibleDeptId"]));

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() <= 0) throw new SystemException("【副責任單位】不存在，請重新輸入!");
                                            SubResponsibleDeptId = Convert.ToInt32(abnorJsonItem["SubResponsibleDeptId"]);
                                        }
                                        #endregion

                                        #region //判斷副責任者是否存在
                                        if (abnorJsonItem["SubResponsibleUserId"].ToString() != "")
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"SELECT TOP 1 1
                                                    FROM BAS.[User] a
                                                    WHERE a.UserId = @SubResponsibleUserId
                                                    AND a.Status = 'A'";
                                            dynamicParameters.Add("SubResponsibleUserId", Convert.ToInt32(abnorJsonItem["SubResponsibleUserId"]));

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() <= 0) throw new SystemException("【副責任者】不存在，請重新輸入!");

                                            SubResponsibleUserId = Convert.ToInt32(abnorJsonItem["SubResponsibleUserId"]);

                                        }
                                        #endregion

                                        #region //判斷編程者是否存在
                                        if (abnorJsonItem["ProgrammerUserId"].ToString() != "")
                                        {
                                            dynamicParameters = new DynamicParameters();

                                            sql = @"SELECT TOP 1 1
                                                    FROM BAS.[User] a
                                                    WHERE a.UserId = @ProgrammerUserId
                                                    AND a.Status = 'A'";
                                            dynamicParameters.Add("ProgrammerUserId", Convert.ToInt32(abnorJsonItem["ProgrammerUserId"]));

                                            result = sqlConnection.Query(sql, dynamicParameters);
                                            if (result.Count() <= 0) throw new SystemException("【編程者】不存在，請重新輸入!");

                                            ProgrammerUserId = Convert.ToInt32(abnorJsonItem["ProgrammerUserId"]);

                                        }
                                        #endregion
                                        #endregion
                                        #endregion

                                        if (QcType != "PVTQC")
                                        {
                                            #region //更新異常條碼目前狀態
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.Barcode SET
                                                    CurrentProdStatus = 'F',
                                                    LastModifiedBy = @LastModifiedBy,
                                                    LastModifiedDate = @LastModifiedDate
                                                    WHERE BarcodeId = @BarcodeId";
                                            dynamicParameters.AddDynamicParams(
                                              new
                                              {
                                                  LastModifiedBy,
                                                  LastModifiedDate,
                                                  BarcodeId = Convert.ToInt32(abnorJsonItem["BarcodeId"])
                                              });
                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion

                                            BarcodeId = Convert.ToInt32(abnorJsonItem["BarcodeId"]);
                                            if (QcType == "NON")
                                            {
                                                if (abnorJsonItem["QcBarcodeId"].Count() == 0)
                                                {
                                                    QcBarcodeId = nullData;
                                                }
                                            }
                                            else
                                            {
                                                QcBarcodeId = Convert.ToInt32(abnorJsonItem["QcBarcodeId"]);
                                            }

                                        }
                                        else
                                        {
                                            BarcodeId = (int?)null;
                                            QcBarcodeId = nullData;
                                        }

                                        #region //新增 - 品異單單身
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO QMS.AqBarcode (AbnormalqualityId, BarcodeId, QcBarcodeId, DefectCauseId, DefectCauseDesc, ConformUserId, 
                                                ResponsibleDeptId, ResponsibleUserId, SubResponsibleDeptId, SubResponsibleUserId, ProgrammerUserId, 
                                                RepairCauseId, RepairCauseDesc, RepairCauseUserId,AqBarcodeStatus
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.AqBarcodeId
                                                VALUES (@AbnormalqualityId, @BarcodeId, @QcBarcodeId, @DefectCauseId, @DefectCauseDesc, @ConformUserId, 
                                                @ResponsibleDeptId, @ResponsibleUserId, @SubResponsibleDeptId, @SubResponsibleUserId, @ProgrammerUserId, 
                                                @RepairCauseId, @RepairCauseDesc, @RepairCauseUserId, @AqBarcodeStatus, 
                                                @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                AbnormalqualityId,
                                                BarcodeId,
                                                QcBarcodeId,
                                                DefectCauseId = nullData,
                                                DefectCauseDesc = nullData,
                                                ConformUserId,
                                                ResponsibleDeptId = Convert.ToInt32(abnorJsonItem["ResponsibleDeptId"]),
                                                ResponsibleUserId = Convert.ToInt32(abnorJsonItem["ResponsibleUserId"]),
                                                SubResponsibleDeptId,
                                                SubResponsibleUserId,
                                                ProgrammerUserId,
                                                RepairCauseId = nullData,
                                                RepairCauseDesc = nullData,
                                                RepairCauseUserId = nullData,
                                                AqBarcodeStatus = 1,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });
                                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult2.Count();

                                        int AqBarcodeId = 0;
                                        foreach (var abnorJsonItem2 in insertResult2)
                                        {
                                            AqBarcodeId = abnorJsonItem2.AqBarcodeId;
                                        }
                                        #endregion

                                        foreach (var item4 in AbnormalProjectListJson["data"])
                                        {
                                            if (BarcodeId == Convert.ToInt32(item4["BarcodeId"]))
                                            {
                                                if (Convert.ToInt32(item4["CauseId"]) <= 0) throw new SystemException("【不良代碼】不能為空!");
                                                if (item4["CauseDesc"].ToString().Length > 100) throw new SystemException("【不良原因】長度錯誤!");

                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO QMS.AqQcItem (AqBarcodeId, QcItemId, DefectCauseId, DefectCauseDesc, RepairCauseId, RepairCauseDesc
                                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                        OUTPUT INSERTED.AqQcItemId
                                                        VALUES (@AqBarcodeId, @QcItemId, @DefectCauseId, @DefectCauseDesc, @RepairCauseId, @RepairCauseDesc
                                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        AqBarcodeId,
                                                        QcItemId = Convert.ToInt32(item4["QcItemId"]),
                                                        DefectCauseId = Convert.ToInt32(item4["CauseId"]),
                                                        DefectCauseDesc = item4["CauseDesc"].ToString(),
                                                        RepairCauseId = nullData,
                                                        RepairCauseDesc = nullData,
                                                        CreateDate,
                                                        LastModifiedDate,
                                                        CreateBy = ResponsibleUserId,
                                                        LastModifiedBy = ResponsibleUserId
                                                    });
                                                var insertAqQcItemResult = sqlConnection.Query(sql, dynamicParameters);
                                                rowsAffected += insertAqQcItemResult.Count();
                                            }
                                        }

                                    }
                                    #endregion
                                    #endregion

                                    if (BarcodeId > 0)
                                    {
                                        #region //更改MES.Barode狀態
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Barcode SET
                                                CurrentProdStatus = @CurrentProdStatus,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BarcodeNo = @BarcodeNo";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              CurrentProdStatus = "F",
                                              LastModifiedDate,
                                              LastModifiedBy,
                                              BarcodeNo
                                          });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                                else if (item2["BarcodeNo"].ToString() == BarcodeNo || item2["BarcodeNo"].ToString() == "null" && item2["QcStatus"].ToString() == "P") //良品
                                {
                                    //出貨檢若OK，後續流程待確認
                                }
                                else if (item2["BarcodeNo"].ToString() == BarcodeNo || item2["BarcodeNo"].ToString() == "null" && item2["QcStatus"].ToString() == "M")
                                {
                                    //重新量測不重工
                                }
                                //待確認: 出貨檢是否有SR(當站返修)
                            }
                        }
                        #endregion

                        #endregion

                        #region //將量測暫存資料狀態改為S
                        if (BarcodeId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE QMS.TempQcMeasureData SET
                                    Status = @Status,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @BarcodeId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  Status = "S",
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  BarcodeId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE a SET
                                    a.[Status] = @Status,
                                    a.LastModifiedDate = @LastModifiedDate,
                                    a.LastModifiedBy = @LastModifiedBy
                                    FROM QMS.TempQcMeasureData a
                                    INNER JOIN QMS.QcNoticeItemSpec b ON a.QcNoticeItemSpecId = b.QcNoticeItemSpecId
                                    INNER JOIN QMS.QcNotice c ON b.QcNoticeId = c.QcNoticeId
                                    WHERE a.MoId = @MoId
                                    AND a.BarcodeId IS NULL";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  Status = "S",
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  MoId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion
                    }
                    transactionScope.Complete();
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //全吋檢
        #region //AddBarcodeTQcRecord-- 新增全吋檢紀錄 + 上傳量測數據 -- Ann 2023-02-17
        public string AddBarcodeTQcRecord(string BarcodeQcRecordData, int MoId, string TempOQcItemData, string QcType)
        {
            try
            {
                if (BarcodeQcRecordData.Length <= 0) throw new SystemException("【出貨檢/試產檢數據】不能為空!");
                if (QcType != "TQC") throw new SystemException("【量測數據類型】資料錯誤!");
                int ProgrammerUserId = -1;
                var barcodeQcRecordJson = JObject.Parse(BarcodeQcRecordData);
                Dictionary<string, int> qcRecord = new Dictionary<string, int>();
                Dictionary<int, int> qcBarcodeList = new Dictionary<int, int>();
                List<int> barcodeIdList = new List<int>();
                int rowsAffected = 0;
                int BarcodeId = -1;
                int BarcodeQty = -1;
                int QcRecordId = -1;
                int qcRecordCount = 0;
                List<QcNgCode> qcNgCodes = new List<QcNgCode>();
                string qcCauseJsonString = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //建立BarcodeQcRecord
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        foreach (var item in barcodeQcRecordJson["barcodeQcRecordInfo"])
                        {
                            if (item["QcStatus"].ToString().Length <= 0) throw new SystemException("【人員判斷】不能為空!");

                            if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null")
                            {
                                #region //判斷條碼資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 BarcodeId, BarcodeQty
                                        FROM MES.Barcode
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item["BarcodeNo"].ToString());

                                var result7 = sqlConnection.Query(sql, dynamicParameters);
                                if (result7.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                                foreach (var item2 in result7)
                                {
                                    BarcodeId = item2.BarcodeId;
                                    BarcodeQty = item2.BarcodeQty;
                                    barcodeIdList.Add(BarcodeId);
                                }
                                #endregion
                            }

                            if (item["SubResponsibleDeptId"].ToString().Length > 0)
                            {
                                #region //判斷副責任單位資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM BAS.Department
                                        WHERE DepartmentId = @DepartmentId";
                                dynamicParameters.Add("DepartmentId", Convert.ToInt32(item["SubResponsibleDeptId"]));

                                var result9 = sqlConnection.Query(sql, dynamicParameters);
                                if (result9.Count() <= 0) throw new SystemException("副責任單位資料錯誤!");
                                #endregion
                            }

                            if (item["SubResponsibleUserId"].ToString().Length > 0)
                            {
                                #region //判斷副責任者資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM BAS.[User]
                                        WHERE UserId = @UserId";
                                dynamicParameters.Add("UserId", Convert.ToInt32(item["SubResponsibleUserId"]));

                                var result10 = sqlConnection.Query(sql, dynamicParameters);
                                if (result10.Count() <= 0) throw new SystemException("副責任者資料錯誤!");
                                #endregion
                            }

                            #region //判斷製令資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.ManufactureOrder
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var result11 = sqlConnection.Query(sql, dynamicParameters);
                            if (result11.Count() <= 0) throw new SystemException("製令資料錯誤!");
                            #endregion

                            #region //若迴圈第一次，建立QcRecord
                            if (qcRecordCount == 0)
                            {
                                Boolean barcodeFlag = false;
                                if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null") barcodeFlag = true;
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.QcRecord (QcNoticeId, QcType, MoId, MoProcessId
                                        , SystemStatus, QcStatus, QcUserId, Remark
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.QcRecordId
                                        VALUES (@QcNoticeId, @QcType, @MoId, @MoProcessId
                                        , @SystemStatus, @QcStatus, @QcUserId, @Remark
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        QcNoticeId = Convert.ToInt32(item["QcNoticeId"]),
                                        QcType,
                                        MoId,
                                        MoProcessId = (int?)null,
                                        SystemStatus = barcodeFlag == false ? "N" : "",
                                        QcStatus = barcodeFlag == false ? item["QcStatus"].ToString() : "",
                                        QcUserId = barcodeFlag == false ? CreateBy : (int?)null,
                                        Remark = barcodeFlag == false ? item["Remark"].ToString() : "",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();

                                foreach (var item2 in insertResult)
                                {
                                    QcRecordId = item2.QcRecordId;
                                    qcRecord.Add(item["BarcodeNo"].ToString(), item2.QcRecordId);
                                }
                            }
                            #endregion

                            #region //INSERT MES.QcBarcode
                            if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null")
                            {
                                int PassQty = -1;
                                int NgQty = -1;
                                if (item["QcStatus"].ToString() == "P")
                                {
                                    PassQty = BarcodeQty;
                                    NgQty = 0;
                                }
                                else
                                {
                                    PassQty = 0;
                                    NgQty = BarcodeQty;
                                }

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.QcBarcode (QcRecordId, BarcodeProcessId, BarcodeId, PassQty, NgQty, SystemStatus, QcStatus, QcUserId, Remark, Status
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.QcBarcodeId, INSERTED.BarcodeId
                                        VALUES (@QcRecordId, @BarcodeProcessId, @BarcodeId, @PassQty, @NgQty, @SystemStatus, @QcStatus, @QcUserId, @Remark, @Status
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcRecordId,
                                    BarcodeProcessId = (int?)null,
                                    BarcodeId,
                                    PassQty,
                                    NgQty,
                                    SystemStatus = "N",
                                    QcStatus = item["QcStatus"].ToString(),
                                    QcUserId = CreateBy,
                                    Remark = item["Remark"].ToString(),
                                    Status = "Y",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                                var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item2 in insertResult2)
                                {
                                    qcBarcodeList.Add(item2.QcBarcodeId, item2.BarcodeId);
                                }
                            }
                            else
                            {
                                qcBarcodeList.Add(-1, BarcodeId);
                            }
                            #endregion

                            qcRecordCount++;
                        }
                        #endregion

                        #region //上傳量測數據
                        var tempQcItemJson = JObject.Parse(TempOQcItemData);
                        foreach (var item in tempQcItemJson["tempQcItemInfo"])
                        {
                            if (item["MeasureValue"].ToString().Length <= 0) throw new SystemException("量測值不能為空!");
                            if (item["QcResult"].ToString() == "F" && (item["NgCode"] == null || item["NgCodeDesc"] == null)) throw new SystemException("條碼【" + item["BarcodeNo"].ToString() + "】之項目【" + item["QcItemName"].ToString() + "】尚未維護異常原因!");

                            #region //判斷量測設定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 CreateBy
                                    FROM QMS.QcNoticeItemSpec
                                    WHERE QcNoticeItemSpecId = @QcNoticeItemSpecId";
                            dynamicParameters.Add("QcNoticeItemSpecId", Convert.ToInt32(item["QcNoticeItemSpecId"]));

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("量測設定資料錯誤!");

                            foreach (var item2 in result)
                            {
                                ProgrammerUserId = item2.CreateBy;
                            }
                            #endregion

                            #region //判斷量測項目資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.QcItemId
                                    FROM QMS.QcItem a
                                    WHERE a.QcItemId = @QcItemId";
                            dynamicParameters.Add("QcItemId", Convert.ToInt32(item["QcItemId"]));

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() <= 0) throw new SystemException("量測項目資料錯誤!");

                            int QcItemId = -1;
                            foreach (var item2 in result2)
                            {
                                QcItemId = item2.QcItemId;
                            }
                            #endregion

                            #region //判斷量測機型資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QcMachineMode
                                    WHERE QcMachineModeId = @QcMachineModeId";
                            dynamicParameters.Add("QcMachineModeId", Convert.ToInt32(item["QcMachineModeId"]));

                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            if (result3.Count() <= 0) throw new SystemException("量測機型資料錯誤!");
                            #endregion

                            #region //判斷量測機台資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.QmmDetail
                                    WHERE QmmDetailId = @QmmDetailId";
                            dynamicParameters.Add("QmmDetailId", Convert.ToInt32(item["QmmDetailId"]));

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("量測機台資料錯誤!");
                            #endregion

                            #region //判斷條碼資料是否正確
                            if (item["BarcodeNo"].ToString().Count() > 0 && item["BarcodeNo"].ToString() != "null")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT BarcodeId
                                        FROM MES.Barcode
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item["BarcodeNo"].ToString());

                                var result5 = sqlConnection.Query(sql, dynamicParameters);
                                if (result5.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                                foreach (var item2 in result5)
                                {
                                    BarcodeId = item2.BarcodeId;
                                }
                            }
                            else
                            {
                                BarcodeId = -1;
                            }
                            #endregion

                            int CauseId = -1;
                            if (item["QcResult"].ToString() == "F")
                            {
                                #region //判斷異常原因資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.CauseId
                                        FROM QMS.DefectCause a
                                        WHERE a.CauseNo = @CauseNo";
                                dynamicParameters.Add("CauseNo", item["NgCode"].ToString());

                                var CauseResult = sqlConnection.Query(sql, dynamicParameters);
                                if (CauseResult.Count() <= 0) throw new SystemException("異常原因資料錯誤!");

                                foreach (var item2 in CauseResult)
                                {
                                    CauseId = item2.CauseId;
                                }
                                #endregion

                                #region //維護異常原因項目modal
                                QcNgCode qcNgCode = new QcNgCode
                                {
                                    BarcodeId = BarcodeId,
                                    QcItemId = QcItemId,
                                    CauseId = CauseId,
                                    CauseDesc = item["NgCodeDesc"].ToString()
                                };

                                qcNgCodes.Add(qcNgCode);
                                #endregion
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO QMS.QcMeasureData (QcRecordId, QcNoticeItemSpecId, BarcodeId, QmmDetailId, MeasureValue, QcResult, CauseId, CauseDesc, MakeCount, Remark
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@QcRecordId, @QcNoticeItemSpecId, @BarcodeId, @QmmDetailId, @MeasureValue, @QcResult, @CauseId, @CauseDesc, @MakeCount, @Remark
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    QcRecordId,
                                    QcNoticeItemSpecId = Convert.ToInt32(item["QcNoticeItemSpecId"]),
                                    BarcodeId = BarcodeId > 0 ? BarcodeId : (int?)null,
                                    QmmDetailId = Convert.ToInt32(item["QmmDetailId"]),
                                    MeasureValue = item["MeasureValue"].ToString(),
                                    QcResult = item["QcResult"].ToString(),
                                    CauseId = CauseId > 0 ? CauseId : (int?)null,
                                    CauseDesc = item["NgCodeDesc"] != null ? item["NgCodeDesc"].ToString() : "",
                                    MakeCount = Convert.ToDouble(item["MakeCount"]),
                                    Remark = item["Remark"].ToString(),
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = Convert.ToInt32(item["CreateUserId"]) == CreateBy ? CreateBy : Convert.ToInt32(item["CreateUserId"]),
                                    LastModifiedBy = Convert.ToInt32(item["CreateUserId"]) == CreateBy ? LastModifiedBy : Convert.ToInt32(item["CreateUserId"])
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }

                        if (qcNgCodes.Count() > 0)
                        {
                            qcCauseJsonString = JsonConvert.SerializeObject(qcNgCodes);
                            qcCauseJsonString = "{\"data\":" + qcCauseJsonString + "}";
                        }
                        #endregion
                    }
                    transactionScope.Complete();
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //品異
        #region //AddAbnormalqualityPadProject-- 新增品異單多項目 - 平板版本(只有回報) -- Shintokuro 2023-02-16
        public string AddAbnormalqualityPadProject(string AbnormalqualityData, string AbnormalProjectList)
        {
            try
            {
                if (AbnormalqualityData.Length <= 0) throw new SystemException("【品異單資料】不能為空!");
                if (AbnormalProjectList.Length <= 0) throw new SystemException("【量測異常資料】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int AbnormalqualityId = 0;
                        int rowsAffected = 0;
                        int MoId = 0;
                        int? MoProcessId = 0;
                        int? BarcodeId = 0;
                        int? QcBarcodeId = 0;
                        int? nullData = null;
                        string QcType = "";
                        var ConformUserId = nullData;
                        var SubResponsibleDeptId = nullData;
                        var SubResponsibleUserId = nullData;
                        var ProgrammerUserId = nullData;
                        var ResponsibleSupervisorId = nullData;
                        string DocDate = DateTime.Now.ToString("yyyyMM");


                        var AbnormalqualityJson = JObject.Parse(AbnormalqualityData);
                        var AbnormalProjectListJson = JObject.Parse(AbnormalProjectList);

                        int ResponsibleUserId = -1;
                        #region //品異單單頭建立
                        foreach (var item in AbnormalqualityJson["data"])
                        {
                            if (Convert.ToInt32(item["MoId"]) <= 0) throw new SystemException("【製令】不能為空!");
                            if (Convert.ToInt32(item["ResponsibleDeptId"]) <= 0) throw new SystemException("【責任單位】不能為空!");
                            if (Convert.ToInt32(item["ResponsibleUserId"]) <= 0) throw new SystemException("【責任者】不能為空!");
                            if (Convert.ToString(item["QcType"]) != "PVTQC")
                            {
                                //if (Convert.ToInt32(item["BarcodeId"]) <= 0) throw new SystemException("【條碼】不能為空!");

                                if (Convert.ToString(item["QcType"]) != "NON")
                                {
                                    if (Convert.ToInt32(item["QcBarcodeId"]) <= 0) throw new SystemException("【檢驗紀錄編號】不能為空!");
                                }


                                #region //判斷條碼是否有進品異
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.AqBarcodeId,a.ProcessStatus,a.JudgeStatus
                                        FROM QMS.AqBarcode a
								        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                var resultJudgeStatus = sqlConnection.Query(sql, dynamicParameters);
                                if (resultJudgeStatus.Count() > 0)
                                {
                                    string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                    string ProcessStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessStatus;
                                    int AqBarcodeId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).AqBarcodeId;
                                    if (JudgeStatus == "RW")
                                    {
                                        if (ProcessStatus == "I")
                                        {
                                            #region //資料更新
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE QMS.AqBarcode SET
                                                    ProcessStatus = @ProcessStatus,
                                                    LastModifiedBy = @LastModifiedBy,
                                                    LastModifiedDate = @LastModifiedDate
                                                    WHERE AqBarcodeId = @AqBarcodeId";
                                            dynamicParameters.AddDynamicParams(
                                              new
                                              {
                                                  ProcessStatus = "V",
                                                  ConformUserId,
                                                  LastModifiedBy,
                                                  LastModifiedDate,
                                                  AqBarcodeId
                                              });
                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                    }
                                }
                                #endregion
                            }


                            MoId = Convert.ToInt32(item["MoId"]);
                            QcType = Convert.ToString(item["QcType"]);
                            if (QcType == "IPQC" || QcType == "NON")
                            {
                                MoProcessId = Convert.ToInt32(item["MoProcessId"]);
                            }
                            else
                            {
                                MoProcessId = null;
                            }
                            //DocDate = item["Docate"].ToString();
                            ResponsibleUserId = Convert.ToInt32(item["ResponsibleUserId"]);
                        }


                        #region //單號自動取號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(AbnormalqualityNo))), '000'), 3)) + 1 CurrentNum
                                FROM QMS.Abnormalquality
								WHERE AbnormalqualityNo NOT LIKE '%[A-Za-z]%'
                                AND AbnormalqualityNo LIKE '202311%'";
                        int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                        string AbnormalqualityNo = DocDate + string.Format("{0:000}", currentNum);
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO QMS.Abnormalquality (CompanyId, MoId, MoProcessId, AbnormalqualityNo, AbnormalqualityStatus, DocDate, QcType
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.AbnormalqualityId
                                VALUES (@CompanyId, @MoId, @MoProcessId, @AbnormalqualityNo, @AbnormalqualityStatus, @DocDate, @QcType
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                MoId,
                                MoProcessId,
                                AbnormalqualityNo,
                                AbnormalqualityStatus = "F",
                                DocDate = DateTime.Now.ToString("yyyyMMdd"),
                                QcType,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = ResponsibleUserId,
                                LastModifiedBy = ResponsibleUserId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected += insertResult.Count();

                        //取出單頭Id
                        foreach (var item in insertResult)
                        {
                            AbnormalqualityId = item.AbnormalqualityId;
                        }
                        #endregion

                        #region //品異單單身 - 異常條碼建立
                        foreach (var item in AbnormalqualityJson["data"])
                        {

                            if (QcType != "PVTQC")
                            {

                                if (QcType == "IPQC")
                                {
                                    #region //判斷條碼是否存在
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                            FROM MES.Barcode a
                                            INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                    INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                            WHERE a.BarcodeId = @BarcodeId
                                            --AND a.BarcodeStatus = '1' 
                                            AND　c.FinishDate is not null";
                                    dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                    var result1 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】不存在，請重新輸入!");
                                    #endregion
                                }
                                else if (QcType == "OQC")
                                {
                                    #region //判斷條碼是否存在
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                            FROM MES.Barcode a
                                            INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                    INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                            WHERE a.BarcodeId = @BarcodeId
                                            AND　c.FinishDate is not null";
                                    dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                    var result1 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】不存在，請重新輸入!");
                                    #endregion
                                }


                                #region //判斷條碼目前是否在品異單
                                sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                        FROM QMS.AqBarcode a
                                        WHERE a.BarcodeId =@BarcodeId
                                        Order By a.LastModifiedDate DESC
                                        ";
                                dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                var result2 = sqlConnection.Query(sql, dynamicParameters);
                                if (result2.Count() > 0)
                                {
                                    //判斷品異單判斷結果,如果有值且不是S代表已經判定完成,如果條碼有異常可以開立新的品異單
                                    string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                    if (JudgeStatus == null)
                                    {
                                        throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】目前在品異單判定中，不可以開立品異單");
                                    }
                                    else if (JudgeStatus == "S")
                                    {
                                        throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】目前判定不良品，不可以開立品異單");
                                    }
                                }
                                #endregion
                            }

                            #region //判斷資料是否存在
                            #region //資料 - NOT NULL

                            #region //判斷檢驗紀錄編號是否存在
                            if (QcType != "PVTQC")
                            {
                                if (QcType != "NON")
                                {
                                    sql = @"SELECT TOP 1 1
                                        FROM MES.QcBarcode a
                                        WHERE a.QcBarcodeId = @QcBarcodeId";
                                    dynamicParameters.Add("QcBarcodeId", Convert.ToInt32(item["QcBarcodeId"]));
                                    var resultQcBarcodeId = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultQcBarcodeId.Count() <= 0) throw new SystemException("【檢驗紀錄編號:" + item["QcRecordId"].ToString() + "】不存在，請重新輸入!");
                                }
                            }
                            #endregion

                            #region //判斷責任單位是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                FROM BAS.[User] a
                                INNER JOIN BAS.Department b on a.DepartmentId = b.DepartmentId
                                WHERE b.DepartmentId = @ResponsibleDeptId";
                            dynamicParameters.Add("ResponsibleDeptId", Convert.ToInt32(item["ResponsibleDeptId"]));

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【責任單位】不存在，請重新輸入!");
                            #endregion

                            #region //判斷責任者是否存在
                            dynamicParameters = new DynamicParameters();

                            sql = @"SELECT TOP 1 1
                                FROM BAS.[User] a
                                WHERE a.UserId = @ResponsibleUserId
                                AND a.Status = 'A'";
                            dynamicParameters.Add("ResponsibleUserId", Convert.ToInt32(item["ResponsibleUserId"]));

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【責任者】不存在，請重新輸入!");
                            #endregion
                            #endregion

                            #region //資料 - NULL
                            #region //判斷合致對象是否存在
                            if (item["ConformUserId"].ToString() != "")
                            {
                                dynamicParameters = new DynamicParameters();

                                sql = @"SELECT TOP 1 1
                                FROM BAS.[User] a
                                WHERE a.UserId = @ConformUserId
                                AND a.Status = 'A'";
                                dynamicParameters.Add("ConformUserId", Convert.ToInt32(item["ConformUserId"]));

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【合致對象】不存在，請重新輸入!");
                                ConformUserId = Convert.ToInt32(item["ConformUserId"]);
                            }
                            #endregion

                            #region //判斷副責任單位是否存在
                            if (item["SubResponsibleDeptId"].ToString() != "")
                            {
                                dynamicParameters = new DynamicParameters();

                                sql = @"SELECT TOP 1 1
                                FROM BAS.Department a
                                WHERE a.DepartmentId = @SubResponsibleDeptId";
                                dynamicParameters.Add("SubResponsibleDeptId", Convert.ToInt32(item["SubResponsibleDeptId"]));

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【副責任單位】不存在，請重新輸入!");
                                SubResponsibleDeptId = Convert.ToInt32(item["SubResponsibleDeptId"]);
                            }
                            #endregion

                            #region //判斷副責任者是否存在
                            if (item["SubResponsibleUserId"].ToString() != "")
                            {
                                dynamicParameters = new DynamicParameters();

                                sql = @"SELECT TOP 1 1
                                FROM BAS.[User] a
                                WHERE a.UserId = @SubResponsibleUserId
                                AND a.Status = 'A'";
                                dynamicParameters.Add("SubResponsibleUserId", Convert.ToInt32(item["SubResponsibleUserId"]));

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【副責任者】不存在，請重新輸入!");

                                SubResponsibleUserId = Convert.ToInt32(item["SubResponsibleUserId"]);

                            }
                            #endregion

                            #region //判斷編程者是否存在
                            if (item["ProgrammerUserId"].ToString() != "")
                            {
                                dynamicParameters = new DynamicParameters();

                                sql = @"SELECT TOP 1 1
                                FROM BAS.[User] a
                                WHERE a.UserId = @ProgrammerUserId
                                AND a.Status = 'A'";
                                dynamicParameters.Add("ProgrammerUserId", Convert.ToInt32(item["ProgrammerUserId"]));

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【編程者】不存在，請重新輸入!");

                                ProgrammerUserId = Convert.ToInt32(item["ProgrammerUserId"]);

                            }
                            #endregion
                            #endregion
                            #endregion



                            if (QcType != "PVTQC")
                            {
                                #region //更新異常條碼目前狀態
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        CurrentProdStatus = 'F',
                                        LastModifiedBy = @LastModifiedBy,
                                        LastModifiedDate = @LastModifiedDate
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      LastModifiedBy,
                                      LastModifiedDate,
                                      BarcodeId = Convert.ToInt32(item["BarcodeId"])
                                  });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                BarcodeId = Convert.ToInt32(item["BarcodeId"]);
                                if (QcType == "NON")
                                {
                                    if (item["QcBarcodeId"].Count() == 0)
                                    {
                                        QcBarcodeId = nullData;
                                    }
                                }
                                else
                                {
                                    QcBarcodeId = Convert.ToInt32(item["QcBarcodeId"]);
                                }

                            }
                            else
                            {
                                BarcodeId = nullData;
                                QcBarcodeId = nullData;
                            }


                            #region //新增 - 品異單單身
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO QMS.AqBarcode (AbnormalqualityId, BarcodeId, QcBarcodeId, DefectCauseId, DefectCauseDesc, ConformUserId, 
                                    ResponsibleDeptId, ResponsibleUserId, SubResponsibleDeptId, SubResponsibleUserId, ProgrammerUserId, 
                                    RepairCauseId, RepairCauseDesc, RepairCauseUserId,AqBarcodeStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.AqBarcodeId
                                    VALUES (@AbnormalqualityId, @BarcodeId, @QcBarcodeId, @DefectCauseId, @DefectCauseDesc, @ConformUserId, 
                                    @ResponsibleDeptId, @ResponsibleUserId, @SubResponsibleDeptId, @SubResponsibleUserId, @ProgrammerUserId, 
                                    @RepairCauseId, @RepairCauseDesc, @RepairCauseUserId, @AqBarcodeStatus, 
                                    @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    AbnormalqualityId,
                                    BarcodeId,
                                    QcBarcodeId,
                                    DefectCauseId = nullData,
                                    DefectCauseDesc = nullData,
                                    ConformUserId,
                                    ResponsibleDeptId = Convert.ToInt32(item["ResponsibleDeptId"]),
                                    ResponsibleUserId = Convert.ToInt32(item["ResponsibleUserId"]),
                                    SubResponsibleDeptId,
                                    SubResponsibleUserId,
                                    ProgrammerUserId,
                                    RepairCauseId = nullData,
                                    RepairCauseDesc = nullData,
                                    RepairCauseUserId = nullData,
                                    AqBarcodeStatus = 1,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });
                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult2.Count();

                            int AqBarcodeId = 0;
                            foreach (var item2 in insertResult2)
                            {
                                AqBarcodeId = item2.AqBarcodeId;
                            }
                            #endregion


                            foreach (var item2 in AbnormalProjectListJson["data"])
                            {
                                if (BarcodeId == Convert.ToInt32(item2["BarcodeId"]))
                                {
                                    if (Convert.ToInt32(item2["CauseId"]) <= 0) throw new SystemException("【不良代碼】不能為空!");
                                    if (item2["CauseDesc"].ToString().Length > 100) throw new SystemException("【不良原因】長度錯誤!");

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO QMS.AqQcItem (AqBarcodeId, QcItemId, DefectCauseId, DefectCauseDesc, RepairCauseId, RepairCauseDesc
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.AqQcItemId
                                        VALUES (@AqBarcodeId, @QcItemId, @DefectCauseId, @DefectCauseDesc, @RepairCauseId, @RepairCauseDesc
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            AqBarcodeId,
                                            QcItemId = Convert.ToInt32(item2["QcItemId"]),
                                            DefectCauseId = Convert.ToInt32(item2["CauseId"]),
                                            DefectCauseDesc = item2["CauseDesc"].ToString(),
                                            RepairCauseId = nullData,
                                            RepairCauseDesc = nullData,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = ResponsibleUserId,
                                            LastModifiedBy = ResponsibleUserId
                                        });
                                    var insertAqQcItemResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected += insertAqQcItemResult.Count();
                                }
                            }

                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //高度計
        #region //AddAltimeterData --新增高度計數據 --GPai 20231113
        public string AddAltimeterData(int MoId, int MoProcessId, int QcNoticeId, int MachineId, int BarcodeId, int QcItemId, string QcStatus, float MeasureValue, float UpperValue, float LowerValue, float DesignValue, int ModeId)
        {
            try
            {
                if (MoId <= 0) throw new SystemException("【製令】不能為空!");
                if (MoProcessId <= 0) throw new SystemException("【製程】不能為空!");
                int rowsAffected = 0;
                int BarcodeProcessId = -1;
                int qcRecordCount = 0;
                int qcRecordId = -1;
                string ProcessCheckType = "";
                int qcTypeId = -1;
                int qcNoticeItemSpecId = -1;
                string qcResult = "";
                int qmmDetailId = -1;
                string qcItemDesc = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷量測通知單資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1
                                    FROM QMS.QcNotice
                                    WHERE QcNoticeId = @QcNoticeId";
                    dynamicParameters.Add("QcNoticeId", QcNoticeId);

                    var qcNoticeResult = sqlConnection.Query(sql, dynamicParameters);
                    #endregion

                    #region //最新IPQC量測單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.QcNoticeItemSpecId ,a.QcNoticeId,a.DesignValue,a.UpperTolerance,a.LowerTolerance,a.MakeCount,a.ProductQcCount,a.Depth,a.Remark,a.CreateDate
                            ,b.QcItemId,b.QcItemName,b.QcItemType
                            ,c.QcUomId,c.QcUomName
							FROM QMS.QcNoticeItemSpec a
                            LEFT JOIN QMS.QcItem b ON a.QcItemId=b.QcItemId
                            LEFT JOIN QMS.UnitOfQcMeasure c ON a.QcUomId=c.QcUomId
							WHERE a.QcNoticeId = @QcNoticeId AND a.QcItemId = @QcItemId ";

                    dynamicParameters.Add("QcNoticeId", QcNoticeId);
                    dynamicParameters.Add("QcItemId", QcItemId);

                    var result1 = sqlConnection.Query(sql, dynamicParameters);
                    if (result1.Count() <= 0) throw new SystemException("量測單身錯誤!");
                    foreach (var item in result1)
                    {
                        qcNoticeItemSpecId = item.QcNoticeItemSpecId;
                        //barcodeIdList.Add(BarcodeId);
                    }
                    #endregion

                    #region //判斷條碼資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 BarcodeId, BarcodeQty
                                    FROM MES.Barcode
                                    WHERE BarcodeId = @BarcodeId";
                    dynamicParameters.Add("BarcodeId", BarcodeId);

                    var result2 = sqlConnection.Query(sql, dynamicParameters);
                    if (result2.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                    int BarcodeQty = -1;
                    foreach (var item2 in result2)
                    {
                        BarcodeQty = item2.BarcodeQty;
                        //barcodeIdList.Add(BarcodeId);
                    }
                    #endregion

                    #region //判斷量測機台資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 *
                                    FROM QMS.QmmDetail
                                    WHERE MachineId = @MachineId ";
                    dynamicParameters.Add("MachineId", MachineId);

                    var result3 = sqlConnection.Query(sql, dynamicParameters);
                    if (result3.Count() <= 0) throw new SystemException("量測機台資料錯誤!");
                    foreach (var item in result3) {
                        qmmDetailId = item.QmmDetailId;
                    }

                    #endregion

                    #region //判斷量測類別資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 *
                                    FROM QMS.QcType
                                    WHERE QcTypeNo = 'IPQC' AND ModeId = @ModeId";
                    dynamicParameters.Add("ModeId", ModeId);// ModeId

                    var result4 = sqlConnection.Query(sql, dynamicParameters);
                    if (result4.Count() <= 0) throw new SystemException("量測類別資料錯誤!");
                    foreach (var item in result4) {
                        qcTypeId = item.QcTypeId;
                    }
                    #endregion

                    #region //判斷量測項目資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT *
                                    FROM QMS.QcItem a
                                    WHERE a.QcItemId = @QcItemId";
                    dynamicParameters.Add("QcItemId", QcItemId);

                    var result5 = sqlConnection.Query(sql, dynamicParameters);
                    if (result5.Count() <= 0) throw new SystemException("量測項目資料錯誤!");
                    foreach (var item in result5) {
                        qcItemDesc = item.QcItemDesc;
                    }

                    #endregion

                    #region //判斷製令資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1
                                    FROM MES.ManufactureOrder
                                    WHERE MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    var result6 = sqlConnection.Query(sql, dynamicParameters);
                    if (result6.Count() <= 0) throw new SystemException("製令資料錯誤!");
                    #endregion

                    #region //判斷製令製程資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ProcessCheckType
                                    FROM MES.MoProcess
                                    WHERE MoProcessId = @MoProcessId";
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var result7 = sqlConnection.Query(sql, dynamicParameters);
                    if (result7.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                    foreach (var item2 in result7)
                    {
                        ProcessCheckType = item2.ProcessCheckType;
                    }
                    #endregion

                    #region //取得BarcodeProcess資訊
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.BarcodeProcessId, a.PassQty, a.NgQty
                                    , b.QcBarcodeId, b.QcStatus
                                    FROM MES.BarcodeProcess a
                                    LEFT JOIN MES.QcBarcode b ON b.BarcodeProcessId = a.BarcodeProcessId
                                    AND b.QcBarcodeId = (
                                      SELECT TOP 1 ba.QcBarcodeId
                                      FROM MES.QcBarcode ba
                                      WHERE ba.BarcodeProcessId = a.BarcodeProcessId
                                      ORDER BY ba.CreateDate DESC
                                    )
                                    INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                    WHERE a.MoId = @MoId
                                    AND a.MoProcessId = @MoProcessId
                                    AND a.BarcodeId = @BarcodeId
                                    AND a.FinishDate IS NOT NULL
                                    AND c.CurrentProdStatus = 'P'
                                    ORDER BY a.FinishDate DESC";
                    dynamicParameters.Add("MoId", MoId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    dynamicParameters.Add("BarcodeId", BarcodeId);

                    var result8 = sqlConnection.Query(sql, dynamicParameters);
                    if (result8.Count() <= 0) throw new SystemException("製令歷程資料錯誤!");

                    int barcodeProcessPassQty = -1;
                    int barcodeProcessNgQty = -1;
                    foreach (var item2 in result8)
                    {
                        if (item2.QcStatus != null && item2.QcStatus != "M")
                        {
                            throw new SystemException("此條碼無法重複上傳量測數據!");
                        }
                        else
                        {
                            BarcodeProcessId = item2.BarcodeProcessId;
                            barcodeProcessPassQty = item2.PassQty;
                            barcodeProcessNgQty = item2.NgQty;
                        }
                    }
                    #endregion


                    #region //ADD MES.QcRecord
                    dynamicParameters = new DynamicParameters();
                    sql = @"INSERT INTO MES.QcRecord (QcNoticeId, QcTypeId, MoId, MoProcessId, PassQty, NgQty
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.QcRecordId
                                        VALUES (@QcNoticeId, @QcTypeId, @MoId, @MoProcessId, @PassQty, @NgQty
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                    dynamicParameters.AddDynamicParams(
                        new
                        {
                            QcNoticeId = QcNoticeId,
                            QcTypeId = qcTypeId,
                            MoId,
                            MoProcessId,
                            PassQty = barcodeProcessPassQty,
                            NgQty = barcodeProcessNgQty,
                            CreateDate,
                            LastModifiedDate,
                            CreateBy,
                            LastModifiedBy
                        });

                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                    if (insertResult.Count() <= 0) throw new SystemException("建立QcRecord資料失敗!");

                    rowsAffected += insertResult.Count();

                    foreach (var item2 in insertResult)
                    {
                        qcRecordId = item2.QcRecordId;
                    }
                    #endregion

                    if (MeasureValue > UpperValue || MeasureValue < LowerValue)
                    {
                        qcResult = "F";
                    }
                    else
                    {
                        qcResult = "P";
                    }

                    #region //ADD MES.QcBarcode
                    int PassQty = -1;
                    int NgQty = -1;
                    if (qcResult == "P")
                    {
                        PassQty = BarcodeQty;
                        NgQty = 0;
                    }
                    else
                    {
                        PassQty = 0;
                        NgQty = BarcodeQty;
                    }

                    dynamicParameters = new DynamicParameters();
                    sql = @"INSERT INTO MES.QcBarcode (QcRecordId, BarcodeProcessId, BarcodeId, PassQty, NgQty, SystemStatus, QcStatus, QcUserId, Status
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.QcBarcodeId, INSERTED.BarcodeId
                                    VALUES (@QcRecordId, @BarcodeProcessId, @BarcodeId, @PassQty, @NgQty, @SystemStatus, @QcStatus, @QcUserId, @Status
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                    dynamicParameters.AddDynamicParams(
                        new
                        {
                            QcRecordId = qcRecordId,
                            BarcodeProcessId,
                            BarcodeId,
                            PassQty,
                            NgQty,
                            SystemStatus = qcResult,
                            QcStatus = qcResult,
                            QcUserId = CreateBy,
                            Status = "Y",
                            //Remark = item["Remark"].ToString(),
                            CreateDate,
                            LastModifiedDate,
                            CreateBy,
                            LastModifiedBy
                        });

                    var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                    rowsAffected += insertResult2.Count();
                    #endregion

                    #region //ADD QMS.QcMeasureData
                    


                    dynamicParameters = new DynamicParameters();//QcNoticeItemSpecId qcNoticeItemSpecId
                    sql = @"INSERT INTO QMS.QcMeasureData (QcRecordId, BarcodeId, QcNoticeItemSpecId, QmmDetailId, MeasureValue, UpperTolerance, LowerTolerance, DesignValue, QcResult, QcItemId, QcItemDesc
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@QcRecordId, @BarcodeId, @QcNoticeItemSpecId, @QmmDetailId, @MeasureValue, @UpperTolerance, @LowerTolerance, @DesignValue, @QcResult, @QcItemId, @QcItemDesc
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                    dynamicParameters.AddDynamicParams(
                        new
                        {
                            QcRecordId = qcRecordId,
                            BarcodeId,
                            QcNoticeItemSpecId = qcNoticeItemSpecId,
                            QmmDetailId = qmmDetailId,
                            MeasureValue,
                            UpperTolerance = UpperValue,
                            LowerTolerance = LowerValue,
                            DesignValue,
                            QcResult = qcResult,
                            QcItemId,
                            QcItemDesc = qcItemDesc,
                            CreateDate,
                            LastModifiedDate,
                            CreateBy ,
                            LastModifiedBy
                        });

                    var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                    rowsAffected += insertResult3.Count();
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = rowsAffected
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion
        #endregion

        #region //Update
        #region //UpdateJigBarcodeWorkingFlag -- 更新治具條碼完工狀態 -- Ann 2022-11-02
        public string UpdateJigBarcodeWorkingFlag(string JigBarcodeIdData)
        {
            try
            {
                if (JigBarcodeIdData.Length < 0) throw new SystemException("【治具條碼資料】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string[] JigBarcodeList = JigBarcodeIdData.Split(',');

                        int UserId = CreateBy;
                        int rowsAffected = 0;
                        int rowCnt = 0;
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        foreach (var jigBarcodeId in JigBarcodeList)
                        {
                            rowCnt++;
                            #region //判斷治具條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT JigId
                                    FROM MES.JigBarcode
                                    WHERE JigBarcodeId = @JigBarcodeId";
                            dynamicParameters.Add("JigBarcodeId", jigBarcodeId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("治具條碼資料錯誤!");
                            int JigId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JigId);
                            #endregion

                            #region //先更新此治具下所有條碼狀態都為N
                            if (rowCnt.Equals(1))
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.JigBarcode SET
                                        WorkingFlag = 'N'
                                        WHERE JigId = @JigId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        JigId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            }

                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.JigBarcode SET
                                    WorkingFlag = @WorkingFlag,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE JigBarcodeId = @JigBarcodeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    WorkingFlag = "Y",
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    jigBarcodeId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateLotNgBarcodeProcessToPass-- 更新批量條碼數量為Pass -- Ann 2022-12-29
        public string UpdateLotNgBarcodeProcessToPass(int BarcodeProcessId, int ChangeBarcodeQty, string PreBarcodeNo, string MinBarcodes)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        #region //判斷【被改判】條碼歷程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoProcessId, a.BarcodeId, a.StationQty, a.ProdStatus, a.MoId
                                , b.NextMoProcessId OriNextMoProcessId, b.BarcodeStatus, b.BarcodeQty
                                , c.LotQty, c.TrayBarcode
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                INNER JOIN MES.MoSetting c ON a.MoId = c.MoId
                                WHERE a.BarcodeProcessId = @BarcodeProcessId";
                        dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);

                        var barcodeProcessIdResult = sqlConnection.Query(sql, dynamicParameters);
                        if (barcodeProcessIdResult.Count() <= 0) throw new SystemException("找不到製令用料設定!");

                        int MoProcessId = -1;
                        int BarcodeId = -1;
                        string ProdStatus = "";
                        int OriNextMoProcessId = -1;
                        int StationQty = -1;
                        int MoId = -1;
                        string TrayBarcode = "";
                        foreach (var item in barcodeProcessIdResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0")
                            {
                                switch (item.BarcodeStatus)
                                {
                                    case "3":
                                        throw new SystemException("條碼狀態為【可上料，但未綁定】不可更改");
                                    case "4":
                                        throw new SystemException("條碼狀態為【已綁定上料】不可更改");
                                    case "7":
                                        throw new SystemException("條碼狀態為【強制結束流程】不可更改");
                                    case "8":
                                        throw new SystemException("條碼狀態為【製令完工入庫】不可更改");
                                    case "10":
                                        throw new SystemException("條碼狀態為【已出貨】不可更改");
                                    default:
                                        throw new SystemException("條碼狀態不可更改");
                                }
                            }
                            if (ChangeBarcodeQty > item.BarcodeQty) throw new SystemException("改判數量超過原NG條碼數量(" + item.BarcodeQty + ")!");
                            if (ChangeBarcodeQty > item.LotQty) throw new SystemException("改判數量已超過此製令設定之最大滿盤數(" + item.LotQty + ")!");
                            MoProcessId = item.MoProcessId;
                            BarcodeId = item.BarcodeId;
                            ProdStatus = item.ProdStatus;
                            OriNextMoProcessId = item.OriNextMoProcessId;
                            StationQty = item.StationQty;
                            MoId = item.MoId;
                            TrayBarcode = item.TrayBarcode;
                        }
                        #endregion

                        #region //確認【原PASS】條碼是否為TrayBarcode
                        if (TrayBarcode == "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo
                                    FROM MES.Tray a 
                                    WHERE a.TrayNo = @PreBarcodeNo";
                            dynamicParameters.Add("PreBarcodeNo", PreBarcodeNo);

                            var TrayBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TrayBarcodeResult.Count() <= 0) throw new SystemException("Tray資料錯誤!!");

                            foreach (var item in TrayBarcodeResult)
                            {
                                if (item.BarcodeNo != null) PreBarcodeNo = item.BarcodeNo;
                            }
                        }
                        #endregion

                        #region //確認【原PASS】條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT BarcodeId PreBarcodeId, NextMoProcessId OrigNextMoProcessId
                                FROM MES.Barcode
                                WHERE BarcodeNo = @PreBarcodeNo";
                        dynamicParameters.Add("PreBarcodeNo", PreBarcodeNo);

                        var PreBarcodeNoResult = sqlConnection.Query(sql, dynamicParameters);

                        if (PreBarcodeNoResult.Count() <= 0)
                        {
                            throw new SystemException("原PASS條碼資料錯誤!!");
                        }

                        int PreBarcodeId = -1;
                        int OrigNextMoProcessId = -1;
                        foreach (var item in PreBarcodeNoResult)
                        {
                            PreBarcodeId = item.PreBarcodeId;
                            OrigNextMoProcessId = item.OrigNextMoProcessId;
                        }
                        #endregion

                        #region //取得BarcodeTransfer資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.TransactionId, a.TransactionDate, a.FromBarcodeId, a.ToBarcodeId, a.TransactionQty
                                FROM MES.BarcodeTransfer a
                                WHERE a.ToBarcodeId = @ToBarcodeId
                                AND EXISTS(
                                    SELECT 1
                                    FROM MES.BarcodeProcess b
                                    WHERE a.ToBarcodeId = b.BarcodeId
                                    AND b.MoProcessId = @MoProcessId
                                )
                                ORDER BY a.TransactionDate DESC";
                        dynamicParameters.Add("ToBarcodeId", BarcodeId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var barcodeTransferResult = sqlConnection.Query(sql, dynamicParameters);

                        if (barcodeTransferResult.Count() <= 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.TransactionId, a.TransactionDate, a.FromBarcodeId, a.ToBarcodeId, a.TransactionQty
                                    FROM MES.BarcodeTransfer a
                                    WHERE a.ToBarcodeId = @PreBarcodeId
                                    AND EXISTS(
                                        SELECT 1
                                        FROM MES.BarcodeProcess b
                                        WHERE a.ToBarcodeId = b.BarcodeId
                                        AND b.MoProcessId = @MoProcessId
                                    )
                                    ORDER BY a.TransactionDate DESC";
                            dynamicParameters.Add("PreBarcodeId", PreBarcodeId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            barcodeTransferResult = sqlConnection.Query(sql, dynamicParameters);

                            if (barcodeTransferResult.Count() <= 0) throw new SystemException("條碼數量轉移資料錯誤!");
                        }

                        int TransactionId = -1;
                        int FromBarcodeId = -1;
                        int ToBarcodeId = -1;
                        int TransactionQty = -1;
                        foreach (var item in barcodeTransferResult)
                        {
                            //if (ChangeBarcodeQty > item.TransactionQty) throw new SystemException("修正數量超過數量(" + item.TransactionQty + ")!");
                            TransactionId = item.TransactionId;
                            FromBarcodeId = item.FromBarcodeId;
                            ToBarcodeId = item.ToBarcodeId;
                            TransactionQty = item.TransactionQty;
                        }
                        #endregion

                        #region //更新BarcodeTransfer資訊
                        if (ChangeBarcodeQty > TransactionQty)
                        {
                            #region //先找出此條碼全部BarcodeTransfer
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TransactionId, a.TransactionDate, a.FromBarcodeId, a.ToBarcodeId, a.TransactionQty
                                    , (
                                        SELECT SUM(x.TransactionQty)
                                        FROM MES.BarcodeTransfer x
                                        WHERE x.ToBarcodeId = @BarcodeId
                                            AND EXISTS(
                                                SELECT 1
                                                FROM MES.BarcodeProcess xa
                                                WHERE x.ToBarcodeId = xa.BarcodeId
                                                AND xa.MoProcessId = @MoProcessId
                                            )
                                    ) SumTransactionQty
                                    FROM MES.BarcodeTransfer a
                                    WHERE a.ToBarcodeId = @BarcodeId
                                    AND EXISTS(
                                        SELECT 1
                                        FROM MES.BarcodeProcess b
                                        WHERE a.ToBarcodeId = b.BarcodeId
                                        AND b.MoProcessId = @MoProcessId
                                    )
                                    ORDER BY a.TransactionDate DESC";
                            dynamicParameters.Add("BarcodeId", BarcodeId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var BarcodeTransferResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //重複刪除紀錄直到數量滿足
                            int CurrentChangeBarcodeQty = ChangeBarcodeQty;
                            foreach (var item in BarcodeTransferResult)
                            {
                                if (ChangeBarcodeQty > item.SumTransactionQty) throw new SystemException("修正數量超過總數量(" + item.SumTransactionQty + ")!");
                                if (CurrentChangeBarcodeQty - item.TransactionQty > 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE MES.BarcodeTransfer
                                            WHERE TransactionId = @TransactionId";
                                    dynamicParameters.Add("TransactionId", item.TransactionId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                    CurrentChangeBarcodeQty -= item.TransactionQty;
                                }
                                else if (CurrentChangeBarcodeQty - item.TransactionQty == 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE MES.BarcodeTransfer
                                            WHERE TransactionId = @TransactionId";
                                    dynamicParameters.Add("TransactionId", item.TransactionId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                    break;
                                }
                                else if (CurrentChangeBarcodeQty - item.TransactionQty < 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.BarcodeTransfer SET
                                            TransactionQty = TransactionQty - @ChangeBarcodeQty,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE TransactionId = @TransactionId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          ChangeBarcodeQty,
                                          LastModifiedDate,
                                          LastModifiedBy = UserId,
                                          item.TransactionId
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                    break;
                                }
                            }
                            #endregion
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.BarcodeTransfer SET
                                    TransactionQty = TransactionQty - @ChangeBarcodeQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TransactionId = @TransactionId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ChangeBarcodeQty,
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  TransactionId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion

                        #region //更新【被改判】Barcode
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty - @ChangeBarcodeQty,
                                NextMoProcessId = @OrigNextMoProcessId,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ChangeBarcodeQty,
                              OrigNextMoProcessId,
                              LastModifiedDate,
                              LastModifiedBy = UserId,
                              BarcodeId
                          });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新【被改判】條碼歷程資訊

                        #region //先確認【被改判】條碼歷程StationQty扣除後狀況
                        if (StationQty - ChangeBarcodeQty == 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.BarcodeTransfer
                                    WHERE ToBarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.BarcodeProcess
                                    WHERE BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        else if (StationQty - ChangeBarcodeQty < 0)
                        {
                            #region //先找出此條碼在目前製程過站紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeProcessId, a.StationQty
                                    FROM MES.BarcodeProcess a
                                    WHERE a.BarcodeId = @BarcodeId AND a.MoProcessId = @MoProcessId AND FinishDate IS NOT NULL
                                    ORDER BY a.CreateDate DESC";
                            dynamicParameters.Add("BarcodeId", BarcodeId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //重複刪除紀錄直到數量滿足
                            int CurrentChangeBarcodeQty = ChangeBarcodeQty;
                            foreach (var item in BarcodeProcessResult)
                            {
                                if (CurrentChangeBarcodeQty - item.StationQty > 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE MES.BarcodeProcess
                                            WHERE BarcodeProcessId = @BarcodeProcessId";
                                    dynamicParameters.Add("BarcodeProcessId", item.BarcodeProcessId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                    CurrentChangeBarcodeQty -= item.StationQty;
                                }
                                else if (CurrentChangeBarcodeQty - item.StationQty == 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE MES.BarcodeProcess
                                            WHERE BarcodeProcessId = @BarcodeProcessId";
                                    dynamicParameters.Add("BarcodeProcessId", item.BarcodeProcessId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                    break;
                                }
                                else if (CurrentChangeBarcodeQty - item.StationQty < 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.BarcodeProcess SET
                                            StationQty = StationQty - @CurrentChangeBarcodeQty,
                                            NgQty = NgQty - @CurrentChangeBarcodeQty,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                            WHERE BarcodeProcessId = @BarcodeProcessId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          CurrentChangeBarcodeQty,
                                          LastModifiedDate,
                                          LastModifiedBy = UserId,
                                          item.BarcodeProcessId
                                      });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                    break;
                                }
                            }
                            #endregion
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.BarcodeProcess SET
                                    StationQty = StationQty - @ChangeBarcodeQty,
                                    NgQty = NgQty - @ChangeBarcodeQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ChangeBarcodeQty,
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  BarcodeProcessId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }

                        #endregion

                        #endregion

                        #region //確認是否有鏡頭條碼註冊在此條碼上
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Barcode a 
                                INNER JOIN MES.Barcode b ON a.ParentBarcode = b.BarcodeId
                                WHERE b.BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);
                        var MinBarcodesResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MinBarcodesResult.Count() > 0)
                        {
                            if (MinBarcodes.Length <= 0) throw new SystemException("此條碼有被鏡頭條碼註冊，需輸入鏡頭條碼來進行NG拆盤");

                            #region //更新鏡頭條碼ParentBarcode、狀態
                            List<string> minBarcodeIds = MinBarcodes.Split(',').ToList<string>();
                            foreach (var item in minBarcodeIds)
                            {
                                #region //先確認鏡頭條碼資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.BarcodeStatus, a.CurrentProdStatus, a.CurrentMoProcessId, a.ParentBarcode
                                        FROM MES.Barcode a 
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", item);

                                var MinBarcodesResult2 = sqlConnection.Query(sql, dynamicParameters);

                                if (MinBarcodesResult2.Count() <= 0) throw new SystemException("鏡頭條碼【" + item + "】資料錯誤!!");

                                string minBarcodeNo = "";
                                foreach (var item2 in MinBarcodesResult2)
                                {
                                    if (item2.BarcodeStatus != "1" && item2.BarcodeStatus != "0") throw new SystemException("鏡頭條碼【" + item + "】狀態錯誤!!");
                                    if (item2.CurrentProdStatus != "F") throw new SystemException("鏡頭條碼【" + item + "】非良品!!");
                                    //if (item2.CurrentMoProcessId != MoProcessId) throw new SystemException("鏡頭條碼【" + item + "】製程錯誤!!");
                                    if (item2.ParentBarcode != BarcodeId) throw new SystemException("鏡頭條碼【" + item + "】與主條碼註冊資料錯誤!!");
                                    minBarcodeNo = item2.BarcodeNo;
                                }
                                #endregion

                                #region //Update MinBarcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        ParentBarcode = @PreBarcodeId,
                                        CurrentProdStatus = 'P',
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        PreBarcodeId,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeNo = minBarcodeNo
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion
                        }
                        #endregion

                        #region //更新【原PASS條碼】Barcode
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty + @ChangeBarcodeQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @PreBarcodeId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ChangeBarcodeQty,
                              LastModifiedDate,
                              LastModifiedBy = UserId,
                              PreBarcodeId
                          });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //取得【原PASS條碼】BarcodeProcessId
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.BarcodeProcessId PassBarcodeProcessId
                                FROM MES.BarcodeProcess a
                                WHERE a.BarcodeId = @PreBarcodeId
                                AND a.MoProcessId = @MoProcessId
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("PreBarcodeId", PreBarcodeId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var passBarcodeProcessIdResult = sqlConnection.Query(sql, dynamicParameters);

                        if (passBarcodeProcessIdResult.Count() <= 0) throw new SystemException("查無原先PASS條碼相關資訊!");

                        int PassBarcodeProcessId = -1;
                        foreach (var item in passBarcodeProcessIdResult)
                        {
                            PassBarcodeProcessId = item.PassBarcodeProcessId;
                        }
                        #endregion

                        #region //更新【原PASS條碼】BarcodeProcess
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeProcess SET
                                StationQty = StationQty + @ChangeBarcodeQty,
                                PassQty = PassQty + @ChangeBarcodeQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeProcessId = @PassBarcodeProcessId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ChangeBarcodeQty,
                              LastModifiedDate,
                              LastModifiedBy = UserId,
                              PassBarcodeProcessId
                          });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //重新計算條碼狀態報表資料
                        UpdateMoQtyInformation(MoId);
                        #endregion

                        #region //INSERT MES.AdvancedLog
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.AdvancedLog (BarcodeId, MoProcessId, OriNextMoProcessId, NextMoProcessId, OriQty, Qty, OriCurrentProdStatus, CurrentProdStatus
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@BarcodeId, @MoProcessId, @OriNextMoProcessId, @NextMoProcessId, @OriQty, @Qty, @OriCurrentProdStatus, @CurrentProdStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeId,
                                MoProcessId,
                                OriNextMoProcessId,
                                NextMoProcessId = OriNextMoProcessId,
                                OriQty = StationQty,
                                Qty = StationQty - ChangeBarcodeQty,
                                OriCurrentProdStatus = ProdStatus,
                                CurrentProdStatus = "P",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateQunatityJudge-- 更新數量過站資料 -- Ann 2022-12-30
        public string UpdateQunatityJudge(int TransactionId, string ToJudgeType, int ChangeQty, int NextMoProcessId, string CauseNo)
        {
            try
            {
                if (ToJudgeType.Length <= 0) throw new SystemException("更改後類型不能為空!");
                if (ChangeQty <= 0) throw new SystemException("改判數量不能為空!");
                if (ToJudgeType != "P" && CauseNo.Length <= 0) throw new SystemException("NG原因不能為空!");
                if (ToJudgeType == "F" && NextMoProcessId <= 0) throw new SystemException("下一站製程不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        #region //判斷數量過站歷程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId, a.Quantity, a.MoProcessId, a.MachineId, a.NextMoProcessId OriNextMoProcessId, a.ProdStatus
                                , b.OutputBarcodeFlag
                                , c.TotalNgQty
                                , c.TotalPassQty - ISNULL((
                                    SELECT SUM(x.MweBarcodeQty)
                                    FROM MES.MweBarcode x 
                                    INNER JOIN MES.MweDetail xa ON x.MweDetailId = xa.MweDetailId
                                    INNER JOIN MES.Barcode xb ON x.BarcodeId = xb.BarcodeId
                                    WHERE xa.MoId = a.MoId
                                    AND xb.CurrentProdStatus != 'S'
                                ), 0) TotalPassQty
                                , (
                                    SELECT SUM(x.TotalScrapQty) 
                                    FROM MES.MoProcess x
                                    WHERE x.MoId = a.MoId
                                ) - ISNULL((
                                    SELECT SUM(x.MweBarcodeQty)
                                    FROM MES.MweBarcode x 
                                    INNER JOIN MES.MweDetail xa ON x.MweDetailId = xa.MweDetailId
                                    INNER JOIN MES.Barcode xb ON x.BarcodeId = xb.BarcodeId
                                    WHERE xa.MoId = a.MoId
                                    AND xb.CurrentProdStatus = 'S'
                                ), 0) TotalScrapQty
                                FROM MES.MoProcessTransaction a
                                INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                INNER JOIN MES.MoProcess c ON a.MoProcessId = c.MoProcessId
                                WHERE TransactionId = @TransactionId";
                        dynamicParameters.Add("TransactionId", TransactionId);

                        var moProcessTransactionResult = sqlConnection.Query(sql, dynamicParameters);

                        if (moProcessTransactionResult.Count() <= 0) throw new SystemException("數量過站歷程資料有誤!");

                        int MoId = -1;
                        int MoProcessId = -1;
                        int MachineId = -1;
                        int OriNextMoProcessId = -1;
                        int Quantity = -1;
                        string ProdStatus = "";
                        string OutputBarcodeFlag = "";
                        int TotalPassQty = -1;
                        int TotalNgQty = -1;
                        int TotalScrapQty = -1;
                        foreach (var item in moProcessTransactionResult)
                        {
                            if (item.Quantity < ChangeQty) throw new SystemException("改判數量大於此次紀錄數量(" + item.Quantity + ")!");
                            MoId = item.MoId;
                            MoProcessId = item.MoProcessId;
                            MachineId = item.MachineId;
                            OriNextMoProcessId = item.OriNextMoProcessId;
                            Quantity = item.Quantity;
                            ProdStatus = item.ProdStatus;
                            OutputBarcodeFlag = item.OutputBarcodeFlag;
                            TotalPassQty = item.TotalPassQty;
                            TotalNgQty = item.TotalNgQty;
                            TotalScrapQty = item.TotalScrapQty;
                        }
                        #endregion

                        if (NextMoProcessId > 0)
                        {
                            #region //判斷下一站製程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcess a
                                    WHERE MoProcessId = @NextMoProcessId";
                            dynamicParameters.Add("NextMoProcessId", NextMoProcessId);

                            var nextMoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            if (nextMoProcessResult.Count() <= 0) throw new SystemException("下一站製令製程資料錯誤!");
                            #endregion
                        }

                        if (CauseNo.Length > 0 && CauseNo != "改判回良品")
                        {
                            #region //判斷NG原因資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.DefectCause a
                                    WHERE CauseNo = @CauseNo";
                            dynamicParameters.Add("CauseNo", CauseNo);

                            var causeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (causeResult.Count() <= 0) throw new SystemException("NG原因資料錯誤!");
                            #endregion
                        }

                        #region //取得此製令已入庫總數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(SUM(a.AcceptQty), 0) AcceptQty
                                , ISNULL(SUM(a.ScriptQty), 0) ScriptQty
                                FROM MES.MweDetail a 
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MweDetailResult = sqlConnection.Query(sql, dynamicParameters);

                        int AcceptQty = 0;
                        int ScriptQty = 0;
                        foreach (var item in MweDetailResult)
                        {
                            AcceptQty = item.AcceptQty;
                            ScriptQty = item.ScriptQty;
                        }
                        #endregion

                        #region //檢核數量卡控
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT SUM(a.Quantity) Quantity
                                FROM MES.MoProcessTransaction a 
                                WHERE a.MoId = @MoId
                                AND a.ProdStatus = @ProdStatus";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("ProdStatus", ProdStatus);

                        var MoProcessTransactionResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in MoProcessTransactionResult)
                        {
                            if (ProdStatus == "P")
                            {
                                if (item.Quantity - ChangeQty < AcceptQty) throw new SystemException("改判數量大於已入庫數量，無法修改!!");
                            }
                            else if (ProdStatus == "S")
                            {
                                if (item.Quantity - ChangeQty < ScriptQty) throw new SystemException("改判數量大於已入庫數量，無法修改!!");
                            }
                            else
                            {
                                throw new SystemException("尚未開發此狀態【" + ProdStatus + "】改判方式!!");
                            }
                        }
                        #endregion

                        #region //數量控管模式
                        int AllowQty = 0;
                        int ThisQty = 0;
                        int ReturnQty = 0;
                        int BarcodeQty = Convert.ToInt32(ChangeQty);

                        #region Get 當站過站數累計數量ThiSQty & MoProcess SortNumber
                        // 過站數量不可只計算良品數
                        sql = @"SELECT a.SortNumber,
                                   SUM(ISNULL(b.Quantity,0)) ThisQty
                              FROM MES.MoProcess a
                                   LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                             WHERE a.MoProcessId = @MoProcessId
                             GROUP BY a.SortNumber ";

                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var ThisQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (ThisQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料!");
                        ThisQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ThisQty);
                        int CurrentSortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);
                        #endregion

                        #region //取得是否有指回此站數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(SUM(Quantity),0) ReturnQty
                              FROM MES.MoProcessTransaction 
                             WHERE NextMoProcessId = @MoProcessId
                               AND ProdStatus = 'F'";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var ReturnQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (ReturnQtyResult.Count() > 0)
                        {
                            ReturnQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ReturnQty);
                        }
                        #endregion

                        if (CurrentSortNumber.Equals(1))
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemId, ISNULL(SUM(a.ActualQuantity), 0) AS Quantity
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    WHERE a.MoId = @MoId
                                      AND b.ConfirmStatus = 'Y'
                                      AND (
                                        SELECT COUNT(DISTINCT MtlItemId)
                                        FROM MES.MrDetail
                                        WHERE MrId = a.MrId
                                        AND MoId = a.MoId
                                        GROUP BY MtlItemId
                                      ) = 1
                                    GROUP BY a.MtlItemId";

                            dynamicParameters.Add("MoId", MoId);
                            var AllowQtyResult = sqlConnection.Query(sql, dynamicParameters);
                            if (AllowQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料");

                            foreach (var item in AllowQtyResult)
                            {
                                int MtlItemId = item.MtlItemId;
                                double currentAllowQty = 0;
                                currentAllowQty = item.Quantity;

                                #region //計算單位用量換算，固定用PCS計算
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.DemandRequisitionQty
                                        , b.PlanQty
                                        FROM MES.WoDetail a 
                                        INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                        INNER JOIN MES.ManufactureOrder c ON b.WoId = c.WoId
                                        WHERE a.MtlItemId = @MtlItemId
                                        AND c.MoId = @MoId";
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                dynamicParameters.Add("MoId", MoId);

                                var WoDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                double DemandRequisitionQty = -1;
                                double PlanQty = -1;
                                foreach (var item2 in WoDetailResult)
                                {
                                    DemandRequisitionQty = item2.DemandRequisitionQty;
                                    PlanQty = item2.PlanQty;
                                }

                                double UnitConsumption = DemandRequisitionQty / PlanQty;

                                AllowQty += (int)Math.Round(Convert.ToDouble(currentAllowQty) / UnitConsumption, MidpointRounding.AwayFromZero);
                                #endregion
                            }
                        }
                        else
                        {
                            //非首站, 抓取上一站Pass數量, 但如果上一站非必過站, 則再往前站抓
                            sql = @"SELECT SUM(ISNULL(b.Quantity,0)) Quantity, a.SortNumber
                                  FROM MES.MoProcess a
                                       LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                                 WHERE a.MoId = @MoId
                                   AND b.ProdStatus = 'P'
                                   AND a.SortNumber = (SELECT MAX(a1.SortNumber)
                                                         FROM MES.MoProcess a1
						                                WHERE a.MoId = a1.MoId
						                                  AND a1.SortNumber < @CurrentSortNumber
						                                  AND a1.NecessityStatus != 'N')
                                 GROUP BY a.SortNumber";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("CurrentSortNumber", CurrentSortNumber);
                            var AllowQtyResult = sqlConnection.Query(sql, dynamicParameters);
                            if (AllowQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料");
                            AllowQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Quantity);
                            int PreNecessitySort = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);

                            if (PreNecessitySort - CurrentSortNumber > 1)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT SUM(ISNULL(b.Quantity,0)) Quantity
                                      FROM MES.MoProcess a
                                           LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                                     WHERE a.MoId = @MoId
                                       AND b.ProdStatus = 'P'
                                       AND a.SortNumber > @CurrentSortNumber 
                                       AND a.SortNumber < @PreNecessitySort ";
                                dynamicParameters.Add("CurrentSortNumber", CurrentSortNumber);
                                dynamicParameters.Add("PreNecessitySort", PreNecessitySort);

                                var NonNecessityResult = sqlConnection.Query(sql, dynamicParameters);
                                if (NonNecessityResult.Count() >= 0)
                                {
                                    AllowQty = AllowQty - Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Quantity);
                                }
                            }

                        }

                        #region //Validation Input Quantity

                        #region //若為數量產條碼模式，確認沒有影響到原已綁定之未入庫條碼數量
                        if (OutputBarcodeFlag == "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(SUM(a.BarcodeQty), 0) BindQty
                                    FROM MES.Barcode a 
                                    WHERE a.MoId = @MoId
                                    AND a.CurrentProdStatus = @ProdStatus
                                    AND a.BarcodeStatus != '8'";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("ProdStatus", ProdStatus);

                            var BarcodeQtyResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in BarcodeQtyResult)
                            {
                                if (ProdStatus == "P") if (ChangeQty > (TotalPassQty - item.BindQty)) throw new SystemException("改判數量(" + ChangeQty + ")超過良品未綁定條碼數量(" + (TotalPassQty - item.BindQty) + ")");
                                if (ProdStatus == "F") if (ChangeQty > (TotalNgQty - item.BindQty)) throw new SystemException("改判數量(" + ChangeQty + ")超過不良品未綁定條碼數量(" + (TotalNgQty - item.BindQty) + ")");
                                if (ProdStatus == "S") if (ChangeQty > (TotalScrapQty - item.BindQty)) throw new SystemException("改判數量(" + ChangeQty + ")超過報廢品未綁定條碼數量(" + (TotalScrapQty - item.BindQty) + ")");
                            }
                        }
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT Quantity
                                  FROM MES.MoProcessTransaction
                                 WHERE TransactionId = @TransactionId";
                        dynamicParameters.Add("TransactionId", TransactionId);
                        var OldQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (OldQtyResult.Count() <= 0) throw new SystemException("找不到修改前記錄!");
                        int OldQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Quantity);

                        if (AllowQty + ReturnQty - ThisQty + OldQty - BarcodeQty < 0)
                        {
                            throw new SystemException("前製程完工數[" + (AllowQty + ReturnQty).ToString() + "】減當站完工數小於投入數量");
                        }
                        else
                        {
                            #region //更新原本MES.MoProcessTransaction 
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.MoProcessTransaction SET
                                    Quantity = Quantity - @ChangeQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TransactionId = @TransactionId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ChangeQty,
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  TransactionId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //新增MES.MoProcessTransaction
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.MoProcessTransaction (MoId, MachineId, MoProcessId, NextMoProcessId, ProdStatus, Quantity, CauseNo, InputDate
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.TransactionId
                                    VALUES (@MoId, @MachineId, @MoProcessId, @NextMoProcessId, @ProdStatus, @Quantity, @CauseNo, @InputDate
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MoId,
                                    MachineId,
                                    MoProcessId,
                                    NextMoProcessId,
                                    ProdStatus = ToJudgeType,
                                    Quantity = ChangeQty,
                                    CauseNo,
                                    InputDate = CreateDate,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion

                            #region //如果ToJudgeType = "S"(報廢), 更新ManufactoreOrder.ScrapQty
                            if (ToJudgeType.Equals("S"))
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.ManufactureOrder 
                                           SET ScrapQty = ScrapQty + @BarcodeQty
                                         WHERE MoId = @MoId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeQty,
                                        MoId
                                    });
                                int UpdateMoInputQty = sqlConnection.Execute(sql, dynamicParameters);
                            }
                            #endregion

                            #region 呼叫UpdateMoProcessTransaction 更新MoProcess數量資訊
                            UpdateMoProcessTransaction(MoId);
                            #endregion
                        }
                        #endregion
                        #endregion

                        #region //INSERT MES.AdvancedLog
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.AdvancedLog (BarcodeId, MoProcessId, OriNextMoProcessId, NextMoProcessId, OriQty, Qty, OriCurrentProdStatus, CurrentProdStatus, CauseNo
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@BarcodeId, @MoProcessId, @OriNextMoProcessId, @NextMoProcessId, @OriQty, @Qty, @OriCurrentProdStatus, @CurrentProdStatus, @CauseNo
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeId = (int?)null,
                                MoProcessId,
                                OriNextMoProcessId,
                                NextMoProcessId,
                                OriQty = Quantity,
                                Qty = Quantity - ChangeQty,
                                OriCurrentProdStatus = ProdStatus,
                                CurrentProdStatus = ToJudgeType,
                                CauseNo,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBarcodeQty-- 更新條碼數量(數量產條碼功能用) -- Ann 2023-08-21
        public string UpdateBarcodeQty(int BarcodeId, int BarcodeQty)
        {
            try
            {
                if (BarcodeQty <= 0) throw new SystemException("條碼不能為空或小於0!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        #region //判斷條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeNo, a.CurrentProdStatus, a.BarcodeStatus, a.BarcodeQty
                                , b.OutputBarcodeFlag
                                , c.TotalNgQty
                                , c.TotalPassQty - ISNULL((
                                    SELECT SUM(x.MweBarcodeQty)
                                    FROM MES.MweBarcode x 
                                    INNER JOIN MES.MweDetail xa ON x.MweDetailId = xa.MweDetailId
                                    INNER JOIN MES.Barcode xb ON x.BarcodeId = xb.BarcodeId
                                    WHERE xa.MoId = a.MoId
                                    AND xb.CurrentProdStatus != 'S'
                                ), 0) TotalPassQty
                                , (
                                    SELECT SUM(x.TotalScrapQty)
                                    FROM MES.MoProcess x
                                    WHERE x.MoId = a.MoId
                                ) TotalScrapQty
                                , (
                                    SELECT SUM(x.BarcodeQty) - a.BarcodeQty
                                    FROM MES.Barcode x 
                                    WHERE x.MoId = a.MoId
                                    AND x.CurrentProdStatus = 'P'
                                ) PassBindQty
                                , (
                                    SELECT SUM(x.BarcodeQty) - a.BarcodeQty
                                    FROM MES.Barcode x 
                                    WHERE x.MoId = a.MoId
                                    AND x.CurrentProdStatus = 'F'
                                ) NgBindQty
                                , (
                                    SELECT SUM(x.BarcodeQty) - a.BarcodeQty
                                    FROM MES.Barcode x 
                                    WHERE x.MoId = a.MoId
                                    AND x.CurrentProdStatus = 'S'
                                ) ScrapBindQty
                                FROM MES.Barcode a 
                                INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                INNER JOIN MES.MoProcess c ON a.CurrentMoProcessId = c.MoProcessId
                                WHERE a.BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeResult.Count() <= 0) throw new SystemException("條碼資料有誤!!");

                        foreach (var item in BarcodeResult)
                        {
                            if (item.BarcodeStatus != "0") throw new SystemException("條碼狀態錯誤!!");
                            if (item.OutputBarcodeFlag != "Y") throw new SystemException("此製令不可使用數量產條碼相關功能!!");
                            if (BarcodeQty > item.BarcodeQty) throw new SystemException("修改數量不可大於原條碼數量!!");

                            if (item.CurrentProdStatus == "P") if (BarcodeQty > (item.TotalPassQty - item.PassBindQty)) throw new SystemException("改判數量(" + BarcodeQty + ")超過良品未綁定條碼數量(" + (item.TotalPassQty - item.PassBindQty) + ")");
                            if (item.CurrentProdStatus == "F") if (BarcodeQty > (item.TotalNgQty - item.NgBindQty)) throw new SystemException("改判數量(" + BarcodeQty + ")超過不良品未綁定條碼數量(" + (item.TotalNgQty - item.NgBindQty) + ")");
                            if (item.CurrentProdStatus == "S") if (BarcodeQty > (item.TotalScrapQty - item.ScrapBindQty)) throw new SystemException("改判數量(" + BarcodeQty + ")超過報廢品未綁定條碼數量(" + (item.TotalScrapQty - item.ScrapBindQty) + ")");
                        }
                        #endregion

                        #region //UPDATE MES.Barcode
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = @BarcodeQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                BarcodeId
                            });
                        int UpdateMoInputQty = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateNextMoProcess-- 更新條碼下一站製程 -- Ann 2023-01-03
        public string UpdateNextMoProcess(string BarcodeNo, int MoProcessId, int NewMoProcessId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        #region //判斷條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeStatus, a.NextMoProcessId OriNextMoProcessId, a.BarcodeQty, a.CurrentProdStatus OriCurrentProdStatus
                                FROM MES.Barcode a
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var barcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (barcodeResult.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                        string BarcodeStatus = "";
                        int BarcodeId = -1;
                        int OriNextMoProcessId = -1;
                        int BarcodeQty = -1;
                        string OriCurrentProdStatus = "";
                        foreach (var item in barcodeResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0")
                            {
                                string ErrorMsg = "條碼目前狀態無法更改製程";
                                switch (item.BarcodeStatus) {
                                    case "8":
                                        ErrorMsg = "條碼目前狀態【製令完工入庫】無法變更下製程";                                       
                                        break;
                                    case "10":
                                        ErrorMsg = "條碼目前狀態【已出貨】無法變更下製程";
                                        break;
                                    case "3":
                                        ErrorMsg = "條碼目前狀態【可上料，但未綁定】無法變更下製程";
                                        break;
                                    case "4":
                                        ErrorMsg = "條碼目前狀態【已綁定上料】無法變更下製程";
                                        break;
                                    case "7":
                                        ErrorMsg = "條碼目前狀態【強制結束流程】無法變更下製程，請向【生管、製程】確認";
                                        break;
                                    default:
                                        ErrorMsg = "條碼目前狀態無法更改製程";
                                        break;
                                }
                                throw new SystemException(ErrorMsg);
                            }
                            else {
                                BarcodeStatus = item.BarcodeStatus;
                                BarcodeId = item.BarcodeId;
                                OriNextMoProcessId = item.OriNextMoProcessId;
                                BarcodeQty = item.BarcodeQty;
                                OriCurrentProdStatus = item.OriCurrentProdStatus;
                                if (BarcodeStatus == "0") BarcodeStatus = "1";
                            } 
                        }
                        #endregion

                        #region //如果TrayBarcode = Y , Replace BarcodeNo
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.TrayBarcode
                                  FROM MES.MoProcess a
                                       INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                 WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MoSettingResult.Count() <= 0) throw new SystemException("找不到制令設定資訊!");
                        string TrayBarcode = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TrayBarcode;

                        if (TrayBarcode.Equals("Y"))
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayId,a.TrayNo,a.BarcodeNo,a.TrayCapacity
                                          FROM MES.Tray a
                                               INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                         WHERE a.BarcodeNo = @BarcodeNo
                                           AND a.[Status] = 'A'
                                           AND a.CompanyId = @CompanyId";

                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var ToBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (ToBarcodeResult.Count() <= 0) throw new SystemException("該Tray盤Barcode資料錯誤,找不到對應資料!");
                            BarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;
                        }

                        #endregion

                        #region //判斷此條碼目前是否為非加工狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess a
                                WHERE BarcodeId = @BarcodeId AND a.FinishDate IS NULL";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var barcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        if (barcodeProcessResult.Count() > 0) throw new SystemException("條碼目前為【加工中】狀態，無法更改!");
                        #endregion

                        #region //判斷原製程資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcess a
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var moProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        if (moProcessResult.Count() <= 0) throw new SystemException("原製程資訊資料錯誤，請確認製令是否正確");
                        #endregion

                        #region //判斷條碼是否在品異單中且未判定
                        sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                FROM QMS.AqBarcode a
                                LEFT JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                WHERE b.BarcodeNo = @BarcodeNo
                                Order By a.LastModifiedDate DESC";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result)
                        {
                            if (item.JudgeStatus == null) throw new SystemException("條碼【" + BarcodeNo + "】目前為品異判定中，無法更改!");
                        }
                        #endregion

                        if (NewMoProcessId != -1)
                        {
                            #region //判斷新製程資訊是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                FROM MES.MoProcess a
                                WHERE MoProcessId = @NewMoProcessId";
                            dynamicParameters.Add("NewMoProcessId", NewMoProcessId);

                            var newMoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            if (newMoProcessResult.Count() <= 0) throw new SystemException("新製程資訊資料錯誤，請確認製令是否正確");
                            #endregion

                            BarcodeStatus = "1";
                        }
                        else
                        {
                            BarcodeStatus = "0";
                        }

                        #region //更新條碼製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                NextMoProcessId = @NewMoProcessId,
                                BarcodeStatus = @BarcodeStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              NewMoProcessId,
                              BarcodeStatus,
                              LastModifiedDate,
                              LastModifiedBy = UserId,
                              BarcodeNo
                          });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //INSERT MES.AdvancedLog
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.AdvancedLog (BarcodeId, MoProcessId, OriNextMoProcessId, NextMoProcessId, OriQty, Qty, OriCurrentProdStatus, CurrentProdStatus
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@BarcodeId, @MoProcessId, @OriNextMoProcessId, @NextMoProcessId, @OriQty, @Qty, @OriCurrentProdStatus, @CurrentProdStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeId,
                                MoProcessId,
                                OriNextMoProcessId,
                                NextMoProcessId = NewMoProcessId,
                                OriQty = BarcodeQty,
                                Qty = BarcodeQty,
                                OriCurrentProdStatus,
                                CurrentProdStatus = OriCurrentProdStatus,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateNextMoProcessForLotMode-- 更新條碼下一站製程(批量修改) -- Ann 2023-10-25
        public string UpdateNextMoProcessForLotMode(string BarcodeNoListString, int MoProcessId, int NewMoProcessId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        var BarcodeNoList = BarcodeNoListString.Split(',');

                        foreach (var barcodeNo in BarcodeNoList)
                        {
                            string BarcodeNo = barcodeNo;

                            #region //判斷條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId, a.MoId, a.BarcodeStatus, a.NextMoProcessId OriNextMoProcessId
                                    , a.BarcodeQty, a.CurrentProdStatus OriCurrentProdStatus
                                    FROM MES.Barcode a
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var barcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (barcodeResult.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                            string BarcodeStatus = "";
                            int BarcodeId = -1;
                            int OriNextMoProcessId = -1;
                            int BarcodeQty = -1;
                            string OriCurrentProdStatus = "";
                            int MoId = -1;
                            foreach (var item in barcodeResult)
                            {
                                if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0")
                                {
                                    string ErrorMsg = "條碼目前狀態無法更改製程";
                                    switch (item.BarcodeStatus)
                                    {
                                        case "8":
                                            ErrorMsg = "條碼目前狀態【製令完工入庫】無法變更下製程";
                                            break;
                                        case "10":
                                            ErrorMsg = "條碼目前狀態【已出貨】無法變更下製程";
                                            break;
                                        case "3":
                                            ErrorMsg = "條碼目前狀態【可上料，但未綁定】無法變更下製程";
                                            break;
                                        case "4":
                                            ErrorMsg = "條碼目前狀態【已綁定上料】無法變更下製程";
                                            break;
                                        case "7":
                                            ErrorMsg = "條碼目前狀態【強制結束流程】無法變更下製程，請向【生管、製程】確認";
                                            break;
                                        default:
                                            ErrorMsg = "條碼目前狀態無法更改製程";
                                            break;
                                    }
                                    throw new SystemException(ErrorMsg);
                                }
                                else
                                {
                                    BarcodeStatus = item.BarcodeStatus;
                                    BarcodeId = item.BarcodeId;
                                    OriNextMoProcessId = item.OriNextMoProcessId;
                                    BarcodeQty = item.BarcodeQty;
                                    OriCurrentProdStatus = item.OriCurrentProdStatus;
                                    MoId = item.MoId;
                                    if (BarcodeStatus == "0") BarcodeStatus = "1";
                                }
                            }
                            #endregion

                            #region //如果TrayBarcode = Y , Replace BarcodeNo
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.TrayBarcode
                                      FROM MES.MoProcess a
                                           INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                     WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);
                            if (MoSettingResult.Count() <= 0) throw new SystemException("找不到制令設定資訊!");
                            string TrayBarcode = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TrayBarcode;

                            if (TrayBarcode.Equals("Y"))
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TrayId,a.TrayNo,a.BarcodeNo,a.TrayCapacity
                                          FROM MES.Tray a
                                               INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                         WHERE a.BarcodeNo = @BarcodeNo
                                           AND a.[Status] = 'A'
                                           AND a.CompanyId = @CompanyId";

                                dynamicParameters.Add("CompanyId", CurrentCompany);
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                var ToBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                if (ToBarcodeResult.Count() <= 0) throw new SystemException("該Tray盤Barcode資料錯誤,找不到對應資料!");
                                BarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;
                            }

                            #endregion

                            #region //判斷此條碼目前是否為非加工狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    WHERE BarcodeId = @BarcodeId AND a.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeId", BarcodeId);

                            var barcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            if (barcodeProcessResult.Count() > 0) throw new SystemException("條碼目前為【加工中】狀態，無法更改!");
                            #endregion

                            #region //判斷原製程資訊是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.MoProcess a
                                    WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var moProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            if (moProcessResult.Count() <= 0) throw new SystemException("原製程資訊資料錯誤，請確認製令是否正確");
                            #endregion

                            #region //判斷條碼是否在品異單中且未判定
                            sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                    FROM QMS.AqBarcode a
                                    LEFT JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE b.BarcodeNo = @BarcodeNo
                                    Order By a.LastModifiedDate DESC";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var result = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result)
                            {
                                if (item.JudgeStatus == null) throw new SystemException("條碼【" + BarcodeNo + "】目前為品異判定中，無法更改!");
                            }
                            #endregion

                            if (NewMoProcessId != -1)
                            {
                                #region //判斷新製程資訊是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.MoProcess a
                                        WHERE MoProcessId = @NewMoProcessId";
                                dynamicParameters.Add("NewMoProcessId", NewMoProcessId);

                                var newMoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                if (newMoProcessResult.Count() <= 0) throw new SystemException("新製程資訊資料錯誤，請確認製令是否正確");
                                #endregion

                                BarcodeStatus = "1";
                            }
                            else
                            {
                                BarcodeStatus = "0";
                            }

                            #region //更新條碼製程
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    NextMoProcessId = @NewMoProcessId,
                                    BarcodeStatus = @BarcodeStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  NewMoProcessId,
                                  BarcodeStatus,
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  BarcodeNo
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //INSERT MES.AdvancedLog
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.AdvancedLog (BarcodeId, MoProcessId, OriNextMoProcessId, NextMoProcessId, OriQty, Qty, OriCurrentProdStatus, CurrentProdStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.LogId
                                    VALUES (@BarcodeId, @MoProcessId, @OriNextMoProcessId, @NextMoProcessId, @OriQty, @Qty, @OriCurrentProdStatus, @CurrentProdStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeId,
                                    MoProcessId,
                                    OriNextMoProcessId,
                                    NextMoProcessId = NewMoProcessId,
                                    OriQty = BarcodeQty,
                                    Qty = BarcodeQty,
                                    OriCurrentProdStatus,
                                    CurrentProdStatus = OriCurrentProdStatus,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                            if (insertResult2.Count() <= 0) throw new SystemException("進階功能紀錄LOG失敗，請重新再試一次!!");

                            rowsAffected += insertResult2.Count();
                            #endregion

                            #region //重新計算條碼狀態報表資料
                            UpdateMoQtyInformation(MoId);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateProdStatus-- 更新條碼狀態 -- Ann 2023-01-03
        public string UpdateProdStatus(int BarcodeProcessId, string ProdStatus, string CauseNo)
        {
            try
            {
                if (ProdStatus == "F" && CauseNo.Length <= 0) throw new SystemException("【異常原因】不能為空!");

                CauseNo = CauseNo.ToUpper();

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        List<AqBarcode> aqBarcodes = new List<AqBarcode>();
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        #region //判斷條碼歷程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.MoId, a.MoProcessId, a.ProdStatus OriCurrentProdStatus
                                , b.NextMoProcessId, b.BarcodeNo, b.BarcodeQty, b.BarcodeStatus, b.CurrentProdStatus
                                , c.DepartmentId
                                , e.CompanyId
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                INNER JOIN BAS.[User] c ON a.CreateBy = c.UserId
                                INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                                INNER JOIN MES.WipOrder e ON d.WoId = e.WoId
                                WHERE a.BarcodeProcessId = @BarcodeProcessId";
                        dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);

                        var barcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        if (barcodeProcessResult.Count() <= 0) throw new SystemException("條碼歷程資料錯誤!");

                        int? BarcodeId = -1;
                        int NextMoProcessId = -1;
                        int MoId = -1;
                        int DepartmentId = -1;
                        int? MoProcessId = -1;
                        string BarcodeNo = "";
                        int BarcodeQty = -1;
                        string OriCurrentProdStatus = "";
                        int CompanyId = -1;
                        foreach (var item in barcodeProcessResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("條碼【" + BarcodeNo + "】目前狀態無法更改!!");
                            if (item.CurrentProdStatus == "S") throw new SystemException("條碼【" + BarcodeNo + "】已報廢，無法使用進階功能修改!!");
                            BarcodeId = item.BarcodeId;
                            NextMoProcessId = item.NextMoProcessId;
                            MoId = item.MoId;
                            DepartmentId = item.DepartmentId;
                            MoProcessId = item.MoProcessId;
                            BarcodeNo = item.BarcodeNo;
                            BarcodeQty = item.BarcodeQty;
                            OriCurrentProdStatus = item.OriCurrentProdStatus;
                            CompanyId = item.CompanyId;
                        }
                        #endregion

                        #region //判斷此條碼目前是否為非加工狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess a
                                WHERE BarcodeId = @BarcodeId AND a.FinishDate IS NULL";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var checkBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        if (checkBarcodeProcessResult.Count() > 0) throw new SystemException("條碼【" + BarcodeNo + "】目前為加工狀態，無法更改!");
                        #endregion

                        int CauseId = -1;
                        string CauseDesc = "";
                        if (CauseNo.Length > 0)
                        {
                            #region //確認異常原因資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.CauseId, a.CauseDesc
                                    FROM QMS.DefectCause a
                                    WHERE a.CauseNo = @CauseNo";
                            dynamicParameters.Add("CauseNo", CauseNo);

                            var defectCauseResult = sqlConnection.Query(sql, dynamicParameters);
                            if (defectCauseResult.Count() <= 0) throw new SystemException("異常原因資料錯誤!");

                            foreach (var item in defectCauseResult)
                            {
                                CauseId = item.CauseId;
                                CauseDesc = item.CauseDesc;
                            }
                            #endregion
                        }

                        #region //判斷條碼是否在品異單中且未判定
                        sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                FROM QMS.AqBarcode a
                                LEFT JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                WHERE b.BarcodeNo = @BarcodeNo
                                Order By a.LastModifiedDate DESC";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result)
                        {
                            if (item.JudgeStatus == null) throw new SystemException("條碼【" + BarcodeNo + "】目前為品異判定中，無法更改，請聯繫製程判定人員協助處理!!");
                        }
                        #endregion

                        #region //設定數量
                        int PassQty = -1;
                        int NgQty = -1;
                        string BarcodeStatus = "";
                        switch (ProdStatus)
                        {
                            case "P":
                                PassQty = 1;
                                NgQty = 0;
                                BarcodeStatus = "1";
                                break;
                            case "F":
                                PassQty = 0;
                                NgQty = 1;
                                BarcodeStatus = "1";
                                break;
                            case "S":
                                PassQty = 0;
                                NgQty = 1;
                                BarcodeStatus = "0";
                                NextMoProcessId = -1;
                                break;
                        }
                        #endregion

                        #region //更新條碼資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                CurrentProdStatus = @ProdStatus,
                                BarcodeStatus = @BarcodeStatus,
                                NextMoProcessId = @NextMoProcessId,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              ProdStatus,
                              BarcodeStatus,
                              NextMoProcessId,
                              LastModifiedDate,
                              LastModifiedBy = UserId,
                              BarcodeId
                          });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        UpdateMoQtyInformation(MoId);

                        #region //若改為F，建立品異單資料
                        AqBarcode aqBarcode = new AqBarcode
                        {
                            QcType = "NON",
                            MoId = MoId,
                            BarcodeId = BarcodeId,
                            ResponsibleDeptId = DepartmentId,
                            ResponsibleUserId = UserId,
                            MoProcessId = MoProcessId,
                            DocDate = CreateDate,
                            DefectCauseId = CauseId
                        };

                        aqBarcodes.Add(aqBarcode);

                        var jsonString = JsonConvert.SerializeObject(aqBarcodes);
                        jsonString = "{\"data\":" + jsonString + "}";
                        #endregion

                        #region //建立品異單
                        if (aqBarcodes.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();

                            int AbnormalqualityId = 0;
                            int? QcBarcodeId = 0;
                            int? nullData = null;
                            string QcType = "";
                            var ConformUserId = nullData;
                            var SubResponsibleDeptId = nullData;
                            var SubResponsibleUserId = nullData;
                            var ProgrammerUserId = nullData;
                            var RepairCauseId = nullData;
                            var RepairCauseUserId = nullData;
                            var ResponsibleSupervisorId = nullData;
                            string DocDate = DateTime.Now.ToString("yyyyMM");
                            int ResponsibleUserId = -1;
                            #region //品異單單頭建立
                            var AbnormalqualityJson = JObject.Parse(jsonString);

                            foreach (var item in AbnormalqualityJson["data"])
                            {
                                if (Convert.ToInt32(item["MoId"]) <= 0) throw new SystemException("【製令】不能為空!");
                                if (Convert.ToInt32(item["DefectCauseId"]) <= 0) throw new SystemException("【不良代碼】不能為空!");
                                if (Convert.ToInt32(item["ResponsibleDeptId"]) <= 0) throw new SystemException("【責任單位】不能為空!");
                                if (Convert.ToInt32(item["ResponsibleUserId"]) <= 0) throw new SystemException("【責任者】不能為空!");

                                if (Convert.ToString(item["QcType"]) != "PVTQC")
                                {
                                    if (Convert.ToInt32(item["BarcodeId"]) <= 0) throw new SystemException("【條碼】不能為空!");

                                    if (Convert.ToString(item["QcType"]) != "NON")
                                    {
                                        if (Convert.ToInt32(item["QcBarcodeId"]) <= 0) throw new SystemException("【檢驗紀錄編號】不能為空!");
                                    }
                                    
                                    #region //判斷條碼是否有進品異
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.AqBarcodeId,a.ProcessStatus,a.JudgeStatus
                                            FROM QMS.AqBarcode a
								            WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                    var resultJudgeStatus = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultJudgeStatus.Count() > 0)
                                    {
                                        string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                        string ProcessStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessStatus;
                                        int AqBarcodeId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).AqBarcodeId;
                                        if (JudgeStatus == "RW")
                                        {
                                            if (ProcessStatus == "I")
                                            {
                                                #region //資料更新
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE QMS.AqBarcode SET
                                                        ProcessStatus = @ProcessStatus,
                                                        LastModifiedBy = @LastModifiedBy,
                                                        LastModifiedDate = @LastModifiedDate
                                                        WHERE AqBarcodeId = @AqBarcodeId";
                                                dynamicParameters.AddDynamicParams(
                                                  new
                                                  {
                                                      ProcessStatus = "V",
                                                      ConformUserId,
                                                      LastModifiedBy,
                                                      LastModifiedDate,
                                                      AqBarcodeId
                                                  });
                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion
                                            }
                                        }
                                    }
                                    #endregion
                                }


                                MoId = Convert.ToInt32(item["MoId"]);
                                QcType = Convert.ToString(item["QcType"]);
                                if (QcType == "IPQC" || QcType == "NON")
                                {
                                    MoProcessId = Convert.ToInt32(item["MoProcessId"]);
                                }
                                else
                                {
                                    MoProcessId = null;
                                }
                                ResponsibleUserId = Convert.ToInt32(item["ResponsibleUserId"]);
                            }

                            #region //單號自動取號
                            string thisDate = CreateDate.ToString("yyyyMM");
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(AbnormalqualityNo))), '000'), 3)) + 1 CurrentNum
                                    FROM QMS.Abnormalquality
								    WHERE AbnormalqualityNo NOT LIKE '%[A-Za-z]%'
                                    AND AbnormalqualityNo LIKE '" + thisDate + "%'";
                            int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                            string AbnormalqualityNo = DocDate + string.Format("{0:000}", currentNum);
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO QMS.Abnormalquality (CompanyId, MoId, MoProcessId, AbnormalqualityNo, AbnormalqualityStatus, DocDate, QcType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.AbnormalqualityId
                                    VALUES (@CompanyId, @MoId, @MoProcessId, @AbnormalqualityNo, @AbnormalqualityStatus, @DocDate, @QcType
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    CompanyId,
                                    MoId,
                                    MoProcessId,
                                    AbnormalqualityNo,
                                    AbnormalqualityStatus = "F",
                                    DocDate = DateTime.Now.ToString("yyyyMMdd"),
                                    QcType,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = ResponsibleUserId,
                                    LastModifiedBy = ResponsibleUserId
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);
                            rowsAffected += insertResult.Count();

                            //取出單頭Id
                            foreach (var item in insertResult)
                            {
                                AbnormalqualityId = item.AbnormalqualityId;
                            }
                            #endregion

                            #region //品異單單身 - 異常條碼建立
                            foreach (var item in AbnormalqualityJson["data"])
                            {

                                if (QcType != "PVTQC")
                                {

                                    if (QcType == "IPQC")
                                    {
                                        #region //判斷條碼是否存在
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                                FROM MES.Barcode a
                                                INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                        INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                                WHERE a.BarcodeId = @BarcodeId
                                                --AND a.BarcodeStatus = '1' 
                                                AND　c.FinishDate is not null";
                                        dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                                        if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】不存在，請重新輸入!");
                                        #endregion
                                    }
                                    else if (QcType == "OQC")
                                    {
                                        #region //判斷條碼是否存在
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                                FROM MES.Barcode a
                                                INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                        INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                                WHERE a.BarcodeId = @BarcodeId
                                                AND　c.FinishDate is not null";
                                        dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                                        if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】不存在，請重新輸入!");
                                        #endregion
                                    }


                                    #region //判斷條碼目前是否在品異單
                                    sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                            FROM QMS.AqBarcode a
                                            WHERE a.BarcodeId =@BarcodeId
                                            Order By a.LastModifiedDate DESC";
                                    dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                    var result2 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result2.Count() > 0)
                                    {
                                        //判斷品異單判斷結果,如果有值且不是S代表已經判定完成,如果條碼有異常可以開立新的品異單
                                        string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                        if (JudgeStatus == null)
                                        {
                                            throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】目前在品異單判定中，不可以開立品異單");
                                        }
                                        else if (JudgeStatus == "S")
                                        {
                                            throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】目前判定不良品，不可以開立品異單");
                                        }
                                    }
                                    #endregion
                                }

                                #region //判斷資料是否存在
                                #region //資料 - NOT NULL
                                #region //判斷不良原因代碼是否存在
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 CauseDesc
                                        FROM QMS.DefectCause a
                                        WHERE a.CauseId = @DefectCauseId";
                                dynamicParameters.Add("DefectCauseId", Convert.ToInt32(item["DefectCauseId"]));

                                var DefectCauseResult = sqlConnection.Query(sql, dynamicParameters);
                                if (DefectCauseResult.Count() <= 0) throw new SystemException("【不良原因代碼】不存在，請重新輸入!");
                                string DefectCauseDesc = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CauseDesc;
                                #endregion

                                if (QcType != "PVTQC")
                                {
                                    if (QcType != "NON")
                                    {
                                        #region //判斷檢驗紀錄編號是否存在
                                        sql = @"SELECT TOP 1 1
                                                FROM MES.QcBarcode a
                                                WHERE a.QcBarcodeId = @QcBarcodeId";
                                        dynamicParameters.Add("QcBarcodeId", Convert.ToInt32(item["QcBarcodeId"]));
                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() <= 0) throw new SystemException("【檢驗紀錄編號:" + item["QcRecordId"].ToString() + "】不存在，請重新輸入!");
                                        #endregion
                                    }
                                }

                                #region //判斷責任單位是否存在
                                dynamicParameters = new DynamicParameters();

                                sql = @"SELECT TOP 1 1
                                        FROM BAS.[User] a
                                        INNER JOIN BAS.Department b on a.DepartmentId = b.DepartmentId
                                        WHERE b.DepartmentId = @ResponsibleDeptId";
                                dynamicParameters.Add("ResponsibleDeptId", Convert.ToInt32(item["ResponsibleDeptId"]));

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【責任單位】不存在，請重新輸入!");
                                #endregion

                                #region //判斷責任者是否存在
                                dynamicParameters = new DynamicParameters();

                                sql = @"SELECT TOP 1 1
                                        FROM BAS.[User] a
                                        WHERE a.UserId = @ResponsibleUserId
                                        AND a.Status = 'A'";
                                dynamicParameters.Add("ResponsibleUserId", Convert.ToInt32(item["ResponsibleUserId"]));

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【責任者】不存在，請重新輸入!");
                                #endregion
                                #endregion

                                #region //資料 - NULL
                                #region //判斷合致對象是否存在
                                if (item["ConformUserId"].ToString() != "")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM BAS.[User] a
                                            WHERE a.UserId = @ConformUserId
                                            AND a.Status = 'A'";
                                    dynamicParameters.Add("ConformUserId", Convert.ToInt32(item["ConformUserId"]));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【合致對象】不存在，請重新輸入!");
                                    ConformUserId = Convert.ToInt32(item["ConformUserId"]);
                                }
                                #endregion

                                #region //判斷副責任單位是否存在
                                if (item["SubResponsibleDeptId"].ToString() != "")
                                {
                                    dynamicParameters = new DynamicParameters();

                                    sql = @"SELECT TOP 1 1
                                            FROM BAS.Department a
                                            WHERE a.DepartmentId = @SubResponsibleDeptId";
                                    dynamicParameters.Add("SubResponsibleDeptId", Convert.ToInt32(item["SubResponsibleDeptId"]));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【副責任單位】不存在，請重新輸入!");
                                    SubResponsibleDeptId = Convert.ToInt32(item["SubResponsibleDeptId"]);
                                }
                                #endregion

                                #region //判斷副責任者是否存在
                                if (item["SubResponsibleUserId"].ToString() != "")
                                {
                                    dynamicParameters = new DynamicParameters();

                                    sql = @"SELECT TOP 1 1
                                            FROM BAS.[User] a
                                            WHERE a.UserId = @SubResponsibleUserId
                                            AND a.Status = 'A'";
                                    dynamicParameters.Add("SubResponsibleUserId", Convert.ToInt32(item["SubResponsibleUserId"]));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【副責任者】不存在，請重新輸入!");

                                    SubResponsibleUserId = Convert.ToInt32(item["SubResponsibleUserId"]);

                                }
                                #endregion

                                #region //判斷編程者是否存在
                                if (item["ProgrammerUserId"].ToString() != "")
                                {
                                    dynamicParameters = new DynamicParameters();

                                    sql = @"SELECT TOP 1 1
                                            FROM BAS.[User] a
                                            WHERE a.UserId = @ProgrammerUserId
                                            AND a.Status = 'A'";
                                    dynamicParameters.Add("ProgrammerUserId", Convert.ToInt32(item["ProgrammerUserId"]));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【編程者】不存在，請重新輸入!");

                                    ProgrammerUserId = Convert.ToInt32(item["ProgrammerUserId"]);

                                }
                                #endregion

                                #endregion
                                #endregion

                                #region //判斷異常條碼目前處在哪個階段
                                int AqBarcodeStatus = 0;
                                if (Convert.ToInt32(item["DefectCauseId"]) > 0)
                                {
                                    AqBarcodeStatus = 1;
                                }
                                else
                                {
                                    throw new SystemException("【缺少不良原因代碼】，不能回報");
                                }
                                #endregion

                                if (QcType != "PVTQC")
                                {
                                    #region //更新異常條碼目前狀態
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            CurrentProdStatus = 'F',
                                            LastModifiedBy = @LastModifiedBy,
                                            LastModifiedDate = @LastModifiedDate
                                            WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          LastModifiedBy,
                                          LastModifiedDate,
                                          BarcodeId = Convert.ToInt32(item["BarcodeId"])
                                      });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    BarcodeId = Convert.ToInt32(item["BarcodeId"]);
                                    if (QcType == "NON")
                                    {
                                        if (item["QcBarcodeId"].Count() == 0)
                                        {
                                            QcBarcodeId = nullData;
                                        }
                                    }
                                    else
                                    {
                                        QcBarcodeId = Convert.ToInt32(item["QcBarcodeId"]);
                                    }

                                }
                                else
                                {
                                    BarcodeId = nullData;
                                    QcBarcodeId = nullData;
                                }



                                #region //新增 - 品異單單身
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO QMS.AqBarcode (AbnormalqualityId, BarcodeId, QcBarcodeId, DefectCauseId, DefectCauseDesc, ConformUserId, 
                                        ResponsibleDeptId, ResponsibleUserId, SubResponsibleDeptId, SubResponsibleUserId, ProgrammerUserId, 
                                        RepairCauseId, RepairCauseDesc, RepairCauseUserId,AqBarcodeStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.AqBarcodeId
                                        VALUES (@AbnormalqualityId, @BarcodeId, @QcBarcodeId, @DefectCauseId, @DefectCauseDesc, @ConformUserId, 
                                        @ResponsibleDeptId, @ResponsibleUserId, @SubResponsibleDeptId, @SubResponsibleUserId, @ProgrammerUserId, 
                                        @RepairCauseId, @RepairCauseDesc, @RepairCauseUserId, @AqBarcodeStatus, 
                                        @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AbnormalqualityId,
                                        BarcodeId,
                                        QcBarcodeId,
                                        DefectCauseId = Convert.ToInt32(item["DefectCauseId"]),
                                        DefectCauseDesc,
                                        ConformUserId,
                                        ResponsibleDeptId = Convert.ToInt32(item["ResponsibleDeptId"]),
                                        ResponsibleUserId = Convert.ToInt32(item["ResponsibleUserId"]),
                                        SubResponsibleDeptId,
                                        SubResponsibleUserId,
                                        ProgrammerUserId,
                                        RepairCauseId,
                                        RepairCauseDesc = nullData,
                                        RepairCauseUserId,
                                        AqBarcodeStatus,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });
                                var AqBarcodeInsertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += AqBarcodeInsertResult.Count();
                                #endregion

                            }
                            #endregion
                        }
                        #endregion

                        #region //INSERT MES.AdvancedLog
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.AdvancedLog (BarcodeId, MoProcessId, OriNextMoProcessId, NextMoProcessId, OriQty, Qty, OriCurrentProdStatus, CurrentProdStatus, CauseNo
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.LogId
                                VALUES (@BarcodeId, @MoProcessId, @OriNextMoProcessId, @NextMoProcessId, @OriQty, @Qty, @OriCurrentProdStatus, @CurrentProdStatus, @CauseNo
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeId,
                                MoProcessId,
                                OriNextMoProcessId = NextMoProcessId,
                                NextMoProcessId,
                                OriQty = BarcodeQty,
                                Qty = BarcodeQty,
                                OriCurrentProdStatus,
                                CurrentProdStatus = ProdStatus,
                                CauseNo,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        if (insertResult2.Count() <= 0) throw new SystemException("進階功能紀錄LOG失敗，請重新再試一次!!");

                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //重新計算條碼狀態報表資料
                        UpdateMoQtyInformation(MoId);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            jsonData = jsonString
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateProdStatusForLotMode-- 更新條碼狀態(批量修改版本) -- Ann 2023-10-25
        public string UpdateProdStatusForLotMode(string BarcodeProcessIdListString, string ProdStatus, string CauseNo)
        {
            try
            {
                if (ProdStatus == "F" && CauseNo.Length <= 0) throw new SystemException("【異常原因】不能為空!");

                CauseNo = CauseNo.ToUpper();

                string jsonString = "";
                int MoId = -1;
                int CompanyId = -1;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        List<AqBarcode> aqBarcodes = new List<AqBarcode>();
                        int UserId = CreateBy;
                        int rowsAffected = 0;

                        var BarcodeProcessIdList = BarcodeProcessIdListString.Split(',');

                        foreach (var barcodeProcessId in BarcodeProcessIdList)
                        {
                            #region //判斷條碼歷程資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId, a.MoId, a.MoProcessId, a.ProdStatus OriCurrentProdStatus
                                    , b.NextMoProcessId, b.BarcodeNo, b.BarcodeQty, b.BarcodeStatus, b.CurrentProdStatus
                                    , c.DepartmentId
                                    , e.CompanyId
                                    FROM MES.BarcodeProcess a
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    INNER JOIN BAS.[User] c ON a.CreateBy = c.UserId
                                    INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                                    INNER JOIN MES.WipOrder e ON d.WoId = e.WoId
                                    WHERE a.BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.Add("BarcodeProcessId", barcodeProcessId);

                            var barcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            if (barcodeProcessResult.Count() <= 0) throw new SystemException("條碼歷程資料錯誤!");

                            int? BarcodeId = -1;
                            int NextMoProcessId = -1;
                            int DepartmentId = -1;
                            int? MoProcessId = -1;
                            string BarcodeNo = "";
                            int BarcodeQty = -1;
                            string OriCurrentProdStatus = "";
                            foreach (var item in barcodeProcessResult)
                            {
                                if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("條碼【" + item.BarcodeNo + "】目前狀態無法更改!!");
                                if (item.CurrentProdStatus == "S") throw new SystemException("條碼【" + item.BarcodeNo + "】已報廢，無法使用進階功能修改!!");
                                if (item.BarcodeQty > 1) throw new SystemException("條碼【" + item.BarcodeNo + "】數量大於1，無法使用此功能，請聯繫資訊人員!!");
                                BarcodeId = item.BarcodeId;
                                NextMoProcessId = item.NextMoProcessId;
                                MoId = item.MoId;
                                DepartmentId = item.DepartmentId;
                                MoProcessId = item.MoProcessId;
                                BarcodeNo = item.BarcodeNo;
                                BarcodeQty = item.BarcodeQty;
                                OriCurrentProdStatus = item.OriCurrentProdStatus;
                                CompanyId = item.CompanyId;
                            }
                            #endregion

                            #region //判斷此條碼目前是否為非加工狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeProcess a
                                    WHERE BarcodeId = @BarcodeId AND a.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeId", BarcodeId);

                            var checkBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            if (checkBarcodeProcessResult.Count() > 0) throw new SystemException("條碼【" + BarcodeNo + "】目前為加工狀態，無法更改!");
                            #endregion

                            int CauseId = -1;
                            string CauseDesc = "";
                            if (CauseNo.Length > 0)
                            {
                                #region //確認異常原因資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.CauseId, a.CauseDesc
                                        FROM QMS.DefectCause a
                                        WHERE a.CauseNo = @CauseNo";
                                dynamicParameters.Add("CauseNo", CauseNo);

                                var defectCauseResult = sqlConnection.Query(sql, dynamicParameters);
                                if (defectCauseResult.Count() <= 0) throw new SystemException("異常原因資料錯誤!");

                                foreach (var item in defectCauseResult)
                                {
                                    CauseId = item.CauseId;
                                    CauseDesc = item.CauseDesc;
                                }
                                #endregion
                            }

                            #region //判斷條碼是否在品異單中且未判定
                            sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                    FROM QMS.AqBarcode a
                                    LEFT JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE b.BarcodeNo = @BarcodeNo
                                    Order By a.LastModifiedDate DESC";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var result = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result)
                            {
                                if (item.JudgeStatus == null) throw new SystemException("條碼【" + BarcodeNo + "】目前為品異判定中，無法更改，請聯繫製程判定人員協助處理!!");
                            }
                            #endregion

                            #region //設定數量
                            int PassQty = -1;
                            int NgQty = -1;
                            string BarcodeStatus = "";
                            switch (ProdStatus)
                            {
                                case "P":
                                    PassQty = 1;
                                    NgQty = 0;
                                    BarcodeStatus = "1";
                                    break;
                                case "F":
                                    PassQty = 0;
                                    NgQty = 1;
                                    BarcodeStatus = "1";
                                    break;
                                case "S":
                                    PassQty = 0;
                                    NgQty = 1;
                                    BarcodeStatus = "0";
                                    NextMoProcessId = -1;
                                    break;
                            }
                            #endregion

                            #region //更新條碼資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    CurrentProdStatus = @ProdStatus,
                                    BarcodeStatus = @BarcodeStatus,
                                    NextMoProcessId = @NextMoProcessId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @BarcodeId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  ProdStatus,
                                  BarcodeStatus,
                                  NextMoProcessId,
                                  LastModifiedDate,
                                  LastModifiedBy = UserId,
                                  BarcodeId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            UpdateMoQtyInformation(MoId);

                            #region //若改為F，建立品異單資料
                            if (ProdStatus == "F")
                            {
                                AqBarcode aqBarcode = new AqBarcode
                                {
                                    QcType = "NON",
                                    MoId = MoId,
                                    BarcodeId = BarcodeId,
                                    ResponsibleDeptId = DepartmentId,
                                    ResponsibleUserId = UserId,
                                    MoProcessId = MoProcessId,
                                    DocDate = CreateDate,
                                    DefectCauseId = CauseId
                                };

                                aqBarcodes.Add(aqBarcode);
                            }
                            #endregion

                            #region //INSERT MES.AdvancedLog
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.AdvancedLog (BarcodeId, MoProcessId, OriNextMoProcessId, NextMoProcessId, OriQty, Qty, OriCurrentProdStatus, CurrentProdStatus, CauseNo
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.LogId
                                    VALUES (@BarcodeId, @MoProcessId, @OriNextMoProcessId, @NextMoProcessId, @OriQty, @Qty, @OriCurrentProdStatus, @CurrentProdStatus, @CauseNo
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeId,
                                    MoProcessId,
                                    OriNextMoProcessId = NextMoProcessId,
                                    NextMoProcessId,
                                    OriQty = BarcodeQty,
                                    Qty = BarcodeQty,
                                    OriCurrentProdStatus,
                                    CurrentProdStatus = ProdStatus,
                                    CauseNo,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                            if (insertResult2.Count() <= 0) throw new SystemException("進階功能紀錄LOG失敗，請重新再試一次!!");

                            rowsAffected += insertResult2.Count();
                            #endregion
                        }

                        jsonString = JsonConvert.SerializeObject(aqBarcodes);
                        jsonString = "{\"data\":" + jsonString + "}";

                        #region //建立品異單
                        if (aqBarcodes.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();

                            int AbnormalqualityId = 0;
                            int? QcBarcodeId = 0;
                            int? nullData = null;
                            string QcType = "";
                            var ConformUserId = nullData;
                            var SubResponsibleDeptId = nullData;
                            var SubResponsibleUserId = nullData;
                            var ProgrammerUserId = nullData;
                            var RepairCauseId = nullData;
                            var RepairCauseUserId = nullData;
                            var ResponsibleSupervisorId = nullData;
                            string DocDate = DateTime.Now.ToString("yyyyMM");
                            int ResponsibleUserId = -1;
                            #region //品異單單頭建立
                            var AbnormalqualityJson = JObject.Parse(jsonString);

                            int? MoProcessId = -1;
                            int? BarcodeId = -1;

                            foreach (var item in AbnormalqualityJson["data"])
                            {
                                if (Convert.ToInt32(item["MoId"]) <= 0) throw new SystemException("【製令】不能為空!");
                                if (Convert.ToInt32(item["DefectCauseId"]) <= 0) throw new SystemException("【不良代碼】不能為空!");
                                if (Convert.ToInt32(item["ResponsibleDeptId"]) <= 0) throw new SystemException("【責任單位】不能為空!");
                                if (Convert.ToInt32(item["ResponsibleUserId"]) <= 0) throw new SystemException("【責任者】不能為空!");

                                if (Convert.ToString(item["QcType"]) != "PVTQC")
                                {
                                    if (Convert.ToInt32(item["BarcodeId"]) <= 0) throw new SystemException("【條碼】不能為空!");

                                    if (Convert.ToString(item["QcType"]) != "NON")
                                    {
                                        if (Convert.ToInt32(item["QcBarcodeId"]) <= 0) throw new SystemException("【檢驗紀錄編號】不能為空!");
                                    }

                                    #region //判斷條碼是否有進品異
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.AqBarcodeId,a.ProcessStatus,a.JudgeStatus
                                                FROM QMS.AqBarcode a
								                WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                    var resultJudgeStatus = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultJudgeStatus.Count() > 0)
                                    {
                                        string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                        string ProcessStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessStatus;
                                        int AqBarcodeId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).AqBarcodeId;
                                        if (JudgeStatus == "RW")
                                        {
                                            if (ProcessStatus == "I")
                                            {
                                                #region //資料更新
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE QMS.AqBarcode SET
                                                            ProcessStatus = @ProcessStatus,
                                                            LastModifiedBy = @LastModifiedBy,
                                                            LastModifiedDate = @LastModifiedDate
                                                            WHERE AqBarcodeId = @AqBarcodeId";
                                                dynamicParameters.AddDynamicParams(
                                                  new
                                                  {
                                                      ProcessStatus = "V",
                                                      ConformUserId,
                                                      LastModifiedBy,
                                                      LastModifiedDate,
                                                      AqBarcodeId
                                                  });
                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion
                                            }
                                        }
                                    }
                                    #endregion
                                }


                                MoId = Convert.ToInt32(item["MoId"]);
                                MoProcessId = -1;
                                QcType = Convert.ToString(item["QcType"]);
                                if (QcType == "IPQC" || QcType == "NON")
                                {
                                    MoProcessId = Convert.ToInt32(item["MoProcessId"]);
                                }
                                else
                                {
                                    MoProcessId = null;
                                }
                                ResponsibleUserId = Convert.ToInt32(item["ResponsibleUserId"]);
                            }

                            #region //單號自動取號
                            string thisDate = CreateDate.ToString("yyyyMM");
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(AbnormalqualityNo))), '000'), 3)) + 1 CurrentNum
                                        FROM QMS.Abnormalquality
								        WHERE AbnormalqualityNo NOT LIKE '%[A-Za-z]%'
                                        AND AbnormalqualityNo LIKE '" + thisDate + "%'";
                            int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                            string AbnormalqualityNo = DocDate + string.Format("{0:000}", currentNum);
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO QMS.Abnormalquality (CompanyId, MoId, MoProcessId, AbnormalqualityNo, AbnormalqualityStatus, DocDate, QcType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.AbnormalqualityId
                                    VALUES (@CompanyId, @MoId, @MoProcessId, @AbnormalqualityNo, @AbnormalqualityStatus, @DocDate, @QcType
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    CompanyId,
                                    MoId,
                                    MoProcessId,
                                    AbnormalqualityNo,
                                    AbnormalqualityStatus = "F",
                                    DocDate = DateTime.Now.ToString("yyyyMMdd"),
                                    QcType,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = ResponsibleUserId,
                                    LastModifiedBy = ResponsibleUserId
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);
                            rowsAffected += insertResult.Count();

                            //取出單頭Id
                            foreach (var item in insertResult)
                            {
                                AbnormalqualityId = item.AbnormalqualityId;
                            }
                            #endregion

                            #region //品異單單身 - 異常條碼建立
                            foreach (var item in AbnormalqualityJson["data"])
                            {

                                if (QcType != "PVTQC")
                                {

                                    if (QcType == "IPQC")
                                    {
                                        #region //判斷條碼是否存在
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                                FROM MES.Barcode a
                                                INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                        INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                                WHERE a.BarcodeId = @BarcodeId
                                                --AND a.BarcodeStatus = '1' 
                                                AND　c.FinishDate is not null";
                                        dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                                        if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】不存在，請重新輸入!");
                                        #endregion
                                    }
                                    else if (QcType == "OQC")
                                    {
                                        #region //判斷條碼是否存在
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeNo,a.BarcodeStatus
                                                FROM MES.Barcode a
                                                INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
		                                        INNER JOIN MES.BarcodeProcess c ON b.MoProcessId = c.MoProcessId and a.BarcodeId =c.BarcodeId
                                                WHERE a.BarcodeId = @BarcodeId
                                                AND　c.FinishDate is not null";
                                        dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                                        if (result1.Count() <= 0) throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】不存在，請重新輸入!");
                                        #endregion
                                    }


                                    #region //判斷條碼目前是否在品異單
                                    sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                            FROM QMS.AqBarcode a
                                            WHERE a.BarcodeId =@BarcodeId
                                            Order By a.LastModifiedDate DESC";
                                    dynamicParameters.Add("BarcodeId", Convert.ToInt32(item["BarcodeId"]));
                                    var result2 = sqlConnection.Query(sql, dynamicParameters);
                                    if (result2.Count() > 0)
                                    {
                                        //判斷品異單判斷結果,如果有值且不是S代表已經判定完成,如果條碼有異常可以開立新的品異單
                                        string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                                        if (JudgeStatus == null)
                                        {
                                            throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】目前在品異單判定中，不可以開立品異單");
                                        }
                                        else if (JudgeStatus == "S")
                                        {
                                            throw new SystemException("【條碼Id:" + Convert.ToInt32(item["BarcodeId"]) + "】目前判定不良品，不可以開立品異單");
                                        }
                                    }
                                    #endregion
                                }

                                #region //判斷資料是否存在
                                #region //資料 - NOT NULL
                                #region //判斷不良原因代碼是否存在
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 CauseDesc
                                        FROM QMS.DefectCause a
                                        WHERE a.CauseId = @DefectCauseId";
                                dynamicParameters.Add("DefectCauseId", Convert.ToInt32(item["DefectCauseId"]));

                                var DefectCauseResult = sqlConnection.Query(sql, dynamicParameters);
                                if (DefectCauseResult.Count() <= 0) throw new SystemException("【不良原因代碼】不存在，請重新輸入!");
                                string DefectCauseDesc = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CauseDesc;
                                #endregion

                                if (QcType != "PVTQC")
                                {
                                    if (QcType != "NON")
                                    {
                                        #region //判斷檢驗紀錄編號是否存在
                                        sql = @"SELECT TOP 1 1
                                                FROM MES.QcBarcode a
                                                WHERE a.QcBarcodeId = @QcBarcodeId";
                                        dynamicParameters.Add("QcBarcodeId", Convert.ToInt32(item["QcBarcodeId"]));
                                        var QcBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                        if (QcBarcodeResult.Count() <= 0) throw new SystemException("【檢驗紀錄編號:" + item["QcRecordId"].ToString() + "】不存在，請重新輸入!");
                                        #endregion
                                    }
                                }

                                #region //判斷責任單位是否存在
                                dynamicParameters = new DynamicParameters();

                                sql = @"SELECT TOP 1 1
                                        FROM BAS.[User] a
                                        INNER JOIN BAS.Department b on a.DepartmentId = b.DepartmentId
                                        WHERE b.DepartmentId = @ResponsibleDeptId";
                                dynamicParameters.Add("ResponsibleDeptId", Convert.ToInt32(item["ResponsibleDeptId"]));

                                var result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【責任單位】不存在，請重新輸入!");
                                #endregion

                                #region //判斷責任者是否存在
                                dynamicParameters = new DynamicParameters();

                                sql = @"SELECT TOP 1 1
                                        FROM BAS.[User] a
                                        WHERE a.UserId = @ResponsibleUserId
                                        AND a.Status = 'A'";
                                dynamicParameters.Add("ResponsibleUserId", Convert.ToInt32(item["ResponsibleUserId"]));

                                result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() <= 0) throw new SystemException("【責任者】不存在，請重新輸入!");
                                #endregion
                                #endregion

                                #region //資料 - NULL
                                #region //判斷合致對象是否存在
                                if (item["ConformUserId"].ToString() != "")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM BAS.[User] a
                                            WHERE a.UserId = @ConformUserId
                                            AND a.Status = 'A'";
                                    dynamicParameters.Add("ConformUserId", Convert.ToInt32(item["ConformUserId"]));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【合致對象】不存在，請重新輸入!");
                                    ConformUserId = Convert.ToInt32(item["ConformUserId"]);
                                }
                                #endregion

                                #region //判斷副責任單位是否存在
                                if (item["SubResponsibleDeptId"].ToString() != "")
                                {
                                    dynamicParameters = new DynamicParameters();

                                    sql = @"SELECT TOP 1 1
                                            FROM BAS.Department a
                                            WHERE a.DepartmentId = @SubResponsibleDeptId";
                                    dynamicParameters.Add("SubResponsibleDeptId", Convert.ToInt32(item["SubResponsibleDeptId"]));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【副責任單位】不存在，請重新輸入!");
                                    SubResponsibleDeptId = Convert.ToInt32(item["SubResponsibleDeptId"]);
                                }
                                #endregion

                                #region //判斷副責任者是否存在
                                if (item["SubResponsibleUserId"].ToString() != "")
                                {
                                    dynamicParameters = new DynamicParameters();

                                    sql = @"SELECT TOP 1 1
                                            FROM BAS.[User] a
                                            WHERE a.UserId = @SubResponsibleUserId
                                            AND a.Status = 'A'";
                                    dynamicParameters.Add("SubResponsibleUserId", Convert.ToInt32(item["SubResponsibleUserId"]));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【副責任者】不存在，請重新輸入!");

                                    SubResponsibleUserId = Convert.ToInt32(item["SubResponsibleUserId"]);

                                }
                                #endregion

                                #region //判斷編程者是否存在
                                if (item["ProgrammerUserId"].ToString() != "")
                                {
                                    dynamicParameters = new DynamicParameters();

                                    sql = @"SELECT TOP 1 1
                                            FROM BAS.[User] a
                                            WHERE a.UserId = @ProgrammerUserId
                                            AND a.Status = 'A'";
                                    dynamicParameters.Add("ProgrammerUserId", Convert.ToInt32(item["ProgrammerUserId"]));

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() <= 0) throw new SystemException("【編程者】不存在，請重新輸入!");

                                    ProgrammerUserId = Convert.ToInt32(item["ProgrammerUserId"]);

                                }
                                #endregion

                                #endregion
                                #endregion

                                #region //判斷異常條碼目前處在哪個階段
                                int AqBarcodeStatus = 0;
                                if (Convert.ToInt32(item["DefectCauseId"]) > 0)
                                {
                                    AqBarcodeStatus = 1;
                                }
                                else
                                {
                                    throw new SystemException("【缺少不良原因代碼】，不能回報");
                                }
                                #endregion

                                if (QcType != "PVTQC")
                                {
                                    #region //更新異常條碼目前狀態
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode SET
                                            CurrentProdStatus = 'F',
                                            LastModifiedBy = @LastModifiedBy,
                                            LastModifiedDate = @LastModifiedDate
                                            WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          LastModifiedBy,
                                          LastModifiedDate,
                                          BarcodeId = Convert.ToInt32(item["BarcodeId"])
                                      });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    BarcodeId = Convert.ToInt32(item["BarcodeId"]);
                                    if (QcType == "NON")
                                    {
                                        if (item["QcBarcodeId"].Count() == 0)
                                        {
                                            QcBarcodeId = nullData;
                                        }
                                    }
                                    else
                                    {
                                        QcBarcodeId = Convert.ToInt32(item["QcBarcodeId"]);
                                    }

                                }
                                else
                                {
                                    BarcodeId = nullData;
                                    QcBarcodeId = nullData;
                                }



                                #region //新增 - 品異單單身
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO QMS.AqBarcode (AbnormalqualityId, BarcodeId, QcBarcodeId, DefectCauseId, DefectCauseDesc, ConformUserId, 
                                        ResponsibleDeptId, ResponsibleUserId, SubResponsibleDeptId, SubResponsibleUserId, ProgrammerUserId, 
                                        RepairCauseId, RepairCauseDesc, RepairCauseUserId,AqBarcodeStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.AqBarcodeId
                                        VALUES (@AbnormalqualityId, @BarcodeId, @QcBarcodeId, @DefectCauseId, @DefectCauseDesc, @ConformUserId, 
                                        @ResponsibleDeptId, @ResponsibleUserId, @SubResponsibleDeptId, @SubResponsibleUserId, @ProgrammerUserId, 
                                        @RepairCauseId, @RepairCauseDesc, @RepairCauseUserId, @AqBarcodeStatus, 
                                        @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AbnormalqualityId,
                                        BarcodeId,
                                        QcBarcodeId,
                                        DefectCauseId = Convert.ToInt32(item["DefectCauseId"]),
                                        DefectCauseDesc,
                                        ConformUserId,
                                        ResponsibleDeptId = Convert.ToInt32(item["ResponsibleDeptId"]),
                                        ResponsibleUserId = Convert.ToInt32(item["ResponsibleUserId"]),
                                        SubResponsibleDeptId,
                                        SubResponsibleUserId,
                                        ProgrammerUserId,
                                        RepairCauseId,
                                        RepairCauseDesc = nullData,
                                        RepairCauseUserId,
                                        AqBarcodeStatus,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });
                                var AqBarcodeInsertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += AqBarcodeInsertResult.Count();
                                #endregion

                            }
                            #endregion
                        }
                        #endregion

                        #region //重新計算條碼狀態報表資料
                        UpdateMoQtyInformation(MoId);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            jsonData = jsonString
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateUnbindJigBarcode-- 查詢條碼是否完工，若完工則自動解除模仁治具綁定 -- Ann 2023-03-07
        public string UpdateUnbindJigBarcode(string JigBarcodeIdData, string JigNo)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int UserId = CreateBy;
                        int rowsAffected = 0;
                        var jigBarcodeList = JigBarcodeIdData.Split(',');
                        foreach (var jigBarcodeId in jigBarcodeList)
                        {
                            #region //判斷治具條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo, a.MoProcessId, a.JigId, a.WorkingFlag
                                    FROM MES.JigBarcode a
                                    INNER JOIN MES.Jig b ON a.JigId = b.JigId
                                    WHERE a.WorkingFlag = 'Y'
                                    AND a.JigBarcodeId = @JigBarcodeId
                                    AND b.JigNo = @JigNo";
                            dynamicParameters.Add("JigBarcodeId", jigBarcodeId);
                            dynamicParameters.Add("JigNo", JigNo);

                            var JigBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (JigBarcodeResult.Count() <= 0) throw new SystemException("治具條碼資料錯誤!");

                            string BarcodeNo = "";
                            int MoProcessId = -1;
                            int JigId = -1;
                            string WorkingFlag = "";
                            foreach (var item in JigBarcodeResult)
                            {
                                BarcodeNo = item.BarcodeNo;
                                MoProcessId = item.MoProcessId;
                                JigId = item.JigId;
                                WorkingFlag = item.WorkingFlag;
                            }
                            #endregion

                            #region //查詢條碼目前狀態是否非加工狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 a.FinishDate
                                    FROM MES.BarcodeProcess a
                                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    WHERE b.BarcodeNo = @BarcodeNo
                                    AND a.MoProcessId = @MoProcessId
                                    ORDER BY a.BarcodeProcessId DESC";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //若完工，自動解除相關治具條碼
                            foreach (var item in BarcodeProcessResult)
                            {
                                if (item.FinishDate != null)
                                {
                                    #region //刪除主要table
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE MES.JigBarcode
                                            WHERE JigBarcodeId = @JigBarcodeId";
                                    dynamicParameters.Add("JigBarcodeId", jigBarcodeId);

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region //建立治具條碼歷史紀錄
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.JigBarcodeHistory (JigId, BarcodeNo, MoProcessId, WorkingFlag
                                            , CreateDate, CreateBy)
                                            OUTPUT INSERTED.HistoryId
                                            VALUES (@JigId, @BarcodeNo, @MoProcessId, @WorkingFlag
                                            , @CreateDate, @CreateBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            JigId,
                                            BarcodeNo,
                                            MoProcessId,
                                            WorkingFlag,
                                            CreateDate,
                                            CreateBy = UserId
                                        });

                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                    #endregion
                                }
                            }
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //工程檢
        #region //UpdateTempQcMeasureData -- 更新工程檢量測數據暫存資料 -- Ann 2022-11-10
        public string UpdateTempQcMeasureData(int BarcodeId, int MoProcessId, string Status)
        {
            try
            {
                if (Status.Length < 0) throw new SystemException("【狀態】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Barcode
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("條碼資料錯誤!");
                        #endregion

                        #region //判斷製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.MoProcess
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("製令製程資料錯誤!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE QMS.TempQcMeasureData SET
                                Status = @Status,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @BarcodeId
                                AND MoProcessId = @MoProcessId";
                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              Status,
                              LastModifiedDate,
                              LastModifiedBy,
                              BarcodeId,
                              MoProcessId
                          });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //出貨檢
        #region //UpdateTempOQcMeasureData -- 更新出貨檢量測數據暫存資料 -- Ann 2022-11-23
        public string UpdateTempOQcMeasureData(int MoId, string BarcodeNo, string Status, int BarcodeId)
        {
            try
            {
                if (Status.Length < 0) throw new SystemException("【狀態】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;
                        if (BarcodeNo.Length > 0)
                        {
                            #region //判斷條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT BarcodeId
                                    FROM MES.Barcode
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                            foreach (var item in result)
                            {
                                BarcodeId = item.BarcodeId;
                            }
                            #endregion
                        }

                        if (BarcodeId > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE QMS.TempQcMeasureData SET
                                    Status = @Status,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @BarcodeId";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  Status,
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  BarcodeId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE a SET
                                    a.[Status] = @Status,
                                    a.LastModifiedDate = @LastModifiedDate,
                                    a.LastModifiedBy = @LastModifiedBy
                                    FROM QMS.TempQcMeasureData a
                                    INNER JOIN QMS.QcNoticeItemSpec b ON a.QcNoticeItemSpecId = b.QcNoticeItemSpecId
                                    INNER JOIN QMS.QcNotice c ON b.QcNoticeId = c.QcNoticeId
                                    WHERE a.MoId = @MoId
                                    AND a.BarcodeId IS NULL";
                            dynamicParameters.AddDynamicParams(
                              new
                              {
                                  Status,
                                  LastModifiedDate,
                                  LastModifiedBy,
                                  MoId
                              });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //物料載盤
        #region //UpdateImportVehicle -- 物料載盤 MAPPING TrayBarcode -- Ann 2024-05-27
        public string UpdateImportVehicle(string VehicleNo, int MoProcessId, string AssemblyBarcodeNo)
        {
            try
            {
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認物料載盤資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.VehicleId
                                FROM MES.Vehicle a 
                                WHERE a.VehicleNo = @VehicleNo
                                AND a.[Status] = 'A'
                                AND a.CompanyId = @CompanyId";
                        dynamicParameters.Add("VehicleNo", VehicleNo);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var VehicleResult = sqlConnection.Query(sql, dynamicParameters);

                        if (VehicleResult.Count() <= 0) throw new SystemException("物料載盤資料錯誤!!");

                        int VehicleId = -1;
                        foreach (var item in VehicleResult)
                        {
                            VehicleId = item.VehicleId;
                        }
                        #endregion

                        #region //確認製令製程資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId
                                FROM MES.MoProcess a 
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoProcessResult.Count() <= 0) throw new SystemException("製令製程資料錯誤!!");

                        int MoId = -1;
                        foreach (var item in MoProcessResult)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //確認主件條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId AssemblyBarcodeId, a.BarcodeQty, a.CurrentMoProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                FROM MES.Barcode a 
                                WHERE a.BarcodeNo = @AssemblyBarcodeNo";
                        dynamicParameters.Add("AssemblyBarcodeNo", AssemblyBarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeResult.Count() <= 0) throw new SystemException("主件條碼資料錯誤!!");

                        int AssemblyBarcodeId = -1;
                        foreach (var item in BarcodeResult)
                        {
                            if (item.BarcodeQty <= 0) throw new SystemException("主件條碼數量異常!!");
                            if (item.CurrentMoProcessId != MoProcessId) throw new SystemException("主件條碼目前製程與上料製程不同!!");
                            if (item.CurrentProdStatus != "P") throw new SystemException("主件條碼非良品!!");
                            if (item.BarcodeStatus != "1") throw new SystemException("主件條碼非在製狀態!!");
                            AssemblyBarcodeId = item.AssemblyBarcodeId;
                        }
                        #endregion

                        #region //確認此主件尚無任何上料資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeComponent a 
                                WHERE a.AssemblyBarcodeId = @AssemblyBarcodeId
                                AND a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("AssemblyBarcodeId", AssemblyBarcodeId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeComponentResult.Count() > 0) throw new SystemException("此主條碼再當前站別已有上料資料，無法使用載盤模式!!");
                        #endregion

                        #region //確認物料載盤已綁定所有需上料之物料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT c.MtlItemId, c.MtlItemNo 
                                , (
                                    SELECT TOP 1 1
                                    FROM MES.VehicleDetail x 
                                    INNER JOIN MES.Vehicle xa ON x.VehicleId = xa.VehicleId
                                    INNER JOIN SCM.LotNumber xb ON x.LotNumberId = xb.LotNumberId
                                    WHERE xb.MtlItemId = b.MtlItemId
                                    AND x.MoProcessId = a.MoProcessId
                                    AND xa.VehicleId = @VehicleId
                                    AND x.ExpirationDate IS NULL
                                    AND x.[Status] = 'A'
                                ) CheckBindStatus
                                FROM MES.MoMtlSetting a
                                INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                WHERE a.MainBarcode = 'N'
                                AND a.ProcessBinding = 'Y'
                                AND a.MoProcessId = @MoProcessId 
                                AND a.BindType != 'N'";
                        dynamicParameters.Add("VehicleId", VehicleId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var MoMtlSettingResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoMtlSettingResult.Count() <= 0) throw new SystemException("此製令製程查無上料資料!!");

                        List<int> mtlItemIdList = new List<int>();
                        List<int> errorMtlItemIdList = new List<int>();
                        foreach (var item in MoMtlSettingResult)
                        {
                            if (item.CheckBindStatus == null)
                            {
                                errorMtlItemIdList.Add(item.MtlItemId);
                            }

                            mtlItemIdList.Add(item.MtlItemId);
                        }
                        #endregion

                        #region //確認未在載盤上的物料是否已有其他關聯物料註冊
                        foreach (var item in errorMtlItemIdList)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemId, a.SubstitutionId
                                    FROM MES.MrDetail a 
                                    WHERE a.MtlItemId = @MtlItemId
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("MtlItemId", item);
                            dynamicParameters.Add("MoId", MoId);

                            var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MrDetailResult.Count() <= 0) throw new SystemException("物料【" + item + "】資料錯誤!!");

                            foreach (var item2 in MrDetailResult)
                            {
                                #region //本身為替代料
                                if (item2.MtlItemId != item2.SubstitutionId)
                                {
                                    if (mtlItemIdList.IndexOf(item2.SubstitutionId) == -1)
                                    {
                                        throw new SystemException("物料【" + item + "】尚未註冊在載盤!!");
                                    }
                                }
                                #region //本身為原BOM
                                else
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MtlItemId 
                                            FROM MES.MrDetail a 
                                            WHERE a.SubstitutionId = @MtlItemId 
                                            AND a.MtlItemId != a.SubstitutionId";
                                    dynamicParameters.Add("MtlItemId", item);

                                    var SubResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (SubResult.Count() <= 0) throw new SystemException("物料【" + item + "】尚未註冊在載盤!!");

                                    bool checkFlag = false;
                                    foreach (var item3 in SubResult)
                                    {
                                        if (mtlItemIdList.IndexOf(item3.MtlItemId) != -1)
                                        {
                                            checkFlag = true;
                                            break;
                                        }
                                    }

                                    if (!checkFlag) throw new SystemException("物料【" + item + "】尚未註冊在載盤!!");
                                }
                                #endregion
                                #endregion
                            }
                        }
                        #endregion

                        #region //確認物料載盤上料資訊後進行MAPPING
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeNo, a.LotNumberId
                                , d.MtlItemNo
                                , e.BarcodeId ComponentBarcodeId
                                , g.BindType
                                FROM MES.VehicleDetail a 
                                INNER JOIN MES.Vehicle b ON a.VehicleId = b.VehicleId
                                INNER JOIN SCM.LotNumber c ON a.LotNumberId = c.LotNumberId
                                INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                LEFT JOIN MES.Barcode e ON a.BarcodeNo = e.BarcodeNo
                                INNER JOIN MES.MoProcess f ON a.MoProcessId = f.MoProcessId
                                INNER JOIN MES.MoMtlSetting g ON f.MoId = g.MoId
                                INNER JOIN MES.WoDetail h ON g.WoDetailId = h.WoDetailId AND h.MtlItemId = c.MtlItemId
                                WHERE b.VehicleNo = @VehicleNo
                                AND a.MoProcessId = @MoProcessId
                                AND a.ExpirationDate IS NULL
                                AND a.[Status] = 'A'";
                        dynamicParameters.Add("VehicleNo", VehicleNo);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var VehicleDetailResult = sqlConnection.Query(sql, dynamicParameters);

                        if (VehicleDetailResult.Count() <= 0) throw new SystemException("物料載盤上料資訊錯誤!!");

                        foreach (var item in VehicleDetailResult)
                        {
                            if (item.BindType == "B")
                            {
                                #region //確認物料條碼有無被其他上料流程註冊
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM MES.BarcodeComponent a 
                                        INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                        WHERE b.BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", item.BarcodeNo);

                                var BarcodeComponentCheckResult = sqlConnection.Query(sql, dynamicParameters);

                                if (BarcodeComponentCheckResult.Count() > 0) throw new SystemException("物料【" + item.MtlItemNo + "】條碼【" + item.BarcodeNo + "】已被其他上料流程註冊!!");
                                #endregion
                            }
                            else
                            {
                                #region //確認批號是否已被相同主件綁定
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.LotNumberNo
                                        FROM MES.BarcodeComponent a 
                                        INNER JOIN SCM.LotNumber b ON a.LotNumberId = b.LotNumberId
                                        WHERE a.AssemblyBarcodeId = @AssemblyBarcodeId
                                        AND a.LotNumberId = @LotNumberId";
                                dynamicParameters.Add("AssemblyBarcodeId", AssemblyBarcodeId);
                                dynamicParameters.Add("LotNumberId", item.LotNumberId);

                                var BarcodeComponentLotResult = sqlConnection.Query(sql, dynamicParameters);

                                foreach (var item2 in BarcodeComponentLotResult)
                                {
                                    throw new SystemException("批號【" + item2.LotNumberNo + "】已被相同主件註冊!!");
                                }
                                #endregion
                            }

                            #region //MAPPING
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeComponent (AssemblyBarcodeId, ComponentBarcodeId, LotNumberId, MoProcessId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeComponentId
                                    VALUES (@AssemblyBarcodeId, @ComponentBarcodeId, @LotNumberId, @MoProcessId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    AssemblyBarcodeId,
                                    item.ComponentBarcodeId,
                                    item.LotNumberId,
                                    MoProcessId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        #endregion

                        #region //解除物料載盤綁定
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.VehicleDetail SET
                                ExpirationDate = GETDATE(),
                                [Status] = 'S',
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE VehicleId = @VehicleId
                                AND MoProcessId = @MoProcessId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LastModifiedDate,
                                LastModifiedBy,
                                VehicleId,
                                MoProcessId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //Update MoProcessQty
        public void UpdateMoQtyInformation(int MoId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;

                        #region //更新MoProcess PassQty,NgQty,ScrapQty,InputQty
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcess
                                   SET TotalPassQty = y.PassQty,
                                       TotalNgQty = y.NgQty,
	                                   TotalScrapQty = y.ScrapQty,
	                                   TotalInputQty = y.InputQty
                                  FROM MES.MoProcess x,
	                                   (SELECT t.MoProcessId,
			                                   t.ProcessAlias,
			                                   SUM(t.PassQty) PassQty,
			                                   SUM(t.NgQty) NgQty,
			                                   SUM(t.ScrapQty) ScrapQty,
			                                   SUM(t.PassQty) + SUM(t.NgQty) + SUM(t.ScrapQty) InputQty
		                                  FROM (
				                                SELECT a.MoProcessId,a.ProcessAlias,
					                                   CASE WHEN b.ProdStatus = 'P' THEN SUM(b.StationQty) ELSE 0 END PassQty,
					                                   CASE WHEN b.ProdStatus = 'F' THEN SUM(b.StationQty) ELSE 0 END NgQty,
					                                   CASE WHEN b.ProdStatus = 'S' THEN SUM(b.StationQty) ELSE 0 END ScrapQty
				                                  FROM MES.MoProcess a
					                                   INNER JOIN MES.BarcodeProcess b ON a.MoProcessId = b.MoProcessId
                                                        INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId AND c.ParentBarcode IS NULL
				                                 GROUP BY a.MoProcessId,a.ProcessAlias,b.ProdStatus) t
		                                 GROUP BY t.MoProcessId,t.ProcessAlias) y
                                 WHERE x.MoProcessId  = y.MoProcessId
                                   AND x.MoId = @MoId";
                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            MoId
                        });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        #endregion

                        #region //找出所有MoProcess依順序更新WipQty
                        //目前無法有邏輯推算每站在製數量, 等確定邏輯再補
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcess
                                   SET WipQty = ISNULL(b.WipQty,0)
                                  FROM MES.MoProcess a
                                       LEFT JOIN (SELECT x.CurrentMoProcessId,SUM(x.BarcodeQty) WipQty
	                                                FROM MES.Barcode x
				                                   WHERE x.BarcodeStatus = 1
				                                     AND EXISTS(SELECT 1
					                                              FROM MES.BarcodeProcess z
								                                 WHERE x.BarcodeId = z.BarcodeId
								                                   AND z.MoId = x.MoId)
				                                   GROUP BY x.CurrentMoProcessId) b ON a.MoProcessId = b.CurrentMoProcessId
                                 WHERE a.MoId = @MoId";
                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            MoId
                        });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新Mo Scrap Quantity
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.ManufactureOrder
                                   SET ScrapQty = y.ScrapQty
                                  FROM MES.ManufactureOrder x,
                                       (SELECT a.MoId,ISNULL(SUM(b.TotalScrapQty),0) ScrapQty
                                          FROM MES.ManufactureOrder a
                                               INNER JOIN MES.MoProcess b ON a.MoId = b.MoId
	                                     GROUP BY a.MoId) y
                                 WHERE x.MoId = y.MoId
                                   AND x.MoId = @MoId";
                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            MoId
                        });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
        }
        #endregion 

        #region //Change BarcodeProcess Status & Update MoProcess Total Quantity (準備廢除)
        public void UpdateBarcodeProcessStatus(string TxType, int BarcodeProcessId, string ProdStatus)
        {
            if (ProdStatus == "") throw new Exception("ProdStatus 不可為空");
            if (BarcodeProcessId == -1) throw new Exception("BarcodeProcessId 不可為空");
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;

                        #region default
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        int PassQty = 0;
                        int NgQty = 0;
                        int ScrapQty = 0;
                        int PreMoProcessId = -1;
                        #endregion

                        #region //找出BarcodeProcess資訊

                        sql = @"SELECT MoProcessId,StationQty,ProdStatus,BarcodeId
                                  FROM MES.BarcodeProcess 
                                 WHERE BarcodeProcessId = @BarcodePRocessId";

                        dynamicParameters.Add("BarcodePRocessId", BarcodeProcessId);
                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BarcodeProcessResult.Count() > 0)
                        {
                            foreach (var item in BarcodeProcessResult)
                            {
                                int MoProcessId = Convert.ToInt32(item.MoProcessId);
                                int StationQty = Convert.ToInt32(item.StationQty);
                                string OrigProdStatus = item.ProdStatus.ToString();
                                int BarcodeId = Convert.ToInt32(item.BarcodeId);
                                int TransferQty = 0;

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT y.MoProcessId
                                          FROM MES.Barcode x
                                               INNER JOIN MES.BarcodeProcess y ON x.BarcodeId = y.BarcodeId
                                         WHERE x.BarcodeId = @BarcodeId
                                           AND y.StartDate = (SELECT MAX(z.StartDate)
                                                                FROM MES.BarcodeProcess z
					                                           WHERE z.BarcodeId = x.BarcodeId
					                                             AND z.BarcodeProcessId != @BarcodeProcessId)";
                                dynamicParameters.Add("BarcodeId", BarcodeId);
                                dynamicParameters.Add("BarcodePRocessId", BarcodeProcessId);
                                var PreMoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                if (PreMoProcessResult.Count() > 0)
                                {
                                    PreMoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoProcessId);
                                }

                                if (ProdStatus.Equals("S"))
                                {
                                    ScrapQty = StationQty;
                                    PassQty = 0;
                                    NgQty = 0;
                                }
                                else if (ProdStatus.Equals("F"))
                                {
                                    ScrapQty = 0;
                                    PassQty = 0;
                                    NgQty = StationQty;
                                }
                                else if (ProdStatus.Equals("P"))
                                {
                                    ScrapQty = 0;
                                    PassQty = StationQty;
                                    NgQty = 0;
                                }
                                else
                                {
                                    throw new SystemException("條碼狀態錯誤!");
                                }

                                switch (TxType)
                                {
                                    case "A": //過站時需Update MoProcess , 加上新狀態數量
                                        #region //取出這條碼有沒有NG或報廢數量
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT SUM(TransactionQty) TransactionQty
                                                  FROM MES.BarcodeTransfer a
                                                 WHERE a.FromBarcodeId = @BarcodeId
                                                   AND EXISTS(SELECT 1
                                                                FROM MES.BarcodeProcess b
			                                                   WHERE a.ToBarcodeId = b.BarcodeId
			                                                     AND b.MoProcessId = @MoProcessId)";
                                        dynamicParameters.Add("BarcodeId", BarcodeId);
                                        dynamicParameters.Add("MoProcessId", MoProcessId);
                                        var BarcodeNgQtyResult = sqlConnection.Query(sql, dynamicParameters);
                                        if (BarcodeNgQtyResult.Count() > 0)
                                        {
                                            TransferQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TransactionQty);
                                        }
                                        #endregion

                                        #region //更新MoProcess Quantity Informations
                                        sql = @"UPDATE MES.MoProcess 
                                                   SET TotalInputQty = TotalInputQty + @StationQty,
                                                       TotalPassQty = TotalPassQty + @PassQty + @TransferQty,
                                                       TotalNgQty = TotalNgQty + @NgQty,
                                                       TotalScrapQty = TotalScrapQty + @ScrapQty
                                                 WHERE MoProcessId = @MoProcessId";
                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            StationQty,
                                            PassQty,
                                            TransferQty,
                                            NgQty,
                                            ScrapQty,
                                            MoProcessId
                                        });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //更新WipQty
                                        if (!PreMoProcessId.Equals(MoProcessId))
                                        {
                                            sql = @"UPDATE MES.MoProcess 
                                                   SET WipQty = WipQty - @StationQty - @TransferQty
                                                 WHERE MoProcessId = @PreMoProcessId";
                                            dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                StationQty,
                                                TransferQty,
                                                PreMoProcessId
                                            });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                            sql = @"UPDATE MES.MoProcess 
                                                   SET WipQty = WipQty + @StationQty + @TransferQty
                                                 WHERE MoProcessId = @MoProcessId";
                                            dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                StationQty,
                                                TransferQty,
                                                MoProcessId
                                            });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        }
                                        #endregion
                                        break;
                                    case "U": //過站時Update MoProcess , 扣掉原本狀態數量, 加上新狀態數量
                                        #region //更新BarcodeProcess ProdStatus
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.BarcodeProcess 
                                                   SET ProdStatus = @ProdStatus
                                                 WHERE BarcodeProcessId = @BarcodeProcessId";
                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            ProdStatus,
                                            BarcodeProcessId
                                        });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion

                                        #region //更新MoProcess Quantity Informations
                                        if (!OrigProdStatus.Equals(ProdStatus))
                                        {
                                            sql = "UPDATE MES.MoProcess ";
                                            #region //判斷原始BarcodeProcess.ProdStatus & New ProdStatus
                                            if (OrigProdStatus.Equals("P") && ProdStatus.Equals("F"))
                                            {
                                                //扣掉PassQty, 增加NgQty
                                                sql += "SET TotalPassQty = TotalPassQty - @StationQty,";
                                                sql += " TotalNgQty = TotalNgQty + @StationQty ";
                                            }
                                            else if (OrigProdStatus.Equals("P") && ProdStatus.Equals("S"))
                                            {
                                                //扣掉PassQty, 增加ScrapQty
                                                sql += "SET TotalPassQty = TotalPassQty - @StationQty,";
                                                sql += " TotalScrapQty = TotalScrapQty + @StationQty ";
                                            }
                                            else if (OrigProdStatus.Equals("F") && ProdStatus.Equals("P"))
                                            {
                                                //扣掉NgQty, 增加PassQty
                                                sql += "SET TotalNgQty = TotalNgQty - @StationQty,";
                                                sql += " TotalPassQty = TotalPassQty + @StationQty ";
                                            }
                                            else if (OrigProdStatus.Equals("F") && ProdStatus.Equals("S"))
                                            {
                                                //扣掉NgQty, 增加ScripQty
                                                sql += "SET TotalNgQty = TotalNgQty - @StationQty,";
                                                sql += " TotalScrapQty = TotalScrapQty + @StationQty ";
                                            }
                                            else if (OrigProdStatus.Equals("S") && ProdStatus.Equals("F"))
                                            {
                                                //扣掉ScripQty, 增加NgQty
                                                sql += "SET TotalScrapQty = TotalScrapQty - @StationQty,";
                                                sql += " TotalNgQty = TotalNgQty + @StationQty ";
                                            }
                                            else if (OrigProdStatus.Equals("S") && ProdStatus.Equals("P"))
                                            {
                                                //扣掉ScripQty, 增加PassQty
                                                sql += "SET TotalScrapQty = TotalScrapQty - @StationQty,";
                                                sql += " TotalPassQty = TotalPassQty + @StationQty ";
                                            }
                                            else
                                            {
                                                throw new SystemException("UpdateBarcodeProcessStatus非預期錯誤");
                                            }
                                            #endregion
                                            sql += " WHERE MoProcessId = @MoProcessId ";
                                            dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                StationQty,
                                                MoProcessId
                                            });
                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                        }
                                        #endregion
                                        break;
                                    case "D": //過站時Update MoProcess , 扣掉原本狀態數量
                                        #region //更新MoProcess Quantity Informations
                                        if (OrigProdStatus.Equals("P"))
                                        {
                                            //扣掉PassQty
                                        }
                                        else if (OrigProdStatus.Equals("F"))
                                        {
                                            //扣掉NgQty
                                        }
                                        else if (OrigProdStatus.Equals("S"))
                                        {
                                            //扣掉ScrapQty
                                        }
                                        #endregion
                                        break;
                                    default: throw new SystemException("TxType 未定義");
                                }

                            }
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

        }

        #endregion

        #region 
        public void UpdateMoProcessTransaction(int MoId)
        {
            #region default
            int rowsAffected = 0;
            DynamicParameters dynamicParameters = new DynamicParameters();
            #endregion

            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //先批次更新整個MoProcess Quantity資訊(WipQty除外)
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MoProcess
                                   SET TotalInputQty = ISNULL(y1.InputQty,0),
                                       TotalPassQty = ISNULL(y1.PassQty,0),
	                                   TotalNgQty = ISNULL(y1.NgQty,0),
	                                   TotalScrapQty = ISNULL(y1.ScrapQty,0),
	                                   ReturnQty = ISNULL(y1.ReturnQty,0)
                                  FROM MES.MoProcess x1,
                                       (SELECT x.MoProcessId,x.SortNumber,x.ProcessAlias,
			                                   x.InputQty,
			                                   x.PassQty,
			                                   x.NgQty,
			                                   x.ScrapQty,
			                                   ISNULL(y.Quantity,0) ReturnQty
		                                  FROM (SELECT a.MoId,a.MoProcessId,a.SortNumber,a.ProcessAlias,
					                                   SUM(b.Quantity) InputQty,
					                                   SUM(CASE WHEN b.ProdStatus  = 'P' THEN b.Quantity ELSE 0 END) PassQty,
					                                   SUM(CASE WHEN b.ProdStatus  = 'F' THEN b.Quantity ELSE 0 END) NgQty,
					                                   SUM(CASE WHEN b.ProdStatus  = 'S' THEN b.Quantity ELSE 0 END) ScrapQty
				                                  FROM MES.MoProcess a
					                                   LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
				                                 GROUP BY a.MoId,a.MoProcessId,a.SortNumber,a.ProcessAlias) x
				                                LEFT JOIN MES.MoProcessTransaction y ON x.MoProcessId = y.NextMoProcessId) y1
                                 WHERE x1.MoId = @MoId
                                   AND x1.MoProcessId = y1.MoProcessId";
                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            MoId
                        });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //找出所有MoProcess依順序更新WipQty
                        //目前無法有邏輯推算每站在製數量, 等確定邏輯再補
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT SortNumber,MoProcessId,NecessityStatus
                                  FROM MES.MoProcess
                                 WHERE MoId = @MoId
                                 ORDER BY SortNumber";
                        dynamicParameters.Add("MoId", MoId);
                        var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in MoProcessResult)
                        {
                            int MoProcessId = Convert.ToInt32(item.MoProcessId);
                            int SortNumber = Convert.ToInt32(item.SortNumber);
                            int CurrentQty = 0;
                            int NextQty = 0;
                            int NextSortNumber = 0;
                            string NecessityStatus = item.NecessityStatus;

                            #region //找出當站投入可流往下站數量, 報廢就不會向下流, 只流良品
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(SUM(a.Quantity),0) CurrentQty
                                      FROM MES.MoProcessTransaction a
                                           INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                     WHERE a.MoId = @MoId
                                       AND b.SortNumber = @SortNumber
                                       AND a.ProdStatus != 'S'";

                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("SortNumber", SortNumber);
                            var CurrentQtyResult = sqlConnection.Query(sql, dynamicParameters);
                            if (CurrentQtyResult.Count() > 0)
                            {
                                CurrentQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentQty);
                            }
                            #endregion

                            #region //找出下站必要過站的SortNumber
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT SortNumber
                                      FROM MES.MoProcess
                                     WHERE MoId = @MoId
                                       AND SortNumber > @SortNumber
                                       AND NecessityStatus = 'Y'
									   Order By SortNumber";

                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("SortNumber", SortNumber);
                            var NextSortResult = sqlConnection.Query(sql, dynamicParameters);
                            if (NextSortResult.Count() > 0)
                            {
                                NextSortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);
                            }
                            #endregion

                            #region //找出下站投入數量, 不含NG品
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(SUM(a.Quantity),0) NextQty
                                      FROM MES.MoProcessTransaction a
                                           INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                     WHERE a.MoId = @MoId
                                       AND b.NecessityStatus = 'Y'
                                       AND b.SortNumber > @SortNumber 
                                       AND b.SortNumber <= @NextSortNumber";

                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("SortNumber", SortNumber);
                            dynamicParameters.Add("NextSortNumber", NextSortNumber);

                            var NextQtyResult = sqlConnection.Query(sql, dynamicParameters);
                            if (NextQtyResult.Count() > 0)
                            {
                                NextQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NextQty);
                            }
                            #endregion

                            if (NecessityStatus.Equals("N"))
                            {
                                CurrentQty = 0;
                                NextQty = 0;
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"Update MES.MoProcess
                                       SET WipQty = @CurrentQty - @NextQty
                                     WHERE MoProcessId = @MoProcessId";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                CurrentQty,
                                NextQty,
                                MoProcessId
                            });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                            #region //找出每站未生產數
                            string AlreadyString = GetProcessQty(MoProcessId);
                            int AlreadyQty = 0;

                            var AlreadyResult = JObject.Parse(AlreadyString);
                            foreach (var item1 in AlreadyResult)
                            {
                                if (item1.Key == "data")
                                {
                                    var ProcessQtyResult = JToken.Parse(item1.Value.ToString());

                                    AlreadyQty = Convert.ToInt32(ProcessQtyResult[0]["ProcessQty"]);

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.MoProcess
                                               SET AlreadyQty = @AlreadyQty
                                             WHERE MoProcessId = @MoProcessId";
                                    dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AlreadyQty,
                                        MoProcessId
                                    });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                }
                            }
                            #endregion

                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
        }
        #endregion

        #region //UpdatePackageBarcodeProductQty --更新包裝條碼數量 GPai 20230419
        public string UpdatePackageBarcodeProductQty(int PackageBarcodeId)
        {
            try
            {

                int ProductQty = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //取得該包裝產品總數 
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL (SUM(c.BarcodeQty), 0) BarcodeQtySum
                            FROM MES.PackageBarcodeReference a
                            INNER JOIN MES.PackageBarcode b ON b.PackageBarcodeId = a.PackageBarcodeId
                            INNER JOIN MES.Barcode c ON c.BarcodeId = a.BarcodeId
							WHERE b.PackageBarcodeId = @PackageBarcodeId";
                        dynamicParameters.Add("PackageBarcodeId", PackageBarcodeId);
                        var result0 = sqlConnection.Query(sql, dynamicParameters);
                        ProductQty = result0.First().BarcodeQtySum;
                        #endregion         

                        #region //更新包裝產品條碼數
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.PackageBarcode
							SET Quantity = @Quantity
							WHERE PackageBarcodeId = @PackageBarcodeId";

                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            Quantity = ProductQty,
                            PackageBarcodeId
                        });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateEndCoutTime --更新該事件完成時間 20230803
        public string UpdateEndCoutTime(int EventId, string Finish, string CountType)
        {
            try
            {

                DateTime finishTime = Convert.ToDateTime(Finish);
                var operationTime = 0.0;

                using (TransactionScope transactionScope = new TransactionScope())
                {


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region // 確認事件資料
                        switch (CountType)
                        {
                            case "manTime":
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT * 
                                FROM MES.UserEvent
                                WHERE UserEventId = @UserEventId";
                                dynamicParameters.Add("UserEventId", EventId);
                                break;
                            case "machineTime":
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT * 
                                    FROM MES.MachineEvent
                                    WHERE MachineEventId = @MachineEventId";
                                dynamicParameters.Add("MachineEventId", EventId);
                                break;
                            case "before":
                            case "after":
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT * 
                                    FROM MES.BarcodeProcessEvent
                                    WHERE BarcodeEventId = @BarcodeEventId";
                                dynamicParameters.Add("BarcodeEventId", EventId);
                                break;

                        }
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("查無事件資料!");
                        DateTime startTime = Convert.ToDateTime(result.First().StartDate);
                        TimeSpan ts = finishTime - startTime;
                        operationTime = ts.TotalSeconds;
                        #endregion

                        #region //更新
                        switch (CountType)
                        {
                            case "manTime":
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.UserEvent
							            SET
                                        FinishDate = @FinishDate,
                                        OperationTime = @OperationTime
							            WHERE UserEventId = @UserEventId";

                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    FinishDate = Finish,
                                    OperationTime = operationTime,
                                    UserEventId= EventId
                                });
                                break;
                            case "machineTime":
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MachineEvent
							            SET
                                        FinishDate = @FinishDate,
                                        OperationTime = @OperationTime
							            WHERE MachineEventId = @MachineEventId";

                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    FinishDate = Finish,
                                    OperationTime = operationTime,
                                    MachineEventId = EventId
                                });
                                break;
                            case "before":
                            case "after":
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.BarcodeProcessEvent
							            SET 
                                        FinishDate = @FinishDate,
                                        CycleTime = @CycleTime
							            WHERE BarcodeEventId = @BarcodeEventId";

                                dynamicParameters.AddDynamicParams(
                                new
                                {
                                    FinishDate = Finish,
                                    CycleTime = operationTime,
                                    BarcodeEventId = EventId
                                });
                                break;

                        }


                        #endregion

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//UpdateTempMtfQcMeasureData 解析暫存的MTF數據 -- Luca 2024-09-09
        public string UpdateTempMtfQcMeasureData(string Company,string RunStatus)
        {
            try
            {
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int BarcodeId=-1,BarcodeProcessId = -1, MachineId = -1,MoId=-1, ModeId=-1, MoProcessId=-1, UserId=-1,QcTypeId = -1;
                        string StartDate="" , FinishDate = "";

                        #region//查詢MTF未執行的暫存資料
                        DateTime Update = DateTime.Now.AddHours(-1);
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.*
                        FROM MES.MtfProcessTemp a                       
                        WHERE a.RunStatus = @RunStatus AND a.LastModifiedDate > = @Update";
                        dynamicParameters.Add("RunStatus", RunStatus);
                        dynamicParameters.Add("Update", Update);
                        var MtfProcessTempResult = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var TempItem in MtfProcessTempResult)
                        {
                            BarcodeProcessId = Convert.ToInt32(TempItem.BarcodeProcessId);
                            MachineId = Convert.ToInt32(TempItem.MachineId);
                            StartDate = TempItem.StartDate != null ? Convert.ToDateTime(TempItem.StartDate).ToString("yyyy-MM-dd HH:mm:ss") : "";
                            FinishDate = TempItem.FinishDate != null ? Convert.ToDateTime(TempItem.FinishDate).ToString("yyyy-MM-dd HH:mm:ss") : "";
                            UserId = Convert.ToInt32(TempItem.CreateBy);

                            #region//綁定MTF機台量測數據

                            //取得 IOTtableName
                            string IOTtableName = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MachineNo,a.IOTtableName
                                FROM MES.Machine a
                                WHERE a.IOTtableName IS NOT NULL AND a.MachineId = @MachineId";
                            dynamicParameters.Add("MachineId", MachineId);
                            var IOTMachineResult = sqlConnection.Query(sql, dynamicParameters);
                            if (IOTMachineResult.Count() > 0)
                            {
                                foreach (var item in IOTMachineResult)
                                {
                                    IOTtableName = item.IOTtableName;
                                }

                                #region//取得製令資訊                          
                                dynamicParameters = new DynamicParameters();
                                string sql = @"SELECT a.MoId, a.BarcodeId, a.BarcodeProcessId,a.MoProcessId,c.ModeId
                                                FROM MES.BarcodeProcess a
                                                INNER JOIN MES.MoProcess b ON a.MoProcessId=b.MoProcessId
                                                INNER JOIN MES.ManufactureOrder c ON b.MoId=c.MoId
                                                WHERE a.BarcodeProcessId = @BarcodeProcessId";
                                dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);
                                var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                if (BarcodeProcessResult.Count() == 0)
                                {
                                    throw new SystemException("【MES】查無製令資訊!");
                                }
                                else {
                                    foreach (var item in BarcodeProcessResult)
                                    {
                                        MoId = Convert.ToInt32(item.MoId);
                                        BarcodeId = Convert.ToInt32(item.BarcodeId);
                                        BarcodeProcessId = Convert.ToInt32(item.BarcodeProcessId);
                                        ModeId = Convert.ToInt32(item.ModeId);
                                        MoProcessId = Convert.ToInt32(item.MoProcessId);
                                    }
                                }
                                #endregion

                                #region //取得QcType
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT QcTypeId 
	                                        FROM QMS.QcType
                                            WHERE QcTypeNo='MTFQC' AND ModeId = @ModeId";
                                dynamicParameters.Add("ModeId", ModeId);
                                var QcTypeResult = sqlConnection.Query(sql, dynamicParameters);
                                
                                foreach (var item in QcTypeResult)
                                {
                                    QcTypeId = item.QcTypeId;
                                }
                                #endregion

                                #region //取得預設SpreadsheetData
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 a.DefaultSpreadsheetData
                                    FROM MES.QcRecord a";
                                var DefaultFileIdResult = sqlConnection.Query(sql, dynamicParameters);
                                string DefaultSpreadsheetData = "";
                                foreach (var item in DefaultFileIdResult)
                                {
                                    DefaultSpreadsheetData = item.DefaultSpreadsheetData;
                                }
                                #endregion

                                #region //確認機台資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                    FROM MES.Machine a 
                                    WHERE a.MachineId = @MachineId";
                                dynamicParameters.Add("MachineId", MachineId);
                                var MachineResult = sqlConnection.Query(sql, dynamicParameters);
                                if (MachineResult.Count() <= 0) throw new SystemException("【MES】機台資料錯誤!!");
                                #endregion

                                #region //取得量測機台id、QmmDetailId
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.QmmDetailId, a.MachineNumber, b.MachineName, b.MachineNo
                                        FROM  QMS.QmmDetail a
                                        INNER JOIN MES.Machine b on a.MachineId = b.MachineId
                                        WHERE b.MachineId = @MachineId";
                                dynamicParameters.Add("MachineId", MachineId);
                                var QmmResult = sqlConnection.Query(sql, dynamicParameters);
                                if (QmmResult.Count() <= 0) throw new Exception("【MES】查無量測機台資訊");
                                int QmmDetailId = -1;
                                string MachineNumber = "";
                                foreach (var item in QmmResult)
                                {
                                    QmmDetailId = item.QmmDetailId;
                                    MachineNumber = item.MachineNumber;
                                }
                                #endregion

                                #region //INSERT MES.QcRecord
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.QcRecord (QcNoticeId, QcTypeId, InputType, MoId, MoProcessId,BarcodeId,BarcodeProcessId, Remark, DefaultFileId, CurrentFileId, DefaultSpreadsheetData, CheckQcMeasureData, SupportAqFlag, SupportProcessFlag, ResolveFileJson
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.QcRecordId
                                            VALUES (null, @QcTypeId, 'Cavity', @MoId, @MoProcessId,@BarcodeId, @BarcodeProcessId, null, null, null, @DefaultSpreadsheetData, 'P', 'Y', 'N', '{""resolveFileInfo"":[]}'
                                            , @CreateDate, @LastModifiedDate, @UserId, @LastModifiedBy)";
                                dynamicParameters.Add("QcTypeId", QcTypeId);
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                dynamicParameters.Add("BarcodeId", BarcodeId);
                                dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);
                                dynamicParameters.Add("DefaultSpreadsheetData", DefaultSpreadsheetData);
                                dynamicParameters.Add("CreateDate", CreateDate);
                                dynamicParameters.Add("LastModifiedDate", LastModifiedDate);
                                dynamicParameters.Add("UserId", UserId);
                                dynamicParameters.Add("LastModifiedBy", UserId);
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);
                                int qcRecordId = -1;
                                foreach (var item in insertResult)
                                {
                                    qcRecordId = item.QcRecordId;
                                }
                                #endregion

                                using (SqlConnection sqlConnection2 = new SqlConnection(AutomationConnectionStrings))
                                {
                                    //測試
                                    //StartDate = "2024-09-12 21:42:42.720";
                                    //FinishDate = "2024-09-12 23:59:16.160";

                                    // 一次性查詢所有 QcItem 資料，避免多次查詢
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT DISTINCT c.QcItemId,c.QcItemName
                                        FROM QMS.QcGroup a
                                        INNER JOIN QMS.QcClass b ON a.QcGroupId=b.QcGroupId
                                        INNER JOIN QMS.QcItem c ON b.QcClassId=c.QcClassId
                                        INNER JOIN BAS.Company d ON a.CompanyId=d.CompanyId
                                        WHERE c.QcType='IPQC' AND d.CompanyNo=@Company  AND b.QcClassId = 65";
                                    dynamicParameters.Add("Company", Company);
                                    var qcItemList = sqlConnection.Query<QcItemModel>(sql, dynamicParameters).ToList();
                                    // 使用 Dictionary 快取 QcItem 資料
                                    var qcItemDictionary = qcItemList.ToDictionary(item => item.QcItemName, item => item);

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT 
                                        Location_X,
                                        Location_Y,
                                        Class,
                                        CheckFreq,
                                        FBL,
                                        DOF_Index,
                                        DOF_minus,
                                        DOF_plus,
                                        DOF_T,
                                        GDOF_Index,
                                        GDOF_minus,
                                        GDOF_plus,
                                        GDOF_T,
                                        EFL,
                                        W_1S,
                                        W_1T,
                                        W_2S,
                                        W_2T,
                                        W_3S,
                                        W_3T,
                                        W_4S,
                                        W_4T,
                                        W_5S,
                                        W_5T,
                                        W_6S,
                                        W_6T,
                                        W_7S,
                                        W_7T,
                                        W_8S,
                                        W_8T,
                                        W_9S,
                                        W_9T,
                                        W_10S,
                                        W_10T,
                                        W_11S,
                                        W_11T,
                                        W_12S,
                                        W_12T,
                                        W_13S,
                                        W_13T,
                                        W_14S,
                                        W_14T,
                                        W_15S,
                                        W_15T,
                                        W_16S,
                                        W_16T,
                                        W_17S,
                                        W_17T,
                                        W1S_Peak,
                                        W1T_Peak,
                                        W2S_Peak,
                                        W2T_Peak,
                                        W3S_Peak,
                                        W3T_Peak,
                                        W4S_Peak,
                                        W4T_Peak,
                                        W5S_Peak,
                                        W5T_Peak,
                                        W6S_Peak,
                                        W6T_Peak,
                                        W7S_Peak,
                                        W7T_Peak,
                                        W8S_Peak,
                                        W8T_Peak,
                                        W9S_Peak,
                                        W9T_Peak,
                                        W10S_Peak,
                                        W10T_Peak,
                                        W11S_Peak,
                                        W11T_Peak,
                                        W12S_Peak,
                                        W12T_Peak,
                                        W13S_Peak,
                                        W13T_Peak,
                                        W14S_Peak,
                                        W14T_Peak,
                                        W15S_Peak,
                                        W15T_Peak,
                                        W16S_Peak,
                                        W16T_Peak,
                                        W17S_Peak,
                                        W17T_Peak,
                                        MTF_DateTime,RecordTime,MeasurementSN";
                                    sql += " FROM dbo." + IOTtableName;
                                    sql += @" WHERE 1=1                                    
                                    AND MTF_DateTime BETWEEN @StartDate AND @FinishDate  ORDER BY RecordTime ";
                                    dynamicParameters.Add("StartDate", StartDate);
                                    dynamicParameters.Add("FinishDate", FinishDate);
                                    var AutomationResult = sqlConnection2.Query<MtfmeasureValues>(sql, dynamicParameters).ToList();
                                    if (AutomationResult.Count() > 0)
                                    {
                                        List<QcMeasureDataModel> qcMeasureDataList = new List<QcMeasureDataModel>();
                                        foreach (var DataRow in AutomationResult)
                                        {
                                            List<string> measureValues = new List<string>() {
                                            DataRow.Location_X,
                                            DataRow.Location_Y,
                                            DataRow.Class,
                                            DataRow.CheckFreq,
                                            DataRow.FBL,
                                            DataRow.DOF_Index,
                                            DataRow.DOF_minus,
                                            DataRow.DOF_plus,
                                            DataRow.DOF_T,
                                            DataRow.GDOF_Index,
                                            DataRow.GDOF_minus,
                                            DataRow.GDOF_plus,
                                            DataRow.GDOF_T,
                                            DataRow.EFL,
                                            DataRow.W_1S,
                                            DataRow.W_1T,
                                            DataRow.W_2S,
                                            DataRow.W_2T,
                                            DataRow.W_3S,
                                            DataRow.W_3T,
                                            DataRow.W_4S,
                                            DataRow.W_4T,
                                            DataRow.W_5S,
                                            DataRow.W_5T,
                                            DataRow.W_6S,
                                            DataRow.W_6T,
                                            DataRow.W_7S,
                                            DataRow.W_7T,
                                            DataRow.W_8S,
                                            DataRow.W_8T,
                                            DataRow.W_9S,
                                            DataRow.W_9T,
                                            DataRow.W_10S,
                                            DataRow.W_10T,
                                            DataRow.W_11S,
                                            DataRow.W_11T,
                                            DataRow.W_12S,
                                            DataRow.W_12T,
                                            DataRow.W_13S,
                                            DataRow.W_13T,
                                            DataRow.W_14S,
                                            DataRow.W_14T,
                                            DataRow.W_15S,
                                            DataRow.W_15T,
                                            DataRow.W_16S,
                                            DataRow.W_16T,
                                            DataRow.W_17S,
                                            DataRow.W_17T,
                                            DataRow.W1S_Peak,
                                            DataRow.W1T_Peak,
                                            DataRow.W2S_Peak,
                                            DataRow.W2T_Peak,
                                            DataRow.W3S_Peak,
                                            DataRow.W3T_Peak,
                                            DataRow.W4S_Peak,
                                            DataRow.W4T_Peak,
                                            DataRow.W5S_Peak,
                                            DataRow.W5T_Peak,
                                            DataRow.W6S_Peak,
                                            DataRow.W6T_Peak,
                                            DataRow.W7S_Peak,
                                            DataRow.W7T_Peak,
                                            DataRow.W8S_Peak,
                                            DataRow.W8T_Peak,
                                            DataRow.W9S_Peak,
                                            DataRow.W9T_Peak,
                                            DataRow.W10S_Peak,
                                            DataRow.W10T_Peak,
                                            DataRow.W11S_Peak,
                                            DataRow.W11T_Peak,
                                            DataRow.W12S_Peak,
                                            DataRow.W12T_Peak,
                                            DataRow.W13S_Peak,
                                            DataRow.W13T_Peak,
                                            DataRow.W14S_Peak,
                                            DataRow.W14T_Peak,
                                            DataRow.W15S_Peak,
                                            DataRow.W15T_Peak,
                                            DataRow.W16S_Peak,
                                            DataRow.W16T_Peak,
                                            DataRow.W17S_Peak,
                                            DataRow.W17T_Peak,
                                            DataRow.MTF_DateTime,
                                            DataRow.RecordTime,
                                            DataRow.MeasurementSN
                                        };
                                            List<string> columnNames = new List<string> {
                                            "Location_X",
                                            "Location_Y",
                                            "Class",
                                            "CheckFreq",
                                            "FBL",
                                            "DOF_Index",
                                            "DOF_minus",
                                            "DOF_plus",
                                            "DOF_T",
                                            "GDOF_Index",
                                            "GDOF_minus",
                                            "GDOF_plus",
                                            "GDOF_T",
                                            "EFL",
                                            "W_1S",
                                            "W_1T",
                                            "W_2S",
                                            "W_2T",
                                            "W_3S",
                                            "W_3T",
                                            "W_4S",
                                            "W_4T",
                                            "W_5S",
                                            "W_5T",
                                            "W_6S",
                                            "W_6T",
                                            "W_7S",
                                            "W_7T",
                                            "W_8S",
                                            "W_8T",
                                            "W_9S",
                                            "W_9T",
                                            "W_10S",
                                            "W_10T",
                                            "W_11S",
                                            "W_11T",
                                            "W_12S",
                                            "W_12T",
                                            "W_13S",
                                            "W_13T",
                                            "W_14S",
                                            "W_14T",
                                            "W_15S",
                                            "W_15T",
                                            "W_16S",
                                            "W_16T",
                                            "W_17S",
                                            "W_17T",
                                            "W1S_Peak",
                                            "W1T_Peak",
                                            "W2S_Peak",
                                            "W2T_Peak",
                                            "W3S_Peak",
                                            "W3T_Peak",
                                            "W4S_Peak",
                                            "W4T_Peak",
                                            "W5S_Peak",
                                            "W5T_Peak",
                                            "W6S_Peak",
                                            "W6T_Peak",
                                            "W7S_Peak",
                                            "W7T_Peak",
                                            "W8S_Peak",
                                            "W8T_Peak",
                                            "W9S_Peak",
                                            "W9T_Peak",
                                            "W10S_Peak",
                                            "W10T_Peak",
                                            "W11S_Peak",
                                            "W11T_Peak",
                                            "W12S_Peak",
                                            "W12T_Peak",
                                            "W13S_Peak",
                                            "W13T_Peak",
                                            "W14S_Peak",
                                            "W14T_Peak",
                                            "W15S_Peak",
                                            "W15T_Peak",
                                            "W16S_Peak",
                                            "W16T_Peak",
                                            "W17S_Peak",
                                            "W17T_Peak",
                                            "MTF_DateTime",
                                            "RecordTime",
                                            "MeasurementSN"
                                        };

                                            string trayLocation = $"{DataRow.Location_X}-{DataRow.Location_Y}";
                                            string qcResult = DataRow.Class == "NG" ? "F" : "P";

                                            #region //INSERT QMS.QcMeasureData，每一個數據都要存一筆 measureData
                                            foreach (var tuple in measureValues.Zip(columnNames, Tuple.Create))
                                            {
                                                string measureValue = tuple.Item1;
                                                string qcItemName = tuple.Item2;

                                                // 從快取中取得 QcItem 資料
                                                if (qcItemDictionary.TryGetValue(qcItemName, out var qcItem))
                                                {
                                                    // 建立 QcMeasureDataModel 並加入批次清單

                                                    var qcMeasureData = new QcMeasureDataModel
                                                    {
                                                        QcRecordId = qcRecordId,
                                                        QmmDetailId = QmmDetailId,
                                                        QcItemId = qcItem.QcItemId,
                                                        QcItemDesc = qcItem.QcItemName,
                                                        MeasureValue = measureValue,
                                                        QcResult = qcResult,
                                                        TrayLocation = trayLocation,
                                                        CreateBy = UserId,
                                                        LastModifiedBy = UserId,
                                                        CauseId = qcResult == "P" ? (int?)null : 1311,
                                                        // 其他必要欄位
                                                    };
                                                    qcMeasureDataList.Add(qcMeasureData);
                                                }
                                            }
                                            #endregion
                                        }

                                        #region//INSERT QMS.QcMeasureData 
                                        qcMeasureDataList = qcMeasureDataList.OrderBy(x => x.QcRecordId).ThenBy(x => x.QcItemId).ToList();
                                        sql = @"INSERT INTO QMS.QcMeasureData 
                                        (QcRecordId,QmmDetailId, QcItemId, QcItemDesc, MeasureValue, QcResult, CauseId, Cavity,CreateBy, CreateDate,LastModifiedBy, LastModifiedDate) 
                                        VALUES (@QcRecordId,@QmmDetailId, @QcItemId, @QcItemDesc, @MeasureValue, @QcResult, @CauseId, @Cavity,@CreateBy, @CreateDate,@LastModifiedBy, @LastModifiedDate)";
                                        var parameters = qcMeasureDataList.Select(data => new
                                        {
                                            data.QcRecordId,
                                            data.QmmDetailId,
                                            data.QcItemId,
                                            data.QcItemDesc,
                                            data.MeasureValue,
                                            data.QcResult,
                                            data.CauseId,
                                            Cavity = data.TrayLocation,
                                            data.CreateBy,
                                            CreateDate = DateTime.Now,
                                            data.LastModifiedBy,
                                            LastModifiedDate = DateTime.Now
                                        });
                                        rowsAffected += sqlConnection.Execute(sql, parameters);
                                        if (rowsAffected == 0) throw new Exception("【MES】MTF數據新增失敗");
                                        #endregion

                                        #region //更新MTF暫存資料狀態
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.MtfProcessTemp
                                            SET RunStatus = 'Y'                                            
                                            WHERE MtfProcessTempId = @MtfProcessTempId";
                                        dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            TempItem.MtfProcessTempId
                                        });
                                        int MtfProcessTempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                        if (MtfProcessTempRowsAffected != 1) throw new Exception("【MES】MTF暫存數據更新失敗");
                                        #endregion
                                    }

                                    #region //Response
                                    jsonResponse = JObject.FromObject(new
                                    {
                                        status = "success",
                                        msg = "(" + rowsAffected + " rows affected)",
                                    });
                                    #endregion
                                }
                            }
                            #endregion
                        }
                        #endregion
                    }

                    if (rowsAffected > 0)
                    {
                        transactionScope.Complete();
                    }
                    else {
                        throw new Exception("MTF資訊新增失敗");
                    }                    
                }                
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBarcodesToScrap -- 批次更改條碼為報廢 -- GPAI 2025-02-03
        public string UpdateBarcodesToScrap(string BarcodeInfo, string ScrapReason)
        {
            try
            {
                if (BarcodeInfo.Length <= 0) throw new SystemException("無設定條碼!!");
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string[] BarcodeInfoArray = BarcodeInfo.Split(',');
                        foreach (var BarcodeId in BarcodeInfoArray)
                        {
                            #region //判斷資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT *
                                    FROM MES.Barcode a
                                    WHERE BarcodeId = @BarcodeId";
                            dynamicParameters.Add("BarcodeId", BarcodeId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                            foreach (var item in result)
                            {
                                if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0")
                                {
                                    switch (item.BarcodeStatus)
                                    {
                                       
                                        case "7":
                                            throw new SystemException("條碼狀態為【強制結束流程】不可更改");
                                        case "8":
                                            throw new SystemException("條碼狀態為【製令完工入庫】不可更改");
                                        case "10":
                                            throw new SystemException("條碼狀態為【已出貨】不可更改");
                                        default:
                                            throw new SystemException("條碼狀態不可更改");
                                    }
                                }

                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    CurrentProdStatus = 'S',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @BarcodeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    BarcodeId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeScrapLog (BarcodeId, ScrapReason
                                    ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                VALUES (@BarcodeId, @ScrapReason
                                    ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeId,
                                    ScrapReason,
                                   
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = CreateBy,
                                    LastModifiedBy = LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateLotBarcodeQty 修改條碼數量 --GPAI 2025-03-25 
        public string UpdateLotBarcodeQty(int PrintId, int SetQty)
        {
            var BarcodeId = -1;
            var BarcodeNo = "";

            try
            {
                if (PrintId <= 0) throw new SystemException("無設定條碼!!");
                if (SetQty <= 0) throw new SystemException("數量不得為0!!");

                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int moid = -1;
                        #region //判斷資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM MES.BarcodePrint a
                                    WHERE PrintId = @PrintId";
                        dynamicParameters.Add("PrintId", PrintId);

                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                        if (result1.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                        foreach (var item in result1)
                        {
                            if (item.PrintStatus == "F") throw new SystemException("條碼為不良品條碼!");

                            BarcodeNo = item.BarcodeNo;

                        }
                        #endregion


                        #region //判斷資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM MES.Barcode a
                                    WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("條碼資料錯誤!");

                        foreach (var item in result)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0")
                            {
                                switch (item.BarcodeStatus)
                                {

                                    case "7":
                                        throw new SystemException("條碼狀態為【強制結束流程】不可更改");
                                    case "8":
                                        throw new SystemException("條碼狀態為【製令完工入庫】不可更改");
                                    case "10":
                                        throw new SystemException("條碼狀態為【已出貨】不可更改");
                                    default:
                                        throw new SystemException("條碼狀態不可更改");
                                }
                            }
                            if (item.CurrentProdStatus == "F") throw new SystemException("條碼為不良品條碼!");
                            moid = item.MoId;
                            BarcodeId = item.BarcodeId;

                        }
                        #endregion

                        #region 判斷是否有過站紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM MES.BarcodeProcess a
                                    WHERE a.BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var BarcodeProcessresult = sqlConnection.Query(sql, dynamicParameters);
                        if (BarcodeProcessresult.Count() > 0) throw new SystemException("條碼有過站紀錄，不可修改!");

                        #endregion

                        #region 判斷是否超過條瑪數
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM MES.MoSetting a
                                    WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", moid);

                        var MoSettingresult = sqlConnection.Query(sql, dynamicParameters);
                        if (MoSettingresult.Count() <= 0) throw new SystemException("製令設定錯誤!");
                        foreach (var item in MoSettingresult)
                        {
                            
                            if (SetQty > item.LotQty ) throw new SystemException("數量超過製令設定!! " + SetQty + ">" + item.LotQty);
                            if (item.LotStatus == "N") throw new SystemException("該製令設定非批量過站!");
                        }
                        #endregion

                        #region UPDATE
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                    BarcodeQty = @SetQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                SetQty = SetQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                BarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodePrint SET
                                    BarcodeQty = @SetQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE PrintId = @PrintId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                SetQty = SetQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                PrintId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMaterialFeedingRecord -- 更新投料记录 --Jean 2025-05-25 --
        public string UpdateMaterialFeedingRecord(int MatFeedRegId, int MaterialId, double MatInRegQty, int UomId, string Remarks)
        {
            try
            {
                if (MatInRegQty == 0) throw new SystemException("【投料数量】不能為0!");
                if (MaterialId <= 0) throw new SystemException("【材料】不能為空!");
                if (UomId <= 0) throw new SystemException("【单位】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷投料记录資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MaterialFeedReg
                                WHERE MatFeedRegId = @MatFeedRegId";
                        dynamicParameters.Add("MatFeedRegId", MatFeedRegId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("投料记录資料錯誤!");
                        #endregion


                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MaterialFeedReg SET
                                MaterialId = @MaterialId,
                                MatInRegQty = @MatInRegQty,
                                UomId = @UomId,
                                Remarks = @Remarks,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MatFeedRegId = @MatFeedRegId";
                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            MaterialId,
                            MatInRegQty,
                            UomId,
                            Remarks,
                            LastModifiedDate,
                            LastModifiedBy,
                            MatFeedRegId
                        });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateStatusMaterialFeedingRecord -- 更新投料记录状态 --Jean 2025-05-25 --
        public string UpdateStatusMaterialFeedingRecord(int MatFeedRegId, string Status)
        {
            try
            {
                
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷投料记录資料是否正確
                        sql = @"SELECT TOP 1 1
                                FROM MES.MaterialFeedReg
                                WHERE MatFeedRegId = @MatFeedRegId";
                        dynamicParameters.Add("MatFeedRegId", MatFeedRegId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("投料记录資料錯誤!");
                        #endregion


                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.MaterialFeedReg SET
                                Status = @Status,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MatFeedRegId = @MatFeedRegId";
                        dynamicParameters.AddDynamicParams(
                        new
                        {
                            Status,
                            LastModifiedDate,
                            LastModifiedBy,
                            MatFeedRegId
                        });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region
        #endregion

        #endregion

        private void TxCalculateWip(int MoId, int Quantity, int SortNumber, SqlConnection sqlConnection)
        {
            #region //先找出SortNumber的WipQty
            dynamicParameters = new DynamicParameters();
            sql = @"SELECT WipQty,MoProcessId,NecessityStatus
                      FROM MES.MoProcess
                     WHERE MoId = @MoId
                       AND SortNumber = @SortNumber ";
            dynamicParameters.Add("MoId", MoId);
            dynamicParameters.Add("SortNumber", SortNumber);

            var WipResult = sqlConnection.Query(sql, dynamicParameters);
            if(WipResult.Count() > 0)
            {
                int MoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoProcessId);
                int WipQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).WipQty);
                string NecessityStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NecessityStatus;
                #region //扣除WipQty
                dynamicParameters = new DynamicParameters();
                sql = @"Update MES.MoProcess
                           SET WipQty = WipQty - @WipQty
                         WHERE MoProcessId = @MoProcessId";
                dynamicParameters.AddDynamicParams(
                new
                {
                    MoProcessId,
                    WipQty = WipQty - Quantity < 0 ? WipQty : Quantity
                });

                int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                #region //檢核Update完結果
                sql = @"  SELECT a.Quantity,
                                 b.SortNumber,b.ProcessAlias,b.MoProcessId,
		                         b.TotalInputQty,b.TotalPassQty,b.TotalNgQty,b.TotalScrapQty,
		                         ISNULL(c.ReturnQty,0) ReturnQty,
		                         b.TotalPassQty + ISNULL(c.ReturnQty,0) AvailToNextQty,
		                         b.WipQty
                            FROM MES.ManufactureOrder a
                                 INNER JOIN MES.MoProcess b ON a.MoId = b.MoId
	                             LEFT JOIN (SELECT c1.NextMoProcessId,SUM(c1.Quantity) ReturnQty
	                                          FROM MES.MoProcessTransaction c1
				                             GROUP BY c1.NextMoProcessId) c ON b.MoProcessId = c.NextMoProcessId 
                           WHERE MoProcessId = @MoProcessId ";
                dynamicParameters.Add("MoProcessId", MoProcessId);
                var AfterUpdateResult = sqlConnection.Query(sql, dynamicParameters);
                #endregion

                #endregion

                if ((Quantity - WipQty > 0) && !NecessityStatus.Equals("Y"))
                {
                    TxCalculateWip(MoId, Quantity - WipQty, SortNumber - 1, sqlConnection);
                }
                else
                {
                    return;
                }
            }
            #endregion
        }

        #region //Delete
        #region //DeleteJigBarcodeDetail -- 刪除治具綁定條碼資料 -- Ann 2022-11-01
        public string DeleteJigBarcodeDetail(int JigBarcodeId, string BarcodeNo, int MoProcessId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int UserId = CreateBy;
                        int JigId = -1;
                        string WorkingFlag = "";
                        if (JigBarcodeId > 0)
                        {
                            #region //判斷治具條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.JigId, a.BarcodeNo, a.MoProcessId, a.WorkingFlag
                                    FROM MES.JigBarcode a
                                    WHERE a.JigBarcodeId = @JigBarcodeId";
                            dynamicParameters.Add("JigBarcodeId", JigBarcodeId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("治具條碼資料錯誤!");

                            foreach (var item in result)
                            {
                                JigId = item.JigId;
                                BarcodeNo = item.BarcodeNo;
                                MoProcessId = item.MoProcessId;
                                WorkingFlag = item.WorkingFlag;
                            }
                            #endregion
                        }
                        else if (BarcodeNo.Length > 0 && MoProcessId > 0)
                        {
                            #region //判斷治具條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.JigBarcodeId, a.JigId, a.WorkingFlag
                                    FROM MES.JigBarcode a
                                    WHERE a.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("治具條碼資料錯誤!");

                            foreach (var item in result)
                            {
                                JigBarcodeId = item.JigBarcodeId;
                                JigId = item.JigId;
                                WorkingFlag = item.WorkingFlag;
                            }
                            #endregion
                        }
                        else throw new SystemException("條件資料錯誤!");

                        #region //判斷此條碼加工狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                WHERE a.FinishDate IS NULL
                                AND b.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("此條碼目前加工中，無法解除綁定!");
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.JigBarcode
                                WHERE JigBarcodeId = @JigBarcodeId";
                        dynamicParameters.Add("JigBarcodeId", JigBarcodeId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //建立治具條碼歷史紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.JigBarcodeHistory (JigId, BarcodeNo, MoProcessId, WorkingFlag
                                , CreateDate, CreateBy)
                                OUTPUT INSERTED.HistoryId
                                VALUES (@JigId, @BarcodeNo, @MoProcessId, @WorkingFlag
                                , @CreateDate, @CreateBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                JigId,
                                BarcodeNo,
                                MoProcessId,
                                WorkingFlag,
                                CreateDate,
                                CreateBy = UserId
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBarcodeComponent -- 刪除上料綁定資料 -- Ann 2022-11-14
        public string DeleteBarcodeComponent(int BarcodeComponentId, string ComponentBarcodeNo = "", int MoProcessId = -1)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int UserId = CreateBy;
                        int AssemblyBarcodeId = -1;
                        int ComponentBarcodeId = -1;
                        if (BarcodeComponentId > 0)
                        {
                            #region //判斷上料綁定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.AssemblyBarcodeId, a.ComponentBarcodeId, a.MoProcessId
                                    , b.BarcodeNo ComponentBarcodeNo
                                    FROM MES.BarcodeComponent a
                                    INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                    WHERE a.BarcodeComponentId = @BarcodeComponentId";
                            dynamicParameters.Add("BarcodeComponentId", BarcodeComponentId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("上料綁定資料錯誤!");

                            foreach (var item in result)
                            {
                                AssemblyBarcodeId = item.AssemblyBarcodeId;
                                ComponentBarcodeId = item.ComponentBarcodeId;
                                MoProcessId = item.MoProcessId;
                                ComponentBarcodeNo = item.ComponentBarcodeNo;
                            }
                            #endregion
                        }
                        else
                        {
                            #region //判斷上料綁定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeComponentId, a.AssemblyBarcodeId, a.ComponentBarcodeId
                                    FROM MES.BarcodeComponent a
                                    INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                    WHERE b.BarcodeNo = @ComponentBarcodeNo
                                    AND a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("ComponentBarcodeNo", ComponentBarcodeNo);
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("上料綁定資料錯誤!");

                            foreach (var item in result)
                            {
                                BarcodeComponentId = item.BarcodeComponentId;
                                AssemblyBarcodeId = item.AssemblyBarcodeId;
                                ComponentBarcodeId = item.ComponentBarcodeId;
                            }
                            #endregion
                        }

                        #region //判斷主條碼是否為加工狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Barcode a
                                INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                WHERE a.BarcodeId = @BarcodeId AND b.FinishDate IS NULL";
                        dynamicParameters.Add("BarcodeId", AssemblyBarcodeId);

                        var finishCheckResult = sqlConnection.Query(sql, dynamicParameters);

                        if (finishCheckResult.Count() <= 0) throw new SystemException("主條碼目前非加工狀態!");
                        #endregion

                        #region //判斷主條碼是否有比此製程順序更後面的過站紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                WHERE a.BarcodeId = @BarcodeId
                                AND b.SortNumber >
                                (
                                  SELECT b.SortNumber
                                  FROM MES.MoProcess b
                                  WHERE b.MoProcessId = @MoProcessId
                                )";
                        dynamicParameters.Add("BarcodeId", AssemblyBarcodeId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        //if (result2.Count() > 0) throw new SystemException("此主條碼已有後製程過站紀錄，無法解除綁定!");
                        #endregion

                        #region //檢查是否有綁定屬性，若有則需要新增LOG
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ItemNo, a.ItemValue
                                FROM MES.BarcodeComponentAttribute a
                                WHERE a.BarcodeComponentId = @BarcodeComponentId";
                        dynamicParameters.Add("BarcodeComponentId", BarcodeComponentId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = 0;
                        if (result3.Count() > 0)
                        {
                            foreach (var item in result3)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeComponentDeleteLog (AssemblyBarcodeId, ComponentBarcodeId, MoProcessId, ItemNo, ItemValue
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.LogId
                                        VALUES (@AssemblyBarcodeId, @ComponentBarcodeId, @MoProcessId, @ItemNo, @ItemValue
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AssemblyBarcodeId,
                                        ComponentBarcodeId,
                                        MoProcessId,
                                        item.ItemNo,
                                        item.ItemValue,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                            }
                        }
                        #endregion

                        #region //先刪除關聯Table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.BarcodeComponentAttribute
                                WHERE BarcodeComponentId = @BarcodeComponentId";
                        dynamicParameters.Add("BarcodeComponentId", BarcodeComponentId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.BarcodeComponent
                                WHERE BarcodeComponentId = @BarcodeComponentId";
                        dynamicParameters.Add("BarcodeComponentId", BarcodeComponentId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //將綁定條碼狀態改回下料狀態(3)，退料後才會將狀態改回8
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeStatus = '3',
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @ComponentBarcodeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LastModifiedDate,
                                LastModifiedBy = UserId,
                                ComponentBarcodeNo
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBarcodeComponentL -- 刪除上料綁定資料(批號模式) -- Ann 2024-05-13
        public string DeleteBarcodeComponentL(int BarcodeComponentId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷上料綁定資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.AssemblyBarcodeId, a.LotNumberId, a.MoProcessId
                                FROM MES.BarcodeComponent a
                                WHERE a.BarcodeComponentId = @BarcodeComponentId";
                        dynamicParameters.Add("BarcodeComponentId", BarcodeComponentId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("上料綁定資料錯誤!");

                        int AssemblyBarcodeId = -1;
                        int LotNumberId = -1;
                        int MoProcessId = -1;
                        foreach (var item in result)
                        {
                            AssemblyBarcodeId = item.AssemblyBarcodeId;
                            LotNumberId = item.LotNumberId;
                            MoProcessId = item.MoProcessId;
                        }
                        #endregion

                        #region //判斷主條碼是否為加工狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Barcode a
                                INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                WHERE a.BarcodeId = @BarcodeId AND b.FinishDate IS NULL";
                        dynamicParameters.Add("BarcodeId", AssemblyBarcodeId);

                        var finishCheckResult = sqlConnection.Query(sql, dynamicParameters);

                        if (finishCheckResult.Count() <= 0) throw new SystemException("主條碼目前非加工狀態!");
                        #endregion

                        #region //判斷主條碼是否有比此製程順序更後面的過站紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                WHERE a.BarcodeId = @BarcodeId
                                AND b.SortNumber >
                                (
                                  SELECT b.SortNumber
                                  FROM MES.MoProcess b
                                  WHERE b.MoProcessId = @MoProcessId
                                )";
                        dynamicParameters.Add("BarcodeId", AssemblyBarcodeId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        //if (result2.Count() > 0) throw new SystemException("此主條碼已有後製程過站紀錄，無法解除綁定!");
                        #endregion

                        #region //檢查是否有綁定屬性，若有則需要新增LOG
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ItemNo, a.ItemValue
                                FROM MES.BarcodeComponentAttribute a
                                WHERE a.BarcodeComponentId = @BarcodeComponentId";
                        dynamicParameters.Add("BarcodeComponentId", BarcodeComponentId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = 0;
                        if (result3.Count() > 0)
                        {
                            foreach (var item in result3)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeComponentDeleteLog (AssemblyBarcodeId, LotNumberId, MoProcessId, ItemNo, ItemValue
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.LogId
                                        VALUES (@AssemblyBarcodeId, @ComponentBarcodeId, @MoProcessId, @ItemNo, @ItemValue
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AssemblyBarcodeId,
                                        LotNumberId,
                                        MoProcessId,
                                        item.ItemNo,
                                        item.ItemValue,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                            }
                        }
                        #endregion

                        #region //先刪除關聯Table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.BarcodeComponentAttribute
                                WHERE BarcodeComponentId = @BarcodeComponentId";
                        dynamicParameters.Add("BarcodeComponentId", BarcodeComponentId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.BarcodeComponent
                                WHERE BarcodeComponentId = @BarcodeComponentId";
                        dynamicParameters.Add("BarcodeComponentId", BarcodeComponentId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteAllBarcodeComponent -- 刪除上料綁定資料(批量解綁) -- Ann 2023-04-13
        public string DeleteAllBarcodeComponent(int MoId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷製令資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.ManufactureOrder
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);
                        if (ManufactureOrderResult.Count() <= 0) throw new SystemException("製令資料錯誤!!");
                        #endregion

                        #region //找出目前被綁定之條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeComponentId
                                FROM MES.BarcodeComponent a
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                WHERE b.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeComponentResult.Count() <= 0) throw new SystemException("此製令尚未綁定任何一筆模仁!!");
                        #endregion

                        int UserId = CreateBy;
                        int rowsAffected = 0;
                        foreach (var item in BarcodeComponentResult)
                        {
                            #region //判斷上料綁定資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.AssemblyBarcodeId, a.ComponentBarcodeId, a.MoProcessId
                                    , b.BarcodeNo ComponentBarcodeNo
                                    FROM MES.BarcodeComponent a
                                    INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                    WHERE a.BarcodeComponentId = @BarcodeComponentId";
                            dynamicParameters.Add("BarcodeComponentId", item.BarcodeComponentId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("上料綁定資料錯誤!");

                            int AssemblyBarcodeId = -1;
                            int ComponentBarcodeId = -1;
                            int MoProcessId = -1;
                            string ComponentBarcodeNo = "";
                            foreach (var item2 in result)
                            {
                                AssemblyBarcodeId = item2.AssemblyBarcodeId;
                                ComponentBarcodeId = item2.ComponentBarcodeId;
                                MoProcessId = item2.MoProcessId;
                                ComponentBarcodeNo = item2.ComponentBarcodeNo;
                            }
                            #endregion

                            #region //判斷主條碼是否為加工狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.Barcode a
                                    INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                    WHERE a.BarcodeId = @BarcodeId AND b.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeId", AssemblyBarcodeId);

                            var finishCheckResult = sqlConnection.Query(sql, dynamicParameters);

                            if (finishCheckResult.Count() <= 0) throw new SystemException("主條碼目前非加工狀態!");
                            #endregion

                            #region //檢查是否有綁定屬性，若有則需要新增LOG
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ItemNo, a.ItemValue
                                    FROM MES.BarcodeComponentAttribute a
                                    WHERE a.BarcodeComponentId = @BarcodeComponentId";
                            dynamicParameters.Add("BarcodeComponentId", item.BarcodeComponentId);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);

                            if (result3.Count() > 0)
                            {
                                foreach (var item2 in result3)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodeComponentDeleteLog (AssemblyBarcodeId, ComponentBarcodeId, MoProcessId, ItemNo, ItemValue
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.LogId
                                            VALUES (@AssemblyBarcodeId, @ComponentBarcodeId, @MoProcessId, @ItemNo, @ItemValue
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            AssemblyBarcodeId,
                                            ComponentBarcodeId,
                                            MoProcessId,
                                            item2.ItemNo,
                                            item2.ItemValue,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();
                                }
                            }
                            #endregion

                            #region //先刪除關聯Table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.BarcodeComponentAttribute
                                    WHERE BarcodeComponentId = @BarcodeComponentId";
                            dynamicParameters.Add("BarcodeComponentId", item.BarcodeComponentId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除主要table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE MES.BarcodeComponent
                                    WHERE BarcodeComponentId = @BarcodeComponentId";
                            dynamicParameters.Add("BarcodeComponentId", item.BarcodeComponentId);

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //將綁定條碼狀態改回下料狀態(3)，退料後才會將狀態改回8
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    BarcodeStatus = '3',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeNo = @ComponentBarcodeNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    ComponentBarcodeNo
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBarcode -- 刪除綁定條碼資料(數量產條碼功能用) -- Ann 2023-08-21
        public string DeleteBarcode(int BarcodeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        int UserId = CreateBy;

                        #region //判斷條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeStatus
                                FROM MES.Barcode a 
                                WHERE a.BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeResult.Count() <= 0) throw new SystemException("條碼資料錯誤!!");

                        foreach (var item in BarcodeResult)
                        {
                            if (item.BarcodeStatus != "0") throw new SystemException("條碼狀態錯誤!!");
                        }
                        #endregion

                        int rowsAffected = 0;
                        #region //先刪除關聯Table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a
                                FROM MES.BarcodeProcessAttribute a 
                                INNER JOIN MES.BarcodeProcess b ON a.BarcodeProcessId = b.BarcodeProcessId
                                WHERE b.BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE a
                                FROM MES.BarcodeAttribute a 
                                WHERE a.BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.BarcodeProcess
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE MES.Barcode
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //刪除該包裝產品條碼 --Gpai 2022-04-20
        public string DeletePackageProductBarcode(int PackageBarcodeId, string BarcodeNo, int MoId)
        {
            try
            {

                int BarcodeId = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        //#region //判斷該條碼是否被綁過
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT 1
                        //        FROM MES.PackageBarcodeReference a
                        //        INNER JOIN MES.Barcode b ON b.BarcodeId = a.BarcodeId
                        //        WHERE b.BarcodeNo = @BarcodeNo";
                        //dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        //var result0 = sqlConnection.Query(sql, dynamicParameters);
                        //if (result0.Count() > 0) throw new SystemException("條碼已包裝入庫過，請重新輸入!");
                        //#endregion


                        //#region //判斷條碼是否完工
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT TOP 1 *
                        //        FROM MES.BarcodeProcess a
                        //        INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId AND a.MoProcessId = b.CurrentMoProcessId
                        //        WHERE b.BarcodeNo = @BarcodeNo
                        //        AND a.FinishDate IS NULL";
                        //dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        //var result1 = sqlConnection.Query(sql, dynamicParameters);
                        //if (result1.Count() > 0) throw new SystemException("條碼未完工，請重新輸入!");

                        //#endregion

                        #region //判斷該條碼是否屬於該製令底下
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT BarcodeId, BarcodeNo, CurrentProdStatus, BarcodeQty, BarcodeStatus
                                FROM MES.Barcode 
                                WHERE MoId = @MoId AND BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("條碼不屬於該製令");

                        //判斷該條碼是否良品
                        //if (result.First().CurrentProdStatus != "P") throw new SystemException("該產品非良品，請重新輸入!");
                        //判斷該條碼是否入庫
                        if (result.First().BarcodeStatus == "8") throw new SystemException("該產品已入庫!");
                        BarcodeId = result.First().BarcodeId;
                        #endregion

                        #region //判斷該條碼是否屬於該包裝
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 FROM MES.PackageBarcodeReference
							WHERE PackageBarcodeId = @PackageBarcodeId AND BarcodeId = @BarcodeId";
                        dynamicParameters.Add("PackageBarcodeId", PackageBarcodeId);
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                        if (result1.Count() <= 0) throw new SystemException("條碼不屬於該包裝條碼");

                        //判斷該條碼是否良品
                        //if (result.First().CurrentProdStatus != "P") throw new SystemException("該產品非良品，請重新輸入!");
                        BarcodeId = result.First().BarcodeId;
                        #endregion

                        #region //刪除產品條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.PackageBarcodeReference 
                                WHERE PackageBarcodeId = @PackageBarcodeId AND BarcodeId= @BarcodeId;";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                PackageBarcodeId,
                                BarcodeId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        int rowsAffected = insertResult.Count();
                        //更新產品條碼數
                        UpdatePackageBarcodeProductQty(PackageBarcodeId);
                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //刪除該包裝條碼 --Gpai 2022-04-25 
        public string DeletePackageBarcode(int PackageBarcodeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //該包裝非入庫狀態才能刪
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM MES.PackageBarcode
                                WHERE PackageBarcodeId = @PackageBarcodeId";
                        dynamicParameters.Add("PackageBarcodeId", PackageBarcodeId);
                        var result0 = sqlConnection.Query(sql, dynamicParameters);
                        if (result0.First().Status == "2") throw new SystemException("已入庫無法刪除!");
                        #endregion

                        #region //判斷該條碼是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM MES.PackageBarcode 
                                WHERE PackageBarcodeId = @PackageBarcodeId";
                        dynamicParameters.Add("PackageBarcodeId", PackageBarcodeId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("條碼不存在");

                        
                        #endregion

                        #region //判斷該包裝是否有綁定產品
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * FROM MES.PackageBarcodeReference
							WHERE PackageBarcodeId = @PackageBarcodeId";
                        dynamicParameters.Add("PackageBarcodeId", PackageBarcodeId);

                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                        if (result1.Count() > 0) throw new SystemException("該包裝有綁定產品!");

                        #endregion

                        #region //刪除包裝條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE FROM MES.PackageBarcode 
                                WHERE PackageBarcodeId = @PackageBarcodeId ;";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                PackageBarcodeId,
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        int rowsAffected = insertResult.Count();
                        
                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //物料載盤
        #region //DeleteVehicleDetail -- 刪除物料載盤詳細資料 -- Ann 2024-05-27
        public string DeleteVehicleDetail(int VdId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認物料載盤詳細資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(a.BarcodeNo, '') BarcodeNo
                                FROM MES.VehicleDetail a 
                                WHERE a.VdId = @VdId";
                        dynamicParameters.Add("VdId", VdId);

                        var VehicleDetailResult = sqlConnection.Query(sql, dynamicParameters);

                        if (VehicleDetailResult.Count() <= 0) throw new SystemException("物料載盤詳細資料錯誤!!");

                        string BarcodeNo = "";
                        foreach (var item in VehicleDetailResult)
                        {
                            BarcodeNo = item.BarcodeNo;
                        }
                        #endregion

                        #region //解綁程序
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.VehicleDetail SET
                                ExpirationDate = GETDATE(),
                                [Status] = 'S',
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE VdId = @VdId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LastModifiedDate,
                                LastModifiedBy,
                                VdId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //若有條碼，則將條碼恢復初始狀態
                        if (BarcodeNo.Length > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    CurrentMoProcessId = -1,
                                    NextMoProcessId = -1,
                                    MoId = NULL,
                                    BarcodeStatus = '8',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeNo = @BarcodeNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    BarcodeNo
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion
        #endregion

        #region //Transaction
        #region //TxBarcodeProcess -- 過站入口
        public string TxBarcodeProcess(string BarcodeNo, int MoProcessId, int MachineId, int UserId,
            string QtyBarcodeStatus, string QtyLotNgCauseNo, int QtyNextMoProcessId, string Company, string UserNo)
        {
            if (BarcodeNo == "") throw new Exception("BarcodeNo 不可為空");
            if (MoProcessId == -1) throw new Exception("MoProcessId 不可為空");
            if (UserId == -1 && UserNo.Length <= 0) throw new Exception("過站人員資料錯誤!!");

            if (QtyBarcodeStatus == "F")
            {
                if (QtyLotNgCauseNo.Length <= 0) throw new Exception("NG原因不能為空!");
                if (QtyNextMoProcessId <= 0) throw new Exception("下一站製程不能為空!");
            }
            try
            {
                int rowsAffected = 0;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (Company == "JMO")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.CompanyId
                                FROM BAS.Company a
                                WHERE CompanyNo = @CompanyNo";
                            dynamicParameters.Add("CompanyNo", Company);
                            var companyNoResult = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in companyNoResult)
                            {
                                CurrentCompany = item.CompanyId;
                            }
                        }

                        #region //若公司別與USER皆為空值，預設為託外供應商過站模式
                        if (UserNo.Length > 0 && UserId <= 0)
                        {
                            #region //確認公司別
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT c.CompanyId
                                    FROM MES.MoProcess a 
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MoProcessResult.Count() <= 0) throw new Exception("確認公司別時錯誤!!");

                            foreach (var item in MoProcessResult)
                            {
                                CurrentCompany = item.CompanyId;
                            }
                            #endregion

                            #region //確認USER資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UserId
                                    FROM BAS.[User] a 
                                    INNER JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                                    WHERE a.UserNo = @UserNo
                                    AND b.CompanyId = @CompanyId";
                            dynamicParameters.Add("UserNo", UserNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var UserResult = sqlConnection.Query(sql, dynamicParameters);

                            if (UserResult.Count() <= 0) throw new Exception("過站人員資料錯誤!!");

                            foreach (var item in UserResult)
                            {
                                UserId = item.UserId;
                            }
                            #endregion
                        }
                        #endregion

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //取得MoId
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoId
                                    , c.WoErpPrefix, c.WoErpNo
                                    FROM MES.MoProcess a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var MoIdResult = sqlConnection.Query(sql, dynamicParameters);

                            int MoId = -1;
                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            foreach (var item2 in MoIdResult)
                            {
                                MoId = item2.MoId;
                                WoErpPrefix = item2.WoErpPrefix;
                                WoErpNo = item2.WoErpNo;
                            }
                            #endregion

                            #region //確認製令狀態是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT RTRIM(LTRIM(TA011)) TA011
                                    FROM MOCTA
                                    WHERE TA001 = @WoErpPrefix
                                    AND TA002 = @WoErpNo";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);

                            var MOCTAResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (MOCTAResult.Count() <= 0) throw new Exception("查無ERP製令相關資料!!");

                            foreach (var item in MOCTAResult)
                            {
                                if (item.TA011 == "Y" || item.TA011 == "y") throw new Exception("此製令已完工，無法刷取!!");
                            }
                            #endregion

                            #region //判斷條碼是否在治具裡

                            sql = @"SELECT a.[Status] JigStatus,
                                           b.JigId,
                                           b.JigBarcodeId,
                                           b.BarcodeNo,
	                                       b.MoProcessId,
                                           b.WorkingFlag
                                      FROM MES.Jig a
                                           LEFT JOIN MES.JigBarcode b ON a.JigId = b.JigId
                                     WHERE JigNo = @BarcodeNo
                                       AND b.WorkingFlag = 'Y'";

                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var JigBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (JigBarcodeResult.Count() > 0) //治具批量過站
                            {
                                foreach (var item in JigBarcodeResult)
                                {
                                    string JigStatus = item.JigStatus.ToString();
                                    if (JigStatus.Equals("S")) throw new SystemException("治具失效中,不可過站");

                                    string JigBarcodeNo = item.BarcodeNo.ToString();
                                    int JigMoProcessId = Convert.ToInt32(item.MoProcessId);

                                    MoProcessId = item.MoProcessId;

                                    #region //確認是否為Tray模式
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TrayBarcode, a.Source
                                        FROM MES.MoSetting a
                                        WHERE MoId = @MoId";
                                    dynamicParameters.Add("MoId", MoId);

                                    var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                    string TrayBarcode = "";
                                    string Source = "";
                                    foreach (var item2 in MoSettingResult)
                                    {
                                        TrayBarcode = item2.TrayBarcode;
                                        Source = item2.Source;
                                    }

                                    if (TrayBarcode == "Y" && Source == "MR")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.TrayNo
                                            FROM MES.Tray a
                                            WHERE a.BarcodeNo = @BarcodeNo";
                                        dynamicParameters.Add("BarcodeNo", item.BarcodeNo);

                                        var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (TrayResult.Count() <= 0) throw new SystemException("查無此條碼(" + item.BarcodeNo + ")綁定的Tray盤資訊!");

                                        string TrayNo = "";
                                        foreach (var item2 in TrayResult)
                                        {
                                            TrayNo = item2.TrayNo;
                                            BarcodeNo = item.BarcodeNo;
                                            JigBarcodeNo = item2.TrayNo;
                                        }
                                    }
                                    #endregion

                                    #region //判斷該治具是否可在此機台生產
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT 1
                                          FROM MES.Jig a
                                               INNER JOIN MES.MachineJig b ON a.JigId = b.JigId
                                         WHERE a.JigId = @JigId
                                           AND b.MachineId = @MachineId";

                                    dynamicParameters.Add("JigId", item.JigId);
                                    dynamicParameters.Add("MachineId", MachineId);
                                    var JigMachineCheck = sqlConnection.Query(sql, dynamicParameters);
                                    if (JigMachineCheck.Count() == 0) throw new SystemException("此治具不可在這機台生產!");
                                    #endregion

                                    TxBarcodeProcessCore(JigBarcodeNo, JigMoProcessId, MachineId, UserId,
                                        QtyBarcodeStatus, QtyLotNgCauseNo, QtyNextMoProcessId, sqlConnection, UserNo);

                                    #region //查詢條碼目前狀態是否非加工狀態
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.FinishDate
                                        FROM MES.BarcodeProcess a
                                        INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                        WHERE b.BarcodeNo = @BarcodeNo
                                        AND a.MoProcessId = @MoProcessId
                                        ORDER BY a.BarcodeProcessId DESC";
                                    dynamicParameters.Add("BarcodeNo", item.BarcodeNo);
                                    dynamicParameters.Add("MoProcessId", MoProcessId);

                                    var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeProcessResult.Count() <= 0) throw new SystemException("此條碼【" + item.BarcodeNo + "】查無過站歷程!!");
                                    #endregion

                                    #region //若完工，自動解除治具綁定
                                    foreach (var item2 in BarcodeProcessResult)
                                    {
                                        if (item2.FinishDate != null)
                                        {
                                            #region //刪除主要table
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"DELETE MES.JigBarcode
                                            WHERE JigBarcodeId = @JigBarcodeId";
                                            dynamicParameters.Add("JigBarcodeId", item.JigBarcodeId);

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion

                                            #region //建立治具條碼歷史紀錄
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.JigBarcodeHistory (JigId, BarcodeNo, MoProcessId, WorkingFlag
                                            , CreateDate, CreateBy)
                                            OUTPUT INSERTED.HistoryId
                                            VALUES (@JigId, @BarcodeNo, @MoProcessId, @WorkingFlag
                                            , @CreateDate, @CreateBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    item.JigId,
                                                    item.BarcodeNo,
                                                    MoProcessId,
                                                    item.WorkingFlag,
                                                    CreateDate,
                                                    CreateBy = UserId
                                                });

                                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                            rowsAffected += insertResult.Count();
                                            #endregion
                                        }
                                    }
                                    #endregion

                                }
                            }
                            else // 非治具過站
                            {
                                #region //確認是否為Tray模式
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TrayBarcode
                                        FROM MES.MoSetting a
                                        WHERE MoId = @MoId";
                                dynamicParameters.Add("MoId", MoId);

                                var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                string TrayBarcode = "";
                                string Source = "";
                                foreach (var item2 in MoSettingResult)
                                {
                                    TrayBarcode = item2.TrayBarcode;
                                }

                                string TrayNo = "";
                                if (TrayBarcode == "Y")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeNo, a.TrayNo
                                            FROM MES.Tray a
                                            WHERE a.TrayNo = @TrayNo";
                                    dynamicParameters.Add("TrayNo", BarcodeNo);

                                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (TrayResult.Count() <= 0) throw new SystemException("查無此Tray盤(" + BarcodeNo + ")綁定的條碼資訊!");

                                    foreach (var item in TrayResult)
                                    {
                                        if (item.BarcodeNo != null) BarcodeNo = item.BarcodeNo;
                                        TrayNo = item.TrayNo;
                                    }
                                }
                                #endregion

                                int n;
                                bool isNumeric = int.TryParse(BarcodeNo, out n);

                                if (isNumeric == true)
                                {
                                    #region //判斷是否為刻字過站
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT d.BarcodeNo
                                        FROM MES.MoItemPart a
                                        INNER JOIN MES.BarcodeProcessAttribute b ON a.MoItemPartNo = b.ItemValue AND b.ItemNo = 'Lettering'
                                        INNER JOIN MES.BarcodeProcess c ON c.BarcodeProcessId = b.BarcodeProcessId
                                        INNER JOIN MES.Barcode d ON c.BarcodeId = d.BarcodeId
                                        WHERE a.MoItemPartId = @MoItemPartId
                                        AND a.MoId = @MoId";

                                    dynamicParameters.Add("MoItemPartId", BarcodeNo);
                                    dynamicParameters.Add("MoId", MoId);
                                    var AttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item in AttributeResult)
                                    {
                                        BarcodeNo = item.BarcodeNo;
                                    }
                                    #endregion
                                }

                                #region //將條碼轉成大寫
                                BarcodeNo = BarcodeNo.ToString().ToUpper();
                                #endregion

                                #region //判斷單顆過站時, 條碼不能被治具綁定狀態
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.JigNo
                                      FROM MES.JigBarcode a
                                           INNER JOIN MES.Jig b ON a.JigId = b.JigId
                                     WHERE a.JigId = b.JigId
                                       AND a.BarcodeNo = @BarcodeNo";

                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                var BarcodeJigCheck = sqlConnection.Query(sql, dynamicParameters);

                                if (BarcodeJigCheck.Count() > 0)
                                {
                                    throw new SystemException("條碼【" + BarcodeNo + "】被綁定在治具［" + sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JigNo + "］");
                                }
                                #endregion

                                #region //確認是否為試模製令及檢核相關卡控
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 a.MoMtlSettingId, a.MoProcessId BindMoProcessId, a.BindType
                                        FROM MES.MoMtlSetting a
                                        WHERE a.MoId = @MoId
                                        AND a.ProcessBinding = 'Y'
                                        AND a.MoProcessId = @MoProcessId
                                        AND a.MainBarcode = 'N'
                                        AND a.BindType != 'N'";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                var MoMtlSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MoMtlSettingResult.Count() > 0)
                                {
                                    foreach (var item in MoMtlSettingResult)
                                    {
                                        #region //確認是否為開工未完工狀態
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                                FROM MES.BarcodeProcess a
                                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                                WHERE a.MoProcessId = @MoProcessId
                                                AND b.BarcodeNo = @BarcodeNo
                                                AND FinishDate IS NULL";
                                        dynamicParameters.Add("MoProcessId", MoProcessId);
                                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion

                                        if (BarcodeProcessResult.Count() > 0)
                                        {
                                            if (item.BindType == "B")
                                            {
                                                #region //檢核組模時是否已將條碼都上料完成
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT Count(1) BarcodeComponent
                                                        , (
                                                          SELECT Count(1) Count
                                                          FROM MES.BarcodeComponent d
                                                          INNER JOIN MES.Barcode da ON d.ComponentBarcodeId = da.BarcodeId
                                                          WHERE da.MoId = c.MoId
                                                        ) RegisterCount
                                                        FROM MES.MrBarcodeRegister a
                                                        LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                                        LEFT JOIN MES.MrDetail c ON a.MrDetailId = c.MrDetailId
                                                        WHERE c.MoId = @MoId
                                                        GROUP BY c.MoId";
                                                dynamicParameters.Add("MoId", MoId);
                                                var mtlCountResult = sqlConnection.Query(sql, dynamicParameters);

                                                int RegisterCount = 0;
                                                foreach (var item2 in mtlCountResult)
                                                {
                                                    if (item.BindMoProcessId == MoProcessId && item2.RegisterCount <= 0) throw new SystemException("尚有模仁未做上料綁定，無法進行主條碼完工!!");
                                                    RegisterCount = item2.RegisterCount;
                                                }
                                                #endregion

                                                #region //檢核組模時屬性是否都已設定完成
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT a.ItemNo
                                                        FROM MES.MoMtlSettingAttribute a
                                                        WHERE a.MoMtlSettingId = @MoMtlSettingId";
                                                dynamicParameters.Add("MoMtlSettingId", item.MoMtlSettingId);

                                                var MoMtlSettingAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                                foreach (var item2 in MoMtlSettingAttributeResult)
                                                {
                                                    #region //取得目前上料條碼
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT a.BarcodeComponentId
                                                            , b.BarcodeNo
                                                            , c.ItemValue
                                                            FROM MES.BarcodeComponent a
                                                            INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                                            LEFT JOIN MES.BarcodeAttribute c ON b.BarcodeId = c.BarcodeId AND c.ItemNo = 'Lettering'
                                                            WHERE b.MoId = @MoId";
                                                    dynamicParameters.Add("MoId", MoId);

                                                    var BarcodeComponentIdResult = sqlConnection.Query(sql, dynamicParameters);
                                                    #endregion

                                                    foreach (var item3 in BarcodeComponentIdResult)
                                                    {
                                                        dynamicParameters = new DynamicParameters();
                                                        sql = @"SELECT TOP 1 1
                                                                FROM MES.BarcodeComponentAttribute a
                                                                WHERE a.BarcodeComponentId = @BarcodeComponentId
                                                                AND a.ItemNo = @ItemNo";
                                                        dynamicParameters.Add("BarcodeComponentId", item3.BarcodeComponentId);
                                                        dynamicParameters.Add("ItemNo", item2.ItemNo);

                                                        var BarcodeComponentAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                                        if (BarcodeComponentAttributeResult.Count() <= 0) throw new SystemException("條碼【" + item3.BarcodeNo + "(" + item3.ItemValue + ")】尚未完成屬性設定!!");
                                                    }
                                                }
                                                #endregion

                                                #region //若為最後一站拆模，則檢核是否條碼都已解除綁定
                                                //紘立無法使用，鏡頭上料會有問題
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TOP 1 1
                                                        FROM MES.MoProcess a
                                                        WHERE a.MoProcessId = @MoProcessId
                                                        AND a.SortNumber = (
                                                            SELECT MAX(x.SortNumber) SortNumber
                                                            FROM MES.MoProcess x
                                                            WHERE x.MoId = a.MoId
                                                        )";
                                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                                var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                                if (MoProcessResult.Count() > 0)
                                                {
                                                    if (RegisterCount != 0) throw new SystemException("尚有模仁尚未解除綁定，無法進行主條碼完工!!");
                                                }
                                                #endregion
                                            }
                                            else if (item.BindType == "L")
                                            {
                                                #region //先找出此製令用料下所有需批號上料之品號
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT b.MtlItemId
                                                        , c.MtlItemNo
                                                        FROM MES.MoMtlSetting a 
                                                        INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                                        INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                                        WHERE a.MoId = @MoId
                                                        AND a.ProcessBinding = 'Y'
                                                        AND a.MoProcessId = @MoProcessId
                                                        AND a.MainBarcode = 'N'
                                                        AND a.BindType = 'L'";
                                                dynamicParameters.Add("MoId", MoId);
                                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                                var MoMtlSettingResult2 = sqlConnection.Query(sql, dynamicParameters);

                                                if (MoMtlSettingResult2.Count() <= 0) throw new SystemException("查詢物料資料時發生錯誤!!");

                                                List<int> mtlItemIdList = new List<int>();
                                                List<int> errorMtlItemIdList = new List<int>();
                                                foreach (var item2 in MoMtlSettingResult2)
                                                {
                                                    #region //比對物料是否已上料
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT TOP 1 1
                                                            FROM MES.BarcodeComponent a
                                                            INNER JOIN SCM.LotNumber b ON a.LotNumberId = b.LotNumberId 
                                                            INNER JOIN MES.Barcode c ON a.AssemblyBarcodeId = c.BarcodeId
                                                            WHERE c.BarcodeNo = @BarcodeNo
                                                            AND a.MoProcessId = @MoProcessId
                                                            AND b.MtlItemId = @MtlItemId";
                                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                                    dynamicParameters.Add("MoProcessId", MoProcessId);
                                                    dynamicParameters.Add("MtlItemId", item2.MtlItemId);

                                                    var BarcodeComponentResult2 = sqlConnection.Query(sql, dynamicParameters);

                                                    if (BarcodeComponentResult2.Count() <= 0)
                                                    {
                                                        errorMtlItemIdList.Add(item2.MtlItemId);
                                                    }
                                                    else
                                                    {
                                                        mtlItemIdList.Add(item2.MtlItemId);
                                                    }
                                                    #endregion
                                                }
                                                #endregion

                                                #region //確認未在載盤上的物料是否已有其他關聯物料註冊
                                                foreach (var item2 in errorMtlItemIdList)
                                                {
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT a.MtlItemId, a.SubstitutionId
                                                            FROM MES.MrDetail a 
                                                            WHERE a.MtlItemId = @MtlItemId
                                                            AND a.MoId = @MoId";
                                                    dynamicParameters.Add("MtlItemId", item2);
                                                    dynamicParameters.Add("MoId", MoId);

                                                    var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                                    if (MrDetailResult.Count() <= 0) {
                                                        sql = @"SELECT *
                                                            FROM PDM.MtlItem a 
                                                            WHERE a.MtlItemId = @MtlItemId";
                                                        dynamicParameters.Add("MtlItemId", item2);
                                                        var item2MtlResult = sqlConnection.Query(sql, dynamicParameters);
                                                        var item2mtlno = "";
                                                        foreach (var item2mtl in item2MtlResult)
                                                        {
                                                            item2mtlno = item2mtl.MtlItemNo;
                                                        }
                                                        throw new SystemException("物料【" + item2mtlno + "】資料錯誤!! 無領料資訊!!");


                                                    }

                                                    foreach (var item3 in MrDetailResult)
                                                    {
                                                        #region //本身為替代料
                                                        if (item3.MtlItemId != item3.SubstitutionId)
                                                        {
                                                            if (mtlItemIdList.IndexOf(item3.SubstitutionId) == -1)
                                                            {
                                                                throw new SystemException("物料【" + item2 + "】尚未完成上料!!");
                                                            }
                                                        }
                                                        #region //本身為原BOM
                                                        else
                                                        {
                                                            dynamicParameters = new DynamicParameters();
                                                            sql = @"SELECT a.MtlItemId 
                                                                    FROM MES.MrDetail a 
                                                                    WHERE a.SubstitutionId = @MtlItemId 
                                                                    AND a.MtlItemId != a.SubstitutionId";
                                                            dynamicParameters.Add("MtlItemId", item2);

                                                            var SubResult = sqlConnection.Query(sql, dynamicParameters);

                                                            if (SubResult.Count() <= 0) throw new SystemException("物料【" + item2 + "】尚未完成上料!!");

                                                            bool checkFlag = false;
                                                            foreach (var item4 in SubResult)
                                                            {
                                                                if (mtlItemIdList.IndexOf(item4.MtlItemId) != -1)
                                                                {
                                                                    checkFlag = true;
                                                                    break;
                                                                }
                                                            }

                                                            if (!checkFlag) throw new SystemException("物料【" + item2 + "】尚未完成上料!!");
                                                        }
                                                        #endregion
                                                        #endregion
                                                    }
                                                }
                                                #endregion

                                                #region //檢核此主條碼是否已有綁定上料
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TOP 1 1
                                                        FROM MES.BarcodeComponent a 
                                                        INNER JOIN MES.Barcode b ON a.AssemblyBarcodeId = b.BarcodeId
                                                        WHERE b.BarcodeNo = @AssemblyBarcodeNo
                                                        AND a.MoProcessId = @MoProcessId";
                                                dynamicParameters.Add("AssemblyBarcodeNo", BarcodeNo);
                                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                                var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                                                if (BarcodeComponentResult.Count() <= 0) throw new SystemException("尚未綁定任一物料!!");
                                                #endregion
                                            }
                                            else
                                            {
                                                throw new SystemException("上料方式【" + item.BindType + "】錯誤!!");
                                            }
                                        }
                                    }
                                }

                                #endregion

                                TxBarcodeProcessCore(TrayNo.Length > 0 ? TrayNo : BarcodeNo, MoProcessId, MachineId, UserId,
                                    QtyBarcodeStatus, QtyLotNgCauseNo, QtyNextMoProcessId, sqlConnection, UserNo);
                            }
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                msg = "(" + rowsAffected + " rows affected)"
                            });
                            #endregion
                        }
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion]

        #region //TxBarcodeAttributeLog -- 現場NG模仁改刻字 (模仁改刻字置換介面) -- Yi 2023.09.19
        public string TxBarcodeAttributeLog(string BarcodeNo, int UserId)
        {
            if (BarcodeNo == "") throw new Exception("條碼不可為空");
            if (UserId == -1) throw new Exception("UserId 不可為空");

            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;

                        #region default
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #endregion

                        #region //取得Barcode資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 BarcodeId
                                FROM MES.Barcode
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("條碼資訊錯誤!");

                        int barcodeId = -1;
                        foreach (var item in result)
                        {
                            barcodeId = item.BarcodeId;
                        }
                        #endregion

                        #region //取得BarcodeProcessAttributeLog資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.ProcessAttrLogId, a.OriBarcodeId, a.NewBarcodeId, a.OriMoId, a.NewMoId, c.BpalDetailId
                                , c.Status
                                FROM MES.BarcodeProcessAttributeLog a
                                INNER JOIN MES.BarcodeAttribute b ON a.NewBarcodeId = b.BarcodeId
                                LEFT JOIN MES.BpalDetail c ON a.ProcessAttrLogId = c.ProcessAttrLogId AND b.BarcodeId = c.BarcodeId
                                WHERE a.NewItemNo = 'Lettering'
                                AND a.NewBarcodeId = @NewBarcodeId
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("NewBarcodeId", barcodeId);

                        var resultLog = sqlConnection.Query(sql, dynamicParameters);
                        if (resultLog.Count() <= 0) throw new SystemException("條碼置換歷程錯誤!");

                        int processAttrLogId = -1;
                        int newBarcodeId = -1;
                        int newMoId = -1;
                        int bpalDetailId = -1;
                        string statusLog = "";
                        foreach (var item in resultLog)
                        {
                            processAttrLogId = item.ProcessAttrLogId;
                            newBarcodeId = item.NewBarcodeId;
                            newMoId = item.NewMoId;
                            bpalDetailId = Convert.ToInt32(item.BpalDetailId);
                            statusLog = item.Status;
                        }
                        #endregion

                        #region //取得BarcodeProcessAttribute資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ItemValue, ItemSeq
                                FROM MES.BarcodeAttribute
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", newBarcodeId);

                        var resultValue = sqlConnection.Query(sql, dynamicParameters);
                        if (resultValue.Count() <= 0) throw new SystemException("條碼置換資訊錯誤!");

                        string itemValue = "";
                        int itemSeq = -1;
                        foreach (var item in resultValue)
                        {
                            itemValue = item.ItemValue;
                            itemSeq = item.ItemSeq;
                        }
                        #endregion

                        #region //取得BpalDetail資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 Status
                                FROM MES.BpalDetail
                                WHERE ProcessAttrLogId = @ProcessAttrLogId";
                        dynamicParameters.Add("ProcessAttrLogId", processAttrLogId);

                        var resultBpalDetail = sqlConnection.Query(sql, dynamicParameters);

                        string status = "";
                        foreach (var item in resultBpalDetail)
                        {
                            status = item.Status;
                        }

                        if (status == "Y")
                        {
                            throw new SystemException("條碼已完成置換!");
                        }
                        #endregion

                        if (processAttrLogId >= 0 && bpalDetailId <= 0 && (statusLog == null && statusLog != "Y"))
                        {
                            #region//新增條碼置換歷程單身(MES.BpalDetail)
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BpalDetail (ProcessAttrLogId, BarcodeId, MoId, Status
                                    , CreateDate, CreateBy)
                                    OUTPUT INSERTED.BpalDetailId
                                    VALUES (@ProcessAttrLogId, @BarcodeId, @MoId, @Status
                                    , @CreateDate, @CreateBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ProcessAttrLogId = processAttrLogId,
                                    BarcodeId = newBarcodeId,
                                    MoId = newMoId,
                                    Status = "A",
                                    CreateDate,
                                    CreateBy
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();
                            #endregion
                        }
                        else
                        {
                            #region//更新條碼置換歷程單身(MES.BpalDetail)
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.BpalDetail SET
                                    Status = @Status,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE ProcessAttrLogId = @ProcessAttrLogId";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                Status = "Y",
                                LastModifiedDate,
                                LastModifiedBy,
                                ProcessAttrLogId = processAttrLogId
                            });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = rowsAffected
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion]

        #region //TxKeyenceProcess -- Keyence模式過站入口
        public string TxKeyenceProcess(string BarcodeList, int MoProcessId, int MachineId, int UserId, int KeyenceId
            , string QtyBarcodeStatus, string QtyLotNgCauseNo, int QtyNextMoProcessId)
        {
            if (BarcodeList == "") throw new Exception("BarcodeNo 不可為空");
            if (MoProcessId == -1) throw new Exception("MoProcessId 不可為空");
            if (UserId == -1) throw new Exception("UserId 不可為空");

            if (QtyBarcodeStatus == "F")
            {
                if (QtyLotNgCauseNo.Length <= 0) throw new Exception("NG原因不能為空!");
                if (QtyNextMoProcessId <= 0) throw new Exception("下一站製程不能為空!");
            }

            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;

                        #region default
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #endregion

                        #region //解析BarcodeList，並批次過站
                        var BarcodeNoList = BarcodeList.Split(',');

                        foreach (var barcodeNo in BarcodeNoList)
                        {
                            string BarcodeNo = barcodeNo;

                            #region //判斷條碼是否在治具裡

                            sql = @"SELECT a.[Status] JigStatus,
                                           b.BarcodeNo,
	                                       b.MoProcessId
                                      FROM MES.Jig a
                                           LEFT JOIN MES.JigBarcode b ON a.JigId = b.JigId
                                     WHERE JigNo = @BarcodeNo
                                       AND b.WorkingFlag = 'Y'";

                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var JigBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (JigBarcodeResult.Count() > 0) //治具批量過站
                            {
                                foreach (var item in JigBarcodeResult)
                                {
                                    string JigStatus = item.JigStatus.ToString();
                                    if (JigStatus.Equals("S")) throw new SystemException("治具失效中,不可過站");

                                    string JigBarcodeNo = item.BarcodeNo.ToString();
                                    int JigMoProcessId = Convert.ToInt32(item.MoProcessId);

                                    #region //取得MOID
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT MoId FROM MES.MoProcess
                                        WHERE MoProcessId = @MoProcessId";
                                    dynamicParameters.Add("MoProcessId", MoProcessId);

                                    var MoIdResult = sqlConnection.Query(sql, dynamicParameters);

                                    int MoId = -1;
                                    foreach (var item2 in MoIdResult)
                                    {
                                        MoId = item2.MoId;
                                    }
                                    #endregion

                                    #region //確認是否為Tray模式
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.TrayBarcode, a.Source
                                        FROM MES.MoSetting a
                                        WHERE MoId = @MoId";
                                    dynamicParameters.Add("MoId", MoId);

                                    var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                    string TrayBarcode = "";
                                    string Source = "";
                                    foreach (var item2 in MoSettingResult)
                                    {
                                        TrayBarcode = item2.TrayBarcode;
                                        Source = item2.Source;
                                    }

                                    if (TrayBarcode == "Y" && Source == "MR")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeNo, a.TrayNo
                                                FROM MES.Tray a
                                                WHERE a.TrayNo = @TrayNo";
                                        dynamicParameters.Add("TrayNo", BarcodeNo);

                                        var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (TrayResult.Count() < 0) throw new SystemException("查無此Tray盤資訊!");

                                        string TrayNo = "";
                                        foreach (var item2 in TrayResult)
                                        {
                                            if (item.BarcodeNo == null) throw new SystemException("此Tray盤尚未綁定條碼!");
                                            TrayNo = item2.TrayNo;
                                            BarcodeNo = item2.BarcodeNo;
                                            JigBarcodeNo = item2.BarcodeNo;
                                        }
                                    }
                                    #endregion

                                    #region //判斷該治具是否可在此機台生產
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT 1
                                              FROM MES.Jig a
                                                   INNER JOIN MES.MachineJig b ON a.JigId = b.JigId
                                             WHERE a.JigNo = @BarcodeNo
                                               AND b.MachineId = @MachineId";

                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                    dynamicParameters.Add("MachineId", MachineId);
                                    var JigMachineCheck = sqlConnection.Query(sql, dynamicParameters);
                                    if (JigMachineCheck.Count() == 0) throw new SystemException("此治具不可在這機台生產!");
                                    #endregion

                                    TxBarcodeProcessCore(JigBarcodeNo, JigMoProcessId, MachineId, UserId,
                                        QtyBarcodeStatus, QtyLotNgCauseNo, QtyNextMoProcessId, sqlConnection, "");
                                }
                            }
                            else // 非治具過站
                            {
                                int n;
                                bool isNumeric = int.TryParse(BarcodeNo, out n);

                                #region //找MOID
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoId
                                        FROM MES.MoProcess a
                                        WHERE a.MoProcessId = @MoProcessId";
                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                var moProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                if (moProcessResult.Count() <= 0) throw new SystemException("查無此製令製程資訊!");

                                int MoId = -1;
                                foreach (var item in moProcessResult)
                                {
                                    MoId = item.MoId;
                                }
                                #endregion

                                if (isNumeric == true)
                                {
                                    #region //判斷是否為刻字過站
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT d.BarcodeNo
                                        FROM MES.MoItemPart a
                                        INNER JOIN MES.BarcodeProcessAttribute b ON a.MoItemPartNo = b.ItemValue AND b.ItemNo = 'Lettering'
                                        INNER JOIN MES.BarcodeProcess c ON c.BarcodeProcessId = b.BarcodeProcessId
                                        INNER JOIN MES.Barcode d ON c.BarcodeId = d.BarcodeId
                                        WHERE a.MoItemPartId = @MoItemPartId
                                        AND a.MoId = @MoId";

                                    dynamicParameters.Add("MoItemPartId", BarcodeNo);
                                    dynamicParameters.Add("MoId", MoId);
                                    var AttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item in AttributeResult)
                                    {
                                        BarcodeNo = item.BarcodeNo;
                                    }
                                    #endregion
                                }

                                #region //將條碼轉成大寫
                                BarcodeNo = BarcodeNo.ToString().ToUpper();
                                #endregion

                                #region //判斷單顆過站時, 條碼不能被治具綁定狀態
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.JigNo
                                      FROM MES.JigBarcode a
                                           INNER JOIN MES.Jig b ON a.JigId = b.JigId
                                     WHERE a.JigId = b.JigId
                                       AND a.BarcodeNo = @BarcodeNo";

                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                var BarcodeJigCheck = sqlConnection.Query(sql, dynamicParameters);

                                if (BarcodeJigCheck.Count() > 0)
                                {
                                    throw new SystemException("條碼【" + BarcodeNo + "】被綁定在治具［" + sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JigNo + "］");
                                }
                                #endregion

                                #region //確認是否為試模製令及檢核相關卡控
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoMtlSettingId, a.MoProcessId BindMoProcessId
                                    FROM MES.MoMtlSetting a
                                    WHERE a.MoId = @MoId
                                    AND a.ProcessBinding = 'Y'";
                                dynamicParameters.Add("MoId", MoId);

                                var MoMtlSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MoMtlSettingResult.Count() > 0)
                                {
                                    foreach (var item in MoMtlSettingResult)
                                    {
                                        #region //確認是否為開工未完工狀態
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                            FROM MES.BarcodeProcess a
                                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                            WHERE a.MoProcessId = @MoProcessId
                                            AND b.BarcodeNo = @BarcodeNo
                                            AND FinishDate IS NULL";
                                        dynamicParameters.Add("MoProcessId", MoProcessId);
                                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion

                                        if (BarcodeProcessResult.Count() > 0)
                                        {
                                            #region //檢核組模時是否已將條碼都上料完成
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT Count(1) BarcodeComponent
                                                , (
                                                  SELECT Count(1) Count
                                                  FROM MES.BarcodeComponent d
                                                  INNER JOIN MES.Barcode da ON d.ComponentBarcodeId = da.BarcodeId
                                                  WHERE da.MoId = c.MoId
                                                ) RegisterCount
                                                FROM MES.MrBarcodeRegister a
                                                LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                                LEFT JOIN MES.MrDetail c ON a.MrDetailId = c.MrDetailId
                                                WHERE c.MoId = @MoId
                                                GROUP BY c.MoId";
                                            dynamicParameters.Add("MoId", MoId);
                                            var mtlCountResult = sqlConnection.Query(sql, dynamicParameters);

                                            int RegisterCount = 0;
                                            foreach (var item2 in mtlCountResult)
                                            {
                                                if (item.BindMoProcessId == MoProcessId && item2.RegisterCount <= 0) throw new SystemException("尚有模仁未做上料綁定，無法進行主條碼完工!!");
                                                RegisterCount = item2.RegisterCount;
                                            }
                                            #endregion

                                            #region //檢核組模時屬性是否都已設定完成
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT a.ItemNo
                                                FROM MES.MoMtlSettingAttribute a
                                                WHERE a.MoMtlSettingId = @MoMtlSettingId";
                                            dynamicParameters.Add("MoMtlSettingId", item.MoMtlSettingId);

                                            var MoMtlSettingAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                            foreach (var item2 in MoMtlSettingAttributeResult)
                                            {
                                                #region 取得目前上料條碼
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT a.BarcodeComponentId
                                                    , b.BarcodeNo
                                                    , c.ItemValue
                                                    FROM MES.BarcodeComponent a
                                                    INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                                    LEFT JOIN MES.BarcodeAttribute c ON b.BarcodeId = c.BarcodeId AND c.ItemNo = 'Lettering'
                                                    WHERE b.MoId = @MoId";
                                                dynamicParameters.Add("MoId", MoId);

                                                var BarcodeComponentIdResult = sqlConnection.Query(sql, dynamicParameters);
                                                #endregion

                                                foreach (var item3 in BarcodeComponentIdResult)
                                                {
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT TOP 1 1
                                                        FROM MES.BarcodeComponentAttribute a
                                                        WHERE a.BarcodeComponentId = @BarcodeComponentId
                                                        AND a.ItemNo = @ItemNo";
                                                    dynamicParameters.Add("BarcodeComponentId", item3.BarcodeComponentId);
                                                    dynamicParameters.Add("ItemNo", item2.ItemNo);

                                                    var BarcodeComponentAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                                    if (BarcodeComponentAttributeResult.Count() <= 0) throw new SystemException("條碼【" + item3.BarcodeNo + "(" + item3.ItemValue + ")】尚未完成屬性設定!!");
                                                }
                                            }
                                            #endregion

                                            #region //若為最後一站拆模，則檢核是否條碼都已解除綁定
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1
                                                FROM MES.MoProcess a
                                                WHERE a.MoProcessId = @MoProcessId
                                                AND a.SortNumber = (
                                                    SELECT MAX(x.SortNumber) SortNumber
                                                    FROM MES.MoProcess x
                                                    WHERE x.MoId = a.MoId
                                                )";
                                            dynamicParameters.Add("MoProcessId", MoProcessId);
                                            var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                            if (MoProcessResult.Count() > 0)
                                            {
                                                if (RegisterCount != 0) throw new SystemException("尚有模仁尚未解除綁定，無法進行主條碼完工!!");
                                            }
                                            #endregion
                                        }
                                    }
                                }

                                #endregion

                                #region //確認是否為Tray模式
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TrayBarcode, a.Source
                                        FROM MES.MoSetting a
                                        WHERE MoId = @MoId";
                                dynamicParameters.Add("MoId", MoId);

                                var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                string TrayBarcode = "";
                                string Source = "";
                                foreach (var item2 in MoSettingResult)
                                {
                                    TrayBarcode = item2.TrayBarcode;
                                    Source = item2.Source;
                                }
                                string TrayNo = "";

                                if (TrayBarcode == "Y")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.BarcodeNo, a.TrayNo
                                                FROM MES.Tray a
                                                WHERE a.TrayNo = @TrayNo";
                                    dynamicParameters.Add("TrayNo", BarcodeNo);

                                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (TrayResult.Count() < 0) throw new SystemException("查無此Tray盤資訊!");

                                    foreach (var item2 in TrayResult)
                                    {
                                        //if (item2.BarcodeNo == null) throw new SystemException("此Tray盤尚未綁定條碼!");
                                        TrayNo = item2.TrayNo;
                                        BarcodeNo = item2.BarcodeNo;
                                    }
                                }
                                #endregion



                                #region //確認條碼資訊
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT BarcodeId
                                        FROM MES.Barcode
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                //if (BarcodeResult.Count() <= 0) throw new SystemException("條碼【" + BarcodeNo + "】資料錯誤!!");

                                int BarcodeId = -1;
                                if (BarcodeResult.Count() > 0)
                                {
                                    foreach (var item in BarcodeResult)
                                    {
                                        BarcodeId = item.BarcodeId;
                                    }

                                }
                            
                                #endregion

                                #region //紀錄KeyenceBarcodeLog
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.KeyenceBarcodeLog (KeyenceId, BarcodeId, MoProcessId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@KeyenceId, @BarcodeId, @MoProcessId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";

                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      KeyenceId,
                                      BarcodeId,
                                      MoProcessId,
                                      CreateDate,
                                      LastModifiedDate,
                                      CreateBy,
                                      LastModifiedBy
                                  });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                #endregion

                                TxBarcodeProcessCore(TrayNo.Length > 0 ? TrayNo : BarcodeNo, MoProcessId, MachineId, UserId,
                                    QtyBarcodeStatus, QtyLotNgCauseNo, QtyNextMoProcessId, sqlConnection, "");
                            }
                            #endregion
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion]

        #region //TxBarcodeProcessCore -- 過站核心功能
        public void TxBarcodeProcessCore(string BarcodeNo, int MoProcessId, int MachineId, int UserId, string QtyBarcodeStatus, string QtyLotNgCauseNo, int QtyNextMoProcessId,
            SqlConnection sqlConnection, string UserNo)
        {
            if (BarcodeNo == "") throw new Exception("BarcodeNo 不可為空");
            if (MoProcessId == -1) throw new Exception("MoProcessId 不可為空");
            if (UserId == -1) throw new Exception("UserId 不可為空");
            try
            {
                BarcodeNo = BarcodeNo.ToUpper();
                int rowsAffected = 0;
                Boolean NewBarcode = false;
                Boolean bInput = true; //條碼目前狀態 加工中 或 完工  
                string LotStatus = "N";//製令是否為批量製令
                string sAutoCompleted = "N";//該站是否自動完工
                string BarcodeCtrl = "N"; //判斷數量過站
                int DelayTime = 0;

                #region default
                int MoId = -1;
                int BarcodeId = -1;
                int BarcodeProcessId = -1;
                int CurrentMoProcessId = -1;//條碼目前的站別
                int CurrentSortNumber = 1; //條碼當前製程序號, 預設第一站
                int ProcessSortNumber = 0; //登入站別MoProcess的SortNumber
                int NextMoProcessId = -1;//條碼下一站
                int NextSortNumber = -1;//下一站製程序號
                int BarcodeQty = -1;
                int ModeId = -1; //生產模式
                int ModeShiftId = -1; //班別
                int FirstMoProcessId = -1; //首站MoProcessId
                string ProcessCheckStatus = ""; //是否需做工程檢
                string ProcessCheckType = ""; //若要工程檢, 抽檢或全檢
                string FirstProcessAlias = ""; //首站Alias Name
                string BarcodeStatus = "1";
                string CurrentProcessAlias = "", NextProcessAlias = "";
                string CurrentProdStatus = "";
                string PVTQCFlag = "";
                Boolean JumpFlag = false;
                string BarcodeSource = "";
                int MpcId = -1;
                string TrayBarcode = "N";
                string ProcessName = "";
                string ProcessNo = "";
                string NgToDisassembly = "";
                #endregion

                DynamicParameters dynamicParameters = new DynamicParameters();

                #region //Validation & Get Data

                #region //取得MoId
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT a.MoId, a.SortNumber
                        , b.ProcessNo
                        , c.NgToDisassembly
                        , e.DelayTime
                        FROM MES.MoProcess a
                        INNER JOIN MES.Process b ON a.ProcessId = b.ProcessId
                        INNER JOIN MES.MoSetting c ON a.MoId = c.MoId
                        INNER JOIN MES.ManufactureOrder d ON a.MoId = d.MoId
                        INNER JOIN MES.ProcessParameter e ON d.ModeId = e.ModeId AND e.ProcessId = a.ProcessId
                        WHERE a.MoProcessId = @MoProcessId";
                dynamicParameters.Add("MoProcessId", MoProcessId);

                var MoResult = sqlConnection.Query(sql, dynamicParameters);

                foreach (var item in MoResult)
                {
                    MoId = Convert.ToInt32(item.MoId);
                    ProcessSortNumber = Convert.ToInt32(item.SortNumber);
                    ProcessNo = item.ProcessNo;
                    NgToDisassembly = item.NgToDisassembly;
                    DelayTime = item.DelayTime;
                }
                #endregion

                #region //MO Validation & get MO Informations
                dynamicParameters = new DynamicParameters();
                //若McpId > 0 , 則需使用製程變更單之流程
                if (MpcId > 0)
                {
                    sql = @"SELECT c.MoProcessId,d.ProcessId,c.MoProcessId,
                                   e.PostCollectionStatus,e.PreCollectionStatus,
                                   e.PassingMode,e.NgToBarcode,
                                   g.BarcodeCtrl,g.LotStatus,h.FirstMoProcessId,h.FirstProcessAlias,
                                   a.ModeId, g.Source, g.PVTQCFlag, g.TrayBarcode
                              FROM MES.ManufactureOrder a
                                   INNER JOIN MES.MoProcessChange b ON a.MoId = b.MoId AND b.[Status] = 'A'
	                               INNER JOIN MES.MpcRoutingProcess c ON b.MpcId = c.MpcId
	                               INNER JOIN MES.MoProcess d ON c.MoProcessId = d.MoProcessId
	                               INNER JOIN MES.ProcessParameter e ON d.ProcessId = e.ProcessId and a.ModeId = e.ModeId
	                               INNER JOIN MES.ProdMode f ON a.ModeId = f.ModeId
	                               INNER JOIN MES.MoSetting g ON a.MoId = g.MoId
                                   LEFT JOIN (SELECT x.MoProcessId FirstMoProcessId,x.ProcessAlias FirstProcessAlias,x.MpcId 
                                               FROM MES.MpcRoutingProcess x  
                                               WHERE x.SortNumber = 1) h ON h.MpcId = b.MpcId
                             WHERE b.[Status] = 'A'
                               AND a.MoId = @MoId
                               AND c.MoProcessId = @MoProcessId";
                }
                else
                {
                    sql = @"SELECT b.MoProcessId,b.ProcessId,b.MoProcessId,
                                       c.PostCollectionStatus,c.PreCollectionStatus,
                                       c.PassingMode,c.NgToBarcode,
                                       e.BarcodeCtrl,e.LotStatus,f.FirstMoProcessId,f.FirstProcessAlias,
                                       a.ModeId, e.Source, e.PVTQCFlag, e.TrayBarcode
                                  FROM MES.ManufactureOrder a
                                       INNER JOIN MES.MoProcess b ON a.MoId=b.MoId
                                       INNER JOIN MES.ProcessParameter c ON b.ProcessId=c.ProcessId and a.ModeId = c.ModeId
                                       INNER JOIN MES.ProdMode d ON a.ModeId=d.ModeId
                                       INNER JOIN MES.MoSetting e ON a.MoId=e.MoId
                                       LEFT JOIN (SELECT x.MoProcessId FirstMoProcessId,x.ProcessAlias FirstProcessAlias,x.MoId 
                                                    FROM MES.MoProcess x  
                                                   WHERE x.SortNumber = 1) f ON f.MoId = a.MoId
                                 WHERE a.MoId = @MoId
                                   AND b.MoProcessId = @MoProcessId";

                }

                dynamicParameters.Add("MoId", MoId);
                dynamicParameters.Add("MoProcessId", MoProcessId);

                var MoResult1 = sqlConnection.Query(sql, dynamicParameters);
                if (MoResult1.Count() <= 0) throw new SystemException("製令相關資訊不存在!");
                foreach (var item in MoResult1)
                {
                    sAutoCompleted = item.PassingMode;
                    BarcodeCtrl = item.BarcodeCtrl; //Y代表為條碼過站, N代表無法用條碼過站(模造使用)
                    LotStatus = item.LotStatus; //是否批量製令
                    FirstMoProcessId = item.FirstMoProcessId;
                    FirstProcessAlias = item.FirstProcessAlias;
                    ModeId = item.ModeId;
                    BarcodeSource = item.Source;
                    PVTQCFlag = item.PVTQCFlag;
                    TrayBarcode = item.TrayBarcode;
                }
                #endregion

                #region //如果TrayBarcode = 'Y', 代表使用Tray承載產品, 將Barcode轉成TrayBarcode, 將BarcodePrint的Barcode置換當下BarcodeNo
                if (TrayBarcode.Equals("Y"))
                {

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TrayId,a.TrayNo,ISNULL(a.BarcodeNo,'NOBINDING') BarcodeNo,a.TrayCapacity
                          FROM MES.Tray a
                               LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                         WHERE a.TrayNo = @TrayNo
                           AND a.[Status] = 'A'
                           AND a.CompanyId = @CompanyId";

                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("TrayNo", BarcodeNo);
                    var TrayResult = sqlConnection.Query(sql, dynamicParameters);
                    if (TrayResult.Count() > 0)
                    {
                        int TrayId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TrayId);
                        #region //如果Tray盤有條碼用Tray盤條碼取代Barcode, 如果沒有, 找BarcodePrint裡沒綁定過的給一個條碼並註冊
                        if (!sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo.Equals("NOBINDING"))
                        {
                            BarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT Top 1 a.PrintId,a.BarcodeNo,a.BarcodeQty
                                  FROM MES.BarcodePrint a
                                       INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                 WHERE NOT EXISTS(SELECT 1
                                                    FROM MES.Tray c
				                                   WHERE a.BarcodeNo = c.BarcodeNo)
                                   AND b.MoId = @MoId AND a.PrintStatus != 'F'
                                 ORDER BY a.PrintId";
                            dynamicParameters.Add("MoId", MoId);
                            var TrayBarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);
                            if (TrayBarcodePrintResult.Count() > 0)
                            {
                                string PrintBarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;

                                #region //Update MES.Tray & Insert MES.TrayBarcodeLog, 然後將BarcodeNo 與TrayNo綁定
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Tray SET
                                               UseTimes = UseTimes + 1,
                                               BarcodeNo = @BarcodeNo,
                                               LastModifiedDate = @LastModifiedDate,
                                               LastModifiedBy = @LastModifiedBy
                                         WHERE TrayId = @TrayId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = PrintBarcodeNo,
                                        TrayId,
                                        LastModifiedDate = DateTime.Now,
                                        LastModifiedBy = UserId
                                    });
                                var updTrayResult = sqlConnection.Query(sql, dynamicParameters);

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.TrayBarcodeLog(TrayId,BarcodeNo,BindDate
                                    ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                    VALUES(@TrayId,@BarcodeNo,@BindDate
                                    ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        TrayId,
                                        BarcodeNo = PrintBarcodeNo,
                                        BindDate = DateTime.Now,
                                        CreateDate = DateTime.Now,
                                        LastModifiedDate = DateTime.Now,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });
                                var insertTrayBarcodeLogResult = sqlConnection.Query(sql, dynamicParameters);

                                BarcodeNo = PrintBarcodeNo;
                                #endregion
                            }
                            else
                            {
                                throw new SystemException("找不到條碼標籤設定!或是條碼已經全部綁定托盤了!請重新確認");
                            }
                        }
                        #endregion
                    }
                    else
                    {
                        throw new SystemException("找不到Tray【" + BarcodeNo + "】盤條碼資料!!!");
                    }
                }
                #endregion

                #region //取得MpcId, 如果條碼存在製令變更單, 則先給MpcId值
                dynamicParameters = new DynamicParameters();

                sql = @"SELECT a.MpcId
                          FROM MES.MoProcessChange a
	                           INNER JOIN MES.MpcBarcode c ON a.MpcId = c.MpcId
                         WHERE c.BarcodeNo = @BarcodeNo
                           AND a.[Status] = 'A'
                           AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                 FROM MES.MoProcessChange a1
					                                  INNER JOIN MES.MpcBarcode b1 ON a1.MpcId = b1.MpcId
					                            WHERE a.MpcId = a1.MpcId)";

                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                var MpcResult = sqlConnection.Query(sql, dynamicParameters);
                if (MpcResult.Count() > 0)
                {
                    MpcId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MpcId);
                }
                #endregion

                #region //檢核條碼是否在此製程有委外, 若委外需使用託外收貨
                dynamicParameters = new DynamicParameters();

                sql = @"SELECT a.OspNo
                            , b.OspDetailId
                            , (
                                SELECT TOP 1 x.OsrDetailId, x.ProcessStatus
                                FROM MES.OspReceiptDetail x
                                WHERE x.OspDetailId = c.OspDetailId
                                ORDER BY CreateDate 
                                FOR JSON PATH, ROOT('data')
                            ) OsrDetail
                          FROM MES.OutsourcingProduction a
                               INNER JOIN MES.OspDetail b ON a.OspId = b.OspId
	                           INNER JOIN MES.OspBarcode c ON b.OspDetailId = c.OspDetailId
                         WHERE c.BarcodeNo = @BarcodeNo
                           AND b.MoProcessId = @MoProcessId";

                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                dynamicParameters.Add("MoProcessId", MoProcessId);
                var OspResult = sqlConnection.Query(sql, dynamicParameters);
                int OspDetailId = -1;
                int OsrDetailId = -1;
                if (OspResult.Count() > 0)
                {
                    foreach (var item in OspResult)
                    {
                        string OspNo = item.OspNo;
                        OspDetailId = item.OspDetailId;

                        if (item.OsrDetail != null)
                        {
                            JObject ospDetailJson = JObject.Parse(item.OsrDetail);
                            foreach (var item2 in ospDetailJson["data"])
                            {
                                OsrDetailId = Convert.ToInt32(item2["OsrDetailId"]);
                                string ProcessStatus = item2["ProcessStatus"].ToString();
                                if (UserNo != "Z100" && ProcessStatus != "Y")
                                {
                                    throw new SystemException("此條碼當站已託外生產, 託外單號為:" + OspNo);
                                }
                            }
                        }
                    }
                }
                #endregion

                #region //領料檢核
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT a.TransferStatus
                          FROM MES.MaterialRequisition a
                               INNER JOIN MES.MrDetail b ON a.MrId = b.MrId
                         WHERE b.MoId = @MoId
                           AND a.TransferStatus = 'Y'";
                dynamicParameters.Add("MoId", MoId);
                var MoMrResult = sqlConnection.Query(sql, dynamicParameters);
                if (MoMrResult.Count() <= 0) throw new SystemException("製令找不到領料單拋轉記錄，請洽詢生管人員協助處理!!");

                #endregion

                #region //發料檢核
                if (!BarcodeCtrl.Equals("N"))
                {
                    dynamicParameters = new DynamicParameters();
                    if (BarcodeSource.Equals("BP"))
                    {
                        //有抓到Barcode以Barcode為主, 否則以BarcodePrint為主
                        sql = @"SELECT a.PrintId,c.MoId,a.BarcodeNo,ISNULL(d.BarcodeQty,a.BarcodeQty) BarcodeQty
                                      FROM MES.BarcodePrint a
                                           INNER JOIN MES.MoSetting b ON a.MoSettingId=b.MoSettingId
                                           INNER JOIN MES.ManufactureOrder c ON b.MoId=c.MoId
                                           LEFT JOIN MES.Barcode d ON a.BarcodeNo = d.BarcodeNo
                                 WHERE a.BarcodeNo = @BarcodeNo
                                   AND c.MoId = @MoId";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BarcodePrintResult.Count() <= 0) throw new SystemException("該條碼【" + BarcodeNo + "】不在製令條碼標籤設定!");
                        foreach (var item in BarcodePrintResult)
                        {
                            BarcodeQty = Convert.ToInt32(item.BarcodeQty);
                        }
                    }
                    else
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeRegisterId, a.BarcodeNo
                                , b.WoErpPrefix, b.WoErpNo
                                , e.TransferStatus
                                , ISNULL(f.BarcodeQty, 1) BarcodeQty
                                FROM MES.MrBarcodeRegister a
                                INNER JOIN MES.MrDetail b ON a.MrDetailId=b.MrDetailId
                                INNER JOIN MES.WoDetail c ON b.MtlItemId = c.MtlItemId
                                INNER JOIN MES.MoMtlSetting d ON b.MoId = d.MoId AND c.WoDetailId = d.WoDetailId
                                INNER JOIN MES.MaterialRequisition e ON b.MrId = e.MrId
                                LEFT JOIN MES.Barcode f ON a.BarcodeNo = f.BarcodeNo
                                WHERE a.BarcodeNo = @BarcodeNo
                                AND b.MoId = @MoId";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("MoId", MoId);

                        var BarcodeMtlResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BarcodeMtlResult.Count() > 0)
                        {
                            foreach (var item in BarcodeMtlResult)
                            {
                                if (item.TransferStatus != "Y") throw new SystemException("該條碼【" + BarcodeNo + "】領料單尚未拋單，無法開工!!");
                                BarcodeQty = item.BarcodeQty;
                            }
                        }
                        else
                        {
                            #region //判斷MES.Barcode有無資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeQty
                                    FROM MES.Barcode a 
                                    WHERE a.BarcodeNo = @BarcodeNo
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("MoId", MoId);

                            var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (BarcodeResult.Count() <= 0) throw new SystemException("該條碼【" + BarcodeNo + "】找不到發料資料或此條碼非主條碼!");

                            foreach (var item in BarcodeResult)
                            {
                                BarcodeQty = item.BarcodeQty;
                            }
                            #endregion
                        }
                    }
                }
                else
                {
                    //未來確認是否要抓領料單數量判斷
                }
                #endregion

                #region //Barcode Validation & get Barcode Informations
                if (BarcodeCtrl.Equals("Y"))
                {
                    #region //條碼控管模式

                    #region //判斷條碼有沒有在其他製程綁定治具未下治具
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT b.JigNo
                              FROM MES.JigBarcode a
                                   INNER JOIN MES.Jig b ON a.JigId = b.JigId
                             WHERE a.BarcodeNo = @BarcodeNo
                               AND a.MoProcessId != @MoProcessId";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var JigBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                    if (JigBarcodeResult.Count() > 0)
                    {
                        throw new SystemException("此產品條碼未從治具［" + sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JigName + "］拆下!!!");
                    }
                    #endregion

                    #region //判斷條碼目前是否在品異單
                    sql = @"SELECT Top 1 a.AqBarcodeId ,a.JudgeStatus 
                                FROM QMS.AqBarcode a
                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                INNER JOIN QMS.Abnormalquality c ON a.AbnormalqualityId = c.AbnormalqualityId AND b.MoId = c.MoId
                                WHERE b.BarcodeNo = @BarcodeNo
                                Order By a.JudgeDate DESC
                                ";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        string JudgeStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeStatus;
                        if (JudgeStatus == null)
                        {
                            throw new SystemException("該條碼【" + BarcodeNo + "】目前在品異單判定中，不可以輸入");
                        }
                        else if (JudgeStatus == "S")
                        {
                            throw new SystemException("該條碼【" + BarcodeNo + "】目前判定不良品，不可以輸入");
                        }
                    }
                    #endregion

                    #region //條碼製程檢核與取出條碼相關資訊
                    dynamicParameters = new DynamicParameters();
                    //若有製程變更單, 則流程抓變更單
                    if (MpcId > 0)
                    {
                        //sql = @"SELECT a.BarcodeId,a.CurrentMoProcessId,a.NextMoProcessId,a.BarcodeQty,a.BarcodeProcessId,
                        //               b.SortNumber CurrentSortNumber, ISNULL(c.SortNumber,1) NextSortNumber,
                        //               a.BarcodeStatus,a.CurrentProdStatus,
                        //               b.ProcessAlias CurrentProcessAlias, ISNULL(c.ProcessAlias,'') NextProcessAlias 
                        //          FROM MES.Barcode a
                        //               LEFT JOIN MES.MpcRoutingProcess b ON a.CurrentMoProcessId = b.MoProcessId AND b.MpcId = @MpcId
                        //            LEFT JOIN MES.MoProcess b1 ON b.MoProcessId = b1.MoProcessId
                        //               LEFT JOIN MES.MpcRoutingProcess c ON a.NextMoProcessId = c.MoProcessId AND c.MpcId = @MpcId
                        //               LEFT JOIN MES.ProcessParameter d ON b1.ProcessId = d.ProcessId AND d.ModeId = @ModeId
                        //         WHERE a.BarcodeNo = @BarcodeNo";

                        sql = @"SELECT a.BarcodeId,a.CurrentMoProcessId,b1.MoProcessId NextMoProcessId,
	                                   b.SortNumber CurrentSortNumber,b1.SortNumber NextSortNumber,
	                                   b.ProcessAlias CurrentProcessAlias,b1.ProcessAlias NextProcessAlias,
	                                   a.BarcodeStatus,a.CurrentProdStatus
                                  FROM MES.Barcode a, 
                                       MES.MpcRoutingProcess b,
	                                   MES.MpcRoutingProcess b1
                                 WHERE a.CurrentMoProcessId = b.MoProcessId
                                   AND b.MpcId = b1.MpcId
                                   AND b.MpcId = @MpcId
                                   AND a.BarcodeNo = @BarcodeNo
                                   AND b1.SortNumber = (SELECT MIN(b2.SortNumber)
                                                          FROM MES.MpcRoutingProcess b2
			 			                                 WHERE b1.MpcId = b2.MpcId
						                                   AND b2.NecessityStatus = 'Y'
						                                   AND b.SortNumber < b2.SortNumber)";

                        dynamicParameters.Add("MpcId", MpcId);
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        //dynamicParameters.Add("ModeId", ModeId);
                    }
                    else
                    {
                        sql = @"SELECT a.BarcodeId,a.CurrentMoProcessId,a.NextMoProcessId,a.BarcodeQty,a.BarcodeProcessId,
                                       b.SortNumber CurrentSortNumber, ISNULL(c.SortNumber,1) NextSortNumber,
                                       a.BarcodeStatus,a.CurrentProdStatus,
                                       b.ProcessAlias CurrentProcessAlias, ISNULL(c.ProcessAlias,'') NextProcessAlias
                                       , e.ProcessName
                                  FROM MES.Barcode a
                                       LEFT JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
                                       LEFT JOIN MES.MoProcess c ON a.NextMoProcessId = c.MoProcessId
                                       LEFT JOIN MES.ProcessParameter d ON b.ProcessId = d.ProcessId AND d.ModeId = @ModeId
                                       LEFT JOIN MES.Process e ON b.ProcessId = e.ProcessId
                                 WHERE a.BarcodeNo = @BarcodeNo";

                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("ModeId", ModeId);
                    }

                    var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                    if (BarcodeResult.Count() > 0) //有找到Barcode
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.BarcodeProcessId,b.MoProcessId
                                  FROM MES.Barcode a
                                       LEFT JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId
                                 WHERE a.BarcodeNo = @BarcodeNo 
                                   AND b.MoProcessId = a.CurrentMoProcessId
                                   AND b.FinishDate IS NULL ";

                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BarcodeProcessResult.Count() > 0) //找到BarcodeProcess, 代表已有開工資料
                        {
                            bInput = false;
                            foreach (var item in BarcodeProcessResult)
                            {
                                BarcodeProcessId = Convert.ToInt32(item.BarcodeProcessId);
                            }
                        }

                        foreach (var item in BarcodeResult)
                        {
                            NewBarcode = false;
                            BarcodeId = Convert.ToInt32(item.BarcodeId);
                            CurrentMoProcessId = Convert.ToInt32(item.CurrentMoProcessId);
                            NextMoProcessId = Convert.ToInt32(item.NextMoProcessId);
                            CurrentSortNumber = Convert.ToInt32(item.CurrentSortNumber);
                            NextSortNumber = Convert.ToInt32(item.NextSortNumber);
                            CurrentProcessAlias = item.CurrentProcessAlias.ToString();
                            NextProcessAlias = item.NextProcessAlias.ToString();
                            BarcodeStatus = item.BarcodeStatus.ToString();
                            CurrentProdStatus = item.CurrentProdStatus.ToString();
                            ProcessName = item.ProcessName;

                            //if (CurrentProdStatus.Equals("F")) throw new SystemException("該條碼【" + BarcodeNo + "】目前為不良品, 不可過站");

                            if (!BarcodeStatus.Equals("1")) throw new SystemException("條碼狀態非生產中!");

                            #region //判斷該條碼品異單是否有指定返回製程

                            #endregion

                            if (bInput)
                            {
                                //如果MoProcessId != NextMoProcessId, 再判斷是否可以跳至此站別
                                if (!MoProcessId.Equals(NextMoProcessId))
                                {
                                    dynamicParameters = new DynamicParameters();
                                    if (MpcId > 0)
                                    {
                                        sql = @"SELECT 1 
                                                  FROM MES.MpcRoutingProcess a
                                                 WHERE a.SortNumber > @CurrentSortNumber 
                                                   AND a.SortNumber < (SELECT a1.SortNumber
                                                                         FROM MES.MpcRoutingProcess a1
                                                                        WHERE a1.MoProcessId = @MoProcessId)
                                                   AND a.NecessityStatus = 'Y'
                                                   AND a.MpcId = @MpcId";

                                        dynamicParameters.Add("MpcId", MpcId);
                                        dynamicParameters.Add("CurrentSortNumber", CurrentSortNumber);
                                    }
                                    else
                                    {
                                        sql = @"SELECT 1 
                                                  FROM MES.MoProcess a
                                                 WHERE a.SortNumber > @CurrentSortNumber 
                                                   AND a.SortNumber < (SELECT a1.SortNumber
                                                                         FROM MES.MoProcess a1
                                                                        WHERE a1.MoProcessId = @MoProcessId)
                                                   AND a.NecessityStatus = 'Y'
                                                   AND a.MoId = @MoId";

                                        dynamicParameters.Add("CurrentSortNumber", CurrentSortNumber);
                                        dynamicParameters.Add("MoProcessId", MoProcessId);
                                        dynamicParameters.Add("MoId", MoId);
                                    }

                                    var ProcessJumpResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (ProcessJumpResult.Count() > 0)
                                    {
                                        JumpFlag = false;
                                    }
                                    else
                                    {
                                        sql = @"SELECT SortNumber
                                                  FROM MES.MoProcess
                                                 WHERE MoProcessId = @MoProcessId";
                                        dynamicParameters.Add("MoProcessId", MoProcessId);
                                        var thisSortResult = sqlConnection.Query(sql, dynamicParameters);
                                        int thisSortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);
                                        if (thisSortNumber < NextSortNumber)
                                        {
                                            //沒改過NextMoProcess不可往回跳站
                                            throw new SystemException("條碼【" + BarcodeNo + "】製程應為【" + NextProcessAlias + "】");
                                        }
                                        else
                                        {
                                            JumpFlag = true;
                                        }                                        
                                    }

                                    if (!JumpFlag)
                                    {
                                        throw new SystemException("條碼【" + BarcodeNo + "】製程應為【" + NextProcessAlias + "】");
                                    }

                                    if (!MoProcessId.Equals(NextMoProcessId) && !JumpFlag) throw new SystemException("該條碼製程為【" + NextProcessAlias + "】");

                                    if (!MoProcessId.Equals(NextMoProcessId) && CurrentSortNumber.Equals(NextSortNumber)) throw new SystemException("該條碼製程為【" + NextProcessAlias + "】");

                                    if (MoProcessId.Equals(CurrentMoProcessId)) throw new SystemException("該條碼製程為【" + NextProcessAlias + "】");

                                }
                            }
                            else
                            {
                                //完工應該一律檢查MoProcessId 是不是等於目前條碼Next即可
                                if (!MoProcessId.Equals(CurrentMoProcessId))
                                {

                                    throw new SystemException("條碼製程應為【" + CurrentProcessAlias + "】!");
                                }
                            }
                        }

                    }
                    else //找不到Barcode
                    {
                        NewBarcode = true;
                        if (!MoProcessId.Equals(FirstMoProcessId)) throw new SystemException("製程錯誤, 應做首站製程!");
                        bInput = true;
                    }

                    if (!bInput)
                    {
                        #region //抓取NextMoProcessId, 以品異單返回為優先
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.AbnormalqualityNo,b.JudgeReturnMoProcessId,b.JudgeReturnNextMoProcessId,
                                       a.MoProcessId
                                  FROM QMS.Abnormalquality a
                                       INNER JOIN QMS.AqBarcode b ON a.AbnormalqualityId = b.AbnormalqualityId
	                                   INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                                 WHERE a.AbnormalqualityId = b.AbnormalqualityId
                                   AND b.CreateDate = (SELECT MAX(b2.CreateDate)
                                                         FROM QMS.AqBarcode b2
						                                WHERE b.BarcodeId = b2.BarcodeId)
                                   AND b.JudgeReturnMoProcessId = @MoProcessId
                                   AND c.BarcodeNo = @BarcodeNo
                                   AND b.JudgeStatus = 'RW'
                                   AND c.CurrentProdStatus = 'P'";

                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var AqBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (AqBarcodeResult.Count() > 0)
                        {
                            NextMoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeReturnNextMoProcessId);
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();

                            if (MpcId > 0)
                            {
                                //條碼在製程變更單中下製程ID
                                sql = @"SELECT b.MoProcessId
                                              FROM MES.MoProcessChange a
                                                   INNER JOIN MES.MpcRoutingProcess b ON a.MpcId = b.MpcId
                                             WHERE a.MpcId = @MpcId
                                               AND a.[Status] = 'A'
                                               AND b.SortNumber = (SELECT MIN(b1.SortNumber)
                                                                     FROM MES.MpcRoutingProcess b1
						                                            WHERE a.MpcId = b.MpcId
						                                              AND b1.SortNumber > @ProcessSortNumber)";

                                dynamicParameters.Add("MpcId", MpcId);
                                dynamicParameters.Add("ProcessSortNumber", ProcessSortNumber);
                                var BarcodeNextProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                if (BarcodeNextProcessResult.Count() > 0)
                                {
                                    foreach (var item in BarcodeNextProcessResult)
                                    {
                                        NextMoProcessId = Convert.ToInt32(item.MoProcessId);
                                    }
                                }
                                else
                                {
                                    NextMoProcessId = -1;
                                    //BarcodeStatus = "0"; //Barcode Process Completed
                                }
                            }
                            else
                            {
                                sql = @"SELECT a.MoProcessId
                                          FROM MES.MoProcess a
                                         WHERE a.MoId = @MoId
                                           AND a.SortNumber = (SELECT MIN(a1.SortNumber)
                                                                 FROM MES.MoProcess a1
						                                        WHERE a.MoId = a1.MoId
						                                          AND a1.SortNumber > (SELECT a2.SortNumber 
						                                                                 FROM MES.MoProcess a2 
												                                        WHERE a2.MoProcessId = @MoProcessId))";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MoProcessId", MoProcessId);
                            }

                            var NextProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in NextProcessResult)
                            {
                                NextMoProcessId = Convert.ToInt32(item.MoProcessId);
                            }
                        }
                        #endregion

                    }
                    #endregion

                    #region //判斷BarcodeProcess裡此MoProcess裡有沒有CurrentProdStatus = 'F','SR','RW'
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT 1
                              FROM MES.MoProcess a
                                   INNER JOIN MES.BarcodeProcess b ON a.MoProcessId = b.MoProcessId
                                   INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                             WHERE a.MoProcessId = @MoProcessId
                               AND c.CurrentProdStatus IN ('F','SR','RW')";

                    dynamicParameters.Add("MoProcessId", MoProcessId);

                    var CurrentProdStatusCheck = sqlConnection.Query(sql, dynamicParameters);
                    if (CurrentProdStatusCheck.Count() > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT 1
                                  FROM MES.Barcode a                                   
                                 WHERE a.NextMoProcessId = @MoProcessId
                                   AND a.CurrentProdStatus IN ('SR','RW','P')
                                   AND a.BarcodeNo = @BarcodeNo";

                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var BarcodeProdStatus = sqlConnection.Query(sql, dynamicParameters);
                        if (BarcodeProdStatus.Count() == 0 && !LotStatus.Equals("Y"))
                        {
                            throw new SystemException("此製程存在不良品未處理結束, 不可繼續加工!");
                        }
                    }
                    #endregion

                    #region //判斷條碼是否還在加工事件中尚未結束
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 c.ProcessEventName
                            FROM MES.BarcodeProcessEvent a 
                            INNER JOIN MES.BarcodeProcess b ON a.BarcodeProcessId = b.BarcodeProcessId
                            INNER JOIN MES.ProcessEventItem c ON a.ProcessEventItemId = c.ProcessEventItemId
                            WHERE b.BarcodeId = @BarcodeId
                            AND a.FinishDate IS NULL";
                    dynamicParameters.Add("BarcodeId", BarcodeId);

                    var BarcodeProcessEventResult = sqlConnection.Query(sql, dynamicParameters);

                    if (BarcodeProcessEventResult.Count() > 0)
                    {
                        foreach (var item in BarcodeProcessEventResult)
                        {
                            throw new SystemException("條碼【" + BarcodeNo + "】尚有事件【" + item.ProcessEventName + "】未結束，無法執行下一動作!!");
                        }
                    }
                    #endregion

                    #region //判斷機台事件是否還沒結束
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 b.MachineEventName, c.MachineDesc
                            FROM MES.MachineEvent a 
                            INNER JOIN MES.MachineEventItem b ON a.MachineEventItemId = b.MachineEventItemId
                            INNER JOIN MES.Machine c ON b.MachineId = c.MachineId
                            WHERE b.MachineId = @MachineId
                            AND a.FinishDate IS NULL";
                    dynamicParameters.Add("MachineId", MachineId);

                    var MachineEventResult = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in MachineEventResult)
                    {
                        throw new SystemException("機台【" + item.MachineDesc + "】尚有事件【" + item.MachineEventName + "】未結束，無法執行下一動作!!");
                    }
                    #endregion

                    #region //確認此條碼是否有刻字置換資料未確認(鍍鎳站除外)
                    if (ProcessNo != "JMO-IE-0014" && ProcessNo != "JMO-JC-0008")
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.OriBarcodeAttrId, a.NewBarcodeAttrId
                                , b.[Status]
                                , (
                                    SELECT TOP 1 1
                                    FROM MES.BarcodeProcess x 
                                    WHERE x.BarcodeId = @BarcodeId
                                    AND x.FinishDate IS NULL
                                ) CheckBarcodeProcess
                                FROM MES.BarcodeProcessAttributeLog a 
                                LEFT JOIN MES.BpalDetail b ON a.ProcessAttrLogId = b.ProcessAttrLogId
                                WHERE a.NewBarcodeId = @BarcodeId
                                ORDER BY a.CreateDate DESC";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var BarcodeProcessAtrLogResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in BarcodeProcessAtrLogResult)
                        {
                            if (item.OriBarcodeAttrId != item.NewBarcodeAttrId)
                            {
                                if (item.Status != "Y" && item.CheckBarcodeProcess == null)
                                {
                                    throw new SystemException("條碼【" + BarcodeNo + "】已被置換，請實際執行重新刻字的動作後再進行後續過站!!");
                                }
                            }
                        }
                    }
                    #endregion

                    #region //判斷是否為拆料模式
                    if (NgToDisassembly == "Y" && (CurrentProdStatus == "F" || CurrentProdStatus == "S"))
                    {
                        throw new SystemException("條碼【" + BarcodeNo + "】狀態非良品，且此製令已設定為【拆料模式】，NG品無法繼續過站!!");
                    }
                    #endregion

                    #region //判斷條碼是否為送測中尚未量測完成
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT b.QcRecordId
                            FROM MES.QcReceiptBarcode a 
                            INNER JOIN MES.QcRecord b ON a.QcRecordId = b.QcRecordId
                            INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                            INNER JOIN MES.ManufactureOrder d ON b.MoId = d.MoId
                            INNER JOIN MES.ProdMode e ON d.ModeId = e.ModeId
                            WHERE b.CheckQcMeasureData != 'Y'
                            AND b.CheckQcMeasureData != 'P'
                            AND b.CheckQcMeasureData != 'F'
                            AND c.BarcodeNo = @BarcodeNo
                            AND e.CompanyId = @CompanyId";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var QcReceiptBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                    if (QcReceiptBarcodeResult.Count() > 0)
                    {
                        foreach (var item in QcReceiptBarcodeResult)
                        {
                            throw new SystemException("條碼【" + BarcodeNo + "】尚有量測單據【" + item.QcRecordId + "】未完成，無法開工或完工!!");
                        }
                    }
                    #endregion
                    
                    #endregion
                }

                #endregion

                #region //檢核出貨檢設定, (MoSetting.PVTQCFlag = Y), 沒出貨檢Pass資訊不可過站
                if (PVTQCFlag.Equals("Y"))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT 1
                              FROM MES.ManufactureOrder a
                                   INNER JOIN MES.QcRecord b ON a.MoId = b.MoId
                             WHERE a.MoId = @MoId
                               AND b.QcStatus = 'P'
                               AND b.QcType = 'PVTQC'
                               AND b.CreateDate = (SELECT MAX(b1.CreateDate)
                                                     FROM MES.QcRecord b1
						                            WHERE b.MoId = b1.MoId
						                              AND b1.QcType = 'PVTQC')";
                    dynamicParameters.Add("MoId", MoId);
                    var OqcResult = sqlConnection.Query(sql, dynamicParameters);
                    if (OqcResult.Count() <= 0) throw new SystemException("找不到試檢量測良品記錄!!!");

                }
                #endregion

                #region //確認是否有做工程檢, 確認是否有做製程屬性資料維護(穴號/刻字)
                #region //取得MoId
                dynamicParameters = new DynamicParameters();

                sql = @"SELECT ISNULL(ProcessCheckStatus,'N') ProcessCheckStatus, ISNULL(ProcessCheckType,'N') ProcessCheckType
                          FROM MES.MoProcess
                         WHERE MoProcessId = @CurrentMoProcessId";

                dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                var ProcessCheckResult = sqlConnection.Query(sql, dynamicParameters);
                if (ProcessCheckResult.Count() > 0)
                {
                    ProcessCheckStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessCheckStatus;
                    ProcessCheckType = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessCheckType;
                }
                #endregion

                //MoProcess.ProcessCheckStatus = 'Y'才要檢核, 檢核後需判斷ProcessCheckType 1(全檢),2(抽檢)
                if (BarcodeCtrl.Equals("Y") && bInput && !FirstMoProcessId.Equals(MoProcessId))
                {

                    #region //如果條碼經過品異返修或跳站則不檢核
                    if (CurrentSortNumber.Equals(NextSortNumber - 1) && !MoProcessId.Equals(FirstMoProcessId))
                    {

                        #region //前製程需做工程檢, 所以要檢核前置程工程檢結果
                        if (ProcessCheckStatus.Equals("Y") && !CurrentMoProcessId.Equals(MoProcessId)) //前置程需做工程檢, 所以要檢核前置程工程檢結果
                        {
                            if (ProcessCheckType.Equals("1"))
                            {
                                //全檢檢核
                                #region //檢核工程檢資訊, 如果找不到前置程工程檢為Pass or 品異單放行則報錯
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.QcStatus
                                          FROM MES.QcRecord a
                                               INNER JOIN MES.QcBarcode b ON a.QcRecordId = b.QcRecordId
                                         WHERE a.MoProcessId = @CurrentMoProcessId
                                           AND b.BarcodeId = @BarcodeId
                                           AND b.QcStatus = 'P'";

                                dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                                dynamicParameters.Add("BarcodeId", BarcodeId);
                                var QcStatusResult = sqlConnection.Query(sql, dynamicParameters);
                                if (QcStatusResult.Count() <= 0)
                                {
                                    throw new SystemException("前置程【" + CurrentProcessAlias + "】此條碼未有工程檢量測良品記錄,此製程不可加工!");
                                }
                                #endregion
                            }
                            else
                            {
                                //抽檢檢核
                                #region //檢核工程檢資訊, 如果找不到前置程工程檢為Pass or 品異單放行則報錯

                                //找出此Barcode最後一次完工FinishDate is not null的BarcodeProcessId, 看有沒有做工程檢
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.QcStatus
                                          FROM MES.QcRecord a
                                               INNER JOIN MES.QcBarcode b ON a.QcRecordId = b.QcRecordId
                                         WHERE a.MoProcessId = @CurrentMoProcessId
                                           AND b.QcStatus = 'P'";

                                dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                                var QcStatusResult = sqlConnection.Query(sql, dynamicParameters);
                                if (QcStatusResult.Count() <= 0)
                                {
                                    throw new SystemException("前置程【" + CurrentProcessAlias + "】未有工程檢量測良品記錄,此製程不可加工!");
                                }
                                #endregion
                            }
                        }
                        #endregion

                        #region //檢查此製令製程是否有品異單，且為工程檢
                        dynamicParameters = new DynamicParameters();
                        sql = @"";
                        #endregion

                        #region //確認前置程是否有設定製程屬性
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT d.ItemNo,e.TypeDesc
                                  FROM MES.WipOrder a
                                       INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
	                                   INNER JOIN MES.MoProcess c ON b.MoId = c.MoId
	                                   INNER JOIN MES.MoProcessItem d ON c.MoProcessId = d.MoProcessId
	                                   INNER JOIN BAS.[Type] e ON d.ItemNo = e.TypeNo AND e.TypeSchema = 'RoutingProcessItem.ItemNo'
                                 WHERE c.MoProcessId = @CurrentMoProcessId";

                        dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                        var ProcessAttributeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (ProcessAttributeResult.Count() > 0)
                        {
                            string AttributeItemNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ItemNo;
                            string AttributeItemName = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TypeDesc;

                            #region //確認條碼屬性是否有維護
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.BarcodeAttribute a 
                                    WHERE a.MoId = @MoId
                                    ANd a.BarcodeId = @BarcodeId
                                    AND a.ItemNo = @ItemNo";
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("BarcodeId", BarcodeId);
                            dynamicParameters.Add("ItemNo", AttributeItemNo);

                            var BarcodeAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (BarcodeAttributeResult.Count() <= 0) throw new SystemException("條碼【" + BarcodeNo + "】前製程需維護【" + AttributeItemName + "】尚未維護!");
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT c.BarcodeNo
                                      FROM MES.BarcodeProcess a
                                           INNER JOIN MES.BarcodeProcessAttribute b ON a.BarcodeProcessId = b.BarcodeProcessId
	                                       INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                     WHERE c.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var BarcodeProcessItemAttributeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (BarcodeProcessItemAttributeResult.Count() == 0) throw new SystemException("條碼前製程需維護【" + AttributeItemName + "】尚未維護!");
                        }
                        #endregion

                    }
                    #endregion

                }

                #endregion

                #region //取出班別ID
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT a.ModeShiftId
                                  FROM MES.ProdModeShift a
                                       INNER JOIN BAS.[Shift] b ON a.ShiftId = b.ShiftId
                                WHERE a.ModeId = @ModeId
                                AND ((format(CONVERT(datetime,CONVERT(VARCHAR(10),CONVERT(DATE,GETDATE()),120) + ' ' + @CurrentTime),'HH:mm') between b.WorkBeginTime and b.WorkEndTime) or
                                     (format(dateadd(hour,12,CONVERT(datetime,CONVERT(VARCHAR(10),CONVERT(DATE,GETDATE()),120) + ' ' + @CurrentTime)),'HH:mm') between b.WorkBeginTime and b.WorkEndTime)
                                    )";
                dynamicParameters.Add("ModeId", ModeId);
                dynamicParameters.Add("CurrentTime", DateTime.Now.ToString("HH:mm"));

                var resultShift = sqlConnection.Query(sql, dynamicParameters);
                if (resultShift.Count() <= 0) throw new SystemException("找不到班別!");

                foreach (var item in resultShift)
                {
                    ModeShiftId = Convert.ToInt32(item.ModeShiftId);
                }
                #endregion

                #region //如果有機台膠水綁膠水紀錄
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT TOP 1 b.MachineConsumeLogId
                            , e.MoMtlSettingId
							, b.EXPs, b.MaxDispenseQty, b.AllowDispenseQty
                            , FORMAT(b.BindDate, 'yyyy-MM-dd') BindDate
							, FORMAT(b.OpeningDate, 'yyyy-MM-dd') OpeningDate
                            FROM MES.Machine a 
                            LEFT JOIN MES.MachineConsumeLog b ON a.MachineId = b.MachineId AND b.UnBindDate IS NULL 
                            LEFT JOIN SCM.LotNumber c ON b.LotNumberId = c.LotNumberId
                            LEFT JOIN MES.WoDetail d ON c.MtlItemId = d.MtlItemId
                            LEFT JOIN MES.MoMtlSetting e ON d.WoDetailId = e.WoDetailId AND e.MoId = @MoId
                            LEFT JOIN PDM.MtlItem f ON c.MtlItemId = f.MtlItemId
                            WHERE a.MachineId = @MachineId 
                            AND (
                                b.MachineId IS NULL 
                                OR (b.MachineId IS NOT NULL AND e.MoId IS NOT NULL)
                            )
                            ORDER BY b.MachineConsumeLogId DESC ";
                dynamicParameters.Add("MoId", MoId);
                dynamicParameters.Add("MachineId", MachineId);
                var consumeresult = sqlConnection.Query(sql, dynamicParameters);
                int AllowDispenseQty = -1;
                int MachineConsumeLogId = -1;

                if (consumeresult.Count() > 0)
                {
                    #region //先檢查次數是否超過(已點+BarcodeQty)
                    foreach (var item in consumeresult)
                    {
                        if (item.MachineConsumeLogId != null) {
                            var allowDispenseQty = item.AllowDispenseQty != null ? item.AllowDispenseQty : 0;
                            if ((allowDispenseQty + BarcodeQty) > item.MaxDispenseQty) throw new SystemException("該膠水剩餘次數無法滿足本次點膠! ");
                            AllowDispenseQty = item.AllowDispenseQty != null ? item.AllowDispenseQty : 0; ;
                            MachineConsumeLogId = item.MachineConsumeLogId;
                        }
                        

                    }
                    #endregion
                }
                #endregion

                #region //如果有綁定鏡頭條碼
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT BarcodeId
                        FROM MES.Barcode a
                        WHERE a.ParentBarcode = @ParentBarcode ";
                dynamicParameters.Add("ParentBarcode", BarcodeId);
                var lensresult = sqlConnection.Query(sql, dynamicParameters);
                
                #endregion
                #endregion

                #region //過站Process
                //BarcodeCtrl: Y-->過站要刷條碼, N-->過站輸入數量
                if (BarcodeCtrl.Equals("Y"))//條碼過站
                {
                    if (bInput) //開工
                    {
                        #region//確認開工時間是否符合等待時間
                        //是否為已經有過站紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId=b.BarcodeId
                                WHERE b.BarcodeNo=@BarcodeNo
                                ";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BarcodeProcessResult.Count() > 0)
                        {
                            int CycleTime = 0;
                            int MoveTime = 0;
                            int WatingTime = 0;
                            int ProcessingTime = 0;
                            //取得等待設定時間
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT ISNULL(d.CycleTime,0) CycleTime,ISNULL(d.MoveTime,0)MoveTime ,ISNULL(d.ProcessingTime,0) ProcessingTime,ISNULL(d.WatingTime,0) WatingTime
                            FROM MES.MoProcess a 
                            INNER JOIN MES.RoutingProcess b ON a.RoutingProcessId=b.RoutingProcessId
                            INNER JOIN MES.MoRouting c ON a.MoId=c.MoId
                            INNER JOIN MES.RoutingItemProcess d ON d.RoutingProcessId=b.RoutingProcessId AND d.RoutingItemId=c.RoutingItemId
                            WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            var RoResult = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in RoResult)
                            {
                                CycleTime = Convert.ToInt32(item.CycleTime);//標準工時
                                MoveTime = Convert.ToInt32(item.MoveTime);//當站完工至下站移轉時間                                
                                ProcessingTime = Convert.ToInt32(item.ProcessingTime);//標準工時上下公差
                                WatingTime = Convert.ToInt32(item.WatingTime);//當前站的最小前置時間
                            }

                            if (ProcessingTime>0 && WatingTime > 0) {
                                //取得前一站完工時間
                                string beforeFinishDate = "";
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT FORMAT(a.StartDate,'yyyy-MM-dd HH:mm:ss') StartDate
                                        ,FORMAT(a.FinishDate,'yyyy-MM-dd HH:mm:ss') FinishDate
                                        FROM MES.BarcodeProcess a
                                        WHERE a.BarcodeProcessId=(
                                        SELECT MAX(x.BarcodeProcessId)
                                        FROM MES.BarcodeProcess x
                                        INNER JOIN MES.Barcode y ON x.BarcodeId=y.BarcodeId
                                        WHERE y.BarcodeNo=@BarcodeNo
                                    )";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                var DateResult = sqlConnection.Query(sql, dynamicParameters);
                                foreach (var item in DateResult)
                                {
                                    beforeFinishDate = item.FinishDate;//上站完工時間
                                }
                                string nowDateTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                                DateTime dt_end = Convert.ToDateTime(nowDateTime);//當下時間
                                DateTime dt_start = Convert.ToDateTime(beforeFinishDate);
                                DateTime nextAvailableWorkTime = dt_start.AddSeconds(ProcessingTime + WatingTime); 
                                if (nextAvailableWorkTime> dt_end) throw new Exception("預計【" + nextAvailableWorkTime.ToString() + "】才可開工");
                            }
                        }
                        #endregion

                        if (NewBarcode)//先新增Barcode
                        {
                            #region //Insert New Barcode
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty
                                                ,CurrentProdStatus,BarcodeStatus, BarcodeProcessId
                                                ,CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.BarcodeId
                                                VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty
                                                , @CurrentProdStatus, @BarcodeStatus, @BarcodeProcessId
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeNo,
                                    CurrentMoProcessId = MoProcessId,
                                    NextMoProcessId,
                                    MoId,
                                    BarcodeQty,
                                    CurrentProdStatus = "P",
                                    BarcodeStatus = 1,
                                    BarcodeProcessId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });
                            var insertResult1 = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in insertResult1)
                            {
                                BarcodeId = Convert.ToInt32(item.BarcodeId);
                            }
                            #endregion
                        }

                        if (sAutoCompleted.Equals("Y") || sAutoCompleted.Equals("S"))//自動完工
                        {
                            #region //Insert BarcodeProcess, 自動完工要壓上FinishDate
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId
                                                ,ProdStatus, StationQty,PassQty
                                                ,NgQty,StartDate,FinishDate
                                                ,ModeShiftId,CycleTime,StartUserId
                                                ,FinishUserId
                                                ,CreateDate, CreateBy)
                                                OUTPUT INSERTED.BarcodeProcessId
                                                VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId
                                                ,@ProdStatus, @StationQty, @PassQty
                                                ,@NgQty, @StartDate, @FinishDate
                                                ,@ModeShiftId, @CycleTime, @StartUserId
                                                ,@FinishUserId
                                                ,@CreateDate, @CreateBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeId,
                                    MoId,
                                    MachineId,
                                    MoProcessId,
                                    ProdStatus = "P",
                                    StationQty = BarcodeQty,
                                    PassQty = BarcodeQty,
                                    NgQty = 0,
                                    StartDate = DateTime.Now,
                                    FinishDate = DateTime.Now,
                                    ModeShiftId,
                                    CycleTime = 0,
                                    StartUserId = UserId,
                                    FinishUserId = UserId,
                                    CreateDate,
                                    CreateBy = UserId
                                });
                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in insertResult2)
                            {
                                BarcodeProcessId = Convert.ToInt32(item.BarcodeProcessId);
                            }
                            #endregion

                            #region //如果自動完工, 則取出下一站MoProcessId
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.AbnormalqualityNo,b.JudgeReturnMoProcessId,b.JudgeReturnNextMoProcessId,
                                       a.MoProcessId
                                  FROM QMS.Abnormalquality a
                                       INNER JOIN QMS.AqBarcode b ON a.AbnormalqualityId = b.AbnormalqualityId
	                                   INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                                 WHERE a.AbnormalqualityId = b.AbnormalqualityId
                                   AND b.CreateDate = (SELECT MAX(b2.CreateDate)
                                                         FROM QMS.AqBarcode b2
						                                WHERE b.BarcodeId = b2.BarcodeId)
                                   AND b.JudgeReturnMoProcessId = @MoProcessId
                                   AND c.BarcodeNo = @BarcodeNo
                                   AND b.JudgeStatus = 'RW'
                                   AND (c.CurrentProdStatus = 'P' OR (c.CurrentProdStatus = 'RW' AND @sAutoCompleted IN('Y','S')))";

                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            dynamicParameters.Add("sAutoCompleted", sAutoCompleted);

                            var AqBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (AqBarcodeResult.Count() > 0)
                            {
                                NextMoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeReturnNextMoProcessId);
                            }
                            else
                            {
                                if (MpcId > 0)
                                {
                                    //條碼在製程變更單中下製程ID
                                    sql = @"SELECT b.MoProcessId
                                              FROM MES.MoProcessChange a
                                                   INNER JOIN MES.MpcRoutingProcess b ON a.MpcId = b.MpcId
                                             WHERE a.MpcId = @MpcId
                                               AND a.[Status] = 'A'
                                               AND b.SortNumber = (SELECT MIN(b1.SortNumber)
                                                                     FROM MES.MpcRoutingProcess b1
						                                            WHERE a.MpcId = b.MpcId
						                                              AND b1.SortNumber > @ProcessSortNumber + 1)";

                                    dynamicParameters.Add("MpcId", MpcId);
                                    dynamicParameters.Add("ProcessSortNumber", ProcessSortNumber);
                                    var BarcodeNextProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (BarcodeNextProcessResult.Count() > 0)
                                    {
                                        foreach (var item in BarcodeNextProcessResult)
                                        {
                                            NextMoProcessId = Convert.ToInt32(item.MoProcessId);
                                        }
                                    }
                                    else
                                    {
                                        NextMoProcessId = -1;
                                        //BarcodeStatus = "0"; //Barcode Process Completed
                                    }
                                }
                                else
                                {
                                    sql = @"SELECT a.MoProcessId
                                              FROM MES.MoProcess a
                                             WHERE a.MoId = @MoId
                                               AND a.SortNumber = (SELECT MIN(a1.SortNumber)
                                                                      FROM MES.MoProcess a1
						                                             WHERE a.MoId = a1.MoId
						                                               AND a1.SortNumber > @ProcessSortNumber)";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("ProcessSortNumber", ProcessSortNumber);
                                    var BarcodeNextProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (BarcodeNextProcessResult.Count() > 0)
                                    {
                                        foreach (var item in BarcodeNextProcessResult)
                                        {
                                            NextMoProcessId = Convert.ToInt32(item.MoProcessId);
                                        }
                                    }
                                    else
                                    {
                                        NextMoProcessId = -1;
                                        //BarcodeStatus = "0"; //Barcode Process Completed
                                    }
                                }

                            }
                            #endregion

                            #region //如果過的是品異判定站別, 需把AqBarcode.ProcessStatus 改成Y
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ProcessStatus,a.JudgeReturnNextMoProcessId
                                      FROM QMS.AqBarcode a
                                           INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                     WHERE b.BarcodeNo = @BarcodeNo
                                       AND a.ProcessStatus != 'Y'";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var AqResult1 = sqlConnection.Query(sql, dynamicParameters);
                            if (AqResult1.Count() > 0)
                            {
                                if (MoProcessId.Equals(Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeReturnNextMoProcessId)))
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE QMS.AqBarcode
                                               SET ProcessStatus = 'Y'
                                             WHERE ProcessStatus != 'Y'
                                               AND BarcodeId = @BarcodeId";

                                    dynamicParameters.Add("BarcodeId", BarcodeId);
                                    var updAqBarcode = sqlConnection.Execute(sql, dynamicParameters);
                                }
                            }
                            #endregion

                            #region //更新點膠次數

                            if (consumeresult.Count() > 0 && MachineConsumeLogId > 0)
                            {
                                #region //更新次數
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MachineConsumeLog 
                                   SET AllowDispenseQty = @AllowDispenseQty,
                                       LastModifiedDate = @LastModifiedDate,
                                       LastModifiedBy = @LastModifiedBy
                                 WHERE MachineConsumeLogId = @MachineConsumeLogId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AllowDispenseQty = AllowDispenseQty + BarcodeQty,
                                        LastModifiedDate = DateTime.Now,
                                        LastModifiedBy = UserId,
                                        MachineConsumeLogId = MachineConsumeLogId
                                    });
                                int UpdateCountResult = sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region 點膠條碼記錄



                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeConsumeLog (BarcodeProcessId, MachineConsumeLogId, AllowDispenseQty
                                                ,CreateDate, CreateBy, LastModifiedDate, LastModifiedBy)
                                                OUTPUT INSERTED.BarcodeConsumeLogId
                                                VALUES (@BarcodeProcessId, @MachineConsumeLogId, @AllowDispenseQty
                                                ,@CreateDate, @CreateBy, @LastModifiedDate, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeProcessId,
                                        MachineConsumeLogId,
                                        AllowDispenseQty = BarcodeQty,
                                        CreateDate,
                                        CreateBy = UserId,
                                        LastModifiedDate = DateTime.Now,
                                        LastModifiedBy = UserId,
                                    });
                                var insertResult4 = sqlConnection.Query(sql, dynamicParameters);


                                #endregion


                            }

                            #endregion



                            #region //加鏡頭條碼過站記錄

                            if (lensresult.Count() > 0)
                            {
                                foreach (var item in lensresult)
                                {
                                    #region 過站記錄
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId
                                                ,ProdStatus, StationQty,PassQty
                                                ,NgQty,StartDate,FinishDate
                                                ,ModeShiftId,CycleTime,StartUserId
                                                ,FinishUserId
                                                ,CreateDate, CreateBy)
                                                OUTPUT INSERTED.BarcodeProcessId
                                                VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId
                                                ,@ProdStatus, @StationQty, @PassQty
                                                ,@NgQty, @StartDate, @FinishDate
                                                ,@ModeShiftId, @CycleTime, @StartUserId
                                                ,@FinishUserId
                                                ,@CreateDate, @CreateBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeId = item.BarcodeId,
                                            MoId,
                                            MachineId,
                                            MoProcessId,
                                            ProdStatus = "P",
                                            StationQty = 1,
                                            PassQty = 1,
                                            NgQty = 0,
                                            StartDate = DateTime.Now,
                                            FinishDate = DateTime.Now,
                                            ModeShiftId,
                                            CycleTime = 0,
                                            StartUserId = UserId,
                                            FinishUserId = UserId,
                                            CreateDate,
                                            CreateBy = UserId
                                        });
                                    var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                    #endregion

                                    #region //更新LensBarcode NextProcess

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode 
                                   SET CurrentMoProcessId = @CurrentMoProcessId,
                                       NextMoProcessId = @NextMoProcessId,
                                       CurrentProdStatus = 'P',
                                       BarcodeStatus = @BarcodeStatus,
                                       LastModifiedDate = @LastModifiedDate,
                                       LastModifiedBy = @LastModifiedBy
                                 WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            CurrentMoProcessId = MoProcessId,
                                            NextMoProcessId,
                                            BarcodeStatus,
                                            LastModifiedDate = DateTime.Now,
                                            LastModifiedBy = UserId,
                                            item.BarcodeId
                                        });
                                    int UpdateLensBarcodeNextResult = sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                            #endregion

                            //更新MoProcess數量資訊
                            UpdateMoQtyInformation(MoId);
                            //UpdateBarcodeProcessStatus("A", BarcodeProcessId, "P");
                        }
                        else//只處理開工
                        {
                            #region //Insert BarcodeProcess, 只要壓上StartDate
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId
                                                ,ProdStatus, StationQty,PassQty
                                                ,NgQty,StartDate
                                                ,ModeShiftId,CycleTime,StartUserId
                                                ,CreateDate, CreateBy)
                                                OUTPUT INSERTED.BarcodeProcessId
                                                VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId
                                                ,@ProdStatus, @StationQty, @PassQty
                                                ,@NgQty, @StartDate
                                                ,@ModeShiftId, @CycleTime, @StartUserId
                                                ,@CreateDate, @CreateBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeId,
                                    MoId,
                                    MachineId,
                                    MoProcessId,
                                    ProdStatus = "P",
                                    StationQty = BarcodeQty,
                                    PassQty = BarcodeQty,
                                    //PassQty = 1,
                                    NgQty = 0,
                                    StartDate = DateTime.Now,
                                    ModeShiftId,
                                    CycleTime = 0,
                                    StartUserId = UserId,
                                    CreateDate,
                                    CreateBy = UserId
                                });
                            var insertResult3 = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in insertResult3)
                            {
                                BarcodeProcessId = Convert.ToInt32(item.BarcodeProcessId);
                            }
                            #endregion


                        }

                        #region //若為最後一站, 且不需工程檢,  則需更新條碼狀態為0(自動完工才需執行)
                        if ((sAutoCompleted.Equals("Y") || sAutoCompleted.Equals("S")) && NextMoProcessId.Equals(-1) && ProcessCheckStatus.Equals("N"))
                        {
                            BarcodeStatus = "0";
                        }
                        else
                        {
                            BarcodeStatus = "1";
                        }
                        #endregion

                        #region //更新Barcode NextProcess

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode 
                                   SET CurrentMoProcessId = @CurrentMoProcessId,
                                       NextMoProcessId = @NextMoProcessId,
                                       CurrentProdStatus = 'P',
                                       BarcodeStatus = @BarcodeStatus,
                                       LastModifiedDate = @LastModifiedDate,
                                       LastModifiedBy = @LastModifiedBy
                                 WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CurrentMoProcessId = MoProcessId,
                                NextMoProcessId,
                                BarcodeStatus,
                                LastModifiedDate = DateTime.Now,
                                LastModifiedBy = UserId,
                                BarcodeId
                            });
                        int UpdateBarcodeNextResult = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }
                    else //完工
                    {
                        #region//確認工時是否符合設定標準
                        int CycleTime = 0;
                        int MoveTime = 0;
                        int WatingTime = 0;
                        int ProcessingTime = 0;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(d.CycleTime,0) CycleTime,ISNULL(d.MoveTime,0)MoveTime ,ISNULL(d.ProcessingTime,0) ProcessingTime,ISNULL(d.WatingTime,0) WatingTime
                            FROM MES.MoProcess a 
                            INNER JOIN MES.RoutingProcess b ON a.RoutingProcessId=b.RoutingProcessId
                            INNER JOIN MES.MoRouting c ON a.MoId=c.MoId
                            INNER JOIN MES.RoutingItemProcess d ON d.RoutingProcessId=b.RoutingProcessId AND d.RoutingItemId=c.RoutingItemId
                            WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var RoResult = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in RoResult)
                        {
                            CycleTime = Convert.ToInt32(item.CycleTime);//標準工時
                            MoveTime = Convert.ToInt32(item.MoveTime);//當站完工至下站移轉時間                                
                            ProcessingTime = Convert.ToInt32(item.ProcessingTime);//標準工時上下公差
                            WatingTime = Convert.ToInt32(item.WatingTime);//當前站的最小前置時間
                        }

                        if (CycleTime >0 && ProcessingTime > 0) {
                            //取得當站開工時間
                            string startDate = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT  FORMAT(a.StartDate,'yyyy-MM-dd HH:mm:ss') StartDate
                                    ,FORMAT(a.FinishDate,'yyyy-MM-dd HH:mm:ss') FinishDate
                                FROM MES.BarcodeProcess a
                                WHERE a.MoProcessId=@MoProcessId
                                AND a.BarcodeProcessId=@BarcodeProcessId";
                            dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            var DateResult = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in DateResult)
                            {
                                startDate = item.StartDate;
                            }
                            string nowDateTime = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss");
                            DateTime dt_end = Convert.ToDateTime(nowDateTime);
                            DateTime dt_start = Convert.ToDateTime(startDate);
                            DateTime expCompletionTime = dt_start.AddSeconds(CycleTime- ProcessingTime);
                          
                            if (dt_end < expCompletionTime) throw new Exception("預計【" + expCompletionTime.ToString("yyyy-MM-dd HH:mm:ss") + "】才可完工");
                        }
                        #endregion

                        #region //則取出下一站MoProcessId
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.AbnormalqualityNo,b.JudgeReturnMoProcessId,b.JudgeReturnNextMoProcessId,
                                       a.MoProcessId,b.AqBarcodeId
                                  FROM QMS.Abnormalquality a
                                       INNER JOIN QMS.AqBarcode b ON a.AbnormalqualityId = b.AbnormalqualityId
	                                   INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                                 WHERE a.AbnormalqualityId = b.AbnormalqualityId
                                   AND b.CreateDate = (SELECT MAX(b2.CreateDate)
                                                         FROM QMS.AqBarcode b2
						                                WHERE b.BarcodeId = b2.BarcodeId)
                                   AND b.JudgeReturnMoProcessId = @MoProcessId
                                   AND c.BarcodeNo = @BarcodeNo
                                   AND b.JudgeStatus = 'RW'
                                   AND b.ProcessStatus != 'Y'
                                   AND c.CurrentProdStatus = 'P'";

                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var AqBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (AqBarcodeResult.Count() > 0)
                        {
                            NextMoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeReturnNextMoProcessId);
                            int AqBarcodeId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).AqBarcodeId);

                            #region //更新品異單狀態, 代表此品異Barcode已完成
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE QMS.AqBarcode
                                   SET ProcessStatus = 'Y',
                                       LastModifiedDate = @LastModifiedDate,
                                       LastModifiedBy = @LastModifiedBy
                                 WHERE AqBarcodeId = @AqBarcodeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate = DateTime.Now,
                                    LastModifiedBy = UserId,
                                    AqBarcodeId
                                });
                            int UpdateAqBarcodeResult = sqlConnection.Execute(sql, dynamicParameters);

                            #endregion
                        }
                        else
                        {
                            if (MpcId > 0)
                            {
                                //條碼在製程變更單中下製程ID
                                sql = @"SELECT b.MoProcessId
                                          FROM MES.MoProcessChange a
                                               INNER JOIN MES.MpcRoutingProcess b ON a.MpcId = b.MpcId
                                         WHERE a.MpcId = @MpcId
                                           AND a.[Status] = 'A'
                                           AND b.SortNumber = (SELECT MIN(b1.SortNumber)
                                                                 FROM MES.MpcRoutingProcess b1
						                                        WHERE a.MpcId = b.MpcId
						                                          AND b1.SortNumber > @ProcessSortNumber)";

                                dynamicParameters.Add("MpcId", MpcId);
                                dynamicParameters.Add("ProcessSortNumber", ProcessSortNumber);
                                var BarcodeNextProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                if (BarcodeNextProcessResult.Count() > 0)
                                {
                                    foreach (var item in BarcodeNextProcessResult)
                                    {
                                        NextMoProcessId = Convert.ToInt32(item.MoProcessId);
                                    }
                                }
                                else
                                {
                                    NextMoProcessId = -1;
                                    //BarcodeStatus = "0"; //Barcode Process Completed
                                }
                            }
                            else
                            {
                                if (ProcessSortNumber <= 0) throw new SystemException("取得目前製程順序資料錯誤!!");

                                sql = @"SELECT a.MoProcessId
                                        FROM MES.MoProcess a
                                        WHERE a.MoId = @MoId
                                        AND a.SortNumber = (SELECT MIN(a1.SortNumber)
                                                                FROM MES.MoProcess a1
						                                        WHERE a.MoId = a1.MoId
						                                        AND a1.SortNumber > @ProcessSortNumber)";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("ProcessSortNumber", ProcessSortNumber);
                                var BarcodeNextProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                if (BarcodeNextProcessResult.Count() > 0)
                                {
                                    foreach (var item in BarcodeNextProcessResult)
                                    {
                                        NextMoProcessId = Convert.ToInt32(item.MoProcessId);
                                    }
                                }
                                else
                                {
                                    NextMoProcessId = -1;
                                    //BarcodeStatus = "0"; //Barcode Process Completed
                                }
                            }

                        }
                        #endregion

                        #region //更新BarcodeProcess, 壓上FinishDate
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeProcess 
                                           SET FinishDate = @FinishDate,
                                               FinishUserId = @FinishUserId,
                                               CycleTime = DATEDIFF(ss,StartDate,@FinishDate),
                                               LastModifiedDate = @LastModifiedDate,
                                               LastModifiedBy = @LastModifiedBy
                                         WHERE BarcodeProcessId = @BarcodeProcessId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FinishDate = DateTime.Now,
                                FinishUserId = UserId,
                                LastModifiedDate = DateTime.Now,
                                LastModifiedBy = UserId,
                                BarcodeProcessId
                            });
                        var insertResult5 = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //如果過的是品異判定站別, 需把AqBarcode.ProcessStatus 改成Y
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ProcessStatus,a.JudgeReturnNextMoProcessId
                                      FROM QMS.AqBarcode a
                                           INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                     WHERE b.BarcodeNo = @BarcodeNo
                                       AND a.ProcessStatus != 'Y'";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        var AqResult1 = sqlConnection.Query(sql, dynamicParameters);
                        if (AqResult1.Count() > 0)
                        {
                            if (MoProcessId.Equals(Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JudgeReturnNextMoProcessId)))
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE QMS.AqBarcode
                                               SET ProcessStatus = 'Y'
                                             WHERE ProcessStatus != 'Y'
                                               AND BarcodeId = @BarcodeId";

                                dynamicParameters.Add("BarcodeId", BarcodeId);
                                var updAqBarcode = sqlConnection.Execute(sql, dynamicParameters);
                            }
                        }
                        #endregion

                        #region //若為最後一站, 且不需工程檢,  則需更新條碼狀態為0
                        if (NextMoProcessId.Equals(-1) && ProcessCheckStatus.Equals("N"))
                        {
                            BarcodeStatus = "0";
                        }
                        else
                        {
                            BarcodeStatus = "1";
                        }
                        #endregion

                        #region //更新Barcode NextProcess

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode 
                                   SET CurrentMoProcessId = @CurrentMoProcessId,
                                       NextMoProcessId = @NextMoProcessId,
                                       CurrentProdStatus = 'P',
                                       BarcodeStatus = @BarcodeStatus,
                                       LastModifiedDate = @LastModifiedDate,
                                       LastModifiedBy = @LastModifiedBy
                                 WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CurrentMoProcessId = MoProcessId,
                                NextMoProcessId = NextMoProcessId.Equals(0) ? -1 : NextMoProcessId,
                                BarcodeStatus = NextMoProcessId.Equals(0) ? "0" : BarcodeStatus,
                                LastModifiedDate = DateTime.Now,
                                LastModifiedBy = UserId,
                                BarcodeId
                            });
                        int UpdateBarcodeNextResult = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新MoProcess數量資訊
                        UpdateMoQtyInformation(MoId);
                        //UpdateBarcodeProcessStatus("A", BarcodeProcessId, "P");
                        #endregion

                        #region//新增MTF暫存量測數據

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MachineNo,a.IOTtableName
                                FROM MES.Machine a
                                WHERE a.IOTtableName IS NOT NULL AND a.MachineId = @MachineId";
                        dynamicParameters.Add("MachineId", MachineId);
                        var IOTMachineResult = sqlConnection.Query(sql, dynamicParameters);
                        if (IOTMachineResult.Count() > 0)
                        {
                            #region//取得開工完工時間
                            string StartDate = "", FinishDate = "";
                            dynamicParameters = new DynamicParameters();
                            string sql = @"SELECT a.StartDate,a.FinishDate
                                FROM MES.BarcodeProcess a
                                WHERE a.BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);
                            var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in BarcodeProcessResult)
                            {
                                StartDate = item.StartDate != null ? Convert.ToDateTime(item.StartDate).ToString("yyyy-MM-dd HH:mm:ss") : "";
                                FinishDate = item.FinishDate != null ? Convert.ToDateTime(item.FinishDate).ToString("yyyy-MM-dd HH:mm:ss") : "";
                            }
                            #endregion

                            AddMtfProcessTemp(BarcodeProcessId, MachineId, StartDate, FinishDate);
                        }
                        #endregion

                        #region //更新點膠次數
                        
                        if (consumeresult.Count() > 0 && MachineConsumeLogId > 0)
                        {
                                #region //更新次數
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MachineConsumeLog 
                                   SET AllowDispenseQty = @AllowDispenseQty,
                                       LastModifiedDate = @LastModifiedDate,
                                       LastModifiedBy = @LastModifiedBy
                                 WHERE MachineConsumeLogId = @MachineConsumeLogId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        AllowDispenseQty = AllowDispenseQty + BarcodeQty,
                                        LastModifiedDate = DateTime.Now,
                                        LastModifiedBy = UserId,
                                        MachineConsumeLogId = MachineConsumeLogId
                                    });
                                int UpdateCountResult = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region 點膠條碼記錄



                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeConsumeLog (BarcodeProcessId, MachineConsumeLogId, AllowDispenseQty
                                                ,CreateDate, CreateBy, LastModifiedDate, LastModifiedBy)
                                                OUTPUT INSERTED.BarcodeConsumeLogId
                                                VALUES (@BarcodeProcessId, @MachineConsumeLogId, @AllowDispenseQty
                                                ,@CreateDate, @CreateBy, @LastModifiedDate, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeProcessId,
                                    MachineConsumeLogId,
                                    AllowDispenseQty = BarcodeQty,
                                    CreateDate,
                                    CreateBy = UserId,
                                    LastModifiedDate = DateTime.Now,
                                    LastModifiedBy = UserId,
                                });
                            var insertResult4 = sqlConnection.Query(sql, dynamicParameters);


                            #endregion


                        }
                        #endregion



                        #region //加鏡頭條碼過站記錄

                        if (lensresult.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT * 
                                FROM MES.BarcodeProcess a
                                INNER JOIN MES.Barcode b ON a.BarcodeId=b.BarcodeId
                                WHERE a.BarcodeProcessId = @BarcodeProcessId
                                ";
                            dynamicParameters.Add("BarcodeProcessId", BarcodeProcessId);
                            var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                            var parentCycleTime = BarcodeProcessResult.FirstOrDefault().CycleTime;
                            var parentStartDate = BarcodeProcessResult.FirstOrDefault().StartDate;

                            foreach (var item in lensresult)
                            {
                                #region Lens過站記錄

                                

                                dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId
                                                ,ProdStatus, StationQty,PassQty
                                                ,NgQty,StartDate, FinishDate
                                                ,ModeShiftId,CycleTime,StartUserId
                                                ,CreateDate, CreateBy, FinishUserId, LastModifiedDate, LastModifiedBy)
                                                OUTPUT INSERTED.BarcodeProcessId
                                                VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId
                                                ,@ProdStatus, @StationQty, @PassQty
                                                ,@NgQty, @StartDate, @FinishDate
                                                ,@ModeShiftId, DATEDIFF(ss,@StartDate,@FinishDate), @StartUserId
                                                ,@CreateDate, @CreateBy, @FinishUserId, @LastModifiedDate, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                item.BarcodeId,
                                                MoId,
                                                MachineId,
                                                MoProcessId,
                                                ProdStatus = "P",
                                                StationQty = 1,
                                                PassQty = 0,
                                                NgQty = 0,
                                                StartDate = parentStartDate,
                                                FinishDate = DateTime.Now,
                                                ModeShiftId,
                                                StartUserId = UserId,
                                                CreateDate,
                                                CreateBy = UserId,
                                                FinishUserId = UserId,
                                                LastModifiedDate = DateTime.Now,
                                                LastModifiedBy = UserId,
                                            });
                                        var insertResult4 = sqlConnection.Query(sql, dynamicParameters);
                                

                                #endregion
                                #region //更新LensBarcode NextProcess

                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode 
                                   SET CurrentMoProcessId = @CurrentMoProcessId,
                                       NextMoProcessId = @NextMoProcessId,
                                       CurrentProdStatus = 'P',
                                       BarcodeStatus = @BarcodeStatus,
                                       LastModifiedDate = @LastModifiedDate,
                                       LastModifiedBy = @LastModifiedBy
                                 WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        CurrentMoProcessId = MoProcessId,
                                        NextMoProcessId,
                                        BarcodeStatus,
                                        LastModifiedDate = DateTime.Now,
                                        LastModifiedBy = UserId,
                                        item.BarcodeId
                                    });
                                int UpdateLensBarcodeNextResult = sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                        }
                        #endregion
                    }
                }
                else//數量過站
                {
                    //找出可投入數量, 首站不可大於製令數量(或領料數), 首站外不可大於前製程數量
                    #region //數量控管模式
                    double AllowQty = 0;
                    int ThisQty = 0;
                    int ReturnQty = 0;
                    BarcodeQty = Convert.ToInt32(BarcodeNo);

                    #region Get 當站過站數累計數量ThiSQty & MoProcess SortNumber
                    //sql = @"SELECT a.SortNumber,
                    //               SUM(ISNULL(b.Quantity,0)) ThisQty
                    //          FROM MES.MoProcess a
                    //               LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                    //         WHERE a.MoProcessId = @MoProcessId
                    //           AND ISNULL(b.ProdStatus,'P') = 'P'
                    //         GROUP BY a.SortNumber ";
                    // 過站數量不可只計算良品數
                    sql = @"SELECT a.SortNumber,
                                   SUM(ISNULL(b.Quantity,0)) ThisQty
                              FROM MES.MoProcess a
                                   LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                             WHERE a.MoProcessId = @MoProcessId
                             GROUP BY a.SortNumber ";

                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    var ThisQtyResult = sqlConnection.Query(sql, dynamicParameters);
                    if (ThisQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料!");
                    ThisQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ThisQty);
                    CurrentSortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);
                    #endregion

                    #region //取得是否有指回此站數量
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT ISNULL(SUM(Quantity),0) ReturnQty
                              FROM MES.MoProcessTransaction 
                             WHERE NextMoProcessId = @MoProcessId
                               AND ProdStatus = 'F'";
                    dynamicParameters.Add("MoProcessId", MoProcessId);
                    var ReturnQtyResult = sqlConnection.Query(sql, dynamicParameters);
                    if (ReturnQtyResult.Count() > 0)
                    {
                        ReturnQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ReturnQty);
                    }
                    #endregion

                    if (CurrentSortNumber.Equals(1))
                    {
                        //首站, 抓取製令開立數量(未來可能改成領料數量)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemId, ISNULL(SUM(a.ActualQuantity), 0) AS Quantity
                                    FROM MES.MrDetail a
                                    INNER JOIN MES.MaterialRequisition b ON a.MrId = b.MrId
                                    WHERE a.MoId = @MoId
                                      AND b.ConfirmStatus = 'Y'
                                      AND (
                                        SELECT COUNT(DISTINCT MtlItemId)
                                        FROM MES.MrDetail
                                        WHERE MrId = a.MrId
                                        AND MoId = a.MoId
                                        GROUP BY MtlItemId
                                      ) = 1
                                    GROUP BY a.MtlItemId";

                        dynamicParameters.Add("MoId", MoId);
                        var AllowQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (AllowQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料");

                        foreach (var item in AllowQtyResult)
                        {
                            int MtlItemId = item.MtlItemId;
                            double currentAllowQty = 0;
                            currentAllowQty = item.Quantity;

                            #region //計算單位用量換算，固定用PCS計算
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.DemandRequisitionQty
                                        , b.PlanQty
                                        FROM MES.WoDetail a 
                                        INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                                        INNER JOIN MES.ManufactureOrder c ON b.WoId = c.WoId
                                        WHERE a.MtlItemId = @MtlItemId
                                        AND c.MoId = @MoId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            dynamicParameters.Add("MoId", MoId);

                            var WoDetailResult = sqlConnection.Query(sql, dynamicParameters);

                            double DemandRequisitionQty = -1;
                            double PlanQty = -1;
                            foreach (var item2 in WoDetailResult)
                            {
                                DemandRequisitionQty = item2.DemandRequisitionQty;
                                PlanQty = item2.PlanQty;
                            }

                            double UnitConsumption = DemandRequisitionQty / PlanQty;

                            AllowQty += (int)Math.Round(Convert.ToDouble(currentAllowQty) / UnitConsumption, MidpointRounding.AwayFromZero);
                            #endregion
                        }
                    }
                    else
                    {
                        //非首站, 抓取上一站Pass數量, 但如果上一站非必過站, 則再往前站抓
                        sql = @"SELECT SUM(ISNULL(b.Quantity,0)) Quantity, a.SortNumber
                                  FROM MES.MoProcess a
                                       LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                                 WHERE a.MoId = @MoId
                                   AND b.ProdStatus = 'P'
                                   AND a.SortNumber = (SELECT MAX(a1.SortNumber)
                                                         FROM MES.MoProcess a1
						                                WHERE a.MoId = a1.MoId
						                                  AND a1.SortNumber < @CurrentSortNumber
						                                  AND a1.NecessityStatus != 'N')
                                 GROUP BY a.SortNumber";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("CurrentSortNumber", CurrentSortNumber);
                        var AllowQtyResult = sqlConnection.Query(sql, dynamicParameters);
                        if (AllowQtyResult.Count() <= 0) throw new SystemException("該製令找不到製程資料");
                        AllowQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Quantity);
                        int PreNecessitySort = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);

                        if (PreNecessitySort - CurrentSortNumber > 1)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT SUM(ISNULL(b.Quantity,0)) Quantity
                                      FROM MES.MoProcess a
                                           LEFT JOIN MES.MoProcessTransaction b ON a.MoProcessId = b.MoProcessId
                                     WHERE a.MoId = @MoId
                                       AND b.ProdStatus = 'P'
                                       AND a.SortNumber > @CurrentSortNumber 
                                       AND a.SortNumber < @PreNecessitySort ";
                            dynamicParameters.Add("CurrentSortNumber", CurrentSortNumber);
                            dynamicParameters.Add("PreNecessitySort", PreNecessitySort);

                            var NonNecessityResult = sqlConnection.Query(sql, dynamicParameters);
                            if (NonNecessityResult.Count() >= 0)
                            {
                                AllowQty = AllowQty - Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Quantity);
                            }
                        }

                    }

                    #region //Validation Input Quantity
                    if (AllowQty + ReturnQty - ThisQty - BarcodeQty < 0)
                    {
                        throw new SystemException("前製程完工數[" + (AllowQty + ReturnQty).ToString() + "】減當站完工數小於投入數量");
                    }
                    else
                    {
                        if (QtyLotNgCauseNo.Length > 0)
                        {
                            sql = @"SELECT TOP 1 1
                                    FROM QMS.DefectCause a
                                    WHERE a.CauseNo = @CauseNo";
                            dynamicParameters.Add("CauseNo", QtyLotNgCauseNo);
                            var CauseNoResult = sqlConnection.Query(sql, dynamicParameters);

                            if (CauseNoResult.Count() <= 0) throw new SystemException("此異常原因不存在!");
                        }

                        #region //新增MES.MoProcessTransaction 
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MoProcessTransaction (MoId,MachineId,NextMoProcessId
                                                ,MoProcessId,ProdStatus,Quantity,InputDate,CauseNo
                                                ,CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.TransactionId
                                                VALUES (@MoId, @MachineId, @QtyNextMoProcessId
                                                , @MoProcessId, @ProdStatus, @Quantity, @InputDate, @CauseNo
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoId,
                                MachineId,
                                QtyNextMoProcessId,
                                MoProcessId,
                                ProdStatus = QtyBarcodeStatus,
                                Quantity = BarcodeQty,
                                CauseNo = QtyLotNgCauseNo,
                                InputDate = DateTime.Now,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });
                        var insertMoProcessTransaction = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //如果QtyBarcodeStatus = "S"(報廢), 更新ManufactoreOrder.ScrapQty
                        if (QtyBarcodeStatus.Equals("S"))
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.ManufactureOrder 
                                   SET ScrapQty = ScrapQty + @BarcodeQty
                                 WHERE MoId = @MoId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeQty,
                                    MoId
                                });
                            int UpdateMoInputQty = sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion

                        #region 呼叫UpdateMoProcessTransaction 更新MoProcess數量資訊
                        UpdateMoProcessTransaction(MoId);
                        #endregion
                    }
                    #endregion
                    #endregion

                    #region //確認是否有BarcodePrint
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1
                            FROM MES.BarcodePrint a 
                            INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                            WHERE b.MoId = @MoId";
                    dynamicParameters.Add("MoId", MoId);

                    var BarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);
                    #endregion
                }
                #endregion

                #region //若首站, 則更新製令投量, 數量過站用
                if (bInput && FirstMoProcessId.Equals(MoProcessId) && BarcodeCtrl.Equals("N"))
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"UPDATE MES.ManufactureOrder 
                               SET InputQty = ISNULL(InputQty,0) + @BarcodeQty,
                                   [Status] = 'A',
                                   LastModifiedDate = @LastModifiedDate,
                                   LastModifiedBy = @LastModifiedBy
                             WHERE MoId = @MoId";
                    dynamicParameters.AddDynamicParams(
                        new
                        {
                            BarcodeQty,
                            MoId,
                            LastModifiedDate = DateTime.Now,
                            LastModifiedBy = UserId,
                            BarcodeId
                        });
                    int UpdateMoInputQty = sqlConnection.Execute(sql, dynamicParameters);
                }
                #endregion

                #region //更新製令投入量, 條碼過站用
                if (bInput)
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT COUNT(1) ProcessQty
                          FROM MES.BarcodeProcess a
                         WHERE BarcodeId = @BarcodeId 
                           AND MoId = @MoId";
                    dynamicParameters.Add("BarcodeId", BarcodeId);
                    dynamicParameters.Add("MoId", MoId);
                    var ProcessQtyResult = sqlConnection.Query(sql, dynamicParameters);
                    if (Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ProcessQty) == 1)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.ManufactureOrder 
                               SET InputQty = ISNULL(InputQty,0) + @BarcodeQty,
                                   [Status] = 'A',
                                   LastModifiedDate = @LastModifiedDate,
                                   LastModifiedBy = @LastModifiedBy
                             WHERE MoId = @MoId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeQty,
                                MoId,
                                LastModifiedDate = DateTime.Now,
                                LastModifiedBy = UserId,
                                BarcodeId
                            });
                        int UpdateMoInputQty = sqlConnection.Execute(sql, dynamicParameters);
                    }
                }

                #endregion

                #region //若為託外過站，確認當前單身是否還有未過站條碼
                if (OspDetailId > 0 && OsrDetailId > 0)
                {
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 1
                            FROM MES.OspReceiptBarcode a 
                            INNER JOIN MES.OspBarcode b ON a.OspBarcodeId = b.OspBarcodeId
                            INNER JOIN MES.OspDetail c ON b.OspDetailId = c.OspDetailId
                            WHERE b.OspDetailId = @OspDetailId
                            AND EXISTS (
                                SELECT TOP 1 1
                                FROM MES.BarcodeProcess x 
                                INNER JOIN MES.Barcode xa ON x.BarcodeId = xa.BarcodeId
                                WHERE xa.BarcodeNo = b.BarcodeNo
                                AND x.MoProcessId = c.MoProcessId
                                AND x.FinishDate IS NULL
                            )";
                    dynamicParameters.Add("OspDetailId", OspDetailId);

                    var OspReceiptBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                    if (OspReceiptBarcodeResult.Count() <= 0)
                    {
                        #region  //更新OspReceiptDetail.ProcessStatus
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.OspReceiptDetail 
                                SET ProcessStatus = 'Y',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                WHERE OsrDetailId = @OsrDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                OsrDetailId,
                                LastModifiedDate = DateTime.Now,
                                LastModifiedBy = UserId
                            });
                        int UpdateOsrDetailResult = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }
                }
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                throw new SystemException("Error:" + e.Message);
                #endregion
            }
        }
        #endregion

        #region //TxOspBarcodeProcess 託外收貨後呼叫此API過站BarcodeProcess
        public string TxOspBarcodeProcess(int OsrId, string SourceMode)
        {
            try
            {
                int rowsAffected = 0;
                Boolean JumpFlag;
                int nUserId = CreateBy;

                var transactionOptions = new TransactionOptions
                {
                    IsolationLevel = IsolationLevel.ReadCommitted,
                    Timeout = TimeSpan.FromMinutes(2) // 設定較長的逾時時間
                };

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, transactionOptions))
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //處理託外收貨後過站功能

                        #region //先取得此託外入庫單共有幾張製令
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT a.MoId
                                FROM MES.OspReceiptDetail a
                                WHERE a.OsrId = @OsrId";
                        dynamicParameters.Add("OsrId", OsrId);
                        var OspReceiptDetailMoIdResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        foreach (var item in OspReceiptDetailMoIdResult)
                        {
                            #region 確認託外製程是否為連續順序
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.SortNumber
                                    FROM MES.OspReceiptDetail a
                                    INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                    WHERE a.OsrId = @OsrId
                                    AND a.MoId = @MoId";
                            dynamicParameters.Add("OsrId", OsrId);
                            dynamicParameters.Add("MoId", item.MoId);
                            var OspReceiptSortNumberResult = sqlConnection.Query(sql, dynamicParameters);

                            List<int> SortNumberList = new List<int>();
                            int CurrentMoProcessSortNumber = 0;
                            foreach (var item2 in OspReceiptSortNumberResult)
                            {
                                SortNumberList.Add(item2.SortNumber);
                            }

                            SortNumberList.Sort();
                            int i = 1;
                            foreach (var item3 in SortNumberList)
                            {
                                if (i == 1)
                                {
                                    CurrentMoProcessSortNumber = item3;
                                }
                                else
                                {
                                    if (item3 - CurrentMoProcessSortNumber != 1)
                                    {
                                        #region //確認中間站別是否為非必要過站
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1 
                                                    FROM MES.MoProcess
                                                    WHERE MoId = @MoId
                                                    AND SortNumber > @CurrentSortNumber
                                                    AND SortNumber < @SortNumber
                                                    AND NecessityStatus = 'Y'";
                                        dynamicParameters.Add("MoId", item.MoId);
                                        dynamicParameters.Add("CurrentSortNumber", CurrentMoProcessSortNumber);
                                        dynamicParameters.Add("SortNumber", item3);

                                        var SortNumberResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (SortNumberResult.Count() > 0)
                                        {
                                            throw new SystemException("此託外生產單過站製程中順序沒有連續!!");
                                        }
                                        #endregion
                                    }
                                    else
                                    {
                                        CurrentMoProcessSortNumber = item3;
                                    }
                                }
                                i++;
                            }
                            #endregion
                        }

                        #region //取出委外Barcode物件
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.OsrDetailId
                                , a.ConfirmStatus, a.ReceiptQty, a.MoProcessId, a.MoId, a.ProcessStatus
                                , c.BarcodeNo, c.BarcodeQty
                                , d.BarcodeId, d.BarcodeStatus, d.BarcodeNo
                                , FORMAT(e.CreateDate, 'yyyy-MM-dd') StartDate, e.CreateBy StartUserId
                                , f.SortNumber
                                , h.PassStationControl
                                FROM MES.OspReceiptDetail a 
                                INNER JOIN MES.OspReceiptBarcode b ON a.OsrDetailId = b.OsrDetailId
                                INNER JOIN MES.OspBarcode c ON b.OspBarcodeId = c.OspBarcodeId
                                INNER JOIN MES.Barcode d ON c.BarcodeNo = d.BarcodeNo
                                INNER JOIN MES.OspDetail e ON c.OspDetailId = e.OspDetailId
                                INNER JOIN MES.MoProcess f ON a.MoProcessId = f.MoProcessId
                                INNER JOIN MES.OspReceipt g ON a.OsrId = g.OsrId
                                INNER JOIN SCM.Supplier h ON g.SupplierId = h.SupplierId
                                WHERE a.OsrId = @OsrId
                                ORDER BY f.SortNumber,d.BarcodeId";

                        dynamicParameters.Add("OsrId", OsrId);
                        var OsrBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (OsrBarcodeResult.Count() > 0)
                        {
                            foreach (var item in OsrBarcodeResult)
                            {
                                //if (item.PassStationControl == "Y" && SourceMode != "admin")
                                //{
                                //    throw new SystemException("此供應商已設定為供應商過站!!");
                                //}

                                if (item.ProcessStatus != "N" && SourceMode != "admin")
                                {
                                    continue;
                                }
                                int OsrDetailId = Convert.ToInt32(item.OsrDetailId);
                                int MoId = Convert.ToInt32(item.MoId);
                                int MoProcessId = Convert.ToInt32(item.MoProcessId);
                                int BarcodeId = Convert.ToInt32(item.BarcodeId);
                                int BarcodeQty = Convert.ToInt32(item.BarcodeQty);
                                int ModeShiftId = -1;
                                string BarcodeStatus = item.BarcodeStatus.ToString();
                                string BarcodeNo = item.BarcodeNo.ToString();

                                #region //確認條碼是否已經完工
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.NextMoProcessId, a.BarcodeStatus
                                        FROM MES.Barcode a
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", BarcodeId);

                                var NextMoProcessIdResult = sqlConnection.Query(sql, dynamicParameters);

                                if (NextMoProcessIdResult.Count() <= 0) throw new SystemException("找不到條碼資料!");

                                bool finishbool = false;
                                foreach (var item2 in NextMoProcessIdResult)
                                {
                                    if (item2.NextMoProcessId == -1) finishbool = true;
                                }
                                #endregion

                                if (finishbool == false)
                                {
                                    #region //取出Next & Current Process ID
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.CurrentMoProcessId, b.SortNumber CurrentSortNumber,
                                               a.NextMoProcessId, c.SortNumber NextSortNumber, c.ProcessAlias NextProcessAlias
                                          FROM MES.Barcode a
                                               INNER JOIN MES.MoProcess b ON a.CurrentMoProcessId = b.MoProcessId
                                               INNER JOIN MES.MoProcess c ON a.NextMoProcessId = c.MoProcessId
                                         WHERE a.BarcodeId = @BarcodeId";
                                    dynamicParameters.Add("BarcodeId", BarcodeId);
                                    var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (BarcodeResult.Count() <= 0) throw new SystemException("條碼找製程資訊錯誤!!!");

                                    #endregion
                                    int CurrentMoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentMoProcessId);
                                    int NextMoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NextMoProcessId);
                                    int CurrentSortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentSortNumber);
                                    int NextSortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NextSortNumber);
                                    string NextProcessAlias = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NextProcessAlias;

                                    if (!BarcodeStatus.Equals("1")) throw new SystemException("［" + BarcodeNo + "］條碼為非加工狀態!");

                                    if (!NextMoProcessId.Equals(MoProcessId))
                                    {
                                        if (SourceMode == "admin")
                                        {
                                            continue;
                                        }
                                        else
                                        {
                                            #region //判斷前面站別是否為非必要過站
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT 1 
                                                      FROM MES.MoProcess a
                                                     WHERE a.SortNumber > @CurrentSortNumber 
                                                       AND a.SortNumber < (SELECT a1.SortNumber
                                                                             FROM MES.MoProcess a1
                                                                            WHERE a1.MoProcessId = @MoProcessId)
                                                       AND a.NecessityStatus = 'Y'
                                                       AND a.MoId = @MoId";

                                            dynamicParameters.Add("CurrentSortNumber", CurrentSortNumber);
                                            dynamicParameters.Add("MoProcessId", MoProcessId);
                                            dynamicParameters.Add("MoId", MoId);

                                            var ProcessJumpResult = sqlConnection.Query(sql, dynamicParameters);
                                            #endregion

                                            if (ProcessJumpResult.Count() > 0)
                                            {
                                                JumpFlag = false;
                                            }
                                            else
                                            {
                                                sql = @"SELECT SortNumber
                                                          FROM MES.MoProcess
                                                         WHERE MoProcessId = @MoProcessId";
                                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                                var thisSortResult = sqlConnection.Query(sql, dynamicParameters);
                                                int thisSortNumber = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SortNumber);
                                                if (thisSortNumber < NextSortNumber)
                                                {
                                                    //沒改過NextMoProcess不可往回跳站
                                                    throw new SystemException("條碼【" + BarcodeNo + "】製程應為【" + NextProcessAlias + "】");
                                                }
                                                else
                                                {
                                                    JumpFlag = true;
                                                }
                                            }

                                            if (!JumpFlag)
                                            {
                                                throw new SystemException("條碼【" + BarcodeNo + "】製程應為【" + NextProcessAlias + "】");
                                            }

                                            if (!MoProcessId.Equals(NextMoProcessId) && !JumpFlag) throw new SystemException("條碼【" + BarcodeNo + "】製程為【" + NextProcessAlias + "】");

                                            if (!MoProcessId.Equals(NextMoProcessId) && CurrentSortNumber.Equals(NextSortNumber)) throw new SystemException("條碼【" + BarcodeNo + "】製程為【" + NextProcessAlias + "】");

                                            if (MoProcessId.Equals(CurrentMoProcessId)) throw new SystemException("條碼【" + BarcodeNo + "】製程為【" + NextProcessAlias + "】");
                                        }
                                    }

                                    #region //託外物件過站主邏輯

                                    #region //確認前置程是否有設定製程屬性
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT d.ItemNo,e.TypeDesc
                                              FROM MES.WipOrder a
                                                   INNER JOIN MES.ManufactureOrder b ON a.WoId = b.WoId
	                                               INNER JOIN MES.MoProcess c ON b.MoId = c.MoId
	                                               INNER JOIN MES.MoProcessItem d ON c.MoProcessId = d.MoProcessId
	                                               INNER JOIN BAS.[Type] e ON d.ItemNo = e.TypeNo AND e.TypeSchema = 'RoutingProcessItem.ItemNo'
                                             WHERE c.MoProcessId = @CurrentMoProcessId";

                                    dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                                    var ProcessAttributeResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (ProcessAttributeResult.Count() > 0)
                                    {
                                        string AttributeItemNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).ItemNo;
                                        string AttributeItemName = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TypeDesc;

                                        #region //確認條碼屬性是否有維護
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                                FROM MES.BarcodeAttribute a 
                                                WHERE a.MoId = @MoId
                                                ANd a.BarcodeId = @BarcodeId
                                                AND a.ItemNo = @ItemNo";
                                        dynamicParameters.Add("MoId", MoId);
                                        dynamicParameters.Add("BarcodeId", BarcodeId);
                                        dynamicParameters.Add("ItemNo", AttributeItemNo);

                                        var BarcodeAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (BarcodeAttributeResult.Count() <= 0) throw new SystemException("條碼【" + BarcodeNo + "】前製程需維護【" + AttributeItemName + "】尚未維護!");
                                        #endregion

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT c.BarcodeNo
                                                  FROM MES.BarcodeProcess a
                                                       INNER JOIN MES.BarcodeProcessAttribute b ON a.BarcodeProcessId = b.BarcodeProcessId
	                                                   INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                                 WHERE a.MoProcessId = @CurrentMoProcessId
                                                   AND c.BarcodeNo = @BarcodeNo";
                                        dynamicParameters.Add("CurrentMoProcessId", CurrentMoProcessId);
                                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                        var BarcodeProcessItemAttributeResult = sqlConnection.Query(sql, dynamicParameters);
                                        if (BarcodeProcessItemAttributeResult.Count() == 0) throw new SystemException("條碼前製程需維護【" + AttributeItemName + "】尚未維護!");
                                    }
                                    #endregion

                                    #region //取出班別ID
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.ModeShiftId
                                              FROM MES.ProdModeShift a
                                                   INNER JOIN BAS.[Shift] b ON a.ShiftId = b.ShiftId
                                            WHERE a.ModeId = (SELECT ModeId FROM MES.ManufactureOrder WHERE MoId = @MoId)
                                            AND ((format(CONVERT(datetime,CONVERT(VARCHAR(10),CONVERT(DATE,GETDATE()),120) + ' ' + @CurrentTime),'HH:mm') between b.WorkBeginTime and b.WorkEndTime) or
                                                 (format(dateadd(hour,12,CONVERT(datetime,CONVERT(VARCHAR(10),CONVERT(DATE,GETDATE()),120) + ' ' + @CurrentTime)),'HH:mm') between b.WorkBeginTime and b.WorkEndTime)
                                                )";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("CurrentTime", DateTime.Now.ToString("HH:mm"));

                                    var resultShift = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultShift.Count() <= 0) throw new SystemException("找不到班別!");

                                    foreach (var item1 in resultShift)
                                    {
                                        ModeShiftId = Convert.ToInt32(item1.ModeShiftId);
                                    }
                                    #endregion

                                    #region //新增BarcodeProcess
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId
                                            ,ProdStatus, StationQty,PassQty
                                            ,NgQty,StartDate,FinishDate
                                            ,ModeShiftId,CycleTime,StartUserId
                                            ,FinishUserId
                                            ,CreateDate, CreateBy)
                                            OUTPUT INSERTED.BarcodeProcessId
                                            VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId
                                            ,@ProdStatus, @StationQty, @PassQty
                                            ,@NgQty, @StartDate, @FinishDate
                                            ,@ModeShiftId, @CycleTime, @StartUserId
                                            ,@FinishUserId
                                            ,@CreateDate, @CreateBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeId,
                                            MoId,
                                            MachineId = (int?)null,
                                            MoProcessId,
                                            ProdStatus = "P",
                                            StationQty = BarcodeQty,
                                            PassQty = BarcodeQty,
                                            NgQty = 0,
                                            StartDate = DateTime.Now,
                                            FinishDate = DateTime.Now,
                                            ModeShiftId = 1,
                                            CycleTime = 0,
                                            StartUserId = nUserId,
                                            FinishUserId = nUserId,
                                            CreateDate,
                                            CreateBy = nUserId
                                        });
                                    var insertResult2 = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var item1 in insertResult2)
                                    {
                                        int BarcodeProcessId = Convert.ToInt32(item1.BarcodeProcessId);
                                    }
                                    #endregion

                                    #region //更新Barcode資訊CurrentMoProcessId & NextMoProcessId

                                    #region //取出委外站下一個製程ID, 排除退鎳(目前只能寫死)
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MoProcessId
                                              FROM MES.MoProcess a
                                             WHERE a.MoId = @MoId
                                               AND a.SortNumber = (SELECT MIN(a1.SortNumber)
                                                                     FROM MES.MoProcess a1
						                                            WHERE a.MoId = a1.MoId
						                                              AND a1.ProcessId != 15
						                                              AND a1.SortNumber > (SELECT a2.SortNumber
									  		                                                 FROM MES.MoProcess a2
											                                                WHERE a2.MoProcessId = @MoProcessId))";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("MoProcessId", MoProcessId);
                                    var NextMoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (NextMoProcessResult.Count() > 0)
                                    {
                                        NextMoProcessId = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoProcessId);
                                    }
                                    else
                                    {
                                        NextMoProcessId = -1;
                                    }
                                    #endregion

                                    #region //更新CurrentMoProcessId & NextMoProcessId
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE MES.Barcode 
                                               SET CurrentMoProcessId = @CurrentMoProcessId,
                                                   NextMoProcessId = @NextMoProcessId,
                                                   BarcodeStatus = @BarcodeStatus,
                                                   CurrentProdStatus = 'P',
                                                   LastModifiedDate = @LastModifiedDate,
                                                   LastModifiedBy = @LastModifiedBy
                                             WHERE BarcodeId = @BarcodeId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            CurrentMoProcessId = MoProcessId,
                                            NextMoProcessId,
                                            BarcodeStatus = NextMoProcessId == -1 ? "0" : "1",
                                            LastModifiedDate = DateTime.Now,
                                            LastModifiedBy = nUserId,
                                            BarcodeId
                                        });
                                    int UpdateBarcodeNextResult = sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #endregion

                                    //更新在製
                                    UpdateMoQtyInformation(MoId);

                                    #region //若首站, 則更新製令投量
                                    if (item.SortNumber == 1)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.ManufactureOrder 
                                                   SET InputQty = ISNULL(InputQty,0) + @BarcodeQty,
                                                       [Status] = 'A',
                                                       LastModifiedDate = @LastModifiedDate,
                                                       LastModifiedBy = @LastModifiedBy
                                                 WHERE MoId = @MoId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BarcodeQty,
                                                MoId,
                                                LastModifiedDate = DateTime.Now,
                                                LastModifiedBy,
                                                BarcodeId
                                            });
                                        int UpdateMoInputQty = sqlConnection.Execute(sql, dynamicParameters);
                                    }
                                    else
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.ManufactureOrder 
                                                   SET [Status] = 'A',
                                                       LastModifiedDate = @LastModifiedDate,
                                                       LastModifiedBy = @LastModifiedBy
                                                 WHERE MoId = @MoId
                                                    AND [Status] = 'N'";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MoId,
                                                LastModifiedDate = DateTime.Now,
                                                LastModifiedBy
                                            });
                                        int UpdateMoInputQty = sqlConnection.Execute(sql, dynamicParameters);
                                    }
                                    #endregion

                                    #endregion
                                }

                                #region  //更新OspReceiptDetail.ProcessStatus
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.OspReceiptDetail 
                                           SET ProcessStatus = 'Y',
                                               LastModifiedDate = @LastModifiedDate,
                                               LastModifiedBy = @LastModifiedBy
                                         WHERE OsrDetailId = @OsrDetailId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        OsrDetailId,
                                        LastModifiedDate = DateTime.Now,
                                        LastModifiedBy = nUserId
                                    });
                                int UpdateOsrDetailResult = sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                        }
                        else
                        {
                            throw new SystemException("找不到託外收貨條碼!");
                        }
                        #endregion

                        #endregion
                    }
                    transactionScope.Complete();
                }
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "(" + rowsAffected + " rows affected)"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                throw new SystemException("Error:" + e.Message);
                #endregion
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //TxKeyenceProcess2 -- Keyence模式過站入口(單次)
        public string TxKeyenceProcess2(string Barcode, int MoProcessId, int MachineId, int UserId, int KeyenceId
            , string QtyBarcodeStatus, string QtyLotNgCauseNo, int QtyNextMoProcessId)
        {
            //if (BarcodeList == "") throw new Exception("BarcodeNo 不可為空");
            if (MoProcessId == -1) throw new Exception("MoProcessId 不可為空");
            if (UserId == -1) throw new Exception("UserId 不可為空");

            if (QtyBarcodeStatus == "F")
            {
                if (QtyLotNgCauseNo.Length <= 0) throw new Exception("NG原因不能為空!");
                if (QtyNextMoProcessId <= 0) throw new Exception("下一站製程不能為空!");
            }

            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;

                        #region default
                        DynamicParameters dynamicParameters = new DynamicParameters();
                        #endregion

                        #region //過站
                        //var BarcodeNoList = BarcodeList.Split(',');

                        string BarcodeNo = Barcode;

                        #region //找MOID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId
                                        FROM MES.MoProcess a
                                        WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var moProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (moProcessResult.Count() <= 0) throw new SystemException("查無此製令製程資訊!");

                        int MoId = -1;
                        foreach (var item in moProcessResult)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //確認是否為Tray模式
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TrayBarcode, a.Source
                                        FROM MES.MoSetting a
                                        WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                        string TrayBarcode = "";
                        string Source = "";
                        foreach (var item2 in MoSettingResult)
                        {
                            TrayBarcode = item2.TrayBarcode;
                            Source = item2.Source;
                        }
                        string TrayNo = "";

                        if (TrayBarcode == "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeNo, a.TrayNo
                                                FROM MES.Tray a
                                                WHERE a.TrayNo = @TrayNo";
                            dynamicParameters.Add("TrayNo", BarcodeNo);

                            var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TrayResult.Count() < 0) throw new SystemException("查無此Tray盤資訊!");

                            foreach (var item2 in TrayResult)
                            {
                                //if (item2.BarcodeNo == null) throw new SystemException("此Tray盤尚未綁定條碼!");
                                TrayNo = item2.TrayNo;
                                BarcodeNo = item2.BarcodeNo;
                            }
                        }
                        #endregion

                        #region //將條碼轉成大寫
                        BarcodeNo = BarcodeNo.ToString().ToUpper();
                        #endregion


                        #region //確認條碼資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT BarcodeId
                                        FROM MES.Barcode
                                        WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        //if (BarcodeResult.Count() <= 0) throw new SystemException("條碼【" + BarcodeNo + "】資料錯誤!!");

                        int BarcodeId = -1;
                        if (BarcodeResult.Count() > 0)
                        {
                            foreach (var item in BarcodeResult)
                            {
                                BarcodeId = item.BarcodeId;
                            }

                        }

                        #endregion

                        #region //紀錄KeyenceBarcodeLog
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.KeyenceBarcodeLog (KeyenceId, BarcodeId, MoProcessId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@KeyenceId, @BarcodeId, @MoProcessId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";

                        dynamicParameters.AddDynamicParams(
                          new
                          {
                              KeyenceId,
                              BarcodeId,
                              MoProcessId,
                              CreateDate,
                              LastModifiedDate,
                              CreateBy,
                              LastModifiedBy
                          });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();
                        #endregion

                        TxBarcodeProcessCore(TrayNo.Length > 0 ? TrayNo : BarcodeNo, MoProcessId, MachineId, UserId,
                            QtyBarcodeStatus, QtyLotNgCauseNo, QtyNextMoProcessId, sqlConnection, "");

                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion]

        #region Keyence批量用 20250611

        #region //TxKeyenceProcessFromTemp -- 從暫存表批次處理Keyence過站 (統一交易版本)
        public async Task<string> TxKeyenceProcessFromTemp(int chunkSize = 100)
        {
            var results = new List<object>();
            int successCount = 0;
            int errorCount = 0;
            int totalProcessed = 0;

            try
            {
                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required,
                    new TransactionOptions { IsolationLevel = IsolationLevel.ReadCommitted, Timeout = TimeSpan.FromMinutes(10) },
                    TransactionScopeAsyncFlowOption.Enabled)) // 重要：啟用非同步流程
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        await sqlConnection.OpenAsync(); // 使用非同步開啟連接

                        #region //從暫存表取得待處理資料
                        var tempDataSql = @"
                    SELECT KPTId, Barcode, MoProcessId, MachineId, UserId, KeyenceId, 
                           QtyBarcodeStatus, QtyLotNgCauseNo, QtyNextMoProcessId, ItemNo, ItemValue, ChkUnique, DateCode
                    FROM MES.KeyenceProcessTemp 
                    ORDER BY KPTId";

                        var tempData = (await sqlConnection.QueryAsync(tempDataSql)).ToList(); // 使用非同步查詢

                        if (tempData.Count == 0)
                        {
                            return JObject.FromObject(new
                            {
                                status = "warning",
                                msg = "暫存表中沒有待處理的資料",
                                successCount = 0,
                                errorCount = 0
                            }).ToString();
                        }
                        #endregion

                        #region //按MoProcessId分組處理 (提高效率)
                        var groupedData = tempData.GroupBy(x => new {
                            MoProcessId = (int)x.MoProcessId,
                            MachineId = (int)x.MachineId,
                            UserId = (int)x.UserId,
                            KeyenceId = (int)x.KeyenceId
                        }).ToList();

                        foreach (var group in groupedData)
                        {
                            var groupKey = group.Key;
                            var groupItems = group.ToList();

                            try
                            {
                                // 預先載入該組別的必要資料
                                #region //取得MoId
                                var moIdSql = @"SELECT MoId FROM MES.MoProcess WHERE MoProcessId = @MoProcessId";
                                var moIdResult = await sqlConnection.QueryFirstOrDefaultAsync<int?>(moIdSql, new { MoProcessId = groupKey.MoProcessId });
                                if (!moIdResult.HasValue) throw new SystemException("查無此製令製程資訊!");
                                var moId = moIdResult.Value;
                                #endregion

                                #region //取得MoSetting
                                var moSettingSql = @"SELECT TrayBarcode, Source FROM MES.MoSetting WHERE MoId = @MoId";
                                var moSetting = await sqlConnection.QueryFirstOrDefaultAsync(moSettingSql, new { MoId = moId }) ?? new { TrayBarcode = "N", Source = "" };
                                #endregion

                                #region //批次查詢條碼資訊
                                var barcodes = groupItems.Select(x => ((string)x.Barcode)?.ToUpper() ?? "").Where(b => !string.IsNullOrEmpty(b)).ToList();
                                Dictionary<string, int> barcodeIds = new Dictionary<string, int>();

                                if (barcodes.Count > 0)
                                {
                                    var barcodeIdsSql = @"SELECT BarcodeNo, BarcodeId FROM MES.Barcode WHERE BarcodeNo IN @Barcodes";
                                    var barcodeResults = await sqlConnection.QueryAsync(barcodeIdsSql, new { Barcodes = barcodes });
                                    barcodeIds = barcodeResults.ToDictionary(
                                        x => (string)x.BarcodeNo,
                                        x => (int)x.BarcodeId
                                    );
                                }
                                #endregion

                                #region //Tray對應資料
                                Dictionary<string, string> trayMapping = new Dictionary<string, string>();
                                if (moSetting.TrayBarcode == "Y" && barcodes.Count > 0)
                                {
                                    var trayMappingSql = @"SELECT TrayNo, BarcodeNo FROM MES.Tray WHERE TrayNo IN @TrayNos";
                                    var trayResults = await sqlConnection.QueryAsync(trayMappingSql, new { TrayNos = barcodes });
                                    trayMapping = trayResults.ToDictionary(
                                        x => (string)x.TrayNo,
                                        x => (string)x.BarcodeNo ?? ""
                                    );
                                }
                                #endregion

                                #region //分批處理該組的條碼過站
                                var chunks = groupItems
                                    .Select((item, index) => new { item, index })
                                    .GroupBy(x => x.index / chunkSize)
                                    .Select(g => g.Select(x => x.item).ToList())
                                    .ToList();

                                foreach (var chunk in chunks)
                                {
                                    foreach (var item in chunk)
                                    {
                                        try
                                        {
                                            var inputBarcode = ((string)item.Barcode)?.ToUpper() ?? "";
                                            var finalBarcodeNo = inputBarcode; // 預設使用輸入的條碼

                                            // Tray模式處理
                                            if (moSetting.TrayBarcode == "Y")
                                            {
                                                // 在Tray模式下，inputBarcode 實際上是 TrayNo
                                                var trayNo = inputBarcode;

                                                if (trayMapping.ContainsKey(trayNo) && !string.IsNullOrEmpty(trayMapping[trayNo]))
                                                {
                                                    // 找到對應的BarcodeNo，使用BarcodeNo過站
                                                    finalBarcodeNo = trayMapping[trayNo];
                                                }
                                                else
                                                {
                                                    // 沒找到對應的BarcodeNo，使用TrayNo過站
                                                    finalBarcodeNo = trayNo;
                                                }
                                            }

                                            // NG原因檢查
                                            var qtyBarcodeStatus = item.QtyBarcodeStatus?.ToString() ?? "";
                                            var qtyLotNgCauseNo = item.QtyLotNgCauseNo?.ToString() ?? "";
                                            var qtyNextMoProcessId = (int)(item.QtyNextMoProcessId ?? -1);
                                            var ItemNo = (string)item.ItemNo ?? "";
                                            var ItemValue = (string)item.ItemValue ?? "";
                                            var ChkUnique = (string)item.ChkUnique ?? "N";
                                            var DateCode = (string)item.DateCode ?? "";

                                            // 步驟1：呼叫核心過站邏輯 (使用同一個 sqlConnection)
                                            await Task.Run(() => TxBarcodeProcessCore(finalBarcodeNo, groupKey.MoProcessId, groupKey.MachineId, groupKey.UserId,
                                                qtyBarcodeStatus, qtyLotNgCauseNo, qtyNextMoProcessId, sqlConnection, ""));

                                            // 步驟2：處理BarcodeProcessAttribute (使用同一個 sqlConnection)
                                            if (!string.IsNullOrEmpty(ItemNo))
                                            {
                                                var attributeResult = await Task.Run(() => AddBarcodeProcessAttributeTemp(finalBarcodeNo, ItemNo, ItemValue, ChkUnique, DateCode, sqlConnection));
                                                if (attributeResult != "success")
                                                {
                                                    throw new SystemException("屬性處理失敗");
                                                }
                                            }

                                            // 步驟3：刪除已處理完成的暫存資料 (使用同一個 sqlConnection)
                                            await DeleteTempRecordAsync(sqlConnection, (int)item.KPTId);

                                            results.Add(new
                                            {
                                                kptId = (int)item.KPTId,
                                                barcode = (string)item.Barcode,
                                                status = "success",
                                                message = "過站成功"
                                            });
                                            successCount++;
                                        }
                                        catch (Exception ex)
                                        {
                                            results.Add(new
                                            {
                                                kptId = (int)item.KPTId,
                                                barcode = (string)item.Barcode,
                                                status = "error",
                                                message = ex.Message
                                            });
                                            errorCount++;
                                        }
                                        totalProcessed++;
                                    }

                                    // 每個批次之間稍作延遲
                                    if (chunks.Count > 1) await Task.Delay(5);
                                }
                                #endregion
                            }
                            catch (Exception ex)
                            {
                                // 該組別整體處理失敗
                                foreach (var item in groupItems)
                                {
                                    results.Add(new
                                    {
                                        kptId = (int)item.KPTId,
                                        barcode = (string)item.Barcode,
                                        status = "error",
                                        message = $"群組處理失敗: {ex.Message}"
                                    });
                                    errorCount++;
                                    totalProcessed++;
                                }
                            }
                        }
                        #endregion
                    }

                    transactionScope.Complete();
                }

                #region //Response
                // 提取每個失敗Barcode的失敗原因
                var failureDetails = results
                    .Cast<dynamic>()
                    .Where(r => r.status == "error")
                    .Take(5)  // 只取前5個
                    .Select(r => $"{r.barcode}: {r.message}")
                    .ToList();

                // 如果失敗數量超過5個，加入提示
                if (errorCount > 5)
                {
                    failureDetails.Add($"... 還有 {errorCount - 5} 個失敗項目");
                }

                var failureReasonsText = failureDetails.Count > 0 ? string.Join("; ", failureDetails) : "無";

                jsonResponse = JObject.FromObject(new
                {
                    status = errorCount == 0 ? "success" : "error",
                    msg = $"批次處理完成 - 總處理: {totalProcessed}, 成功: {successCount}, 失敗: {errorCount}, 失敗原因: {failureReasonsText}"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "error",
                    msg = $"批次處理發生錯誤: {e.Message}",
                    totalProcessed = totalProcessed,
                    successCount = successCount,
                    errorCount = errorCount,
                    details = results
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region // AddBarcodeProcessAttributeTemp - 從暫存新增屬性
        public string AddBarcodeProcessAttributeTemp(string BarcodeNo, string ItemNo, string ItemValue,
            string ChkUnique, string DateCode, SqlConnection sqlConnection)
        {
            try
            {
                int rowsAffected = 0;
                int UserId = CreateBy;
                bool LetteringBool = false;

                #region //判斷Type資料是否正確
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT TypeName
                FROM BAS.[Type] a
                WHERE a.TypeSchema = 'RoutingProcessItem.ItemNo'
                AND a.TypeNo = @TypeNo";
                dynamicParameters.Add("TypeNo", ItemNo);

                var result3 = sqlConnection.Query(sql, dynamicParameters);
                if (result3.Count() <= 0) throw new SystemException("屬性設定資料錯誤!");

                string TypeName = "";
                foreach (var item2 in result3)
                {
                    TypeName = item2.TypeName;
                }
                #endregion

                #region //判斷製令歷程資料是否正確 - 查詢最新的BarcodeProcessId
                dynamicParameters = new DynamicParameters();
                sql = @"SELECT TOP 1 a.MoId, a.BarcodeId, a.BarcodeProcessId, c.BarcodeNo
                FROM MES.BarcodeProcess a
                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                INNER JOIN MES.Tray c ON b.BarcodeNo = c.BarcodeNo
                WHERE c.TrayNo = @TrayNo
                ORDER BY a.BarcodeProcessId DESC";
                dynamicParameters.Add("TrayNo", BarcodeNo);

                var result = sqlConnection.Query(sql, dynamicParameters);
                if (result.Count() <= 0)
                {
                    // 如果Tray查詢失敗，嘗試直接用BarcodeNo查詢
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.MoId, a.BarcodeId, a.BarcodeProcessId
                    FROM MES.BarcodeProcess a
                    INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                    WHERE b.BarcodeNo = @BarcodeNo
                    ORDER BY a.BarcodeProcessId DESC";
                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("製令歷程資料錯誤!");
                }

                int MoId = -1;
                int BarcodeId = -1;
                int BarcodeProcessId = -1;

                foreach (var item2 in result)
                {
                    MoId = item2.MoId;
                    BarcodeId = item2.BarcodeId;
                    BarcodeProcessId = item2.BarcodeProcessId;
                }
                #endregion

                int ItemSeq = -1;
                string MoItemPartNo = "";
                if (ItemNo == "Lettering")
                {
                    var intFlag = int.TryParse(ItemValue, out int stringToInt);
                    if (intFlag == false) throw new SystemException("刷取後的刻字資料錯誤，請洽系統開發室確認!");

                    #region //判斷刻字資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 MoItemPartSortNumber, MoItemPartNo
                    FROM MES.MoItemPart
                    WHERE MoItemPartId = @MoItemPartId
                    AND MoId = @MoId";
                    dynamicParameters.Add("MoItemPartId", ItemValue);
                    dynamicParameters.Add("MoId", MoId);

                    var result2 = sqlConnection.Query(sql, dynamicParameters);
                    if (result2.Count() <= 0) throw new SystemException("刻字資料錯誤!");

                    foreach (var item3 in result2)
                    {
                        ItemSeq = item3.MoItemPartSortNumber;
                        MoItemPartNo = item3.MoItemPartNo;
                        ItemValue = MoItemPartNo;
                    }
                    #endregion
                }

                #region //檢查DateCode日期是否大於今天日期
                DateTime dateCode = DateTime.Parse(DateCode);
                DateTime today = DateTime.Now;

                if (dateCode > today) throw new SystemException("屬性日期不能大於今天日期!!");
                #endregion

                #region //INSERT MES.BarcodeProcessAttribute
                dynamicParameters = new DynamicParameters();
                sql = @"INSERT INTO MES.BarcodeProcessAttribute (BarcodeProcessId, ItemNo, ItemValue, ItemSeq
                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                OUTPUT INSERTED.ProcessAttrId
                VALUES (@BarcodeProcessId, @ItemNo, @ItemValue, @ItemSeq
                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                dynamicParameters.AddDynamicParams(
                    new
                    {
                        BarcodeProcessId = BarcodeProcessId,
                        ItemNo = ItemNo,
                        ItemValue = ItemValue,
                        ItemSeq = ItemSeq != -1 ? ItemSeq : (int?)null,
                        CreateDate,
                        LastModifiedDate,
                        CreateBy = UserId,
                        LastModifiedBy = UserId
                    });

                var insertResult = sqlConnection.Query(sql, dynamicParameters);
                rowsAffected += insertResult.Count();
                #endregion

                if (LetteringBool == false)
                {
                    #region //檢查此條碼是否已綁定過相同製程相同屬性之資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.BarcodeAttrId
                    FROM MES.BarcodeAttribute a
                    WHERE a.BarcodeId = @BarcodeId
                    AND a.ItemNo = @ItemNo
                    ORDER BY a.CreateDate DESC";
                    dynamicParameters.Add("BarcodeId", BarcodeId);
                    dynamicParameters.Add("ItemNo", ItemNo);

                    var BarcodeAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                    if (BarcodeAttributeResult.Count() > 0)
                    {
                        foreach (var item4 in BarcodeAttributeResult)
                        {
                            #region //UPDATE MES.BarcodeAttribute
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.BarcodeAttribute SET
                            MoId = @MoId,
                            ItemValue = @ItemValue,
                            ItemSeq = @ItemSeq,
                            DateCode = @DateCode
                            WHERE BarcodeAttrId = @BarcodeAttrId";
                            dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoId,
                                ItemValue = ItemValue,
                                ItemSeq = ItemSeq != -1 ? ItemSeq : (int?)null,
                                DateCode = DateCode,
                                item4.BarcodeAttrId
                            });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                    }
                    else
                    {
                        #region //INSERT MES.BarcodeAttribute
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeAttribute (MoId, BarcodeId, ItemNo, ItemValue, ItemSeq, DateCode
                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                        OUTPUT INSERTED.BarcodeAttrId
                        VALUES (@MoId, @BarcodeId, @ItemNo, @ItemValue, @ItemSeq, @DateCode
                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoId,
                                BarcodeId,
                                ItemNo = ItemNo,
                                ItemValue = ItemValue,
                                ItemSeq = ItemSeq != -1 ? ItemSeq : (int?)null,
                                DateCode = DateCode,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        insertResult = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected += insertResult.Count();
                        #endregion
                    }
                    #endregion
                }

                return "success";
            }
            catch (Exception e)
            {
                throw new SystemException($"新增製程屬性資料失敗: {e.Message}");
            }
        }
        #endregion

        #region //輔助方法
        private async Task DeleteTempRecordAsync(SqlConnection sqlConnection, int kptId)
        {
            var deleteSql = "DELETE FROM MES.KeyenceProcessTemp WHERE KPTId = @KPTId";
            await sqlConnection.ExecuteAsync(deleteSql, new { KPTId = kptId });
        }
        #endregion

        #region //AddKeyenceProcessTemp --新增KeyenceTemp GPai 20250611
        public string AddKeyenceProcessTemp(string BarcodeList, int MoProcessId, int MachineId, int UserId, int KeyenceId
            , string QtyBarcodeStatus, string QtyLotNgCauseNo, int QtyNextMoProcessId, string ItemNo, string ItemValue, string ChkUnique, string DateCode)
        {
            try
            {
                //var UserId = CreateBy;
                int rowsAffected = 0;


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        var BarcodeNoList = BarcodeList.Split(',');

                        foreach (var barcodeNo in BarcodeNoList)
                        {
                            string BarcodeNo = barcodeNo.Trim();

                            #region //條碼是否存在TrayTemp中?
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT * 
                                FROM MES.TrayTemp a
                                WHERE a.TrayTempNo = @TrayTempNo";
                            dynamicParameters.Add("TrayTempNo", BarcodeNo);

                            var TrayTempresult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //條碼是否存在Tray中?
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT * 
                                FROM MES.Tray a
                                WHERE a.TrayNo = @TrayNo";
                            dynamicParameters.Add("TrayNo", BarcodeNo);

                            var Trayresult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //條碼是否存在過站暫存中?
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT * 
                                FROM MES.KeyenceProcessTemp a
                                WHERE a.Barcode = @Barcode";
                            dynamicParameters.Add("Barcode", BarcodeNo);

                            var KeyenceProcessTempresult = sqlConnection.Query(sql, dynamicParameters);
                            //if (result.Count() > 0) throw new SystemException("該條碼已新增暫存!: " + BarcodeNo);
                            #endregion

                            #region 如果Tray表沒有則幫Insert
                            if (TrayTempresult.Count() > 0 && Trayresult.Count() <= 0)
                            {

                                #region //新增tray表
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.Tray (CompanyId, TrayNo, Remark, 
                                      UseTimes, Status, CreateDate, LastModifiedDate, 
                                      CreateBy, LastModifiedBy)                                
                                      VALUES (@CompanyId, @TrayNo, @Remark, 
                                              @UseTimes, @Status, @CreateDate, @LastModifiedDate, 
                                              @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                CompanyId = CurrentCompany,
                                                TrayNo = BarcodeNo,
                                                Remark = "",
                                                UseTimes = 0,
                                                Status = 'A',
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy = UserId,
                                                LastModifiedBy = UserId
                                            });

                                var TrayinsertResult = sqlConnection.Query(sql, dynamicParameters);
                                rowsAffected = TrayinsertResult.Count();
                                #endregion

                                #region //更新Temp
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.TrayTemp SET
                                [Status] = @Status,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE TrayTempNo = @TrayTempNo";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      Status = 'S',
                                      LastModifiedDate,
                                      LastModifiedBy = UserId,
                                      TrayTempNo = BarcodeNo
                                  });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //新增KeyenceProcessTemp
                                if (KeyenceProcessTempresult.Count() <= 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.KeyenceProcessTemp (Barcode, MoProcessId, MachineId, UserId, KeyenceId, QtyBarcodeStatus
                                        , QtyLotNgCauseNo, QtyNextMoProcessId, ItemNo, ItemValue, ChkUnique, DateCode
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@Barcode, @MoProcessId, @MachineId, @UserId, @KeyenceId, @QtyBarcodeStatus, @QtyLotNgCauseNo
                                        , @QtyNextMoProcessId, @ItemNo, @ItemValue, @ChkUnique, @DateCode
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    Barcode = BarcodeNo,
                                                    MoProcessId,
                                                    MachineId,
                                                    UserId,
                                                    KeyenceId,
                                                    QtyBarcodeStatus,
                                                    QtyLotNgCauseNo,
                                                    QtyNextMoProcessId,
                                                    ItemNo,
                                                    ItemValue,
                                                    ChkUnique = "N",
                                                    DateCode,
                                                    CreateDate,
                                                    LastModifiedDate,
                                                    CreateBy = UserId,
                                                    LastModifiedBy = UserId
                                                });

                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected = insertResult.Count();
                                }
                                #endregion

                            }
                            else if ( Trayresult.Count() > 0)//Tray有則僅新增KeyenceProcessTemp
                            {
                                #region //新增KeyenceProcessTemp
                                if (KeyenceProcessTempresult.Count() <= 0)
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.KeyenceProcessTemp (Barcode, MoProcessId, MachineId, UserId, KeyenceId, QtyBarcodeStatus
                                        , QtyLotNgCauseNo, QtyNextMoProcessId, ItemNo, ItemValue, ChkUnique, DateCode
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@Barcode, @MoProcessId, @MachineId, @UserId, @KeyenceId, @QtyBarcodeStatus, @QtyLotNgCauseNo
                                        , @QtyNextMoProcessId, @ItemNo, @ItemValue, @ChkUnique, @DateCode
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    Barcode = BarcodeNo,
                                                    MoProcessId,
                                                    MachineId,
                                                    UserId,
                                                    KeyenceId,
                                                    QtyBarcodeStatus,
                                                    QtyLotNgCauseNo,
                                                    QtyNextMoProcessId,
                                                    ItemNo,
                                                    ItemValue,
                                                    ChkUnique = "N",
                                                    DateCode,
                                                    CreateDate,
                                                    LastModifiedDate,
                                                    CreateBy = UserId,
                                                    LastModifiedBy = UserId
                                                });

                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);
                                    rowsAffected = insertResult.Count();
                                }
                                #endregion
                            }
                            else if (TrayTempresult.Count() <= 0 && Trayresult.Count() <= 0)
                            {
                                throw new SystemException("該Tray條碼查無資料!: " + BarcodeNo);
                            }




                            #endregion




                        }




                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetBarcodeTrayKence -- 取得條碼資料 -- GPAI 2025-06-24
        public string GetBarcodeTrayKence(string TrayNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TrayId, a.TrayNo, a.TrayName, a.TrayCapacity, a.Remark, a.UseTimes, a.Status
                                   , a.BarcodeNo
                                   , (e.WoErpPrefix + '-' + e.WoErpNo + '(' + CONVERT(Varchar, d.WoSeq) + ')') MoNo
                                   , b.BarcodeQty
                                   , b1.TrayBarcodeLogId
                                   , a1.UserNo + ':' + a1.UserName CreateUser
                                   , FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm') CreateDate
                                   , (SELECT f2.ItemNo, f2.ItemSeq, (ea.TypeName + ':' + f2.ItemValue) ItemValue
                                      FROM MES.BarcodeAttribute f2 
                                      INNER JOIN BAS.[Type] ea ON f2.ItemNo = ea.TypeNo AND ea.TypeSchema = 'RoutingProcessItem.ItemNo'
                                      WHERE f2.BarcodeId = c.BarcodeId 
                                      FOR JSON AUTO) AS BarcodeAttributes
                            FROM MES.Tray a
                            INNER JOIN BAS.[User] a1 ON a.CreateBy = a1.UserId
                            LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                            LEFT JOIN MES.BarcodeProcess c ON c.BarcodeId = b.BarcodeId
                            LEFT JOIN MES.ManufactureOrder d ON b.MoId = d.MoId
                            LEFT JOIN MES.WipOrder e ON d.WoId = e.WoId
                            OUTER APPLY (SELECT TOP 1 b.TrayBarcodeLogId FROM MES.TrayBarcodeLog b WHERE a.TrayId = b.TrayId) b1
                            WHERE a.CompanyId = @CompanyId AND a.TrayNo LIKE '%' + @TrayNo + '%'";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("TrayNo", TrayNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetKeyenceProcessTemp -- 取得條碼暫存資料 -- GPAI 2025-06-24
        public string GetKeyenceProcessTemp(string TrayNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT *
                            FROM MES.KeyenceProcessTemp a
                            WHERE a.Barcode = @Barcode";
                    dynamicParameters.Add("Barcode", TrayNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion



        #endregion


        #endregion

        #region //Validation

        #endregion

        #region//銑床編程上拋
        public string MillNcUpAsync(string PostNCData = "")
        {
            string Result = "";
            try
            {
                using (HttpClient client = new HttpClient())
                {
                    string apiUrl = "http://192.168.145.55:8080/api/YcmNCData";
                    string beforePostData = Path.GetFileName(PostNCData), afterPostData = "";

                    client.Timeout = TimeSpan.FromMinutes(60);
                    using (HttpRequestMessage httpRequestMessage = new HttpRequestMessage(HttpMethod.Post, apiUrl))
                    {
                        byte[] FileBytes = System.IO.File.ReadAllBytes(PostNCData);
                        MultipartFormDataContent formData = new MultipartFormDataContent
                        {
                            { new StreamContent(new MemoryStream(FileBytes)), "PostNCData",Path.GetFileName(PostNCData)}
                        };
                        httpRequestMessage.Content = formData;
                        using (HttpResponseMessage httpResponseMessage = client.SendAsync(httpRequestMessage).GetAwaiter().GetResult())
                        {
                            if (httpResponseMessage.IsSuccessStatusCode)
                            {
                                return httpResponseMessage.Content.ReadAsStringAsync().Result.ToString();
                            }
                            else
                            {
                                return "伺服器連線異常";
                            }
                        }
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "error",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return Result;
        }
        //public async Task<string> MillNcUpAsync(string PostNCData = "")
        //{
        //    var Res = "";
        //    var clientUrl = "http://localhost:56619/api/ERP/getTest";
        //    //var clientUrl = "http://192.168.145.55:8080/api/YcmNCData";
        //    using (HttpClient client = new HttpClient())
        //    {
        //        byte[] FileBytes = System.IO.File.ReadAllBytes(PostNCData);
        //        MultipartFormDataContent formData = new MultipartFormDataContent
        //        {
        //            { new StreamContent(new MemoryStream(FileBytes)), "PostNCData",Path.GetFileName(PostNCData)}
        //        };
        //        HttpResponseMessage result;
        //        try
        //        {
        //            result = await client.PostAsync(clientUrl, formData);
        //            result.EnsureSuccessStatusCode();
        //        }
        //        catch (HttpRequestException ex)
        //        {
        //            throw new SystemException($"伺服器回應異常: {ex.Message}");
        //        }
        //        // 如果成功，讀取並返回內容
        //        var responseContent = await result.Content.ReadAsStringAsync();
        //        Res = responseContent;
        //        return Res;
        //        //var result = await client.PostAsync(clientUrl, formData);
        //        //var input = await result.Content.ReadAsStringAsync();
        //        //if (result.IsSuccessStatusCode)
        //        //{
        //        //    var responseContent = await result.Content.ReadAsStringAsync();
        //        //}
        //        //else
        //        //{
        //        //    throw new SystemException("伺服器連線異常，請聯絡資訊人員!");
        //        //}
        //        //return result;
        //    }
        //}
        #endregion

        #region //Model
        public class AqBarcode
        {
            public int? QcRecordId { get; set; }
            public int? BarcodeId { get; set; }
            public int? ConformUserId { get; set; }
            public int? ResponsibleDeptId { get; set; }
            public int? ResponsibleUserId { get; set; }
            public int? SubResponsibleDeptId { get; set; }
            public int? SubResponsibleUserId { get; set; }
            public int? ProgrammerUserId { get; set; }
            public int? MoProcessId { get; set; }
            public DateTime DocDate { get; set; }
            public string QcType { get; set; }
            public int? MoId { get; set; }
            public int? QcBarcodeId { get; set; }
            public int? DefectCauseId { get; set; }
        }

        public class QcNgCode
        {
            public int? BarcodeId { get; set; }
            public int? QcItemId { get; set; }
            public int? CauseId { get; set; }
            public string CauseDesc { get; set; }
        }
        #endregion

        #region //Tray過站相關 GPAI 2024-02-28

        #region //綁鏡頭條碼

        #region //Get
        #region //GetTrayBarcodeInfo -- 取得TRAY盤條碼資訊 -- GPAI 2024-02-28
        public string GetTrayBarcodeInfo(int MoId, string TrayNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //找Tray是否存在
                    dynamicParameters = new DynamicParameters();

                    sql = @"select TrayNo, BarcodeNo from MES.Tray
                            where TrayNo = @TrayNo";

                    dynamicParameters.Add("TrayNo", TrayNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result1 = sqlConnection.Query(sql, dynamicParameters);

                    if (result1.Count() <= 0) throw new SystemException("查無Tray盤資訊");
                    #endregion


                    sql = @"SELECT a.TrayId, a.TrayNo, b.BarcodeId, b.BarcodeNo, b.BarcodeQty, d.WoErpPrefix, d.WoErpNo, b.CurrentMoProcessId, b.BarcodeStatus
                            , e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, b.TrayLocation, g.MtlItemNo, b.MoId
                            FROM MES.Tray a
                            inner join MES.Barcode b on a.BarcodeNo = b.BarcodeNo
                            inner join MES.ManufactureOrder c on b.MoId = c.MoId
                            inner join MES.WipOrder d on c.WoId = d.WoId
                            inner join MES.MoProcess e on b.CurrentMoProcessId = e.MoProcessId
                            inner join MES.Process f on e.ProcessId = f.ProcessId 
                            inner join PDM.MtlItem g on d.MtlItemId = g.MtlItemId
                            WHERE a.TrayNo = @TrayNo";

                    dynamicParameters.Add("TrayNo", TrayNo);
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("MoId", MoId);


                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    //if (result.Count() <= 0 ) throw new SystemException("該Tray盤無綁定任何批量條碼");
                    foreach (var item in result) {
                        if (item.MoId != MoId) throw new SystemException("該Tray盤不屬於本製令");

                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //GetTrayLOTBarcodeInfo -- 取得條碼資訊 -- GPAI 2024-05-09
        public string GetTrayLOTBarcodeInfo(int MoId, string inputNo)
        {
            try
            {
                string trayNo = "";
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();


                    #region //找Barcode是否存在
                    dynamicParameters = new DynamicParameters();

                    sql = @"select * from MES.Barcode
                            where BarcodeNo = @BarcodeNo";

                    dynamicParameters.Add("BarcodeNo", inputNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result2 = sqlConnection.Query(sql, dynamicParameters);
                    if (result2.Count() <= 0) throw new SystemException("查無該條碼資訊");

                    #endregion


                    sql = @"SELECT b.TrayId, b.TrayNo, a.BarcodeId, b.BarcodeNo, a.BarcodeQty, d.WoErpPrefix, d.WoErpNo, a.CurrentMoProcessId, a.BarcodeStatus
                            , e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, a.TrayLocation, g.MtlItemNo, a.MoId
                            FROM MES.Barcode a
                            left join MES.Tray b on a.BarcodeNo = b.BarcodeNo
                            inner join MES.ManufactureOrder c on a.MoId = c.MoId
                            inner join MES.WipOrder d on c.WoId = d.WoId
                            inner join MES.MoProcess e on a.CurrentMoProcessId = e.MoProcessId
                            inner join MES.Process f on e.ProcessId = f.ProcessId 
                            inner join PDM.MtlItem g on d.MtlItemId = g.MtlItemId
                            WHERE a.BarcodeNo = @BarcodeNo AND c.MoId = @MoId";

                        dynamicParameters.Add("BarcodeNo", inputNo);
                        //dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MoId", MoId);

                 




                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    //if (result.Count() <= 0 ) throw new SystemException("該Tray盤無綁定任何批量條碼");
                    foreach (var item in result)
                    {
                        if (item.MoId != MoId) throw new SystemException("該條碼不屬於本製令");

                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion


        #region //GetTrayBindLens -- 取得TRAY盤已綁定鏡頭條碼列表 -- GPAI 2024-02-28
        public string GetTrayBindLens(int ParentBarcodeId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"select a.BarcodeId, a.BarcodeNo, a.TrayLocation, b.UserNo, b.UserName, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate  from MES.Barcode a
                            INNER JOIN BAS.[User] b ON a.LastModifiedBy = b.UserId

                            where ParentBarcode = @ParentBarcode";

                    dynamicParameters.Add("ParentBarcode", ParentBarcodeId);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region//Add

        #region //AddBarcodeToBindLens --Tray綁鏡頭條碼
        public string AddBarcodeToBindLens(string TrayNo, string XTrayLocation, string YTrayLocation, string BarcodeNo, int MoId, int MoProcessId)
        {
            if (LastModifiedBy <= 0) throw new SystemException("使用者資料錯誤，請重整頁面!!");
            if (CreateBy <= 0) throw new SystemException("使用者資料錯誤，請重整頁面!!");

            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    string lotBarcode = "";

                    #region //找Tray綁定LotBarcode資訊\
                    sql = @"select TrayNo, BarcodeNo from MES.Tray
                            where TrayNo = @TrayNo";

                    dynamicParameters.Add("TrayNo", TrayNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result1 = sqlConnection.Query(sql, dynamicParameters);

                    if (result1.Count() <= 0) throw new SystemException("查無Tray盤資訊");
                    foreach (var item in result1) {
                        lotBarcode = item.BarcodeNo;
                    }
                    #endregion

                    #region //找LotBarcode資訊\
                    dynamicParameters = new DynamicParameters();

                    int nextMoProcessId = 0;
                    string currentProdStatus = "";
                    string barcodeStatus = "";
                    int lotBarcodeId = 0;
                    int lotBarcodeQty = 0;
                    string trayLocation = "";

                    if (XTrayLocation != "" && YTrayLocation != "")
                    {
                        trayLocation = XTrayLocation + "-" + YTrayLocation;
                    }
                    else
                    {
                        trayLocation = "";
                    }

                    sql = @"select * from MES.Barcode
                            where BarcodeNo = @BarcodeNo";

                    dynamicParameters.Add("BarcodeNo", lotBarcode);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                    if (result2.Count() <= 0) throw new SystemException("查無Tray盤綁定條碼資訊");
                    foreach (var item in result2)
                    {
                        if (item.BarcodeStatus == "0") throw new SystemException("該Tray綁定條碼已完工");
                        if (item.MoId != MoId) throw new SystemException("該Tray不屬於當前製令");
                        if (item.CurrentMoProcessId != MoProcessId) throw new SystemException("該Tray當前站別不是該站");
                        if (item.BarcodeQty == 0) throw new SystemException("該條碼數量為0");

                        nextMoProcessId = item.NextMoProcessId;
                        currentProdStatus = item.CurrentProdStatus;
                        barcodeStatus = item.BarcodeStatus;
                        lotBarcodeId = item.BarcodeId;
                        lotBarcodeQty = item.BarcodeQty;
                    }
                    #endregion

                    #region //找綁定此LotBarcode的Len\
                    dynamicParameters = new DynamicParameters();

                    sql = @"select * from MES.Barcode
                            where ParentBarcode = @ParentBarcode";

                    dynamicParameters.Add("ParentBarcode", lotBarcodeId);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result3 = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in result3)
                    {
                        if (trayLocation != "" && item.TrayLocation == trayLocation) throw new SystemException("該位置已綁定!");
                        if (item.BarcodeNo == BarcodeNo) throw new SystemException("該鏡頭條碼已綁定在該Tray");
                        //if (item.CurrentMoProcessId != MoProcessId) throw new SystemException("該Tray當前站別不是該站");
                        if (result3.Count() == lotBarcodeQty ) throw new SystemException("該Tray盤綁定已達上限!");

                    }
                    #endregion

                    #region //Len是否綁定其他TRAY\
                    dynamicParameters = new DynamicParameters();

                    sql = @"select * from MES.Barcode
                            where BarcodeNo = @BarcodeNo";

                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result4 = sqlConnection.Query(sql, dynamicParameters);

                    int barcodeId = 0;

                    if (result4.Count() > 0) {
                        foreach (var item in result4)
                        {
                            if (item.ParentBarcode != null && item.ParentBarcode != -1) throw new SystemException("該條碼已綁定其他TRAY!");
                            barcodeId = item.BarcodeId;
                        }
                    }

                    #endregion

                    #region //是否有LOT過站紀錄.
                    int machineId = 0;
                    string prodStatus = "";
                    int modeShiftId = 0;

                    dynamicParameters = new DynamicParameters();

                    sql = @"select top 1 * from MES.BarcodeProcess
                            where BarcodeId = @BarcodeId and MoProcessId = @MoProcessId and FinishDate is not null
                            order by BarcodeProcessId desc";

                    dynamicParameters.Add("BarcodeId", lotBarcodeId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);


                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result6 = sqlConnection.Query(sql, dynamicParameters);
                    if (result6.Count() <= 0) throw new SystemException("該Tray條碼無此站過站紀錄!");
                    foreach (var item in result6)
                    {
                        if (item.MoId != MoId) throw new SystemException("該條碼不屬於當前製令");
                        //if (item.MoProcessId != MoProcessId) throw new SystemException("該條碼當前站別不是該站");
                        machineId = item.MachineId;
                        prodStatus = item.ProdStatus;
                        modeShiftId = item.ModeShiftId;
                    }
                    #endregion

                    #region //是否有過站紀錄.
                    dynamicParameters = new DynamicParameters();

                    sql = @"select top 1 * from MES.BarcodeProcess
                            where BarcodeId = @BarcodeId
                            order by BarcodeProcessId desc";

                    dynamicParameters.Add("BarcodeId", barcodeId);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result5 = sqlConnection.Query(sql, dynamicParameters);
                    if (result5.Count() > 0)
                    {
                        //throw new SystemException("該鏡頭條碼有過站紀錄!");
                        foreach (var item in result5)
                        {
                            if (item.MoId != MoId) throw new SystemException("該條碼不屬於當前製令");
                            //if (item.MoProcessId != MoProcessId) throw new SystemException("該條碼當前站別不是該站");

                        }
                    }
                    #endregion

                    #region //INSERT
                    int rowsAffected = 0;

                    int insteredBarcode = 0;

                   



                    if (result4.Count() > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode
                                SET 
                                ParentBarcode = @ParentBarcode,
                                TrayLocation = @TrayLocation,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ParentBarcode = lotBarcodeId,
                                TrayLocation = trayLocation,
                                LastModifiedDate,
                                LastModifiedBy,
                                barcodeId
                            });
                        insteredBarcode = barcodeId;
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                    }
                    else {
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus, ParentBarcode, TrayLocation
                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                            OUTPUT INSERTED.BarcodeId
                            VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus, @ParentBarcode, @TrayLocation
                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo,
                                CurrentMoProcessId = MoProcessId,
                                NextMoProcessId = nextMoProcessId,
                                MoId,
                                BarcodeQty = 1,
                                BarcodeProcessId = -1,
                                CurrentProdStatus = currentProdStatus,
                                BarcodeStatus = barcodeStatus,
                                ParentBarcode = lotBarcodeId,
                                TrayLocation = trayLocation,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy = CreateBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();

                        foreach (var item in insertResult) {
                            insteredBarcode = item.BarcodeId;

                        }

                    }

                    #region //INSERT MES.BarcodeProcess
                    dynamicParameters = new DynamicParameters();
                    sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, StartDate
                                        , FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeProcessId
                                        VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @StartDate
                                        , @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                    dynamicParameters.AddDynamicParams(
                        new
                        {
                            BarcodeId = insteredBarcode,
                            MoId,
                            MachineId  =machineId,
                            MoProcessId,
                            ProdStatus = prodStatus,
                            StationQty = 1,
                            PassQty = 0,
                            NgQty =  0,
                            StartDate = CreateDate,
                            FinishDate = CreateDate,
                            ModeShiftId = modeShiftId,
                            CycleTime = 0,
                            StartUserId = CreateBy,
                            FinishUserId = CreateBy,
                            CreateDate,
                            LastModifiedDate,
                            CreateBy = CreateBy,
                            LastModifiedBy = CreateBy
                        });

                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                    #endregion

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = rowsAffected
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }

        #endregion

        #region //AddBarcodeToBindLensLot --Lot綁鏡頭條碼
        public string AddBarcodeToBindLensLot(string LotNo, string XTrayLocation, string YTrayLocation, string BarcodeNo, int MoId, int MoProcessId)
        {

            if (LastModifiedBy <= 0) throw new SystemException("使用者資料錯誤，請重整頁面!!");
            if (CreateBy <= 0) throw new SystemException("使用者資料錯誤，請重整頁面!!");

            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();


                    #region //找LotBarcode資訊\
                    dynamicParameters = new DynamicParameters();

                    int nextMoProcessId = 0;
                    string currentProdStatus = "";
                    string barcodeStatus = "";
                    int lotBarcodeId = 0;
                    int lotBarcodeQty = 0;
                    
                    string trayLocation = "";

                    if (XTrayLocation != "" && YTrayLocation != "")
                    {
                        trayLocation = XTrayLocation + "-" + YTrayLocation;
                    } else {
                        trayLocation = "";
                    }

                    sql = @"select * from MES.Barcode
                            where BarcodeNo = @BarcodeNo";

                    dynamicParameters.Add("BarcodeNo", LotNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                    if (result2.Count() <= 0) throw new SystemException("查無批量條碼資訊");
                    foreach (var item in result2)
                    {
                        if (item.BarcodeStatus == "0") throw new SystemException("該Tray綁定條碼已完工");
                        if (item.MoId != MoId) throw new SystemException("該Tray不屬於當前製令");
                        if (item.CurrentMoProcessId != MoProcessId) throw new SystemException("該Tray當前站別不是該站");
                        if (item.BarcodeQty == 0) throw new SystemException("該條碼數量為0");

                        nextMoProcessId = item.NextMoProcessId;
                        currentProdStatus = item.CurrentProdStatus;
                        barcodeStatus = item.BarcodeStatus;
                        lotBarcodeId = item.BarcodeId;
                        lotBarcodeQty = item.BarcodeQty;
                    }
                    #endregion

                    #region //找綁定此LotBarcode的Len\
                    dynamicParameters = new DynamicParameters();

                    sql = @"select * from MES.Barcode
                            where ParentBarcode = @ParentBarcode";

                    dynamicParameters.Add("ParentBarcode", lotBarcodeId);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result3 = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in result3)
                    {
                        if (trayLocation != "" && item.TrayLocation == trayLocation) throw new SystemException("該位置已綁定!");
                        if (item.BarcodeNo == BarcodeNo) throw new SystemException("該鏡頭條碼已綁定在該Tray");
                        //if (item.CurrentMoProcessId != MoProcessId) throw new SystemException("該Tray當前站別不是該站");
                        if (result3.Count() == lotBarcodeQty) throw new SystemException("該Tray盤綁定已達上限!");

                    }
                    #endregion

                    #region //Len是否綁定其他TRAY\
                    dynamicParameters = new DynamicParameters();

                    sql = @"select * from MES.Barcode
                            where BarcodeNo = @BarcodeNo";

                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result4 = sqlConnection.Query(sql, dynamicParameters);

                    int barcodeId = 0;

                    if (result4.Count() > 0)
                    {
                        foreach (var item in result4)
                        {
                            if (item.ParentBarcode != null && item.ParentBarcode != -1) throw new SystemException("該條碼已綁定其他TRAY!");
                            barcodeId = item.BarcodeId;
                        }
                    }

                    #endregion

                    #region //是否有LOT過站紀錄.
                    int machineId = 0;
                    string prodStatus = "";
                    int modeShiftId = 0;

                    dynamicParameters = new DynamicParameters();

                    sql = @"select top 1 * from MES.BarcodeProcess
                            where BarcodeId = @BarcodeId and MoProcessId = @MoProcessId and FinishDate is not null
                            order by BarcodeProcessId desc";

                    dynamicParameters.Add("BarcodeId", lotBarcodeId);
                    dynamicParameters.Add("MoProcessId", MoProcessId);


                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result6 = sqlConnection.Query(sql, dynamicParameters);
                    if (result6.Count() <= 0) throw new SystemException("該Tray條碼無此站過站紀錄!");
                    foreach (var item in result6)
                    {
                        if (item.MoId != MoId) throw new SystemException("該條碼不屬於當前製令");
                        //if (item.MoProcessId != MoProcessId) throw new SystemException("該條碼當前站別不是該站");
                        machineId = item.MachineId;
                        prodStatus = item.ProdStatus;
                        modeShiftId = item.ModeShiftId;
                    }
                    #endregion

                    #region //是否有過站紀錄.
                    dynamicParameters = new DynamicParameters();

                    sql = @"select top 1 * from MES.BarcodeProcess
                            where BarcodeId = @BarcodeId
                            order by BarcodeProcessId desc";

                    dynamicParameters.Add("BarcodeId", barcodeId);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result5 = sqlConnection.Query(sql, dynamicParameters);
                    if (result5.Count() > 0)
                    {
                        //throw new SystemException("該鏡頭條碼有過站紀錄!");
                        foreach (var item in result5)
                        {
                            if (item.MoId != MoId) throw new SystemException("該條碼不屬於當前製令");
                            //if (item.MoProcessId != MoProcessId) throw new SystemException("該條碼當前站別不是該站");

                        }
                    }
                    #endregion

                    #region //INSERT
                    int rowsAffected = 0;

                    int insteredBarcode = 0;





                    if (result4.Count() > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode
                                SET 
                                ParentBarcode = @ParentBarcode,
                                TrayLocation = @TrayLocation,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ParentBarcode = lotBarcodeId,
                                TrayLocation = trayLocation,
                                LastModifiedDate,
                                LastModifiedBy,
                                barcodeId
                            });
                        insteredBarcode = barcodeId;
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                    }
                    else
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus, ParentBarcode, TrayLocation
                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                            OUTPUT INSERTED.BarcodeId
                            VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus, @ParentBarcode, @TrayLocation
                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo,
                                CurrentMoProcessId = MoProcessId,
                                NextMoProcessId = nextMoProcessId,
                                MoId,
                                BarcodeQty = 1,
                                BarcodeProcessId = -1,
                                CurrentProdStatus = currentProdStatus,
                                BarcodeStatus = barcodeStatus,
                                ParentBarcode = lotBarcodeId,
                                TrayLocation = trayLocation,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy = CreateBy
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();

                        foreach (var item in insertResult)
                        {
                            insteredBarcode = item.BarcodeId;

                        }

                    }

                    #region //INSERT MES.BarcodeProcess
                    dynamicParameters = new DynamicParameters();
                    sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, StartDate
                                        , FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeProcessId
                                        VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @StartDate
                                        , @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                    dynamicParameters.AddDynamicParams(
                        new
                        {
                            BarcodeId = insteredBarcode,
                            MoId,
                            MachineId = machineId,
                            MoProcessId,
                            ProdStatus = prodStatus,
                            StationQty = 1,
                            PassQty = 0,
                            NgQty = 0,
                            StartDate = CreateDate,
                            FinishDate = CreateDate,
                            ModeShiftId = modeShiftId,
                            CycleTime = 0,
                            StartUserId = CreateBy,
                            FinishUserId = CreateBy,
                            CreateDate,
                            LastModifiedDate,
                            CreateBy = CreateBy,
                            LastModifiedBy = CreateBy
                        });

                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                    #endregion

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = rowsAffected
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }

        #endregion


        #endregion

        #region //UPDATE
        #region //UddateBindingBarcode -- 解除綁定條碼資料(TRAY盤綁條碼用) -- GPAI 2024-02-29
        public string UddateBindingBarcode(int BarcodeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        int UserId = CreateBy;
                        string nullstring = null;


                        #region //判斷條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeStatus
                                FROM MES.Barcode a 
                                WHERE a.BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeResult.Count() <= 0) throw new SystemException("條碼資料錯誤!!");

                        foreach (var item in BarcodeResult)
                        {
                            if (item.BarcodeStatus == "0") throw new SystemException("條碼狀態錯誤!!");
                        }
                        #endregion

                        int rowsAffected = 0;
                        #region //UPATE
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"delete from MES.BarcodeProcess
                        //        WHERE BarcodeId = @BarcodeId";
                        //dynamicParameters.AddDynamicParams(
                        //    new
                        //    {
                        //        BarcodeId
                        //    });

                        //rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode
                                SET
--CurrentMoProcessId  = @CurrentMoProcessId
--NextMoProcessId = @NextMoProcessId
--MoId = @MoId
                                ParentBarcode = @ParentBarcode,
                                TrayLocation = @TrayLocation,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                //CurrentMoProcessId = -1,
                                //NextMoProcessId = -1,
                                //MoId = -1,
                                ParentBarcode = -1,
                                TrayLocation = nullstring,
                                LastModifiedDate,
                                LastModifiedBy,
                                BarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UddateAllBindingBarcode -- 解除n所有綁定條碼資料(TRAY盤綁條碼用) -- GPAI 2024-11-07
        public string UddateAllBindingBarcode(int BarcodeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        int UserId = CreateBy;
                        string nullstring = null;


                        #region //判斷條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeStatus
                                FROM MES.Barcode a 
                                WHERE a.BarcodeId = @BarcodeId";
                        dynamicParameters.Add("BarcodeId", BarcodeId);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeResult.Count() <= 0) throw new SystemException("條碼資料錯誤!!");

                        foreach (var item in BarcodeResult)
                        {
                            if (item.BarcodeStatus == "0") throw new SystemException("條碼狀態錯誤!!");
                        }
                        #endregion

                        int rowsAffected = 0;
                        #region //UPATE
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"delete from MES.BarcodeProcess
                        //        WHERE BarcodeId = @BarcodeId";
                        //dynamicParameters.AddDynamicParams(
                        //    new
                        //    {
                        //        BarcodeId
                        //    });

                        //rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode
                                SET
--CurrentMoProcessId  = @CurrentMoProcessId
--NextMoProcessId = @NextMoProcessId
--MoId = @MoId
                                ParentBarcode = @ParentBarcode,
                                TrayLocation = @TrayLocation,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE ParentBarcode = @BarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                //CurrentMoProcessId = -1,
                                //NextMoProcessId = -1,
                                //MoId = -1,
                                ParentBarcode = -1,
                                TrayLocation = nullstring,
                                LastModifiedDate,
                                LastModifiedBy,
                                BarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion
        #endregion

        #region //鏡頭周轉

        #region //GET
        #endregion

        #region //UPDATE

        #region // UpdateTrayBindtTurnover 周轉Tray盤與鏡頭條碼移轉

        public string UpdateTrayBindtTurnover(string oldTrayNo, string newTrayNo, int moProcessId)
        {
            try
            {
                if (oldTrayNo.Length < 0) throw new SystemException("周轉Tray盤條碼不能為空!");
                if (newTrayNo.Length < 0) throw new SystemException("新Tray盤條碼不能為空!");


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;
                        string nullstring = null;

                        int parentBarcodeId = 0;
                        int oldTrayId = 0;
                        int oldTrayBarcodeLogId = 0;
                        string lotBarcodeNo = "";
                        int newTrayId = 0;

                        #region // 找舊Tray資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.ParentBarcode, a.TrayId, a.TrayNo, (a.BarcodeNo) TrayBindBarcode, b.BarcodeId, b.BarcodeNo, b.BarcodeQty, d.WoErpPrefix, d.WoErpNo, b.CurrentMoProcessId, b.BarcodeStatus
                            , e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, b.TrayLocation
                            FROM MES.Tray a
                            inner join MES.Barcode b on a.BarcodeNo = b.BarcodeNo
                            inner join MES.ManufactureOrder c on b.MoId = c.MoId
                            inner join MES.WipOrder d on c.WoId = d.WoId
                            inner join MES.MoProcess e on b.CurrentMoProcessId = e.MoProcessId
                            inner join MES.Process f on e.ProcessId = f.ProcessId 
                            WHERE a.TrayNo = @TrayNo and a.CompanyId = @CompanyId";

                        dynamicParameters.Add("TrayNo", oldTrayNo);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                        var result1 = sqlConnection.Query(sql, dynamicParameters);
                        if (result1.Count() <= 0) throw new SystemException("查無周轉Tray盤資訊");

                        foreach (var item in result1)
                        {
                            if (item.ParentBarcode != null) throw new SystemException("該周轉Tray盤資訊有誤! 批量條碼有綁定其他條碼");
                            if (item.CurrentMoProcessId != moProcessId) throw new SystemException("該周轉Tray盤非本站!");

                            parentBarcodeId = item.BarcodeId;
                            oldTrayId = item.TrayId;
                            lotBarcodeNo = item.BarcodeNo;
                        }
                        #endregion

                        #region //最新周轉TrayLog紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 TrayBarcodeLogId
                                FROM MES.TrayBarcodeLog
                                WHERE TrayId = @TrayId
                                AND BarcodeNo = @BarcodeNo
                                AND ReMoveBindDate is null";

                        dynamicParameters.Add("TrayId", oldTrayId);
                        dynamicParameters.Add("BarcodeNo", lotBarcodeNo);

                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in result4)
                        {

                            oldTrayBarcodeLogId = item.TrayBarcodeLogId;

                        }

                        #endregion

                        #region //Tray盤綁定條碼列表
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.TrayLocation, b.UserNo, b.UserName, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate  
                            from MES.Barcode a
                            INNER JOIN BAS.[User] b ON a.LastModifiedBy = b.UserId
                            where ParentBarcode = @ParentBarcode";

                        dynamicParameters.Add("ParentBarcode", parentBarcodeId);

                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        //if (result2.Count() <= 0) throw new SystemException("周轉Tray盤需有綁定鏡頭條碼");

                        #endregion

                        #region // 找新Tray資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                            FROM MES.Tray a
                            WHERE a.TrayNo = @TrayNo and a.CompanyId = @CompanyId";

                        dynamicParameters.Add("TrayNo", newTrayNo);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() <= 0) throw new SystemException("查無新Tray盤資訊");

                        foreach (var item in result3) {

                            if (item.BarcodeNo != null) throw new SystemException("該新Tray盤有綁定條碼!");

                            newTrayId = item.TrayId;

                        }
                        #endregion

                        #region //UPDATE
                        //#region //更新 BARCODE ParentBarcode
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"UPDATE MES.Barcode
                        //        SET 
                        //        ParentBarcode = @newParentBarcodeId,
                        //        LastModifiedDate = @LastModifiedDate,
                        //        LastModifiedBy = @LastModifiedBy
                        //        WHERE ParentBarcode = @ParentBarcode";
                        //dynamicParameters.AddDynamicParams(
                        //    new
                        //    {
                        //        newParentBarcodeId,
                        //        LastModifiedDate,
                        //        LastModifiedBy,
                        //        parentBarcodeId
                        //    });

                        //rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //#endregion

                        #region //更新 Tray 解除綁定 BarcodeNo
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Tray
                                SET 
                                BarcodeNo = @BarcodeNo,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE TrayId = @TrayId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo = nullstring,
                                LastModifiedDate,
                                LastModifiedBy,
                                TrayId = oldTrayId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新 TrayBarcodeLog ParentBarcode
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.TrayBarcodeLog
                                SET 
                                ReMoveBindDate = @LastModifiedDate,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE TrayBarcodeLogId = @TrayBarcodeLogId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ReMoveBindDate = LastModifiedDate,
                                LastModifiedDate,
                                LastModifiedBy,
                                TrayBarcodeLogId = oldTrayBarcodeLogId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion


                        #region //更新 Tray 綁定 BarcodeNo
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Tray
                                SET 
                                BarcodeNo = @BarcodeNo,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE TrayId = @TrayId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo = lotBarcodeNo,
                                LastModifiedDate,
                                LastModifiedBy,
                                TrayId = newTrayId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //新增新盤 TrayBarcodeLog 
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.TrayBarcodeLog(TrayId,BarcodeNo,BindDate
                                    ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                    VALUES(@TrayId,@BarcodeNo,@BindDate
                                    ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TrayId = newTrayId,
                                BarcodeNo = lotBarcodeNo,
                                BindDate = DateTime.Now,
                                CreateDate = DateTime.Now,
                                LastModifiedDate = DateTime.Now,
                                CreateBy,
                                LastModifiedBy = CreateBy
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }


        #endregion

        #endregion

        #endregion

        #region //物料NG管理

        #region //GET

        #region GetJudgeLensTray //判別為LENS/TRAY
        public string GetJudgeLensTray(string inputNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //先找Tray

                    dynamicParameters = new DynamicParameters();
                    sql = @"select *
                            from MES.Tray
                            where TrayNo = @TrayNo";

                    dynamicParameters.Add("TrayNo", inputNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #endregion

                    #region //再找Barcode

                    dynamicParameters = new DynamicParameters();
                    sql = @"select *
                            from MES.Barcode
                            where BarcodeNo = @BarcodeNo";

                    dynamicParameters.Add("BarcodeNo", inputNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                    #endregion

                    #region //Response
                    if (result.Count() > 0)
                    {
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = "TrayNo"
                        });
                    }
                    else if (result2.Count() > 0)
                    {
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = "BarcodeNo"
                        });
                    }
                    else {
                        throw new SystemException("查無任何資料，請重新輸入");
                    }
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }

        #endregion


        #region GetNgTrayInfo //取得Ng Tray盤資訊
        public string GetNgTrayInfo(string TrayNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    int barcodeId = 0;

                    #region //找Tray是否存在
                    dynamicParameters = new DynamicParameters();

                    sql = @"select TrayNo, BarcodeNo from MES.Tray
                            where TrayNo = @TrayNo";

                    dynamicParameters.Add("TrayNo", TrayNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result1 = sqlConnection.Query(sql, dynamicParameters);

                    if (result1.Count() <= 0) throw new SystemException("查無Tray盤資訊");


                    

                    #endregion //Tray盤相關資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.TrayId, a.TrayNo, b.BarcodeId, b.BarcodeNo, b.BarcodeQty, d.WoErpPrefix, d.WoErpNo, b.CurrentMoProcessId, b.BarcodeStatus
                            , e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, b.TrayLocation, g.MtlItemNo, g.MtlItemId, c.MoId, b.CurrentProdStatus, d.WoId
                            FROM MES.Tray a
                            inner join MES.Barcode b on a.BarcodeNo = b.BarcodeNo
                            inner join MES.ManufactureOrder c on b.MoId = c.MoId
                            inner join MES.WipOrder d on c.WoId = d.WoId
                            inner join MES.MoProcess e on b.CurrentMoProcessId = e.MoProcessId
                            inner join MES.Process f on e.ProcessId = f.ProcessId 
                            inner join PDM.MtlItem g on d.MtlItemId = g.MtlItemId
                            WHERE a.TrayNo = @TrayNo and a.CompanyId = @CompanyId";

                    dynamicParameters.Add("TrayNo", TrayNo);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("該Tray盤無綁定任何批量條碼或不是NG托盤");

                    foreach (var item in result)
                    {
                        if (item.CurrentProdStatus == "P") throw new SystemException("該Tray盤不是NG Tray盤!");
                        if (item.BarcodeStatus == "0") throw new SystemException("該Tray盤產品已入庫!");
                        barcodeId = item.BarcodeId;
                    }

                    #region //找是否有拆解紀錄
                    dynamicParameters = new DynamicParameters();
                    sql = @"select ISNULL(SUM(a.Quantity), 0) DismantleQty, a.BarcodeId, b.BarcodeNo, b.BarcodeQty, d.WoErpPrefix, d.WoErpNo
                            , b.CurrentMoProcessId, b.BarcodeStatus, e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, b.TrayLocation, g.MtlItemNo, g.MtlItemId, c.MoId, b.CurrentProdStatus, d.WoId
                            from MES.TrayBarcodeDismantle a
                            inner join MES.Barcode b on a.BarcodeId = b.BarcodeId
                            inner join MES.ManufactureOrder c on b.MoId = c.MoId
                            inner join MES.WipOrder d on c.WoId = d.WoId
                            inner join MES.MoProcess e on b.CurrentMoProcessId = e.MoProcessId
                            inner join MES.Process f on e.ProcessId = f.ProcessId 
                            inner join PDM.MtlItem g on d.MtlItemId = g.MtlItemId
                            WHERE a.BarcodeId = @BarcodeId
                            group BY a.BarcodeId, b.BarcodeNo, b.BarcodeQty, d.WoErpPrefix, d.WoErpNo
                            , b.CurrentMoProcessId, b.BarcodeStatus, e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, b.TrayLocation, g.MtlItemNo
							, g.MtlItemId, c.MoId, b.CurrentProdStatus, d.WoId";

                    dynamicParameters.Add("BarcodeId", barcodeId);
                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                    foreach (var item in result2)
                    {
                        //if (item.CurrentProdStatus != "N") throw new SystemException("該Tray盤不是NG Tray盤!");
                        if (item.BarcodeStatus == "0") throw new SystemException("該Tray盤產品已入庫!");
                    }
                    #endregion

                    #region //Response
                    if (result2.Count() > 0)
                    {
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result2
                        });
                    }
                    else {
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = result
                        });
                    }
                    
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }

        #endregion

        #region GetTrayMoBom//取得Tray盤物料
        public string GetTrayMoBom(int MtlItemId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //取得所屬製令產品物料

                    sql = @"SELECT a.BomDetailId, a.BomId, a.BomSequence, a.MtlItemId, a.UomId, a.CompositionQuantity, a.Base, a.LossRate,a.StandardCostingType,a.MaterialProperties
                            , ISNULL(FORMAT(a.EffectiveDate, 'yyyy-MM-dd'), '') EffectiveDate, ISNULL(FORMAT(a.ExpirationDate, 'yyyy-MM-dd'), '') ExpirationDate
                            , a.ReleaseItem, a.Remark, a.SubstitutionRemark, a.ConfirmStatus, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm') CreateDate
                            , b.TransferStatus
                            , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                            , d.UomNo
                            , CASE WHEN GETDATE() BETWEEN ISNULL(a.EffectiveDate, '1900-01-01') AND ISNULL(a.ExpirationDate, '9999-01-01') THEN 1 ELSE 0 END AS Effective
                            FROM PDM.BomDetail a
                            INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                            INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                            WHERE 1=1 and b.MtlItemId = @MtlItemId";

                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result2 = sqlConnection.Query(sql, dynamicParameters);

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result2
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region GetNgLensBarcodeInfo //取得Lens資訊
        public string GetNgLensBarcodeInfo(string BarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    int barcodeId = 0;
                    //Tray盤相關資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"select x.TrayNo, x.BarcodeQty TotalNgQty, y.DismantleQty, b.BarcodeId, b.BarcodeNo, b.BarcodeQty, d.WoErpPrefix, d.WoErpNo, b.CurrentMoProcessId, b.BarcodeStatus, b.ParentBarcode
                            , e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, b.TrayLocation, g.MtlItemNo, g.MtlItemId, c.MoId, b.CurrentProdStatus, d.WoId
                            from MES.Barcode b
                            inner join MES.ManufactureOrder c on b.MoId = c.MoId
                            inner join MES.WipOrder d on c.WoId = d.WoId
                            inner join MES.MoProcess e on b.CurrentMoProcessId = e.MoProcessId
                            inner join MES.Process f on e.ProcessId = f.ProcessId 
                            inner join PDM.MtlItem g on d.MtlItemId = g.MtlItemId
							OUTER APPLY  (
                            SELECT TOP 1  TrayNo, BarcodeQty FROM MES.Tray x1
                            INNER JOIN MES.Barcode x2 on x1.BarcodeNo =x2.BarcodeNo
                            WHERE  x1.BarcodeNo = b.BarcodeNo
                        ) x
						OUTER APPLY  (
                             SELECT TOP 1  ISNULL(SUM(y1.Quantity), 0) DismantleQty FROM MES.TrayBarcodeDismantle y1
                            INNER JOIN MES.Barcode y2 on y1.BarcodeId = y2.BarcodeId
                            WHERE  y2.BarcodeId = b.BarcodeId
                        ) y
							where b.BarcodeNo = @BarcodeNo and b.ParentBarcode is null";

                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("查無任何資料或該條碼未綁定Tray盤");

                    foreach (var item in result)
                    {
                        if (item.CurrentProdStatus == "P") throw new SystemException("該Tray盤不是NG Tray盤!");
                        if (item.BarcodeStatus == "0") throw new SystemException("該條碼已入庫!");
                        barcodeId = item.BarcodeId;
                    }


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });

                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }

        #endregion


        #endregion

        #region //UPDATE
        #region // UpdateTrayNg TrayNG物料
        public string UpdateTrayNg(string inputNo, string NgBom, int NgcountQty)
        {
            try
            {
                if (inputNo.Length < 0) throw new SystemException("條碼不能為空!");


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;
                        string lotBarcodeNo = null;

                        int barcodeId = 0;
                        int trayDismantleId = 0;
                        int trayId = 0;
                        int totalQty = 0;
                        int moId = 0;

                        int inputbarcodeId = 0;

                        string[] ngBomCountList = NgBom.Split(',');

                        string unllint = null;


                        #region //判別條碼類型
                        #region //先找Tray

                        dynamicParameters = new DynamicParameters();
                        sql = @"select *
                            from MES.Tray
                            where TrayNo = @TrayNo";

                        dynamicParameters.Add("TrayNo", inputNo);

                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                        var result1 = sqlConnection.Query(sql, dynamicParameters);

                        #endregion

                        #region //再找Barcode

                        dynamicParameters = new DynamicParameters();
                        sql = @"select *
                            from MES.Barcode
                            where BarcodeNo = @BarcodeNo";

                        dynamicParameters.Add("BarcodeNo", inputNo);

                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        #endregion

                        #endregion

                        #region //Tray盤
                        if (result1.Count() > 0 && result2.Count() <= 0)//Tray盤
                        {
                            //Tray盤相關資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayId, a.TrayNo, b.BarcodeId, b.BarcodeNo, b.BarcodeQty, d.WoErpPrefix, d.WoErpNo, b.CurrentMoProcessId, b.BarcodeStatus, b.MoId
                            , e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, b.TrayLocation, g.MtlItemNo, g.MtlItemId, c.MoId, b.CurrentProdStatus
                            FROM MES.Tray a
                            inner join MES.Barcode b on a.BarcodeNo = b.BarcodeNo
                            inner join MES.ManufactureOrder c on b.MoId = c.MoId
                            inner join MES.WipOrder d on c.WoId = d.WoId
                            inner join MES.MoProcess e on b.CurrentMoProcessId = e.MoProcessId
                            inner join MES.Process f on e.ProcessId = f.ProcessId 
                            inner join PDM.MtlItem g on d.MtlItemId = g.MtlItemId
                            WHERE a.TrayNo = @TrayNo and a.CompanyId = @CompanyId";

                            dynamicParameters.Add("TrayNo", inputNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("該Tray盤無綁定任何批量條碼");

                            foreach (var item in result4)
                            {
                                //if (item.CurrentProdStatus != "N") throw new SystemException("該Tray盤不是NG Tray盤!");
                                if (item.BarcodeStatus == "0") throw new SystemException("該Tray盤產品已入庫!");
                                barcodeId = item.BarcodeId;
                                trayId = item.TrayId;
                                lotBarcodeNo = item.BarcodeNo;
                                totalQty = item.BarcodeQty;
                                moId = item.MoId;
                            }
                            var result7 = sqlConnection.Query(sql, dynamicParameters);
                            int nglensnoid = 0;

                            #region // 找綁定的Lens
                            dynamicParameters = new DynamicParameters();
                            sql = @"select * from MES.Barcode
                                    where ParentBarcode = @ParentBarcode and CurrentProdStatus != 'TN'";

                            dynamicParameters.Add("ParentBarcode", barcodeId);

                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                            result7 = sqlConnection.Query(sql, dynamicParameters);
                            //if (result7.Count() <= 0) throw new SystemException("該Tray盤無綁定任何鏡頭條碼");

                            #endregion

                            #region // 找是否是NG 批量條碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"select * from MES.Barcode
                                    where BarcodeId = @ParentBarcode AND CurrentProdStatus = 'F'";

                            dynamicParameters.Add("ParentBarcode", barcodeId);

                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                            var result8 = sqlConnection.Query(sql, dynamicParameters);
                            if (result8.Count() <= 0) throw new SystemException("該Tray盤不是NG-Tray");

                            #endregion

                            #region //找是否有製令拆解紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"select a.TrayMtlItemNgId, a.MoId, a.NgQty, a.AlreadyQty
                                    from MES.TrayMtlItemNg a
                                    WHERE a.MoId = @MoId";

                            dynamicParameters.Add("MoId", moId);
                            var result5 = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //計算條碼已拆解數是否超過BarcodeQty
                            dynamicParameters = new DynamicParameters();
                            sql = @"select  a.BarcodeId , ISNULL(SUM(a.Quantity), 0) Quantity , b.BarcodeQty
                                    from MES.TrayBarcodeDismantle a
                                    inner join MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    where a.BarcodeId = @ParentBarcode
                                    group by a.BarcodeId , b.BarcodeQty";

                            dynamicParameters.Add("ParentBarcode", barcodeId);

                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                            var result9 = sqlConnection.Query(sql, dynamicParameters);
                            int barcodeQty = 0;
                            int ngtotal = 0;

                            if (result9.Count() > 0)
                            {
                                foreach (var item in result9)
                                {
                                    foreach (var item2 in ngBomCountList)
                                    {

                                        int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

                                        decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

                                        if (item.Quantity + ngBomDetailCount > item.BarcodeQty) throw new SystemException("該Tray盤已全數拆解或者拆解數大於總數!");
                                        barcodeQty = item.BarcodeQty;
                                        ngtotal = item.Quantity;

                                        #region //找是否有製令拆解紀錄
                                        //UPDATE OR INSERT
                                        if (result5.Count() > 0)
                                        {//有拆解紀錄

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"select a.TrayMtlItemNgId
                                                from MES.TrayMtlItemNg a
                                                WHERE a.MoId = @MoId AND a.BomDetailId = @BomDetailId";

                                            dynamicParameters.Add("MoId", moId);
                                            dynamicParameters.Add("BomDetailId", bomDetailId);

                                            var result6 = sqlConnection.Query(sql, dynamicParameters);
                                            #endregion

                                            if (result6.Count() > 0)
                                            {
                                                #region //有物料拆解紀錄 UPDATE子表
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE MES.TrayMtlItemNg
                                                     SET 
                                                     NgQty = NgQty + @NgQty,
                                                     LastModifiedDate = @LastModifiedDate,
                                                     LastModifiedBy = @LastModifiedBy
                                                     WHERE MoId = @MoId AND BomDetailId = @BomDetailId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        NgQty = ngBomDetailCount,
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        MoId = moId,
                                                        BomDetailId = bomDetailId
                                                    });

                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion
                                            }
                                            else
                                            {
                                                #region //無物料拆解紀錄 INSERT子表
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO MES.TrayMtlItemNg(MoId, BomDetailId, NgQty
                                                     ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                                     VALUES(@MoId, @BomDetailId, @NgQty
                                                     ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        MoId = moId,
                                                        BomDetailId = bomDetailId,
                                                        NgQty = ngBomDetailCount,
                                                        CreateDate = DateTime.Now,
                                                        LastModifiedDate = DateTime.Now,
                                                        CreateBy,
                                                        LastModifiedBy = CreateBy
                                                    });

                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion
                                            }
                                        }
                                        else
                                        {//無拆解紀錄

                                            #region //新增物料拆解紀錄
                                            if (ngtotal + ngBomDetailCount > barcodeQty) throw new SystemException("該Tray盤物料已全數拆解或者拆解數大於Tray盤條碼數!");
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.TrayMtlItemNg(MoId,BomDetailId,NgQty
                                                     ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                                     OUTPUT Inserted.TrayMtlItemNgId
                                                     VALUES(@MoId,@BomDetailId,@NgQty
                                                     ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MoId = moId,
                                                    BomDetailId = bomDetailId,
                                                    NgQty = ngBomDetailCount,
                                                    CreateDate = DateTime.Now,
                                                    LastModifiedDate = DateTime.Now,
                                                    CreateBy,
                                                    LastModifiedBy = CreateBy
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                            #endregion
                                        }
                                        #endregion

                                    }


                                }
                            }
                            else {
                                foreach (var item2 in ngBomCountList)
                                {

                                    int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

                                    decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

                                    #region //找是否有製令物料拆解紀錄
                                    //UPDATE OR INSERT
                                    if (result5.Count() > 0)
                                    {//有拆解紀錄

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"select a.TrayMtlItemNgId
                                                from MES.TrayMtlItemNg a
                                                WHERE a.MoId = @MoId AND a.BomDetailId = @BomDetailId";

                                        dynamicParameters.Add("MoId", moId);
                                        dynamicParameters.Add("BomDetailId", bomDetailId);

                                        var result6 = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion

                                        if (result6.Count() > 0)
                                        {
                                            #region //有物料拆解紀錄 UPDATE子表
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.TrayMtlItemNg
                                                     SET 
                                                     NgQty = NgQty + @NgQty,
                                                     LastModifiedDate = @LastModifiedDate,
                                                     LastModifiedBy = @LastModifiedBy
                                                     WHERE MoId = @MoId AND BomDetailId = @BomDetailId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    NgQty = ngBomDetailCount,
                                                    LastModifiedDate,
                                                    LastModifiedBy,
                                                    MoId = moId,
                                                    BomDetailId = bomDetailId
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                        else
                                        {
                                            #region //無物料拆解紀錄 INSERT子表
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.TrayMtlItemNg(MoId, BomDetailId, NgQty
                                                     ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                                     VALUES(@MoId, @BomDetailId, @NgQty
                                                     ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MoId = moId,
                                                    BomDetailId = bomDetailId,
                                                    NgQty = ngBomDetailCount,
                                                    CreateDate = DateTime.Now,
                                                    LastModifiedDate = DateTime.Now,
                                                    CreateBy,
                                                    LastModifiedBy = CreateBy
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }

                                    }
                                    else
                                    {//無拆解紀錄

                                        #region //新增物料拆解紀錄
                                       // if (ngtotal + ngBomDetailCount > barcodeQty) throw new SystemException("該Tray盤物料已全數拆解或者拆解數大於Tray盤條碼數!");
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.TrayMtlItemNg(MoId,BomDetailId,NgQty
                                                     ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                                     OUTPUT Inserted.TrayMtlItemNgId
                                                     VALUES(@MoId,@BomDetailId,@NgQty
                                                     ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MoId = moId,
                                                BomDetailId = bomDetailId,
                                                NgQty = ngBomDetailCount,
                                                CreateDate = DateTime.Now,
                                                LastModifiedDate = DateTime.Now,
                                                CreateBy,
                                                LastModifiedBy = CreateBy
                                            });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                        #endregion
                                    }

                                }

                            }
                            #endregion




                            #region 新增該條碼拆解紀錄


                            #region //新增紀錄
                            //if (ngtotal + NgcountQty > barcodeQty) throw new SystemException("該Tray盤已全數拆解或者拆解數大於總數!");

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.TrayBarcodeDismantle(BarcodeId,Quantity
                                    ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                    OUTPUT Inserted.TbdId
                                    VALUES(@BarcodeId,@Quantity
                                    ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeId = barcodeId,
                                    Quantity = NgcountQty,
                                    CreateDate = DateTime.Now,
                                    LastModifiedDate = DateTime.Now,
                                    CreateBy,
                                    LastModifiedBy = CreateBy
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //UPDATE MES.BARCODE
                            //foreach (var item in result7)
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"UPDATE MES.Barcode
                            //                SET 
                            //                CurrentProdStatus = @CurrentProdStatus,
                            //                LastModifiedDate = @LastModifiedDate,
                            //                LastModifiedBy = @LastModifiedBy
                            //                WHERE BarcodeId = @BarcodeId";
                            //    dynamicParameters.AddDynamicParams(
                            //        new
                            //        {
                            //            CurrentProdStatus = "TN",
                            //            ParentBarcode = unllint,
                            //            LastModifiedDate,
                            //            LastModifiedBy,
                            //            BarcodeId = item.BarcodeId
                            //        });

                            //    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            //}
                            #endregion
                        }
                        #endregion

                        else
                        {
                            throw new SystemException("查無任何Tray資料，請重新輸入");
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region // UpdateLensNg LensNG物料(現FOR無綁定TRAY盤LOT做拆解)
        public string UpdateLensNg(string inputNo, string NgBom, int NgcountQty)
        {
            try
            {
                if (inputNo.Length < 0) throw new SystemException("條碼不能為空!");


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;
                        string lotBarcodeNo = null;

                        int barcodeId = 0;
                        int trayDismantleId = 0;
                        int trayId = 0;
                        int totalQty = 0;
                        int moid = 0;

                        int inputbarcodeId = 0;

                        string[] ngBomCountList = NgBom.Split(',');

                        int? unllint = null;


                        #region //判別條碼類型
                        #region //先找Tray

                        dynamicParameters = new DynamicParameters();
                        sql = @"select *
                            from MES.Tray
                            where TrayNo = @TrayNo";

                        dynamicParameters.Add("TrayNo", inputNo);

                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                        var result1 = sqlConnection.Query(sql, dynamicParameters);

                        #endregion

                        #region //再找Barcode

                        dynamicParameters = new DynamicParameters();
                        sql = @"select *
                            from MES.Barcode
                            where BarcodeNo = @BarcodeNo";

                        dynamicParameters.Add("BarcodeNo", inputNo);

                        //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        #endregion

                        #endregion

                        #region //只有條碼
                        if (result2.Count() > 0 && result1.Count() <= 0)//Lens朴馬
                        {
                            foreach (var item in result2)
                            {
                                inputbarcodeId = item.BarcodeId;
                            }

                            #region // 是否有綁定
                            dynamicParameters = new DynamicParameters();
                            sql = @"select * from MES.Barcode
                                    where BarcodeId = @BarcodeId and ParentBarcode is null";

                            dynamicParameters.Add("BarcodeId", inputbarcodeId);

                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                            var result8 = sqlConnection.Query(sql, dynamicParameters);
                            if (result8.Count() <= 0) throw new SystemException("該條碼資料錯誤");

                            foreach (var item in result8)
                            {
                                barcodeId = item.BarcodeId;
                                moid = item.MoId;
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"select * from MES.Barcode
                                    where BarcodeId = @BarcodeId";

                            dynamicParameters.Add("BarcodeId", barcodeId);

                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                            var result81 = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in result81)
                            {
                                totalQty = item.BarcodeQty;
                            }
                            #endregion

                            #region //找是否有製令拆解紀錄
                            dynamicParameters = new DynamicParameters();
                            sql = @"select a.TrayMtlItemNgId, a.MoId, a.NgQty, a.AlreadyQty
                                    from MES.TrayMtlItemNg a
                                    WHERE a.MoId = @MoId";

                            dynamicParameters.Add("MoId", moid);
                            var result5 = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //計算條碼已拆解數是否超過BarcodeQty
                            dynamicParameters = new DynamicParameters();
                            sql = @"select  a.BarcodeId , ISNULL(SUM(a.Quantity), 0) Quantity , b.BarcodeQty
                                    from MES.TrayBarcodeDismantle a
                                    inner join MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                    where a.BarcodeId = @ParentBarcode
                                    group by a.BarcodeId , b.BarcodeQty";

                            dynamicParameters.Add("ParentBarcode", barcodeId);

                            //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                            var result9 = sqlConnection.Query(sql, dynamicParameters);
                            int barcodeQty = 0;
                            int ngtotal = 0;

                            if (result9.Count() > 0)
                            {
                                foreach (var item in result9)
                                {
                                    foreach (var item2 in ngBomCountList)
                                    {

                                        int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

                                        decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

                                        if (item.Quantity + ngBomDetailCount > item.BarcodeQty) throw new SystemException("該Tray盤已全數拆解或者拆解數大於總數!");
                                        barcodeQty = item.BarcodeQty;
                                        ngtotal = item.Quantity;

                                        #region //找是否有製令拆解紀錄
                                        //UPDATE OR INSERT
                                        if (result5.Count() > 0)
                                        {//有拆解紀錄

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"select a.TrayMtlItemNgId
                                                from MES.TrayMtlItemNg a
                                                WHERE a.MoId = @MoId AND a.BomDetailId = @BomDetailId";

                                            dynamicParameters.Add("MoId", moid);
                                            dynamicParameters.Add("BomDetailId", bomDetailId);

                                            var result6 = sqlConnection.Query(sql, dynamicParameters);
                                            #endregion

                                            if (result6.Count() > 0)
                                            {
                                                #region //有物料拆解紀錄 UPDATE子表
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"UPDATE MES.TrayMtlItemNg
                                                     SET 
                                                     NgQty = NgQty + @NgQty,
                                                     LastModifiedDate = @LastModifiedDate,
                                                     LastModifiedBy = @LastModifiedBy
                                                     WHERE MoId = @MoId AND BomDetailId = @BomDetailId";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        NgQty = ngBomDetailCount,
                                                        LastModifiedDate,
                                                        LastModifiedBy,
                                                        MoId = moid,
                                                        BomDetailId = bomDetailId
                                                    });

                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion
                                            }
                                            else
                                            {
                                                #region //無物料拆解紀錄 INSERT子表
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"INSERT INTO MES.TrayMtlItemNg(MoId, BomDetailId, NgQty
                                                     ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                                     VALUES(@MoId, @BomDetailId, @NgQty
                                                     ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                                dynamicParameters.AddDynamicParams(
                                                    new
                                                    {
                                                        MoId = moid,
                                                        BomDetailId = bomDetailId,
                                                        NgQty = ngBomDetailCount,
                                                        CreateDate = DateTime.Now,
                                                        LastModifiedDate = DateTime.Now,
                                                        CreateBy,
                                                        LastModifiedBy = CreateBy
                                                    });

                                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                                #endregion
                                            }
                                        }
                                        else
                                        {//無拆解紀錄

                                            #region //新增物料拆解紀錄
                                            if (ngtotal + ngBomDetailCount > barcodeQty) throw new SystemException("該Tray盤物料已全數拆解或者拆解數大於Tray盤條碼數!");
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.TrayMtlItemNg(MoId,BomDetailId,NgQty
                                                     ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                                     OUTPUT Inserted.TrayMtlItemNgId
                                                     VALUES(@MoId,@BomDetailId,@NgQty
                                                     ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MoId = moid,
                                                    BomDetailId = bomDetailId,
                                                    NgQty = ngBomDetailCount,
                                                    CreateDate = DateTime.Now,
                                                    LastModifiedDate = DateTime.Now,
                                                    CreateBy,
                                                    LastModifiedBy = CreateBy
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                            #endregion
                                        }
                                        #endregion

                                    }


                                }
                            }
                            else
                            {
                                foreach (var item2 in ngBomCountList)
                                {

                                    int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

                                    decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

                                    #region //找是否有製令物料拆解紀錄
                                    //UPDATE OR INSERT
                                    if (result5.Count() > 0)
                                    {//有拆解紀錄

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"select a.TrayMtlItemNgId
                                                from MES.TrayMtlItemNg a
                                                WHERE a.MoId = @MoId AND a.BomDetailId = @BomDetailId";

                                        dynamicParameters.Add("MoId", moid);
                                        dynamicParameters.Add("BomDetailId", bomDetailId);

                                        var result6 = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion

                                        if (result6.Count() > 0)
                                        {
                                            #region //有物料拆解紀錄 UPDATE子表
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"UPDATE MES.TrayMtlItemNg
                                                     SET 
                                                     NgQty = NgQty + @NgQty,
                                                     LastModifiedDate = @LastModifiedDate,
                                                     LastModifiedBy = @LastModifiedBy
                                                     WHERE MoId = @MoId AND BomDetailId = @BomDetailId";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    NgQty = ngBomDetailCount,
                                                    LastModifiedDate,
                                                    LastModifiedBy,
                                                    MoId = moid,
                                                    BomDetailId = bomDetailId
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }
                                        else
                                        {
                                            #region //無物料拆解紀錄 INSERT子表
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.TrayMtlItemNg(MoId, BomDetailId, NgQty
                                                     ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                                     VALUES(@MoId, @BomDetailId, @NgQty
                                                     ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    MoId = moid,
                                                    BomDetailId = bomDetailId,
                                                    NgQty = ngBomDetailCount,
                                                    CreateDate = DateTime.Now,
                                                    LastModifiedDate = DateTime.Now,
                                                    CreateBy,
                                                    LastModifiedBy = CreateBy
                                                });

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion
                                        }

                                    }
                                    else
                                    {//無拆解紀錄

                                        #region //新增物料拆解紀錄
                                        // if (ngtotal + ngBomDetailCount > barcodeQty) throw new SystemException("該Tray盤物料已全數拆解或者拆解數大於Tray盤條碼數!");
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.TrayMtlItemNg(MoId,BomDetailId,NgQty
                                                     ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                                     OUTPUT Inserted.TrayMtlItemNgId
                                                     VALUES(@MoId,@BomDetailId,@NgQty
                                                     ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MoId = moid,
                                                BomDetailId = bomDetailId,
                                                NgQty = ngBomDetailCount,
                                                CreateDate = DateTime.Now,
                                                LastModifiedDate = DateTime.Now,
                                                CreateBy,
                                                LastModifiedBy = CreateBy
                                            });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                        #endregion
                                    }

                                }

                            }
                            #endregion




                            #region 新增該條碼拆解紀錄


                            #region //新增紀錄
                            //if (ngtotal + NgcountQty > barcodeQty) throw new SystemException("該Tray盤已全數拆解或者拆解數大於總數!");

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.TrayBarcodeDismantle(BarcodeId,Quantity
                                    ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                    OUTPUT Inserted.TbdId
                                    VALUES(@BarcodeId,@Quantity
                                    ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeId = barcodeId,
                                    Quantity = NgcountQty,
                                    CreateDate = DateTime.Now,
                                    LastModifiedDate = DateTime.Now,
                                    CreateBy,
                                    LastModifiedBy = CreateBy
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //UPDATE MES.BARCODE
                            //foreach (var item in result7)
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"UPDATE MES.Barcode
                            //                SET 
                            //                CurrentProdStatus = @CurrentProdStatus,
                            //                LastModifiedDate = @LastModifiedDate,
                            //                LastModifiedBy = @LastModifiedBy
                            //                WHERE BarcodeId = @BarcodeId";
                            //    dynamicParameters.AddDynamicParams(
                            //        new
                            //        {
                            //            CurrentProdStatus = "TN",
                            //            ParentBarcode = unllint,
                            //            LastModifiedDate,
                            //            LastModifiedBy,
                            //            BarcodeId = item.BarcodeId
                            //        });

                            //    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            //}
                            #endregion
                        }
                        #endregion

                        else
                        {
                            throw new SystemException("查無任何Tray資料，請重新輸入");
                        }



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region // UpdateTrayLensNg TrayNG物料 with lens
        //public string UpdateTrayLensNg(string inputNo, string NgBom, int NgcountQty, string NgLensNo)
        //{
        //    try
        //    {
        //        if (inputNo.Length < 0) throw new SystemException("條碼不能為空!");


        //        using (TransactionScope transactionScope = new TransactionScope())
        //        {
        //            using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
        //            {
        //                int rowsAffected = 0;
        //                string lotBarcodeNo = null;

        //                int barcodeId = 0;
        //                int trayDismantleId = 0;
        //                int trayId = 0;
        //                int totalQty = 0;

        //                int inputbarcodeId = 0;

        //                string[] ngBomCountList = NgBom.Split(',');

        //                string unllint = null;


        //                #region //判別條碼類型
        //                #region //先找Tray

        //                dynamicParameters = new DynamicParameters();
        //                sql = @"select *
        //                    from MES.Tray
        //                    where TrayNo = @TrayNo";

        //                dynamicParameters.Add("TrayNo", inputNo);

        //                //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

        //                var result1 = sqlConnection.Query(sql, dynamicParameters);

        //                #endregion

        //                #region //再找Barcode

        //                dynamicParameters = new DynamicParameters();
        //                sql = @"select *
        //                    from MES.Barcode
        //                    where BarcodeNo = @BarcodeNo";

        //                dynamicParameters.Add("BarcodeNo", inputNo);

        //                //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

        //                var result2 = sqlConnection.Query(sql, dynamicParameters);

        //                #endregion

        //                #endregion

        //                #region //Tray盤
        //                if (result1.Count() > 0 && result2.Count() <= 0)//Tray盤
        //                {
        //                    //Tray盤相關資料
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"SELECT a.TrayId, a.TrayNo, b.BarcodeId, b.BarcodeNo, b.BarcodeQty, d.WoErpPrefix, d.WoErpNo, b.CurrentMoProcessId, b.BarcodeStatus
        //                    , e.ProcessAlias, f.ProcessDesc, f.ProcessName, f.ProcessNo, b.TrayLocation, g.MtlItemNo, g.MtlItemId, c.MoId, b.CurrentProdStatus
        //                    FROM MES.Tray a
        //                    inner join MES.Barcode b on a.BarcodeNo = b.BarcodeNo
        //                    inner join MES.ManufactureOrder c on b.MoId = c.MoId
        //                    inner join MES.WipOrder d on c.WoId = d.WoId
        //                    inner join MES.MoProcess e on b.CurrentMoProcessId = e.MoProcessId
        //                    inner join MES.Process f on e.ProcessId = f.ProcessId 
        //                    inner join PDM.MtlItem g on d.MtlItemId = g.MtlItemId
        //                    WHERE a.TrayNo = @TrayNo and a.CompanyId = @CompanyId";

        //                    dynamicParameters.Add("TrayNo", inputNo);
        //                    dynamicParameters.Add("CompanyId", CurrentCompany);

        //                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

        //                    var result4 = sqlConnection.Query(sql, dynamicParameters);
        //                    if (result4.Count() <= 0) throw new SystemException("該Tray盤無綁定任何批量條碼");

        //                    foreach (var item in result4)
        //                    {
        //                        //if (item.CurrentProdStatus != "N") throw new SystemException("該Tray盤不是NG Tray盤!");
        //                        if (item.BarcodeStatus == "0") throw new SystemException("該Tray盤產品已入庫!");
        //                        barcodeId = item.BarcodeId;
        //                        trayId = item.TrayId;
        //                        lotBarcodeNo = item.BarcodeNo;
        //                        totalQty = item.BarcodeQty;
        //                    }
        //                    var result7 = sqlConnection.Query(sql, dynamicParameters);
        //                    int nglensnoid = 0;

        //                    #region // 找綁定的Lens
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"select * from MES.Barcode
        //                            where ParentBarcode = @ParentBarcode";

        //                    dynamicParameters.Add("ParentBarcode", barcodeId);

        //                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

        //                    result7 = sqlConnection.Query(sql, dynamicParameters);
        //                    if (result7.Count() <= 0) throw new SystemException("該Tray盤無綁定任何鏡頭條碼");

        //                    #endregion



        //                    #region //找是否有拆解紀錄
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"select a.TrayDismantleId, a.BarcodeId, a.TotalQty, a.DismantleQty
        //                            from MES.TrayDismantle a
        //                            WHERE a.BarcodeId = @BarcodeId";

        //                    dynamicParameters.Add("BarcodeId", barcodeId);
        //                    var result5 = sqlConnection.Query(sql, dynamicParameters);


        //                    //UPDATE OR INSERT
        //                    if (result5.Count() > 0)
        //                    {//有拆解紀錄

        //                        foreach (var item in result5)
        //                        {
        //                            //if (item.CurrentProdStatus != "N") throw new SystemException("該Tray盤不是NG Tray盤!");
        //                            if (item.BarcodeStatus == "0") throw new SystemException("該Tray盤產品已入庫!");
        //                            trayDismantleId = item.TrayDismantleId;

        //                            #region //找是否有各物料拆解紀錄
        //                            foreach (var item2 in ngBomCountList)
        //                            {

        //                                int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

        //                                decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

        //                                dynamicParameters = new DynamicParameters();
        //                                sql = @"select a.TrayDismantleId
        //                                        from MES.TrayMtlItemNg a
        //                                        WHERE a.TrayDismantleId = @TrayDismantleId AND a.BomDetailId = @BomDetailId";

        //                                dynamicParameters.Add("TrayDismantleId", trayDismantleId);
        //                                dynamicParameters.Add("BomDetailId", bomDetailId);

        //                                var result6 = sqlConnection.Query(sql, dynamicParameters);
        //                                #endregion

        //                                if (result6.Count() > 0)
        //                                {
        //                                    #region //有物料拆解紀錄 UPDATE子表
        //                                    dynamicParameters = new DynamicParameters();
        //                                    sql = @"UPDATE MES.TrayMtlItemNg
        //                                             SET 
        //                                             NgQty = @NgQty,
        //                                             LastModifiedDate = @LastModifiedDate,
        //                                             LastModifiedBy = @LastModifiedBy
        //                                             WHERE TrayDismantleId = @TrayDismantleId AND BomDetailId = @BomDetailId";
        //                                    dynamicParameters.AddDynamicParams(
        //                                        new
        //                                        {
        //                                            NgQty = ngBomDetailCount,
        //                                            LastModifiedDate,
        //                                            LastModifiedBy,
        //                                            TrayDismantleId = trayDismantleId,
        //                                            BomDetailId = bomDetailId
        //                                        });

        //                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                                    #endregion
        //                                }
        //                                else
        //                                {
        //                                    #region //無物料拆解紀錄 INSERT子表
        //                                    dynamicParameters = new DynamicParameters();
        //                                    sql = @"INSERT INTO MES.TrayMtlItemNg(TrayDismantleId, BomDetailId, NgQty
        //                                             ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
        //                                             VALUES(@TrayDismantleId, @BomDetailId, @NgQty
        //                                             ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
        //                                    dynamicParameters.AddDynamicParams(
        //                                        new
        //                                        {
        //                                            TrayDismantleId = trayDismantleId,
        //                                            BomDetailId = bomDetailId,
        //                                            NgQty = ngBomDetailCount,
        //                                            CreateDate = DateTime.Now,
        //                                            LastModifiedDate = DateTime.Now,
        //                                            CreateBy,
        //                                            LastModifiedBy = CreateBy
        //                                        });

        //                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                                    #endregion
        //                                }
        //                            }
        //                        }
        //                    }
        //                    else
        //                    {//無拆解紀錄
        //                        #region //新增拆解紀錄
        //                        dynamicParameters = new DynamicParameters();
        //                        sql = @"INSERT INTO MES.TrayDismantle(BarcodeId,TotalQty,DismantleQty
        //                            ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
        //                            OUTPUT Inserted.TrayDismantleId

        //                            VALUES(@BarcodeId,@TotalQty,@DismantleQty
        //                            ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
        //                        dynamicParameters.AddDynamicParams(
        //                            new
        //                            {
        //                                BarcodeId = barcodeId,
        //                                TotalQty = totalQty,
        //                                DismantleQty = NgcountQty,
        //                                CreateDate = DateTime.Now,
        //                                LastModifiedDate = DateTime.Now,
        //                                CreateBy,
        //                                LastModifiedBy = CreateBy
        //                            });

        //                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
        //                        int newtrayDismantleId = 0;

        //                        foreach (var item in insertResult)
        //                        {
        //                            newtrayDismantleId = item.TrayDismantleId;
        //                        }

        //                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                        #endregion

        //                        #region //新增物料拆解紀錄
        //                        foreach (var item2 in ngBomCountList)
        //                        {

        //                            int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

        //                            decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"INSERT INTO MES.TrayMtlItemNg(TrayDismantleId,BomDetailId,NgQty
        //                            ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
        //                            OUTPUT Inserted.TrayMtlItemNgId
        //                            VALUES(@TrayDismantleId,@BomDetailId,@NgQty
        //                            ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
        //                            dynamicParameters.AddDynamicParams(
        //                                new
        //                                {
        //                                    TrayDismantleId = newtrayDismantleId,
        //                                    BomDetailId = bomDetailId,
        //                                    NgQty = ngBomDetailCount,
        //                                    CreateDate = DateTime.Now,
        //                                    LastModifiedDate = DateTime.Now,
        //                                    CreateBy,
        //                                    LastModifiedBy = CreateBy
        //                                });

        //                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                        }

        //                        #endregion
        //                    }
        //                    #endregion

        //                    #region //UPDATE MES.BARCODE
        //                    foreach (var item in result7)
        //                    {
        //                        dynamicParameters = new DynamicParameters();
        //                        sql = @"UPDATE MES.Barcode
        //                                    SET 
        //                                    CurrentProdStatus = @CurrentProdStatus,
        //                                    LastModifiedDate = @LastModifiedDate,
        //                                    LastModifiedBy = @LastModifiedBy
        //                                    WHERE BarcodeId = @BarcodeId";
        //                        dynamicParameters.AddDynamicParams(
        //                            new
        //                            {
        //                                CurrentProdStatus = "TN",
        //                                ParentBarcode = unllint,
        //                                LastModifiedDate,
        //                                LastModifiedBy,
        //                                BarcodeId = item.BarcodeId
        //                            });

        //                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                    }
        //                    #endregion
        //                }
        //                #endregion

        //                #region //只有LENS條碼
        //                else if (result2.Count() > 0 && result1.Count() <= 0)//Lens朴馬
        //                {
        //                    foreach (var item in result2)
        //                    {
        //                        inputbarcodeId = item.BarcodeId;
        //                    }

        //                    #region // 是否有綁定
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"select * from MES.Barcode
        //                            where BarcodeId = @BarcodeId and ParentBarcode is not null";

        //                    dynamicParameters.Add("BarcodeId", inputbarcodeId);

        //                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

        //                    var result8 = sqlConnection.Query(sql, dynamicParameters);
        //                    if (result8.Count() <= 0) throw new SystemException("該鏡頭條碼無綁定");

        //                    foreach (var item in result8)
        //                    {
        //                        barcodeId = item.ParentBarcode;
        //                    }

        //                    #endregion

        //                    #region //找是否有TRAY拆解紀錄
        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"select a.TrayDismantleId, a.BarcodeId, b.BarcodeNo, a.TotalQty, a.DismantleQty
        //                            from MES.TrayDismantle a
        //                            WHERE a.BarcodeId = @BarcodeId";

        //                    dynamicParameters.Add("BarcodeId", barcodeId);
        //                    var result9 = sqlConnection.Query(sql, dynamicParameters);
        //                    #endregion

        //                    //#region //找是否有Lens拆解紀錄
        //                    //dynamicParameters = new DynamicParameters();
        //                    //sql = @"select *
        //                    //        from MES.LensMtlItemNg a
        //                    //        WHERE a.LensBarcodeId = @LensBarcodeId";

        //                    //dynamicParameters.Add("LensBarcodeId", inputbarcodeId);
        //                    //var result10 = sqlConnection.Query(sql, dynamicParameters);
        //                    //#endregion

        //                    #region //UPDATE

        //                    #region// INS/UPD MES.TrayDismantle TrayMtlItemNg

        //                    if (result9.Count() > 0)
        //                    {
        //                        foreach (var item in result9)
        //                        {
        //                            if (item.BarcodeStatus == "0") throw new SystemException("該Tray盤產品已入庫!");
        //                            trayDismantleId = item.TrayDismantleId;

        //                            #region //找是否有各物料拆解紀錄
        //                            foreach (var item2 in ngBomCountList)
        //                            {

        //                                int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

        //                                decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

        //                                dynamicParameters = new DynamicParameters();
        //                                sql = @"select a.TrayDismantleId, a.BarcodeId, b.BarcodeNo, a.TotalQty, a.DismantleQty
        //                                        from MES.TrayMtlItemNg a
        //                                        WHERE a.TrayDismantleId = @TrayDismantleId AND a.BomDetailId = @BomDetailId";

        //                                dynamicParameters.Add("TrayDismantleId", trayDismantleId);
        //                                dynamicParameters.Add("BomDetailId", bomDetailId);

        //                                var result6 = sqlConnection.Query(sql, dynamicParameters);
        //                                #endregion

        //                                if (result6.Count() > 0)
        //                                {
        //                                    #region //有物料拆解紀錄 UPDATE子表
        //                                    dynamicParameters = new DynamicParameters();
        //                                    sql = @"UPDATE MES.TrayMtlItemNg
        //                                             SET 
        //                                             NgQty = @NgQty,
        //                                             LastModifiedDate = @LastModifiedDate,
        //                                             LastModifiedBy = @LastModifiedBy
        //                                             WHERE TrayDismantleId = @TrayDismantleId AND BomDetailId = @BomDetailId";
        //                                    dynamicParameters.AddDynamicParams(
        //                                        new
        //                                        {
        //                                            NgQty = ngBomDetailCount,
        //                                            LastModifiedDate,
        //                                            LastModifiedBy,
        //                                            TrayDismantleId = trayDismantleId,
        //                                            BomDetailId = bomDetailId
        //                                        });

        //                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                                    #endregion
        //                                }
        //                                else
        //                                {
        //                                    #region //無物料拆解紀錄 INSERT子表
        //                                    dynamicParameters = new DynamicParameters();
        //                                    sql = @"INSERT INTO MES.TrayMtlItemNg(TrayDismantleId, BomDetailId, NgQty
        //                                             ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
        //                                             VALUES(@TrayDismantleId, @BomDetailId, @NgQty
        //                                             ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
        //                                    dynamicParameters.AddDynamicParams(
        //                                        new
        //                                        {
        //                                            TrayDismantleId = trayDismantleId,
        //                                            BomDetailId = bomDetailId,
        //                                            NgQty = ngBomDetailCount,
        //                                            CreateDate = DateTime.Now,
        //                                            LastModifiedDate = DateTime.Now,
        //                                            CreateBy,
        //                                            LastModifiedBy = CreateBy
        //                                        });

        //                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                                    #endregion
        //                                }
        //                            }


        //                        }
        //                    }
        //                    else
        //                    {
        //                        #region //新增拆解紀錄
        //                        dynamicParameters = new DynamicParameters();
        //                        sql = @"INSERT INTO MES.TrayDismantle(BarcodeId,TotalQty,DismantleQty
        //                            ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
        //                            OUTPUT Inserted.TrayDismantleId

        //                            VALUES(@BarcodeId,@TotalQty,@DismantleQty
        //                            ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
        //                        dynamicParameters.AddDynamicParams(
        //                            new
        //                            {
        //                                BarcodeId = barcodeId,
        //                                TotalQty = totalQty,
        //                                DismantleQty = NgcountQty,
        //                                CreateDate = DateTime.Now,
        //                                LastModifiedDate = DateTime.Now,
        //                                CreateBy,
        //                                LastModifiedBy = CreateBy
        //                            });

        //                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
        //                        int newtrayDismantleId = 0;

        //                        foreach (var item in insertResult)
        //                        {
        //                            newtrayDismantleId = item.TrayDismantleId;
        //                        }

        //                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                        #endregion

        //                        #region //新增物料拆解紀錄
        //                        foreach (var item2 in ngBomCountList)
        //                        {

        //                            int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

        //                            decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"INSERT INTO MES.TrayMtlItemNg(TrayDismantleId,BomDetailId,NgQty
        //                            ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
        //                            OUTPUT Inserted.TrayMtlItemNgId
        //                            VALUES(@TrayDismantleId,@BomDetailId,@NgQty
        //                            ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
        //                            dynamicParameters.AddDynamicParams(
        //                                new
        //                                {
        //                                    TrayDismantleId = newtrayDismantleId,
        //                                    BomDetailId = bomDetailId,
        //                                    NgQty = ngBomDetailCount,
        //                                    CreateDate = DateTime.Now,
        //                                    LastModifiedDate = DateTime.Now,
        //                                    CreateBy,
        //                                    LastModifiedBy = CreateBy
        //                                });

        //                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                        }

        //                        #endregion
        //                    }

        //                    #endregion

        //                    #region// INS/UPD MES.LensMtlItemNg

        //                    #region //找是否有Lens各物料拆解紀錄
        //                    foreach (var item2 in ngBomCountList)
        //                    {

        //                        int bomDetailId = Convert.ToInt32(item2.Split('❤')[0]);

        //                        decimal ngBomDetailCount = Convert.ToDecimal(item2.Split('❤')[1]);

        //                        dynamicParameters = new DynamicParameters();
        //                        sql = @"select a.TrayDismantleId, a.BarcodeId, b.BarcodeNo, a.TotalQty, a.DismantleQty
        //                                        from MES.LensMtlItemNg a
        //                                        WHERE a.TrayDismantleId = @TrayDismantleId AND a.BomDetailId = @BomDetailId and a.LensBarcodeId = @LensBarcodeId";

        //                        dynamicParameters.Add("TrayDismantleId", trayDismantleId);
        //                        dynamicParameters.Add("BomDetailId", bomDetailId);
        //                        dynamicParameters.Add("LensBarcodeId", inputbarcodeId);


        //                        var result6 = sqlConnection.Query(sql, dynamicParameters);
        //                        #endregion

        //                        if (result6.Count() > 0)
        //                        {
        //                            #region //有物料拆解紀錄 UPDATE子表
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"UPDATE MES.LensMtlItemNg
        //                                             SET 
        //                                             NgQty = @NgQty,
        //                                             LastModifiedDate = @LastModifiedDate,
        //                                             LastModifiedBy = @LastModifiedBy
        //                                             WHERE TrayDismantleId = @TrayDismantleId AND BomDetailId = @BomDetailId and LensBarcodeId = @LensBarcodeId";
        //                            dynamicParameters.AddDynamicParams(
        //                                new
        //                                {
        //                                    NgQty = ngBomDetailCount,
        //                                    LastModifiedDate,
        //                                    LastModifiedBy,
        //                                    TrayDismantleId = trayDismantleId,
        //                                    BomDetailId = bomDetailId,
        //                                    LensBarcodeId = inputbarcodeId
        //                                });

        //                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                            #endregion
        //                        }
        //                        else
        //                        {
        //                            #region //無物料拆解紀錄 INSERT子表
        //                            dynamicParameters = new DynamicParameters();
        //                            sql = @"INSERT INTO MES.LensMtlItemNg(TrayDismantleId, BomDetailId, NgQty
        //                                             ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy, LensBarcodeId)
        //                                             VALUES(@TrayDismantleId, @BomDetailId, @NgQty
        //                                             ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy, @LensBarcodeId)";
        //                            dynamicParameters.AddDynamicParams(
        //                                new
        //                                {
        //                                    TrayDismantleId = trayDismantleId,
        //                                    BomDetailId = bomDetailId,
        //                                    NgQty = ngBomDetailCount,
        //                                    CreateDate = DateTime.Now,
        //                                    LastModifiedDate = DateTime.Now,
        //                                    CreateBy,
        //                                    LastModifiedBy = CreateBy,
        //                                    LensBarcodeId = inputbarcodeId
        //                                });

        //                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                            #endregion
        //                        }
        //                    }


        //                    #endregion

        //                    dynamicParameters = new DynamicParameters();
        //                    sql = @"UPDATE MES.Barcode
        //                                    SET 
        //                                    CurrentProdStatus = @CurrentProdStatus,
        //                                    LastModifiedDate = @LastModifiedDate,
        //                                    LastModifiedBy = @LastModifiedBy
        //                                    WHERE BarcodeId = @BarcodeId";
        //                    dynamicParameters.AddDynamicParams(
        //                        new
        //                        {
        //                            CurrentProdStatus = "TN",
        //                            ParentBarcode = unllint,
        //                            LastModifiedDate,
        //                            LastModifiedBy,
        //                            BarcodeId = inputbarcodeId
        //                        });

        //                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
        //                    #endregion


        //                }

        //                #endregion
        //                else
        //                {
        //                    throw new SystemException("查無任何資料，請重新輸入");
        //                }

        //                #region //Response
        //                jsonResponse = JObject.FromObject(new
        //                {
        //                    status = "success",
        //                    msg = "(" + rowsAffected + " rows affected)",
        //                });
        //                #endregion
        //            }
        //            transactionScope.Complete();
        //        }
        //    }
        //    catch (Exception e)
        //    {
        //        #region //Response
        //        jsonResponse = JObject.FromObject(new
        //        {
        //            status = "errorForDA",
        //            msg = e.Message
        //        });
        //        #endregion

        //        logger.Error(e.Message);
        //    }

        //    return jsonResponse.ToString();
        //}
        #endregion
        #endregion


        #endregion

        #region //耗材管理

        #region //GetMachineMoInfo --取得機台製令資訊
        public string GetMachineMoInfo(int MachineId)
        {
            try
            {
                List<MachineConsume> machineConsume = new List<MachineConsume>();
                machineConsume.Add(new MachineConsume
                {

                    LotNumberId = -1,
                    MaxDispenseQty = -1,
                    AllowDispenseQty = -1,
                    OpeningDate = "",
                    EXPs = -1,
                    BindDate = "",
                    UnBindDate = "",
                    MachineId = -1,
                    MachineNo = "",
                    MachineName = "",
                    MachineDesc = "",
                    LotNumberNo = "",
                    BarcodeProcessId = -1,
                    MoId = -1,
                    BarcodeId = -1,
                    MoProcessId = -1,
                    FinishDate = "",
                    BarcodeNo = "",
                    CurrentMoProcessId = -1,
                    BarcodeQty = 0,
                    WoErpPrefix = "",
                    WoErpNo = "",
                    ProcessAlias = "",
                    MtlItemId = -1,
                    MtlItemNo = "",
                    MtlItemName = ""


                });

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.GrBarcodeId, a.MaxDispenseQty, a.AllowDispenseQty, FORMAT(a.OpeningDate, 'yyyy-MM-dd') OpeningDate, a.EXPs, FORMAT(a.BindDate, 'yyyy-MM-dd') BindDate
                            , b.MachineId, b.MachineNo, b.MachineName, b.MachineDesc
                             , c.BarcodeNo LotNumberNo
                            FROM MES.MachineConsumeLog a
                            inner JOIN MES.Machine b ON b.MachineId = a.MachineId
                            inner join SCM.GrBarcode c ON a.GrBarcodeId = c.GrBarcodeId
                            WHERE a.MachineId = @MachineId AND a.UnBindDate is null 
                            order by a.MachineConsumeLogId desc";

                    dynamicParameters.Add("MachineId", MachineId);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result1 = sqlConnection.Query(sql, dynamicParameters);

                    if (result1.Count() > 0) {
                        foreach (var item in result1)
                        {
                            machineConsume
                                            //.Where(y => y.MachineId == item.MachineId)
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.LotNumberId = item.LotNumberId;
                                                x.MaxDispenseQty = item.MaxDispenseQty;
                                                x.AllowDispenseQty = item.AllowDispenseQty;
                                                x.OpeningDate = item.OpeningDate;
                                                x.EXPs = item.EXPs;
                                                x.BindDate = item.BindDate;
                                                x.UnBindDate = item.UnBindDate;
                                                x.MachineId = item.MachineId;
                                                x.MachineNo = item.MachineNo;
                                                x.MachineName = item.MachineName;
                                                x.MachineDesc = item.MachineDesc;
                                                x.LotNumberNo = item.LotNumberNo;
                                            });
                        }
                    }


                    

                    dynamicParameters = new DynamicParameters();
                    sql = @"select TOP 1 a.BarcodeProcessId, a.MoId, a.BarcodeId ,a.MoProcessId, a.MachineId, FORMAT(a.FinishDate, 'yyyy-MM-dd') FinishDate
                            , a1.BarcodeNo, a1.CurrentMoProcessId, a1.BarcodeQty
                            , c.WoErpPrefix, c.WoErpNo
                            , d.MachineNo, d.MachineName, d.MachineDesc, d.MachineId
                            , e.ProcessAlias
                            , g.MtlItemId, g.MtlItemNo, g.MtlItemName
                            from MES.BarcodeProcess a
                            INNER JOIN MES.Barcode a1 ON a.BarcodeId = a1.BarcodeId
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                            INNER JOIN MES.Machine d ON a.MachineId = d.MachineId
                            inner join MES.MoProcess e on a1.CurrentMoProcessId = e.MoProcessId
                            inner join MES.Process f on e.ProcessId = f.ProcessId 
                            inner join PDM.MtlItem g on c.MtlItemId = g.MtlItemId
                            WHERE a.MachineId = @MachineId
                            and a.FinishDate is null
                            order by a.BarcodeProcessId desc";

                    dynamicParameters.Add("MachineId", MachineId);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result2 = sqlConnection.Query(sql, dynamicParameters);
                    if (result2.Count() > 0)
                    {
                        foreach (var item in result2)
                        {
                            machineConsume
                                            //.Where(y => y.MachineId == item.MachineId)
                                            .ToList()
                                            .ForEach(x =>
                                            {
                                                x.BarcodeProcessId = item.BarcodeProcessId;
                                                x.MoId = item.MoId;
                                                x.BarcodeId = item.BarcodeId;
                                                x.MoProcessId = item.MoProcessId;
                                                x.FinishDate = item.FinishDate;
                                                x.BarcodeNo = item.BarcodeNo;
                                                x.CurrentMoProcessId = item.CurrentMoProcessId;
                                                x.BarcodeQty = item.BarcodeQty;
                                                x.WoErpPrefix = item.WoErpPrefix;
                                                x.WoErpNo = item.WoErpNo;
                                                x.ProcessAlias = item.ProcessAlias;
                                                x.MtlItemId = item.MtlItemId;
                                                x.MtlItemNo = item.MtlItemNo;
                                                x.MtlItemName = item.MtlItemName;
                                                x.MachineId = item.MachineId;
                                                x.MachineNo = item.MachineNo;
                                                x.MachineName = item.MachineName;
                                                x.MachineDesc = item.MachineDesc;

                                            });
                        }
                    }
                        

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = machineConsume
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }

        #endregion

        #region //GetLotNumber --取得批號條碼資料
        public string GetLotNumber(string LnBarcodeNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();
                    sql = @"select a.GrBarcodeId, a.GrDetailId, a.BarcodeNo, b.LotNumberNo, b.CloseStatus, b.TransferStatus, FORMAT(b.FirstRecriptDate, 'yyyy-MM-dd HH:mm:ss') FirstRecriptDate 
                            , b.MtlItemId, c.MtlItemNo, c.MtlItemName, c.CompanyId
                            from SCM.GrBarcode a
							INNER JOIN SCM.GrDetail a1 ON a.GrDetailId = a1.GrDetailId
                            inner join SCM.LotNumber b on a1.LotNumber = b.LotNumberNo
                            inner join PDM.MtlItem c on b.MtlItemId = c.MtlItemId and a1.MtlItemId = c.MtlItemId

                            where a.BarcodeNo = @LnBarcodeNo";

                    dynamicParameters.Add("LnBarcodeNo", LnBarcodeNo);

                    //sql = @"select a.LotNumberId, a.LotNumberNo, a.CloseStatus, a.TransferStatus, FORMAT(a.FirstRecriptDate, 'yyyy-MM-dd HH:mm:ss') FirstRecriptDate 
                    //        , b.MtlItemId, b.MtlItemNo, b.MtlItemName, b.CompanyId
                    //        from SCM.LotNumber a
                    //        inner join PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                    //        where a.LotNumberNo = @LotNumberNo";

                    //dynamicParameters.Add("LotNumberNo", LnBarcodeNo);

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }

        #endregion

        #region //UpdateMachineConsume --更換耗材
        public string UpdateMachineConsume(int MachineId, string LnBarcodeNo, int BarcodeQty, string OpeningDate, int Exps, int AllowQty, int LotNumberId)
        {
            try
            {
                if (Exps <= 0) throw new SystemException("使用期限(天)不得為0!!");
                if (AllowQty <= 0) throw new SystemException("可使用數不得為0!!");


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        int UserId = CreateBy;
                        string nullstring = null;


                        #region //判斷機台資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MachineId
                                FROM MES.Machine a 
                                WHERE a.MachineId = @MachineId";
                        dynamicParameters.Add("MachineId", MachineId);

                        var MachineResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MachineResult.Count() <= 0) throw new SystemException("機台資料錯誤!!");


                        #endregion

                        #region //判斷物料條碼資料是否正確
                        int lnBarcodeId = -1;
                        dynamicParameters = new DynamicParameters();
                        sql = @"select a.GrBarcodeId, c.LotNumberNo, c.LotNumberId
                                from SCM.GrBarcode a
                                inner join SCM.GrDetail b on a.GrDetailId = b.GrDetailId
                                inner join SCM.LotNumber c on b.LotNumber = c.LotNumberNo
								inner join PDM.MtlItem d on b.MtlItemId = c.MtlItemId and b.MtlItemId = d.MtlItemId

                                where a.BarcodeNo = @LnBarcodeNo";
                        dynamicParameters.Add("LnBarcodeNo", LnBarcodeNo);

                        var LotNumberResult1 = sqlConnection.Query(sql, dynamicParameters);
                        //int lnBarcodeId = 0;

                        if (LotNumberResult1.Count() <= 0) throw new SystemException("批號物料條碼資料錯誤!!");
                        foreach (var item in LotNumberResult1)
                        {
                            lnBarcodeId = item.GrBarcodeId;
                            LotNumberId = item.LotNumberId;
                        }
                        #endregion

                        #region //判斷批號資料是否正確
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT a.LotNumberId
                        //        FROM SCM.LotNumber  a 
                        //        WHERE a.LotNumberId = @LotNumberId";
                        //dynamicParameters.Add("LotNumberId", LotNumberId);

                        //var LotNumberResult2 = sqlConnection.Query(sql, dynamicParameters);

                        //if (LotNumberResult2.Count() <= 0) throw new SystemException("批號資料錯誤!!");

                        #endregion

                        #region //是否有機台耗材正在使用紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"select TOP 1 * 
                                from MES.MachineConsumeLog a
                                where a.LotNumberId = @LotNumberId and a.UnBindDate is null
                                order by a.MachineConsumeLogId desc";
                        dynamicParameters.Add("LotNumberId", LotNumberId);

                        var MachineConsumeResult = sqlConnection.Query(sql, dynamicParameters);
                        int rowsAffected = 0;


                        if (LotNumberResult1.Count() > 0)
                        {
                            foreach (var item in MachineConsumeResult)
                            {
                                #region //UPATE
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MachineConsumeLog
                                SET 
								UnBindDate = @UnBindDate,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MachineConsumeLogId = @MachineConsumeLogId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        UnBindDate = LastModifiedDate,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MachineConsumeLogId = item.MachineConsumeLogId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion


                            }

                        }
                        #region //INSERT
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.MachineConsumeLog(MachineId, GrBarcodeId, LotNumberId, MaxDispenseQty, AllowDispenseQty, OpeningDate, EXPs, BindDate
                                    ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                    VALUES(@MachineId, @GrBarcodeId, @LotNumberId, @MaxDispenseQty, @AllowDispenseQty, @OpeningDate, @EXPs, @BindDate
                                    ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MachineId = MachineId,
                                GrBarcodeId = lnBarcodeId,
                                LotNumberId = LotNumberId,
                                MaxDispenseQty = AllowQty,
                                AllowDispenseQty = 0,
                                OpeningDate = OpeningDate,
                                EXPs = Exps,
                                BindDate = DateTime.Now,
                                CreateDate = DateTime.Now,
                                LastModifiedDate = DateTime.Now,
                                CreateBy,
                                LastModifiedBy = CreateBy
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                        #endregion



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //UpdateUnbindMachineConsume --解除耗材綁定
        public string UpdateUnbindMachineConsume(int MachineId)
        {
            try
            {
                if (MachineId <= 0) throw new SystemException("機台為空!!");


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();

                        int UserId = CreateBy;
                        string nullstring = null;


                        #region //判斷機台資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MachineId
                                FROM MES.Machine a 
                                WHERE a.MachineId = @MachineId";
                        dynamicParameters.Add("MachineId", MachineId);

                        var MachineResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MachineResult.Count() <= 0) throw new SystemException("機台資料錯誤!!");


                        #endregion



                        #region //是否有機台耗材正在使用紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"select TOP 1 * 
                                from MES.MachineConsumeLog a
                                where a.MachineId = @MachineId and a.UnBindDate is null
                                order by a.MachineConsumeLogId desc";
                        dynamicParameters.Add("MachineId", MachineId);

                        var MachineConsumeResult = sqlConnection.Query(sql, dynamicParameters);
                        int rowsAffected = 0;

                        if (MachineConsumeResult.Count() > 0) {
                            foreach (var item in MachineConsumeResult)
                            {
                                #region //UPATE
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.MachineConsumeLog
                                SET 
								UnBindDate = @UnBindDate,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MachineConsumeLogId = @MachineConsumeLogId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        UnBindDate = LastModifiedDate,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MachineConsumeLogId = item.MachineConsumeLogId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion


                            }

                        }

                        #endregion



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion


        #endregion


        #endregion

        #region //API
        #region //BarcodeProcessByRoboticArm -- MTF機械手臂過站入口 -- Ann 2024-04-22
        public string BarcodeProcessByRoboticArm(string Company, string BarcodeNo, int MoProcessId, string UserNo, int MachineId, int ProcessCount)
        {
            if (BarcodeNo == "") throw new Exception("BarcodeNo 不可為空");
            if (MoProcessId == -1) throw new Exception("MoProcessId 不可為空");
            if (UserNo.Length <= 0) throw new Exception("過站人員資料錯誤!!");

            try
            {
                int rowsAffected = 0;
                bool bInput = true;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb, a.CompanyId
                                FROM BAS.Company a
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        using (SqlConnection sqlConnection2 = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //取得MoId
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MoId, a.ProcessAlias
                                    , b.WoSeq
                                    , c.WoErpPrefix, c.WoErpNo
                                    FROM MES.MoProcess a
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                    WHERE a.MoProcessId = @MoProcessId";
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var MoIdResult = sqlConnection.Query(sql, dynamicParameters);

                            int MoId = -1;
                            string WoErpPrefix = "";
                            string WoErpNo = "";
                            string ProcessAlias = "";
                            int WoSeq = -1;
                            foreach (var item2 in MoIdResult)
                            {
                                MoId = item2.MoId;
                                WoErpPrefix = item2.WoErpPrefix;
                                WoErpNo = item2.WoErpNo;
                                ProcessAlias = item2.ProcessAlias;
                                WoSeq = item2.WoSeq;
                            }
                            #endregion

                            #region //確認製令狀態是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT RTRIM(LTRIM(TA011)) TA011
                                    FROM MOCTA
                                    WHERE TA001 = @WoErpPrefix
                                    AND TA002 = @WoErpNo";
                            dynamicParameters.Add("WoErpPrefix", WoErpPrefix);
                            dynamicParameters.Add("WoErpNo", WoErpNo);

                            var MOCTAResult = sqlConnection2.Query(sql, dynamicParameters);

                            if (MOCTAResult.Count() <= 0) throw new Exception("查無ERP製令相關資料!!");

                            foreach (var item in MOCTAResult)
                            {
                                if (item.TA011 == "Y" || item.TA011 == "y") throw new Exception("此製令已完工，無法刷取!!");
                            }
                            #endregion

                            #region //確認機台資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM MES.Machine a 
                                    WHERE a.MachineId = @MachineId";
                            dynamicParameters.Add("MachineId", MachineId);

                            var MachineResult = sqlConnection.Query(sql, dynamicParameters);

                            if (MachineResult.Count() <= 0) throw new SystemException("機台資料錯誤!!");
                            #endregion

                            #region //取得User資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT UserId
                                    FROM BAS.[User]
                                    WHERE UserNo = @UserNo";
                            dynamicParameters.Add("UserNo", UserNo);

                            var UserResult = sqlConnection.Query(sql, dynamicParameters);

                            if (UserResult.Count() <= 0) throw new SystemException("使用者資料錯誤!!");

                            int UserId = -1;
                            foreach (var item in UserResult)
                            {
                                UserId = item.UserId;
                            }
                            #endregion

                            #region //取得治具過站狀態
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.[Status] JigStatus,
                                           b.JigId,
                                           b.JigBarcodeId,
                                           b.BarcodeNo,
	                                       b.MoProcessId,
                                           b.WorkingFlag
                                      FROM MES.Jig a
                                           LEFT JOIN MES.JigBarcode b ON a.JigId = b.JigId
                                     WHERE JigNo = @BarcodeNo
                                       AND b.WorkingFlag = 'Y'";

                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                            var JigBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //確認是否為Tray模式
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayBarcode, a.Source
                                    FROM MES.MoSetting a
                                    WHERE MoId = @MoId";
                            dynamicParameters.Add("MoId", MoId);

                            var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                            string TrayBarcode = "";
                            string Source = "";
                            foreach (var item2 in MoSettingResult)
                            {
                                TrayBarcode = item2.TrayBarcode;
                                Source = item2.Source;
                            }

                            string TrayNo = "";
                            if (TrayBarcode == "Y" && Source == "BP")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TrayNo, ISNULL(a.BarcodeNo, '') BarcodeNo
                                        FROM MES.Tray a
                                        WHERE a.TrayNo = @TrayNo";
                                dynamicParameters.Add("TrayNo", BarcodeNo);

                                var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                                if (TrayResult.Count() <= 0) throw new SystemException("查無此條碼(" + BarcodeNo + ")綁定的Tray盤資訊!");

                                foreach (var item2 in TrayResult)
                                {
                                    //if (item2.BarcodeNo) throw new Exception("數量輸入錯誤");

                                    TrayNo = item2.TrayNo;
                                    BarcodeNo = item2.BarcodeNo;
                                }
                            }
                            #endregion

                            #region //確認條碼資料是否正確
                            if (BarcodeNo.Length > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT (
                                        SELECT TOP 1 1 FROM MES.BarcodeProcess x 
                                        WHERE x.MoProcessId = @MoProcessId
                                        AND x.BarcodeId = a.BarcodeId
                                        --AND x.FinishDate IS NULL
                                    ) BarcodeProcess, a.BarcodeQty
                                    FROM MES.Barcode a 
                                    WHERE a.BarcodeNo = @BarcodeNo
                                    AND a.MoId = @MoId";
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                if (BarcodeResult.Count() <= 0) throw new Exception("條碼【" + BarcodeNo + "】資料錯誤!!");

                                foreach (var item in BarcodeResult)
                                {
                                    if (Company != "JMO-CT") {
                                        if ( item.BarcodeQty != ProcessCount) throw new Exception("數量輸入錯誤");

                                    }

                                    if (item.BarcodeProcess == null)
                                    {
                                        bInput = true;
                                    }
                                    else
                                    {
                                        bInput = false;
                                    }
                                }
                            }
                            else
                            {

                                #region //找下一個要綁的條碼
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 a.BarcodeNo, a.BarcodeQty
                                                FROM MES.Barcode a
                                                LEFT JOIN MES.Tray b ON b.BarcodeNo = a.BarcodeNo
                                                WHERE a.MoId = @MoId AND b.BarcodeNo IS NULL AND a.CurrentProdStatus != 'F' AND a.BarcodeQty != 0
                                                ORDER BY a.BarcodeId";
                                dynamicParameters.Add("MoId", MoId);

                                var nextBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                if (nextBarcodeResult.Count() > 0)
                                {
                                    foreach (var item3 in nextBarcodeResult)
                                    {
                                        if (Company != "JMO-CT")
                                        {
                                            if (item3.BarcodeQty != ProcessCount) throw new Exception("數量輸入錯誤，與條碼數量不符!");

                                        }
                                        //BarcodeNo = item3.BarcodeNo;
                                    }
                                }

                                #endregion

                                bInput = true;
                            }
                            #endregion

                            #region //取得該站是否點膠
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT  a.MoProcessId, a.MoId, a.ProcessId, a.ProcessAlias,a1.ModeId
                            , c.MachineId, c.[Status], a.ConsumeFlag
                            FROM MES.MoProcess a
                            INNER JOIN MES.ManufactureOrder a1 on a.MoId =a1.MoId
                            INNER JOIN MES.ProcessParameter b ON a.ProcessId=b.ProcessId AND a1.ModeId =b.ModeId
                            INNER JOIN MES.ProcessMachine c ON b.ParameterId=c.ParameterId
                            WHERE 1=1
                            AND c.[Status] = 'A'
                            AND a.MoId = @MoId
                            AND c.MachineId = @MachineId
                            AND a.MoProcessId = @MoProcessId
                            ORDER BY a.MoProcessId";

                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("MachineId", MachineId);
                            dynamicParameters.Add("MoProcessId", MoProcessId);

                            var ConsumeFlagresult = sqlConnection.Query(sql, dynamicParameters);

                            string consumeFlag = "";
                            if (ConsumeFlagresult.Count() > 0)
                            {
                                foreach (var item in ConsumeFlagresult)
                                {
                                    consumeFlag = item.ConsumeFlag;

                                }
                            }
                            else {
                                throw new Exception("無此機台點膠資訊!! ");
                            }
                            #endregion
                            if (consumeFlag == "Y") {
                                #region //膠水相關卡控
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 b.MachineConsumeLogId
                            , e.MoMtlSettingId
							, b.EXPs, b.MaxDispenseQty, b.AllowDispenseQty
                            , FORMAT(b.BindDate, 'yyyy-MM-dd') BindDate
							, FORMAT(b.OpeningDate, 'yyyy-MM-dd') OpeningDate
                            FROM MES.Machine a 
                            LEFT JOIN MES.MachineConsumeLog b ON a.MachineId = b.MachineId AND b.UnBindDate IS NULL 
                            LEFT JOIN SCM.LotNumber c ON b.LotNumberId = c.LotNumberId
                            LEFT JOIN MES.WoDetail d ON c.MtlItemId = d.MtlItemId
                            LEFT JOIN MES.MoMtlSetting e ON d.WoDetailId = e.WoDetailId AND e.MoId = @MoId
                            LEFT JOIN PDM.MtlItem f ON c.MtlItemId = f.MtlItemId
                            WHERE a.MachineId = @MachineId 
                            AND (
                                b.MachineId IS NULL 
                                OR (b.MachineId IS NOT NULL AND e.MoId IS NOT NULL)
                            )
                            ORDER BY b.MachineConsumeLogId DESC ";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MachineId", MachineId);

                                var MachineConsumeresult = sqlConnection.Query(sql, dynamicParameters);

                                var today = DateTime.Now;
                                if (MachineConsumeresult.Count() > 0)
                                {
                                    foreach (var item in MachineConsumeresult)
                                    {
                                        if (item.MachineConsumeLogId == null) throw new Exception("此製程需綁定膠水!! ");

                                        if (item.MachineConsumeLogId != null)
                                        {
                                            DateTime openingDate = DateTime.Parse(item.OpeningDate);
                                            DateTime updatedDate = openingDate.AddDays(item.EXPs);
                                            var allowDispenseQty = item.AllowDispenseQty != null ? item.AllowDispenseQty : 0;
                                            if (today >= updatedDate) throw new Exception("膠水已過期!! ");
                                            if (allowDispenseQty >= item.MaxDispenseQty) throw new Exception("膠水已達到點膠次數上限!! ");
                                        }




                                    }
                                }

                                #endregion

                            }

                            #region //治具過站模式
                            if (JigBarcodeResult.Count() > 0)
                            {
                                foreach (var item in JigBarcodeResult)
                                {
                                    string JigStatus = item.JigStatus.ToString();
                                    if (JigStatus.Equals("S")) throw new SystemException("治具失效中,不可過站");

                                    string JigBarcodeNo = item.BarcodeNo.ToString();
                                    int JigMoProcessId = Convert.ToInt32(item.MoProcessId);

                                    MoProcessId = item.MoProcessId;

                                    #region //確認是否為Tray模式
                                    if (TrayNo.Length > 0)
                                    {
                                        JigBarcodeNo = TrayNo;
                                    }
                                    #endregion

                                    #region //判斷該治具是否可在此機台生產
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT 1
                                          FROM MES.Jig a
                                               INNER JOIN MES.MachineJig b ON a.JigId = b.JigId
                                         WHERE a.JigId = @JigId
                                           AND b.MachineId = @MachineId";

                                    dynamicParameters.Add("JigId", item.JigId);
                                    dynamicParameters.Add("MachineId", MachineId);
                                    var JigMachineCheck = sqlConnection.Query(sql, dynamicParameters);
                                    if (JigMachineCheck.Count() == 0) throw new SystemException("此治具不可在這機台生產!");
                                    #endregion

                                    TxBarcodeProcessCore(JigBarcodeNo, JigMoProcessId, MachineId, UserId,
                                        "", "", -1, sqlConnection, UserNo);

                                    #region //查詢條碼目前狀態是否非加工狀態
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.FinishDate
                                            FROM MES.BarcodeProcess a
                                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                            WHERE b.BarcodeNo = @BarcodeNo
                                            AND a.MoProcessId = @MoProcessId
                                            ORDER BY a.BarcodeProcessId DESC";
                                    dynamicParameters.Add("BarcodeNo", item.BarcodeNo);
                                    dynamicParameters.Add("MoProcessId", MoProcessId);

                                    var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                    if (BarcodeProcessResult.Count() <= 0) throw new SystemException("此條碼【" + item.BarcodeNo + "】查無過站歷程!!");
                                    #endregion

                                    #region //若完工，自動解除治具綁定
                                    foreach (var item2 in BarcodeProcessResult)
                                    {
                                        if (item2.FinishDate != null)
                                        {
                                            #region //刪除主要table
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"DELETE MES.JigBarcode
                                            WHERE JigBarcodeId = @JigBarcodeId";
                                            dynamicParameters.Add("JigBarcodeId", item.JigBarcodeId);

                                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                            #endregion

                                            #region //建立治具條碼歷史紀錄
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.JigBarcodeHistory (JigId, BarcodeNo, MoProcessId, WorkingFlag
                                            , CreateDate, CreateBy)
                                            OUTPUT INSERTED.HistoryId
                                            VALUES (@JigId, @BarcodeNo, @MoProcessId, @WorkingFlag
                                            , @CreateDate, @CreateBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    item.JigId,
                                                    item.BarcodeNo,
                                                    MoProcessId,
                                                    item.WorkingFlag,
                                                    CreateDate,
                                                    CreateBy
                                                });

                                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                            rowsAffected += insertResult.Count();
                                            #endregion
                                        }
                                    }
                                    #endregion

                                }
                            }
                            #endregion

                            #region //非治具過站模式
                            else // 非治具過站
                            {
                                int n;
                                bool isNumeric = int.TryParse(BarcodeNo, out n);
                                string productBarcodeNo = BarcodeNo;
                                if (TrayNo.Length > 0)
                                {
                                    BarcodeNo = TrayNo;
                                }

                                if (isNumeric == true)
                                {
                                    #region //判斷是否為刻字過站
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT d.BarcodeNo
                                        FROM MES.MoItemPart a
                                        INNER JOIN MES.BarcodeProcessAttribute b ON a.MoItemPartNo = b.ItemValue AND b.ItemNo = 'Lettering'
                                        INNER JOIN MES.BarcodeProcess c ON c.BarcodeProcessId = b.BarcodeProcessId
                                        INNER JOIN MES.Barcode d ON c.BarcodeId = d.BarcodeId
                                        WHERE a.MoItemPartId = @MoItemPartId
                                        AND a.MoId = @MoId";

                                    dynamicParameters.Add("MoItemPartId", BarcodeNo);
                                    dynamicParameters.Add("MoId", MoId);
                                    var AttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item in AttributeResult)
                                    {
                                        BarcodeNo = item.BarcodeNo;
                                    }
                                    #endregion
                                }

                                #region //將條碼轉成大寫
                                BarcodeNo = BarcodeNo.ToString().ToUpper();
                                #endregion

                                #region //判斷單顆過站時, 條碼不能被治具綁定狀態
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT b.JigNo
                                      FROM MES.JigBarcode a
                                           INNER JOIN MES.Jig b ON a.JigId = b.JigId
                                     WHERE a.JigId = b.JigId
                                       AND a.BarcodeNo = @BarcodeNo";

                                dynamicParameters.Add("BarcodeNo", productBarcodeNo);
                                var BarcodeJigCheck = sqlConnection.Query(sql, dynamicParameters);

                                if (BarcodeJigCheck.Count() > 0)
                                {
                                    throw new SystemException("條碼【" + productBarcodeNo + "】被綁定在治具［" + sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).JigNo + "］");
                                }
                                #endregion

                                #region //確認是否為試模製令及檢核相關卡控
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 a.MoMtlSettingId, a.MoProcessId BindMoProcessId, a.BindType
                                        FROM MES.MoMtlSetting a
                                        WHERE a.MoId = @MoId
                                        AND a.ProcessBinding = 'Y'
                                        AND a.MoProcessId = @MoProcessId
                                        AND a.MainBarcode = 'N'
                                        AND a.BindType != 'N'";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                var MoMtlSettingResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MoMtlSettingResult.Count() > 0)
                                {
                                    foreach (var item in MoMtlSettingResult)
                                    {
                                        #region //確認是否為開工未完工狀態
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                                FROM MES.BarcodeProcess a
                                                INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                                WHERE a.MoProcessId = @MoProcessId
                                                AND b.BarcodeNo = @BarcodeNo
                                                AND FinishDate IS NULL";
                                        dynamicParameters.Add("MoProcessId", MoProcessId);
                                        dynamicParameters.Add("BarcodeNo", productBarcodeNo);

                                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                        #endregion

                                        if (BarcodeProcessResult.Count() > 0)
                                        {
                                            if (item.BindType == "B")
                                            {
                                                #region //檢核組模時是否已將條碼都上料完成
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT Count(1) BarcodeComponent
                                                        , (
                                                          SELECT Count(1) Count
                                                          FROM MES.BarcodeComponent d
                                                          INNER JOIN MES.Barcode da ON d.ComponentBarcodeId = da.BarcodeId
                                                          WHERE da.MoId = c.MoId
                                                        ) RegisterCount
                                                        FROM MES.MrBarcodeRegister a
                                                        LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                                        LEFT JOIN MES.MrDetail c ON a.MrDetailId = c.MrDetailId
                                                        WHERE c.MoId = @MoId
                                                        GROUP BY c.MoId";
                                                dynamicParameters.Add("MoId", MoId);
                                                var mtlCountResult = sqlConnection.Query(sql, dynamicParameters);

                                                int RegisterCount = 0;
                                                foreach (var item2 in mtlCountResult)
                                                {
                                                    if (item.BindMoProcessId == MoProcessId && item2.RegisterCount <= 0) throw new SystemException("尚有模仁未做上料綁定，無法進行主條碼完工!!");
                                                    RegisterCount = item2.RegisterCount;
                                                }
                                                #endregion

                                                #region //檢核組模時屬性是否都已設定完成
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT a.ItemNo
                                                        FROM MES.MoMtlSettingAttribute a
                                                        WHERE a.MoMtlSettingId = @MoMtlSettingId";
                                                dynamicParameters.Add("MoMtlSettingId", item.MoMtlSettingId);

                                                var MoMtlSettingAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                                foreach (var item2 in MoMtlSettingAttributeResult)
                                                {
                                                    #region //取得目前上料條碼
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT a.BarcodeComponentId
                                                            , b.BarcodeNo
                                                            , c.ItemValue
                                                            FROM MES.BarcodeComponent a
                                                            INNER JOIN MES.Barcode b ON a.ComponentBarcodeId = b.BarcodeId
                                                            LEFT JOIN MES.BarcodeAttribute c ON b.BarcodeId = c.BarcodeId AND c.ItemNo = 'Lettering'
                                                            WHERE b.MoId = @MoId";
                                                    dynamicParameters.Add("MoId", MoId);

                                                    var BarcodeComponentIdResult = sqlConnection.Query(sql, dynamicParameters);
                                                    #endregion

                                                    foreach (var item3 in BarcodeComponentIdResult)
                                                    {
                                                        dynamicParameters = new DynamicParameters();
                                                        sql = @"SELECT TOP 1 1
                                                                FROM MES.BarcodeComponentAttribute a
                                                                WHERE a.BarcodeComponentId = @BarcodeComponentId
                                                                AND a.ItemNo = @ItemNo";
                                                        dynamicParameters.Add("BarcodeComponentId", item3.BarcodeComponentId);
                                                        dynamicParameters.Add("ItemNo", item2.ItemNo);

                                                        var BarcodeComponentAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                                        if (BarcodeComponentAttributeResult.Count() <= 0) throw new SystemException("條碼【" + item3.BarcodeNo + "(" + item3.ItemValue + ")】尚未完成屬性設定!!");
                                                    }
                                                }
                                                #endregion

                                                #region //若為最後一站拆模，則檢核是否條碼都已解除綁定
                                                //紘立無法使用，鏡頭上料會有問題
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TOP 1 1
                                                        FROM MES.MoProcess a
                                                        WHERE a.MoProcessId = @MoProcessId
                                                        AND a.SortNumber = (
                                                            SELECT MAX(x.SortNumber) SortNumber
                                                            FROM MES.MoProcess x
                                                            WHERE x.MoId = a.MoId
                                                        )";
                                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                                var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                                if (MoProcessResult.Count() > 0)
                                                {
                                                    if (RegisterCount != 0) throw new SystemException("尚有模仁尚未解除綁定，無法進行主條碼完工!!");
                                                }
                                                #endregion
                                            }
                                            else if (item.BindType == "L")
                                            {
                                                #region //先找出此製令用料下所有需批號上料之品號
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT b.MtlItemId
                                                        , c.MtlItemNo
                                                        FROM MES.MoMtlSetting a 
                                                        INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                                        INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                                        WHERE a.MoId = @MoId
                                                        AND a.ProcessBinding = 'Y'
                                                        AND a.MoProcessId = @MoProcessId
                                                        AND a.MainBarcode = 'N'
                                                        AND a.BindType = 'L'";
                                                dynamicParameters.Add("MoId", MoId);
                                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                                var MoMtlSettingResult2 = sqlConnection.Query(sql, dynamicParameters);

                                                if (MoMtlSettingResult2.Count() <= 0) throw new SystemException("查詢物料資料時發生錯誤!!");

                                                List<int> mtlItemIdList = new List<int>();
                                                List<int> errorMtlItemIdList = new List<int>();
                                                foreach (var item2 in MoMtlSettingResult2)
                                                {
                                                    #region //比對物料是否已上料
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT TOP 1 1
                                                            FROM MES.BarcodeComponent a
                                                            INNER JOIN SCM.LotNumber b ON a.LotNumberId = b.LotNumberId 
                                                            INNER JOIN MES.Barcode c ON a.AssemblyBarcodeId = c.BarcodeId
                                                            WHERE c.BarcodeNo = @BarcodeNo
                                                            AND a.MoProcessId = @MoProcessId
                                                            AND b.MtlItemId = @MtlItemId";
                                                    dynamicParameters.Add("BarcodeNo", productBarcodeNo);
                                                    dynamicParameters.Add("MoProcessId", MoProcessId);
                                                    dynamicParameters.Add("MtlItemId", item2.MtlItemId);

                                                    var BarcodeComponentResult2 = sqlConnection.Query(sql, dynamicParameters);

                                                    if (BarcodeComponentResult2.Count() <= 0)
                                                    {
                                                        errorMtlItemIdList.Add(item2.MtlItemId);
                                                    }
                                                    else
                                                    {
                                                        mtlItemIdList.Add(item2.MtlItemId);
                                                    }
                                                    #endregion
                                                }
                                                #endregion

                                                #region //確認未在載盤上的物料是否已有其他關聯物料註冊
                                                foreach (var item2 in errorMtlItemIdList)
                                                {
                                                    string item2MtlNo = "";
                                                    #region 取得品號
                                                    dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT a.MtlItemNo
                                                            FROM PDM.MtlItem a 
                                                            WHERE a.MtlItemId = @MtlItemId";
                                                    dynamicParameters.Add("MtlItemId", item2);
                                                    var MTLITEMNOResult = sqlConnection.Query(sql, dynamicParameters);
                                                    foreach (var NOitem in MTLITEMNOResult)
                                                    {
                                                        item2MtlNo = NOitem.MtlItemNo;
                                                    }

                                                        #endregion

                                                        dynamicParameters = new DynamicParameters();
                                                    sql = @"SELECT a.MtlItemId, a.SubstitutionId
                                                            FROM MES.MrDetail a 
                                                            WHERE a.MtlItemId = @MtlItemId
                                                            AND a.MoId = @MoId";
                                                    dynamicParameters.Add("MtlItemId", item2);
                                                    dynamicParameters.Add("MoId", MoId);

                                                    var MrDetailResult = sqlConnection.Query(sql, dynamicParameters);

                                                    if (MrDetailResult.Count() <= 0) throw new SystemException("物料【" + item2MtlNo + "】資料錯誤!!");

                                                    foreach (var item3 in MrDetailResult)
                                                    {
                                                        #region //本身為替代料
                                                        if (item3.MtlItemId != item3.SubstitutionId && item3.SubstitutionId != null)
                                                        {
                                                            if (mtlItemIdList.IndexOf(item3.SubstitutionId) == -1)
                                                            {
                                                                throw new SystemException("物料【" + item2MtlNo + "】尚未完成上料!!");
                                                            }
                                                        }
                                                        #region //本身為原BOM
                                                        else
                                                        {
                                                            dynamicParameters = new DynamicParameters();
                                                            sql = @"SELECT a.MtlItemId 
                                                                    FROM MES.MrDetail a 
                                                                    WHERE a.SubstitutionId = @MtlItemId 
                                                                    AND a.MtlItemId != a.SubstitutionId";
                                                            dynamicParameters.Add("MtlItemId", item2);

                                                            var SubResult = sqlConnection.Query(sql, dynamicParameters);

                                                            if (SubResult.Count() <= 0) throw new SystemException("物料【" + item2MtlNo + "】尚未完成上料!!");

                                                            bool checkFlag = false;
                                                            foreach (var item4 in SubResult)
                                                            {
                                                                if (mtlItemIdList.IndexOf(item4.MtlItemId) != -1)
                                                                {
                                                                    checkFlag = true;
                                                                    break;
                                                                }
                                                            }

                                                            if (!checkFlag) throw new SystemException("物料【" + item2MtlNo + "】尚未完成上料!!");
                                                        }
                                                        #endregion
                                                        #endregion
                                                    }
                                                }
                                                #endregion

                                                #region //檢核此主條碼是否已有綁定上料
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT TOP 1 1
                                                        FROM MES.BarcodeComponent a 
                                                        INNER JOIN MES.Barcode b ON a.AssemblyBarcodeId = b.BarcodeId
                                                        WHERE b.BarcodeNo = @AssemblyBarcodeNo
                                                        AND a.MoProcessId = @MoProcessId";
                                                dynamicParameters.Add("AssemblyBarcodeNo", productBarcodeNo);
                                                dynamicParameters.Add("MoProcessId", MoProcessId);

                                                var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                                                if (BarcodeComponentResult.Count() <= 0) throw new SystemException("尚未綁定任一物料!!");
                                                #endregion
                                            }
                                            else
                                            {
                                                throw new SystemException("上料方式【" + item.BindType + "】錯誤!!");
                                            }
                                        }
                                    }
                                }

                                #endregion

                                TxBarcodeProcessCore(BarcodeNo, MoProcessId, MachineId, UserId,
                                    "", "", -1, sqlConnection, UserNo);
                            }
                            #endregion

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                woErpFullNo = WoErpPrefix + "-" + WoErpNo + "("+ WoSeq.ToString() + ")",
                                barcodeNo = BarcodeNo,
                                processAlias = ProcessAlias,
                                bInput
                            });
                            #endregion
                        }
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion]

        #region //AddLotNgBarcodeProcessByRoboticArm -- MTF機械手臂刷取NG條碼 -- Ann 2024-04-22
        public string AddLotNgBarcodeProcessByRoboticArm(string Company, string UserNo, string BarcodeNo, string NgBarcodeNo, int NgBarcodeQty, string CauseId, int MachineId, string CauseNo, int MoProcessId)
        {
            try
            {
                int rowsAffected = 0;
                string NgToBarcode = "";
                int BarcodeQty = -1;
                int CurrentMoProcessId = -1;
                int NextMoProcessId = -1;
                int ModeShiftId = -1;
                int LotBarcodeQty = -1;
                int BarcodeProcessId = -1;
                int StationQty = -1;
                int ScrapQty = 0;
                int WipQty = 0;
                string CurrentProdStatus = "F";
                string BarcodeStatus = "";
                int BarcodeId = -1;
                string OriCurrentProdStatus = "";
                CauseNo = CauseNo.ToUpper();
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb, a.CompanyId
                                FROM BAS.Company a
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        #region //取得User資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId
                                FROM BAS.[User]
                                WHERE UserNo = @UserNo";
                        dynamicParameters.Add("UserNo", UserNo);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        if (UserResult.Count() <= 0) throw new SystemException("使用者資料錯誤!!");

                        int UserId = -1;
                        foreach (var item in UserResult)
                        {
                            UserId = item.UserId;
                        }
                        #endregion

                        #region //取得MoId
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId
                                , c.WoErpPrefix, c.WoErpNo
                                FROM MES.MoProcess a
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                WHERE a.MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var MoIdResult = sqlConnection.Query(sql, dynamicParameters);

                        int MoId = -1;
                        foreach (var item2 in MoIdResult)
                        {
                            MoId = item2.MoId;
                        }
                        #endregion

                        #region //取得製令用料設定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT NgToBarcode, TrayBarcode, Source
                                FROM MES.MoSetting a
                                WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MoSettingResult.Count() <= 0) throw new SystemException("找不到製令用料設定!");
                        string TrayBarcode = "";
                        string Source = "";
                        foreach (var item in MoSettingResult)
                        {
                            NgToBarcode = item.NgToBarcode;
                            TrayBarcode = item.TrayBarcode;
                            Source = item.Source;
                        }

                        string TrayNo = "";

                        if (TrayBarcode == "Y" && Source == "BP")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayNo, ISNULL(a.BarcodeNo, '') BarcodeNo
                                        FROM MES.Tray a
                                        WHERE a.TrayNo = @TrayNo";
                            dynamicParameters.Add("TrayNo", BarcodeNo);

                            var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TrayResult.Count() <= 0) throw new SystemException("查無此條碼(" + BarcodeNo + ")綁定的Tray盤資訊!");

                            foreach (var item2 in TrayResult)
                            {
                                TrayNo = item2.TrayNo;
                                BarcodeNo = item2.BarcodeNo;
                            }

                            
                        }
                        #endregion

                        #region //確認製令製程資料正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ProcessAlias, a.MoId
                                FROM MES.MoProcess a
                                WHERE MoProcessId = @MoProcessId";
                        dynamicParameters.Add("MoProcessId", MoProcessId);

                        var moProcessIdResult = sqlConnection.Query(sql, dynamicParameters);
                        if (moProcessIdResult.Count() <= 0) throw new SystemException("製令製程資料錯誤!");

                        string ProcessAlias = "";
                        foreach (var item in moProcessIdResult)
                        {
                            ProcessAlias = item.ProcessAlias;
                            MoId = item.MoId;
                        }
                        #endregion

                        if (NgToBarcode.Equals("Y"))
                        {
                            if (NgBarcodeNo.Length <= 0) throw new SystemException("此製令需刷取NG條碼!!");

                            #region //判斷NG條碼資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeQty CurrentNgBarcodeQty
                                    , c.CurrentMoProcessId, c.NextMoProcessId, ISNULL(c.CurrentProdStatus, 'F') CurrentProdStatus
                                    , d.ProcessAlias
                                    FROM MES.BarcodePrint a
                                    INNER JOIN MES.MoSetting b ON a.MoSettingId = b.MoSettingId
                                    LEFT JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo
                                    LEFT JOIN MES.MoProcess d ON c.CurrentMoProcessId = d.MoProcessId
                                    WHERE a.BarcodeNo = @BarcodeNo
                                    AND b.MoId = @MoId
                                    AND a.PrintStatus = 'F'";
                            dynamicParameters.Add("BarcodeNo", NgBarcodeNo);
                            dynamicParameters.Add("MoId", MoId);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("NG條碼【" + NgBarcodeNo + "】資料有誤!");

                            int CurrentNgBarcodeQty = -1;
                            foreach (var item in result)
                            {
                                CurrentNgBarcodeQty = item.CurrentNgBarcodeQty;
                                if (item.CurrentMoProcessId != null && item.CurrentMoProcessId != MoProcessId) throw new SystemException("該NG條碼目前站別為【" + item.ProcessAlias + "】!");
                                if (item.CurrentProdStatus != "F") throw new SystemException("該條碼目前狀態非【不良品】，無法綁定NG數量!!");
                            }
                            #endregion
                        }

                        #region //判斷NG原因是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CauseName
                                FROM QMS.DefectCause a
                                WHERE a.CauseNo = @CauseNo";
                        dynamicParameters.Add("CauseNo", CauseNo);

                        var CauseResult = sqlConnection.Query(sql, dynamicParameters);

                        if (CauseResult.Count() <= 0) throw new SystemException("NG原因資料有誤!");

                        string CauseName = "";
                        foreach (var item in CauseResult)
                        {
                            CauseName = item.CauseName;
                        }
                        #endregion

                        #region //判斷機台資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Machine a
                                WHERE a.MachineId = @MachineId";
                        dynamicParameters.Add("MachineId", MachineId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        if (result2.Count() <= 0) throw new SystemException("機台資料有誤!");
                        #endregion

                        #region //確認原始批量條碼資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeQty, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeStatus, a.CurrentProdStatus OriCurrentProdStatus
                                , b.BarcodeProcessId, b.StationQty, b.ModeShiftId
                                , c.BarcodeQty LotBarcodeQty
                                      FROM MES.Barcode a
                                           INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                           INNER JOIN MES.BarcodePrint c ON a.BarcodeNo = c.BarcodeNo
                                     WHERE a.BarcodeNo = @BarcodeNo
                                UNION ALL
                                SELECT a.BarcodeId, a.BarcodeQty, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeStatus, a.CurrentProdStatus OriCurrentProdStatus
                                       , b.BarcodeProcessId, b.StationQty, b.ModeShiftId
                                       , c.BarcodeQty LotBarcodeQty
                                      FROM MES.Barcode a
                                           INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                           INNER JOIN MES.Barcode c ON a.BarcodeNo = c.BarcodeNo
                                     WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        if (result3.Count() <= 0) throw new SystemException("條碼【" + BarcodeNo + "】資訊有誤!");

                        foreach (var item in result3)
                        {
                            BarcodeId = item.BarcodeId;
                            BarcodeQty = item.BarcodeQty;
                            CurrentMoProcessId = item.CurrentMoProcessId;
                            NextMoProcessId = item.NextMoProcessId;
                            ModeShiftId = item.ModeShiftId;
                            LotBarcodeQty = item.LotBarcodeQty;
                            BarcodeProcessId = item.BarcodeProcessId;
                            StationQty = item.StationQty;
                            BarcodeStatus = item.BarcodeStatus;
                            OriCurrentProdStatus = item.OriCurrentProdStatus;

                            if (NgBarcodeQty > BarcodeQty) throw new SystemException("NG條碼數量不能大於原先條碼數量!");
                        }
                        #endregion

                        #region //INSERT OR UPDATE MES.Barcode

                        #region //若需刷NG條碼則使用NG條碼, 否則一站使用一張虛擬NG條碼
                        if (!NgToBarcode.Equals("Y"))
                        {
                            #region // 先判斷此製程有沒有未必庫的NG條碼, 如果有就延用, 如果沒有產生一筆新的
                            //1.先找出此製程有沒有NG碼
                            //2.如果有NG碼, 要判斷NG條碼是否已入庫
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.BarcodeNo,b.CurrentProdStatus,b.BarcodeStatus,
                                           SUM(a.StationQty) StationQty
                                      FROM MES.BarcodeProcess a
                                           INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                     WHERE a.MoProcessId = @MoProcessId
                                       AND b.CurrentProdStatus = 'S'
                                       GROUP BY b.BarcodeNo,b.CurrentProdStatus,b.BarcodeStatus
                                        ORDER BY b.BarcodeNo DESC";

                            dynamicParameters.Add("MoProcessId", MoProcessId);
                            var NgBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (NgBarcodeResult.Count() <= 0)
                            {
                                NgBarcodeNo = CurrentMoProcessId.ToString() + "NG001";
                            }
                            else
                            {
                                NgBarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;
                                //找看有沒有報廢未入庫的條碼
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT 1
                                          FROM MES.BarcodeProcess a
                                               INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                         WHERE a.MoProcessId = @MoProcessId
                                           AND b.CurrentProdStatus = 'S'
                                           AND b.BarcodeStatus = '0'
                                            ORDER BY b.CreateDate DESC";

                                dynamicParameters.Add("MoProcessId", MoProcessId);
                                var Ng8BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                if (Ng8BarcodeResult.Count() <= 0)
                                {
                                    int NgSequence = Convert.ToInt32(NgBarcodeNo.Substring(NgBarcodeNo.Length - 3, 3)) + 1;
                                    NgBarcodeNo = NgBarcodeNo.Substring(0, NgBarcodeNo.Length - 3) + NgSequence.ToString().PadLeft(3, '0');
                                }
                            }

                            #endregion


                            CurrentProdStatus = "S";
                        }
                        #endregion

                        #region //NG條碼流程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId NgBarcodeId, a.BarcodeQty
                                FROM MES.Barcode a
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", NgBarcodeNo);

                        var result4 = sqlConnection.Query(sql, dynamicParameters);

                        int NgBarcodeId = -1;
                        if (result4.Count() <= 0)
                        {
                            #region //INSERT
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeId
                                    VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BarcodeNo = NgBarcodeNo,
                                    CurrentMoProcessId,
                                    NextMoProcessId = NgToBarcode.Equals("Y") ? NextMoProcessId : -1,
                                    MoId,
                                    BarcodeQty = NgBarcodeQty,
                                    BarcodeProcessId = -1,
                                    CurrentProdStatus = NgToBarcode.Equals("Y") ? "F" : "S",
                                    BarcodeStatus = NgToBarcode.Equals("Y") ? "1" : "0",
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();

                            foreach (var item in insertResult)
                            {
                                NgBarcodeId = item.BarcodeId;
                            }
                            #endregion
                        }
                        else
                        {
                            #region //UPDATE
                            foreach (var item in result4)
                            {
                                NgBarcodeId = item.NgBarcodeId;

                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        CurrentMoProcessId = @CurrentMoProcessId,
                                        NextMoProcessId = @NextMoProcessId,
                                        MoId = @MoId,
                                        BarcodeQty = @BarcodeQty,
                                        CurrentProdStatus = @CurrentProdStatus,
                                        BarcodeStatus = @BarcodeStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        CurrentMoProcessId,
                                        NextMoProcessId,
                                        MoId,
                                        BarcodeQty = item.BarcodeQty + NgBarcodeQty,
                                        CurrentProdStatus = NgToBarcode.Equals("Y") ? "F" : "S",
                                        BarcodeStatus = NgToBarcode.Equals("Y") ? "1" : "0",
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeNo = NgBarcodeNo
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            }
                            #endregion
                        }
                        #endregion

                        #endregion

                        #region //INSERT MES.BarcodeProcess
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, CauseNo
                                , StartDate, FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeProcessId, INSERTED.BarcodeId
                                VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @CauseNo
                                , @StartDate, @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeId = NgBarcodeId,
                                MoId,
                                MachineId,
                                MoProcessId = CurrentMoProcessId,
                                ProdStatus = NgToBarcode.Equals("Y") ? "F" : "S",
                                StationQty = NgBarcodeQty,
                                PassQty = 0,
                                NgQty = NgBarcodeQty,
                                CauseNo,
                                StartDate = CreateDate,
                                FinishDate = LastModifiedDate,
                                ModeShiftId,
                                CycleTime = 0,
                                StartUserId = UserId,
                                FinishUserId = UserId,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();

                        int ToBarcodeProcessId = -1;
                        foreach (var item in insertResult2)
                        {
                            ToBarcodeProcessId = item.BarcodeProcessId;
                        }
                        #endregion

                        #region //UPDATE 原本MES.Barcode BarcodeQty
                        //if (BarcodeQty - NgBarcodeQty == 0)
                        //{
                        //    BarcodeStatus = "0";
                        //    NextMoProcessId = -1;
                        //}
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty - @NgBarcodeQty,
                                BarcodeStatus = @BarcodeStatus,
                                NextMoProcessId = @NextMoProcessId,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                NgBarcodeQty,
                                BarcodeStatus,
                                NextMoProcessId,
                                LastModifiedDate,
                                LastModifiedBy = UserId,
                                BarcodeNo
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion



                        TxBarcodeProcessCore(TrayNo, MoProcessId, MachineId, UserId,
                                    "", "", -1, sqlConnection, UserNo);

                        #region //UPDATE原本的BarcodeProcess StationQty
                        dynamicParameters = new DynamicParameters();
                        if (BarcodeQty - NgBarcodeQty == 0)
                        {
                            sql = @"UPDATE MES.BarcodeProcess SET
                                    StationQty = StationQty - @NgBarcodeQty,
                                    PassQty = PassQty - @NgBarcodeQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NgBarcodeQty,
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    BarcodeProcessId
                                });
                        }
                        else
                        {
                            sql = @"UPDATE MES.BarcodeProcess SET
                                    StationQty = StationQty - @NgBarcodeQty,
                                    PassQty = PassQty - @NgBarcodeQty,
                                   
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeProcessId = @BarcodeProcessId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NgBarcodeQty,
                                    
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    BarcodeProcessId
                                });
                        }

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion


                        #region //重新計算條碼狀態報表資料
                        UpdateMoQtyInformation(MoId);
                        #endregion

                        #region //INSERT MES.BarcodeTransfer
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeTransfer (FromBarcodeProcessId, ToBarcodeProcessId, TransactionDate, FromBarcodeId, ToBarcodeId, TransactionQty
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.TransactionId
                                VALUES (@FromBarcodeProcessId, @ToBarcodeProcessId, @TransactionDate, @FromBarcodeId, @ToBarcodeId, @TransactionQty
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FromBarcodeProcessId = BarcodeProcessId,
                                ToBarcodeProcessId,
                                TransactionDate = CreateDate,
                                FromBarcodeId = BarcodeId,
                                ToBarcodeId = NgBarcodeId,
                                TransactionQty = NgBarcodeQty,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult3.Count();
                        #endregion

                        #region //INSERT MES.AdvancedLog
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.AdvancedLog (BarcodeId, MoProcessId, OriNextMoProcessId, NextMoProcessId, OriQty, Qty, OriCurrentProdStatus, CurrentProdStatus, CauseNo
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@BarcodeId, @MoProcessId, @OriNextMoProcessId, @NextMoProcessId, @OriQty, @Qty, @OriCurrentProdStatus, @CurrentProdStatus, @CauseNo
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeId,
                                MoProcessId,
                                OriNextMoProcessId = NextMoProcessId,
                                NextMoProcessId,
                                OriQty = StationQty,
                                Qty = StationQty - NgBarcodeQty,
                                OriCurrentProdStatus,
                                CurrentProdStatus = NgToBarcode == "Y" ? "F" : "S",
                                CauseNo,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult2.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            ngToBarcode = NgToBarcode,
                            barcodeNo = BarcodeNo,
                            ngBarcodeNo = NgBarcodeNo,
                            ngBarcodeQty = NgBarcodeQty,
                            causeNo = CauseNo,
                            causeName = CauseName
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMoProcessByRoboticArm -- MTF機械手臂取得製令製程資料 -- Ann 2024-05-16
        public string GetMoProcessByRoboticArm(string Company, string WoErpFullNo, int MachineId)
        {
            try
            {
                if (WoErpFullNo.IndexOf("-") == 1) {
                    if (WoErpFullNo.IndexOf("(") == -1) throw new SystemException("需輸入完整製令，且包括括號!!例如:5101-20240516001(1)");
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyId
                            FROM BAS.Company a
                            WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        #region //確認製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId
                            FROM MES.ManufactureOrder a 
                            INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                            WHERE b.WoErpPrefix + '-' + b.WoErpNo + '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')' = @WoErpFullNo
                            AND b.CompanyId = @CompanyId";
                        dynamicParameters.Add("WoErpFullNo", WoErpFullNo);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ManufactureOrderResult.Count() <= 0) throw new SystemException("查無此製令【" + WoErpFullNo + "】資料!!");

                        int MoId = -1;
                        foreach (var item in ManufactureOrderResult)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //取得此機台可以過站之製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoProcessId, a.ProcessAlias
                            FROM MES.MoProcess a 
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            WHERE a.MoId = @MoId
                            AND EXISTS (
                                SELECT TOP 1 1
                                FROM MES.ProcessMachine x 
                                INNER JOIN MES.ProcessParameter xa ON x.ParameterId = xa.ParameterId
                                WHERE x.MachineId = @MachineId
                                AND xa.ModeId = b.ModeId
                                AND xa.ProcessId = a.ProcessId
                            )";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MachineId", MachineId);

                        var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoProcessResult.Count() <= 0) throw new SystemException("此製令【" + WoErpFullNo + "】機台查無任何可過站之製程資料!!");
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = MoProcessResult
                        });
                        #endregion
                    }
                }
                else {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CompanyId
                            FROM BAS.Company a
                            WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        #region //確認製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoId
                            FROM MES.ManufactureOrder a 
                            INNER JOIN MES.WipOrder b ON a.WoId = b.WoId
                            WHERE  b.WoErpPrefix + '-' + b.WoErpNo + '(' + CONVERT(VARCHAR(10), a.WoSeq) + ')' = @WoErpFullNo
                            AND b.CompanyId = @CompanyId";
                        dynamicParameters.Add("WoErpFullNo", WoErpFullNo);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var ManufactureOrderResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ManufactureOrderResult.Count() <= 0) throw new SystemException("查無此製令【" + WoErpFullNo + "】資料!!");

                        int MoId = -1;
                        foreach (var item in ManufactureOrderResult)
                        {
                            MoId = item.MoId;
                        }
                        #endregion

                        #region //取得此機台可以過站之製程
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MoProcessId, a.ProcessAlias
                            FROM MES.MoProcess a 
                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                            WHERE a.MoId = @MoId
                            AND EXISTS (
                                SELECT TOP 1 1
                                FROM MES.ProcessMachine x 
                                INNER JOIN MES.ProcessParameter xa ON x.ParameterId = xa.ParameterId
                                WHERE x.MachineId = @MachineId
                                AND xa.ModeId = b.ModeId
                                AND xa.ProcessId = a.ProcessId
                            )";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MachineId", MachineId);

                        var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MoProcessResult.Count() <= 0) throw new SystemException("此製令【" + WoErpFullNo + "】機台查無任何可過站之製程資料!!");
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = MoProcessResult
                        });
                        #endregion
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //BarcodeMergerTransactionAfterInwardForApi-- 入庫後條碼拆併盤作業 -- Luca 2024-12-24
        public string BarcodeMergerTransactionAfterInwardForApi(string Company, string UserNo, string FromBarcodeNo, string ToBarcodeNo, int TransactionQty)
        {
            try
            {
                if (FromBarcodeNo.Length <= 0) throw new SystemException("【來源條碼】不能為空!");
                if (ToBarcodeNo.Length <= 0) throw new SystemException("【目標條碼】不能為空!");
                if (TransactionQty <= 0) throw new SystemException("【拆併數量】必須大於0!");
                if (FromBarcodeNo == ToBarcodeNo) throw new SystemException("來源及目標條碼不能相同!!");
                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb, a.CompanyId
                         FROM BAS.Company a
                         WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        #region //取得User資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId
                         FROM BAS.[User]
                         WHERE UserNo = @UserNo";
                        dynamicParameters.Add("UserNo", UserNo);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        if (UserResult.Count() <= 0) throw new SystemException("使用者資料錯誤!!");

                        int UserId = -1;
                        foreach (var item in UserResult)
                        {
                            UserId = item.UserId;
                        }
                        #endregion

                        #region //將條碼轉成大寫
                        FromBarcodeNo = FromBarcodeNo.ToString().ToUpper();
                        ToBarcodeNo = ToBarcodeNo.ToString().ToUpper();
                        #endregion

                        #region //確認來源條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.MoId, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                         , c.MtlItemId
                         FROM MES.Barcode a 
                         INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                         INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                         WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);

                        var FromBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (FromBarcodeResult.Count() <= 0) throw new SystemException("查無【來源條碼】相關資料，請確認資料是否有誤!");

                        int FromMoId = -1;
                        int FromBarcodeId = -1;
                        int FromMtlItemId = -1;
                        int FromBarcodeQty = 0;
                        foreach (var item in FromBarcodeResult)
                        {
                            if (item.BarcodeQty < TransactionQty) throw new SystemException("轉移數量已超過來源條碼目前數量【" + item.BarcodeQty + "】!");
                            if (item.CurrentProdStatus != "P") throw new SystemException("【來源條碼】狀態非良品!");
                            if (item.BarcodeStatus != "8") throw new SystemException("【來源條碼】狀態尚未入庫!");
                            FromMoId = item.MoId;
                            FromBarcodeId = item.BarcodeId;
                            FromMtlItemId = item.MtlItemId;
                            FromBarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //取得來源條碼批號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ISNULL(b.LotNumber, '')  LotNumber
                         FROM MES.MweBarcode a 
                         INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                         WHERE a.BarcodeId = @BarcodeId 
                         ANd b.MoId = @MoId 
                         ORDER BY b.CreateDate DESC";
                        dynamicParameters.Add("BarcodeId", FromBarcodeId);
                        dynamicParameters.Add("MoId", FromMoId);

                        var FromMweBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (FromMweBarcodeResult.Count() <= 0) throw new SystemException("查無此【來源條碼】的入庫單紀錄!");

                        string FromLotNumber = "";
                        foreach (var item in FromMweBarcodeResult)
                        {
                            if (item.LotNumber.Length <= 0) throw new SystemException("此【來源條碼】最近一次的入庫單尚未維護批號!");
                            FromLotNumber = item.LotNumber;
                        }
                        #endregion

                        #region //確認來源條碼無被其他條碼註冊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 
                         FROM MES.Barcode a 
                         INNER JOIN MES.Barcode b ON a.ParentBarcode = b.BarcodeId
                         WHERE b.BarcodeNo = @FromBarcodeNo";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);

                        var ParentBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ParentBarcodeResult.Any()) throw new SystemException("此【來源條碼】已被其他條碼註冊!");
                        #endregion

                        #region //確認來源條碼無被其他條碼註冊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 
                         FROM MES.Barcode a 
                         INNER JOIN MES.Barcode b ON a.PrevBarcodeId = b.BarcodeId
                         WHERE b.BarcodeNo = @FromBarcodeNo";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);

                        var PrevBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (PrevBarcodeResult.Any()) throw new SystemException("此【來源條碼】為包裝條碼!");
                        #endregion

                        #region //確認目標條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.MoId, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                         , c.MtlItemId
                         FROM MES.Barcode a 
                         INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                         INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                         WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", ToBarcodeNo);

                        var ToBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ToBarcodeResult.Count() <= 0) throw new SystemException("查無【目標條碼】相關資料，請確認資料是否有誤!");

                        int ToMoId = -1;
                        int ToBarcodeId = -1;
                        int ToMtlItemId = -1;
                        int ToBarcodeQty = 0;
                        foreach (var item in ToBarcodeResult)
                        {
                            if (item.CurrentProdStatus != "P") throw new SystemException("【目標條碼】狀態非良品!");
                            if (item.BarcodeStatus != "8") throw new SystemException("【目標條碼】狀態尚未入庫!");
                            ToMoId = item.MoId;
                            ToBarcodeId = item.BarcodeId;
                            ToMtlItemId = item.MtlItemId;
                            ToBarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //取得目標條碼批號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ISNULL(b.LotNumber, '')  LotNumber
                         FROM MES.MweBarcode a 
                         INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                         WHERE a.BarcodeId = @BarcodeId 
                         ANd b.MoId = @MoId 
                         ORDER BY b.CreateDate DESC";
                        dynamicParameters.Add("BarcodeId", ToBarcodeId);
                        dynamicParameters.Add("MoId", ToMoId);

                        var ToMweBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ToMweBarcodeResult.Count() <= 0) throw new SystemException("查無此【目標條碼】的入庫單紀錄!");

                        string ToLotNumber = "";
                        foreach (var item in ToMweBarcodeResult)
                        {
                            if (item.LotNumber.Length <= 0) throw new SystemException("此【目標條碼】最近一次的入庫單尚未維護批號!");
                            ToLotNumber = item.LotNumber;
                        }
                        #endregion

                        #region //檢核來源及目標條碼的品號及批號要相同
                        if (FromMtlItemId != ToMtlItemId || FromLotNumber != ToLotNumber)
                        {
                            throw new SystemException("來源條碼及目標條碼的【品號】或【批號】不同!");
                        }
                        #endregion

                        #region //更新來源條碼數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                         BarcodeQty = BarcodeQty - @TransactionQty,
                         LastModifiedDate = @LastModifiedDate,
                         LastModifiedBy = @LastModifiedBy
                         WHERE BarcodeId = @FromBarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                LastModifiedDate,
                                LastModifiedBy = UserId,
                                FromBarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新目標條碼數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                         BarcodeQty = BarcodeQty + @TransactionQty,
                         LastModifiedDate = @LastModifiedDate,
                         LastModifiedBy = @LastModifiedBy
                         WHERE BarcodeId = @ToBarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                LastModifiedDate,
                                LastModifiedBy = UserId,
                                ToBarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //新增調整紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeTransfer (TransactionDate, FromBarcodeId, ToBarcodeId, TransactionQty
                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                        VALUES (@TransactionDate, @FromBarcodeId, @ToBarcodeId, @TransactionQty
                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionDate = DateTime.Now,
                                FromBarcodeId,
                                ToBarcodeId,
                                TransactionQty,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //重新查詢目標及來源條碼數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeQty FromBarcodeQty,
                         (
                             SELECT x.BarcodeQty 
                             FROM MES.Barcode x 
                             WHERE x.BarcodeNo = @ToBarcodeNo
                         ) ToBarcodeQty
                         FROM MES.Barcode a
                         WHERE a.BarcodeNo = @FromBarcodeNo";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);
                        dynamicParameters.Add("ToBarcodeNo", ToBarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            BarcodeResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddLotBarcodeQtyMergeForApi-- 新增批量條碼拆併盤資料 -- Luca 2024-12-24
        public string AddLotBarcodeQtyMergeForApi(string Company, string UserNo, int MoId, string FromBarcodeNo, string ToBarcodeNo, int TransactionQty, string MinBarcodes)
        {
            try
            {
                if (TransactionQty <= 0) throw new SystemException("【拆併數量】不能為空!");
                if (FromBarcodeNo == ToBarcodeNo) throw new SystemException("來源及目標條碼不能相同!!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb, a.CompanyId
                         FROM BAS.Company a
                         WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        #region //取得User資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId
                         FROM BAS.[User]
                         WHERE UserNo = @UserNo";
                        dynamicParameters.Add("UserNo", UserNo);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        if (UserResult.Count() <= 0) throw new SystemException("使用者資料錯誤!!");

                        int UserId = -1;
                        foreach (var item in UserResult)
                        {
                            UserId = item.UserId;
                        }
                        #endregion
                        int rowsAffected = 0;

                        #region //判斷製令資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MoSettingId, b.LotStatus, b.LotQty, b.NgToBarcode, b.TrayBarcode, b.Source
                                    , b.BarcodePrefix, b.SequenceLen, b.BarcodePostfix
                                FROM MES.ManufactureOrder a
                                     INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                WHERE a.MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("製令資料錯誤!");
                        int LotQty = Convert.ToInt32(sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).LotQty);
                        string NgToBarcode = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NgToBarcode;
                        string TrayBarcode = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).TrayBarcode;
                        string LotStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).LotStatus;
                        string Source = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Source;
                        string BarcodePrefix = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodePrefix;
                        int SequenceLen = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).SequenceLen;
                        string BarcodePostfix = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodePostfix;
                        int MoSettingId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoSettingId;
                        #endregion

                        #region //若TrayBarcode為Y, 則replace fromBarcode & ToBarcode
                        bool newToBarcode = false;
                        if (TrayBarcode.Equals("Y"))
                        {
                            #region //來源Tray
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayId,a.TrayNo,a.BarcodeNo,a.TrayCapacity
                                        , b.CurrentMoProcessId, b.NextMoProcessId, b.BarcodeStatus, b.CurrentProdStatus
                                        FROM MES.Tray a
                                            INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                    WHERE a.TrayNo = @TrayNo
                                        AND a.[Status] = 'A'
                                        AND a.CompanyId = @CompanyId";

                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("TrayNo", FromBarcodeNo);
                            var FromBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (FromBarcodeResult.Count() <= 0) throw new SystemException("該Tray盤Barcode資料錯誤,找不到對應資料!");
                            FromBarcodeNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BarcodeNo;
                            int FromCurrentMoProcessId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentMoProcessId;
                            int FromNextMoProcessId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).NextMoProcessId;
                            string FromCurrentProdStatus = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentProdStatus;
                            #endregion

                            #region //目標Tray
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayId,a.TrayNo,a.BarcodeNo,a.TrayCapacity
                                        FROM MES.Tray a
                                            LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                        WHERE a.TrayNo = @TrayNo
                                            AND a.[Status] = 'A'
                                            AND a.CompanyId = @CompanyId";

                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            dynamicParameters.Add("TrayNo", ToBarcodeNo);
                            var ToBarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                            if (ToBarcodeResult.Count() <= 0) throw new SystemException("該Tray盤Barcode資料錯誤,找不到對應資料!");

                            int ToTrayId = -1;
                            foreach (var item in ToBarcodeResult)
                            {
                                ToTrayId = item.TrayId;

                                if (item.BarcodeNo == null)
                                {
                                    newToBarcode = true;

                                    #region //自動建立BarcodePrint
                                    #region //取得最大序列號條碼
                                    string seq = "";
                                    seq = GetNewBarcodeNo(BarcodePrefix, SequenceLen, BarcodePostfix).PadLeft(SequenceLen, '0');
                                    ToBarcodeNo = BarcodePrefix + seq + BarcodePostfix;
                                    string GetNewBarcodeNo(string thisBarcodePrefix, int thisSequenceLen, string thisBarcodePostfix)
                                    {
                                        string NewBarcodeNo = "";
                                        #region //找此BARCODE格式最大號
                                        #region //組模糊查詢字串
                                        string SearchLikeStrig = "";
                                        for (int j = 1; j <= thisSequenceLen; j++)
                                        {
                                            SearchLikeStrig += "_";
                                        }
                                        #endregion

                                        string queryModal = "";
                                        if (thisBarcodePrefix.IndexOf("[") != -1)
                                        {
                                            char[] prefixList = thisBarcodePrefix.ToCharArray();

                                            for (int i = 0; i < prefixList.Length; i++)
                                            {
                                                if (prefixList[i] == '[') queryModal += "|";
                                                queryModal += prefixList[i];
                                            }

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                    FROM MES.BarcodePrint
                                                    WHERE BarcodeNo LIKE '%" + queryModal + SearchLikeStrig + thisBarcodePostfix + "%' ESCAPE '|'";
                                        }
                                        else if (thisBarcodePostfix.IndexOf("[") != -1)
                                        {
                                            char[] postfixList = thisBarcodePostfix.ToCharArray();

                                            for (int i = 0; i < postfixList.Length; i++)
                                            {
                                                if (postfixList[i] == '[') queryModal += "|";
                                                queryModal += postfixList[i];
                                            }

                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                    FROM MES.BarcodePrint
                                                    WHERE BarcodeNo LIKE '%" + thisBarcodePrefix + SearchLikeStrig + queryModal + "%' ESCAPE '|'";
                                        }
                                        else
                                        {
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT MAX(BarcodeNo) MaxBarcodeNo
                                                    FROM MES.BarcodePrint
                                                    WHERE BarcodeNo LIKE '" + thisBarcodePrefix + SearchLikeStrig + thisBarcodePostfix + "%'";
                                        }

                                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                        foreach (var item2 in BarcodeResult)
                                        {
                                            string MaxBarcodeNo = item2.MaxBarcodeNo;
                                            if (item2.MaxBarcodeNo == null)
                                            {
                                                seq = "1".PadLeft(SequenceLen, '0');
                                            }
                                            else
                                            {
                                                #region //拆解BarcodeNo順序
                                                string thisSeq = "";
                                                if (thisBarcodePostfix != "")
                                                {
                                                    thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "").Replace(thisBarcodePostfix, "");
                                                }
                                                else
                                                {
                                                    thisSeq = MaxBarcodeNo.Replace(thisBarcodePrefix, "");
                                                }
                                                seq = (Convert.ToInt32(thisSeq) + 1).ToString().PadLeft(SequenceLen, '0');
                                                #endregion
                                            }

                                            NewBarcodeNo = thisBarcodePrefix + seq + thisBarcodePostfix;
                                        }
                                        #endregion

                                        return seq;
                                    }
                                    #endregion

                                    #region //INSERT MES.BarcodePrint
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodePrint (BarcodeNo, BarcodeQty, MoSettingId, ParentBarcode, PrintCnt, PrintStatus
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.BarcodeNo
                                            VALUES (@BarcodeNo, @BarcodeQty, @MoSettingId, @ParentBarcode, @PrintCnt, @PrintStatus
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeNo = ToBarcodeNo,
                                            BarcodeQty = 0,
                                            MoSettingId,
                                            ParentBarcode = "",
                                            PrintCnt = 0,
                                            PrintStatus = "P",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                    #endregion
                                }
                                else
                                {
                                    ToBarcodeNo = item.BarcodeNo;
                                }
                            }

                            #region //註冊TrayBarcode
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Tray SET
                                    BarcodeNo = @ToBarcodeNo,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE TrayId = @ToTrayId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ToBarcodeNo,
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    ToTrayId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                            #endregion
                        }

                        #endregion

                        #region //確認來源條碼狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeStatus
                                FROM MES.Barcode a
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);

                        var BarcodeStatusResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeStatusResult.Count() <= 0) throw new SystemException("來源條碼(" + FromBarcodeNo + ")資料錯誤!!");

                        foreach (var item in BarcodeStatusResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("來源條碼(" + FromBarcodeNo + ")目前狀態不可更改!!");
                        }
                        #endregion

                        #region //確認目標條碼狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeStatus
                                FROM MES.Barcode a
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", ToBarcodeNo);

                        var BarcodeStatusResult2 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in BarcodeStatusResult2)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("目標條碼(" + ToBarcodeNo + ")目前狀態不可更改!!");
                        }
                        #endregion

                        #region //判斷來源條碼是否被包裝條碼綁定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.[Status], b.PackageBarcodeNo
                                , c.BarcodeStatus
                                FROM MES.PackageBarcodeReference a 
                                INNER JOIN MES.PackageBarcode b ON a.PackageBarcodeId = b.PackageBarcodeId
                                INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                WHERE c.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);

                        var PackageBarcodeReferenceResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in PackageBarcodeReferenceResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("來源條碼(" + FromBarcodeNo + ")目前狀態不可更改!!");
                            if (item.Status != "3") throw new SystemException("來源條碼(" + FromBarcodeNo + ")目前被包裝條碼(" + item.PackageBarcodeNo + ")綁定，無法更改!!");
                        }
                        #endregion

                        #region //判斷目標條碼是否被包裝條碼綁定
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.[Status], b.PackageBarcodeNo
                                , c.BarcodeStatus
                                FROM MES.PackageBarcodeReference a 
                                INNER JOIN MES.PackageBarcode b ON a.PackageBarcodeId = b.PackageBarcodeId
                                INNER JOIN MES.Barcode c ON a.BarcodeId = c.BarcodeId
                                WHERE c.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", ToBarcodeNo);

                        PackageBarcodeReferenceResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in PackageBarcodeReferenceResult)
                        {
                            if (item.BarcodeStatus != "1" && item.BarcodeStatus != "0") throw new SystemException("目標條碼(" + ToBarcodeNo + ")目前狀態不可更改!!");
                            if (item.Status != "3") throw new SystemException("目標條碼(" + ToBarcodeNo + ")目前被包裝條碼(" + item.PackageBarcodeNo + ")綁定，無法更改!!");
                        }
                        #endregion

                        #region //將條碼轉成大寫
                        FromBarcodeNo = FromBarcodeNo.ToString().ToUpper();
                        ToBarcodeNo = ToBarcodeNo.ToString().ToUpper();
                        #endregion

                        #region //判斷來源條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId FromBarcodeId, a.BarcodeQty FromBarcodeQty, a.CurrentProdStatus, a.CurrentMoProcessId FromBarcodeMoProcessId, a.NextMoProcessId FromBarcodeNextMoProcessId, a.BarcodeStatus FromBarcodeStatus
                                , b.FinishDate, b.MachineId, b.ModeShiftId, NextMoProcessId
                                FROM MES.Barcode a
                                INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                WHERE a.BarcodeNo = @FromBarcodeNo
                                AND a.MoId = @MoId";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);
                        dynamicParameters.Add("MoId", MoId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("來源條碼資料錯誤!");

                        int FromBarcodeId = -1;
                        int FromBarcodeMoProcessId = -1;
                        int FromBarcodeNextMoProcessId = -1;
                        int MachineId = -1;
                        int ModeShiftId = -1;
                        int FromBarcodeQty = -1;
                        int NextMoProcessId = -1;
                        string FromBarcodeStatus = "";
                        foreach (var item in result2)
                        {
                            if (TransactionQty > item.FromBarcodeQty) throw new SystemException("拆併數量不能超過來源條碼數量(" + item.FromBarcodeQty + ")!");
                            if (TransactionQty == item.FromBarcodeQty) FromBarcodeQty = 0;
                            if (item.CurrentProdStatus != "P") throw new SystemException("來源條碼目前狀態非良品(P)!");
                            if (item.FinishDate == null) throw new SystemException("來源條碼目前尚在加工中!");
                            FromBarcodeId = item.FromBarcodeId;
                            FromBarcodeMoProcessId = item.FromBarcodeMoProcessId;
                            FromBarcodeNextMoProcessId = item.FromBarcodeNextMoProcessId;
                            MachineId = item.MachineId;
                            ModeShiftId = item.ModeShiftId;
                            NextMoProcessId = Convert.ToInt32(item.NextMoProcessId);
                            FromBarcodeStatus = item.FromBarcodeStatus;
                        }
                        #endregion

                        #region //判斷目標條碼資料是否正確
                        dynamicParameters = new DynamicParameters();

                        if (LotStatus == "Y" && Source == "BP")
                        {
                            sql = @"SELECT a.BarcodeQty BarcodePrintQty, a.PrintStatus
                                    , b.BarcodeId ToBarcodeId, b.MoId, b.CurrentProdStatus, b.CurrentMoProcessId ToBarcodeMoProcessId
                                    , c.FinishDate
                                    FROM MES.BarcodePrint a
                                    LEFT JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                    LEFT JOIN MES.BarcodeProcess c ON b.BarcodeId = c.BarcodeId AND b.CurrentMoProcessId = c.MoProcessId
                                    WHERE a.BarcodeNo = @ToBarcodeNo";
                            dynamicParameters.Add("ToBarcodeNo", ToBarcodeNo);
                        }
                        else
                        {
                            sql = @"SELECT a.BarcodeQty, a.BarcodeId ToBarcodeId, a.MoId, a.CurrentProdStatus, a.CurrentMoProcessId ToBarcodeMoProcessId
                                    , b.FinishDate
                                    FROM MES.Barcode a
                                    INNER JOIN MES.BarcodeProcess b ON a.BarcodeId = b.BarcodeId AND a.CurrentMoProcessId = b.MoProcessId
                                    WHERE a.BarcodeNo = @ToBarcodeNo";
                            dynamicParameters.Add("ToBarcodeNo", ToBarcodeNo);
                        }

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() <= 0) throw new SystemException("目標條碼資料錯誤!");

                        int ToBarcodeId = -1;
                        foreach (var item in result3)
                        {
                            if (item.ToBarcodeId == null)
                            {
                                if (item.PrintStatus != "P") throw new SystemException("目標條碼目前狀態非良品(P)!");
                                #region //INSERT BARCODE
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeId ToBarcodeId, INSERTED.BarcodeQty ToBarcodeQty
                                        VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = ToBarcodeNo,
                                        CurrentMoProcessId = FromBarcodeMoProcessId,
                                        NextMoProcessId = FromBarcodeNextMoProcessId,
                                        MoId,
                                        BarcodeQty = item.BarcodePrintQty,
                                        BarcodeProcessId = -1,
                                        CurrentProdStatus = "P",
                                        BarcodeStatus = FromBarcodeStatus,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult2.Count();

                                int ToBarcodeQty = -1;
                                foreach (var item2 in insertResult2)
                                {
                                    ToBarcodeId = item2.ToBarcodeId;
                                    ToBarcodeQty = item2.ToBarcodeQty;
                                }
                                #endregion

                                #region //先找出目前所有歷屆必要過站製程
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.MoProcessId
                                        FROM MES.MoProcess a 
                                        WHERE a.MoId = @MoId
                                        AND (
                                            a.SortNumber < (
                                                SELECT x.SortNumber FROM MES.MoProcess x 
                                            WHERE x.MoProcessId = @MoProcessId)
                                        )
                                        AND a.NecessityStatus = 'Y'";
                                dynamicParameters.Add("MoId", MoId);
                                dynamicParameters.Add("MoProcessId", FromBarcodeMoProcessId);

                                var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                #endregion

                                #region //補足過站歷程相關資料
                                DateTime CurrentCreateDate = CreateDate;
                                DateTime CurrentLastModifiedDate = LastModifiedDate;
                                foreach (var item2 in MoProcessResult)
                                {
                                    CurrentCreateDate = CurrentCreateDate.AddMinutes(-10);
                                    CurrentLastModifiedDate = CurrentLastModifiedDate.AddMinutes(-11);

                                    #region //取得來此製程班別及機台
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.MachineId, a.ModeShiftId
                                            FROM MES.BarcodeProcess a 
                                            WHERE MoProcessId = @MoProcessId";
                                    dynamicParameters.Add("MoProcessId", item2.MoProcessId);

                                    var NewBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                    int CurrentMachineId = -1;
                                    int CurrentModeShiftId = -1;
                                    foreach (var item3 in NewBarcodeProcessResult)
                                    {
                                        CurrentMachineId = item3.MachineId;
                                        CurrentModeShiftId = item3.ModeShiftId;
                                    }
                                    #endregion

                                    #region //INSERT MES.BarcodeProcess
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, StartDate
                                            , FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.BarcodeProcessId
                                            VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @StartDate
                                            , @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeId = ToBarcodeId,
                                            MoId,
                                            MachineId = CurrentMachineId,
                                            item2.MoProcessId,
                                            ProdStatus = "P",
                                            StationQty = 0,
                                            PassQty = 0,
                                            NgQty = 0,
                                            StartDate = CreateDate,
                                            FinishDate = CurrentLastModifiedDate,
                                            ModeShiftId = CurrentModeShiftId,
                                            CycleTime = 0,
                                            StartUserId = UserId,
                                            FinishUserId = UserId,
                                            CreateDate = CurrentCreateDate,
                                            LastModifiedDate = CurrentLastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult2.Count();

                                    int CurrentBarcodeProcessId = -1;
                                    foreach (var item3 in insertResult2)
                                    {
                                        CurrentBarcodeProcessId = item3.BarcodeProcessId;
                                    }
                                    #endregion
                                }
                                #endregion

                                #region //INSERT BarcodeProcess (目前站別)
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty
                                        , StartDate, FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BarcodeId ToBarcodeId
                                        VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty
                                        , @StartDate, @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeId = ToBarcodeId,
                                        MoId,
                                        MachineId,
                                        MoProcessId = FromBarcodeMoProcessId,
                                        ProdStatus = "P",
                                        StationQty = ToBarcodeQty,
                                        PassQty = ToBarcodeQty,
                                        NgQty = 0,
                                        StartDate = CreateDate,
                                        FinishDate = CreateDate,
                                        ModeShiftId,
                                        CycleTime = 0,
                                        StartUserId = CreateBy,
                                        FinishUserId = CreateBy,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult3.Count();
                                #endregion
                            }
                            else
                            {
                                if (item.CurrentProdStatus != "P") throw new SystemException("目標條碼目前狀態非良品(P)!");
                                if (item.FinishDate == null && item.BarcodePrintQty != 0) throw new SystemException("目標條碼目前非完工狀態!");
                                if (item.ToBarcodeMoProcessId != FromBarcodeMoProcessId) throw new SystemException("來源條碼與目標條碼製程不同!");
                                ToBarcodeId = item.ToBarcodeId;
                            }
                        }
                        #endregion

                        #region //更新來源條碼 Barcode & BarcodeProcess
                        if (FromBarcodeQty != 0 && NextMoProcessId != -1)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    NextMoProcessId = @NextMoProcessId,
                                    BarcodeQty = BarcodeQty - @TransactionQty,
                                    BarcodeStatus = @BarcodeStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @FromBarcodeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NextMoProcessId = FromBarcodeQty != 0 ? FromBarcodeNextMoProcessId : -1,
                                    TransactionQty,
                                    BarcodeStatus = FromBarcodeQty != 0 ? "1" : "0",
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    FromBarcodeId
                                });
                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE MES.Barcode SET
                                    BarcodeQty = BarcodeQty - @TransactionQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @FromBarcodeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    TransactionQty,
                                    LastModifiedDate,
                                    LastModifiedBy = UserId,
                                    FromBarcodeId
                                });
                        }

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeProcess SET
                                StationQty = StationQty - @TransactionQty,
                                PassQty = PassQty - @TransactionQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                FROM MES.BarcodeProcess a
                                WHERE a.BarcodeId = @FromBarcodeId
                                  AND a.MoProcessId = @FromBarcodeMoProcessId
                                  AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                        FROM MES.BarcodeProcess a1
                                                       WHERE a1.BarcodeId = a.BarcodeId
                                                         AND a1.MoProcessId = a.MoProcessId)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                FromBarcodeId,
                                FromBarcodeMoProcessId,
                                LastModifiedDate,
                                LastModifiedBy = UserId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //取得來源條碼BarcodeProcessId
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeProcessId
                                    FROM MES.BarcodeProcess a 
                                WHERE a.BarcodeId = @FromBarcodeId
                                  AND a.MoProcessId = @FromBarcodeMoProcessId
                                  AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                        FROM MES.BarcodeProcess a1
                                                       WHERE a1.BarcodeId = a.BarcodeId
                                                         AND a1.MoProcessId = a.MoProcessId)";
                        dynamicParameters.Add("FromBarcodeId", FromBarcodeId);
                        dynamicParameters.Add("FromBarcodeMoProcessId", FromBarcodeMoProcessId);

                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodeProcessResult.Count() <= 0) throw new SystemException("取得來源條碼過站歷程資料錯誤!!");

                        int FromBarcodeProcessId = -1;
                        foreach (var item in BarcodeProcessResult)
                        {
                            FromBarcodeProcessId = item.BarcodeProcessId;
                        }
                        #endregion

                        #region //取得目標條碼BarcodeProcessId
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeProcessId FROM MES.BarcodeProcess a 
                                WHERE a.BarcodeId = @ToBarcodeId
                                  AND a.MoProcessId = @ToBarcodeMoProcessId
                                  AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                        FROM MES.BarcodeProcess a1
                                                       WHERE a1.BarcodeId = a.BarcodeId
                                                         AND a1.MoProcessId = a.MoProcessId)";
                        dynamicParameters.Add("ToBarcodeId", ToBarcodeId);
                        dynamicParameters.Add("ToBarcodeMoProcessId", FromBarcodeMoProcessId);

                        var ToBarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ToBarcodeProcessResult.Count() <= 0) throw new SystemException("取得來源條碼過站歷程資料錯誤!!");

                        int ToBarcodeProcessId = -1;
                        foreach (var item in ToBarcodeProcessResult)
                        {
                            ToBarcodeProcessId = item.BarcodeProcessId;
                        }
                        #endregion

                        #region //更新目標條碼
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty + @TransactionQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @ToBarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                LastModifiedDate,
                                LastModifiedBy = UserId,
                                ToBarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.BarcodeProcess SET
                                StationQty = StationQty + @TransactionQty,
                                PassQty = PassQty + @TransactionQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                FROM MES.BarcodeProcess a
                                WHERE a.BarcodeId = @ToBarcodeId
                                  AND a.MoProcessId = @FromBarcodeMoProcessId
                                  AND a.CreateDate = (SELECT MAX(a1.CreateDate)
                                                        FROM MES.BarcodeProcess a1
                                                       WHERE a1.BarcodeId = a.BarcodeId
                                                         AND a1.MoProcessId = a.MoProcessId)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                ToBarcodeId,
                                FromBarcodeMoProcessId,
                                LastModifiedDate,
                                LastModifiedBy = UserId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //確認是否有鏡頭條碼註冊在來源條碼上
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.Barcode a 
                                INNER JOIN MES.Barcode b ON a.ParentBarcode = b.BarcodeId
                                WHERE b.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);
                        var MinBarcodesResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MinBarcodesResult.Count() > 0)
                        {
                            if (MinBarcodes.Length <= 0) throw new SystemException("此條碼有被鏡頭條碼註冊，需輸入鏡頭條碼來進行NG拆盤");

                            #region //更新鏡頭條碼ParentBarcode、狀態
                            List<string> minBarcodeIds = MinBarcodes.Split(',').ToList<string>();
                            foreach (var item in minBarcodeIds)
                            {
                                #region //先確認鏡頭條碼資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeNo, a.BarcodeQty, a.BarcodeStatus, a.CurrentProdStatus, a.CurrentMoProcessId, a.ParentBarcode
                                        FROM MES.Barcode a 
                                        WHERE BarcodeId = @BarcodeId";
                                dynamicParameters.Add("BarcodeId", item);

                                var MinBarcodesResult2 = sqlConnection.Query(sql, dynamicParameters);

                                if (MinBarcodesResult2.Count() <= 0) throw new SystemException("鏡頭條碼【" + item + "】資料錯誤!!");

                                string minBarcodeNo = "";
                                foreach (var item2 in MinBarcodesResult2)
                                {
                                    if (item2.BarcodeStatus != "1" && item2.BarcodeStatus != "0") throw new SystemException("鏡頭條碼【" + item + "】狀態錯誤!!");
                                    if (item2.CurrentProdStatus != "P") throw new SystemException("鏡頭條碼【" + item + "】目前狀態非良品!!");
                                    //if (item2.CurrentMoProcessId != FromBarcodeMoProcessId) throw new SystemException("鏡頭條碼【" + item + "】製程錯誤!!");
                                    if (item2.ParentBarcode != FromBarcodeId) throw new SystemException("鏡頭條碼【" + item + "】與主條碼註冊資料錯誤!!");
                                    minBarcodeNo = item2.BarcodeNo;
                                }
                                #endregion

                                #region //Update MinBarcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                        ParentBarcode = @ToBarcodeId,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ToBarcodeId,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeNo = minBarcodeNo
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion
                        }
                        #endregion

                        #region //INSERT BarcodeTransfer
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeTransfer (FromBarcodeProcessId, ToBarcodeProcessId, TransactionDate, FromBarcodeId, ToBarcodeId, TransactionQty
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@FromBarcodeProcessId, @ToBarcodeProcessId, @TransactionDate, @FromBarcodeId, @ToBarcodeId, @TransactionQty
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FromBarcodeProcessId,
                                ToBarcodeProcessId,
                                TransactionDate = CreateDate,
                                FromBarcodeId,
                                ToBarcodeId,
                                TransactionQty,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy = UserId,
                                LastModifiedBy = UserId
                            });

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();
                        #endregion

                        #region //檢核更新後數量是否正確

                        #region //確認此條碼是否為BarcodePrint
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM MES.BarcodePrint a
                                WHERE BarcodeNo = @FromBarcodeNo";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);

                        var BarcodePrintResult = sqlConnection.Query(sql, dynamicParameters);

                        if (BarcodePrintResult.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT BarcodeQty 
                                      FROM MES.Barcode
                                     WHERE BarcodeId in(@FromBarcodeId,@ToBarcodeId)
                                       AND (BarcodeQty < 0 or BarcodeQty > @LotQty) ";
                            dynamicParameters.Add("FromBarcodeId", FromBarcodeId);
                            dynamicParameters.Add("ToBarcodeId", ToBarcodeId);
                            dynamicParameters.Add("LotQty", LotQty);

                            var QtyResult = sqlConnection.Query(sql, dynamicParameters);
                            if (QtyResult.Count() > 0) throw new SystemException("合併前後條碼超出批量數量!");
                        }
                        #endregion

                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBarcodeComponentByArm-- 手臂上料 -- GPai 20250106
        public string AddBarcodeComponentByArm(string Company, string UserNo, string BarcodeNo, string ComponentNo, int MoProcessId,  string ComponentMtlitemNo)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【主條碼】不能為空!");
                if (ComponentNo.Length <= 0) throw new SystemException("【物料條碼】不能為空!");
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb, a.CompanyId
                                FROM BAS.Company a
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        #region //取得User資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId
                                    FROM BAS.[User]
                                    WHERE UserNo = @UserNo";
                        dynamicParameters.Add("UserNo", UserNo);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        if (UserResult.Count() <= 0) throw new SystemException("使用者資料錯誤!!");

                        int UserId = -1;
                        foreach (var item in UserResult)
                        {
                            UserId = item.UserId;
                        }
                        #endregion
                        
                        #region //判斷主條碼資訊是否正確
                        //若條碼來源為BP, 判斷在BarcodePrint, 否則判斷在MrDetail MainBarcode = 'Y'
                        dynamicParameters = new DynamicParameters();

                        sql = @"SELECT b.Source, a.MoId
                                  FROM MES.MoProcess a
                                       INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                 WHERE a.MoProcessId = @MoProcessId ";

                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var MtlSettingResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlSettingResult.Count() <= 0) throw new SystemException("找不到製令用料設定!");
                        string Source = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Source;
                        int MoId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoId;

                        #region //確認是否為Tray模式
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TrayBarcode, a.Source
                                    FROM MES.MoSetting a
                                    WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                        string TrayBarcode = "";
                        foreach (var item2 in MoSettingResult)
                        {
                            TrayBarcode = item2.TrayBarcode;
                        }

                        string TrayNo = "";
                        if (TrayBarcode == "Y" && Source == "BP")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayNo, ISNULL(a.BarcodeNo, '') BarcodeNo
                                        FROM MES.Tray a
                                        WHERE a.TrayNo = @TrayNo";
                            dynamicParameters.Add("TrayNo", BarcodeNo);

                            var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TrayResult.Count() <= 0) throw new SystemException("查無此條碼(" + BarcodeNo + ")綁定的Tray盤資訊!");

                            foreach (var item2 in TrayResult)
                            {
                                TrayNo = item2.TrayNo;
                                BarcodeNo = item2.BarcodeNo;
                            }
                        }
                        #endregion


                        if (Source.Equals("BP"))
                        {
                            sql = @"SELECT a.BarcodeId AssemblyBarcodeId, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeQty
                                    , 'Y' MainBarcode
                                    FROM MES.Barcode a
                                    INNER JOIN MES.BarcodeProcess b ON a.CurrentMoProcessId = b.MoProcessId AND a.BarcodeId = b.BarcodeId
                                    INNER JOIN MES.BarcodePrint c ON a.BarcodeNo = c.BarcodeNo
                                    WHERE a.BarcodeNo = @BarcodeNo AND b.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        }
                        else
                        {
                            sql = @"SELECT a.BarcodeId AssemblyBarcodeId, a.CurrentMoProcessId, a.NextMoProcessId, a.BarcodeQty
                                    , e.MainBarcode
                                    FROM MES.Barcode a
                                    INNER JOIN MES.MrBarcodeRegister b ON a.BarcodeNo = b.BarcodeNo
                                    INNER JOIN MES.MrDetail c ON b.MrDetailId = c.MrDetailId
                                    INNER JOIN MES.WoDetail d ON c.MtlItemId = d.MtlItemId
                                    INNER JOIN MES.MoMtlSetting e ON d.WoDetailId = e.WoDetailId AND e.MoId = a.MoId
                                    INNER JOIN MES.BarcodeProcess f ON a.BarcodeId = f.BarcodeId AND a.CurrentMoProcessId = f.MoProcessId
                                    WHERE a.BarcodeNo = @BarcodeNo AND f.FinishDate IS NULL";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);
                        }

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("主條碼資料錯誤!");

                        int AssemblyBarcodeId = -1;
                        int CurrentMoProcessId = -1;
                        int NextMoProcessId = -1;
                        int BarcodeQty = -1;
                        foreach (var item in result)
                        {
                            if (item.MainBarcode != "Y") throw new SystemException("此條碼非主條碼!");

                            AssemblyBarcodeId = item.AssemblyBarcodeId;
                            CurrentMoProcessId = item.CurrentMoProcessId;
                            NextMoProcessId = item.NextMoProcessId;
                            BarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //判斷料品上料類型
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BindType 
                                       , c.MtlItemId, c.MtlItemNo, c.MtlItemName
                                       , a.MoProcessId
                                       FROM MES.MoMtlSetting a
                                       INNER JOIN MES.WoDetail b ON a.WoDetailId = b.WoDetailId
                                       INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                       WHERE a.MoId = @MoId
                                       AND a.ProcessBinding = 'Y'
                                       AND a.MoProcessId = @MoProcessId
                                       AND a.MainBarcode != 'Y'
							           AND c.MtlItemNo = @MtlItemNo";
                        dynamicParameters.Add("MoId", MoId);
                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        dynamicParameters.Add("MtlItemNo", ComponentMtlitemNo);
                        var ComponentTypeResult = sqlConnection.Query(sql, dynamicParameters);
                        var bindtype = "";
                        if (ComponentTypeResult.Count() > 0)
                        {
                            bindtype = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).BindType;

                        }
                        else
                        {
                            throw new SystemException("該品號查無上料資訊，請確認製令或品號相關設定! "+ ComponentMtlitemNo);
                        }
                        #endregion
                        int rowsAffected = 0;
                        if (bindtype == "B")
                        {
                            #region //判斷綁定條碼資訊是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT c.MainBarcode
                                , e.BarcodeId, e.BarcodeStatus
                                FROM MES.MrBarcodeRegister a
                                INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                INNER JOIN MES.MoMtlSetting c ON b.MoId = c.MoId
                                INNER JOIN MES.WoDetail d ON c.WoDetailId = d.WoDetailId AND d.MtlItemId = b.MtlItemId
                                INNER JOIN MES.Barcode e ON a.BarcodeNo = e.BarcodeNo AND e.MoId = @MoId
                                WHERE e.BarcodeNo = @BarcodeNo
                                AND b.MoId = @MoId";
                            dynamicParameters.Add("BarcodeNo", ComponentNo);
                            dynamicParameters.Add("MoId", MoId);

                            var ComponentBarcodeResult2 = sqlConnection.Query(sql, dynamicParameters);
                            if (ComponentBarcodeResult2.Count() <= 0) throw new SystemException("綁定條碼資料錯誤!");


                            Boolean newBarcode = false;
                            int ComponentBarcodeId = -1;
                            foreach (var item in ComponentBarcodeResult2)
                            {
                                if (item.MainBarcode != "N") throw new SystemException("此條碼為主條碼，無法用於綁定上料!");

                                if (item.BarcodeId == null) newBarcode = true;
                                else
                                {
                                    if (item.BarcodeStatus != "3") throw new SystemException("此條碼狀態無法進行上料綁定!");
                                    ComponentBarcodeId = item.BarcodeId;
                                }
                            }
                            #endregion

                            #region //判斷主條碼與綁定條碼關係是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT d.MoProcessId BindMoProcessId
                                , e.ProcessAlias
                                FROM MES.MrBarcodeRegister a
                                INNER JOIN MES.MrDetail b ON a.MrDetailId = b.MrDetailId
                                INNER JOIN MES.WoDetail c ON b.MtlItemId = c.MtlItemId
                                INNER JOIN MES.MoMtlSetting d ON c.WoDetailId = d.WoDetailId AND d.MoId = b.MoId
                                INNER JOIN MES.MoProcess e ON d.MoId = e.MoId
                                WHERE a.BarcodeNo = @BarcodeNo
                                AND b.MoId = @MoId";
                            dynamicParameters.Add("BarcodeNo", ComponentNo);
                            dynamicParameters.Add("MoId", MoId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);
                            if (result4.Count() <= 0) throw new SystemException("此條碼不能與主條碼【" + BarcodeNo + "】進行綁定!");

                            foreach (var item in result4)
                            {
                                if (item.BindMoProcessId != MoProcessId) throw new SystemException("請於【" + item.ProcessAlias + "】進行上料綁定!!");
                            }
                            #endregion


                            if (newBarcode == true)
                            {
                                //新增Barcode 與主條碼內容相同
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId
                                    , CurrentProdStatus, BarcodeStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BarcodeId
                                    VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId
                                    , @CurrentProdStatus, @BarcodeStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = ComponentNo,
                                        CurrentMoProcessId = -1,
                                        NextMoProcessId = -1,
                                        MoId,
                                        BarcodeQty,
                                        BarcodeProcessId = -1,
                                        CurrentProdStatus = "P",
                                        BarcodeStatus = "1", //定義一個Status = "投入產品生產中"
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();

                                foreach (var item in insertResult)
                                {
                                    ComponentBarcodeId = item.BarcodeId;
                                }
                            }
                            else
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                    CurrentMoProcessId = @CurrentMoProcessId,
                                    NextMoProcessId = @NextMoProcessId,
                                    BarcodeStatus = '4',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeNo = @BarcodeNo";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        CurrentMoProcessId,
                                        NextMoProcessId,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        BarcodeNo = ComponentNo
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            }

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeComponent (AssemblyBarcodeId, ComponentBarcodeId, MoProcessId
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeComponentId
                                VALUES (@AssemblyBarcodeId, @ComponentBarcodeId, @MoProcessId
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    AssemblyBarcodeId,
                                    ComponentBarcodeId,
                                    MoProcessId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult2.Count();
                        }
                        else if (bindtype == "L")
                        {
                            #region //確認批號資料是否正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.LotNumberId 
                                , c.MoProcessId BindMoProcessId
                                , e.ProcessAlias
                                FROM SCM.LotNumber a 
                                INNER JOIN MES.MrDetail b ON a.LotNumberNo = b.LotNumber AND a.MtlItemId = b.MtlItemId
                                INNER JOIN MES.MoMtlSetting c ON c.MoId = b.MoId
                                INNER JOIN MES.WoDetail d ON c.WoDetailId = d.WoDetailId AND d.MtlItemId = b.MtlItemId
                                INNER JOIN MES.MoProcess e ON c.MoProcessId = e.MoProcessId
                                INNER JOIN PDM.MtlItem f ON b.MtlItemId = f.MtlItemId
                                WHERE a.LotNumberNo = @LotNumber
                                AND b.MoId = @MoId
                                AND f.MtlItemNo = @ComponentMtlitemNo";
                            dynamicParameters.Add("LotNumber", ComponentNo);
                            dynamicParameters.Add("MoId", MoId);
                            dynamicParameters.Add("ComponentMtlitemNo", ComponentMtlitemNo);

                            var LotNumberResult = sqlConnection.Query(sql, dynamicParameters);

                            if (LotNumberResult.Count() <= 0) throw new SystemException("【批號】資料錯誤!!");

                            int LotNumberId = -1;
                            foreach (var item in LotNumberResult)
                            {
                                if (item.BindMoProcessId != MoProcessId) throw new SystemException("請於【" + item.ProcessAlias + "】進行上料綁定!!");
                                LotNumberId = item.LotNumberId;
                            }
                            #endregion

                            #region //確認此批號沒有被同一個主件綁定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.ProcessAlias
                                , d.WoErpPrefix + '-' + d.WoErpNo WoErpFullNo
                                FROM MES.BarcodeComponent a 
                                INNER JOIN MES.MoProcess b ON a.MoProcessId = b.MoProcessId
                                INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
                                INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                WHERE a.AssemblyBarcodeId = @AssemblyBarcodeId
                                AND a.LotNumberId = @LotNumberId
AND c.MoId = @MoId";
                            dynamicParameters.Add("AssemblyBarcodeId", AssemblyBarcodeId);
                            dynamicParameters.Add("LotNumberId", LotNumberId);
                            dynamicParameters.Add("MoId", MoId);


                            var BarcodeComponentResult = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in BarcodeComponentResult)
                            {
                                throw new SystemException("此批號已被相同主料重複綁定!!<br>製令:【" + item.WoErpFullNo + "】<br>製程:【" + item.ProcessAlias + "】");
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO MES.BarcodeComponent (AssemblyBarcodeId, LotNumberId, MoProcessId
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BarcodeComponentId
                                VALUES (@AssemblyBarcodeId, @LotNumberId, @MoProcessId
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    AssemblyBarcodeId,
                                    LotNumberId,
                                    MoProcessId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy = UserId,
                                    LastModifiedBy = UserId
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += insertResult.Count();


                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region BarcodeMergeByArm //自動手臂拆併盤 --GPAI 20250224
        public string BarcodeMergeByArm(string Company, string UserNo, int MoProcessId, string BarcodeNo, string OKTrayNo, string MTFBTrayNo, int MergeQty)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【主條碼】不能為空!");
                if (MergeQty <= 0) throw new SystemException("拆併數為0");
                if (OKTrayNo.Length <= 0 && MTFBTrayNo.Length <= 0) throw new SystemException("請輸入併盤條碼!");
                if (OKTrayNo.Length > 0 && MTFBTrayNo.Length > 0) throw new SystemException("併盤條碼請擇一填入!");

                int rowsAffected = 0;
                string TrayNo = "";

                string OKBarcode = "";
                string MTFBBarcode = "";
                int fromQty = 0;
                int FromBarcodeProcessId = 0;
                int ToBarcodeProcessId = 0;


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb, a.CompanyId
                                FROM BAS.Company a
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", Company);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            CurrentCompany = item.CompanyId;
                        }
                        #endregion

                        #region //取得User資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UserId
                                    FROM BAS.[User]
                                    WHERE UserNo = @UserNo";
                        dynamicParameters.Add("UserNo", UserNo);

                        var UserResult = sqlConnection.Query(sql, dynamicParameters);

                        if (UserResult.Count() <= 0) throw new SystemException("使用者資料錯誤!!");

                        int UserId = -1;
                        foreach (var item in UserResult)
                        {
                            UserId = item.UserId;
                        }
                        #endregion

                        #region //判斷主條碼資訊是否正確
                        //若條碼來源為BP, 判斷在BarcodePrint, 否則判斷在MrDetail MainBarcode = 'Y'
                        dynamicParameters = new DynamicParameters();

                        sql = @"SELECT b.Source, a.MoId
                                  FROM MES.MoProcess a
                                       INNER JOIN MES.MoSetting b ON a.MoId = b.MoId
                                 WHERE a.MoProcessId = @MoProcessId ";

                        dynamicParameters.Add("MoProcessId", MoProcessId);
                        var MtlSettingResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlSettingResult.Count() <= 0) throw new SystemException("找不到製令用料設定!");
                        string Source = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).Source;
                        int MoId = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).MoId;

                        #region //確認是否為Tray模式
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TrayBarcode, a.Source
                                    FROM MES.MoSetting a
                                    WHERE MoId = @MoId";
                        dynamicParameters.Add("MoId", MoId);

                        var MoSettingResult = sqlConnection.Query(sql, dynamicParameters);

                        string TrayBarcode = "";
                        foreach (var item2 in MoSettingResult)
                        {
                            TrayBarcode = item2.TrayBarcode;
                        }

                        if (TrayBarcode == "Y" && Source == "BP")
                        {
                            int ToMoId = -1;
                            int ToBarcodeId = -1;
                            int ToMtlItemId = -1;
                            int ToBarcodeQty = 0;
                            int FromBarcodeId = -1;
                            int FromTrayId = -1;
                            int oldTrayBarcodeLogId = -1;
                            #region 拆盤條碼
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.TrayNo, ISNULL(a.BarcodeNo, '') BarcodeNo, ISNULL(b.BarcodeId, -1) BarcodeId, b.BarcodeQty, a.TrayId
                                        FROM MES.Tray a
										INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                        WHERE a.TrayNo = @TrayNo";
                            dynamicParameters.Add("TrayNo", BarcodeNo);

                            var TrayResult = sqlConnection.Query(sql, dynamicParameters);

                            if (TrayResult.Count() <= 0) throw new SystemException("查無此條碼(" + BarcodeNo + ")綁定的Tray盤資訊!");

                            foreach (var item3 in TrayResult)
                            {
                                TrayNo = item3.TrayNo;
                                BarcodeNo = item3.BarcodeNo;
                                FromBarcodeId = item3.BarcodeId;
                                fromQty = item3.BarcodeQty;
                                FromTrayId = item3.TrayId;
                                if (fromQty < MergeQty) throw new SystemException("拆併數大於來源條碼數量!! " + fromQty);
                            }

                            #region //確認來源條碼無被其他條碼註冊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1 
                                    FROM MES.Barcode a 
                                    INNER JOIN MES.Barcode b ON a.ParentBarcode = b.BarcodeId
                                    WHERE b.BarcodeNo = @FromBarcodeNo";
                            dynamicParameters.Add("FromBarcodeNo", BarcodeNo);

                            var ParentBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (ParentBarcodeResult.Any()) throw new SystemException("此【來源條碼】已被其他條碼註冊! " + BarcodeNo);
                            #endregion

                            #region //確認來源條碼無被其他條碼註冊
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1 
                                    FROM MES.Barcode a 
                                    INNER JOIN MES.Barcode b ON a.PrevBarcodeId = b.BarcodeId
                                    WHERE b.BarcodeNo = @FromBarcodeNo";
                            dynamicParameters.Add("FromBarcodeNo", BarcodeNo);

                            var PrevBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            if (PrevBarcodeResult.Any()) throw new SystemException("此【來源條碼】為包裝條碼! " + BarcodeNo);
                            #endregion
                            #endregion

                            if (OKTrayNo != "") {

                                #region //最新周轉TrayLog紀錄
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 TrayBarcodeLogId
                                FROM MES.TrayBarcodeLog
                                WHERE TrayId = @TrayId
                                AND BarcodeNo = @BarcodeNo
                                AND ReMoveBindDate is null";

                                dynamicParameters.Add("TrayId", FromTrayId);
                                dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                                var result4 = sqlConnection.Query(sql, dynamicParameters);
                                foreach (var item in result4)
                                {

                                    oldTrayBarcodeLogId = item.TrayBarcodeLogId;

                                }

                                #endregion

                                #region //Tray盤綁定條碼列表
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.TrayLocation, b.UserNo, b.UserName, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm:ss') CreateDate  
                            from MES.Barcode a
                            INNER JOIN BAS.[User] b ON a.LastModifiedBy = b.UserId
                            where ParentBarcode = @ParentBarcode";

                                dynamicParameters.Add("ParentBarcode", FromBarcodeId);

                                //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                                var result2 = sqlConnection.Query(sql, dynamicParameters);
                                //if (result2.Count() <= 0) throw new SystemException("周轉Tray盤需有綁定鏡頭條碼");

                                #endregion

                                #region // 找新Tray資料
                                int newTrayId = -1;

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT *
                            FROM MES.Tray a
                            WHERE a.TrayNo = @TrayNo and a.CompanyId = @CompanyId";

                                dynamicParameters.Add("TrayNo", OKTrayNo);
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MoId", @" AND a.MoId = @MoId", MoId);

                                var result3 = sqlConnection.Query(sql, dynamicParameters);
                                if (result3.Count() <= 0) throw new SystemException("查無新Tray盤資訊");

                                foreach (var item in result3)
                                {

                                    if (item.BarcodeNo != null) throw new SystemException("該新Tray盤有綁定條碼!");

                                    newTrayId = item.TrayId;

                                }
                                #endregion

                                #region //UPDATE

                                #region //更新 Tray 解除綁定 BarcodeNo
                                string nullstring = null;

                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Tray
                                SET 
                                BarcodeNo = @BarcodeNo,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE TrayId = @TrayId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = nullstring,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        TrayId = FromTrayId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //更新 TrayBarcodeLog ParentBarcode
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.TrayBarcodeLog
                                SET 
                                ReMoveBindDate = @LastModifiedDate,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE TrayBarcodeLogId = @TrayBarcodeLogId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ReMoveBindDate = LastModifiedDate,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        TrayBarcodeLogId = oldTrayBarcodeLogId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion


                                #region //更新 Tray 綁定 BarcodeNo
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Tray
                                SET 
                                BarcodeNo = @BarcodeNo,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE TrayId = @TrayId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BarcodeNo = BarcodeNo,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        TrayId = newTrayId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //新增新盤 TrayBarcodeLog 
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.TrayBarcodeLog(TrayId,BarcodeNo,BindDate
                                    ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                    VALUES(@TrayId,@BarcodeNo,@BindDate
                                    ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        TrayId = newTrayId,
                                        BarcodeNo = BarcodeNo,
                                        BindDate = DateTime.Now,
                                        CreateDate = DateTime.Now,
                                        LastModifiedDate = DateTime.Now,
                                        CreateBy,
                                        LastModifiedBy = CreateBy
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                                #endregion


                            }
                            else if (MTFBTrayNo != "") {
                                #region 併盤條碼(MTFBTrayNo
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.TrayNo, ISNULL(a.BarcodeNo, '') BarcodeNo, ISNULL(b.BarcodeId, -1) BarcodeId
                                        FROM MES.Tray a
										INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                        WHERE a.TrayNo = @TrayNo";
                                dynamicParameters.Add("TrayNo", MTFBTrayNo);

                                var MTFBTrayNoResult = sqlConnection.Query(sql, dynamicParameters);

                                if (MTFBTrayNoResult.Count() <= 0)
                                {

                                    #region 自動新增空條碼並綁定Tray
                                    if (TrayBarcode == "Y")
                                    {
                                        #region //判斷新Tray盤資料是否正確
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.BarcodeNo
                                    FROM MES.Tray a
                                    WHERE a.TrayNo = @NewTrayBarcode";
                                        dynamicParameters.Add("NewTrayBarcode", OKTrayNo);

                                        var NewTrayResult = sqlConnection.Query(sql, dynamicParameters);

                                        if (NewTrayResult.Count() <= 0) throw new SystemException("查無此Tray盤【" + OKTrayNo + "】資料!!");

                                        foreach (var item in NewTrayResult)
                                        {
                                            if (item.BarcodeNo != null) throw new SystemException("此Tray盤【" + OKTrayNo + "】已被其他條碼綁定!!");
                                        }
                                        #endregion

                                        #region //判斷TrayBarcode
                                        //dynamicParameters = new DynamicParameters();
                                        //sql = @"SELECT a.BarcodeNo
                                        //FROM MES.Tray a
                                        //WHERE a.TrayNo = @FromBarcodeNo";
                                        //dynamicParameters.Add("FromBarcodeNo", OKTrayNo);

                                        //var TrayResult2 = sqlConnection.Query(sql, dynamicParameters);

                                        //if (TrayResult.Count() <= 0) throw new SystemException("查無此Tray盤【" + OKTrayNo + "】資料!!");

                                        //foreach (var item in TrayResult)
                                        //{
                                        //    //FromBarcodeNo = item.BarcodeNo;
                                        //}
                                        #endregion
                                    }

                                    #region //判斷來源條碼資料是否正確
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.CurrentMoProcessId, a.NextMoProcessId, a.MoId, a.BarcodeProcessId, a.CurrentProdStatus, a.BarcodeStatus
                                            , d.MtlItemNo
                                            , e.MoSettingId
                                            , f.FinishDate, f.MachineId, f.ModeShiftId
                                            FROM MES.Barcode a
                                            INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                            INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                            INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                            INNER JOIN MES.MoSetting e ON a.MoId = e.MoId
                                            INNER JOIN MES.BarcodeProcess f ON a.BarcodeId = f.BarcodeId AND a.CurrentMoProcessId = f.MoProcessId
                                            WHERE a.BarcodeNo = @BarcodeNo";
                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                    var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (BarcodeResult.Count() <= 0) throw new SystemException("來源條碼資料錯誤!");

                                    int CurrentMoProcessId = -1;
                                    int NextMoProcessId = -1;
                                    int BarcodeProcessId = -1;
                                    string CurrentProdStatus = "";
                                    string BarcodeStatus = "";
                                    string MtlItemNo = "";
                                    int MoSettingId = -1;
                                    int MachineId = -1;
                                    int ModeShiftId = -1;
                                    foreach (var item in BarcodeResult)
                                    {
                                        if (item.CurrentProdStatus != "P") throw new SystemException("來源條碼狀態無法併盤!!");
                                        if (item.FinishDate == null) throw new SystemException("來源條碼目前尚在加工中!");
                                        CurrentMoProcessId = item.CurrentMoProcessId;
                                        NextMoProcessId = item.NextMoProcessId;
                                        MoId = item.MoId;
                                        BarcodeProcessId = item.BarcodeProcessId;
                                        CurrentProdStatus = item.CurrentProdStatus;
                                        BarcodeStatus = item.BarcodeStatus;
                                        MtlItemNo = item.MtlItemNo;
                                        MtlItemNo = MtlItemNo.ToUpper();
                                        MoSettingId = item.MoSettingId;
                                        MachineId = item.MachineId;
                                        ModeShiftId = item.ModeShiftId;
                                        FromBarcodeProcessId = item.CurrentMoProcessId;
                                    }
                                    #endregion

                                    #region //找此BARCODE格式最大號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(BarcodeNo))), '000'), 3)) + 1 CurrentNum
                                            FROM MES.Barcode
                                            WHERE BarcodeNo LIKE '%" + MoId + "%'";
                                    dynamicParameters.Add("MoId", MoId);

                                    var BarcodeCountResult = sqlConnection.Query(sql, dynamicParameters);

                                    int CurrentNum = 0;
                                    foreach (var item in BarcodeCountResult)
                                    {
                                        CurrentNum = item.CurrentNum;
                                    }

                                    string seq = CurrentNum.ToString().PadLeft(3, '0');
                                    string NewBarcodeNo = (MoId + "-" + seq).ToUpper();
                                    #endregion

                                    #region //INSERT MES.BarcodePrint
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.BarcodePrint (BarcodeNo, BarcodeQty, MoSettingId, ParentBarcode, PrintCnt, PrintStatus
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.BarcodeNo
                                            VALUES (@BarcodeNo, @BarcodeQty, @MoSettingId, @ParentBarcode, @PrintCnt, @PrintStatus
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeNo = NewBarcodeNo,
                                            BarcodeQty = 0,
                                            MoSettingId,
                                            ParentBarcode = "",
                                            PrintCnt = 0,
                                            PrintStatus = "P",
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    string NewOutputBarcodeNo = "";
                                    foreach (var item in insertResult)
                                    {
                                        NewOutputBarcodeNo = item.BarcodeNo;
                                    }

                                    rowsAffected += insertResult.Count();
                                    #endregion

                                    #region //INSERT MES.Barcode
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, MoId, BarcodeQty, BarcodeProcessId, CurrentProdStatus, BarcodeStatus
                                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            OUTPUT INSERTED.BarcodeNo, INSERTED.BarcodeId
                                            VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @MoId, @BarcodeQty, @BarcodeProcessId, @CurrentProdStatus, @BarcodeStatus
                                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            BarcodeNo = NewBarcodeNo,
                                            CurrentMoProcessId,
                                            NextMoProcessId,
                                            MoId,
                                            BarcodeQty = 0,
                                            BarcodeProcessId,
                                            CurrentProdStatus,
                                            BarcodeStatus,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy = UserId,
                                            LastModifiedBy = UserId
                                        });

                                    insertResult = sqlConnection.Query(sql, dynamicParameters);

                                    rowsAffected += insertResult.Count();

                                    int BarcodeId = -1;
                                    foreach (var item in insertResult)
                                    {
                                        BarcodeId = item.BarcodeId;
                                        MTFBBarcode = item.BarcodeNo;
                                    }
                                    #endregion

                                    #region //先找出目前所有歷屆必要過站製程(含目前製程)
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.MoProcessId
                                             FROM MES.MoProcess a 
                                             WHERE a.MoId = @MoId
                                             AND (
                                                 a.SortNumber < (
                                                     SELECT x.SortNumber FROM MES.MoProcess x 
                                                 WHERE x.MoProcessId = @MoProcessId)
                                                 OR a.SortNumber = (
                                                     SELECT x.SortNumber FROM MES.MoProcess x 
                                                 WHERE x.MoProcessId = @MoProcessId)
                                             )";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("MoProcessId", CurrentMoProcessId);

                                    var MoProcessResult = sqlConnection.Query(sql, dynamicParameters);
                                    #endregion

                                    #region //補足過站歷程相關資料
                                    DateTime CurrentCreateDate = CreateDate;
                                    DateTime CurrentLastModifiedDate = LastModifiedDate;
                                    foreach (var item in MoProcessResult)
                                    {
                                        CurrentCreateDate = CurrentCreateDate.AddMinutes(10);
                                        CurrentLastModifiedDate = CurrentLastModifiedDate.AddMinutes(11);

                                        #region //取得來此製程班別及機台
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 a.MachineId, a.ModeShiftId
                                                FROM MES.BarcodeProcess a 
                                                WHERE MoProcessId = @MoProcessId";
                                        dynamicParameters.Add("MoProcessId", item.MoProcessId);

                                        var BarcodeProcessResult = sqlConnection.Query(sql, dynamicParameters);

                                        int CurrentMachineId = -1;
                                        int CurrentModeShiftId = -1;
                                        foreach (var item2 in BarcodeProcessResult)
                                        {
                                            CurrentMachineId = item2.MachineId;
                                            CurrentModeShiftId = item2.ModeShiftId;
                                        }
                                        #endregion

                                        #region //INSERT MES.BarcodeProcess
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.BarcodeProcess (BarcodeId, MoId, MachineId, MoProcessId, ProdStatus, StationQty, PassQty, NgQty, StartDate
                                                , FinishDate, ModeShiftId, CycleTime, StartUserId, FinishUserId
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.BarcodeProcessId
                                                VALUES (@BarcodeId, @MoId, @MachineId, @MoProcessId, @ProdStatus, @StationQty, @PassQty, @NgQty, @StartDate
                                                , @FinishDate, @ModeShiftId, @CycleTime, @StartUserId, @FinishUserId
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BarcodeId,
                                                MoId,
                                                MachineId = CurrentMachineId,
                                                item.MoProcessId,
                                                ProdStatus = "P",
                                                StationQty = MergeQty,
                                                PassQty = MergeQty,
                                                NgQty = 0,
                                                StartDate = CreateDate,
                                                FinishDate = CurrentLastModifiedDate,
                                                ModeShiftId = CurrentModeShiftId,
                                                CycleTime = 0,
                                                StartUserId = UserId,
                                                FinishUserId = UserId,
                                                CreateDate = CurrentCreateDate,
                                                LastModifiedDate = CurrentLastModifiedDate,
                                                CreateBy = UserId,
                                                LastModifiedBy = UserId
                                            });

                                        var insertResult2 = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();

                                        int CurrentBarcodeProcessId = -1;
                                        foreach (var item2 in insertResult2)
                                        {
                                            CurrentBarcodeProcessId = item2.BarcodeProcessId;
                                            ToBarcodeProcessId = item2.BarcodeProcessId;

                                        }
                                        #endregion

                                        #region //補足BarcodeProcessAttribute資料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT a.ItemNo, a.ItemValue, a.ItemSeq
                                                FROM MES.BarcodeProcessAttribute a 
                                                INNER JOIN MES.BarcodeProcess b ON a.BarcodeProcessId = b.BarcodeProcessId
                                                INNER JOIN MES.Barcode c ON b.BarcodeId = c.BarcodeId
                                                WHERE c.BarcodeNo = @BarcodeNo
                                                AND b.MoProcessId = @MoProcessId";
                                        dynamicParameters.Add("BarcodeNo", BarcodeNo);
                                        dynamicParameters.Add("MoProcessId", item.MoProcessId);

                                        var BarcodeProcessAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                        foreach (var item2 in BarcodeProcessAttributeResult)
                                        {
                                            #region //INSERT MES.BarcodeProcessAttribute
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"INSERT INTO MES.BarcodeProcessAttribute (BarcodeProcessId, ItemNo, ItemValue, ItemSeq
                                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                    OUTPUT INSERTED.BarcodeProcessId
                                                    VALUES (@BarcodeProcessId, @ItemNo, @ItemValue, @ItemSeq
                                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                            dynamicParameters.AddDynamicParams(
                                                new
                                                {
                                                    BarcodeProcessId = CurrentBarcodeProcessId,
                                                    item2.ItemNo,
                                                    item2.ItemValue,
                                                    item2.ItemSeq,
                                                    CreateDate,
                                                    LastModifiedDate,
                                                    CreateBy = UserId,
                                                    LastModifiedBy = UserId
                                                });

                                            var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                            rowsAffected += insertResult.Count();
                                            #endregion
                                        }
                                        #endregion
                                    }
                                    #endregion

                                    #region //若來源條碼有綁定屬性，自動延續
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.ItemNo, a.ItemValue
                                            FROM MES.BarcodeAttribute a 
                                            INNER JOIN MES.Barcode b ON a.BarcodeId = b.BarcodeId
                                            WHERE a.MoId = @MoId
                                            AND b.BarcodeNo = @BarcodeNo";
                                    dynamicParameters.Add("MoId", MoId);
                                    dynamicParameters.Add("BarcodeNo", BarcodeNo);

                                    var BarcodeAttributeResult = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var item in BarcodeAttributeResult)
                                    {
                                        #region //INSERT MES.BarcodeAttribute
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO MES.BarcodeAttribute (MoId, BarcodeId, ItemNo, ItemValue, ItemSeq
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.MoId
                                                VALUES (@MoId, @BarcodeId, @ItemNo, @ItemValue, @ItemSeq
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MoId,
                                                BarcodeId,
                                                item.ItemNo,
                                                item.ItemValue,
                                                item.ItemSeq,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy = UserId,
                                                LastModifiedBy = UserId
                                            });

                                        var insertResult3 = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected += insertResult.Count();
                                        #endregion
                                    }
                                    #endregion

                                    #region //若為Tray模式，將新產條碼自動綁定到新Tray盤上
                                    if (TrayBarcode == "Y")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE MES.Tray SET
                                                BarcodeNo = @BarcodeNo,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE TrayNo = @NewTrayBarcode";
                                        dynamicParameters.AddDynamicParams(
                                          new
                                          {
                                              BarcodeNo = OKBarcode,
                                              LastModifiedDate,
                                              LastModifiedBy = UserId,
                                              NewTrayBarcode = MTFBTrayNo
                                          });

                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    }
                                    #endregion
                                    #endregion

                                } //throw new SystemException("查無此條碼(" + MTFBTrayNo + ")綁定的Tray盤資訊!");

                                else {
                                    foreach (var item4 in TrayResult)
                                    {
                                        MTFBBarcode = item4.BarcodeNo;
                                    }
                                }

                                
                                #endregion

                                #region //確認目標條碼資料是否正確
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT a.BarcodeId, a.MoId, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                                        , c.MtlItemId
                                        FROM MES.Barcode a 
                                        INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                        INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                        WHERE a.BarcodeNo = @BarcodeNo";
                                dynamicParameters.Add("BarcodeNo", MTFBBarcode);

                                var ToBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                                if (ToBarcodeResult.Count() <= 0) throw new SystemException("查無【目標條碼】相關資料，請確認資料是否有誤!");

                                
                                foreach (var item in ToBarcodeResult)
                                {
                                    if (item.CurrentProdStatus != "P") throw new SystemException("【目標條碼】狀態非良品!");
                                    //if (item.BarcodeStatus != "8") throw new SystemException("【目標條碼】狀態尚未入庫!");
                                    ToMoId = item.MoId;
                                    ToBarcodeId = item.BarcodeId;
                                    ToMtlItemId = item.MtlItemId;
                                    ToBarcodeQty = item.BarcodeQty;
                                }
                                #endregion

                                #region 拆併
                                #region //更新來源條碼數量
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                    BarcodeQty = BarcodeQty - @TransactionQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @FromBarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        TransactionQty = MergeQty,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        FromBarcodeId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //更新目標條碼數量
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE MES.Barcode SET
                                    BarcodeQty = BarcodeQty + @TransactionQty,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BarcodeId = @ToBarcodeId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        TransactionQty = MergeQty,
                                        LastModifiedDate,
                                        LastModifiedBy = UserId,
                                        ToBarcodeId
                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //新增調整紀錄
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO MES.BarcodeTransfer (TransactionDate, FromBarcodeId, ToBarcodeId, TransactionQty
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@TransactionDate, @FromBarcodeId, @ToBarcodeId, @TransactionQty
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        FromBarcodeProcessId,
                                        ToBarcodeProcessId,
                                        TransactionDate = DateTime.Now,
                                        FromBarcodeId,
                                        ToBarcodeId,
                                        TransactionQty = MergeQty,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy = UserId,
                                        LastModifiedBy = UserId


                                    });

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                                #endregion


                            }




                        }
                        #endregion




                        #endregion


                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }


        #endregion

        #endregion

        #region //條碼入庫後拆併包裝作業
        #region //BarcodeMergerTransaction-- 條碼拆併盤作業 -- Ann 2024-10-24
        public string BarcodeMergerTransaction(string FromBarcodeNo, string ToBarcodeNo, int TransactionQty)
        {
            try
            {
                if (FromBarcodeNo.Length <= 0) throw new SystemException("【來源條碼】不能為空!");
                if (ToBarcodeNo.Length <= 0) throw new SystemException("【目標條碼】不能為空!");
                if (TransactionQty <= 0) throw new SystemException("【拆併數量】必須大於0!");
                if (FromBarcodeNo == ToBarcodeNo) throw new SystemException("來源及目標條碼不能相同!!");
                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //將條碼轉成大寫
                        FromBarcodeNo = FromBarcodeNo.ToString().ToUpper();
                        ToBarcodeNo = ToBarcodeNo.ToString().ToUpper();
                        #endregion

                        #region //確認來源條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.MoId, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                                , c.MtlItemId
                                FROM MES.Barcode a 
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", FromBarcodeNo);

                        var FromBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (FromBarcodeResult.Count() <= 0) throw new SystemException("查無【來源條碼】相關資料，請確認資料是否有誤!");

                        int FromMoId = -1;
                        int FromBarcodeId = -1;
                        int FromMtlItemId = -1;
                        int FromBarcodeQty = 0;
                        foreach (var item in FromBarcodeResult)
                        {
                            if (item.BarcodeQty < TransactionQty) throw new SystemException("轉移數量已超過來源條碼目前數量【" + item.BarcodeQty + "】!");
                            if (item.CurrentProdStatus != "P") throw new SystemException("【來源條碼】狀態非良品!");
                            if (item.BarcodeStatus != "8") throw new SystemException("【來源條碼】狀態尚未入庫!");
                            FromMoId = item.MoId;
                            FromBarcodeId = item.BarcodeId;
                            FromMtlItemId = item.MtlItemId;
                            FromBarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //取得來源條碼批號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ISNULL(b.LotNumber, '')  LotNumber
                                FROM MES.MweBarcode a 
                                INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                                WHERE a.BarcodeId = @BarcodeId 
                                ANd b.MoId = @MoId 
                                ORDER BY b.CreateDate DESC";
                        dynamicParameters.Add("BarcodeId", FromBarcodeId);
                        dynamicParameters.Add("MoId", FromMoId);

                        var FromMweBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (FromMweBarcodeResult.Count() <= 0) throw new SystemException("查無此【來源條碼】的入庫單紀錄!");

                        string FromLotNumber = "";
                        foreach (var item in FromMweBarcodeResult)
                        {
                            if (item.LotNumber.Length <= 0) throw new SystemException("此【來源條碼】最近一次的入庫單尚未維護批號!");
                            FromLotNumber = item.LotNumber;
                        }
                        #endregion

                        #region //確認來源條碼無被其他條碼註冊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 
                                FROM MES.Barcode a 
                                INNER JOIN MES.Barcode b ON a.ParentBarcode = b.BarcodeId
                                WHERE b.BarcodeNo = @FromBarcodeNo";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);

                        var ParentBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ParentBarcodeResult.Any()) throw new SystemException("此【來源條碼】已被其他條碼註冊!");
                        #endregion

                        #region //確認來源條碼無被其他條碼註冊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 
                                FROM MES.Barcode a 
                                INNER JOIN MES.Barcode b ON a.PrevBarcodeId = b.BarcodeId
                                WHERE b.BarcodeNo = @FromBarcodeNo";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);

                        var PrevBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (PrevBarcodeResult.Any()) throw new SystemException("此【來源條碼】為包裝條碼!");
                        #endregion

                        #region //確認目標條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.MoId, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus
                                , c.MtlItemId
                                FROM MES.Barcode a 
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", ToBarcodeNo);

                        var ToBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ToBarcodeResult.Count() <= 0) throw new SystemException("查無【目標條碼】相關資料，請確認資料是否有誤!");

                        int ToMoId = -1;
                        int ToBarcodeId = -1;
                        int ToMtlItemId = -1;
                        int ToBarcodeQty = 0;
                        foreach (var item in ToBarcodeResult)
                        {
                            if (item.CurrentProdStatus != "P") throw new SystemException("【目標條碼】狀態非良品!");
                            if (item.BarcodeStatus != "8") throw new SystemException("【目標條碼】狀態尚未入庫!");
                            ToMoId = item.MoId;
                            ToBarcodeId = item.BarcodeId;
                            ToMtlItemId = item.MtlItemId;
                            ToBarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //取得目標條碼批號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ISNULL(b.LotNumber, '')  LotNumber
                                FROM MES.MweBarcode a 
                                INNER JOIN MES.MweDetail b ON a.MweDetailId = b.MweDetailId
                                WHERE a.BarcodeId = @BarcodeId 
                                ANd b.MoId = @MoId 
                                ORDER BY b.CreateDate DESC";
                        dynamicParameters.Add("BarcodeId", ToBarcodeId);
                        dynamicParameters.Add("MoId", ToMoId);

                        var ToMweBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (ToMweBarcodeResult.Count() <= 0) throw new SystemException("查無此【目標條碼】的入庫單紀錄!");

                        string ToLotNumber = "";
                        foreach (var item in ToMweBarcodeResult)
                        {
                            if (item.LotNumber.Length <= 0) throw new SystemException("此【目標條碼】最近一次的入庫單尚未維護批號!");
                            ToLotNumber = item.LotNumber;
                        }
                        #endregion

                        #region //檢核來源及目標條碼的品號及批號要相同
                        if (FromMtlItemId != ToMtlItemId || FromLotNumber != ToLotNumber)
                        {
                            throw new SystemException("來源條碼及目標條碼的【品號】或【批號】不同!");
                        }
                        #endregion

                        #region //更新來源條碼數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty - @TransactionQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @FromBarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                FromBarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //更新目標條碼數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty + @TransactionQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeId = @ToBarcodeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                ToBarcodeId
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //新增調整紀錄
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.BarcodeTransfer (TransactionDate, FromBarcodeId, ToBarcodeId, TransactionQty
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@TransactionDate, @FromBarcodeId, @ToBarcodeId, @TransactionQty
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionDate = DateTime.Now,
                                FromBarcodeId,
                                ToBarcodeId,
                                TransactionQty,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //重新查詢目標及來源條碼數量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeQty FromBarcodeQty,
                                (
                                    SELECT x.BarcodeQty 
                                    FROM MES.Barcode x 
                                    WHERE x.BarcodeNo = @ToBarcodeNo
                                ) ToBarcodeQty
                                FROM MES.Barcode a
                                WHERE a.BarcodeNo = @FromBarcodeNo";
                        dynamicParameters.Add("FromBarcodeNo", FromBarcodeNo);
                        dynamicParameters.Add("ToBarcodeNo", ToBarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            BarcodeResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBarcodeForBatchProcessing-- 取得條碼資料(拆盤包裝作業用) -- Ann 2024-10-24
        public string GetBarcodeForBatchProcessing(string BarcodeNo)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【條碼】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TrayNo 
                                , b.BarcodeId, b.BarcodeNo, b.MoId, b.BarcodeQty, b.PrevBarcodeId
                                , d.WoErpPrefix, d.WoErpNo
                                , e.MtlItemNo, e.MtlItemName, e.MtlItemSpec
                                FROM MES.Tray a 
                                INNER JOIN MES.Barcode b ON a.BarcodeNo = b.BarcodeNo
                                INNER JOIN MES.ManufactureOrder c ON b.MoId = c.MoId
                                INNER JOIN MES.WipOrder d ON c.WoId = d.WoId
                                INNER JOIN PDM.MtlItem e ON d.MtlItemId = e.MtlItemId
                                WHERE a.TrayNo = @BarcodeNo
                                AND b.CurrentProdStatus = 'P'
                                AND b.BarcodeStatus = '8'";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var TrayBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (TrayBarcodeResult.Count() <= 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.MoId, a.BarcodeQty, a.PrevBarcodeId
                                    , c.WoErpPrefix, c.WoErpNo
                                    , d.MtlItemNo, d.MtlItemName, d.MtlItemSpec
                                    , '' TrayNo
                                    FROM MES.Barcode a 
                                    INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                    INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                    INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                    WHERE a.BarcodeNo = @BarcodeNo
                                    AND a.CurrentProdStatus = 'P'
                                    AND a.BarcodeStatus = '8'";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                result = BarcodeResult
                            });
                            #endregion
                        }
                        else
                        {
                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "success",
                                result = TrayBarcodeResult
                            });
                            #endregion
                        }
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //RegisterBarcodeToPackage-- 註冊產品條碼至包裝中 -- Ann 2024-10-25
        public string RegisterBarcodeToPackage(string BarcodeNo, string PrevBarcodeNo)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【產品條碼】不能為空!");
                if (PrevBarcodeNo.Length <= 0) throw new SystemException("【包裝條碼】不能為空!");
                if (!PrevBarcodeNo.StartsWith("PACKAGE-")) throw new SystemException("【包裝條碼】格式錯誤!");
                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //將條碼轉成大寫
                        BarcodeNo = BarcodeNo.ToString().ToUpper();
                        PrevBarcodeNo = PrevBarcodeNo.ToString().ToUpper();
                        #endregion

                        #region //確認產品條碼資料是否已存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeQty, a.PrevBarcodeId, a.CurrentProdStatus, a.BarcodeStatus
                                FROM MES.Barcode a 
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (!BarcodeResult.Any()) throw new SystemException("查無此產品條碼【" + BarcodeNo + "】資料!");

                        int BarcodeQty = -1;
                        foreach (var item in BarcodeResult)
                        {
                            if (item.PrevBarcodeId != null) throw new SystemException("此產品條碼【" + BarcodeNo + "】已有註冊在其他包裝條碼!");
                            if (item.CurrentProdStatus != "P") throw new SystemException("此產品條碼【" + BarcodeNo + "】狀態非良品，無法進行包裝流程!");
                            if (item.BarcodeStatus != "8") throw new SystemException("此產品條碼【" + BarcodeNo + "】未入庫，無法進行包裝流程!");
                            BarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //確認包裝條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.CurrentProdStatus, a.BarcodeStatus
                                FROM MES.Barcode a 
                                WHERE a.BarcodeNo = @PrevBarcodeNo";
                        dynamicParameters.Add("PrevBarcodeNo", PrevBarcodeNo);

                        var ParentBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (!ParentBarcodeResult.Any()) throw new SystemException("查無此包裝條碼【" + PrevBarcodeNo + "】資料!");
                        int PrevBarcodeId = -1;
                        foreach (var item in ParentBarcodeResult)
                        {
                            if (item.CurrentProdStatus != "P" || item.BarcodeStatus != "8") throw new SystemException("此包裝條碼【" + PrevBarcodeNo + "】，無法新增!");
                            PrevBarcodeId = item.BarcodeId;
                        }
                        #endregion

                        #region //UPDATE MES.Barcode ParentBarcode
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                PrevBarcodeId = @PrevBarcodeId,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                PrevBarcodeId,
                                LastModifiedDate,
                                LastModifiedBy,
                                BarcodeNo
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //UPDATE Package BarcodeQty
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty + @BarcodeQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @PrevBarcodeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                PrevBarcodeNo
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddEmptyPackage-- 新增空包裝條碼 -- Ann 2024-10-28
        public string AddEmptyPackage()
        {
            try
            {
                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //包裝條碼編碼設定
                        string BarcodeNo = "";
                        bool isBarcodeUsed;
                        do
                        {
                            BarcodeNo = "PACKAGE-" + Guid.NewGuid().ToString().Substring(0, 10).ToUpper();
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1 
                                    FROM MES.Barcode a 
                                    WHERE a.BarcodeNo = @BarcodeNo";
                            dynamicParameters.Add("BarcodeNo", BarcodeNo);

                            var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                            isBarcodeUsed = BarcodeResult.Any();
                        }
                        while (isBarcodeUsed);
                        #endregion

                        #region //INSERT MES.Barcode ParentBarcode
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO MES.Barcode (BarcodeNo, CurrentMoProcessId, NextMoProcessId, BarcodeQty
                                , CurrentProdStatus, BarcodeStatus
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@BarcodeNo, @CurrentMoProcessId, @NextMoProcessId, @BarcodeQty
                                , @CurrentProdStatus, @BarcodeStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeNo,
                                CurrentMoProcessId = -1,
                                NextMoProcessId = -1,
                                BarcodeQty = 0,
                                CurrentProdStatus = "P",
                                BarcodeStatus = "8",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            barcodeNo = BarcodeNo
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPackageBarcode-- 取得包裝內條碼資料 -- Ann 2024-10-28
        public string GetPackageBarcode(string PrevBarcodeNo)
        {
            try
            {
                if (PrevBarcodeNo.Length <= 0) throw new SystemException("【包裝條碼】不能為空!");
                if (!PrevBarcodeNo.StartsWith("PACKAGE-")) throw new SystemException("【包裝條碼】格式錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeNo PrevBarcodeNo, a.BarcodeQty
                                , (
                                    SELECT x.BarcodeId, x.BarcodeNo, x.MoId, x.BarcodeQty
                                    , xc.MtlItemNo, xc.MtlItemName, xc.MtlItemSpec
                                    FROM MES.Barcode x 
                                    INNER JOIN MES.ManufactureOrder xa ON x.MoId = xa.MoId
                                    INNER JOIN MES.WipOrder xb ON xa.WoId = xb.WoId
                                    INNER JOIN PDM.MtlItem xc ON xb.MtlItemId = xc.MtlItemId
                                    WHERE x.PrevBarcodeId = a.BarcodeId
                                    FOR JSON PATH, ROOT('data')
                                ) PackageBarcode
                                FROM MES.Barcode a 
                                WHERE a.BarcodeNo = @PrevBarcodeNo";
                        dynamicParameters.Add("PrevBarcodeNo", PrevBarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            result = BarcodeResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UnRegisterBarcodeToPackage-- 將條碼從包裝中移除註冊 -- Ann 2024-10-28
        public string UnRegisterBarcodeToPackage(string BarcodeNo, string PrevBarcodeNo)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【產品條碼】不能為空!");
                if (PrevBarcodeNo.Length <= 0) throw new SystemException("【包裝條碼】不能為空!");
                if (!PrevBarcodeNo.StartsWith("PACKAGE-")) throw new SystemException("【包裝條碼】格式錯誤!");
                int rowsAffected = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //將條碼轉成大寫
                        BarcodeNo = BarcodeNo.ToString().ToUpper();
                        PrevBarcodeNo = PrevBarcodeNo.ToString().ToUpper();
                        #endregion

                        #region //確認包裝條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId
                                FROM MES.Barcode a 
                                WHERE a.BarcodeNo = @PrevBarcodeNo";
                        dynamicParameters.Add("PrevBarcodeNo", PrevBarcodeNo);

                        var PrevBarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (!PrevBarcodeResult.Any()) throw new SystemException("查無此包裝條碼【" + PrevBarcodeNo + "】資料!");

                        int PrevBarcodeId = -1;
                        foreach (var item in PrevBarcodeResult)
                        {
                            PrevBarcodeId = item.BarcodeId;
                        }
                        #endregion

                        #region //確認產品條碼資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeQty, a.PrevBarcodeId, a.CurrentProdStatus, a.BarcodeStatus
                                FROM MES.Barcode a 
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (!BarcodeResult.Any()) throw new SystemException("查無此產品條碼【" + BarcodeNo + "】資料!");

                        int BarcodeQty = -1;
                        foreach (var item in BarcodeResult)
                        {
                            if (item.PrevBarcodeId != PrevBarcodeId) throw new SystemException("產品條碼與包裝條碼關聯錯誤!");
                            if (item.CurrentProdStatus != "P") throw new SystemException("此產品條碼狀態非良品!");
                            if (item.BarcodeStatus != "8") throw new SystemException("此產品條碼狀態非入庫!");
                            BarcodeQty = item.BarcodeQty;
                        }
                        #endregion

                        #region //UPDATE MES.Barcode PrevBarcodeId
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                PrevBarcodeId = NULL,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @BarcodeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                LastModifiedDate,
                                LastModifiedBy,
                                BarcodeNo
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //UPDATE Package BarcodeQty
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE MES.Barcode SET
                                BarcodeQty = BarcodeQty - @BarcodeQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BarcodeNo = @PrevBarcodeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BarcodeQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                PrevBarcodeNo
                            });

                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCurrentPackageBarcode-- 取得目前產品條碼資料 -- Ann 2024-10-30
        public string GetCurrentPackageBarcode(string BarcodeNo)
        {
            try
            {
                if (BarcodeNo.Length <= 0) throw new SystemException("【產品條碼】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BarcodeId, a.BarcodeNo, a.CurrentMoProcessId, a.NextMoProcessId
                                , a.MoId, a.BarcodeQty, a.CurrentProdStatus, a.BarcodeStatus 
                                , d.MtlItemNo, d.MtlItemName, d.MtlItemSpec
                                FROM MES.Barcode a 
                                INNER JOIN MES.ManufactureOrder b ON a.MoId = b.MoId
                                INNER JOIN MES.WipOrder c ON b.WoId = c.WoId
                                INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                WHERE a.BarcodeNo = @BarcodeNo";
                        dynamicParameters.Add("BarcodeNo", BarcodeNo);

                        var BarcodeResult = sqlConnection.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            result = BarcodeResult
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion
    }
}