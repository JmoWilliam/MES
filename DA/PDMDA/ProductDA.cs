using Dapper;
using Helpers;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using NLog;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Globalization;
using System.Linq;
using System.Text.RegularExpressions;
using System.Transactions;
using System.Web;
using System.Xml;
using System.Xml.Linq;

namespace PDMDA
{
    public class ProductDA
    {
        public string MainConnectionStrings = "";
        public string ErpConnectionStrings = "";
        public string HrmConnectionStrings = "";

        public int CurrentCompany = -1;
        public int CurrentUser = -1;
        public int CreateBy = -1;
        public int LastModifiedBy = -1;
        public string UserLock = "";
        public string UserNo = "";
        public DateTime CreateDate = default(DateTime);
        public DateTime LastModifiedDate = default(DateTime);

        public string sql = "";
        public JObject jsonResponse = new JObject();
        public Logger logger = LogManager.GetCurrentClassLogger();
        public DynamicParameters dynamicParameters = new DynamicParameters();
        public SqlQuery sqlQuery = new SqlQuery();

        public ProductDA()
        {
            MainConnectionStrings = ConfigurationManager.AppSettings["MainDb"];
            HrmConnectionStrings = ConfigurationManager.AppSettings["HrmDb"];

            GetUserInfo();
            CreateDate = DateTime.Now;
            LastModifiedDate = DateTime.Now;

            dynamicParameters = new DynamicParameters();
            sqlQuery = new SqlQuery();
        }

        #region //GetUserInfo 取得使用者資訊
        private void GetUserInfo()
        {
            try
            {
                CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["UserCompany"]);
                CurrentUser = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                CreateBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);
                LastModifiedBy = Convert.ToInt32(HttpContext.Current.Session["UserId"]);

                if (HttpContext.Current.Session["CompanySwitch"] != null)
                {
                    if (HttpContext.Current.Session["CompanySwitch"].ToString() == "manual")
                    {
                        CurrentCompany = Convert.ToInt32(HttpContext.Current.Session["CompanyId"]);
                    }
                }
            }
            catch (Exception e)
            {
                logger.Error(e.Message);
            }
        }
        #endregion

        #region //Get
        #region //GetMtlItem -- 取得品號資料 -- Ben Ma 2022.06.30
        public string GetMtlItem(int MtlItemId, string MtlItemNo, string MtlItemName, string MtlItemSpec, string CustomerMtlItemNo, string SearchKey
            , string Status, string TransferStatus, string BomTransferStatus, string CustomerTransferStatus, string BomSubstitutionTransferStatus, string UomCTransferStatus, string CheckMtlDate
            , int ItemTypeId, string LotManagement, string ItemAttribute, string TransferStartDate, string TransferEndDate
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                List<string> MB001s = new List<string>();
                List<MtlItem> mtlItems = new List<MtlItem>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    sqlQuery.mainKey = "a.MtlItemId";
                    sqlQuery.auxKey = ", a.CustomerMtlItem";
                    sqlQuery.columns =
                        @", a.ItemTypeId, a.LotManagement
                          , LTRIM(RTRIM(a.MtlItemNo)) AS MtlItemNo, LTRIM(RTRIM(a.MtlItemName)) AS MtlItemName, LTRIM(RTRIM(a.MtlItemSpec)) AS MtlItemSpec
                          , ISNULL(a.TypeOne, '') TypeOne, ISNULL(a.TypeTwo, '') TypeTwo, ISNULL(a.TypeThree, '') TypeThree
                          , ISNULL(a.TypeFour, '') TypeFour, a.InventoryId, a.RequisitionInventoryId, a.InventoryManagement
                          , a.PurchaseUomId, a.SaleUomId, a.MtlModify, a.BondedStore, a.ItemAttribute, a.ProductionLine, a.LotManagement, a.MeasureType, a.InventoryUomId
                          , a.EffectiveDate, a.ExpirationDate, a.Version, a.MtlItemDesc, a.MtlItemRemark
                          , a.TransferStatus, a.TransferDate, a.Status, a.CreateDate, a.EfficientDays, a.RetestDays, a.ReplenishmentPolicy
                          , b.UomNo AS InventoryUomNo
                          , c.UserName
                          , d.InventoryNo
                          , ISNULL(x.MtlItemUomCalculateQty, 0) AS MtlItemUomCalculateQty
                          , ISNULL(bom.BomTransferQty, 0) AS BomTransferQty
                          , ISNULL(Cus.CusTransferQty, 0) AS CusTransferQty
                          , ISNULL(Sub.SubTransferQty, 0) AS SubTransferQty
                          , ISNULL(Uom.UomTransferQty, 0) AS UomTransferQty
                          , CASE WHEN GETDATE() BETWEEN ISNULL(a.EffectiveDate, '1900-01-01') AND ISNULL(a.ExpirationDate, '9999-01-01') THEN 1 ELSE 0 END AS Effective";
                    sqlQuery.mainTables =
                        @"FROM PDM.MtlItem a
                          LEFT JOIN PDM.UnitOfMeasure b on a.InventoryUomId = b.UomId
                          LEFT JOIN BAS.[User] c on a.CreateBy = c.UserId
                          LEFT JOIN SCM.Inventory d ON a.InventoryId = d.InventoryId
                          OUTER APPLY(
                            SELECT COUNT(x1.MtlItemUomCalculateId) MtlItemUomCalculateQty FROM PDM.MtlItemUomCalculate x1 WHERE a.MtlItemId = x1.MtlItemId
                        　) x
                          OUTER APPLY(
	                          SELECT COUNT(x1.MtlItemId) as BomTransferQty FROM PDM.BillOfMaterials x1 INNER JOIN PDM.BomDetail x2 ON x2.BomId = x1.BomId WHERE x1.MtlItemId = a.MtlItemId AND x1.[TransferStatus] = 'N'
                          ) bom
                          OUTER APPLY(
	                          SELECT COUNT(x1.MtlItemId) as CusTransferQty FROM PDM.CustomerMtlItem x1 WHERE x1.MtlItemId = a.MtlItemId AND x1.[TransferStatus] = 'N'
                          ) Cus
                          OUTER APPLY(
	                          SELECT COUNT(x1.MtlItemId) as SubTransferQty FROM PDM.BomSubstitution x1 INNER JOIN PDM.BomDetail x2 ON x2.BomDetailId = x1.BomDetailId INNER JOIN PDM.BillOfMaterials x3 ON x3.BomId = x2.BomId WHERE x3.MtlItemId = a.MtlItemId AND x1.[TransferStatus] = 'N'
                          ) Sub
                          OUTER APPLY(
	                          SELECT COUNT(x1.MtlItemId) as UomTransferQty FROM PDM.MtlItemUomCalculate x1 WHERE x1.MtlItemId = a.MtlItemId AND x1.[TransferStatus] = 'N'
                          ) Uom";
                    string queryTable =
                        @"FROM (
                            SELECT a.MtlItemId, a.CompanyId, a.ItemTypeId, a.LotManagement, a.MtlItemNo, a.MtlItemName, a.MtlItemSpec, a.EffectiveDate, a.ExpirationDate
                            , a.TransferStatus, a.TransferDate, a.Status, a.ItemAttribute, c.UserName,a.ReplenishmentPolicy, d.InventoryNo
                            , ISNULL(x.MtlItemUomCalculateQty, 0) AS MtlItemUomCalculateQty, a.CreateDate
                            , ISNULL(bom.BomTransferQty, 0) AS BomTransferQty
                            , ISNULL(Cus.CusTransferQty, 0) AS CusTransferQty
                            , ISNULL(Sub.SubTransferQty, 0) AS SubTransferQty
                            , ISNULL(Uom.UomTransferQty, 0) AS UomTransferQty
                            , (
                                SELECT aa.CustomerMtlItemId, aa.CustomerId, aa.CustomerMtlItemNo, aa.CustomerMtlItemName, aa.CustomerMtlItemSpec
                                , ab.CustomerNo, ab.CustomerShortName, aa.CustomerId customerId, aa.CustomerMtlItemNo customerMtlItemNo
                                , aa.CustomerMtlItemName customerMtlItemName, aa.CustomerMtlItemSpec customerMtlItemSpec
                                , ab.CustomerNo + ' ' + ab.CustomerShortName customerName
                                FROM PDM.CustomerMtlItem aa
                                INNER JOIN SCM.Customer ab ON aa.CustomerId = ab.CustomerId
                                WHERE aa.MtlItemId = a.MtlItemId
                                ORDER BY ab.CustomerNo, aa.CustomerMtlItemNo
                                FOR JSON PATH, ROOT('data')
                            ) CustomerMtlItem
                            FROM PDM.MtlItem a
                            LEFT JOIN PDM.UnitOfMeasure b on a.InventoryUomId = b.UomId
                            LEFT JOIN BAS.[User] c on a.CreateBy = c.UserId
                            LEFT JOIN SCM.Inventory d ON a.InventoryId = d.InventoryId
                            OUTER APPLY(
                                SELECT COUNT(x1.MtlItemUomCalculateId) MtlItemUomCalculateQty FROM PDM.MtlItemUomCalculate x1 WHERE a.MtlItemId = x1.MtlItemId
                            ) x
                            OUTER APPLY(
	                            SELECT COUNT(x1.MtlItemId) as BomTransferQty FROM PDM.BillOfMaterials x1 INNER JOIN PDM.BomDetail x2 ON x2.BomId = x1.BomId WHERE x1.MtlItemId = a.MtlItemId AND x1.[TransferStatus] = 'N'
                            ) bom
                            OUTER APPLY(
	                            SELECT COUNT(x1.MtlItemId) as CusTransferQty FROM PDM.CustomerMtlItem x1 WHERE x1.MtlItemId = a.MtlItemId AND x1.[TransferStatus] = 'N'
                            ) Cus
                            OUTER APPLY(
	                            SELECT COUNT(x1.MtlItemId) as SubTransferQty FROM PDM.BomSubstitution x1 INNER JOIN PDM.BomDetail x2 ON x2.BomDetailId = x1.BomDetailId INNER JOIN PDM.BillOfMaterials x3 ON x3.BomId = x2.BomId WHERE x3.MtlItemId = a.MtlItemId AND x1.[TransferStatus] = 'N'
                            ) Sub
                            OUTER APPLY(
	                            SELECT COUNT(x1.MtlItemId) as UomTransferQty FROM PDM.MtlItemUomCalculate x1 WHERE x1.MtlItemId = a.MtlItemId AND x1.[TransferStatus] = 'N'
                            ) Uom
                        ) a 
                        OUTER APPLY (
                            SELECT TOP 1 x.CustomerMtlItemNo, x.CustomerMtlItemName, x.CustomerMtlItemSpec
                            FROM OPENJSON(a.CustomerMtlItem, '$.data')
                            WITH (
                                CustomerMtlItemNo NVARCHAR(50) N'$.CustomerMtlItemNo',
                                CustomerMtlItemName NVARCHAR(200) N'$.CustomerMtlItemName',
                                CustomerMtlItemSpec NVARCHAR(200) N'$.CustomerMtlItemSpec'
                            ) x
                        ) b";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @"AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    //var expirationDate = CreateDate.ToString("yyyy-MM-dd");
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "expirationDate", @" AND (a.ExpirationDate IS NULL OR a.ExpirationDate='' OR a.ExpirationDate > @expirationDate)", expirationDate);//失效日
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemId", @" AND a.MtlItemId = @MtlItemId", MtlItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND a.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo.Trim());
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND a.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemSpec", @" AND a.MtlItemSpec LIKE '%' + @MtlItemSpec + '%'", MtlItemSpec);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerMtlItemNo", @" AND b.CustomerMtlItemNo LIKE '%' + @CustomerMtlItemNo + '%'", CustomerMtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CheckMtlDate", @" AND @CheckMtlDate >= ISNULL(a.EffectiveDate, '1999-01-01') AND @CheckMtlDate <= ISNULL(a.ExpirationDate, '9999-01-01')", CheckMtlDate);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ItemTypeId", @" AND a.ItemTypeId = @ItemTypeId", ItemTypeId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "LotManagement", @" AND a.LotManagement = @LotManagement", LotManagement);
                    if (ItemAttribute.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ItemAttribute", @" AND a.ItemAttribute IN @ItemAttribute", ItemAttribute.Split(','));
                    if (Status.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.Status IN @Status", Status.Split(','));
                    if (TransferStatus.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferStatus", @" AND a.TransferStatus IN @TransferStatus", TransferStatus.Split(','));

                    //篩選BOM是否已拋轉
                    if (!string.IsNullOrWhiteSpace(BomTransferStatus))
                    {
                        string[] transferStatus = BomTransferStatus.Split(',');
                        if (!transferStatus.Any(a => a == "N"))
                            queryCondition += @" AND a.BomTransferQty = @BomTransferQty";
                        if (!transferStatus.Any(a => a == "Y"))
                            queryCondition += @" AND a.BomTransferQty > @BomTransferQty";
                        dynamicParameters.Add("BomTransferQty", 0);
                    }
                    //篩選部番是否已拋轉
                    if (!string.IsNullOrWhiteSpace(CustomerTransferStatus))
                    {
                        string[] transferStatus = CustomerTransferStatus.Split(',');
                        if (!transferStatus.Any(a => a == "N"))
                            queryCondition += @" AND a.CusTransferQty = @CusTransferQty";
                        if (!transferStatus.Any(a => a == "Y"))
                            queryCondition += @" AND a.CusTransferQty > @CusTransferQty";
                        dynamicParameters.Add("CusTransferQty", 0);
                    }
                    //篩選取替代料是否已拋轉
                    if (!string.IsNullOrWhiteSpace(BomSubstitutionTransferStatus))
                    {
                        string[] transferStatus = BomSubstitutionTransferStatus.Split(',');
                        if (!transferStatus.Any(a => a == "N"))
                            queryCondition += @" AND a.SubTransferQty = @SubTransferQty";
                        if (!transferStatus.Any(a => a == "Y"))
                            queryCondition += @" AND a.SubTransferQty > @SubTransferQty";
                        dynamicParameters.Add("SubTransferQty", 0);
                    }

                    if (!string.IsNullOrEmpty(TransferStartDate) && !string.IsNullOrEmpty(TransferEndDate))
                    {
                        DateTime start = Convert.ToDateTime(TransferStartDate).Date; // 2025-05-01 00:00:00
                        DateTime end = Convert.ToDateTime(TransferEndDate).Date.AddDays(1).AddSeconds(-1); // 2025-05-01 23:59:59

                        string startDateStr = start.ToString("yyyyMMdd");  // 例如: "20250501"
                        string endDateStr = end.ToString("yyyyMMdd");      // 例如: "20250501"

                        queryCondition += " AND CONVERT(VARCHAR(10), a.CreateDate, 120) BETWEEN @TransferStartDate AND @TransferEndDate ";
                        dynamicParameters.Add("TransferStartDate", TransferStartDate);
                        dynamicParameters.Add("TransferEndDate", TransferEndDate);
                    }

                    if (SearchKey.Length > 0)
                    {
                        string searchSql = "";
                        string[] searchKey = SearchKey.Split(' ');

                        searchSql += @" AND (
                                        b.CustomerMtlItemNo LIKE '%' + @SearchKey + '%'
                                        OR a.MtlItemName LIKE '%' + @SearchKey + '%'
                                        OR a.MtlItemSpec LIKE '%' + @SearchKey + '%'
                                        OR a.MtlItemNo LIKE '%' + @SearchKey + '%'";
                        if (searchKey[0].Length >= 4)
                        {
                            searchSql += @" OR b.CustomerMtlItemNo LIKE '%' + @ParagraphStep1 + '%'
                                            OR a.MtlItemName LIKE '%' + @ParagraphStep1 + '%'";
                            if (searchKey[0].Length >= 6)
                            {
                                searchSql += @" OR b.CustomerMtlItemNo LIKE '%' + @ParagraphStep2 + '%'
                                                OR a.MtlItemName LIKE '%' + @ParagraphStep2 + '%'
                                                OR a.MtlItemNo LIKE '%' + @ParagraphStep2 + '%'";
                            }

                            dynamicParameters.Add("ParagraphStep1", searchKey[0]);
                            dynamicParameters.Add("ParagraphStep2", searchKey[0].Substring(2, searchKey[0].Length - 2));
                        }
                        if (searchKey.Length > 1)
                        {
                            if (searchKey[1].Length >= 4)
                            {
                                searchSql += @" OR b.CustomerMtlItemNo LIKE '%' + @ParagraphStep3 + '%'
                                                OR a.MtlItemName LIKE '%' + @ParagraphStep3 + '%'
                                                OR a.MtlItemNo LIKE '%' + @ParagraphStep3 + '%'";
                                if (searchKey[1].Length >= 6)
                                {
                                    searchSql += @" OR b.CustomerMtlItemNo LIKE '%' + @ParagraphStep4 + '%'
                                                    OR a.MtlItemName LIKE '%' + @ParagraphStep4 + '%'
                                                    OR a.MtlItemNo LIKE '%' + @ParagraphStep4 + '%'";
                                }
                                dynamicParameters.Add("ParagraphStep3", searchKey[1]);
                                dynamicParameters.Add("ParagraphStep4", searchKey[1].Substring(2, searchKey[1].Length - 2));
                            }
                        }
                        searchSql += ")";
                        dynamicParameters.Add("SearchKey", SearchKey);

                        queryCondition += searchSql;
                    }
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MtlItemId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    mtlItems = BaseHelper.SqlQuery<MtlItem>(sqlConnection, dynamicParameters, sqlQuery);
                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    #region //取得ERP品號資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT LTRIM(RTRIM(MB001)) as MB001
                            FROM INVMB
                            WHERE LTRIM(RTRIM(MB001)) IN @MB001s";
                    //dynamicParameters.Add("CompanyNo", companyNo);
                    dynamicParameters.Add("MB001s", mtlItems.Select(s => s.MtlItemNo).ToArray());
                    var resultINVMB = sqlConnection.Query(sql, dynamicParameters);
                    MB001s = resultINVMB.Select(s => { return (string)s.MB001; }).ToList();
                    #endregion

                    #region //過濾BM不存在ERP的品號
                    //mtlItems = mtlItems.Where(w => resultINVMB.Select(s => { return (string)s.MB001; }).ToList().Contains(w.MtlItemNo)).ToList();
                    #endregion

                    List<Erp> erps = new List<Erp>();

                    #region //撈取類別一、二、三、四
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT LTRIM(RTRIM(MA002)) MtlItemTypeNo, LTRIM(RTRIM(MA003)) MtlItemTypeName
                            FROM INVMA
                            WHERE 1=1";
                    erps = sqlConnection.Query<Erp>(sql, dynamicParameters).ToList();

                    mtlItems = mtlItems.GroupJoin(erps, x => x.TypeOne, y => y.MtlItemTypeNo, (x, y) => { x.TypeOneName = y.FirstOrDefault()?.MtlItemTypeName ?? ""; return x; }).ToList();
                    mtlItems = mtlItems.GroupJoin(erps, x => x.TypeTwo, y => y.MtlItemTypeNo, (x, y) => { x.TypeTwoName = y.FirstOrDefault()?.MtlItemTypeName ?? ""; return x; }).ToList();
                    mtlItems = mtlItems.GroupJoin(erps, x => x.TypeThree, y => y.MtlItemTypeNo, (x, y) => { x.TypeThreeName = y.FirstOrDefault()?.MtlItemTypeName ?? ""; return x; }).ToList();
                    mtlItems = mtlItems.GroupJoin(erps, x => x.TypeFour, y => y.MtlItemTypeNo, (x, y) => { x.TypeFourName = y.FirstOrDefault()?.MtlItemTypeName ?? ""; return x; }).ToList();
                    #endregion

                    #region //撈取品號總庫存量
                    int i = 0;
                    foreach (var item in mtlItems)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT ISNULL(SUM(a.MC007), 0) TotalQty
                                FROM INVMC a 
                                WHERE MC001 = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", item.MtlItemNo);

                        var INVMCResult = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item2 in INVMCResult)
                        {
                            mtlItems[i].TotalInventoryQty = Convert.ToDouble(item2.TotalQty);
                        }

                        i++;
                    }

                    #endregion
                }

                mtlItems.ForEach(item =>
                {
                    item.ErpStatus = MB001s.FirstOrDefault(f => f == item.MtlItemNo) == null ? "N" : "Y";
                });

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    data = mtlItems
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCustomerMtlItem -- 取得客戶品號資料 -- Zoey 2022.07.14
        public string GetCustomerMtlItem(int CustomerMtlItemId, int MtlItemId, int CustomerId, string CustomerMtlItemNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.CustomerMtlItemId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MtlItemId, a.CustomerId, ISNULL(a.PoErpFullNo, '') AS PoErpFullNo, ISNULL(a.PoSeq, '') PoSeq, a.CustomerMtlItemNo, a.CustomerMtlItemName, a.CustomerMtlItemSpec, a.TransferStatus
                          , b.CustomerNo, b.CustomerShortName, b.CustomerName
                          , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                          , d.*";
                    sqlQuery.mainTables =
                        @"FROM PDM.CustomerMtlItem a
                          INNER JOIN SCM.Customer b ON b.CustomerId = a.CustomerId
                          INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                          OUTER APPLY (
                            SELECT da.TypeDesc AS CompanyId
                            FROM BAS.[Type] da
                            WHERE da.TypeSchema = 'So.CorpType'
                            AND da.TypeNo = a.CustomerId
                          ) d";
                    sqlQuery.auxTables = "";
                    string queryCondition = "";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerMtlItemId", @" AND a.CustomerMtlItemId = @CustomerMtlItemId", CustomerMtlItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemId", @" AND a.MtlItemId = @MtlItemId", MtlItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerId", @" AND a.CustomerId = @CustomerId", CustomerId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerMtlItemNo", @" AND a.CustomerMtlItemNo LIKE '%' + @CustomerMtlItemNo + '%'", CustomerMtlItemNo);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.CustomerMtlItemId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;
                    var resultCustMtlItem = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery).ToList();

                    List<dynamic> resultErp = new List<dynamic>();

                    #region //取得集團內客戶公司別
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT a.TypeNo, a.TypeDesc
                            FROM BAS.[Type] a
                            INNER JOIN SCM.Customer b ON b.CustomerId = a.TypeNo
                            INNER JOIN BAS.Company c ON c.CompanyId = a.TypeDesc
                            WHERE a.TypeSchema = 'So.CorpType'
                            AND a.TypeNo IN @CustomerIds";
                    dynamicParameters.Add("CustomerIds", resultCustMtlItem.Select(s => s.CustomerId));
                    var resultCustCorp = sqlConnection.Query(sql, dynamicParameters).ToList();
                    //var companyId = -1;
                    //foreach (var item in resultCustCorp)
                    //{
                    //    int.TryParse(item.TypeDesc, out companyId);
                    //}
                    #endregion

                    foreach (var companyId in resultCustCorp.Select(s => { int.TryParse((string)s.TypeDesc, out int companyId); return companyId; }).Distinct())
                    {
                        //int.TryParse(corp.TypeDesc, out int companyId);
                        if (companyId == 0) continue;

                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", companyId);
                        var companyResult = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        if (!string.IsNullOrWhiteSpace(ErpConnectionStrings))
                        {
                            using (SqlConnection erpConnection = new SqlConnection(ErpConnectionStrings))
                            {
                                #region //取得客戶ERP採購單
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT c.MainKey
                                        , a.COMPANY
                                        , @CompanyId AS CompanyId
                                        , LTRIM(RTRIM(a.TD001)) + '-' + LTRIM(RTRIM(a.TD002)) AS PoErpFullNo
                                        , LTRIM(RTRIM(a.TD001)) AS TD001, LTRIM(RTRIM(a.TD002)) AS TD002, LTRIM(RTRIM(a.TD003)) PoSeq
                                        , LTRIM(RTRIM(b.ML002)) AS ML002, LTRIM(RTRIM(b.ML003)) AS ML003
                                        FROM PURTD a
                                        INNER JOIN CMSML b ON b.COMPANY = a.COMPANY
                                        OUTER APPLY(SELECT LTRIM(RTRIM(TD001)) + LTRIM(RTRIM(TD002)) + LTRIM(RTRIM(TD003)) AS MainKey FROM PURTD WHERE TD001 = a.TD001 AND TD002 = a.TD002 AND TD003 = a.TD003) c
                                        WHERE LTRIM(RTRIM(a.TD001)) + '-' + LTRIM(RTRIM(a.TD002)) IN @PoErpFullNos
                                        AND LTRIM(RTRIM(a.TD003)) IN @PoSeqs";
                                dynamicParameters.Add("CompanyId", companyId);
                                dynamicParameters.Add("PoErpFullNos", resultCustMtlItem.Select(s => s.PoErpFullNo));
                                dynamicParameters.Add("PoSeqs", resultCustMtlItem.Select(s => s.PoSeq));
                                resultErp.AddRange(erpConnection.Query(sql, dynamicParameters).ToList());
                                #endregion
                            }
                        }
                    }

                    #region //資料集合處理
                    var result = (from s1 in resultCustMtlItem
                                  join s2 in resultErp
                                    on new { PoErpFullNo = (string)s1.PoErpFullNo, PoSeq = (string)s1.PoSeq, CompanyId = Convert.ToInt32(s1.CompanyId) } 
                                        equals new { PoErpFullNo = (string)s2.PoErpFullNo, PoSeq = (string)s2.PoSeq, CompanyId = Convert.ToInt32(s2.CompanyId) } into a1
                                  from s2 in a1.DefaultIfEmpty()
                                  select new
                                  {
                                      s1.CustomerMtlItemId,
                                      s1.MtlItemId,
                                      s1.CustomerId,
                                      s1.PoErpFullNo,
                                      s1.PoSeq,
                                      s1.CustomerMtlItemNo,
                                      s1.CustomerMtlItemName,
                                      s1.CustomerMtlItemSpec,
                                      s1.CustomerNo,
                                      s1.CustomerShortName,
                                      s1.CustomerName,
                                      s1.MtlItemNo,
                                      s1.MtlItemName,
                                      s1.MtlItemSpec,
                                      s1.TransferStatus,
                                      CompanyName = s2?.ML002 ?? "",
                                      CompanyFullName = s2?.ML003 ?? "",
                                      s1.TotalCount
                                  })
                                  .OrderBy(o => o.CustomerMtlItemId);
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBillOfMaterials -- 取得Bom主件資料 -- Zoey 2022.12.05
        public string GetBillOfMaterials(int BomId, int MtlItemId)
        {
            try
            {
                List<BillOfMaterials> boms = new List<BillOfMaterials>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    sql = @"SELECT a.BomId, a.MtlItemId, a.UomId, a.StandardLot, a.WipPrefix, a.ModiPrefix, a.ModiNo, a.ModiSequence, a.Version
                            , a.Remark, a.ConfirmStatus, a.ConfirmUserId, a.ConfirmDate, a.TransferStatus, a.TransferDate, a.Status
                            , b.UomNo
                            FROM PDM.BillOfMaterials a
                            INNER JOIN PDM.UnitOfMeasure b ON a.UomId = b.UomId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BomId", @" AND a.BomId = @BomId", BomId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemId", @" AND a.MtlItemId = @MtlItemId", MtlItemId);

                    boms = sqlConnection.Query<BillOfMaterials>(sql, dynamicParameters).ToList();
                }
                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    List<Erp> erps = new List<Erp>();

                    #region //撈取製令單別
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT LTRIM(RTRIM(MQ001)) WipPrefix, LTRIM(RTRIM(MQ002)) WipPrefixName 
                            FROM CMSMQ 
                            LEFT JOIN CMSMU ON MQ001 = MU001 
                            WHERE (MQ003 = '51' OR MQ003 = '52')  
                            AND ((MU003 = 'DS' AND MQ029 = 'Y')  OR MQ029 = 'N' )";
                    erps = sqlConnection.Query<Erp>(sql, dynamicParameters).ToList();

                    boms = boms.GroupJoin(erps, x => x.WipPrefix, y => y.WipPrefix, (x, y) => { x.WipPrefixName = y.FirstOrDefault()?.WipPrefixName ?? ""; return x; }).ToList();
                    #endregion
                }

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    data = boms
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomDetail -- 取得Bom元件資料 -- Zoey 2022.12.05 
        public string GetBomDetail(int BomDetailId, int BomId, int MtlItemId,string HideFlag)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    string nowDateTime = DateTime.Now.ToString("yyyy-MM-dd");
                    sql = @"SELECT a.BomDetailId, a.BomId, a.BomSequence, a.MtlItemId, a.UomId, a.CompositionQuantity, a.Base, a.LossRate,a.StandardCostingType,a.MaterialProperties
                            , ISNULL(FORMAT(a.EffectiveDate, 'yyyy-MM-dd'), '') EffectiveDate, ISNULL(FORMAT(a.ExpirationDate, 'yyyy-MM-dd'), '') ExpirationDate
                            , a.ReleaseItem, a.Remark, a.SubstitutionRemark, a.ConfirmStatus, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm') CreateDate
                            , b.TransferStatus
                            , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                            , d.UomNo, a.ComponentType
                            , CASE WHEN GETDATE() BETWEEN ISNULL(a.EffectiveDate, '1900-01-01') AND ISNULL(a.ExpirationDate, '9999-01-01') THEN 1 ELSE 0 END AS Effective
                            FROM PDM.BomDetail a
                            INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                            INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BomDetailId", @" AND a.BomDetailId = @BomDetailId", BomDetailId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BomId", @" AND a.BomId = @BomId", BomId);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemId", @" AND b.MtlItemId  = @MtlItemId", MtlItemId);
                    if (HideFlag=="Y") { BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "nowDateTime", @" AND (a.EffectiveDate<@nowDateTime OR a.EffectiveDate IS NULL) AND (a.ExpirationDate>@nowDateTime OR a.ExpirationDate IS NULL) ", nowDateTime); }
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomSequence - 取得Bom元件序號資料 -- Zoey 2022.12.06
        public string GetBomSequence(int BomId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT ISNULL(MAX(a.BomSequence), 0) BomSequence FROM PDM.BomDetail a
                            WHERE a.BomId = @BomId";

                    dynamicParameters.Add("BomId", BomId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetRdDesign - 取得研發設計圖資料 -- Zoey 2022.12.06
        public string GetRdDesign(int MtlItemId, string CustomerMtlItemNo, string MtlItemIsNull, string ReleasedStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.DesignId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.CustomerMtlItemNo RdCustomerMtlItemNo
                          , b.ControlId, b.Edition CustCadEdition, b.Version CustCadVersion
                          , c.CadId, c.CustomerDwgNo, c.CustomerMtlItemNo
                          , (
                                SELECT x.ControlId, x.Edition RdDesignEdition, x.Version RdDesignVersion, x.Cause
                                , FORMAT(x.DesignDate, 'yyyy-MM-dd') DesignDate, x.Cad2DFile, x.Pdf2DFile
                                , x.Cad2DFileAbsolutePath, x.Pdf2DFileAbsolutePath
                                , xa.[FileName] Cad2DFileName, xa.FileExtension Cad2DFileExtension
                                , xb.[FileName] Pdf2DFileName, xb.FileExtension Pdf2DFileExtension
                                FROM PDM.RdDesignControl x
                                LEFT JOIN BAS.[File] xa ON x.Cad2DFile = xa.FileId
                                LEFT JOIN BAS.[File] xb ON x.Pdf2DFile = xb.FileId
                                WHERE x.DesignId = a.DesignId AND x.ReleasedStatus = 'Y'
                                FOR JSON PATH, ROOT('data')
                            ) RdDesignControl";
                    sqlQuery.mainTables =
                        @"FROM PDM.RdDesign a
                          LEFT JOIN PDM.CustomerCadControl b ON b.ControlId = a.CustomerCadControlId
                          LEFT JOIN PDM.CustomerCad c ON c.CadId = b.CadId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.CompanyId = @CompanyId
                                              AND b.ReleasedStatus = 'Y'";
                    if (MtlItemIsNull == "Y") queryCondition += @"AND a.MtlItemId IS NULL";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemId", @" AND a.MtlItemId = @MtlItemId", MtlItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "CustomerMtlItemNo", @" AND a.CustomerMtlItemNo LIKE '%' + @CustomerMtlItemNo + '%'", CustomerMtlItemNo);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.DesignId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomSubstitution - 取得取替代料資料 -- Zoey 2022.12.08
        public string GetBomSubstitution(int MtlItemId, int SubstitutionId, int BomDetailId, int SubMtlItemId, string SubstituteStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.SubstitutionId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.BomDetailId, a.SubstituteStatus, a.MtlItemId
                          , a.Quantity, a.SortNumber, a.Precedence, a.Remark,a.TransferStatus
                          , FORMAT(a.EffectiveDate, 'yyyy-MM-dd') EffectiveDate
                          , FORMAT(a.ExpirationDate, 'yyyy-MM-dd') ExpirationDate
                          , d.MtlItemNo SubMtlNo, d.MtlItemName SubMtlName
                          , e.MtlItemNo DetailMtlNo, e.MtlItemName DetailMtlName";
                    sqlQuery.mainTables =
                        @"FROM PDM.BomSubstitution a
                          INNER JOIN PDM.BomDetail b ON b.BomDetailId = a.BomDetailId
                          INNER JOIN PDM.BillOfMaterials c ON c.BomId = b.BomId
                          INNER JOIN PDM.MtlItem d ON d.MtlItemId = a.MtlItemId
                          INNER JOIN PDM.MtlItem e ON e.MtlItemId = b.MtlItemId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND c.MtlItemId = @MtlItemId";
                    dynamicParameters.Add("MtlItemId", MtlItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SubstitutionId", @" AND a.SubstitutionId = @SubstitutionId", SubstitutionId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "BomDetailId", @" AND a.BomDetailId = @BomDetailId", BomDetailId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SubMtlItemId", @" AND a.MtlItemId = @SubMtlItemId", SubMtlItemId);
                    if (SubstituteStatus.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SubstituteStatus", @" AND a.SubstituteStatus IN @SubstituteStatus", SubstituteStatus.Split(','));
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.BomDetailId, a.SortNumber";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlItemSetting - 取得品號設定資料 -- Zoey 2023.02.01
        public string GetMtlItemSetting(int MtlItemId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT a.MtlItemId, a.FixedLeadTime, a.ChangeLeadTime, a.MinPoQty, a.MultiplePoQty, a.MultipleReqQty
                            FROM PDM.MtlItemSetting a
                            WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemId", @" AND a.MtlItemId  = @MtlItemId", MtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlItemItNoSetteing - 取得品號結構設定-- Zoey 2023.02.01
        public string GetMtlItemItNoSetteing(int MtlItemId, int ItemTypeId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sql = @"SELECT b.StatusName SegmentValue,a.SaveValue,a.SegmentType,a.SegmentSort,a.SuffixCode FROM PDM.MtlItemSegment a  
                            INNER JOIN BAS.[Status] b ON a.SegmentValue = b.StatusNo AND b.StatusSchema = 'ItemTypeSegment.SegmentValueDate'
                            WHERE a.MtlItemId = @MtlItemId
                            AND a.SegmentType = 'D'
                            UNION ALL
                            SELECT a.SegmentValue SegmentValue,a.SaveValue,a.SegmentType,a.SegmentSort,a.SuffixCode FROM PDM.MtlItemSegment a  
                            WHERE a.MtlItemId = @MtlItemId
                            AND a.SegmentType = 'F'
                            UNION ALL
                            SELECT a.SegmentValue SegmentValue,a.SaveValue,a.SegmentType,a.SegmentSort,a.SuffixCode FROM PDM.MtlItemSegment a  
                            WHERE a.MtlItemId = @MtlItemId
                            AND a.SegmentType = 'C'
                            UNION ALL
                            SELECT a.SegmentValue SegmentValue,a.SaveValue,a.SegmentType,a.SegmentSort,a.SuffixCode FROM PDM.MtlItemSegment a  
                            WHERE a.MtlItemId = @MtlItemId
                            AND a.SegmentType = 'S'
                            UNION ALL
                            SELECT a.SegmentValue SegmentValue,a.SaveValue,a.SegmentType,a.SegmentSort,a.SuffixCode FROM PDM.MtlItemSegment a  
                            INNER JOIN PDM.ItemSegmentValue b ON a.SegmentValue = b.SegmentValueId
                            WHERE a.MtlItemId = @MtlItemId
                            AND a.SegmentType = 'SV'
                            ORDER BY SegmentSort";
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetCheckMtlItemName - 判斷品名是否重複 -- Shintokuro 2023.06.16
        public string GetCheckMtlItemName(string MtlItemName)
        {
            try
            {
                string ErpDbName = "";
                string ErpNo = "";
                string companyNo = "";
                string RepeatStr = "";
                string RepeatStatus = "N";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //確認公司別DB
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb,a.CompanyNo
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var companyResult = sqlConnection.Query(sql, dynamicParameters);

                    if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        ErpDbName = ErpConnectionStrings.Split('=')[2].Split(';')[0];
                        ErpNo = item.ErpNo;
                        companyNo = item.CompanyNo;
                    }
                    #endregion

                    #region //判斷品名是否重複
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 a.MtlItemName
                            FROM PDM.MtlItem a
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemName", @" AND a.MtlItemName  = @MtlItemName", MtlItemName);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() > 0)
                    {
                        RepeatStatus = "Y";
                    }
                    #endregion
                }
                if (RepeatStatus == "Y")
                {
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //ERP公司代碼取得
                        string CompanyNoErp = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ML001  
                                FROM CMSML";
                        var resultCompanyNo = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultCompanyNo)
                        {
                            CompanyNoErp = item.ML001;
                        }
                        if (ErpNo != CompanyNoErp) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                        #endregion

                        #region //取得ERP基礎參數設定
                        string MtlItemNameRepeatSettingERP = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MA037  
                                FROM CMSMA";
                        var resultMtlItemNameRepeatSettingERP = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultMtlItemNameRepeatSettingERP)
                        {
                            MtlItemNameRepeatSettingERP = item.MA037;
                        }
                        switch (MtlItemNameRepeatSettingERP)
                        {
                            case "1":
                                RepeatStr += "【品號管理】－ERP設定品名不可以重複";
                                throw new SystemException(RepeatStr);
                            case "2":
                                RepeatStr += "【品號管理】－ERP設定品名可以重複";
                                throw new SystemException(RepeatStr);
                            case "3":
                                RepeatStr += "【品號管理】－ERP設定不管控品名";
                                break;
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = ""
                        });
                        #endregion
                    }
                }
                else
                {
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = ""
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//GetMtlChangeEdition 查詢品號變更單目前版本
        public string GetMtlChangeEdition(int MtlItemId)
        {
            try
            {

                string MtlItemNo = "";
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);



                    var companyResult = sqlConnection.Query(sql, dynamicParameters);
                    if (companyResult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in companyResult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion



                    sql = @"SELECT MtlItemId, MtlItemNo 
                            FROM PDM.MtlItem
                            WHERE MtlItemId = @MtlItemId";
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    MtlItemNo = result.First().MtlItemNo;




                }
                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {

                    #region //取得ERP版本
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT MAX(TL004) ChangeEdition
                                    FROM INVTL
                                    WHERE TL014 = 'Y' AND RTRIM(LTRIM(TL001)) = @TL001";
                    dynamicParameters.Add("TL001", MtlItemNo);
                    var erpEdition = sqlConnection.Query(sql, dynamicParameters);


                    #endregion//

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = erpEdition
                    });
                    #endregion

                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBOMList --取得複製BOM用列表 --GPai 20230530
        public string GetBOMList(int CurrentMtlItemId, string MtlItem, string TransferStatus
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                var notMtlItemNo = "";
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");
                    #endregion

                    #region //取得品號 
                    if (CurrentMtlItemId > 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemNo 
                            FROM PDM.MtlItem
                            WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", CurrentMtlItemId);

                        var mtlItemResult = sqlConnection.Query(sql, dynamicParameters);
                        notMtlItemNo = mtlItemResult.First().MtlItemNo;
                    }

                    #endregion

                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.BomId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MtlItemId, l.MtlItemNo, l.MtlItemName, l.MtlItemSpec, l.ItemAttribute, a.UomId, a.StandardLot, a.WipPrefix, a.ModiPrefix, a.ModiNo, a.ModiSequence, a.Version
                            , a.Remark, a.ConfirmStatus, a.ConfirmUserId, a.ConfirmDate, a.TransferStatus, a.TransferDate, a.Status, b.UomNo, a.UomId
                            ,(SELECT c.BomDetailId, a.BomId, c.BomSequence, c.MtlItemId, c.UomId, c.CompositionQuantity, c.Base, c.LossRate
                            	, ISNULL(FORMAT(c.EffectiveDate, 'yyyy-MM-dd'), '') EffectiveDate, FORMAT(c.ExpirationDate, 'yyyy-MM-dd') ExpirationDate
                            	, c.ReleaseItem, c.Remark, c.SubstitutionRemark, c.ConfirmStatus, FORMAT(a.CreateDate, 'yyyy-MM-dd') CreateDate
                            	, d.TransferStatus, e.MtlItemNo, e.MtlItemName, e.MtlItemSpec, f.UomNo
                            	FROM PDM.BomDetail c
                            	INNER JOIN PDM.BillOfMaterials d ON d.BomId = c.BomId
                            	INNER JOIN PDM.MtlItem e ON e.MtlItemId = c.MtlItemId
                            	INNER JOIN PDM.UnitOfMeasure f ON c.UomId = f.UomId
                            	WHERE 1=1 AND c.BomId = a.BomId AND (CONVERT(varchar(10),c.ExpirationDate, 120)  >= @Date OR c.ExpirationDate IS NULL)
                            	FOR JSON PATH, ROOT('data')
                            ) BOMDetail
                            ,(SELECT g.SubstitutionId, g.BomDetailId, g.SubstituteStatus, g.MtlItemId, g.Quantity, g.SortNumber, g.Precedence, g.Remark
                            	, FORMAT(g.EffectiveDate, 'yyyy-MM-dd') EffectiveDate, FORMAT(g.ExpirationDate, 'yyyy-MM-dd') ExpirationDate,FORMAT(i.CreateDate, 'yyyy-MM-dd') CreateDate
                            	, j.MtlItemNo SubMtlNo, j.MtlItemName SubMtlName, k.MtlItemNo DetailMtlNo, k.MtlItemName DetailMtlName,h.Base,h.LossRate, m.UomNo
                            	FROM PDM.BomSubstitution g
                            	INNER JOIN PDM.BomDetail h ON h.BomDetailId = g.BomDetailId
                            	INNER JOIN PDM.BillOfMaterials i ON i.BomId = h.BomId
                            	INNER JOIN PDM.MtlItem j ON j.MtlItemId = g.MtlItemId
                            	INNER JOIN PDM.MtlItem k ON k.MtlItemId = h.MtlItemId
                            	INNER JOIN PDM.UnitOfMeasure m ON h.UomId = m.UomId
                            	AND i.MtlItemId = a.MtlItemId AND (CONVERT(varchar(10),g.ExpirationDate, 120)  >= @Date OR g.ExpirationDate IS NULL)
                            	FOR JSON PATH, ROOT('data')
                            ) BomSubstitution";
                    sqlQuery.mainTables =
                        @"FROM PDM.BillOfMaterials a
                          INNER JOIN PDM.UnitOfMeasure b ON a.UomId = b.UomId
                          INNER JOIN PDM.MtlItem l ON l.MtlItemId = a.MtlItemId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND 1=1 AND l.CompanyId = @CompanyId ";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("Date", DateTime.Now.ToString("yyyy-MM-dd"));


                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NotMtlItemNo", @" AND l.MtlItemNo != @NotMtlItemNo", notMtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItem", @" AND (l.MtlItemNo LIKE '%' + @MtlItem + '%' 
                                                                                                        OR l.MtlItemName LIKE '%' + @MtlItem + '%' 
                                                                                                        )", MtlItem.ToUpper());
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferStatus", @" AND a.TransferStatus = @TransferStatus", TransferStatus);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.BomId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result1 = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result1
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlItemUomCalculate -- 取得品號單位換算 -- Shintokuro 2023.06.14
        public string GetMtlItemUomCalculate(int MtlItemId, int MtlItemUomCalculateId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sqlQuery.mainKey = "a.MtlItemUomCalculateId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @" , a.MtlItemId, a.UomId, a.ConvertUomId, a.SwapDenominator, a.SwapNumerator, a.TransferStatus
                           , (b.UomNo + ' ' + b.UomName) UomNo
                           , (c.UomNo + ' ' + c.UomName) ConvertUomNo
                          ";
                    sqlQuery.mainTables =
                        @"FROM PDM.MtlItemUomCalculate a
                          INNER JOIN PDM.UnitOfMeasure b on a.UomId = b.UomId
                          INNER JOIN PDM.UnitOfMeasure c on a.ConvertUomId = c.UomId
                         ";
                    string queryTable = "";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @"";
                    dynamicParameters.Add("MtlItemId", MtlItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemId", @" AND a.MtlItemId = @MtlItemId", MtlItemId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemUomCalculateId", @" AND a.MtlItemUomCalculateId = @MtlItemUomCalculateId", MtlItemUomCalculateId);


                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MtlItemUomCalculateId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlItemUomCalculateSimple -- 取得品號單位換算(下拉用) -- Shintokuro 2023.06.14
        public string GetMtlItemUomCalculateSimple(int MtlItemId)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷品號是否存在
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ConvertUomId 
                            , (b.UomNo + ' ' + b.UomName) UomNo
                            , (c.UomNo + ' ' + c.UomName) ConvertUomNo
                            FROM PDM.MtlItemUomCalculate a
                            INNER JOIN PDM.UnitOfMeasure b on a.UomId = b.UomId
                            INNER JOIN PDM.UnitOfMeasure c on a.ConvertUomId = c.UomId
                            WHERE a.MtlItemId = @MtlItemId
                            UNION
                            SELECT a.InventoryUomId ConvertUomId
                            , '' UomNo
                            , (b.UomNo + ' ' + b.UomName) ConvertUomNo
                            FROM PDM.MtlItem a
                            INNER JOIN PDM.UnitOfMeasure b on a.InventoryUomId = b.UomId
                            WHERE a.MtlItemId = @MtlItemId
                            ";
                    dynamicParameters.Add("MtlItemId", MtlItemId);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【品號單位換算】－品號不存在，請重新輸入!");
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlChangeData --取得品號變更列表 --GPai 20230615
        public string GetMtlChangeData(string SearchKey, string ChangeEdition, string TransferStatus, string ConfirmStatus, string StartDate, string EndDate, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                List<MtlItemChange> mtlItemChanges = new List<MtlItemChange>();
                List<MtlItemChangeDetail> mtlItemChangeDetails = new List<MtlItemChangeDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //取得單頭
                    sqlQuery.mainKey = "a.MtlItemChangeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.MtlItemId, c.MtlItemNo, a.ChangeEdition, a.OriginalEdition, a.OriginalMtlItemName, a.OriginalMtlItemSpec, a.NewMtlItemName, a.NewMtlItemSpec, a.ConfirmStatus
                          , ISNULL (d.UserNo,'') UpdateUserNo, ISNULL (d.UserName,'') UpdateUserName, ISNULL (FORMAT (a.ChangeDate, 'yyyy-MM-dd'), '')ChangeDate, ISNULL(e.UserNo,'') ConfirmUserNo, ISNULL(e.UserName,'') ConfirmUserName, FORMAT (a.ConfirmDate, 'yyyy-MM-dd HH:MM:ss')ConfirmDate
                          , ISNULL (FORMAT (a.TransferDate, 'yyyy-MM-dd'), '')TransferDate, a.TransferStatus, a.Remark, a.CreateDate";
                    sqlQuery.mainTables =
                        @"FROM PDM.MtlItemChange a
                          INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                          left JOIN BAS.[User] d ON d.UserId = a.UpdateBy
                          left JOIN BAS.[User] e ON e.UserId = a.ConfirmBy";
                    string queryTable = @"";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @"AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SearchKey", @" AND (c.MtlItemNo LIKE '%' + @SearchKey + '%') ", SearchKey);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ChangeEdition", @" AND a.ChangeEdition = @ChangeEdition ", ChangeEdition);
                    if (TransferStatus.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferStatus", @" AND a.TransferStatus IN @TransferStatus", TransferStatus.Split(','));
                    if (ConfirmStatus.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ConfirmStatus", @" AND a.ConfirmStatus IN @ConfirmStatus", ConfirmStatus.Split(','));
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.CreateDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.CreateDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MtlItemChangeId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    mtlItemChanges = BaseHelper.SqlQuery<MtlItemChange>(sqlConnection, dynamicParameters, sqlQuery);
                    #endregion

                    #region //取得單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MtlChangeDetailId, a.MtlItemChangeId, a.SortNum, a.FieldNum, a.FieldName, a.NewTextField, ISNULL (a.OriginalTextField,'') OriginalTextField, a.NewNumericField, a.OriginalNumericField, a.NewFieldName, ISNULL (a.OriginalFieldName,'') OriginalFieldName, a.Remark
                            FROM PDM.MtlItemChangeDetail a
                            INNER JOIN PDM.MtlItemChange b ON a.MtlItemChangeId = b.MtlItemChangeId
                            WHERE b.CompanyId = @CompanyId AND a.MtlItemChangeId IN @MtlItemChangeIds
                            ORDER BY a.MtlChangeDetailId DESC";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("MtlItemChangeIds", mtlItemChanges.Select(x => x.MtlItemChangeId).ToArray());

                    mtlItemChangeDetails = sqlConnection.Query<MtlItemChangeDetail>(sql, dynamicParameters).ToList();

                    mtlItemChanges
                        .ToList()
                        .ForEach(x =>
                        {
                            x.MtlItemChangeDetails = mtlItemChangeDetails
                                                    .Where(y => y.MtlItemChangeId == x.MtlItemChangeId)
                                                    .Select(y =>
                                                    new MtlItemChangeDetail
                                                    {
                                                        MtlChangeDetailId = y.MtlChangeDetailId,
                                                        MtlItemChangeId = y.MtlItemChangeId,
                                                        SortNum = y.SortNum,
                                                        FieldNum = y.FieldNum,
                                                        FieldName = y.FieldName,
                                                        NewTextField = y.NewTextField,
                                                        OriginalTextField = y.OriginalTextField,
                                                        NewNumericField = y.NewNumericField,
                                                        OriginalNumericField = y.OriginalNumericField,
                                                        NewFieldName = y.NewFieldName,
                                                        OriginalFieldName = y.OriginalFieldName,
                                                        Remark = y.Remark
                                                    }).ToList();
                        });

                    #endregion


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = mtlItemChanges
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlChangeDetail --取得該筆品號變更 --GPai 20230615
        public string GetMtlChangeDetail(int MtlItemChangeId, string ChangeEdition)
        {
            try
            {
                List<MtlItemChange> mtlItemChanges = new List<MtlItemChange>();
                List<MtlItemChangeDetail> mtlItemChangeDetails = new List<MtlItemChangeDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //取得單頭

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MtlItemChangeId, a.MtlItemId, c.MtlItemNo, a.ChangeEdition, a.OriginalEdition, a.OriginalMtlItemName, a.OriginalMtlItemSpec, a.NewMtlItemName, a.NewMtlItemSpec
                          , ISNULL (d.UserNo,'') UpdateUserNo, ISNULL (d.UserName,'') UpdateUserName, FORMAT (a.ChangeDate, 'yyyy-MM-dd HH:MM:ss')ChangeDate, ISNULL(e.UserNo,'') ConfirmUserNo, ISNULL(e.UserName,'') ConfirmUserName, FORMAT (a.ConfirmDate, 'yyyy-MM-dd HH:MM:ss')ConfirmDate
                          , FORMAT (a.TransferDate, 'yyyy-MM-dd HH:MM:ss')TransferDate, a.TransferStatus, a.Remark, a.ConfirmStatus
                            FROM PDM.MtlItemChange a
                          INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                          left JOIN BAS.[User] d ON d.UserId = a.UpdateBy
                          left JOIN BAS.[User] e ON e.UserId = a.ConfirmBy
                            WHERE a.CompanyId = @CompanyId AND a.MtlItemChangeId = @MtlItemChangeId AND a.ChangeEdition = @ChangeEdition
                            ORDER BY a.MtlItemChangeId DESC";
                    dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("ChangeEdition", ChangeEdition);

                    mtlItemChanges = sqlConnection.Query<MtlItemChange>(sql, dynamicParameters).ToList();
                    #endregion

                    #region //取得單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MtlChangeDetailId, a.MtlItemChangeId, a.SortNum, a.FieldNum, a.FieldName, a.NewTextField, ISNULL (a.OriginalTextField,'') OriginalTextField, a.NewNumericField, a.OriginalNumericField, a.NewFieldName, ISNULL (a.OriginalFieldName,'') OriginalFieldName, a.Remark
                            FROM PDM.MtlItemChangeDetail a
                            INNER JOIN PDM.MtlItemChange b ON a.MtlItemChangeId = b.MtlItemChangeId
                            WHERE b.CompanyId = @CompanyId AND a.MtlItemChangeId = @MtlItemChangeId AND b.ChangeEdition = @ChangeEdition
                            ORDER BY a.MtlChangeDetailId DESC";
                    dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("ChangeEdition", ChangeEdition);

                    mtlItemChangeDetails = sqlConnection.Query<MtlItemChangeDetail>(sql, dynamicParameters).ToList();

                    mtlItemChanges
                        .ToList()
                        .ForEach(x =>
                        {
                            x.MtlItemChangeDetails = mtlItemChangeDetails
                                                    .Where(y => y.MtlItemChangeId == x.MtlItemChangeId)
                                                    .Select(y =>
                                                    new MtlItemChangeDetail
                                                    {
                                                        MtlChangeDetailId = y.MtlChangeDetailId,
                                                        MtlItemChangeId = y.MtlItemChangeId,
                                                        SortNum = y.SortNum,
                                                        FieldNum = y.FieldNum,
                                                        FieldName = y.FieldName,
                                                        NewTextField = y.NewTextField,
                                                        OriginalTextField = y.OriginalTextField,
                                                        NewNumericField = y.NewNumericField,
                                                        OriginalNumericField = y.OriginalNumericField,
                                                        NewFieldName = y.NewFieldName,
                                                        OriginalFieldName = y.OriginalFieldName,
                                                        Remark = y.Remark
                                                    }).ToList();
                        });

                    #endregion


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = mtlItemChanges
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlChangeDetailEdit --取得該筆品號變更 --GPai 20230615
        public string GetMtlChangeDetailEdit(int MtlItemChangeDetailId)
        {
            try
            {
                List<MtlItemChange> mtlItemChanges = new List<MtlItemChange>();
                List<MtlItemChangeDetail> mtlItemChangeDetails = new List<MtlItemChangeDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //取得單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.MtlChangeDetailId, a.MtlItemChangeId, a.SortNum, a.FieldNum, a.FieldName, a.NewTextField, ISNULL (a.OriginalTextField,'') OriginalTextField, a.NewNumericField, a.OriginalNumericField, a.NewFieldName, a.OriginalFieldName, a.Remark, a.FieldType
                            FROM PDM.MtlItemChangeDetail a
                            INNER JOIN PDM.MtlItemChange b ON a.MtlItemChangeId = b.MtlItemChangeId 
                            WHERE b.CompanyId = @CompanyId AND a.MtlChangeDetailId = @MtlChangeDetailId
                            ORDER BY a.MtlChangeDetailId DESC";
                    dynamicParameters.Add("MtlChangeDetailId", MtlItemChangeDetailId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    mtlItemChangeDetails = sqlConnection.Query<MtlItemChangeDetail>(sql, dynamicParameters).ToList();

                    #endregion


                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = mtlItemChangeDetails
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomChangeData --取得BOM變更列表 --GPai 20230615
        public string GetBomChangeData(string SearchKey, string TransferStatus, string ConfirmStatus, string StartDate, string EndDate, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                List<BomChange> bomChanges = new List<BomChange>();
                List<BomChangeDetail> bomChangeDetails = new List<BomChangeDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //取得單頭
                    sqlQuery.mainKey = "a.BomChangeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", a.BomChangeNo,a.BomChangePrefix,a.EmergencyCode,a.ChangeReason,a.Remark,a.TransferStatus, a.ConfirmStatus
                          , ISNULL (b.UserNo,'') CreatUserNo, ISNULL (b.UserName,'') CreatUserName,ISNULL (c.UserNo,'') ConfirmUserNo, ISNULL (c.UserName,'') ConfirmUserName
                          , ISNULL (FORMAT (a.ChangeDate, 'yyyy-MM-dd'), '')ChangeDate, ISNULL (FORMAT (a.ConfirmDate, 'yyyy-MM-dd'), '')ConfirmDate, ISNULL (FORMAT (a.TransferDate, 'yyyy-MM-dd'), '')TransferDate";
                    sqlQuery.mainTables =
                        @"FROM PDM.BomChange a 
                          LEFT JOIN BAS.[User] b ON b.UserId = a.CreateBy
                          LEFT JOIN BAS.[User] c ON c.UserId = a.ConfirmBy";
                    string queryTable = @"";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @" AND a.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SearchKey", @" AND (a.BomChangePrefix + '-' + a.BomChangeNo) = @SearchKey ", SearchKey);
                    if (TransferStatus.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "TransferStatus", @" AND a.TransferStatus IN @TransferStatus", TransferStatus.Split(','));
                    if (ConfirmStatus.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "ConfirmStatus", @" AND a.ConfirmStatus IN @ConfirmStatus", ConfirmStatus.Split(','));
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "StartDate", @" AND a.CreateDate >= @StartDate ", StartDate.Length > 0 ? Convert.ToDateTime(StartDate).ToString("yyyy-MM-dd 00:00:00") : "");
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "EndDate", @" AND a.CreateDate <= @EndDate ", EndDate.Length > 0 ? Convert.ToDateTime(EndDate).ToString("yyyy-MM-dd 23:59:59") : "");
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : " a.BomChangeId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    bomChanges = BaseHelper.SqlQuery<BomChange>(sqlConnection, dynamicParameters, sqlQuery);
                    #endregion

                    #region //取得單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BomChangeDetailId, a.BomChangeId, (b.MtlItemNo) NewMtlItemNo, (b.MtlItemName) NewMtlItemName, (b.MtlItemSpec) NewMtlItemSpec, (b.ItemAttribute) NewMtlItemAttribute, (g.TypeName)NewMtlItemAttributeName, (d.UomNo)Unit, a.SmallUnit, a.ChangeEdition, a.StandardLot, a.MoPrefix, a.ChangeReason, a.ConfirmStatus, a.ConfirmCode, a.NewRemark
                            , (c.MtlItemNo) OriginalMtlItemNo, (c.MtlItemName) OriginalMtlItemName, (c.MtlItemSpec) OriginalMtlItemSpec, (c.ItemAttribute) OriginalMtlItemAttribute, h.TypeName, (e.UomNo)OriginalUnit,a.OriginalSmallUnit, a.OriginalChangeEdition, a.OriginalStandardLot,a.OriginalMoPrefix, (f.BomChangeNo) OriginalBomChangeNo , a.OriginalRemark, a.OriginalSortNum, a.BomId
                            FROM PDM.BomChangeDetail a
                            INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.OriginalMtlItemId 
                            INNER JOIN PDM.UnitOfMeasure d ON d.UomId = a.Unit
                            INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.OriginalUnit
                            INNER JOIN PDM.BomChange f ON f.BomChangeId = a.OriginalBomChangeId 
							INNER JOIN BAS.[Type] g ON b.ItemAttribute = g.TypeNo 
							INNER JOIN BAS.[Type] h ON c.ItemAttribute = h.TypeNo 
                            WHERE f.CompanyId = @CompanyId AND a.BomChangeId IN @BomChangeIds AND g.TypeSchema = 'MtlItem.ItemAttribute' AND h.TypeSchema = 'MtlItem.ItemAttribute'
                            ORDER BY a.BomChangeDetailId DESC";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("BomChangeIds", bomChanges.Select(x => x.BomChangeId).ToArray());

                    bomChangeDetails = sqlConnection.Query<BomChangeDetail>(sql, dynamicParameters).ToList();

                    //變更單加單身資料
                    bomChanges
                       .ToList()
                       .ForEach(x =>
                       {
                           x.BomChangeDetail = bomChangeDetails
                                                   .Where(y => y.BomChangeId == x.BomChangeId)
                                                   .Select(y =>
                                                   new BomChangeDetail
                                                   {
                                                       BomChangeDetailId = y.BomChangeDetailId,
                                                       BomChangeId = y.BomChangeId,
                                                       NewMtlItemNo = y.NewMtlItemNo,
                                                       NewMtlItemName = y.NewMtlItemName,
                                                       NewMtlItemSpec = y.NewMtlItemSpec,
                                                       NewMtlItemAttribute = y.NewMtlItemAttribute,
                                                       NewMtlItemAttributeName = y.NewMtlItemAttributeName,
                                                       Unit = y.Unit,
                                                       SmallUnit = y.SmallUnit,
                                                       ChangeEdition = y.ChangeEdition,
                                                       StandardLot = y.StandardLot,
                                                       MoPrefix = y.MoPrefix,
                                                       ChangeReason = y.ChangeReason,
                                                       ConfirmStatus = y.ConfirmStatus,
                                                       ConfirmCode = y.ConfirmCode,
                                                       NewRemark = y.NewRemark,
                                                       BomId = y.BomId
                                                   }).ToList();
                       });
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = bomChanges
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomChangeDetail --取得該筆BOM變更 --GPai 20230627
        public string GetBomChangeDetail(int BomChangeId)
        {
            try
            {
                List<BomChange> bomChanges = new List<BomChange>();
                List<BomChangeDetail> bomChangeDetails = new List<BomChangeDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //取得單頭

                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BomChangeId, a.BomChangeNo,a.BomChangePrefix,a.EmergencyCode,a.ChangeReason,a.Remark,a.TransferStatus,a.ConfirmStatus
                            ,ISNULL (b.UserNo,'') CreatUserNo, ISNULL (b.UserName,'') CreatUserName,ISNULL (c.UserNo,'') ConfirmUserNo, ISNULL (c.UserName,'') ConfirmUserName, ISNULL(FORMAT (a.ChangeDate, 'yyyy-MM-dd'),'')ChangeDate, ISNULL(FORMAT (a.ConfirmDate, 'yyyy-MM-dd'),'')ConfirmDate, ISNULL(FORMAT (a.TransferDate, 'yyyy-MM-dd'),'')TransferDate
                            FROM PDM.BomChange a
                            LEFT JOIN BAS.[User] b ON b.UserId = a.CreateBy
                            LEFT JOIN BAS.[User] c ON c.UserId = a.ConfirmBy
                            WHERE a.CompanyId = @CompanyId AND a.BomChangeId = @BomChangeId
                            ORDER BY a.BomChangeId DESC";
                    dynamicParameters.Add("BomChangeId", BomChangeId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    bomChanges = sqlConnection.Query<BomChange>(sql, dynamicParameters).ToList();
                    #endregion

                    #region //取得單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BomChangeDetailId, a.BomChangeId, (b.MtlItemNo) NewMtlItemNo, (b.MtlItemName) NewMtlItemName, (b.MtlItemSpec) NewMtlItemSpec, (b.ItemAttribute) NewMtlItemAttribute, (g.TypeName)NewMtlItemAttributeName, (d.UomNo)Unit, a.SmallUnit, a.ChangeEdition, a.StandardLot, a.MoPrefix, a.ChangeReason, a.ConfirmStatus, a.ConfirmCode, a.NewRemark
                            , (c.MtlItemNo) OriginalMtlItemNo, (c.MtlItemName) OriginalMtlItemName, (c.MtlItemSpec) OriginalMtlItemSpec, (c.ItemAttribute) OriginalMtlItemAttribute, (h.TypeName) OriginalMtlItemAttributeName, (e.UomNo)OriginalUnit,a.OriginalSmallUnit, a.OriginalChangeEdition, a.OriginalStandardLot,a.OriginalMoPrefix, (f.BomChangeNo) OriginalBomChangeNo , a.OriginalRemark, a.OriginalSortNum, a.BomId
                            FROM PDM.BomChangeDetail a
                            INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.OriginalMtlItemId 
                            INNER JOIN PDM.UnitOfMeasure d ON d.UomId = a.Unit
                            INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.OriginalUnit
                            INNER JOIN PDM.BomChange f ON f.BomChangeId = a.OriginalBomChangeId 
							INNER JOIN BAS.[Type] g ON b.ItemAttribute = g.TypeNo 
							INNER JOIN BAS.[Type] h ON c.ItemAttribute = h.TypeNo 
                            WHERE f.CompanyId = @CompanyId AND a.BomChangeId = @BomChangeId AND g.TypeSchema = 'MtlItem.ItemAttribute' AND h.TypeSchema = 'MtlItem.ItemAttribute'
                            ORDER BY a.BomChangeDetailId DESC";
                    dynamicParameters.Add("BomChangeId", BomChangeId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    bomChangeDetails = sqlConnection.Query<BomChangeDetail>(sql, dynamicParameters).ToList();

                    //變更單加單身資料
                    bomChanges
                       .ToList()
                       .ForEach(x =>
                       {
                           x.BomChangeDetail = bomChangeDetails
                                                   .Where(y => y.BomChangeId == x.BomChangeId)
                                                   .Select(y =>
                                                   new BomChangeDetail
                                                   {
                                                       BomChangeDetailId = y.BomChangeDetailId,
                                                       BomChangeId = y.BomChangeId,
                                                       NewMtlItemNo = y.NewMtlItemNo,
                                                       NewMtlItemName = y.NewMtlItemName,
                                                       NewMtlItemSpec = y.NewMtlItemSpec,
                                                       NewMtlItemAttribute = y.NewMtlItemAttribute,
                                                       NewMtlItemAttributeName = y.NewMtlItemAttributeName,
                                                       Unit = y.Unit,
                                                       SmallUnit = y.SmallUnit,
                                                       ChangeEdition = y.ChangeEdition,
                                                       StandardLot = y.StandardLot,
                                                       MoPrefix = y.MoPrefix,
                                                       ChangeReason = y.ChangeReason,
                                                       ConfirmStatus = y.ConfirmStatus,
                                                       ConfirmCode = y.ConfirmCode,
                                                       NewRemark = y.NewRemark,
                                                       BomId = y.BomId
                                                   }).ToList();
                       });
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = bomChanges
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomChangeDetailEdit --取得該筆BOM變更單身 --GPai 20230627
        public string GetBomChangeDetailEdit(int BomChangeDetailId)
        {
            try
            {
                List<BomChange> bomChanges = new List<BomChange>();
                List<BomChangeDetail> bomChangeDetails = new List<BomChangeDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion


                    #region //取得單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.BomChangeDetailId, a.BomChangeId, (b.MtlItemNo) NewMtlItemNo, (b.MtlItemName) NewMtlItemName, (b.MtlItemSpec) NewMtlItemSpec, (b.ItemAttribute) NewMtlItemAttribute, (g.TypeName)NewMtlItemAttributeName, (d.UomNo)Unit, a.SmallUnit, a.ChangeEdition, a.StandardLot, a.MoPrefix, a.ChangeReason, a.ConfirmStatus, a.ConfirmCode, a.NewRemark
                            , (c.MtlItemNo) OriginalMtlItemNo, (c.MtlItemName) OriginalMtlItemName, (c.MtlItemSpec) OriginalMtlItemSpec, (c.ItemAttribute) OriginalMtlItemAttribute, (h.TypeName) OriginalMtlItemAttributeName, (e.UomNo)OriginalUnit,a.OriginalSmallUnit, a.OriginalChangeEdition, a.OriginalStandardLot,a.OriginalMoPrefix, (f.BomChangeNo) OriginalBomChangeNo , a.OriginalRemark, a.OriginalSortNum, a.BomId
                            FROM PDM.BomChangeDetail a
                            INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.OriginalMtlItemId 
                            INNER JOIN PDM.UnitOfMeasure d ON d.UomId = a.Unit
                            INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.OriginalUnit
                            INNER JOIN PDM.BomChange f ON f.BomChangeId = a.OriginalBomChangeId 
							INNER JOIN BAS.[Type] g ON b.ItemAttribute = g.TypeNo 
							INNER JOIN BAS.[Type] h ON c.ItemAttribute = h.TypeNo 
                            WHERE f.CompanyId = @CompanyId AND a.BomChangeDetailId = @BomChangeDetailId AND g.TypeSchema = 'MtlItem.ItemAttribute' AND h.TypeSchema = 'MtlItem.ItemAttribute'
                            ORDER BY a.BomChangeDetailId DESC";
                    dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    bomChangeDetails = sqlConnection.Query<BomChangeDetail>(sql, dynamicParameters).ToList();

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = bomChangeDetails
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomChangeSubDetailEdit --取得該BOM變更子單身 --GPAI20230714
        public string GetBomChangeSubDetailEdit(int BomChangeSubDetailId)
        {
            try
            {

                List<BomChangeSubDetail> bomChangeSubDetails = new List<BomChangeSubDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //取得子單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT  a.BomChangeId, a.BomChangeDetailId, a.BomChangeSubDetailId, a.BomSortNum , a.BomDetailId, (g.MtlItemNo)NewSubMtlItemNo, (g.MtlItemName)NewSubMtlItemName, (g.MtlItemSpec)NewSubMtlItemSpec, (g.ItemAttribute)NewSubMtlItemAttribute, (h.TypeName)NewSubMtlItemAttributeName
                           , (e.UomNo)SubUnit, (a.SmallUnit)SubSmallUnit, a.Base, a.LossRate, a.CompositionQuantity, a.FeedingInterval, ISNULL(FORMAT(a.EffectiveDate, 'yyyy-MM-dd'), '') EffectiveDate,ISNULL(FORMAT(a.ExpirationDate, 'yyyy-MM-dd'), '') ExpirationDate, a.ChangeReason, a.NewRemark, a.StandardCosting, a.BomType, a.ComponentType
                           FROM PDM.BomChangeSubDetail a
                           INNER JOIN PDM.BomChangeDetail b ON b.BomChangeDetailId = a.BomChangeDetailId
                           INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.Unit
                           INNER JOIN PDM.MtlItem g ON g.MtlItemId = a.MtlItemId 
						   INNER JOIN BAS.[Type] h ON g.ItemAttribute = h.TypeNo 
                           WHERE a.BomChangeSubDetailId = @BomChangeSubDetailId AND h.TypeSchema = 'MtlItem.ItemAttribute'
                           ORDER BY a.BomChangeSubDetailId DESC";
                    dynamicParameters.Add("BomChangeSubDetailId", BomChangeSubDetailId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    bomChangeSubDetails = sqlConnection.Query<BomChangeSubDetail>(sql, dynamicParameters).ToList();
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = bomChangeSubDetails
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetWipPreFix --取得製令單別 --GPai 20230629
        public string GetWipPreFix(string WipPrefix)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion
                }


                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    sql = @"SELECT DISTINCT LTRIM(RTRIM(MQ001)) WipPrefix, LTRIM(RTRIM(MQ002)) WipPrefixName 
                            FROM CMSMQ 
                            LEFT JOIN CMSMU ON MQ001 = MU001 
                            WHERE (MQ003 = '51' OR MQ003 = '52')  
                            AND ((MU003 = 'DS' AND MQ029 = 'Y')  OR MQ029 = 'N' )";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "WipPrefix", @" AND LTRIM(RTRIM(MQ001)) = @WipPrefix ", WipPrefix);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlItemType --取得類別
        public string GetMtlItemType(string Condition, string TypeNo)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion
                }


                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    sql = @"SELECT LTRIM(RTRIM(MA002)) TypeNo, LTRIM(RTRIM(MA003)) TypeName
                                    FROM INVMA 
                                    WHERE 1=1";
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "Condition", @" AND MA001 = @Condition", Condition);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "TypeNo", @" AND LTRIM(RTRIM(MA002)) = @TypeNo", TypeNo);
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomChangeSubDetail --取得該BOM變更子單身 --GPAI20230714
        public string GetBomChangeSubDetail(int BomChangeDetailId)
        {
            try
            {

                List<BomChangeSubDetail> bomChangeSubDetails = new List<BomChangeSubDetail>();

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //取得子單身
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT  a.BomChangeId, a.BomChangeDetailId, a.BomChangeSubDetailId, a.BomSortNum , a.BomDetailId, (g.MtlItemNo)NewSubMtlItemNo, (g.MtlItemName)NewSubMtlItemName, (g.MtlItemSpec)NewSubMtlItemSpec, (g.ItemAttribute)NewSubMtlItemAttribute, (h.TypeName)NewSubMtlItemAttributeName
                           , (e.UomNo)SubUnit, (a.SmallUnit)SubSmallUnit, a.Base, a.LossRate, a.CompositionQuantity, a.FeedingInterval, ISNULL(FORMAT(a.EffectiveDate, 'yyyy-MM-dd'), '') EffectiveDate,ISNULL(FORMAT(a.ExpirationDate, 'yyyy-MM-dd'), '') ExpirationDate, a.ChangeReason, a.NewRemark
                           FROM PDM.BomChangeSubDetail a
                           INNER JOIN PDM.BomChangeDetail b ON b.BomChangeDetailId = a.BomChangeDetailId
                           INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.Unit
                           INNER JOIN PDM.MtlItem g ON g.MtlItemId = a.MtlItemId 
						   INNER JOIN BAS.[Type] h ON g.ItemAttribute = h.TypeNo 
                           WHERE a.BomChangeDetailId = @BomChangeDetailId AND h.TypeSchema = 'MtlItem.ItemAttribute'
                           ORDER BY a.BomChangeSubDetailId DESC";
                    dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    bomChangeSubDetails = sqlConnection.Query<BomChangeSubDetail>(sql, dynamicParameters).ToList();
                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = bomChangeSubDetails
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetBomChangeErpNo --取得BOM變更單Erp編號 --GPAI20230817
        public string GetBomChangeErpNo()
        {
            try
            {
                var mesNo = "";
                var erpNo = "";
                var resultNo = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤:" + UserNo + ":" + UserLock + ":" + CurrentUser + ":" + CurrentCompany);

                    foreach (var item in result)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region //取得MES最新單號
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT MAX(BomChangeNo) BomChangeNo FROM PDM.BomChange";


                    var noResult = sqlConnection.Query(sql, dynamicParameters);
                    mesNo = noResult.First().BomChangeNo;
                    #endregion


                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    #region //取得ERP最新單號
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT MAX(TA002) BomChangeNo FROM BOMTA";


                    var noResult = sqlConnection.Query(sql, dynamicParameters);
                    erpNo = noResult.First().BomChangeNo;
                    #endregion



                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = noResult
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlItemUomCalculateChange 品號換算單位變更表
        public string GetMtlItemUomCalculateChange(string MtlItemChangeId, string OrderBy, int PageIndex, int PageSize)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    
                }


                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                    if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in Companyresult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion


                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.UomChangeId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @" , e.MtlItemChangeId, a.MtlItemId, d.MtlItemNo, d.MtlItemName, d.MtlItemSpec,  a.UomChangeEdit
                           , a.ConvertUomId, (b.UomNo + ' ' + b.UomName) ConvertUomNo, a.SwapNumerator, a.SwapDenominator
                           , a.OriginConvertUomId,(c.UomNo + ' ' + c.UomName) OriginConvertUomNo, a.OriginConvertUomId, a.OriginSwapNumerator, a.OriginSwapDenominator
                           , a.TransferStatus
                          ";
                    sqlQuery.mainTables =
                        @"FROM PDM.MtlItemUomCalculateChange a
                          INNER JOIN PDM.UnitOfMeasure b ON a.ConvertUomId = b.UomId
                          INNER JOIN PDM.UnitOfMeasure c ON a.OriginConvertUomId = c.UomId
                          INNER JOIN PDM.MtlItem d ON a.MtlItemId = d.MtlItemId
                          INNER JOIN PDM.MtlItemChange e ON  a.MtlItemChangeId = e.MtlItemChangeId
                         ";
                    string queryTable = "";
                    sqlQuery.auxTables = queryTable;
                    string queryCondition = @"AND e.MtlItemChangeId = @MtlItemChangeId";
                    dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemId", @" AND a.MtlItemId = @MtlItemId", MtlItemId);
                    //BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemUomCalculateId", @" AND a.MtlItemUomCalculateId = @MtlItemUomCalculateId", MtlItemUomCalculateId);


                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.UomChangeId DESC";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetProduceLine 取得ERP生產線別
        public string GetProduceLine(string ProduceLineNo)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                    if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in Companyresult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    #region //取得ERP最新單號
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT LTRIM(RTRIM(MD001)) ProduceLineNo, LTRIM(RTRIM(MD002)) ProduceLineName
                                    FROM CMSMD
                                    LEFT JOIN CMSMB ON MB001=MD003
                                    WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MD001", @" AND LTRIM(RTRIM(MD001)) = @MD001", ProduceLineNo);
                    var noResult = sqlConnection.Query(sql, dynamicParameters);

                    #endregion



                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = noResult
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GePriceSix 取得ERP品號售價定價六
        public string GePriceSix(string MtlitemNo)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                    if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in Companyresult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    #region //取得ERP
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT LTRIM(RTRIM(MB001)) MB001, MB070
                                    FROM INVMB
                                    WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MB001", @" AND LTRIM(RTRIM(MB001)) = @MB001", MtlitemNo);
                    var noResult = sqlConnection.Query(sql, dynamicParameters);

                    #endregion



                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = noResult
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GeErpUnit 取得ERP單位
        public string GeErpUnit()
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                    if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in Companyresult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    #region //取得ERP
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT UPPER(LTRIM(RTRIM(MX001))) UomNo, LTRIM(RTRIM(MX002)) UomName, LTRIM(RTRIM(MX004)) UomDesc
                                , UPPER(LTRIM(RTRIM(MX001))) + ' ' +  LTRIM(RTRIM(MX002)) UomWithNo
                                , CASE LTRIM(RTRIM(MX003))
                                    WHEN 'Y' THEN 'A'
                                    WHEN 'N' THEN 'S'
                                END Status
                                , CASE WHEN LEN(LTRIM(RTRIM(CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                FROM INVMX
                                WHERE 1=1 AND LTRIM(RTRIM(MX003)) = 'Y'";

                    //BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MX001", @" AND UPPER(LTRIM(RTRIM(MX001))) = @MX001", UomNo);
                    var noResult = sqlConnection.Query(sql, dynamicParameters);

                    #endregion



                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = noResult
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetPreday 取得ERP前置天數
        public string GetPreday(string MtlitemNo)
        {
            try
            {

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    DynamicParameters dynamicParameters = new DynamicParameters();

                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                    if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in Companyresult)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                }

                using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                {
                    #region //取得ERP
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT LTRIM(RTRIM(MB001)) MB001, MB036, MB037
                                    FROM INVMB
                                    WHERE 1=1";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MB001", @" AND LTRIM(RTRIM(MB001)) = @MB001", MtlitemNo);
                    var noResult = sqlConnection.Query(sql, dynamicParameters);

                    #endregion



                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = noResult
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlQcItem //取得製程參數量測項目 --Chia Yuan 2024.03.25
        public string GetMtlQcItem(int MtlItemId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.MtlQcItemId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns = @", a.MtlItemId, a.QcItemId, b.QcItemNo, b.QcItemName, a.DesignValue, a.UpperTolerance, a.LowerTolerance, a.QcItemDesc
                                        , a.BallMark, a.Unit, a.Regulation, a.Notice, a.QmmDetailId, d.MachineNumber, e.MachineNo, e.MachineName, e.MachineDesc ";
                    sqlQuery.mainTables = @"FROM PDM.MtlQcItem a
                                            INNER JOIN QMS.QcItem b ON a.QcItemId = b.QcItemId
                                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                                            LEFT JOIN QMS.QmmDetail d ON d.QmmDetailId = a.QmmDetailId
                                            LEFT JOIN MES.Machine e ON d.MachineId = e.MachineId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND a.MtlItemId = @MtlItemId";
                    dynamicParameters.Add("MtlItemId", MtlItemId);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.SortNumber";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GeMtlItemTypeLogic 取得品號類型編碼邏輯  WuTc --2024-07-25
        public string GeMtlItemTypeLogic(string MtlItemType, string MtlItemTypeNo, string MtlItemTypeName, string MtlItemNameDesc, string FirstWord, string SecondWord, string ThirdWord, string FourthWord, string FifthWord
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //公司別資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                    if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                    foreach (var item in resultCompany)
                    {
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion

                    #region//處理字節
                    string[] FirstWordSP = FirstWord.Split(':');
                    string[] SecondWordSP = SecondWord.Split(':');
                    string[] ThirdWordSP = ThirdWord.Split(':');
                    string[] FourthWordSP = FourthWord.Split(':');
                    string[] FifthWordSP = FifthWord.Split(':');

                    string firstSegmentType = FirstWordSP.Count() > 0 ? FirstWordSP[0].Trim() : "";
                    string secondSegmentType = SecondWordSP.Count() > 0 ? SecondWordSP[0].Trim() : "";
                    string thirdSegmentType = ThirdWordSP.Count() > 0 ? ThirdWordSP[0].Trim() : "";
                    string fourthSegmentType = FourthWordSP.Count() > 0 ? FourthWordSP[0].Trim() : "";
                    string fifthSegmentType = FifthWordSP.Count() > 0 ? FifthWordSP[0].Trim() : "";
                    string firstSegmentValue = FirstWordSP.Count() > 1 ? FirstWordSP[1].Trim() : "";
                    string secondSegmentValue = SecondWordSP.Count() > 1 ? SecondWordSP[1].Trim() : "";
                    string thirdSegmentValue = ThirdWordSP.Count() > 1 ? ThirdWordSP[1].Trim() : "";
                    string fourthSegmentValue = FourthWordSP.Count() > 1 ? FourthWordSP[1].Trim() : "";
                    string fifthSegmentValue = FifthWordSP.Count() > 1 ? FifthWordSP[1].Trim() : "";
                    string firstTypeName = FirstWordSP.Count() > 2 ? FirstWordSP[2].Trim() : "";
                    string secondTypeName = SecondWordSP.Count() > 2 ? SecondWordSP[2].Trim() : "";
                    string thirdTypeName = ThirdWordSP.Count() > 2 ? ThirdWordSP[2].Trim() : "";
                    string fourthTypeName = FourthWordSP.Count() > 2 ? FourthWordSP[2].Trim() : "";
                    string fifthTypeName = FifthWordSP.Count() > 2 ? FifthWordSP[2].Trim() : "";
                    #endregion

                    #region //取得資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT a.ItemTypeId, a.ItemTypeNo, a.ItemTypeName, a.ItemTypeDesc, b.SortNumber
	                        , b.ItemTypeSegmentId, b.SegmentValue, b.SegmentType
	                        , LEFT(a.ItemTypeName ,
	                            CASE
	                                WHEN CHARINDEX('-', a.ItemTypeName) != 0 THEN CHARINDEX('-', a.ItemTypeName) - 1
	                                ELSE LEN(a.ItemTypeName) 
                                END
                            ) AS ItemType,
	                        CASE WHEN b.SortNumber=1 AND b.SegmentType='F' THEN t.TypeName
		                        WHEN b.SortNumber=1 AND b.SegmentType='SV' THEN CONCAT(t.TypeName,'-',sv.SegmentValue)
		                        WHEN b.SortNumber=1 AND b.SegmentType='C' THEN t.TypeName
		                        WHEN b.SortNumber=1 AND b.SegmentType='D' THEN t.TypeName
		                        WHEN b.SortNumber=1 AND b.SegmentType='S' THEN t.TypeName
		                        ELSE ''	END AS FirstWordMark,
	                        CASE WHEN b.SortNumber=1 AND b.SegmentType='F' THEN b.SegmentValue
		                        WHEN b.SortNumber=1 AND b.SegmentType='SV' THEN sv.SegmentValueNo
		                        WHEN b.SortNumber=1 AND b.SegmentType='C' THEN b.SegmentValue
		                        WHEN b.SortNumber=1 AND b.SegmentType='D' THEN s.StatusName
		                        WHEN b.SortNumber=1 AND b.SegmentType='S' THEN b.SegmentValue
		                        ELSE ''	END AS FirstWord,
	                        CASE WHEN b.SortNumber=1 AND SuffixCode='Y' THEN '-' ELSE '' END AS FirstNode,
	                        CASE WHEN b.SortNumber=2 AND b.SegmentType='F' THEN t.TypeName
		                        WHEN b.SortNumber=2 AND b.SegmentType='SV' THEN CONCAT(t.TypeName,'-',sv.SegmentValue)
		                        WHEN b.SortNumber=2 AND b.SegmentType='C' THEN t.TypeName
		                        WHEN b.SortNumber=2 AND b.SegmentType='D' THEN t.TypeName
		                        WHEN b.SortNumber=2 AND b.SegmentType='S' THEN t.TypeName
		                        ELSE ''	END AS SecondWordMark,
	                        CASE WHEN b.SortNumber=2 AND b.SegmentType='F' THEN b.SegmentValue
		                        WHEN b.SortNumber=2 AND b.SegmentType='SV' THEN sv.SegmentValueNo
		                        WHEN b.SortNumber=2 AND b.SegmentType='C' THEN CONCAT(b.SegmentValue,'-',t.TypeName)
		                        WHEN b.SortNumber=2 AND b.SegmentType='D' THEN s.StatusName
		                        WHEN b.SortNumber=2 AND b.SegmentType='S' THEN CONCAT(b.SegmentValue,'-',t.TypeName)
		                        ELSE ''	END AS SecondWord,
	                        CASE WHEN b.SortNumber=2 AND SuffixCode='Y' THEN '-' ELSE '' END AS SecondNode,
	                        CASE WHEN b.SortNumber=3 AND b.SegmentType='F' THEN t.TypeName
		                        WHEN b.SortNumber=3 AND b.SegmentType='SV' THEN CONCAT(t.TypeName,'-',sv.SegmentValue)
		                        WHEN b.SortNumber=3 AND b.SegmentType='C' THEN t.TypeName
		                        WHEN b.SortNumber=3 AND b.SegmentType='D' THEN t.TypeName
		                        WHEN b.SortNumber=3 AND b.SegmentType='S' THEN t.TypeName
		                        ELSE ''	END AS ThirdWordMark,
	                        CASE WHEN b.SortNumber=3 AND b.SegmentType='F' THEN b.SegmentValue
		                        WHEN b.SortNumber=3 AND b.SegmentType='SV' THEN sv.SegmentValueNo
		                        WHEN b.SortNumber=3 AND b.SegmentType='C' THEN b.SegmentValue
		                        WHEN b.SortNumber=3 AND b.SegmentType='D' THEN s.StatusName
		                        WHEN b.SortNumber=3 AND b.SegmentType='S' THEN b.SegmentValue
		                        ELSE ''	END AS ThirdWord,
	                        CASE WHEN b.SortNumber=3 AND SuffixCode='Y' THEN '-' ELSE '' END AS ThirdNode,
	                        CASE WHEN b.SortNumber=4 AND b.SegmentType='F' THEN t.TypeName
		                        WHEN b.SortNumber=4 AND b.SegmentType='SV' THEN CONCAT(t.TypeName,'-', sv.SegmentValue)
		                        WHEN b.SortNumber=4 AND b.SegmentType='C' THEN t.TypeName
		                        WHEN b.SortNumber=4 AND b.SegmentType='D' THEN t.TypeName
		                        WHEN b.SortNumber=4 AND b.SegmentType='S' THEN t.TypeName
		                        ELSE ''	END AS FourthWordMark,
	                        CASE WHEN b.SortNumber=4 AND b.SegmentType='F' THEN b.SegmentValue
		                        WHEN b.SortNumber=4 AND b.SegmentType='SV' THEN sv.SegmentValueNo
		                        WHEN b.SortNumber=4 AND b.SegmentType='C' THEN b.SegmentValue
		                        WHEN b.SortNumber=4 AND b.SegmentType='D' THEN s.StatusName
		                        WHEN b.SortNumber=4 AND b.SegmentType='S' THEN b.SegmentValue
		                        ELSE ''	END AS FourthWord,
	                        CASE WHEN b.SortNumber=4 AND SuffixCode='Y' THEN '-' ELSE '' END AS FourthNode,
	                        CASE WHEN b.SortNumber=5 AND b.SegmentType='F' THEN t.TypeName
		                        WHEN b.SortNumber=5 AND b.SegmentType='SV' THEN CONCAT(t.TypeName,'-',sv.SegmentValue)
		                        WHEN b.SortNumber=5 AND b.SegmentType='C' THEN t.TypeName
		                        WHEN b.SortNumber=5 AND b.SegmentType='D' THEN t.TypeName
		                        WHEN b.SortNumber=5 AND b.SegmentType='S' THEN t.TypeName
		                        ELSE ''	END AS FifthWordMark,
	                        CASE WHEN b.SortNumber=5 AND b.SegmentType='F' THEN b.SegmentValue
		                        WHEN b.SortNumber=5 AND b.SegmentType='SV' THEN sv.SegmentValueNo
		                        WHEN b.SortNumber=5 AND b.SegmentType='C' THEN b.SegmentValue
		                        WHEN b.SortNumber=5 AND b.SegmentType='D' THEN s.StatusName
		                        WHEN b.SortNumber=5 AND b.SegmentType='S' THEN b.SegmentValue
		                        ELSE ''	END AS FifthWord
	                        FROM PDM.ItemType a
	                        INNER JOIN PDM.ItemTypeSegment b ON b.ItemTypeId = a.ItemTypeId
	                        LEFT JOIN BAS.[Type] t ON t.TypeNo = b.SegmentType AND t.TypeSchema = 'ItemTypeSegment.SegmentType'
	                        LEFT JOIN BAS.[Status] s ON s.StatusNo = b.SortNumber AND s.StatusSchema = 'ItemTypeSegment.SegmentValueDate'
	                        OUTER APPLY (
		                        SELECT ac.SegmentValue, ac.SegmentValueNo
			                        FROM PDM.ItemType aa
			                        INNER JOIN PDM.ItemTypeSegment ab ON aa.ItemTypeId = ab.ItemTypeId
			                        LEFT JOIN PDM.ItemSegmentValue ac ON CONVERT(nvarchar, ac.ItemSegmentId) = ab.SegmentValue
			                        WHERE aa.CompanyId = @CompanyId AND ab.SegmentType = 'SV' AND ab.ItemTypeSegmentId = b.ItemTypeSegmentId
	                        ) sv
	                        WHERE a.CompanyId = @CompanyId AND a.[Status] = 'A'";

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemType", @" AND a.ItemTypeName LIKE @MtlItemType + '%'", MtlItemType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemTypeNo", @" AND a.ItemTypeNo = @MtlItemTypeNo", MtlItemTypeNo);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemTypeName", @" AND a.ItemTypeName = @MtlItemTypeName", MtlItemTypeName);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNameDesc", @" AND a.ItemTypeDesc LIKE '%' + @MtlItemNameDesc + '%'", MtlItemNameDesc);

                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstSegmentType", @" AND b.SortNumber = 1 AND b.SegmentType = @firstSegmentType", firstSegmentType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondSegmentType", @" AND b.SortNumber = 2 AND b.SegmentType = @secondSegmentType", secondSegmentType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdSegmentType", @" AND b.SortNumber = 3 AND b.SegmentType = @thirdSegmentType", thirdSegmentType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthSegmentType", @" AND b.SortNumber = 4 AND b.SegmentType = @fourthSegmentType", fourthSegmentType);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthSegmentType", @" AND b.SortNumber = 5 AND b.SegmentType = @fifthSegmentType", fifthSegmentType);

                    if (firstSegmentType == "F" || secondSegmentType == "F" || thirdSegmentType == "F" || fourthSegmentType == "F" || fifthSegmentType == "F")
                    {
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstTypeName", @" AND t.TypeName = @firstTypeName", firstTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondTypeName", @" AND t.TypeName = @secondTypeName", secondTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdTypeName", @" AND t.TypeName = @thirdTypeName", thirdTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthTypeName", @" AND t.TypeName = @fourthTypeName", fourthTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthTypeName", @" AND t.TypeName = @fifthTypeName", fifthTypeName);

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstSegmentValue", @" AND b.SegmentValue = @firstSegmentValue", firstSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondSegmentValue", @" AND b.SegmentValue = @secondSegmentValue", secondSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdSegmentValue", @" AND b.SegmentValue = @thirdSegmentValue", thirdSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthSegmentValue", @" AND b.SegmentValue = @fourthSegmentValue", fourthSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthSegmentValue", @" AND b.SegmentValue = @fifthSegmentValue", fifthSegmentValue);
                    }
                    else if (firstSegmentType == "SV" || secondSegmentType == "SV" || thirdSegmentType == "SV" || fourthSegmentType == "SV" || fifthSegmentType == "SV")
                    {
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstTypeName", @" AND t.TypeName LIKE @firstTypeName + '%'", firstTypeName );
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondTypeName", @" AND t.TypeName LIKE @secondTypeName + '%'", secondTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdTypeName", @" AND t.TypeName LIKE @thirdTypeName + '%'", thirdTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthTypeName", @" AND t.TypeName LIKE @fourthTypeName + '%'", fourthTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthTypeName", @" AND t.TypeName LIKE @fifthTypeName + '%'", fifthTypeName);

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstSegmentValue", @" AND sv.SegmentValue LIKE '%' + @firstSegmentValue", firstSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondSegmentValue", @" AND sv.SegmentValue LIKE '%' + @secondSegmentValue", secondSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdSegmentValue", @" AND sv.SegmentValue LIKE '%' + @thirdSegmentValue", thirdSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthSegmentValue", @" AND sv.SegmentValue LIKE '%' + @fourthSegmentValue", fourthSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthSegmentValue", @" AND sv.SegmentValue LIKE '%' + @fifthSegmentValue", fifthSegmentValue);
                    }
                    else if (firstSegmentType == "C" || secondSegmentType == "C" || thirdSegmentType == "C" || fourthSegmentType == "C" || fifthSegmentType == "C")
                    {
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstTypeName", @" AND t.TypeName = @firstTypeName", firstTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondTypeName", @" AND t.TypeName = @secondTypeName", secondTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdTypeName", @" AND t.TypeName = @thirdTypeName", thirdTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthTypeName", @" AND t.TypeName = @fourthTypeName", fourthTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthTypeName", @" AND t.TypeName = @fifthTypeName", fifthTypeName);

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstSegmentValue", @" AND b.SegmentValue = @firstSegmentValue", firstSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondSegmentValue", @" AND b.SegmentValue = @secondSegmentValue", secondSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdSegmentValue", @" AND b.SegmentValue = @thirdSegmentValue", thirdSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthSegmentValue", @" AND b.SegmentValue = @fourthSegmentValue", fourthSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthSegmentValue", @" AND b.SegmentValue = @fifthSegmentValue", fifthSegmentValue);
                    }
                    else if (firstSegmentType == "D" || secondSegmentType == "D" || thirdSegmentType == "D" || fourthSegmentType == "D" || fifthSegmentType == "D")
                    {
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstTypeName", @" AND t.TypeName = @firstTypeName", firstTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondTypeName", @" AND t.TypeName = @secondTypeName", secondTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdTypeName", @" AND t.TypeName = @thirdTypeName", thirdTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthTypeName", @" AND t.TypeName = @fourthTypeName", fourthTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthTypeName", @" AND t.TypeName = @fifthTypeName", fifthTypeName);

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstSegmentValue", @" AND b.SegmentValue = @firstSegmentValue", firstSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondSegmentValue", @" AND b.SegmentValue = @secondSegmentValue", secondSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdSegmentValue", @" AND b.SegmentValue = @thirdSegmentValue", thirdSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthSegmentValue", @" AND b.SegmentValue = @fourthSegmentValue", fourthSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthSegmentValue", @" AND b.SegmentValue = @fifthSegmentValue", fifthSegmentValue);
                    }
                    else if (firstSegmentType == "S" || secondSegmentType == "S" || thirdSegmentType == "S" || fourthSegmentType == "S" || fifthSegmentType == "S")
                    {
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstTypeName", @" AND t.TypeName = @firstTypeName", firstTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondTypeName", @" AND t.TypeName = @secondTypeName", secondTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdTypeName", @" AND t.TypeName = @thirdTypeName", thirdTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthTypeName", @" AND t.TypeName = @fourthTypeName", fourthTypeName);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthTypeName", @" AND t.TypeName = @fifthTypeName", fifthTypeName);

                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "firstSegmentValue", @" AND b.SegmentValue = @firstSegmentValue", firstSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "secondSegmentValue", @" AND b.SegmentValue = @secondSegmentValue", secondSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "thirdSegmentValue", @" AND b.SegmentValue = @thirdSegmentValue", thirdSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fourthSegmentValue", @" AND b.SegmentValue = @fourthSegmentValue", fourthSegmentValue);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "fifthSegmentValue", @" AND b.SegmentValue = @fifthSegmentValue", fifthSegmentValue);
                    }
                    
                    dynamicParameters.Add("CompanyId", CurrentCompany);

                    #region //取得全部筆數
                    string totalSql = @"SELECT COUNT(1) AS TotalCount
                                        FROM (" + sql + ") AS TotalQuery";

                    var TotalCountResult = sqlConnection.Query(totalSql, dynamicParameters);

                    int TotalCount = 0;
                    foreach (var item in TotalCountResult)
                    {
                        TotalCount = item.TotalCount;
                    }
                    #endregion

                    sql += @" ORDER BY b.ItemTypeSegmentId
                                OFFSET @PageSize * (@PageIndex - 1) ROWS
                                FETCH NEXT @PageSize ROWS ONLY;";

                    dynamicParameters.Add("PageSize", PageSize);
                    dynamicParameters.Add("PageIndex", PageIndex);

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = new { result, TotalCount }
                    });
                    #endregion


                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GeMtlItemType 取得品號類型  WuTc --2024-07-26
        public string GeMtlItemType()
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //取得資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT 
                            LEFT(b.ItemTypeName ,
	                            CASE
	                                WHEN CHARINDEX('-', b.ItemTypeName) != 0 THEN CHARINDEX('-', b.ItemTypeName) - 1
	                                ELSE LEN(b.ItemTypeName)
                                END
                            ) AS ItemType
	                        FROM PDM.ItemTypeSegment a
	                        LEFT JOIN PDM.ItemType b ON b.ItemTypeId = a.ItemTypeId
	                        INNER JOIN [BAS].Company c ON c.CompanyId = b.CompanyId
                            WHERE b.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion


                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GeMtlItemTypeWordNode 取得品號類型字節  WuTc --2024-07-30
        public string GeMtlItemTypeWordNode(int SortNumber)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //取得資料
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT DISTINCT b.SegmentType, b.SortNumber, b.SegmentValue, t.TypeName,
                            CASE WHEN b.SegmentType = 'SV' THEN b.SegmentType + ' : ' + sv.SegmentValue + ' : ' + t.TypeName
		                        ELSE b.SegmentType + ' : ' + b.SegmentValue + ' : ' + t.TypeName END AS showValue
	                        FROM PDM.ItemType a
	                        INNER JOIN PDM.ItemTypeSegment b ON b.ItemTypeId = a.ItemTypeId
	                        LEFT JOIN BAS.[Type] t ON t.TypeNo = b.SegmentType AND t.TypeSchema = 'ItemTypeSegment.SegmentType'
	                        LEFT JOIN BAS.[Status] s ON s.StatusNo = b.SortNumber AND s.StatusSchema = 'ItemTypeSegment.SegmentValueDate'
	                        OUTER APPLY (
		                        SELECT ac.SegmentValue, ac.SegmentValueNo
			                        FROM PDM.ItemType aa
			                        INNER JOIN PDM.ItemTypeSegment ab ON aa.ItemTypeId = ab.ItemTypeId
			                        LEFT JOIN PDM.ItemSegmentValue ac ON CONVERT(nvarchar, ac.ItemSegmentId) = ab.SegmentValue
			                        WHERE aa.CompanyId = @CompanyId AND ab.SegmentType = 'SV' AND ab.ItemTypeSegmentId = b.ItemTypeSegmentId
	                        ) sv
	                        WHERE a.CompanyId = @CompanyId AND a.[Status] = 'A'";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "SortNumber", @" AND b.SortNumber = @SortNumber", SortNumber);

                    sql += @"   ORDER BY t.TypeName, b.SegmentValue";
                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion


                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //GetMassProductionReviewDocSetting -- 取得量產審查文件設定 -- Ben Ma 2024.08.07
        public string GetMassProductionReviewDocSetting(int DocId, string Status
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.DocId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", CASE 
                            WHEN a.[Status] = 'A' THEN a.DocName
                            ELSE a.DocName + '(停用)'
                        END DocName, a.[Status]";
                    sqlQuery.mainTables =
                        @"FROM PDM.MassProductionReviewDocSetting a";
                    sqlQuery.auxTables = "";
                    string queryCondition = "";
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DocId", @" AND a.DocId = @DocId", DocId);
                    if (Status.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "Status", @" AND a.Status IN @Status", Status.Split(','));
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.DocId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMassProductionReviewDoc -- 取得量產審查文件 -- Ben Ma 2024.08.07
        public string GetMassProductionReviewDoc(int DocId, string MtlItemNo, string MtlItemName
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    sqlQuery.mainKey = "a.MtlItemId, a.DocId, a.FileId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @", CASE 
                            WHEN b.[Status] = 'A' THEN b.DocName
                            ELSE b.DocName + '(停用)'
                        END DocName
                        , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                        , d.[FileName], d.FileExtension
                        , e.UserNo + e.UserName UploadUser, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm') UploadTime";
                    sqlQuery.mainTables =
                        @"FROM PDM.MassProductionReviewDoc a
                        INNER JOIN PDM.MassProductionReviewDocSetting b ON a.DocId = b.DocId
                        INNER JOIN PDM.MtlItem c ON a.MtlItemId = c.MtlItemId
                        INNER JOIN BAS.[File] d ON a.FileId = d.FileId
                        INNER JOIN BAS.[User] e ON a.CreateBy = e.UserId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @" AND c.CompanyId = @CompanyId";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "DocId", @" AND a.DocId = @DocId", DocId);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND c.MtlItemNo LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                    BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemName", @" AND c.MtlItemName LIKE '%' + @MtlItemName + '%'", MtlItemName);
                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MtlItemId, a.DocId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetInventoryQueryWithNewMtlItemNo -- 庫存整合+新舊品號變更查詢 -- Tim 2024.11.12
        public string GetInventoryQueryWithNewMtlItemNo(
            string SearchKey,
            string SearchMtlItemNo,
            string SearchNewMtlItemNo,
            string SearchMtlItemSpec,
            string UserIds,
            string NewUserIds,
            string InStock,
            string UserStatus,
            string NewUserStatus,
            string OrderBy,
            int PageIndex,
            int PageSize
        )
        {
            try
            {
                List<InventoryMtlItem> inventoryMtlItems = new List<InventoryMtlItem>();
                List<InventoryData> inventoryDatas = new List<InventoryData>();
                List<InventoryAvailable> inventoryAvailables = new List<InventoryAvailable>();
                string[] validValues = new string[] { "1", "0" };

                if (validValues.Contains(InStock))
                {
                    #region //庫存量相關，先查ERP
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //各庫庫存量
                        dynamicParameters = new DynamicParameters();
                        if (InStock == "1")
                        {
                            #region // 有庫存
                            sql = @"SELECT
                                    	x.MtlItemNo, x.InventoryNo, x.InventoryName, x.InventoryQty
                                    FROM (
                                    	SELECT
                                    		LTRIM(RTRIM(x.MC001)) AS MtlItemNo,
                                    		x.MC007 AS InventoryQty,
                                    		LTRIM(RTRIM(y.MC001)) AS InventoryNo,
                                    		LTRIM(RTRIM(y.MC002)) AS InventoryName
                                    	FROM INVMC x
                                    	INNER JOIN CMSMC y ON x.MC002 = y.MC001
                                    ) x
                                    WHERE 1=1
                                    AND MtlItemNo IN (
                                    	SELECT DISTINCT
                                    		a.MC001
                                    	FROM INVMC a
                                    	WHERE MC007 > 0
                                    	-- ORDER BY MC001
                                    	-- OFFSET 0 ROWS
                                    	-- FETCH NEXT 10 ROWS ONLY
                                    )
                                    AND InventoryQty > 0
                                    ORDER BY MtlItemNo, InventoryNo";
                            #endregion // 有庫存
                        }
                        #endregion //各庫庫存量

                        else
                        {
                            #region// 無庫存
                            sql = @"SELECT
                                    	x.MtlItemNo, x.InventoryNo, x.InventoryName, x.InventoryQty
                                    FROM (
                                    	SELECT
                                    		LTRIM(RTRIM(x.MC001)) AS MtlItemNo,
                                    		x.MC007 AS InventoryQty,
                                    		LTRIM(RTRIM(y.MC001)) AS InventoryNo,
                                    		LTRIM(RTRIM(y.MC002)) AS InventoryName
                                    	FROM INVMC x
                                    	INNER JOIN CMSMC y ON x.MC002 = y.MC001
                                    ) x
                                    WHERE 1=1
                                    AND MtlItemNo IN (
                                    	SELECT DISTINCT
                                    		a.MC001
                                    	FROM INVMC a
                                    	WHERE MC007 <= 0
                                    	-- ORDER BY MC001
                                    	-- OFFSET 0 ROWS
                                    	-- FETCH NEXT 10 ROWS ONLY
                                    )
                                    AND InventoryQty <= 0
                                    ORDER BY MtlItemNo, InventoryNo";
                            #endregion// 無庫存
                        }
                        inventoryDatas = sqlConnection.Query<InventoryData>(sql, dynamicParameters).ToList();
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region // 查MtlItem
                        sql = @"WITH K AS (
	                                SELECT
		                                a.MtlItemId,
		                                a.MtlItemNo, a.MtlItemName, a.MtlItemSpec,
		                                a.UserName, a.UserNo,
		                                CONVERT(nvarchar(25), a.CreateDate, 120) AS CreateDate,
		                                a.NewMtlItemNo, a.NewMtlItemName, a.NewMtlItemSpec,
		                                a.NewUserName, a.NewUserNo,
		                                CONVERT(nvarchar(25), a.NewCreateDate, 120) AS NewCreateDate
                                    FROM (
                                    	SELECT
                                    		a.MtlItemId,
                                    		a.CompanyId,
                                    		a.MtlItemNo, b.NewMtlItemNo, b.NewMtlItemName, b.NewMtlItemSpec, a.MtlItemName, a.MtlItemSpec,
                                    		c.UserId, c.UserName, c.UserNo, a.CreateDate,
                                    		d.UserId AS NewUserId, d.UserName AS NewUserName, d.UserNo AS NewUserNo, b.CreateDate AS NewCreateDate,
                                    		(
                                    			SELECT
                                    				aa.CustomerMtlItemNo
                                    			FROM PDM.CustomerMtlItem aa
                                    			WHERE aa.MtlItemId = a.MtlItemId
                                    			FOR JSON PATH, ROOT('data')
                                    		) CustomerMtlItem
                                    	FROM PDM.MtlItem a
                                    	LEFT JOIN PDM.MtlItemNoIntegration b ON a.MtlItemId = b.MtlItemId
                                    	LEFT JOIN BAS.[User] c ON a.CreateBy = c.UserId
                                    	LEFT JOIN BAS.[User] d ON b.CreateBy = d.UserId
                                    ) a
	                                OUTER APPLY (
	                                    SELECT TOP 1
		                                    x.CustomerMtlItemNo
	                                    FROM OPENJSON(a.CustomerMtlItem, '$.data')
	                                    WITH (
		                                    CustomerMtlItemNo NVARCHAR(50) N'$.CustomerMtlItemNo'
	                                    ) x
	                                ) b
	                                WHERE 1=1
	                                AND a.CompanyId = @CompanyId
	                                AND (
	                                	a.MtlItemNo LIKE '%' + @SearchKey + '%' 
	                                	OR a.MtlItemName LIKE '%' + @SearchKey + '%' 
	                                	OR a.NewMtlItemNo LIKE '%' + @SearchKey + '%' 
	                                	OR b.CustomerMtlItemNo LIKE '%' + @SearchKey + '%'
	                                )";

                        if (SearchMtlItemNo.Length > 0) {sql += " AND a.MtlItemNo LIKE '" + SearchMtlItemNo + "%'";}
                        if (SearchNewMtlItemNo.Length > 0) {sql += " AND a.NewMtlItemNo LIKE '" + SearchNewMtlItemNo + "%'";}
                        if (SearchMtlItemSpec.Length > 0) {sql += " AND a.MtlItemSpec LIKE '%" + SearchMtlItemSpec + "%'";}
                        
                        if (UserStatus.Contains("W"))
                        {
                            if (UserIds.Length > 0)
                            {
                                // users with unknown
                                sql += " AND (a.UserId IS NULL OR a.UserId IN (" + UserIds + "))";
                            }
                            else
                            {
                                // unknown only
                                sql += " AND a.UserId IS NULL";
                            }
                        }
                        else
                        {
                            if (UserIds.Length > 0)
                            {
                                // users
                                sql += " AND a.UserId IN (" + UserIds + ")";
                            }
                            else
                            {
                                // nothing choosed
                            }
                        }

                        if (NewUserStatus.Contains("W"))
                        {
                            if (NewUserIds.Length > 0)
                            {
                                // users with unknown
                                sql += " AND (a.NewUserId IS NULL OR a.NewUserId IN (" + NewUserIds + "))";
                            }
                            else
                            {
                                // unknown only
                                sql += " AND a.NewUserId IS NULL";
                            }
                        }
                        else
                        {
                            if (NewUserIds.Length > 0)
                            {
                                // users
                                sql += " AND a.NewUserId IN (" + NewUserIds + ")";
                            }
                            else
                            {
                                // nothing choosed
                            }
                        }

                        sql +=@")
                                SELECT K.*, L.TotalCount FROM K
                                CROSS APPLY(
	                                select Count(*) TotalCount from K
                                ) L
                                ORDER BY K.MtlItemId DESC
                                -- OFFSET 0 ROWS
                                -- FETCH NEXT 10 ROWS ONLY";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("SearchKey", SearchKey);

                        inventoryMtlItems = sqlConnection.Query<InventoryMtlItem>(sql, dynamicParameters).ToList();
                        #endregion // 查MtlItem

                        // update stock counts
                        inventoryMtlItems
                        .ToList()
                        .ForEach(x =>
                        {
                            x.InventoryDatas = inventoryDatas
                                                    .Where(y => y.MtlItemNo == x.MtlItemNo)
                                                    .Select(y =>
                                                    new InventoryData
                                                    {
                                                        MtlItemNo = y.MtlItemNo,
                                                        InventoryNo = y.InventoryNo,
                                                        InventoryName = y.InventoryName,
                                                        InventoryQty = y.InventoryQty
                                                    }).ToList();
                        }
                        );

                        int totalCount = inventoryMtlItems.Where(x => x.InventoryDatas.Count > 0).ToList().Count();
                        int totalCounts = (InStock != "0") ? totalCount : inventoryMtlItems.Count() - totalCount;

                        if (InStock != "0")
                        {
                            inventoryMtlItems = inventoryMtlItems.Where(x => x.InventoryDatas.Count > 0).ToList();
                        }
                        else
                        {
                            inventoryMtlItems = inventoryMtlItems.Where(x => x.InventoryDatas.Count <= 0).ToList();
                        }
                        inventoryMtlItems
                        .ToList()
                        .ForEach(x =>
                        {
                            x.TotalCount = totalCounts;
                        });

                        inventoryMtlItems = inventoryMtlItems.Skip((PageIndex - 1) * PageSize).Take(PageSize).ToList();
                    }
                }

                #endregion //庫存量相關，先查ERP

                else
                {
                    #region //庫存量無關，先查BM
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        sqlQuery.mainKey = "a.MtlItemId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.MtlItemNo, a.MtlItemName, a.MtlItemSpec,
                            a.UserName, a.UserNo,
                            CONVERT(nvarchar(25), a.CreateDate, 120) AS CreateDate,
                            a.NewMtlItemNo, a.NewMtlItemName, a.NewMtlItemSpec,
                            a.NewUserName, a.NewUserNo,
                            CONVERT(nvarchar(25), a.NewCreateDate, 120) AS NewCreateDate";

                        sqlQuery.mainTables =
                            @"  FROM (
                                SELECT
                                    a.*,
                                	c.UserName, c.UserNo,
                                	b.NewMtlItemNo, b.NewMtlItemName, b.NewMtlItemSpec,
                                	d.UserName AS NewUserName,
                                	d.UserNo AS NewUserNo,
                                	b.CreateDate AS NewCreateDate
                                FROM PDM.MtlItem a
                        	    LEFT JOIN PDM.MtlItemNoIntegration b ON a.MtlItemId = b.MtlItemId
                        	    LEFT JOIN BAS.[User] c ON a.CreateBy = c.UserId
                        	    LEFT JOIN BAS.[User] d ON b.CreateBy = d.UserId
                            ) a";

                        string queryTable =
                            @"  FROM (
                                SELECT
                                    a.MtlItemId, a.CompanyId, a.MtlItemNo, a.MtlItemName, a.MtlItemSpec, a.CreateDate, (
                                        SELECT
                                            aa.CustomerMtlItemNo
                                        FROM PDM.CustomerMtlItem aa
                                        WHERE aa.MtlItemId = a.MtlItemId
                                        FOR JSON PATH, ROOT('data')
                                    ) CustomerMtlItem, (
                                        SELECT
                                            bb.NewMtlItemNo
                                        FROM PDM.MtlItemNoIntegration bb
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) NewMtlItemNo, (
                                        SELECT
                                            bb.NewMtlItemName
                                        FROM PDM.MtlItemNoIntegration bb
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) NewMtlItemName, (
                                        SELECT
                                            bb.NewMtlItemSpec
                                        FROM PDM.MtlItemNoIntegration bb
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) NewMtlItemSpec, (
                                        SELECT
                                            cc.UserId
                                        FROM PDM.MtlItemNoIntegration bb
                                        LEFT JOIN BAS.[User] cc ON bb.CreateBy = cc.UserId
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) NewCreateBy, (
                                        SELECT
                                            bb.CreateDate
                                        FROM PDM.MtlItemNoIntegration bb
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) NewCreateDate, (
                                        SELECT
                                            cc.UserName
                                        FROM PDM.MtlItemNoIntegration bb
                                        LEFT JOIN BAS.[User] cc ON bb.CreateBy = cc.UserId
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) NewUserName, (
                                        SELECT
                                            cc.UserNo
                                        FROM PDM.MtlItemNoIntegration bb
                                        LEFT JOIN BAS.[User] cc ON bb.CreateBy = cc.UserId
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) NewUserNo, (
                                        SELECT
                                            cc.UserId
                                        FROM PDM.MtlItemNoIntegration bb
                                        LEFT JOIN BAS.[User] cc ON bb.CreateBy = cc.UserId
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) NewUserId, (
                                        SELECT
                                            cc.UserName
                                        FROM PDM.MtlItem bb
                                        LEFT JOIN BAS.[User] cc ON bb.CreateBy = cc.UserId
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) UserName, (
                                        SELECT
                                            cc.UserNo
                                        FROM PDM.MtlItem bb
                                        LEFT JOIN BAS.[User] cc ON bb.CreateBy = cc.UserId
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) UserNo, (
                                        SELECT
                                            cc.UserId
                                        FROM PDM.MtlItem bb
                                        LEFT JOIN BAS.[User] cc ON bb.CreateBy = cc.UserId
                                        WHERE bb.MtlItemId = a.MtlItemId
                                    ) UserId
                                FROM PDM.MtlItem a
                            ) a
                            OUTER APPLY (
                                SELECT TOP 1
                                	x.CustomerMtlItemNo
                                FROM OPENJSON(a.CustomerMtlItem, '$.data')
                                WITH (
                                	CustomerMtlItemNo NVARCHAR(50) N'$.CustomerMtlItemNo'
                                ) x
                            ) b";

                        sqlQuery.auxTables = queryTable;

                        string queryCondition = @"AND a.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "SearchKey", @" AND (
	                                	                                                                    a.MtlItemNo LIKE '%' + @SearchKey + '%' 
	                                	                                                                    OR a.MtlItemName LIKE '%' + @SearchKey + '%' 
	                                	                                                                    OR a.NewMtlItemNo LIKE '%' + @SearchKey + '%' 
	                                	                                                                    OR b.CustomerMtlItemNo LIKE '%' + @SearchKey + '%'
	                                                                                                    )", SearchKey);

                        if (SearchMtlItemNo.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemNo", @" AND a.MtlItemNo LIKE + @MtlItemNo + '%'", SearchMtlItemNo.Trim());
                        if (SearchNewMtlItemNo.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NewMtlItemNo", @" AND a.NewMtlItemNo LIKE + @NewMtlItemNo + '%'", SearchNewMtlItemNo.Trim());
                        if (SearchMtlItemSpec.Length > 0) BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "MtlItemSpec", @" AND a.MtlItemSpec LIKE + '%' + @MtlItemSpec + '%'", SearchMtlItemSpec.Trim());

                        if (UserStatus.Contains("W"))
                        {
                            if (UserIds.Length > 0)
                            {
                                // users with unknown
                                BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserIds", @" AND (a.UserId IS NULL OR a.UserId IN @UserIds)", UserIds.Split(','));
                            }
                            else
                            {
                                // unknown only
                                BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserIds", @" AND a.UserId IS NULL", UserIds.Split(','));
                            }
                        }
                        else
                        {
                            if (UserIds.Length > 0)
                            {
                                // users
                                BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "UserIds", @" AND a.UserId IN @UserIds", UserIds.Split(','));
                            }
                            else
                            {
                                // nothing choosed
                            }
                        }

                        if (NewUserStatus.Contains("W"))
                        {
                            if (NewUserIds.Length > 0)
                            {
                                // users with unknown
                                BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NewUserIds", @" AND (a.NewUserId IS NULL OR a.NewUserId IN @NewUserIds)", NewUserIds.Split(','));
                            }
                            else
                            {
                                // unknown only
                                BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NewUserIds", @" AND a.NewUserId IS NULL", NewUserIds.Split(','));
                            }
                        }
                        else
                        {
                            if (NewUserIds.Length > 0)
                            {
                                // users
                                BaseHelper.SqlParameter(ref queryCondition, ref dynamicParameters, "NewUserIds", @" AND a.NewUserId IN @NewUserIds", NewUserIds.Split(','));
                            }
                            else
                            {
                                // nothing choosed
                            }
                        }

                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MtlItemId DESC";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        inventoryMtlItems = BaseHelper.SqlQuery<InventoryMtlItem>(sqlConnection, dynamicParameters, sqlQuery);
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {

                        #region //各庫庫存量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(x.MC001)) MtlItemNo, LTRIM(RTRIM(y.MC001)) InventoryNo, LTRIM(RTRIM(y.MC002)) InventoryName, x.MC007 InventoryQty
                            FROM INVMC x
                            INNER JOIN CMSMC y ON x.MC002 = y.MC001
                            WHERE LTRIM(RTRIM(x.MC001)) IN @MtlItemNos
                            AND x.MC007 > 0
                            ORDER BY y.MC001";
                        dynamicParameters.Add("MtlItemNos", inventoryMtlItems.Select(x => x.MtlItemNo).ToArray());

                        inventoryDatas = sqlConnection.Query<InventoryData>(sql, dynamicParameters).ToList();

                        inventoryMtlItems
                            .ToList()
                            .ForEach(x =>
                            {
                                x.InventoryDatas = inventoryDatas
                                                        .Where(y => y.MtlItemNo == x.MtlItemNo)
                                                        .Select(y =>
                                                        new InventoryData
                                                        {
                                                            MtlItemNo = y.MtlItemNo,
                                                            InventoryNo = y.InventoryNo,
                                                            InventoryName = y.InventoryName,
                                                            InventoryQty = y.InventoryQty
                                                        }).ToList();
                            });
                        #endregion

                        #region //庫存可用量
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MB001)) MtlItemNo, b.ScheduledPurchase, c.ScheduledIn
                            , d.ScheduledProduce, e.ShippedQuantity, f.AvailableInventory
                            FROM INVMB a
                            OUTER APPLY (
                                SELECT ISNULL(SUM(bb.TB009), 0) ScheduledPurchase
                                FROM PURTA ba
                                INNER JOIN PURTB bb ON ba.TA001 = bb.TB001 AND ba.TA002 = bb.TB002
                                WHERE 1=1
                                AND ba.TA007 = 'Y'
                                AND bb.TB025 = 'Y'
                                AND bb.TB039 NOT IN('Y','y')
                                AND LTRIM(RTRIM(bb.TB004)) = LTRIM(RTRIM(a.MB001))
                            ) b
                            OUTER APPLY (
                                SELECT ISNULL(SUM(cb.TD008 - cb.TD015), 0) ScheduledIn
                                FROM PURTC ca
                                INNER JOIN PURTD cb ON ca.TC001 = cb.TD001 AND ca.TC002 = cb.TD002
                                WHERE 1 = 1
                                AND ca.TC014 = 'Y'
                                AND cb.TD016 NOT IN('Y', 'y')
                                AND cb.TD018 = 'Y'
                                AND LTRIM(RTRIM(cb.TD004)) = LTRIM(RTRIM(a.MB001))
                            ) c
                            OUTER APPLY (
                                SELECT ISNULL(SUM(da.TA015 - da.TA017 - da.TA018), 0) ScheduledProduce
                                FROM MOCTA da
                                WHERE da.TA011 NOT IN('Y', 'y')
                                AND da.TA013 = 'Y'
                                AND LTRIM(RTRIM(da.TA006)) = LTRIM(RTRIM(a.MB001))
                            ) d
                            OUTER APPLY (
                                SELECT ISNULL(SUM(eb.TG009), 0) ShippedQuantity
                                FROM INVTF ea
                                INNER JOIN INVTG eb ON ea.TF001 = eb.TG001 AND ea.TF002 = eb.TG002
                                WHERE ea.TF001 = '1301'
                                AND ea.TF020 = 'Y'
                                AND eb.TG022 = 'Y'
                                AND eb.TG024 = 'N'
                                AND LTRIM(RTRIM(eb.TG004)) = LTRIM(RTRIM(a.MB001))
                            ) e
                            OUTER APPLY (
                                SELECT ISNULL(SUM(fa.MC007), 0) AvailableInventory
                                FROM INVMC fa
                                INNER JOIN CMSMC fb ON fa.MC002 = fb.MC001
                                WHERE fa.MC007 > 0
                                AND fb.MC001 LIKE 'A__%'
                                AND fb.MC001 NOT IN('A05', 'A07')
                                AND LTRIM(RTRIM(fa.MC001)) = LTRIM(RTRIM(a.MB001))
                            ) f
                            WHERE LTRIM(RTRIM(a.MB001)) IN @MtlItemNos";
                        dynamicParameters.Add("MtlItemNos", inventoryMtlItems.Select(x => x.MtlItemNo).ToArray());

                        inventoryAvailables = sqlConnection.Query<InventoryAvailable>(sql, dynamicParameters).ToList();

                        inventoryMtlItems = inventoryMtlItems.GroupJoin(inventoryAvailables, x => x.MtlItemNo, y => y.MtlItemNo
                                                , (x, y) => {
                                                    x.ScheduledPurchase = y.FirstOrDefault()?.ScheduledPurchase ?? 0;
                                                    x.ScheduledIn = y.FirstOrDefault()?.ScheduledIn ?? 0;
                                                    x.ScheduledProduce = y.FirstOrDefault()?.ScheduledProduce ?? 0;
                                                    x.ShippedQuantity = y.FirstOrDefault()?.ShippedQuantity ?? 0;
                                                    x.AvailableInventory = y.FirstOrDefault()?.AvailableInventory ?? 0;
                                                    return x;
                                                }).ToList();
                        #endregion
                    }
                }
                #endregion //庫存量無關，先查BM

                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    data = inventoryMtlItems
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlItemList --取得暫存列表的品號相關資料
        public string GetMtlItemList(string MtlItemList)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    if (MtlItemList.Length <= 0) throw new SystemException("品號列表不能為空,請重新確認!!!");

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    sql = @"SELECT a.MtlItemNo,a.MtlItemName
                            FROM PDM.MtlItem a
                            WHERE a.MtlItemId in ( " + MtlItemList + @" )";

                    var result = sqlConnection.Query(sql, dynamicParameters);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetMtlItemFile -- 取得品號審查文件 -- Shintokuro 2024.11.13
        public string GetMtlItemFile(int MtlItemId
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    string MtlItemNo = "";

                    #region //判斷品號是否存在
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 MtlItemNo
                            FROM PDM.MtlItem
                            WHERE MtlItemId = @MtlItemId";
                    dynamicParameters.Add("MtlItemId", MtlItemId);
                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("品號不存在，請重新輸入!");
                    foreach (var item in result)
                    {
                        MtlItemNo = item.MtlItemNo;
                    }
                    #endregion


                    sqlQuery.mainKey = "a.MtlItemNo,x.MtDocId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",a.MtlItemNo,x.DocName,b.FileId,c.FileName,c.FileExtension,x.PurchaseMandatory,x.SaleOrderMandatory";
                    sqlQuery.mainTables =
                        @"FROM PDM.MtlItem a
                          OUTER APPLY(
                              SELECT x1.MtDocId, x1.DocName ,x1.PurchaseMandatory,x1.SaleOrderMandatory
                              FROM PDM.MtlItemDocSetting x1
                          ) x
                          LEFT JOIN PDM.MtlItemFile b on a.MtlItemNo = b.MtlItemNo AND  x.MtDocId = b.MtDocId
                          LEFT JOIN BAS.[File] c on b.FileId = c.FileId";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.MtlItemNo = @MtlItemNo";
                    dynamicParameters.Add("MtlItemNo", MtlItemNo);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "x.MtDocId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetNewMtlItemDetail -- 取得新品號基本資料-- Shintokuro 2024.12.06
        public string GetNewMtlItemDetail(int MtlItemId, string NewMtlItemNo
            , string OrderBy, int PageIndex, int PageSize)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {

                    DynamicParameters dynamicParameters = new DynamicParameters();

                    dynamicParameters = new DynamicParameters();
                    sqlQuery.mainKey = "a.NewMtDetailId";
                    sqlQuery.auxKey = "";
                    sqlQuery.columns =
                        @",a.NewMtDetailId, a.CompanyId, a.MtlItemNo, x.MtlItemName , x.MtlItemSpec, 
                          a.InventoryUomId, a.WeightUomId, a.PurchaseUomId, a.SaleUomId, a.TypeOne, a.TypeTwo, a.TypeThree, a.TypeFour, a.InventoryId, 
                          a.RequisitionInventoryId, a.InventoryManagement, a.MtlModify, a.BondedStore, a.ItemAttribute, a.ProductionLine, 
                          a.LotManagement, a.EfficientDays, a.RetestDays, a.ReplenishmentPolicy, a.MeasureType, a.EffectiveDate, a.ExpirationDate, 
                          a.OverReceiptManagement, a.OverDeliveryManagement, a.Version, a.MtlItemDesc, a.MtlItemRemark, a.TransferStatus, 
                          a.TransferDate, a.Status, a.CreateDate, a.LastModifiedDate, a.CreateBy, a.LastModifiedBy";
                    sqlQuery.mainTables =
                        @"FROM PDM.NewMtlItemDetail a
                          OUTER APPLY(
                            SELECT TOP 1 NewMtlItemName MtlItemName,NewMtlItemSpec MtlItemSpec
                            FROM PDM.MtlItemNoIntegration x1
                            WHERE x1.NewMtlItemNo = a.MtlItemNo
                          ) x
                          ";
                    sqlQuery.auxTables = "";
                    string queryCondition = @"AND a.CompanyId = @CompanyId AND a.MtlItemNo = @MtlItemNo";
                    dynamicParameters.Add("CompanyId", CurrentCompany);
                    dynamicParameters.Add("MtlItemNo", NewMtlItemNo);

                    sqlQuery.conditions = queryCondition;
                    sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.NewMtDetailId";
                    sqlQuery.pageIndex = PageIndex;
                    sqlQuery.pageSize = PageSize;

                    var result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    if (result.Count() <= 0)
                    {
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.MtlItemId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.CompanyId, a.MtlItemNo,
                              CASE WHEN x.MtlItemName != '' OR x.MtlItemSpec != ''  THEN x.MtlItemName ELSE a.MtlItemName END AS MtlItemName,
                              CASE WHEN x.MtlItemName != '' OR x.MtlItemSpec != ''  THEN x.MtlItemSpec ELSE a.MtlItemSpec END AS MtlItemSpec,
                              a.InventoryUomId, a.PurchaseUomId, a.SaleUomId, a.TypeOne, a.TypeTwo, a.TypeThree, a.TypeFour, a.InventoryId, 
                              a.RequisitionInventoryId, a.InventoryManagement, a.MtlModify, a.BondedStore, a.ItemAttribute, a.ProductionLine, 
                              a.LotManagement, a.EfficientDays, a.RetestDays, a.ReplenishmentPolicy, a.MeasureType, a.EffectiveDate, a.ExpirationDate, 
                              a.OverReceiptManagement, a.OverDeliveryManagement, a.Version, a.MtlItemDesc, a.MtlItemRemark, a.TransferStatus, 
                              a.TransferDate, a.Status, a.CreateDate, a.LastModifiedDate, a.CreateBy, a.LastModifiedBy";
                        sqlQuery.mainTables =
                            @"FROM PDM.MtlItem a
                              OUTER APPLY(
                                SELECT TOP 1 x1.NewMtlItemName MtlItemName,x1.NewMtlItemSpec MtlItemSpec
                                FROM PDM.MtlItemNoIntegration x1
                                WHERE x1.NewMtlItemNo = @NewMtlItemNo
                                AND x1.MtlItemId = a.MtlItemId
                              ) x
                          ";
                        sqlQuery.auxTables = "";
                        queryCondition = @"AND a.CompanyId = @CompanyId AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("NewMtlItemNo", NewMtlItemNo);

                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = OrderBy.Length > 0 ? OrderBy : "a.MtlItemId";
                        sqlQuery.pageIndex = PageIndex;
                        sqlQuery.pageSize = PageSize;

                        result = BaseHelper.SqlQuery(sqlConnection, dynamicParameters, sqlQuery);

                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = result
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetActionSituationSimple 取得新品號當前操作情境  Shintokuro --2024-12-06
        public string GetActionSituationSimple(string MtlItemNo)
        {
            try
            {
                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    int Situation = GetActionSituation(MtlItemNo, sqlConnection);

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        data = Situation
                    });
                    #endregion
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion
        #endregion

        #region //Add
        #region //AddMtlItem -- 品號資料新增 -- Zoey 2022.10.13
        public string AddMtlItem(int MtlItemId, string MtlItemNo, string MtlItemName, string MtlItemSpec, int InventoryUomId, int PurchaseUomId, int SaleUomId
            , string TypeOne, string TypeTwo, string TypeThree, string TypeFour, int InventoryId, int RequisitionInventoryId, string InventoryManagement, string MtlModify
            , string BondedStore, string ItemAttribute, string LotManagement, string MeasureType, string OverReceiptManagement, string OverDeliveryManagement, string EffectiveDate
            , string ExpirationDate, string MtlItemDesc, string MtlItemRemark, string CustomerMtlItems, int ItemTypeId, string ItemTypeSegmentList, string ItemTypeEnable
            , string AddBillOfMaterials, int EfficientDays, int RetestDays, string ReplenishmentPolicy, string ProductionLine)
        {
            try
            {
                if (MtlItemNo.Length <= 0) throw new SystemException("【品號管理】- 【品號】不能為空!");
                if (MtlItemNo.Length > 40) throw new SystemException("【品號管理】- 【品號】長度錯誤!");
                if (MtlItemName.Length <= 0) throw new SystemException("【品號管理】- 【品名】不能為空!");
                if (MtlItemName.Length > 120) throw new SystemException("【品號管理】- 【品名】長度錯誤!");
                if (MtlItemSpec.Length <= 0) throw new SystemException("【品號管理】- 【規格】不能為空!");
                if (MtlItemSpec.Length > 120) throw new SystemException("【品號管理】- 【規格】長度錯誤!");
                if (InventoryUomId <= 0) throw new SystemException("【品號管理】- 【庫存單位】不能為空!");
                if (PurchaseUomId <= 0) throw new SystemException("【品號管理】- 【採購單位】不能為空!");
                if (SaleUomId <= 0) throw new SystemException("【品號管理】- 【銷售單位】不能為空!");
                if (TypeOne.Length <= 0) throw new SystemException("【品號管理】- 【品號分類(一)】不能為空!");
                if (TypeTwo.Length <= 0) throw new SystemException("【品號管理】- 【品號分類(二)】不能為空!");
                if (TypeThree.Length <= 0) throw new SystemException("【品號管理】- 【品號分類(三)】不能為空!");
                if (TypeFour.Length <= 0) throw new SystemException("【品號管理】- 【品號分類(四)】不能為空!");
                if (InventoryId <= 0) throw new SystemException("【品號管理】- 【主要庫別】不能為空!");
                if (ItemAttribute.Length <= 0) throw new SystemException("【品號管理】- 【品號屬性】不能為空!");
                if (LotManagement.Length <= 0) throw new SystemException("【品號管理】- 【批號管理】不能為空!");
                if (MeasureType.Length <= 0) throw new SystemException("【品號管理】- 【檢驗方式】不能為空!");
                if (ItemTypeEnable == "Y")
                {
                    if (ItemTypeId <= 0) throw new SystemException("【品號管理】- 【品號類別】不能為空!");
                    if (ItemTypeSegmentList.Length <= 0) throw new SystemException("【品號管理】- 【品號類別結構】不能為空!");
                }
                if (ReplenishmentPolicy.Length <= 0) throw new SystemException("【品號管理】- 【補貨政策】不能為空!");

                #region //品號檢核
                if (MtlItemNo.Length <= 0) throw new SystemException("【品號】不可為空");
                if (string.IsNullOrWhiteSpace(MtlItemNo)) throw new SystemException("【品號】不可為空");
                if (string.IsNullOrEmpty(MtlItemNo)) throw new SystemException("【品號】不可為空");

                //24.01.17 加入(是否包含小寫字母)判斷
                if (Regex.IsMatch(MtlItemNo, @"[a-z]"))
                    throw new SystemException("【品號】不可包含小寫字母");

                //24.01.05 加入(有無寬度的空白字元)判斷
                if (Regex.IsMatch(MtlItemNo, @"[\s\u0009-\u000D\u0020\u0085\u00A0\u1680\u2000-\u200A\u2028-\u2029\u202F\u205F\u3000\u180E\u200B-\u200D\u2060\uFEFF\u00B7\u237D\u2420\u2422\u2423]"))
                    throw new SystemException("【品號】不可為空");

                //24.01.05 加入(全形數字 大寫英文 小寫英文)判斷
                if (Regex.IsMatch(MtlItemNo, @"[\uFF10-\uFF19\uFF41-\uFF5A\uFF21-\uFF3A]"))
                    throw new SystemException("【品號】不能包含全形英文及數字!");

                //MtlItemNo是否包含繁簡體中文
                if (Regex.IsMatch(MtlItemNo, @"\p{IsCJKUnifiedIdeographs}") == true)
                    throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");
                if (Regex.IsMatch(MtlItemNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]"))
                    throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");

                MtlItemNo = MtlItemNo.Trim().ToUpper();
                #endregion

                #region //鈺玲程式碼（未研究）
                //if (!CustomerMtlItems.TryParseJson(out JObject tempJObject)) throw new SystemException("客戶品號資料格式錯誤");

                //JObject custMtlyJson = JObject.Parse(CustomerMtlItems);
                //if (!custMtlyJson.ContainsKey("data")) throw new SystemException("客戶品號資料錯誤");

                //JToken custMtlData = custMtlyJson["data"];

                //List<CustomerMtlItem> customerMtlItem = new List<CustomerMtlItem>();

                //for (int i = 0; i < custMtlData.Count(); i++)
                //{
                //    customerMtlItem.Add(
                //        new CustomerMtlItem
                //        {
                //            CustomerId = Convert.ToInt32(custMtlData[i]["customerId"]),
                //            CustomerMtlItemNo = custMtlData[i]["customerMtlItemNo"].ToString(),
                //            CustomerMtlItemName = custMtlData[i]["customerMtlItemName"].ToString(),
                //            CustomerMtlItemSpec = custMtlData[i]["customerMtlItemSpec"].ToString()
                //        });
                //}
                #endregion

                string companyNo = "", departmentNo = "", userNo = "", userName = "";
                string RepeatStr = "";
                string RepeatStatus = "N";
                int MtlItemLenght = MtlItemNo.Length;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        List<int> MtlItemSegmentIdList = new List<int>();
                        List<int> TemporaryList = new List<int>();
                        var ItemTypeSegmentJson = ItemTypeSegmentList.Split(',');
                        string haveSequence = "N";
                        string Sequence = "";
                        string SequenceSort = "";
                        string MtlItemNoLast = "";
                        string SegmentValueS = "";

                        int maxSequence = 0;
                        int SequenceNum = 0; //幾位數
                        string SuffixCode = "N";

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItem");
                        dynamicParameters.Add("DetailCode", "add");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //判斷庫存單位是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.UomId
                            FROM PDM.UnitOfMeasure a
                            WHERE UomId = @InventoryUomId
                            AND CompanyId = @CompanyId";
                        dynamicParameters.Add("InventoryUomId", InventoryUomId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        var resultUomId = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUomId.Count() <= 0) throw new SystemException("【品號管理】－找不到庫存單位!請重新確認");
                        #endregion

                        #region //判斷採購單位是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.UomId
                            FROM PDM.UnitOfMeasure a
                            WHERE UomId = @PurchaseUomId
                            AND CompanyId = @CompanyId";
                        dynamicParameters.Add("PurchaseUomId", PurchaseUomId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        resultUomId = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUomId.Count() <= 0) throw new SystemException("【品號管理】－找不到採購單位!請重新確認");
                        #endregion

                        #region //判斷銷售單位是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.UomId
                            FROM PDM.UnitOfMeasure a
                            WHERE UomId = @SaleUomId
                            AND CompanyId = @CompanyId";
                        dynamicParameters.Add("SaleUomId", SaleUomId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        resultUomId = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUomId.Count() <= 0) throw new SystemException("【品號管理】－找不到銷售單位!請重新確認");
                        #endregion

                        #region //品號編碼相關設定
                        if (ItemTypeEnable == "Y")
                        {
                            //var StructureType = "";
                            //var StructureSort = "";
                            //var StructureSet = "";
                            //var StructureSave = "";
                            //var StructureCustomNum = "";

                            #region //基本判斷
                            #region //判定品號類別是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1 FROM PDM.ItemType
                                    WHERE ItemTypeId = @ItemTypeId";
                            dynamicParameters.Add("ItemTypeId", ItemTypeId);

                            var resultItemType = sqlConnection.Query(sql, dynamicParameters);
                            if (resultItemType.Count() <= 0) throw new SystemException("【品號管理】- 品號類別不存在,請重新確認");
                            #endregion

                            #region //撈取品號結構設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1 FROM PDM.ItemTypeSegment
                                    WHERE ItemTypeId = @ItemTypeId";
                            dynamicParameters.Add("ItemTypeId", ItemTypeId);

                            var resultItemType1 = sqlConnection.Query(sql, dynamicParameters);
                            if (resultItemType1.Count() <= 0) throw new SystemException("【品號管理】- 品號類別結構無資料,請重新確認");
                            #endregion

                            #region //撈取品號結構流水碼設定是否有後綴
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT SuffixCode FROM PDM.ItemTypeSegment
                                    WHERE ItemTypeId = @ItemTypeId
                                    AND SegmentType = 'S'";
                            dynamicParameters.Add("ItemTypeId", ItemTypeId);

                            resultItemType1 = sqlConnection.Query(sql, dynamicParameters);
                            if (resultItemType1.Count() > 0)
                            {
                                foreach (var item in resultItemType1)
                                {
                                    SuffixCode = item.SuffixCode;

                                }
                            }
                            #endregion

                            #endregion

                            #region //判斷品號編碼是否有流水號設定+自定義的是否符合設定
                            foreach (var item in ItemTypeSegmentJson) //品號結構解析
                            {
                                var StructureType = item.Split('❤')[0];
                                var StructureSort = item.Split('❤')[1];
                                var StructureSet = item.Split('❤')[2];
                                var StructureSave = item.Split('❤')[3];
                                var StructureCustomNum = item.Split('❤')[4];

                                if (StructureType == "S") //流水號設定
                                {
                                    haveSequence = "Y";
                                    Sequence = StructureSave;
                                    SequenceSort = StructureSort; //流水號的位置
                                }
                                if (StructureType == "C") //自訂義設定
                                {
                                    if (StructureSave.Substring(StructureSave.Length - 1, 1) == "-")
                                    {
                                        if (StructureSave.Length - 1 != Convert.ToInt32(StructureCustomNum)) throw new SystemException("【品號管理】- 【自訂義編碼】須補滿" + StructureSet + "字元!!!!!!");

                                    }
                                    else
                                    {
                                        if (StructureSave.Length != Convert.ToInt32(StructureCustomNum)) throw new SystemException("【品號管理】- 【自訂義編碼】須補滿" + StructureSet + "字元!!!!!!");

                                    }
                                }
                                if (StructureType == "SV") //編碼節段設定
                                {
                                    if (StructureSet == "") throw new SystemException("【品號管理】- 【編碼節段】未選取請重新確認!!!");
                                }
                            }
                            #endregion

                            if (haveSequence == "Y") //有流水號就要找出其最大值
                            {
                                int num = 0;

                                #region //撈取該組合目前最大值
                                var testNo = MtlItemNo;
                                char charToCount = '?';

                                int SequenceNum1 = MtlItemNo.Count(c => c == charToCount);
                                string Qmark = "";
                                string direction = "One";
                                for (var i = 0; i < SequenceNum1; i++)
                                {
                                    Qmark += "?";
                                }
                                int Noplace = testNo.IndexOf(Qmark);
                                int NoLong = testNo.Length - SequenceNum1;
                                string[] splitStr = { Qmark }; //自行設定切割字串

                                var StrBefore = testNo.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[0];
                                var StrAfter = "";
                                if (Noplace > 0 || Noplace == NoLong)
                                {
                                    if (SuffixCode == "Y")
                                    {
                                        StrAfter = testNo.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[1];
                                        direction = "Two";
                                    }
                                    else
                                    {
                                        string[] resultTestNo = testNo.Split(splitStr, StringSplitOptions.RemoveEmptyEntries);
                                        if (resultTestNo.Length > 1)
                                        {
                                            StrAfter = testNo.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[1];
                                            if (StrAfter != "")
                                            {
                                                direction = "Two";
                                            }
                                        }
                                            
                                    }
                                }
                                dynamicParameters = new DynamicParameters();

                                switch (direction)
                                {
                                    case "Two":
                                        sql = @"SELECT MAX(REPLACE(REPLACE(MtlItemNo, @StrBefore, ''), @StrAfter, '')) maxSequence
                                                    FROM PDM.MtlItem
                                                    WHERE MtlItemNo LIKE @StrBefore +'%'
                                                    AND  MtlItemNo LIKE + '%' + @StrAfter
                                                    AND MtlItemNo NOT LIKE '%(複製)%'
                                                    AND LEN(MtlItemNo) = @MtlItemLenght
                                                    ";
                                        dynamicParameters.Add("StrBefore", StrBefore);
                                        dynamicParameters.Add("StrAfter", StrAfter);
                                        dynamicParameters.Add("MtlItemLenght", MtlItemLenght);
                                        var resultMaxSequence2 = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var item in resultMaxSequence2)
                                        {
                                            maxSequence = Convert.ToInt32(item.maxSequence);
                                        }
                                        break;
                                    case "One":
                                        sql = @"SELECT MAX(REPLACE(MtlItemNo, @StrBefore, '')) maxSequence
                                                        FROM PDM.MtlItem
                                                        WHERE 1=1
                                                        AND MtlItemNo NOT LIKE '%(複製)%'
                                                        AND LEN(MtlItemNo) = @MtlItemLenght
                                                        ";
                                        dynamicParameters.Add("StrBefore", StrBefore);
                                        dynamicParameters.Add("MtlItemLenght", MtlItemLenght);
                                        if (Noplace == 0)
                                        {
                                            sql += " AND MtlItemNo LIKE '%' + @StrBefore ";
                                        }
                                        else if (Noplace == NoLong)
                                        {
                                            sql += " AND MtlItemNo LIKE  @StrBefore + '%'";
                                        }
                                        var resultMaxSequence1 = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var item in resultMaxSequence1)
                                        {
                                            maxSequence = Convert.ToInt32(item.maxSequence);
                                        }
                                        break;
                                }
                                #endregion

                                foreach (var item in ItemTypeSegmentJson) //品號結構解析
                                {
                                    var StructureType = item.Split('❤')[0];
                                    var StructureSort = item.Split('❤')[1];
                                    var StructureSet = item.Split('❤')[2];
                                    var StructureSave = item.Split('❤')[3];
                                    var StructureCustomNum = item.Split('❤')[4];

                                    if (StructureType != "S")
                                    {
                                        #region //判斷品號編碼其組合是否存在
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT DISTINCT MtlItemId
                                            FROM PDM.MtlItemSegment
                                            WHERE SegmentType = @SegmentType
                                            AND SegmentSort = @SegmentSort
                                            AND SaveValue = @SaveValue";
                                        dynamicParameters.Add("SegmentType", StructureType);
                                        dynamicParameters.Add("SegmentSort", StructureSort);
                                        dynamicParameters.Add("SaveValue", StructureSave);

                                        var segmentValueResult = sqlConnection.Query(sql, dynamicParameters);
                                        if (segmentValueResult.Count() > 0) // 有找到就記住其ID,下次再找到要去跟這些ID對比 有存在在往下繼續找
                                        {
                                            foreach (var item1 in segmentValueResult)
                                            {
                                                if (num == 0) //第一次先將找到的id添加進列表
                                                {
                                                    MtlItemSegmentIdList.Add(item1.MtlItemId);
                                                }
                                                else //與列表做比對
                                                {
                                                    var isContain = MtlItemSegmentIdList.Contains(item1.MtlItemId);
                                                    if (isContain == true)
                                                    {
                                                        TemporaryList.Add(item1.MtlItemId);
                                                     }
                                                }
                                            }
                                            if (num != 0)
                                            {
                                                if (TemporaryList.Count() > 0) //比對的暫存表有值
                                                {
                                                    MtlItemSegmentIdList.Clear(); //將符合規格的ID表清空
                                                    foreach (var item1 in TemporaryList) //將暫存表的ID存進去符合規格的ID表
                                                    {
                                                        MtlItemSegmentIdList.Add(item1);
                                                    }
                                                    TemporaryList.Clear(); //將符合規格暫存列表已經放入符合規格ID表中,所以暫存列表可以清空

                                                }
                                                else //找不到代表沒有這個組合,所以迴圈中斷
                                                {
                                                    MtlItemSegmentIdList.Clear(); //將符合規格的ID表清空
                                                    break;
                                                }
                                            }
                                            num++;
                                        }
                                        else //找不到代表沒有這個組合,所以迴圈中斷
                                        {
                                            MtlItemSegmentIdList.Clear(); //將符合規格的ID表清空
                                            break;
                                        }
                                        #endregion
                                    }
                                }

                                if (MtlItemSegmentIdList.Count() > 0) //如果符合規格的列表有值 就要判斷有沒有符合相同規格的流水碼,有的話從中找出目前流水號規則的最大值
                                {
                                    #region //撈取目前組合中最大的流水號
                                    SequenceNum = 0;
                                    if (Sequence.Substring(Sequence.Length - 1, 1) == "-") //先確認我目前流水號的碼數
                                    {
                                        SequenceNum = Sequence.Length - 1;
                                        SuffixCode = "Y";
                                    }
                                    else
                                    {
                                        SequenceNum = Sequence.Length;
                                    }
                                    foreach (var item1 in MtlItemSegmentIdList)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT SegmentType,SegmentSort,SaveValue
                                            FROM PDM.MtlItemSegment
                                            WHERE MtlItemId = @MtlItemId";
                                        dynamicParameters.Add("MtlItemId", item1);
                                        var sequenceResult = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var item2 in sequenceResult)
                                        {
                                            if (item2.SegmentSort.ToString() == SequenceSort) //判斷流水號位置是否相同
                                            {
                                                if (SuffixCode == "Y") //判斷我的流水碼是否有 - 
                                                {
                                                    if ((item2.SaveValue).Substring(item2.SaveValue.Length - 1, 1) == "-") //判斷符合其規格的品號的流水碼是否有 -
                                                    {
                                                        if (SequenceNum == (item2.SaveValue).Length - 1) //判斷符合規個的流水碼數跟目前要存入的流水碼數是否相同
                                                        {
                                                            if (maxSequence < Convert.ToInt32((item2.SaveValue.Substring(0, item2.SaveValue.Length - 1))))
                                                            {
                                                                maxSequence = Convert.ToInt32((item2.SaveValue.Substring(0, item2.SaveValue.Length - 1)));
                                                            }
                                                        }

                                                    }
                                                }
                                                else
                                                {
                                                    if (SequenceNum == (item2.SaveValue).Length)
                                                    {
                                                        if (maxSequence < Convert.ToInt32((item2.SaveValue)))
                                                        {
                                                            maxSequence = Convert.ToInt32((item2.SaveValue));
                                                        }

                                                    }
                                                }
                                            }
                                        }
                                    }


                                    #region //品號生成
                                    foreach (var item in ItemTypeSegmentJson) //品號結構解析
                                    {
                                        var StructureType = item.Split('❤')[0];
                                        var StructureSort = item.Split('❤')[1];
                                        var StructureSet = item.Split('❤')[2];
                                        var StructureSave = item.Split('❤')[3];
                                        var StructureCustomNum = item.Split('❤')[4];


                                        if (StructureType == "S")
                                        {
                                            if (SuffixCode == "Y")
                                            {
                                                SegmentValueS = (maxSequence + 1).ToString().PadLeft(SequenceNum, '0') + "-";

                                                if (maxSequence != 0)
                                                {
                                                    if (SegmentValueS.Length - 1 != Sequence.Length - 1) throw new SystemException("【品號管理】目前流水編號已經到達到最大值");
                                                }
                                                MtlItemNoLast += (maxSequence + 1).ToString().PadLeft(SequenceNum, '0') + "-";
                                            }
                                            else
                                            {
                                                SegmentValueS = (maxSequence + 1).ToString().PadLeft(SequenceNum, '0');

                                                if (maxSequence != 0)
                                                {
                                                    if (SegmentValueS.Length != Sequence.Length) throw new SystemException("【品號管理】目前流水編號已經到達到最大值");
                                                }
                                                MtlItemNoLast += SegmentValueS;

                                            }
                                            maxSequence++;
                                        }
                                        else
                                        {
                                            MtlItemNoLast += StructureSave;
                                        }
                                    }
                                    #endregion

                                    #endregion
                                }
                                else //找不到代表沒有這個組合,所以流水號從1開始
                                {
                                    if (maxSequence <= 0)
                                    {
                                        maxSequence = 1;
                                    }
                                    else
                                    {
                                        maxSequence = maxSequence + 1;
                                    }
                                    if (Sequence.Substring(Sequence.Length - 1, 1) == "-")
                                    {
                                        SequenceNum = Sequence.Length - 1;
                                        Sequence = maxSequence.ToString().PadLeft(SequenceNum, '0') + "-";
                                        SegmentValueS = maxSequence.ToString().PadLeft(SequenceNum, '0') + "-";
                                    }
                                    else
                                    {
                                        SequenceNum = Sequence.Length;
                                        Sequence = maxSequence.ToString().PadLeft(SequenceNum, '0');
                                        SegmentValueS = maxSequence.ToString().PadLeft(SequenceNum, '0');
                                    }

                                    foreach (var item in ItemTypeSegmentJson) //品號結構解析
                                    {
                                        var StructureType = item.Split('❤')[0];
                                        var StructureSort = item.Split('❤')[1];
                                        var StructureSet = item.Split('❤')[2];
                                        var StructureSave = item.Split('❤')[3];
                                        var StructureCustomNum = item.Split('❤')[4];

                                        if (StructureType == "S")
                                        {
                                            if (Sequence.Substring(Sequence.Length - 1, 1) == "-")
                                            {
                                                MtlItemNoLast += Sequence;
                                            }
                                            else
                                            {
                                                MtlItemNoLast += Sequence;
                                            }
                                        }
                                        else
                                        {
                                            MtlItemNoLast += StructureSave;
                                        }
                                    }
                                }
                            }
                            else //直接判斷該品號是否有重複 --沒有流水號設定所以直接看品號是否有重複
                            {
                                #region //判斷品號是否重複
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                    FROM PDM.MtlItem
                                    WHERE MtlItemNo = @MtlItemNo
                                    AND CompanyId = @CompanyId";
                                dynamicParameters.Add("MtlItemNo", MtlItemNo);
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var result = sqlConnection.Query(sql, dynamicParameters);
                                if (result.Count() > 0) throw new SystemException("【品號管理】－【品號】重複，請重新輸入!");
                                #endregion
                            }

                            if (haveSequence == "Y")
                            {
                                if (SegmentValueS == "") throw new SystemException("【品號管理】－【流水碼】有問題沒有取到正確的值，請重新輸入!");
                            }
                        }
                        else
                        {
                            #region //判斷品號是否重複--全部自訂輸入就直接判定是否有重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM PDM.MtlItem
                                    WHERE MtlItemNo = @MtlItemNo
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0) throw new SystemException("【品號管理】－【品號】重複，請重新輸入!");
                            #endregion
                        }
                        #endregion

                        #region //判斷品名是否重複
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.MtlItemName
                            FROM PDM.MtlItem a
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemName", @" AND a.MtlItemName  = @MtlItemName", MtlItemName);

                        var resultRepeat = sqlConnection.Query(sql, dynamicParameters);
                        if (resultRepeat.Count() > 0)
                        {
                            RepeatStatus = "Y";
                        }
                        #endregion

                        string NewMtlItemNo = haveSequence == "Y" ? MtlItemNoLast : MtlItemNo;

                        //24.08.16 僅能包含半形大寫字母/半形數字/減號
                        if (!Regex.IsMatch(NewMtlItemNo, @"^[A-Z0-9-]+$"))
                            throw new SystemException("【品號】格式錯誤!");

                        #region //品號新增
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.MtlItem (CompanyId, ItemTypeId, MtlItemNo, MtlItemName, MtlItemSpec
                                , InventoryUomId, PurchaseUomId, SaleUomId, TypeOne, TypeTwo
                                , TypeThree, TypeFour, InventoryId, RequisitionInventoryId, InventoryManagement
                                , MtlModify, BondedStore, ItemAttribute, ProductionLine, LotManagement, EfficientDays, RetestDays,ReplenishmentPolicy, MeasureType, EffectiveDate
                                , ExpirationDate, OverReceiptManagement, OverDeliveryManagement, Version
                                , MtlItemDesc, MtlItemRemark, TransferStatus, TransferDate, Status
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MtlItemId,INSERTED.MtlItemNo,INSERTED.InventoryUomId
                                VALUES (@CompanyId, @ItemTypeId, @MtlItemNo, @MtlItemName, @MtlItemSpec
                                , @InventoryUomId, @PurchaseUomId, @SaleUomId, @TypeOne, @TypeTwo
                                , @TypeThree, @TypeFour, @InventoryId, @RequisitionInventoryId, @InventoryManagement
                                , @MtlModify, @BondedStore, @ItemAttribute, @ProductionLine, @LotManagement, @EfficientDays, @RetestDays,@ReplenishmentPolicy, @MeasureType, @EffectiveDate
                                , @ExpirationDate, @OverReceiptManagement, @OverDeliveryManagement, @Version
                                , @MtlItemDesc, @MtlItemRemark, @TransferStatus, @TransferDate, @Status
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                ItemTypeId,
                                MtlItemNo = NewMtlItemNo,
                                MtlItemName,
                                MtlItemSpec,
                                InventoryUomId = InventoryUomId > 0 ? (int?)InventoryUomId : null,
                                PurchaseUomId = PurchaseUomId > 0 ? (int?)PurchaseUomId : null,
                                SaleUomId = SaleUomId > 0 ? (int?)SaleUomId : null,
                                TypeOne,
                                TypeTwo,
                                TypeThree,
                                TypeFour,
                                InventoryId = InventoryId > 0 ? (int?)InventoryId : null,
                                RequisitionInventoryId = RequisitionInventoryId > 0 ? (int?)RequisitionInventoryId : null,
                                InventoryManagement,
                                MtlModify,
                                BondedStore,
                                ItemAttribute,
                                ProductionLine,
                                LotManagement,
                                EfficientDays = LotManagement != "N" ? EfficientDays : 0,
                                RetestDays = LotManagement != "N" ? RetestDays : 0,
                                ReplenishmentPolicy,
                                MeasureType,
                                EffectiveDate = EffectiveDate.Length > 0 ? EffectiveDate : null,
                                ExpirationDate = ExpirationDate.Length > 0 ? ExpirationDate : null,
                                OverReceiptManagement,
                                OverDeliveryManagement,
                                Version = "0000",
                                MtlItemDesc,
                                MtlItemRemark,
                                TransferStatus = "N",
                                TransferDate = (int?)null,
                                Status = "A",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });


                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        foreach (var item in insertResult)
                        {
                            MtlItemId = Convert.ToInt32(item.MtlItemId);
                            InventoryUomId = Convert.ToInt32(item.InventoryUomId);
                        }
                        #endregion

                        if (ItemTypeEnable == "Y")
                        {
                            #region //品號類型資料新增
                            foreach (var item in ItemTypeSegmentJson) //品號結構解析
                            {
                                var StructureType = item.Split('❤')[0];
                                var StructureSort = item.Split('❤')[1];
                                var StructureSet = item.Split('❤')[2];
                                var StructureSave = item.Split('❤')[3];
                                var StructureCustomNum = item.Split('❤')[4];

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.MtlItemSegment (MtlItemId, ItemTypeId, SegmentType
                                        , SegmentSort, SegmentValue, SaveValue, SuffixCode
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MtlItemSegmentId
                                        VALUES (@MtlItemId, @ItemTypeId, @SegmentType
                                        , @SegmentSort, @SegmentValue, @SaveValue, @SuffixCode
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MtlItemId,
                                        ItemTypeId,
                                        SegmentType = StructureType,
                                        SegmentSort = StructureSort,
                                        SegmentValue = StructureSet,
                                        SaveValue = StructureType != "S" ? StructureSave : SegmentValueS,
                                        SuffixCode = StructureSave.Substring(StructureSave.Length - 1, 1) == "-" ? "Y" : "N",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });
                                var insertResult1 = sqlConnection.Query(sql, dynamicParameters);
                                int rowsAffected1 = insertResult1.Count();

                            }
                            #endregion
                        }

                        //if (customerMtlItem.Select(x => x.CustomerId).Distinct().Count() != customerMtlItem.Count)
                        //{
                        //    throw new SystemException("【客戶名稱】不能重複!");
                        //}

                        #region //客戶品號新增(停用)
                        //foreach (var custMtl in customerMtlItem)
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"INSERT INTO PDM.CustomerMtlItem (MtlItemId, CustomerId, CustomerMtlItemNo, CustomerMtlItemName, CustomerMtlItemSpec
                        //           , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                        //           OUTPUT INSERTED.CustomerMtlItemId
                        //           VALUES (@MtlItemId, @CustomerId, @CustomerMtlItemNo, @CustomerMtlItemName, @CustomerMtlItemSpec
                        //           , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        //    dynamicParameters.AddDynamicParams(
                        //        new
                        //        {
                        //            MtlItemId,
                        //            custMtl.CustomerId,
                        //            custMtl.CustomerMtlItemNo,
                        //            custMtl.CustomerMtlItemName,
                        //            custMtl.CustomerMtlItemSpec,
                        //            CreateDate,
                        //            LastModifiedDate,
                        //            CreateBy,
                        //            LastModifiedBy
                        //        });

                        //    var result2 = sqlConnection.Query(sql, dynamicParameters);

                        //    rowsAffected += result2.Count();
                        //}
                        #endregion

                        #region //撈取單位ID
                        int uomId = -1;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UomId FROM PDM.UnitOfMeasure
                                WHERE UomNo = 'PCS'
                                AND CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        if (result3.Count() <= 0) throw new SystemException("【品號管理】－單位資料錯誤!");

                        foreach (var item in result3)
                        {
                            uomId = item.UomId;
                        }
                        #endregion

                        if (AddBillOfMaterials == "Y")
                        {
                            #region //Bom主件新增
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO PDM.BillOfMaterials (MtlItemId, UomId, StandardLot, WipPrefix, ModiPrefix, ModiNo, ModiSequence, Version
                                , Remark, ConfirmStatus, ConfirmUserId, ConfirmDate, TransferStatus, TransferDate, Status
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BomId
                                VALUES (@MtlItemId, @UomId, @StandardLot, @WipPrefix, @ModiPrefix, @ModiNo, @ModiSequence, @Version
                                , @Remark, @ConfirmStatus, @ConfirmUserId, @ConfirmDate, @TransferStatus, @TransferDate, @Status
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MtlItemId,
                                    UomId = uomId,
                                    StandardLot = 1,
                                    WipPrefix = 5101,
                                    ModiPrefix = "",
                                    ModiNo = "",
                                    ModiSequence = "",
                                    Version = "0000",
                                    Remark = "",
                                    ConfirmStatus = 'N',
                                    ConfirmUserId = (int?)null,
                                    ConfirmDate = (int?)null,
                                    TransferStatus = 'N',
                                    TransferDate = (int?)null,
                                    Status = 'Y',
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var result4 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += result4.Count();
                            #endregion
                        }

                        #region //品號設定新增
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.MtlItemSetting (MtlItemId, a.FixedLeadTime, a.ChangeLeadTime, a.MinPoQty, a.MultiplePoQty, a.MultipleReqQty
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@MtlItemId, 0, 0, 0, 0, 0
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MtlItemId,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });

                        var result5 = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += result5.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion
                    }

                    if (RepeatStatus == "Y")
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //ERP公司代碼取得
                            string CompanyNoErp = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 ML001  
                                    FROM CMSML";
                            var resultCompanyNo = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in resultCompanyNo)
                            {
                                CompanyNoErp = item.ML001;
                            }
                            if (companyNo != CompanyNoErp) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                            #endregion

                            #region //ERP公司代碼取得
                            string MtlItemNameRepeatSettingERP = "";
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MA037  
                                FROM CMSMA";
                            var resultMtlItemNameRepeatSettingERP = sqlConnection.Query(sql, dynamicParameters);
                            foreach (var item in resultMtlItemNameRepeatSettingERP)
                            {
                                MtlItemNameRepeatSettingERP = item.MA037;
                            }
                            switch (MtlItemNameRepeatSettingERP)
                            {
                                case "1":
                                    RepeatStr += "【品號管理】－ERP設定品名不可以重複";
                                    throw new SystemException(RepeatStr);
                                case "2":
                                    RepeatStr += "【品號管理】－ERP設定品名可以重複";
                                    break;
                                case "3":
                                    RepeatStr += "【品號管理】－ERP設定品名可以重複";
                                    break;

                            }
                            #endregion
                        }
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMtlItemBatch -- 品號資料新增(批量) -- Zoey 2022.10.13
        public string AddMtlItemBatch(string MtlItemData)
        {
            try
            {
                //簡易版本-不支援編碼段類型具有自訂義或是編碼截斷!!
                int rowsAffected = 0;
                if (MtlItemData.Length <= 0) throw new SystemException("【品號管理】- Excel欲新增資料不能為空!");

                string companyNo = "";
                List<Dictionary<string, string>> MtlItemJsonList = JsonConvert.DeserializeObject<List<Dictionary<string, string>>>(MtlItemData);

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        List<string> MtlItemSegmentList = new List<string>();

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItem");
                        dynamicParameters.Add("DetailCode", "add");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");
                        #endregion

                        foreach (var item in MtlItemJsonList)
                        {
                            int MtlItemId = -1;
                            bool SequenceSetting = false;
                            string SequenceStr = ""; //自行設定切割字串
                            string SequenceNum = ""; //自行設定切割字串
                            string MtlItemNo = "";
                            string ItemType = item["ItemType"] != null ? item["ItemType"].ToString() : throw new SystemException("【資料維護不完整】品號類別欄位資料不可以為空,請重新確認~~");
                            string MtlItemName = item["MtlItemName"] != null ? item["MtlItemName"].ToString() : throw new SystemException("【資料維護不完整】品名欄位資料不可以為空,請重新確認~~");
                            string MtlItemSpec = item["MtlItemSpec"] != null ? item["MtlItemSpec"].ToString() : throw new SystemException("【資料維護不完整】規格欄位資料不可以為空,請重新確認~~");
                            string MtlItemDesc = item["MtlItemDesc"] != null ? item["MtlItemDesc"].ToString() : "";
                            string MtlItemRemark = item["MtlItemRemark"] != null ? item["MtlItemRemark"].ToString() : "";
                            string AddBillOfMaterials = "Y";


                            #region //判定品號類別是否存在
                            int ItemTypeId = -1;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 ItemTypeId 
                                    FROM PDM.ItemType
                                    WHERE ItemTypeNo = @ItemTypeNo
                                    AND CompanyId = @CompanyId
                                    ";
                            dynamicParameters.Add("ItemTypeNo", ItemType.Split(':')[0]);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【品號管理】- 品號類別不存在,請重新確認");
                            foreach (var item1 in result)
                            {
                                ItemTypeId = item1.ItemTypeId;
                            }
                            #endregion

                            #region //撈取品號結構設定
                            int sort = 1;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.SegmentType,a.SegmentValue,a.SuffixCode,
                                    CASE 
                                        WHEN b.StatusName = 'YYYYMMDD' THEN FORMAT(GETDATE(), 'yyyyMMdd')
                                        WHEN b.StatusName = 'YYYYMM' THEN FORMAT(GETDATE(), 'yyyyMM')
                                        WHEN b.StatusName = 'YYMM' THEN FORMAT(GETDATE(), 'yyMM')
                                        ELSE NULL
                                    END AS TodayDate
                                    FROM PDM.ItemTypeSegment a
                                    LEFT JOIN BAS.[Status] b ON a.SegmentValue = b.StatusNo AND b.StatusSchema = 'ItemTypeSegment.SegmentValueDate' AND a.SegmentType = 'D'
                                    WHERE a.ItemTypeId = @ItemTypeId
                                    AND a.Status = 'A'
                                    ORDER BY a.SortNumber ASC
                                    ";
                            dynamicParameters.Add("ItemTypeId", ItemTypeId);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【品號管理】- 品號類別結構無資料,請重新確認");
                            foreach (var item1 in result)
                            {
                                string SegmentType = item1.SegmentType;
                                switch (SegmentType)
                                {
                                    case "F":
                                        MtlItemNo += item1.SegmentValue + (item1.SuffixCode == "Y" ? "-" : "");
                                        MtlItemSegmentList.Add(SegmentType + "❤" + sort + "❤" + item1.SegmentValue + "❤" + item1.SegmentValue + "❤" + item1.SuffixCode);
                                        break;
                                    case "D":
                                        MtlItemNo += item1.TodayDate + (item1.SuffixCode == "Y" ? "-" : "");
                                        MtlItemSegmentList.Add(SegmentType + "❤" + sort + "❤" + item1.SegmentValue + "❤" + item1.TodayDate + "❤" + item1.SuffixCode);

                                        break;
                                    case "S":
                                        for (int num = 1; num <= Convert.ToInt32(item1.SegmentValue); num++)
                                        {
                                            SequenceStr += "_";
                                            SequenceNum += "0";
                                        }
                                        MtlItemNo += SequenceStr + (item1.SuffixCode == "Y" ? "-" : "");
                                        SequenceSetting = true;
                                        MtlItemSegmentList.Add(SegmentType + "❤" + sort + "❤" + item1.SegmentValue + "❤" + SequenceStr + "❤" + item1.SuffixCode);
                                        break;
                                    case "SV":
                                    case "C":
                                        throw new SystemException("【品號管理】- 批量新增品號目前不支援編碼段類型具有自訂義或是編碼截斷!!");
                                        break;
                                }
                                sort++;
                            }
                            #endregion

                            #region //撈取品號結構組合最大流水碼
                            if (SequenceSetting)
                            {
                                string[] splitStr = { "*/*" }; //自行設定切割字串

                                string[] parts = MtlItemNo.Split(new string[] { SequenceStr }, StringSplitOptions.None);
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT 
                                        ISNULL(
                                            FORMAT(
                                                MAX(CAST(REPLACE(REPLACE(MtlItemNo, @MtlItemNoLeft, ''), @MtlItemNoRigth, '') AS INT)) + 1,
                                                @SequenceNum
                                            ),
                                            FORMAT(1, @SequenceNum)
                                        ) AS MaxSequence
                                        FROM PDM.MtlItem
                                        WHERE MtlItemNo LIKE @MtlItemNo
                                    ";
                                dynamicParameters.Add("MtlItemNo", MtlItemNo);
                                dynamicParameters.Add("SequenceNum", SequenceNum);
                                dynamicParameters.Add("MtlItemNoLeft", parts[0]);
                                dynamicParameters.Add("MtlItemNoRigth", parts[1]);
                                result = sqlConnection.Query(sql, dynamicParameters);
                                foreach (var item1 in result)
                                {
                                    MtlItemNo = MtlItemNo.Replace(SequenceStr, item1.MaxSequence);
                                    SequenceStr = item1.MaxSequence;
                                }

                            }
                            #endregion

                            #region //判斷品號是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM PDM.MtlItem
                                    WHERE MtlItemNo = @MtlItemNo
                                    AND CompanyId = @CompanyId";
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);
                            dynamicParameters.Add("CompanyId", CurrentCompany);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0) throw new SystemException("【品號管理】－【品號】重複，請重新輸入!");
                            #endregion

                            #region //撈取品號類別的設定值
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1
                                    TypeOne, TypeTwo, TypeThree, TypeFour, InventoryId, 
                                    RequisitionInventoryId, InventoryUomId, ItemAttribute, MeasureType, WeightUomId, PurchaseUomId, SaleUomId, 
                                    LotManagement, InventoryManagement, MtlModify, BondedStore, OverReceiptManagement, 
                                    OverDeliveryManagement
                                    FROM PDM.ItemTypeDefault
                                    WHERE ItemTypeId = @ItemTypeId";
                            dynamicParameters.Add("ItemTypeId", ItemTypeId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() <= 0) throw new SystemException("【品號管理】－品號類別欲設置尚未設定!");
                            foreach (var item1 in result)
                            {
                                #region //品號新增
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.MtlItem (CompanyId, ItemTypeId, MtlItemNo, MtlItemName, MtlItemSpec
                                , InventoryUomId, PurchaseUomId, SaleUomId, TypeOne, TypeTwo
                                , TypeThree, TypeFour, InventoryId, RequisitionInventoryId, InventoryManagement
                                , MtlModify, BondedStore, ItemAttribute, ProductionLine, LotManagement, EfficientDays, RetestDays,ReplenishmentPolicy, MeasureType, EffectiveDate
                                , ExpirationDate, OverReceiptManagement, OverDeliveryManagement, Version
                                , MtlItemDesc, MtlItemRemark, TransferStatus, TransferDate, Status
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MtlItemId,INSERTED.MtlItemNo,INSERTED.InventoryUomId
                                VALUES (@CompanyId, @ItemTypeId, @MtlItemNo, @MtlItemName, @MtlItemSpec
                                , @InventoryUomId, @PurchaseUomId, @SaleUomId, @TypeOne, @TypeTwo
                                , @TypeThree, @TypeFour, @InventoryId, @RequisitionInventoryId, @InventoryManagement
                                , @MtlModify, @BondedStore, @ItemAttribute, @ProductionLine, @LotManagement, @EfficientDays, @RetestDays,@ReplenishmentPolicy, @MeasureType, @EffectiveDate
                                , @ExpirationDate, @OverReceiptManagement, @OverDeliveryManagement, @Version
                                , @MtlItemDesc, @MtlItemRemark, @TransferStatus, @TransferDate, @Status
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        CompanyId = CurrentCompany,
                                        ItemTypeId,
                                        MtlItemNo,
                                        MtlItemName,
                                        MtlItemSpec,
                                        InventoryUomId = item1.InventoryUomId > 0 ? (int?)item1.InventoryUomId : null,
                                        PurchaseUomId = item1.PurchaseUomId > 0 ? (int?)item1.PurchaseUomId : null,
                                        SaleUomId = item1.SaleUomId > 0 ? (int?)item1.SaleUomId : null,
                                        TypeOne = item1.TypeOne,
                                        TypeTwo = item1.TypeTwo,
                                        TypeThree = item1.TypeThree,
                                        TypeFour = item1.TypeFour,
                                        InventoryId = item1.InventoryId > 0 ? (int?)item1.InventoryId : null,
                                        RequisitionInventoryId = item1.RequisitionInventoryId > 0 ? (int?)item1.RequisitionInventoryId : null,
                                        InventoryManagement = item1.InventoryManagement,
                                        MtlModify = item1.MtlModify,
                                        BondedStore = item1.BondedStore,
                                        ItemAttribute = item1.ItemAttribute,
                                        ProductionLine = (int?)null,
                                        LotManagement = item1.LotManagement,
                                        EfficientDays = item1.LotManagement != "N" ? 999 : 0,
                                        RetestDays = item1.LotManagement != "N" ? 999 : 0,
                                        ReplenishmentPolicy = "R",
                                        MeasureType = "2",
                                        EffectiveDate = (int?)null,
                                        ExpirationDate = (int?)null,
                                        OverReceiptManagement = "Y",
                                        OverDeliveryManagement = "Y",
                                        Version = "0000",
                                        MtlItemDesc,
                                        MtlItemRemark,
                                        TransferStatus = "N",
                                        TransferDate = (int?)null,
                                        Status = "A",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });


                                var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult1.Count();

                                foreach (var item2 in insertResult1)
                                {
                                    MtlItemId = Convert.ToInt32(item2.MtlItemId);
                                }
                                #endregion
                            }
                            #endregion


                            #region //撈取單位ID
                            int uomId = -1;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT UomId FROM PDM.UnitOfMeasure
                                WHERE UomNo = 'PCS'
                                AND CompanyId = @CompanyId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            result = sqlConnection.Query(sql, dynamicParameters);

                            if (result.Count() <= 0) throw new SystemException("【品號管理】－單位資料錯誤!");

                            foreach (var item1 in result)
                            {
                                uomId = item1.UomId;
                            }
                            #endregion

                            if (AddBillOfMaterials == "Y")
                            {
                                #region //Bom主件新增
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.BillOfMaterials (MtlItemId, UomId, StandardLot, WipPrefix, ModiPrefix, ModiNo, ModiSequence, Version
                                , Remark, ConfirmStatus, ConfirmUserId, ConfirmDate, TransferStatus, TransferDate, Status
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.BomId
                                VALUES (@MtlItemId, @UomId, @StandardLot, @WipPrefix, @ModiPrefix, @ModiNo, @ModiSequence, @Version
                                , @Remark, @ConfirmStatus, @ConfirmUserId, @ConfirmDate, @TransferStatus, @TransferDate, @Status
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MtlItemId,
                                        UomId = uomId,
                                        StandardLot = 1,
                                        WipPrefix = 5101,
                                        ModiPrefix = "",
                                        ModiNo = "",
                                        ModiSequence = "",
                                        Version = "0000",
                                        Remark = "",
                                        ConfirmStatus = 'N',
                                        ConfirmUserId = (int?)null,
                                        ConfirmDate = (int?)null,
                                        TransferStatus = 'N',
                                        TransferDate = (int?)null,
                                        Status = 'Y',
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult1 = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult1.Count();
                                #endregion
                            }

                            #region //品號設定新增
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO PDM.MtlItemSetting (MtlItemId, a.FixedLeadTime, a.ChangeLeadTime, a.MinPoQty, a.MultiplePoQty, a.MultipleReqQty
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES (@MtlItemId, 0, 0, 0, 0, 0
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MtlItemId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });

                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += result.Count();
                            #endregion

                            #region //品號類型資料新增
                            foreach (var item1 in MtlItemSegmentList) //品號結構解析
                            {
                                var StructureType = item1.Split('❤')[0];
                                var StructureSort = item1.Split('❤')[1];
                                var StructureSet = item1.Split('❤')[2];
                                var StructureSave = item1.Split('❤')[3];
                                var SuffixCode = item1.Split('❤')[4];

                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.MtlItemSegment (MtlItemId, ItemTypeId, SegmentType
                                        , SegmentSort, SegmentValue, SaveValue, SuffixCode
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MtlItemSegmentId
                                        VALUES (@MtlItemId, @ItemTypeId, @SegmentType
                                        , @SegmentSort, @SegmentValue, @SaveValue, @SuffixCode
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MtlItemId,
                                        ItemTypeId,
                                        SegmentType = StructureType,
                                        SegmentSort = StructureSort,
                                        SegmentValue = StructureSet,
                                        SaveValue = StructureType != "S" ? StructureSave : SequenceStr,
                                        SuffixCode,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });
                                insertResult = sqlConnection.Query(sql, dynamicParameters);
                                rowsAffected += insertResult.Count();

                            }
                            #endregion
                        }


                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBomDetail -- Bom元件新增 -- Zoey 2022.12.06 
        public string AddBomDetail(int BomId, int MtlItemId, string BomSequence, double CompositionQuantity, double Base
            , double LossRate, string StandardCostingType, string MaterialProperties, string EffectiveDate, string ExpirationDate, string Remark, string ComponentType)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【元件品號】不能為空!");
                if (BomSequence.Length <= 0) throw new SystemException("【序號】不能為空!");
                if (BomSequence.Length > 4) throw new SystemException("【序號】長度錯誤!");
                if (CompositionQuantity < 0) throw new SystemException("【單位用量】不能為空!");
                if (Base < 0) throw new SystemException("【底數】不能為空!");
                if (LossRate < 0) throw new SystemException("【損壞率】不能為空!");
                if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                if (StandardCostingType != "Y" && StandardCostingType != "N") throw new SystemException("【標準成本計算】不能為空!");
                if (MaterialProperties != "1" && MaterialProperties != "2" && MaterialProperties != "3" && MaterialProperties != "4" && MaterialProperties != "5") throw new SystemException("【材料性質】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    string companyNo = "", mtlItemNo = "";
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string TransferStatus = "";
                        int rowsAffected = 0;

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷BOM單頭是否存在
                        sql = @"SELECT TOP 1 MtlItemId
                                FROM PDM.BillOfMaterials
                                WHERE BomId = @BomId";
                        dynamicParameters.Add("BomId", BomId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("【BOM單頭】找不到資料，請重新確認!");
                        foreach (var item in result)
                        {
                            if (item.MtlItemId == MtlItemId) throw new SystemException("BOM主件品號和元件品號不能相同，請重新確認!");
                        }
                        #endregion

                        #region //判斷元件品號是否重複
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomDetail
                                WHERE MtlItemId = @MtlItemId
                                AND BomId = @BomId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("BomId", BomId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【元件品號】重複，請重新選擇!");
                        #endregion

                        #region //確認元件品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.InventoryUomId,TransferStatus,MtlItemNo,TypeOne
                                , ISNULL(EffectiveDate, '') as EffectiveDate
                                , ISNULL(ExpirationDate, '') as ExpirationDate
                                FROM PDM.MtlItem a 
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var MtlItemResult = sqlConnection.Query(sql, dynamicParameters);
                        if (!MtlItemResult.Any()) throw new SystemException("品號資料錯誤!!");
                        int uomId = -1;
                        foreach (var item in MtlItemResult)
                        {
                            if(item.TypeOne == "06" && CurrentCompany == 3) throw new SystemException(string.Format("品號{0}</br>屬於費用類,不可被當元件", mtlItemNo));
                            mtlItemNo = item.MtlItemNo;
                            if (item.TransferStatus != "Y") throw new SystemException(string.Format("品號{0}</br>尚未拋轉ERP", mtlItemNo));
                            else uomId = item.InventoryUomId;
                            #region //判斷品號是否已經失效
                            string effectiveDate = item.EffectiveDate.ToString("yyyy-MM-dd");
                            if (effectiveDate != "1900-01-01" && CreateDate.CompareTo(item.EffectiveDate) < 0)
                                throw new SystemException(string.Format("【元件品號】</br>{0}</br>{1}生效</br>目前無法使用!", mtlItemNo, effectiveDate));

                            string expirationDate = item.ExpirationDate.ToString("yyyy-MM-dd");
                            if (expirationDate != "1900-01-01" && CreateDate.CompareTo(item.ExpirationDate) > 0)
                                throw new SystemException(string.Format("【元件品號】</br>{0}</br>{1}到期</br>已無法使用!", mtlItemNo, expirationDate));
                            #endregion
                        }
                        #endregion

                        using (SqlConnection erpConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //取得ERP品號資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 LTRIM(RTRIM(MB030)) MB030, LTRIM(RTRIM(MB031)) MB031
                                    FROM INVMB
                                    WHERE MB001 = @MtlItemNo";
                            dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            var resultINVMB = erpConnection.Query(sql, dynamicParameters);

                            #region //判斷ERP品號是否存在
                            if (!resultINVMB.Any()) throw new SystemException(string.Format("ERP不存在該品號</br>{0}", mtlItemNo));
                            #endregion

                            foreach (var item in resultINVMB)
                            {
                                #region //判斷品號是否已經失效
                                if (DateTime.TryParseExact(item.MB030, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DateTime mb030))
                                {
                                    string MB030 = mb030.ToString("yyyy-MM-dd");
                                    if (MB030 != "1900-01-01" && CreateDate.CompareTo(mb030) < 0)
                                        throw new SystemException(string.Format("【ERP元件品號】</br>{0}</br>{1}生效</br>目前無法使用!", mtlItemNo, MB030));
                                }
                                if (DateTime.TryParseExact(item.MB031, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DateTime mb031))
                                {
                                    string MB031 = mb031.ToString("yyyy-MM-dd");
                                    if (MB031 != "1900-01-01" && CreateDate.CompareTo(mb031) > 0)
                                        throw new SystemException(string.Format("【ERP元件品號】</br>{0}</br>{1}到期</br>已無法使用!", mtlItemNo, MB031));
                                }
                                #endregion
                            }
                            #endregion

                            #region//判斷品號否已經失效 (停用)
                            //var expirationDate = CreateDate.ToString("yyyyMMdd");

                            //dynamicParameters = new DynamicParameters();
                            //sql = @"SELECT TOP 1 MB031
                            //        FROM INVMB
                            //        WHERE MB001 = @MtlItemNo
                            //        AND MB031 !='' AND MB031 IS NOT NULL";
                            //dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            //dynamicParameters.Add("MB031", expirationDate);
                            //var result2INVMB = erpConnection.Query(sql, dynamicParameters);
                            //if (result2INVMB.Any())
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"SELECT TOP 1 MB031
                            //        FROM INVMB
                            //        WHERE MB001 = @MtlItemNo
                            //        AND MB031 <= @MB031 ";
                            //    dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            //    dynamicParameters.Add("MB031", expirationDate);
                            //    var result3INVMB = erpConnection.Query(sql, dynamicParameters);
                            //    if (result3INVMB.Any())
                            //        throw new SystemException(string.Format("ERP在該品號已失效</br>{0}", mtlItemNo));
                            //}
                            #endregion
                        }

                        #region //撈取拋轉狀態
                        sql = @"SELECT TransferStatus
                                FROM PDM.BillOfMaterials
                                WHERE BomId = @BomId";
                        dynamicParameters.Add("BomId", BomId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result3)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        #endregion

                        if (TransferStatus != "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO PDM.BomDetail (BomId, BomSequence, MtlItemId, UomId, CompositionQuantity, Base, LossRate
                                    , StandardCostingType, MaterialProperties
                                    , ReleaseItem, EffectiveDate, ExpirationDate, Remark, SubstitutionRemark, ConfirmStatus, ComponentType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BomDetailId
                                    VALUES (@BomId, @BomSequence, @MtlItemId, @UomId, @CompositionQuantity, @Base, @LossRate
                                    , @StandardCostingType, @MaterialProperties
                                    , @ReleaseItem, @EffectiveDate, @ExpirationDate, @Remark, @SubstitutionRemark, @ConfirmStatus, @ComponentType
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BomId,
                                    BomSequence,
                                    MtlItemId,
                                    UomId = uomId,
                                    CompositionQuantity,
                                    Base,
                                    LossRate,
                                    StandardCostingType,
                                    MaterialProperties,
                                    ReleaseItem = "",
                                    EffectiveDate = EffectiveDate.Length > 0 ? EffectiveDate : null,
                                    ExpirationDate = ExpirationDate.Length > 0 ? ExpirationDate : null,
                                    Remark,
                                    SubstitutionRemark = "",
                                    ConfirmStatus = "N",
                                    ComponentType,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected = insertResult.Count();
                        }
                        else {
                            throw new SystemException("【ERP元件】已拋轉，不可重複拋轉");
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBomSubstitution -- 取替代料資料新增 -- Zoey 2022.12.08
        public string AddBomSubstitution(int MainMtlItemId, int BomDetailId, string SubstituteStatus, int MtlItemId, double Quantity, int SortNumber, string Precedence, string EffectiveDate, string ExpirationDate, string Remark)
        {
            try
            {
                if (MainMtlItemId <= 0) throw new SystemException("【主件品號】不能為空!");
                if (BomDetailId <= 0) throw new SystemException("【元件】不能為空!");
                if (SubstituteStatus.Length <= 0) throw new SystemException("【類別】不能為空!");
                if (MtlItemId < 0) throw new SystemException("【品號】不能為空!");
                if (Quantity < 0) throw new SystemException("【數量】不能為空!");
                if (SortNumber < 0) throw new SystemException("【順序】不能為空!");
                if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    string companyNo = "", mtlItemNo = "";
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //取得主件品號資料
                        sql = @"SELECT TOP 1 TransferStatus,MtlItemNo
	                            , ISNULL(EffectiveDate, '') as EffectiveDate
	                            , ISNULL(ExpirationDate, '') as ExpirationDate
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MainMtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);

                        #region //判斷主件品號是否正確
                        if (!result.Any()) throw new SystemException("【主件品號】資料錯誤!");
                        #endregion

                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo;

                            #region //判斷品號是否已經失效
                            string effectiveDate = item.EffectiveDate.ToString("yyyy-MM-dd");
                            if (effectiveDate != "1900-01-01" && CreateDate.CompareTo(item.EffectiveDate) < 0)
                                throw new SystemException(string.Format("【主件品號】</br>{0}</br>{1}生效</br>目前無法使用!", mtlItemNo, effectiveDate));

                            string expirationDate = item.ExpirationDate.ToString("yyyy-MM-dd");
                            if (expirationDate != "1900-01-01" && CreateDate.CompareTo(item.ExpirationDate) > 0)
                                throw new SystemException(string.Format("【主件品號】</br>{0}</br>{1}到期</br>已無法使用!", mtlItemNo, expirationDate));
                            #endregion
                        }
                        #endregion

                        #region //判斷取替代料是否與主件相同
                        if (MainMtlItemId == MtlItemId) throw new SystemException("【品號】不得與主件相同!");
                        #endregion

                        #region //判斷取替代料是否為自己元件或主件
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomDetail a
                                WHERE a.BomDetailId = @BomDetailId
                                AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("BomDetailId", BomDetailId);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Any()) throw new SystemException("【品號】不得與元件相同!");
                        #endregion

                        #region //取得取替代件品號資料
                        sql = @"SELECT TOP 1 TransferStatus,MtlItemNo,TypeOne
	                            , ISNULL(EffectiveDate, '') as EffectiveDate
	                            , ISNULL(ExpirationDate, '') as ExpirationDate
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);

                        #region //判斷取替代件品號是否正確
                        if (!result.Any()) throw new SystemException("【取替代件品號】資料錯誤!");
                        #endregion

                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo;
                            if (item.TransferStatus != "Y")
                            {
                                throw new SystemException(string.Format("【取替代件品號】{0}</br>尚未拋轉ERP", mtlItemNo));
                            }
                            if (item.TypeOne == "06" && CurrentCompany == 3) throw new SystemException(string.Format("品號{0}</br>屬於費用類,不可被當元件", mtlItemNo));

                            #region //判斷品號是否已經失效
                            var effectiveDate = item.EffectiveDate.ToString("yyyy-MM-dd");
                            if (effectiveDate != "1900-01-01" && CreateDate.CompareTo(item.EffectiveDate) < 0)
                                throw new SystemException(string.Format("【取替代件品號】</br>{0}</br>{1}生效</br>目前無法使用!", mtlItemNo, effectiveDate));

                            var expirationDate = item.ExpirationDate.ToString("yyyy-MM-dd");
                            if (expirationDate != "1900-01-01" && CreateDate.CompareTo(item.ExpirationDate) > 0)
                                throw new SystemException(string.Format("【取替代件品號】</br>{0}</br>{1}到期</br>已無法使用!", mtlItemNo, expirationDate));
                            #endregion
                        }
                        #endregion

                        using (SqlConnection erpConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //取得ERP取替代件資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 LTRIM(RTRIM(MB030)) MB030, LTRIM(RTRIM(MB031)) MB031
                                    FROM INVMB
                                    WHERE MB001 = @MtlItemNo";
                            dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            var resultINVMB = erpConnection.Query(sql, dynamicParameters);

                            #region //判斷ERP品號是否存在
                            if (!resultINVMB.Any()) throw new SystemException(string.Format("ERP不存在該品號</br>{0}", mtlItemNo));
                            #endregion

                            foreach (var item in resultINVMB)
                            {
                                #region //判斷品號是否已經失效
                                if (DateTime.TryParseExact(item.MB030, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DateTime mb030))
                                {
                                    string MB030 = mb030.ToString("yyyy-MM-dd");
                                    if (MB030 != "1900-01-01" && CreateDate.CompareTo(mb030) < 0)
                                        throw new SystemException(string.Format("【ERP取替代件品號】</br>{0}</br>{1}生效</br>目前無法使用!", mtlItemNo, MB030));
                                }
                                if (DateTime.TryParseExact(item.MB031, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DateTime mb031))
                                {
                                    string MB031 = mb031.ToString("yyyy-MM-dd");
                                    if (MB031 != "1900-01-01" && CreateDate.CompareTo(mb031) > 0)
                                        throw new SystemException(string.Format("【ERP取替代件品號】</br>{0}</br>{1}到期</br>已無法使用!", mtlItemNo, MB031));
                                }
                                #endregion
                            }
                            #endregion
                        }

                        #region //判斷順序及品號是否重複
                        sql = @"SELECT MtlItemId, SortNumber
                                FROM PDM.BomSubstitution
                                WHERE BomDetailId = @BomDetailId
                                AND SubstituteStatus = @SubstituteStatus";
                        dynamicParameters.Add("BomDetailId", BomDetailId);
                        dynamicParameters.Add("SubstituteStatus", SubstituteStatus);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Any(a => a.SortNumber == SortNumber)) throw new SystemException("【順序】重複，請重新輸入!");
                        if (result.Any(a => a.MtlItemId == MtlItemId)) throw new SystemException("【品號】重複，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.BomSubstitution (BomDetailId, SubstituteStatus, MtlItemId, Quantity, SortNumber
                                , Precedence, EffectiveDate, ExpirationDate, Remark, TransferStatus, TransferDate, Status
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.SubstitutionId
                                VALUES (@BomDetailId, @SubstituteStatus, @MtlItemId, @Quantity, @SortNumber
                                , @Precedence, @EffectiveDate, @ExpirationDate, @Remark, @TransferStatus, @TransferDate, @Status
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BomDetailId,
                                SubstituteStatus,
                                MtlItemId,
                                Quantity,
                                SortNumber,
                                Precedence,
                                EffectiveDate = EffectiveDate.Length > 0 ? EffectiveDate : null,
                                ExpirationDate = ExpirationDate.Length > 0 ? ExpirationDate : null,
                                Remark,
                                TransferStatus = "N",
                                TransferDate = (DateTime?)null,
                                Status = "A",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddCustomerMtlItem -- 部番資料新增 -- Zoey 2023.01.16
        public string AddCustomerMtlItem(int MtlItemId, int CustomerId, string CustomerMtlItemNo, string CustomerMtlItemName, string CustomerMtlItemSpec, int PoCompanyId, string PoErpPrefixNo, string PoSeq)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【品號】資料錯誤!");
                if (CustomerId <= 0) throw new SystemException("【客戶名稱】不能為空!");
                if (CustomerMtlItemNo.Length <= 0) throw new SystemException("【客戶品號】不能為空!");
                if (CustomerMtlItemNo.Length > 50) throw new SystemException("【客戶品號】長度錯誤!");
                if (CustomerMtlItemName.Length > 200) throw new SystemException("【客戶品名】長度錯誤!");
                if (CustomerMtlItemSpec.Length > 200) throw new SystemException("【客戶品號規格】長度錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0;

                    string transferStatus = "", ErpNo = "", CREATOR = "", MtlItemNo = "", CustomerNo = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (!(string.IsNullOrWhiteSpace(PoErpPrefixNo) && string.IsNullOrWhiteSpace(PoSeq)))
                        {
                            #region //取得ERP採購單公司別DB
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                            dynamicParameters.Add("CompanyId", PoCompanyId);

                            var resultPoCompany = sqlConnection.Query(sql, dynamicParameters);

                            if (resultPoCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                            string PoErpConnectionStrings = string.Empty;
                            foreach (var item in resultPoCompany)
                            {
                                PoErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            }
                            #endregion

                            if (!string.IsNullOrWhiteSpace(PoErpConnectionStrings))
                            {
                                using (SqlConnection erpConnection = new SqlConnection(PoErpConnectionStrings))
                                {
                                    #region //檢查ERP採購單資料是否正確
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.COMPANY
                                            , LTRIM(RTRIM(a.TD001)) AS TD001, LTRIM(RTRIM(a.TD002)) AS TD002, LTRIM(RTRIM(a.TD003)) AS TD003
                                            FROM PURTD a
                                            WHERE LTRIM(RTRIM(a.TD001)) + '-' + LTRIM(RTRIM(a.TD002)) = @PoErpPrefixNo
                                            AND LTRIM(RTRIM(a.TD003)) = @PoSeq";
                                    dynamicParameters.Add("PoErpPrefixNo", PoErpPrefixNo);
                                    dynamicParameters.Add("PoSeq", PoSeq);
                                    var resultPURTD = erpConnection.Query(sql, dynamicParameters);
                                    if (resultPURTD.Count() <= 0) throw new SystemException("【客戶採購單】資料錯誤!");
                                    #endregion
                                }
                            }
                        }

                        #region //判斷客戶名稱是否重複
                        sql = @"SELECT TOP 1 1
                                FROM PDM.CustomerMtlItem
                                WHERE CustomerId = @CustomerId
                                AND MtlItemId = @MtlItemId
                                AND CustomerMtlItemNo = @CustomerMtlItemNo";
                        dynamicParameters.Add("CustomerId", CustomerId);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("CustomerMtlItemNo", CustomerMtlItemNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【客戶品號】重複，請重新選擇!");
                        #endregion

                        #region //判斷客戶名稱是否重複
                        //sql = @"SELECT TOP 1 1
                        //        FROM PDM.CustomerMtlItem a
                        //        INNER JOIN PDM.MtlItem b on b.MtlItemId = a.MtlItemId
                        //        WHERE a.CustomerId = @CustomerId
                        //        AND a.MtlItemId = @MtlItemId
                        //        AND b.MtlItemNo = @CustomerMtlItemNo";
                        //dynamicParameters.Add("CustomerId", CustomerId);
                        //dynamicParameters.Add("MtlItemId", MtlItemId);
                        //dynamicParameters.Add("CustomerMtlItemNo", CustomerMtlItemNo);
                        //var result = sqlConnection.Query(sql, dynamicParameters);
                        //if (result.Count() > 0) throw new SystemException("【客戶名稱】重複，請重新選擇!");
                        #endregion

                        #region //撈取品號拋轉狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TransferStatus
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result2)
                        {
                            transferStatus = item.TransferStatus;
                        }
                        #endregion

                        #region //新增BM客戶品號
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.CustomerMtlItem (MtlItemId, CustomerId, PoErpFullNo, PoSeq, CustomerMtlItemNo, CustomerMtlItemName, CustomerMtlItemSpec
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.CustomerMtlItemId
                                VALUES (@MtlItemId, @CustomerId, @PoErpFullNo, @PoSeq, @CustomerMtlItemNo, @CustomerMtlItemName, @CustomerMtlItemSpec
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MtlItemId,
                                CustomerId,
                                PoErpFullNo = string.IsNullOrWhiteSpace(PoErpPrefixNo) ? null : PoErpPrefixNo,
                                PoSeq = string.IsNullOrWhiteSpace(PoSeq) ? null : PoSeq,
                                CustomerMtlItemNo,
                                CustomerMtlItemName,
                                CustomerMtlItemSpec,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected = insertResult.Count();
                        #endregion

                        if (transferStatus == "Y")
                        {
                            #region //確認公司別DB
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var resultCompanty = sqlConnection.Query(sql, dynamicParameters);

                            if (resultCompanty.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                            foreach (var item in resultCompanty)
                            {
                                ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                                ErpNo = item.ErpNo;
                            }
                            #endregion

                            #region //撈取使用者No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UserNo
                                    FROM BAS.[User] a
                                    WHERE a.UserId = @userId";
                            dynamicParameters.Add("userId", CurrentUser);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result3)
                            {
                                CREATOR = item.UserNo;
                            }
                            #endregion

                            #region //撈取品號No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemNo
                                    FROM PDM.MtlItem
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result4)
                            {
                                MtlItemNo = item.MtlItemNo;
                            }
                            #endregion

                            #region //撈取客戶No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT CustomerNo
                                    FROM SCM.Customer
                                    WHERE CustomerId = @CustomerId";
                            dynamicParameters.Add("CustomerId", CustomerId);

                            var result5 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result5)
                            {
                                CustomerNo = item.CustomerNo;
                            }
                            #endregion
                        }
                    }

                    if (transferStatus == "Y")
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //新增ERP客戶品號
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO COPMG (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                    , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                    , MG001, MG002, MG003, MG004, MG005, MG006, MG007, MG008, MG009, MG010
                                    , MG011, MG012, MG013
                                    , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                    VALUES (@COMPANY, @CREATOR, '', @CREATE_DATE, '', @MODI_DATE
                                    , '1', @CREATE_TIME, @CREATE_AP, 'BM', @MODI_TIME, '', ''
                                    , @MG001, @MG002, @MG003, '', @MG005, @MG006, 0, 0, '', ''
                                    , '', 0, 0
                                    , '', '', '', '', '', 0, 0, 0, 0, 0)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    COMPANY = ErpNo,
                                    CREATOR,
                                    CREATE_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                    MODI_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                    CREATE_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                    CREATE_AP = BaseHelper.ClientComputer(),
                                    MODI_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                    MG001 = CustomerNo,
                                    MG002 = MtlItemNo,
                                    MG003 = CustomerMtlItemNo,
                                    MG005 = CustomerMtlItemName,
                                    MG006 = CustomerMtlItemSpec
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected = insertResult.Count();
                            #endregion
                        }
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddCopyMtlItem -- 複製品號 -- Zoey 2023.01.30
        public string AddCopyMtlItem(int MtlItemId)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【品號】資料錯誤!");
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int newMtlItemId = -1, BomId = -1, BomDetailId = -1, rowsAffected = -1;
                        string MtlItemNo = "";

                        #region //MtlItemNo是否包含繁簡體中文
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemNo
                                    FROM PDM.MtlItem
                                    WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var MtlItemNoResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoResult.Count() != 1) throw new SystemException("【品號管理】－查無【品號】，請重新輸入!");
                        foreach (var item in MtlItemNoResult)
                        {
                            MtlItemNo = item.MtlItemNo;
                        }

                        #region //品號檢核
                        if (MtlItemNo.Length <= 0) throw new SystemException("【品號】不可為空");
                        if (string.IsNullOrWhiteSpace(MtlItemNo)) throw new SystemException("【品號】不可為空");
                        if (string.IsNullOrEmpty(MtlItemNo)) throw new SystemException("【品號】不可為空");

                        //24.08.16 僅能包含半形大寫字母/半形數字/減號
                        if (!Regex.IsMatch(MtlItemNo, @"^[A-Z0-9-]+$"))
                            throw new SystemException("【品號】格式錯誤!");

                        //24.01.17 加入(是否包含小寫字母)判斷
                        if (Regex.IsMatch(MtlItemNo, @"[a-z]"))
                            throw new SystemException("【品號】不可包含小寫字母");

                        //24.01.05 加入(有無寬度的空白字元)判斷
                        if (Regex.IsMatch(MtlItemNo, @"[\s\u0009-\u000D\u0020\u0085\u00A0\u1680\u2000-\u200A\u2028-\u2029\u202F\u205F\u3000\u180E\u200B-\u200D\u2060\uFEFF\u00B7\u237D\u2420\u2422\u2423]"))
                            throw new SystemException("【品號】不可為空");

                        //24.01.05 加入(全形數字 大寫英文 小寫英文)判斷
                        if (Regex.IsMatch(MtlItemNo, @"[\uFF10-\uFF19\uFF41-\uFF5A\uFF21-\uFF3A]"))
                            throw new SystemException("【品號】不能包含全形英文及數字!");

                        //MtlItemNo是否包含繁簡體中文
                        if (Regex.IsMatch(MtlItemNo, @"\p{IsCJKUnifiedIdeographs}") == true)
                            throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");
                        if (Regex.IsMatch(MtlItemNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]"))
                            throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");
                        #endregion

                        #endregion                        

                        #region //品號新增
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"INSERT INTO PDM.MtlItem OUTPUT INSERTED.MtlItemId
                        //        SELECT CompanyId,@ItemTypeId, MtlItemNo + '(複製)' MtlItemNo, MtlItemName, MtlItemSpec, InventoryUomId
                        //        , PurchaseUomId, SaleUomId, TypeOne, TypeTwo, TypeThree, TypeFour
                        //        , InventoryId, RequisitionInventoryId, InventoryManagement, MtlModify, BondedStore
                        //        , ItemAttribute, ProductionLine, LotManagement, EfficientDays, RetestDays, MeasureType, @EffectiveDate, @ExpirationDate
                        //        , OverReceiptManagement, OverDeliveryManagement, @Version, MtlItemDesc, MtlItemRemark,'R' ReplenishmentPolicy
                        //        , @TransferStatus, @TransferDate, @Status, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy
                        //        FROM PDM.MtlItem
                        //        WHERE MtlItemId = @MtlItemId";
                        //dynamicParameters.AddDynamicParams(
                        //    new
                        //    {
                        //        ItemTypeId = (int?)null,
                        //        EffectiveDate = (DateTime?)null,
                        //        ExpirationDate = (DateTime?)null,                                
                        //        Version = "0000",
                        //        TransferStatus = "N",
                        //        TransferDate = (DateTime?)null,
                        //        Status = "A",
                        //        CreateDate,
                        //        LastModifiedDate,
                        //        CreateBy,
                        //        LastModifiedBy,
                        //        MtlItemId
                        //    });
                        //var result = sqlConnection.Query(sql, dynamicParameters);
                        //int rowsAffected = result.Count();
                        //foreach (var item in result)
                        //{
                        //    newMtlItemId = Convert.ToInt32(item.MtlItemId);
                        //}
                        #endregion

                        #region//品號新增 v2
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT CompanyId, MtlItemNo + '(複製)' MtlItemNo, MtlItemName, MtlItemSpec, InventoryUomId
                                , PurchaseUomId, SaleUomId, TypeOne, TypeTwo, TypeThree, TypeFour
                                , InventoryId, RequisitionInventoryId, InventoryManagement, MtlModify, BondedStore
                                , ItemAttribute, ProductionLine, LotManagement, EfficientDays, RetestDays, MeasureType
                                , OverReceiptManagement, OverDeliveryManagement,'0000' Version, MtlItemDesc, MtlItemRemark,ISNULL(ReplenishmentPolicy,'R') ReplenishmentPolicy
                                , 'N' TransferStatus, Status
                                FROM PDM.MtlItem a                                
                                WHERE a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                #region//新增 v2
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.MtlItem (CompanyId, MtlItemNo, MtlItemName, MtlItemSpec
                                    , InventoryUomId, PurchaseUomId, SaleUomId, TypeOne, TypeTwo
                                    , TypeThree, TypeFour, InventoryId, RequisitionInventoryId, InventoryManagement
                                    , MtlModify, BondedStore, ItemAttribute, ProductionLine, LotManagement, EfficientDays, RetestDays,ReplenishmentPolicy, MeasureType
                                    , OverReceiptManagement, OverDeliveryManagement, Version
                                    , MtlItemDesc, MtlItemRemark,TransferStatus, Status
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MtlItemId,INSERTED.MtlItemNo,INSERTED.InventoryUomId
                                    VALUES (@CompanyId, @MtlItemNo, @MtlItemName, @MtlItemSpec
                                    , @InventoryUomId, @PurchaseUomId, @SaleUomId, @TypeOne, @TypeTwo
                                    , @TypeThree, @TypeFour, @InventoryId, @RequisitionInventoryId, @InventoryManagement
                                    , @MtlModify, @BondedStore, @ItemAttribute, @ProductionLine, @LotManagement, @EfficientDays, @RetestDays,@ReplenishmentPolicy, @MeasureType
                                    , @OverReceiptManagement, @OverDeliveryManagement, @Version                                   
                                    , @MtlItemDesc, @MtlItemRemark,@TransferStatus, @Status
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      CompanyId = CurrentCompany,
                                      item.MtlItemNo,
                                      item.MtlItemName,
                                      item.MtlItemSpec,
                                      item.InventoryUomId,
                                      item.PurchaseUomId,
                                      item.SaleUomId,
                                      item.TypeOne,
                                      item.TypeTwo,
                                      item.TypeThree,
                                      item.TypeFour,
                                      item.InventoryId,
                                      item.RequisitionInventoryId,
                                      item.InventoryManagement,
                                      item.MtlModify,
                                      item.BondedStore,
                                      item.ItemAttribute,
                                      item.ProductionLine,
                                      item.LotManagement,
                                      item.EfficientDays,
                                      item.RetestDays,
                                      item.ReplenishmentPolicy,
                                      item.MeasureType,
                                      item.OverReceiptManagement,
                                      item.OverDeliveryManagement,
                                      item.Version,
                                      item.MtlItemDesc,
                                      item.MtlItemRemark,
                                      item.TransferStatus,
                                      Status = "A",
                                      CreateDate,
                                      LastModifiedDate,
                                      CreateBy,
                                      LastModifiedBy
                                  });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected = insertResult.Count();

                                foreach (var itemMtlItemId in insertResult)
                                {
                                    newMtlItemId = Convert.ToInt32(itemMtlItemId.MtlItemId);
                                }
                                #endregion
                            }
                        }
                        else
                        {
                            throw new SystemException("【品號】查無此品號");
                        }
                        #endregion

                        #region //判斷Bom是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomDetail a
                                INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                                WHERE b.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0)
                        {
                            #region //Bom主件新增
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO PDM.BillOfMaterials OUTPUT INSERTED.BomId
                                    SELECT @newMtlItemId, UomId, StandardLot,WipPrefix,'' ModiPrefix,'' ModiNo,'' ModiSequence, @Version
                                    , Remark, @ConfirmStatus, @ConfirmUserId, @ConfirmDate, @TransferStatus, @TransferDate, @Status
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy
                                    FROM PDM.BillOfMaterials
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    newMtlItemId,
                                    Version = "0000",
                                    ConfirmStatus = 'N',
                                    ConfirmUserId = (int?)null,
                                    ConfirmDate = (int?)null,
                                    TransferStatus = 'N',
                                    TransferDate = (int?)null,
                                    Status = 'Y',
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy,
                                    MtlItemId
                                });

                            var result3 = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected += result3.Count();

                            foreach (var item in result3)
                            {
                                BomId = Convert.ToInt32(item.BomId);
                            }
                            #endregion

                            #region //確認BOM元件資料是正確
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BomId, a.BomSequence, a.MtlItemId, a.UomId, a.CompositionQuantity, a.Base
                                    , ISNULL(a.StandardCostingType,'Y') StandardCostingType, ISNULL(a.MaterialProperties,'1')  MaterialProperties
                                    , a.LossRate, a.StandardCostingType, a.MaterialProperties, a.ReleaseItem, a.EffectiveDate, a.ExpirationDate, a.Remark, a.SubstitutionRemark
                                    , a.ConfirmStatus
                                    FROM PDM.BomDetail a
                                    INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                                    WHERE b.MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            var BomResult = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            foreach (var item in BomResult)
                            {
                                #region //Bom元件新增
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.BomDetail (BomId, BomSequence, MtlItemId, UomId, CompositionQuantity, Base, LossRate, StandardCostingType, MaterialProperties
                                        , ReleaseItem,  Remark, SubstitutionRemark, ConfirmStatus
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BomDetailId
                                        VALUES (@BomId, @BomSequence, @MtlItemId, @UomId, @CompositionQuantity, @Base, @LossRate, @StandardCostingType, @MaterialProperties
                                        , @ReleaseItem,  @Remark, @SubstitutionRemark, @ConfirmStatus
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";

                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      BomId,
                                      item.BomSequence,
                                      item.MtlItemId,
                                      item.UomId,
                                      item.CompositionQuantity,
                                      item.Base,
                                      item.LossRate,
                                      item.StandardCostingType,
                                      item.MaterialProperties,
                                      item.ReleaseItem,
                                      item.Remark,
                                      item.SubstitutionRemark,
                                      item.ConfirmStatus,
                                      CreateDate,
                                      LastModifiedDate,
                                      CreateBy,
                                      LastModifiedBy
                                  });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected = insertResult.Count();

                                foreach (var item2 in insertResult)
                                {
                                    BomDetailId = Convert.ToInt32(item2.BomDetailId);
                                }
                                #endregion

                                #region //判斷取替代料是否存在
                                //dynamicParameters = new DynamicParameters();
                                //sql = @"SELECT TOP 1 1
                                //        FROM PDM.BomSubstitution a
                                //        INNER JOIN PDM.BomDetail b ON b.BomDetailId = a.BomDetailId
                                //        INNER JOIN PDM.BillOfMaterials c ON c.BomId = b.BomId
                                //        WHERE c.MtlItemId = @MtlItemId";
                                //dynamicParameters.Add("MtlItemId", MtlItemId);

                                //var result5 = sqlConnection.Query(sql, dynamicParameters);
                                //if (result5.Count() > 0)
                                //{
                                //    dynamicParameters = new DynamicParameters();
                                //    sql = @"INSERT INTO PDM.BomSubstitution OUTPUT INSERTED.SubstitutionId
                                //            SELECT @BomDetailId, a.SubstituteStatus, @newMtlItemId, a.Quantity, a.SortNumber, a.Precedence
                                //            , a.EffectiveDate, a.ExpirationDate, a.Remark, @TransferStatus, @TransferDate, @Status
                                //            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy
                                //            FROM PDM.BomSubstitution a
                                //            INNER JOIN PDM.BomDetail b ON b.BomDetailId = a.BomDetailId
                                //            INNER JOIN PDM.BillOfMaterials c ON c.BomId = b.BomId
                                //            WHERE c.MtlItemId = @MtlItemId";
                                //    dynamicParameters.AddDynamicParams(
                                //        new
                                //        {
                                //            BomDetailId,
                                //            newMtlItemId,
                                //            TransferStatus = "N",
                                //            TransferDate = (DateTime?)null,
                                //            Status = "A",
                                //            CreateDate,
                                //            LastModifiedDate,
                                //            CreateBy,
                                //            LastModifiedBy,
                                //            MtlItemId
                                //        });
                                //    var result6 = sqlConnection.Query(sql, dynamicParameters);

                                //    rowsAffected += result6.Count();
                                //}
                                #endregion
                            }
                        }
                        #endregion

                        #region //判斷部番是否存在
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT *
                        //        FROM PDM.CustomerMtlItem 
                        //        WHERE MtlItemId = @MtlItemId";
                        //dynamicParameters.Add("MtlItemId", MtlItemId);
                        //var result7 = sqlConnection.Query(sql, dynamicParameters);
                        //if (result7.Count() > 0)
                        //{
                        //    foreach (var item in result7) {
                        //        #region //部番新增
                        //        dynamicParameters = new DynamicParameters();
                        //        sql = @"INSERT INTO PDM.CustomerMtlItem (MtlItemId,CustomerId,CustomerMtlItemNo,CustomerMtlItemName,CustomerMtlItemSpec,TransferStatus,TransferDate
                        //            ,Status,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                        //            OUTPUT INSERTED.CustomerMtlItemId
                        //            VALUES(@newMtlItemId,@CustomerId,@CustomerMtlItemNo,@CustomerMtlItemName,@CustomerMtlItemSpec,@TransferStatus,@TransferDate
                        //            ,@Status,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy                                    
                        //            )";
                        //        dynamicParameters.AddDynamicParams(
                        //            new
                        //            {
                        //                newMtlItemId,
                        //                item.CustomerId,
                        //                item.CustomerMtlItemNo,
                        //                item.CustomerMtlItemName,
                        //                item.CustomerMtlItemSpec,
                        //                item.TransferStatus,
                        //                item.TransferDate,
                        //                item.Status,
                        //                CreateDate,
                        //                LastModifiedDate,
                        //                CreateBy,
                        //                LastModifiedBy
                        //            });

                        //        var result8 = sqlConnection.Query(sql, dynamicParameters);

                        //        rowsAffected += result8.Count();
                        //        #endregion
                        //    }
                        //}
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMtlItemChange -- 品號變更資料新增 -- Ding 2023.05.18
        public string AddMtlItemChange(int MtlItemId, string ChangeEdition, string OriginalMtlItemName, string OriginalMtlItemSpec, string ChangeDate, string DelMtlItemStatus, string NewMtlItemName, string NewMtlItemSpec
            , int UpdateBy, string Remark, string FieldType, int ConfirmBy, string ConfirmDate, string ConfirmStatus, string SignOffStatus, string PrintCount
            , string SendCount, string OriginalEdition, string TransferStatus, string TransferDate)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【品號】資料錯誤!");
                //if (ChangeEdition.Equals("")) throw new SystemException("【變更版次】資料錯誤!");
                string MtlItemNo = "";
                string changeEdition = ChangeEdition;


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                        if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in Companyresult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion



                        #region //取得 MtlItemNo
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemNo, CompanyId
                                    FROM PDM.MtlItem
                                    WHERE TransferStatus='Y'                                    
                                    AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var Result = sqlConnection.Query(sql, dynamicParameters);


                        if (Result.Count() < 0) throw new SystemException("【品號變更管理】－此品號為新品號(未拋轉)，不可開立變更單");
                        if (Result.Count() != 1) throw new SystemException("【品號變更管理】－此品號資料錯誤，不可開立變更單");
                        if (Result.FirstOrDefault().CompanyId != Companyresult.FirstOrDefault().CompanyId) throw new SystemException("【品號變更管理】－此品號不屬於目前公司別!");

                        foreach (var item in Result)
                        {
                            MtlItemNo = item.MtlItemNo;
                        }
                        #endregion



                        #region //檢查該品號是否有未拋轉變更單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.MtlItemChange 
                                WHERE MtlItemId = @MtlItemId 
                                AND TransferStatus = 'N'";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var mtlItemChange = sqlConnection.Query(sql, dynamicParameters);

                        if (mtlItemChange.Count() > 0) throw new SystemException("【品號變更管理】－此品號有未拋轉確認的變更單!");
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {

                        #region //MtlItemId 是否存在ERP
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                    FROM INVMB
                                    WHERE RTRIM(LTRIM(MB001)) = @MB001";
                        dynamicParameters.Add("MB001", MtlItemNo);
                        var MtlItemNoErpResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoErpResult.Count() != 1) throw new SystemException("【品號變更管理】－此品號為未建於ERP，不可開立變更單");
                        #endregion

                        #region //MtlItemId 是否有未確認變更單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM INVTL
                                    WHERE RTRIM(LTRIM(TL001)) = @TL001 AND TL014 = 'N'";
                        dynamicParameters.Add("TL001", MtlItemNo);
                        var MtlItemChangeErpResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemChangeErpResult.Count() > 0) throw new SystemException("【品號變更管理】－此品號在ERP有未確認變更單，請至ERP確認！");
                        #endregion


                    }


                    #region //新增
                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.MtlItemChange (CompanyId,MtlItemId,OriginalMtlItemName,OriginalMtlItemSpec,ChangeEdition,ChangeDate,NewMtlItemName,NewMtlItemSpec
                                ,UpdateBy,Remark,ConfirmBy,PrintCount,SendCount,OriginalEdition
                                ,TransferStatus
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@CompanyId,@MtlItemId,@OriginalMtlItemName,@OriginalMtlItemSpec,@ChangeEdition,@ChangeDate,@NewMtlItemName,@NewMtlItemSpec
                                ,@UpdateBy,@Remark,@ConfirmBy,@PrintCount,@SendCount,@OriginalEdition
                                ,@TransferStatus
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                MtlItemId,
                                OriginalMtlItemName,
                                OriginalMtlItemSpec,
                                ChangeEdition = changeEdition,
                                ChangeDate = LastModifiedDate,
                                DelMtlItemStatus,
                                NewMtlItemName,
                                NewMtlItemSpec,
                                UpdateBy = CreateBy,
                                Remark,
                                FieldType,
                                ConfirmBy,
                                ConfirmStatus,
                                SignOffStatus,
                                PrintCount,
                                SendCount,
                                OriginalEdition,
                                TransferStatus,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = insertResult.First().MtlItemChangeId
                        });
                        #endregion
                    }
                    #endregion
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMtlItemChangeDetail -- 品號變更欄位資料新增 -- GPai 2023.06.16
        public string AddMtlItemChangeDetail(int MtlItemChangeId, int MtlItemId, string ChangeEdition, string FieldNum, string FieldName, string NewTextField, string NewNumericField, string OriginalNumericField, string NewFieldName, string OriginalFieldName, string Remark
            , string FieldType, string RetentionField, string Status, string SortNum, string OriginalTextField)
        {
            try
            {
                if (MtlItemChangeId <= 0) throw new SystemException("【品號變更單】資料錯誤!");
                if (MtlItemId <= 0) throw new SystemException("【品號】資料錯誤!");
                if (ChangeEdition.Equals("")) throw new SystemException("【變更版次】資料錯誤!");
                string MtlItemNo = "";
                string mtlItemEffectiveDate = "";
                string mtlItemExpirationDate = "";

                int ordercount = 0;
                int orcount = 0;

                if (NewTextField == OriginalTextField) throw new SystemException("【品號變更管理】－與原資料相同!");

                if (FieldNum == "MB030" && (NewTextField.Length > 0))
                {

                    if (DateTime.Parse(Convert.ToDateTime(NewTextField).ToString("yyyy-MM-dd 00:00:00")) < DateTime.Parse(DateTime.Now.ToString("yyyy-MM-dd 00:00:00"))) throw new SystemException("【品號變更管理】－此日期不得早於今日");
                }

                if (FieldNum == "MB031" && (NewTextField.Length > 0))
                {

                    if (DateTime.Parse(Convert.ToDateTime(NewTextField).ToString("yyyy-MM-dd 00:00:00")) < DateTime.Parse(DateTime.Now.ToString("yyyy-MM-dd 00:00:00"))) throw new SystemException("【品號變更管理】－此日期不得早於今日");
                }

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                        if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in Companyresult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //MtlItemId 是否存在MES
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM PDM.MtlItem
                                    WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var MtlItemNoResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoResult.Count() <= 0) throw new SystemException("【品號變更管理】－查無此品號，不可開立變更單");
                        foreach (var item in MtlItemNoResult)
                        {
                            if (item.TransferStatus != "Y") throw new SystemException("【品號變更管理】－此品號為新品號(未拋轉)，不可開立變更單");
                            if (FieldNum == "MB030" && (NewTextField.Length > 0))
                            {
                                OriginalTextField = item.EffectiveDate != null ? Convert.ToDateTime(item.EffectiveDate).ToString("yyyy-MM-dd") : null;
                                OriginalFieldName = item.EffectiveDate != null ? Convert.ToDateTime(item.EffectiveDate).ToString("yyyy-MM-dd") : null;
                            }

                            if (FieldNum == "MB031" && (NewTextField.Length > 0))
                            {
                                OriginalTextField = item.ExpirationDate != null ? Convert.ToDateTime(item.ExpirationDate).ToString("yyyy-MM-dd") : null;
                                OriginalFieldName = item.ExpirationDate != null ? Convert.ToDateTime(item.ExpirationDate).ToString("yyyy-MM-dd") : null;
                            }
                        }

                        #endregion

                        #region //品號設定資料
                        if (FieldType == "N") { }
                        #endregion

                        #region //MtlItemId MES元件資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM PDM.BomDetail
                                    WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var MtlItemBomResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemBomResult.Count() > 0)
                        {
                            foreach (var item in MtlItemBomResult)
                            {
                                if (FieldNum == "MB030")
                                {
                                    if (item.EffectiveDate != null)
                                    {
                                        if (DateTime.Parse(Convert.ToDateTime(item.EffectiveDate).ToString("yyyy-MM-dd")) < DateTime.Parse(Convert.ToDateTime(NewTextField).ToString("yyyy-MM-dd 00:00:00"))) throw new SystemException("【品號變更管理】－此日期大於BOM元件品號生效日，請先確認BOM元件生效日: " + DateTime.Parse(Convert.ToDateTime(item.EffectiveDate).ToString("yyyy-MM-dd")));

                                    }
                                }

                                if (FieldNum == "MB031")
                                {
                                    if (item.ExpirationDate != null)
                                    {
                                        if (DateTime.Parse(Convert.ToDateTime(item.ExpirationDate).ToString("yyyy-MM-dd")) > DateTime.Parse(Convert.ToDateTime(NewTextField).ToString("yyyy-MM-dd 00:00:00"))) throw new SystemException("【品號變更管理】－此日期小於BOM元件品號失效日，請先確認BOM元件失效日 : " + DateTime.Parse(Convert.ToDateTime(item.ExpirationDate).ToString("yyyy-MM-dd")));
                                        //
                                    }
                                }

                            }

                        }

                        #endregion

                        #region //取得 MtlItemNo
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemNo, CompanyId
                                    FROM PDM.MtlItem
                                    WHERE TransferStatus='Y'                                    
                                    AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var Result = sqlConnection.Query(sql, dynamicParameters);

                        if (Result.Count() < 0) throw new SystemException("【品號變更管理】－此品號為新品號(未拋轉)，不可開立變更單");
                        if (Result.Count() != 1) throw new SystemException("【品號變更管理】－此品號資料錯誤，不可開立變更單");
                        if (Result.FirstOrDefault().CompanyId != Companyresult.FirstOrDefault().CompanyId) throw new SystemException("【品號變更管理】－此品號不屬於目前公司別!");
                        foreach (var item in Result)
                        {
                            MtlItemNo = item.MtlItemNo;
                        }
                        #endregion

                        #region //取得變更單資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM PDM.MtlItemChangeDetail
                                    WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        var MtlItemChangeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (MtlItemChangeResult.Count() > 0)
                        {
                            foreach (var item in MtlItemChangeResult)
                            {

                                if ((item.FieldNum == "MB030") && (FieldNum == "MB031") && (NewTextField.Length > 0))
                                {
                                    if (DateTime.Parse(Convert.ToDateTime(item.NewTextField).ToString("yyyy-MM-dd")) >= DateTime.Parse(Convert.ToDateTime(NewTextField).ToString("yyyy-MM-dd"))) throw new SystemException("【品號變更管理】－此日期與變更單生效日欄位資料相同或小於該資料");
                                }

                                if ((item.FieldNum == "MB031") && (FieldNum == "MB030") && (NewTextField.Length > 0))
                                {
                                    if (DateTime.Parse(Convert.ToDateTime(item.NewTextField).ToString("yyyy-MM-dd")) <= DateTime.Parse(Convert.ToDateTime(NewTextField).ToString("yyyy-MM-dd"))) throw new SystemException("【品號變更管理】－此日期與變更單失效日欄位資料相同或大於該資料");
                                }
                            }

                        }

                        #endregion

                        #region //該欄位是否在該版本已新增
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM PDM.MtlItemChangeDetail
                                WHERE ChangeEdition = @ChangeEdition AND FieldNum = @FieldNum AND MtlItemChangeId = @MtlItemChangeId
                                ORDER BY MtlChangeDetailId DESC";
                        dynamicParameters.Add("ChangeEdition", ChangeEdition);
                        dynamicParameters.Add("FieldNum", FieldNum);
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        var MtlItemChangeDetailResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemChangeDetailResult.Count() > 0) throw new SystemException("【品號變更管理】此欄位已新增過!");

                        foreach (var item in MtlItemChangeDetailResult)
                        {
                            if (item.OriginalTextField == NewTextField) throw new SystemException("【品號變更管理】此欄位資料與原資料相同!");
                        }
                        #endregion

                        #region //有沒有綁定訂單 - MB156	銷售單位
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 
                                                    FROM SCM.PrDetail a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var resulCheck = sqlConnection.Query(sql, dynamicParameters);
                        ordercount = resulCheck.Count();

                        #endregion

                        #region //檢核單據有沒有拋轉ERP MB155	採購單位
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1 
                                                    FROM SCM.PrDetail a 
                                                    INNER JOIN SCM.PurchaseRequisition b on a.PrId = b.PrId
                                                    WHERE a.MtlItemId = @MtlItemId
                                                    AND b.TransferStatus = 'Y'";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        resulCheck = sqlConnection.Query(sql, dynamicParameters);
                        orcount = resulCheck.Count();

                        #endregion


                    }

                    decimal inventoryQty = 0;//MB004	庫存單位
                    #region //MtlItemId 是否存在ERP
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                    FROM INVMB
                                    WHERE RTRIM(LTRIM(MB001)) = @MB001";
                        dynamicParameters.Add("MB001", MtlItemNo);
                        var MtlItemNoErpResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoErpResult.Count() != 1) throw new SystemException("【品號變更管理】－此品號為未建於ERP，不可開立變更單");

                    }
                    #endregion

                    #region //MtlItemId 是否存在庫存
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MC001, a.MC002, a.MC002 InventoryNo ,a.MC007 ,b.MC002 InventoryName
                                    FROM INVMC a
                                    INNER JOIN CMSMC b on a.MC002 = b.MC001
                                    WHERE RTRIM(LTRIM(a.MC001)) = @MC001";
                        dynamicParameters.Add("MC001", MtlItemNo);
                        var MtlItemNoErpResult = sqlConnection.Query(sql, dynamicParameters);
                        //if (MtlItemNoErpResult.Count() != 1) throw new SystemException("【品號變更管理】－此品號為未建於ERP，不可開立變更單");
                        foreach (var item in MtlItemNoErpResult)
                        {
                            inventoryQty = item.MC007;
                        }

                        #region //INVTB資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TB003 Seq, a.TB004 MtlItemNo, a.TB005 MtlItemName, a.TB006 MtlItemSpec
                                    , a.TB008 Uom, a.TB012 InvNo, b.MC002 InvName, a.TB007 Qty, a.TB017 Remark
                                    FROM INVTB a
                                    INNER JOIN CMSMC b ON a.TB012 = b.MC001
                                    WHERE a.TB004 = @TB004
                                    ORDER BY a.TB003";
                        dynamicParameters.Add("TB004", MtlItemNo);

                        var resultInvtb = sqlConnection.Query(sql, dynamicParameters);
                        //if (resultInvtb.Count() > 0 && (FieldNum == "MB004" )) throw new SystemException("該品號在ERP有庫存異動單，因此無法開立該欄位變更資料");
                        //if (resultInvtb.Count() > 0 && (FieldNum == "MB022")) throw new SystemException("該品號在ERP有庫存異動單，因此無法開立該欄位變更資料");
                        #endregion

                        if (FieldNum == "MB022")
                        {
                            //if (inventoryQty > 0) throw new SystemException("【品號變更管理】－此品號庫存數>0，該欄位【" + FieldNum + "】不可開立變更單");
                            //if (ordercount > 0) throw new SystemException("【品號變更管理】－此品號已開立訂單，該欄位【" + FieldNum + "】不可開立變更單");
                            //if (orcount > 0) throw new SystemException("【品號變更管理】－此品號已開立採購單且已拋轉ERP，該欄位【" + FieldNum + "】不可開立變更單");
                            #region //比對ERP關帳日期
                            if (inventoryQty > 0)
                            {
                                string DocDate = CreateDate.ToString("yyyy-MM-dd");

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MA013)) MA013
                            FROM CMSMA";
                                var cmsmaResult = sqlConnection.Query(sql, dynamicParameters);
                                if (cmsmaResult.Count() < 0) throw new SystemException("EPR關帳日期資料錯誤!!");

                                foreach (var item in cmsmaResult)
                                {
                                    string eprDate = item.MA013;
                                    string erpYear = eprDate.Substring(0, 4);
                                    string erpMonth = eprDate.Substring(4, 2);
                                    string erpDay = eprDate.Substring(6, 2);
                                    string erpFullDate = erpYear + "-" + erpMonth + "-" + erpDay;
                                    DateTime erpDateTime = Convert.ToDateTime(erpFullDate);
                                    DateTime DocDateDateTime = Convert.ToDateTime(DocDate);
                                    int compare = DocDateDateTime.CompareTo(erpDateTime);
                                    if (compare <= 0) throw new SystemException("ERP已關帳(" + erpFullDate + ")，無法開立此日期(" + DocDate + ")之單據!!");
                                }

                            }


                            #endregion


                        }

                    }
                    #endregion

                    #region //新增
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;

                        if (FieldNum == "MB004" || FieldNum == "MB155" || FieldNum == "MB156")
                        {
                            if (inventoryQty > 0) throw new SystemException("【品號變更管理】－此品號庫存數>0，該欄位【" + FieldNum + "】不可開立變更單");
                            if (ordercount > 0) throw new SystemException("【品號變更管理】－此品號已開立訂單，該欄位【" + FieldNum + "】不可開立變更單");
                            if (orcount > 0) throw new SystemException("【品號變更管理】－此品號已開立採購單且已拋轉ERP，該欄位【" + FieldNum + "】不可開立變更單");
                        }


                        if (FieldType == "N" && (FieldNum == "MB036" || FieldNum == "MB037" || FieldNum == "MB039" || FieldNum == "MB040" || FieldNum == "MB041" || FieldNum == "MB070"))
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MtlItemChangeId,
                                    MtlItemId,
                                    ChangeEdition,
                                    FieldNum,
                                    FieldName,
                                    NewTextField = "",
                                    NewNumericField,
                                    OriginalNumericField,
                                    OriginalTextField = "",
                                    NewFieldName = "",
                                    OriginalFieldName = "",
                                    FieldType,
                                    RetentionField,
                                    ConfirmStatus = "N",
                                    Status,
                                    Remark,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy,
                                    SortNum
                                });
                            rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                        }
                        else
                        {
                            string nextSortNum = (int.Parse(SortNum) + 1).ToString();
                            switch (FieldNum)
                            {
                                case "MB017":

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum,
                                            FieldName,
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName,
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();


                                    nextSortNum = ("0000" + (int.Parse(SortNum) + 1).ToString()).Substring(("0000" + (int.Parse(SortNum) + 1).ToString()).Length - 4);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB157",
                                            FieldName = "主要領料庫別",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName,
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum = nextSortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    break;

                                case "MB157":

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum,
                                            FieldName,
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName,
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    nextSortNum = ("0000" + (int.Parse(SortNum) + 1).ToString()).Substring(("0000" + (int.Parse(SortNum) + 1).ToString()).Length - 4);

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB017",
                                            FieldName = "主要庫別",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName,
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum = nextSortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    break;

                                case "MB004":

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum,
                                            FieldName,
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    nextSortNum = ("0000" + (int.Parse(SortNum) + 1).ToString()).Substring(("0000" + (int.Parse(SortNum) + 1).ToString()).Length - 4);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB155",
                                            FieldName = "採購單位",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum = nextSortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    nextSortNum = ("0000" + (int.Parse(SortNum) + 2).ToString()).Substring(("0000" + (int.Parse(SortNum) + 2).ToString()).Length - 4);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB156",
                                            FieldName = "銷售單位",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum = nextSortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    break;

                                case "MB155":

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum,
                                            FieldName,
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    nextSortNum = ("0000" + (int.Parse(SortNum) + 1).ToString()).Substring(("0000" + (int.Parse(SortNum) + 1).ToString()).Length - 4);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB156",
                                            FieldName = "銷售單位",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum = nextSortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    nextSortNum = ("0000" + (int.Parse(SortNum) + 2).ToString()).Substring(("0000" + (int.Parse(SortNum) + 2).ToString()).Length - 4);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB004",
                                            FieldName = "庫存單位",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum = nextSortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    break;

                                case "MB156":

                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum,
                                            FieldName,
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    nextSortNum = ("0000" + (int.Parse(SortNum) + 1).ToString()).Substring(("0000" + (int.Parse(SortNum) + 1).ToString()).Length - 4);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB155",
                                            FieldName = "採購單位",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum = nextSortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    nextSortNum = ("0000" + (int.Parse(SortNum) + 2).ToString()).Substring(("0000" + (int.Parse(SortNum) + 2).ToString()).Length - 4);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB004",
                                            FieldName = "庫存單位",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName = "",
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum = nextSortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    break;

                                case "MB022":
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum = "MB022",
                                            FieldName = "批號管理",
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName,
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                        nextSortNum = ("0000" + (int.Parse(SortNum) + 1).ToString()).Substring(("0000" + (int.Parse(SortNum) + 1).ToString()).Length - 4);

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MtlItemChangeId,
                                                MtlItemId,
                                                ChangeEdition,
                                                FieldNum = "MB023",
                                                FieldName = "有效天數",
                                                NewTextField = "",
                                                NewNumericField = NewTextField != "N" ? 9999 : 0,
                                                OriginalNumericField = NewTextField != "N" ? 0 : 9999,
                                                OriginalTextField = "",
                                                NewFieldName = "",
                                                OriginalFieldName = "",
                                                FieldType = "N",
                                                RetentionField,
                                                ConfirmStatus = "N",
                                                Status,
                                                Remark,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy,
                                                SortNum  = nextSortNum
                                            });
                                        rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                        var nextSortNum2 = ("0000" + (int.Parse(nextSortNum) + 1).ToString()).Substring(("0000" + (int.Parse(SortNum) + 1).ToString()).Length - 4);

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MtlItemChangeId,
                                                MtlItemId,
                                                ChangeEdition,
                                                FieldNum = "MB024",
                                                FieldName = "複檢天數",
                                                NewTextField = "",
                                                NewNumericField = NewTextField != "N" ? 9999 : 0,
                                                OriginalNumericField = NewTextField != "N" ? 0 : 9999,
                                                OriginalTextField = "",
                                                NewFieldName = "",
                                                OriginalFieldName = "",
                                                FieldType = "N",
                                                RetentionField,
                                                ConfirmStatus = "N",
                                                Status,
                                                Remark,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy,
                                                SortNum = nextSortNum2
                                            });
                                        rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();

                                    
                                    break;

                                default:
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"INSERT INTO PDM.MtlItemChangeDetail (MtlItemChangeId,MtlItemId, ChangeEdition,FieldNum,FieldName,NewTextField,NewNumericField,OriginalNumericField
                                ,NewFieldName,OriginalFieldName,FieldType,RetentionField,ConfirmStatus,Status,Remark
                                ,CreateDate,LastModifiedDate,CreateBy,LastModifiedBy,SortNum,OriginalTextField)
                                OUTPUT INSERTED.MtlItemChangeId
                                VALUES (@MtlItemChangeId,@MtlItemId, @ChangeEdition,@FieldNum,@FieldName,@NewTextField,@NewNumericField,@OriginalNumericField
                                ,@NewFieldName,@OriginalFieldName,@FieldType,@RetentionField,@ConfirmStatus,@Status,@Remark
                                ,@CreateDate,@LastModifiedDate,@CreateBy,@LastModifiedBy,@SortNum,@OriginalTextField)";

                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MtlItemChangeId,
                                            MtlItemId,
                                            ChangeEdition,
                                            FieldNum,
                                            FieldName,
                                            NewTextField,
                                            NewNumericField = 0,
                                            OriginalNumericField = 0,
                                            OriginalTextField,
                                            NewFieldName,
                                            OriginalFieldName,
                                            FieldType,
                                            RetentionField,
                                            ConfirmStatus = "N",
                                            Status,
                                            Remark,
                                            CreateDate,
                                            LastModifiedDate,
                                            CreateBy,
                                            LastModifiedBy,
                                            SortNum
                                        });
                                    rowsAffected += sqlConnection.Query(sql, dynamicParameters).Count();
                                    break;
                            }

                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = rowsAffected
                        });
                        #endregion
                    }
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //新增複製的BOM --GPai 20230601
        public string AddCopyBomDetail(int CurrentBomId, int MtlItemId, int BomId, int bomSequenceVal)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【元件品號】不能為空!");


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string TransferStatus = "";
                        int rowsAffected = 0;

                        #region //取得目前元件列表
                        sql = @"SELECT a.BomDetailId, a.BomId, a.BomSequence, a.MtlItemId, a.UomId, a.CompositionQuantity, a.Base, a.LossRate
                            , ISNULL(FORMAT(a.EffectiveDate, 'yyyy-MM-dd'), '') EffectiveDate, FORMAT(a.ExpirationDate, 'yyyy-MM-dd') ExpirationDate
                            , a.ReleaseItem, a.Remark, a.SubstitutionRemark, a.ConfirmStatus, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm') CreateDate
                            , b.TransferStatus
                            , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                            , d.UomNo
                            FROM PDM.BomDetail a
                            INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                            INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                            WHERE 1=1  AND a.BomId = @CurrentBomId";
                        dynamicParameters.Add("CurrentBomId", CurrentBomId);

                        var currentResult = sqlConnection.Query(sql, dynamicParameters);


                        #endregion

                        #region //判斷元件品號是否重複
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomDetail
                                WHERE MtlItemId = @MtlItemId
                                AND BomId = @BomId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("BomId", BomId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【元件品號】重複，請重新選擇!");
                        #endregion

                        #region //取得BOM資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * FROM PDM.BomDetail
                                WHERE BomId = @BomId";
                        dynamicParameters.Add("BomId", BomId);
                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        if (result2.Count() <= 0) throw new SystemException("查無BOM元件可複製!");

                        foreach (var item1 in currentResult)
                        {
                            foreach (var item2 in result2)
                            {
                                if (item2.MtlItemId == item1.MtlItemId) throw new SystemException("該品號已新增!");
                            }
                        }
                        #endregion 

                        #region //撈取拋轉狀態
                        sql = @"SELECT TransferStatus
                                FROM PDM.BillOfMaterials
                                WHERE BomId = @BomId";
                        dynamicParameters.Add("BomId", BomId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result3)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        #endregion

                        //ADD
                        //if (TransferStatus != "Y")
                        //{
                        var i = 0;
                        foreach (var item in result2)
                        {
                            i++;
                            int seq = bomSequenceVal + (i * 10);
                            string serial = "0000" + seq;

                            var bomSequence = serial.Substring(serial.Length - 4);
                            var mtlItemId = item.MtlItemId;
                            var compositionQuantity = item.CompositionQuantity;
                            var baseVal = item.Base;
                            var lossRate = item.LossRate;
                            var releaseItem = item.ReleaseItem;
                            var effectiveDate = item.EffectiveDate;
                            var expirationDate = item.ExpirationDate;
                            var remark = item.Remark;
                            var substitutionRemark = item.SubstitutionRemark;
                            var confirmStatus = item.ConfirmStatus;
                            var uomId = item.UomId;

                            dynamicParameters = new DynamicParameters();
                            sql = @"INSERT INTO PDM.BomDetail (BomId, BomSequence, MtlItemId, UomId, CompositionQuantity, Base, LossRate
                                    , ReleaseItem, EffectiveDate, ExpirationDate, Remark, SubstitutionRemark, ConfirmStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BomDetailId
                                    VALUES (@BomId, @BomSequence, @MtlItemId, @UomId, @CompositionQuantity, @Base, @LossRate
                                    , @ReleaseItem, @EffectiveDate, @ExpirationDate, @Remark, @SubstitutionRemark, @ConfirmStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BomId = CurrentBomId,
                                    BomSequence = bomSequence,
                                    MtlItemId = mtlItemId,
                                    UomId = uomId,
                                    CompositionQuantity = compositionQuantity,
                                    Base = baseVal,
                                    LossRate = lossRate,
                                    ReleaseItem = releaseItem,
                                    EffectiveDate = effectiveDate,
                                    ExpirationDate = expirationDate,
                                    Remark = remark,
                                    SubstitutionRemark = substitutionRemark,
                                    ConfirmStatus = confirmStatus,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });
                            var insertResult = sqlConnection.Query(sql, dynamicParameters);

                            rowsAffected = insertResult.Count();
                        }


                        //}

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMtlItemUomCalculate -- 品號單位換算新增 -- Shintokuro 2023.06.14
        public string AddMtlItemUomCalculate(int MtlItemId, int UomId, int ConvertUomId, double SwapNumerator, double SwapDenominator)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【品號單位換算】－品號不能空，請重新確認");
                if (UomId <= 0) throw new SystemException("【品號單位換算】－庫存單位不能空，請重新確認");
                if (ConvertUomId <= 0) throw new SystemException("【品號單位換算】－換算單位不能空，請重新確認");
                if (SwapNumerator <= 0) throw new SystemException("【品號單位換算】－換算率分子不能小於等於0，請重新確認");
                if (SwapDenominator <= 0) throw new SystemException("【品號單位換算】－換算率分母不能小於等於0，請重新確認");
                double? nulldate = null;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 InventoryUomId,TransferStatus
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算】－品號不存在，請重新輸入!");
                        foreach (var item in result)
                        {
                            if (item.InventoryUomId != UomId) throw new SystemException("【品號單位換算】－庫存單位與該品號的庫存單位必須相同，請重新確認!");
                            if (item.TransferStatus == "Y") throw new SystemException("【品號單位換算】－品號已經拋轉不可以新增!!");
                            if (item.InventoryUomId == ConvertUomId) throw new SystemException("【品號單位換算】－庫存單位與換算單位不可以相同，請重新確認!");
                        }
                        #endregion

                        #region //判斷庫存單位是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @UomId";
                        dynamicParameters.Add("UomId", UomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算】－庫存單位不存在，請重新輸入!");
                        #endregion

                        #region //判斷品號單位換算資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConvertUomId
                                FROM PDM.MtlItemUomCalculate
                                WHERE ConvertUomId = @ConvertUomId
                                AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("ConvertUomId", ConvertUomId);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【品號單位換算】－換算單位已存在,不可以新增!");
                        #endregion


                        #region //判斷換算單位是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @ConvertUomId";
                        dynamicParameters.Add("ConvertUomId", ConvertUomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算】－換算單位不存在，請重新輸入!");
                        #endregion

                        #region //資料新增
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.MtlItemUomCalculate (MtlItemId, UomId, ConvertUomId, SwapNumerator, SwapDenominator, TransferStatus
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.MtlItemUomCalculateId
                                VALUES (@MtlItemId, @UomId, @ConvertUomId, @SwapNumerator, @SwapDenominator, @TransferStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MtlItemId,
                                UomId,
                                ConvertUomId,
                                SwapNumerator,
                                SwapDenominator,
                                TransferStatus = 'N',
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        int rowsAffected = insertResult.Count();

                        int MtlItemUomCalculateId = -1;
                        foreach (var item in insertResult)
                        {
                            MtlItemUomCalculateId = item.MtlItemUomCalculateId;
                        }
                        #endregion

                        #region //資料新增(log)
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.MtlItemUomCalculateLog (TransactionType, MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomIdBefore, 
                                SwapNumeratorBefore, SwapDenominatorBefore, ConvertUomId, SwapNumerator, SwapDenominator, TransactionUserId, 
                                TransactionDate, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                VALUES ( @TransactionType, @MtlItemUomCalculateId, @MtlItemId, @UomId, @ConvertUomIdBefore,
                                @SwapNumeratorBefore, @SwapDenominatorBefore, @ConvertUomId, @SwapNumerator, @SwapDenominator, @TransactionUserId,
                                @TransactionDate, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransactionType = "A",
                                MtlItemUomCalculateId,
                                MtlItemId,
                                UomId,
                                ConvertUomIdBefore = nulldate,
                                SwapNumeratorBefore = nulldate,
                                SwapDenominatorBefore = nulldate,
                                ConvertUomId = ConvertUomId,
                                SwapNumerator = SwapNumerator,
                                SwapDenominator = SwapDenominator,
                                TransactionUserId = CreateBy,
                                TransactionDate = CreateDate,
                                TransferStatus = 'N',
                                TransferDate = nulldate,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResultLog = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected += insertResult.Count();
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBomChange -- Bom變更資料新增 -- GPai 20230627
        public string AddBomChange(string BomChangePrefix, string EmergencyCode, string ChangeReason, string Remark)
        {
            try
            {

                var bomChangeNo = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //取得單號
                        //隨機取號,拋轉後改為最新單號
                        bomChangeNo = BaseHelper.RandomCode(11);
                        #endregion

                    }

                    #region //新增
                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.BomChange (CompanyId, BomChangePrefix, BomChangeNo, EmergencyCode, ChangeReason, Remark, ConfirmStatus, PrintCount
                                , SignOffStatus, SendCount, TransferStatus
                                ,CreateDate, LastModifiedDate, CreateBy, LastModifiedBy, ChangeDate)
                                OUTPUT INSERTED.BomChangeId
                                VALUES (@CompanyId, @BomChangePrefix, @BomChangeNo, @EmergencyCode, @ChangeReason, @Remark, @ConfirmStatus, @PrintCount
                                , @SignOffStatus, @SendCount, @TransferStatus
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy, @ChangeDate)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                BomChangePrefix = "4101",
                                BomChangeNo = bomChangeNo,
                                EmergencyCode,
                                ChangeReason,
                                Remark,
                                ChangeDate = LastModifiedDate,
                                ConfirmStatus = "N",
                                PrintCount = 0,
                                SignOffStatus = "N",
                                SendCount = 0,
                                TransferStatus = "N",
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        rowsAffected = insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = insertResult.First().BomChangeId
                        });
                        #endregion
                    }
                    #endregion
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddBomChangeDetail -- Bom變更單身資料新增 -- GPai 20230628
        public string AddBomChangeDetail(int BomChangeId, int MtlItemId, string Unit, string SmallUnit, string StandardLot, string MoPrefix,
            string ChangeReason, string ConfirmStatus, string ConfirmCode, string NewRemark, string SortNum, int BomId)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【品號】資料錯誤!");
                if ((int.Parse(StandardLot)) < 0) throw new SystemException("【標準批量】資料錯誤!");
                string MtlItemNo = "";
                int originalMtlItemId = MtlItemId;
                string originalUnit = "";
                string originalSmallUnit = "";
                string originalChangeEdition = "";
                string originalStandardLot = "";
                string originalMoPrefix = "";
                string originalBomChangeNo = "";
                int originalBomChangeId = 0;
                string originalRemark = "";
                string originalSortNum = "";
                string changeEdition = "";
                string TB003 = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                        if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in Companyresult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //MtlItemId 是否存在MES
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM PDM.MtlItem
                                    WHERE TransferStatus='N'                                    
                                    AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var MtlItemNoResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoResult.Count() > 0) throw new SystemException("【BOM變更管理】－此品號為新品號(未拋轉)，不可開立變更單");
                        #endregion

                        #region //取得 MtlItemNo
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemNo, CompanyId
                                    FROM PDM.MtlItem
                                    WHERE TransferStatus='Y'                                    
                                    AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var Result = sqlConnection.Query(sql, dynamicParameters);

                        if (Result.Count() < 0) throw new SystemException("【BOM變更管理】－此品號為新品號(未拋轉)，不可開立變更單");
                        if (Result.Count() != 1) throw new SystemException("【BOM變更管理】－此品號資料錯誤，不可開立變更單");
                        if (Result.FirstOrDefault().CompanyId != Companyresult.FirstOrDefault().CompanyId) throw new SystemException("【BOM變更管理】－此品號不屬於目前公司別!");
                        foreach (var item in Result)
                        {
                            MtlItemNo = item.MtlItemNo;
                        }
                        #endregion

                        #region //MtlItemId 是否有未拋轉變更單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT  1
                                FROM PDM.BomChangeDetail a
                                INNER JOIN PDM.BomChange b ON b.BomChangeId = a.BomChangeId
                                WHERE b.TransferStatus = 'N' AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var MtlItemChangeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemChangeResult.Count() > 0) throw new SystemException("【BOM變更管理】－此品號有未處理MES變更單!");
                        #endregion

                        #region //取得該變更單單身數
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT  *
                                FROM PDM.BomChangeDetail a
                                WHERE a.BomChangeId = @BomChangeId";
                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        var BomChangeDetailCountResult = sqlConnection.Query(sql, dynamicParameters);
                        #endregion

                        #region //該欄位是否在該變更單已新增
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM PDM.BomChangeDetail
                                WHERE MtlItemId = @MtlItemId AND BomChangeId = @BomChangeId
                                ORDER BY BomChangeDetailId DESC";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        var BomChangeDetailResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BomChangeDetailResult.Count() > 0) throw new SystemException("【BOM變更管理】此BOM已新增過!");

                        int seq = BomChangeDetailCountResult.Count() + 1;
                        string serial = "0000" + seq;
                        TB003 = serial.Substring(serial.Length - 4);
                        #endregion

                        #region //取得主件上一版本BM變更單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 b.BomChangeNo , b.BomChangeId
                                FROM PDM.BomChangeDetail a
                                INNER JOIN PDM.BomChange b ON b.BomChangeId = a.BomChangeId
                                WHERE a.MtlItemId = @MtlItemId
                                AND b.ConfirmStatus = 'Y'
                                AND b.CompanyId = @CompanyId

                                ORDER BY a.BomChangeId DESC";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var lastBomChangeResult = sqlConnection.Query(sql, dynamicParameters);

                        if (lastBomChangeResult.Count() > 0)
                        {
                            originalBomChangeId = lastBomChangeResult.First().BomChangeId;
                        }
                        else
                        {
                            originalBomChangeId = BomChangeId;
                        }
                        #endregion

                    }
                    #region //MtlItemId 是否存在ERP

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                    FROM INVMB
                                    WHERE RTRIM(LTRIM(MB001))=@MB001";
                        dynamicParameters.Add("MB001", MtlItemNo);
                        var MtlItemNoErpResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoErpResult.Count() != 1) throw new SystemException("【BOM變更管理】－此品號為未建於ERP，不可開立變更單");

                        #region //檢查ERP是否有未確認單據
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB008, TB009, TB012, TB013
                                FROM BOMTB
                                WHERE TB012 = 'N' AND RTRIM(LTRIM(TB004)) = @MtlItemNo
                                ORDER BY TB002 DESC,TB007 DESC";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        var nocheckEditionErpResult = sqlConnection.Query(sql, dynamicParameters);

                        if (nocheckEditionErpResult.Count() > 0)
                        {
                            foreach (var item in nocheckEditionErpResult)
                            {
                                var tb012 = item.TB012;

                                if (tb012 == "N")
                                {

                                    using (SqlConnection sqlConnection2 = new SqlConnection(MainConnectionStrings))
                                    {
                                        #region //檢查未拋轉變更單是否存在MES
                                        dynamicParameters = new DynamicParameters();
                                        sql = @" SELECT * FROM PDM.BomChange
                                    WHERE BomChangePrefix = @TB001 AND BomChangeNo = @TB002";
                                        dynamicParameters.Add("TB001", item.TB001);
                                        dynamicParameters.Add("TB002", item.TB002);

                                        var MtlItemChangeResult2 = sqlConnection2.Query(sql, dynamicParameters);
                                        if (MtlItemChangeResult2.Count() > 0)
                                        {
                                            throw new SystemException("【BOM變更管理】－此品號有未處理 MES 變更單! : " + item.TB001 + "-" + item.TB002);

                                        }
                                        else
                                        {
                                            throw new SystemException("【BOM變更管理】－此品號有未處理 ERP 變更單! : " + item.TB001 + "-" + item.TB002);
                                        }
                                        #endregion

                                    }
                                }
                            }
                        }

                        #endregion

                        changeEdition = BaseHelper.RandomCode(4);

                        #region //取得前一版本該BOM變更資訊
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB008, TB009, TB012, TB013
                                FROM BOMTB
                                WHERE TB012 != 'V' AND TB012 != 'N' AND RTRIM(LTRIM(TB004)) = @MtlItemNo
                                ORDER BY TB002 DESC,TB007 DESC";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        var LastEditionErpResult = sqlConnection.Query(sql, dynamicParameters);

                        if (LastEditionErpResult.Count() > 0)
                        {
                            originalUnit = Unit;
                            originalSmallUnit = LastEditionErpResult.First().TB006;
                            originalChangeEdition = LastEditionErpResult.First().TB007;
                            originalStandardLot = Convert.ToInt32(LastEditionErpResult.First().TB008).ToString();
                            originalMoPrefix = LastEditionErpResult.First().TB009;
                            originalRemark = LastEditionErpResult.First().TB013;
                            originalSortNum = LastEditionErpResult.First().TB003;
                            originalBomChangeNo = LastEditionErpResult.First().TB002;

                            //var newEditionNum = int.Parse(LastEditionErpResult.First().TB007) + 1;
                            //var serial = "0000" + newEditionNum;
                            //changeEdition = serial.Substring(serial.Length - 4);
                        }
                        else
                        {
                            originalUnit = Unit;
                            originalSmallUnit = SmallUnit;
                            originalChangeEdition = "0000";
                            originalStandardLot = StandardLot;
                            originalMoPrefix = MoPrefix;
                            originalRemark = NewRemark;
                            originalSortNum = SortNum;
                            originalBomChangeNo = "";
                            //changeEdition = "0001";
                        }
                        #endregion
                    }
                    #endregion

                    #region //新增
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.BomChangeDetail (BomChangeId, MtlItemId, ChangeEdition, Unit, SmallUnit, StandardLot, MoPrefix, ChangeReason, ConfirmStatus, ConfirmCode, NewRemark, SortNum
                                , OriginalMtlItemId,  OriginalUnit, OriginalSmallUnit, OriginalChangeEdition, OriginalStandardLot, OriginalMoPrefix, OriginalBomChangeId, OriginalRemark, OriginalSortNum
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy, BomId)
                                OUTPUT INSERTED.BomChangeDetailId
                                VALUES (@BomChangeId, @MtlItemId, @ChangeEdition, @Unit, @SmallUnit, @StandardLot, @MoPrefix, @ChangeReason, @ConfirmStatus, @ConfirmCode, @NewRemark, @SortNum
                                , @OriginalMtlItemId,  @OriginalUnit, @OriginalSmallUnit, @OriginalChangeEdition, @OriginalStandardLot, @OriginalMoPrefix, @OriginalBomChangeId, @OriginalRemark, @OriginalSortNum
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy, @BomId)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BomChangeId,
                                MtlItemId,
                                ChangeEdition = changeEdition,
                                Unit,
                                SmallUnit,
                                StandardLot,
                                MoPrefix,
                                ChangeReason,
                                ConfirmStatus = "N",
                                ConfirmCode = "N",
                                NewRemark,
                                SortNum = TB003,
                                OriginalMtlItemId = originalMtlItemId,
                                OriginalUnit = originalUnit,
                                OriginalSmallUnit = originalSmallUnit,
                                OriginalChangeEdition = originalChangeEdition,
                                OriginalStandardLot = originalStandardLot,
                                OriginalMoPrefix = originalMoPrefix,
                                OriginalBomChangeId = originalBomChangeId,
                                OriginalRemark = originalRemark,
                                OriginalSortNum = originalSortNum,
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy,
                                BomId,
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = insertResult
                        });
                        #endregion
                    }
                    #endregion


                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region AddBomChangeSubDetail -- Bom變更子單身資料新增 -- GPai 20230718
        public string AddBomChangeSubDetail(int BomChangeId, int BomChangeDetailId, int BomDetailId, int MtlItemId, int Unit, double CompositionQuantity, double Base, string ComponentType
            , double LossRate, string EffectiveDate, string ExpirationDate, string ChangeReason, string NewRemark, int SortNum, string Provide, string isChangeToNew, string StandardCostingType, string MaterialProperties, string DeleteStatus, int BomId)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【品號】資料錯誤!");
                if (Base < 0) throw new SystemException("【底數】設定錯誤!");
                if (LossRate < 0) throw new SystemException("【耗損率】設定錯誤!應大於等於0");
                if (LossRate > 1000) throw new SystemException("【耗損率】設定錯誤!應小於1000");
                if (CompositionQuantity < 0) throw new SystemException("【組成用量數量】設定錯誤!");
                string newMtlItemNo = "";
                string newBomSortNum = "";
                string newSubstituteStatus = "";
                string originalMtlItemNo = "";
                string originalBomSortNum = "";

                double lossRate = LossRate * 0.01;
                var originalBase = 0.0;
                var originalLossRate = 0.0;
                string originalEffectiveDate = "";
                string originalExpirationDate = "";
                int originalMtlItemId = MtlItemId;
                var originalCompositionQuantity = 0.0;

                var newStandardCostingType = "";
                var newMaterialProperties = "";
                var originalStandardCostingType = "";
                var originalMaterialProperties = "";

                string NewEffectiveDate = "";
                string NewExpirationDate = "";

                var mainMtlitem = "";

                var OriginalComponentType = "";


                if (EffectiveDate == "")
                {
                    NewEffectiveDate = null;
                }
                else
                {
                    NewEffectiveDate = EffectiveDate;
                }

                if (ExpirationDate == "")
                {
                    NewExpirationDate = null;
                }
                else
                {
                    NewExpirationDate = ExpirationDate;
                }


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                        if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in Companyresult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //MtlItemId 是否存在MES
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM PDM.MtlItem
                                    WHERE  MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var MtlItemNoResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoResult.Count() < 0) throw new SystemException("【BOM變更管理】－查無此品號");
                        if (MtlItemNoResult.First().TransferStatus == "N") throw new SystemException("【BOM變更管理】－此品號為新品號(未拋轉)");
                        if (MtlItemNoResult.FirstOrDefault().CompanyId != Companyresult.FirstOrDefault().CompanyId) throw new SystemException("【BOM變更管理】－此品號不屬於目前公司別!");
                        newMtlItemNo = MtlItemNoResult.First().MtlItemNo;
                        #endregion

                        #region //取得BOM元件
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.BomDetail 
                                WHERE BomId = @BomId
                                ORDER BY BomSequence DESC";
                        dynamicParameters.Add("BomId", BomId);
                        var BomCountResult = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in BomCountResult)
                        {
                            if (MtlItemId == item.MtlItemId && BomDetailId == -1) throw new SystemException("【BOM變更管理】該品號已是Bom元件!");
                        }

                            #endregion



                            #region //取得 元件資料
                            var i = 0;
                        if (BomDetailId > -1)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.BomDetailId, a.BomId, a.BomSequence, a.MtlItemId, a.UomId, a.CompositionQuantity, a.Base, a.LossRate, a.StandardCostingType, a.MaterialProperties
                            , ISNULL(FORMAT(a.EffectiveDate, 'yyyy-MM-dd'), '') EffectiveDate, FORMAT(a.ExpirationDate, 'yyyy-MM-dd') ExpirationDate
                            , a.ReleaseItem, a.Remark, a.SubstitutionRemark, a.ConfirmStatus, FORMAT(a.CreateDate, 'yyyy-MM-dd HH:mm') CreateDate, a.ComponentType
                            , b.TransferStatus
                            , c.MtlItemNo, c.MtlItemName, c.MtlItemSpec
                            , d.UomNo
                            FROM PDM.BomDetail a
                            INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                            INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                            INNER JOIN PDM.UnitOfMeasure d ON a.UomId = d.UomId
                            WHERE 1=1 AND a.BomDetailId = @BomDetailId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            dynamicParameters.Add("BomDetailId", BomDetailId);
                            var Result = sqlConnection.Query(sql, dynamicParameters);
                            if (Result.Count() != 1) throw new SystemException("【BOM變更管理】－此元件資料錯誤，不可開立變更單");

                            foreach (var item in Result)
                            {
                                i++;
                                int seq = SortNum;//
                                string serial = "0000" + seq;

                                newMtlItemNo = item.MtlItemNo;
                                originalMtlItemNo = item.MtlItemNo;
                                newSubstituteStatus = "1";
                                originalBomSortNum = item.BomSequence;
                                newBomSortNum = serial.Substring(serial.Length - 4);

                                newStandardCostingType = StandardCostingType;
                                newMaterialProperties = MaterialProperties;
                                originalStandardCostingType = item.StandardCostingType;
                                originalMaterialProperties = item.MaterialProperties;

                                originalMtlItemId = item.MtlItemId;

                                OriginalComponentType = item.ComponentType;

                                if (item.EffectiveDate == "" || item.EffectiveDate == null)
                                {
                                    originalEffectiveDate = null;
                                }
                                else
                                {
                                    originalEffectiveDate = item.EffectiveDate;
                                }

                                if (item.ExpirationDate == "" || item.ExpirationDate == null)
                                {
                                    originalExpirationDate = null;
                                }
                                else
                                {
                                    originalExpirationDate = item.EffectiveDate;
                                }

                                originalBase = item.Base;
                                originalLossRate = item.LossRate;
                                originalCompositionQuantity = item.CompositionQuantity;


                                //if (isChangeToNew == "Y")
                                //{
                                //    if (item.MtlItemId == MtlItemId) throw new SystemException("【BOM變更管理】－該新品號與原品號相同!");

                                //}
                                //else
                                //{
                                //    if (DeleteStatus == "N")
                                //    {//newdd
                                //        if ((Base == originalBase) && (LossRate == originalLossRate) && (CompositionQuantity == originalCompositionQuantity) && (originalEffectiveDate == NewEffectiveDate) && (originalExpirationDate == NewExpirationDate)) throw new SystemException("【BOM變更管理】－設定與原資料相同!");
                                //    }
                                //}
                                if (Provide == "Y")
                                {
                                    if ((Base == originalBase) 
                                        && (LossRate == originalLossRate) 
                                        && (CompositionQuantity == originalCompositionQuantity) 
                                        && (originalEffectiveDate == NewEffectiveDate) 
                                        && (originalExpirationDate == NewExpirationDate) 
                                        && (newStandardCostingType == originalStandardCostingType) 
                                        && (newMaterialProperties == originalMaterialProperties)
                                        && (ComponentType == OriginalComponentType))

                                        throw new SystemException("【BOM變更管理】－設定與原資料相同!");
                                }

                            }

                        }
                        else
                        {
                            i++;
                            int seq = SortNum;
                            string serial = "0000" + seq;

                            newStandardCostingType = StandardCostingType;
                            newMaterialProperties = MaterialProperties;

                            originalMtlItemNo = "";
                            newSubstituteStatus = "1";
                            originalBomSortNum = "";
                            newBomSortNum = serial.Substring(serial.Length - 4);
                            originalEffectiveDate = NewEffectiveDate;
                            originalExpirationDate = NewExpirationDate;
                            originalBase = 0;
                            originalLossRate = 0;
                            originalCompositionQuantity = 0;
                            originalMtlItemId = MtlItemId;
                        }

                        #region //子單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.BomChangeSubDetail 
                                WHERE BomChangeId = @BomChangeId AND BomChangeDetailId = @BomChangeDetailId
                                ORDER BY BomSortNum DESC";
                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);


                        var subdetail = sqlConnection.Query(sql, dynamicParameters);
                        if (subdetail.Count() > 0)
                        {
                            foreach (var item in subdetail)
                            {
                                if (BomDetailId > 0)
                                {
                                    if (newBomSortNum == item.BomSortNum) throw new SystemException("【BOM變更管理】－該序號資料已填變更單!: " + newBomSortNum);

                                }
                                else
                                {
                                    
                                }

                            }

                            if (BomDetailId < 0)
                            {
                                string oldbomsort = BomCountResult.Count() > 0 ? BomCountResult.First().BomSequence : "0000";

                                int seq = ((BomCountResult.Count() + 1) * 10);
                                string serial = "0000" + seq;
                                newBomSortNum = serial.Substring(serial.Length - 4);

                                int seq2 = int.Parse(subdetail.First().BomSortNum);

                                if (seq == seq2 || seq < seq2)
                                {
                                    seq = int.Parse(subdetail.First().BomSortNum) + 10;
                                    serial = "0000" + seq;
                                    newBomSortNum = serial.Substring(serial.Length - 4);
                                }

                                if (newBomSortNum == oldbomsort) {
                                    seq = int.Parse(newBomSortNum.Substring(newBomSortNum.Length - 2, 2)) + 10;
                                    serial = "0000" + seq;
                                    newBomSortNum = serial.Substring(serial.Length - 4);
                                }

                            }

                        }
                        else
                        {

                            if (BomDetailId < 0)
                            {
                                string oldbomsort = BomCountResult.Count() > 0 ? BomCountResult.First().BomSequence : "0000";

                                int seq = int.Parse(oldbomsort) + 10;
                                string serial = "0000" + seq;
                                newBomSortNum = serial.Substring(serial.Length - 4);
                            }
                        }
                        #endregion

                        #endregion

                        #region//取得變更單頭資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM PDM.BomChange
                                WHERE BomChangeId = @BomChangeId
                                ORDER BY BomChangeId DESC";
                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        var BomChangeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BomChangeResult.FirstOrDefault().CompanyId != Companyresult.FirstOrDefault().CompanyId) throw new SystemException("【BOM變更管理】－此變更單不屬於目前公司別!");
                        #endregion

                        #region//取得變更單身資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.*,b.MtlItemNo
                                FROM PDM.BomChangeDetail a
								INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                WHERE BomChangeId = @BomChangeId
                                ORDER BY BomChangeId DESC";
                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        var BomChangeDetailResult = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in BomChangeDetailResult)
                        {
                            if (item.MtlItemId == MtlItemId) throw new SystemException("【BOM變更管理】－ 該品號與主件相同!!");
                            mainMtlitem = item.MtlItemNo;
                        }
                        #endregion

                        #region //該欄位是否在該變更單已新增
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM PDM.BomChangeSubDetail
                                WHERE BomChangeDetailId = @BomChangeDetailId AND MtlItemId = @MtlItemId
                                ORDER BY BomChangeDetailId DESC";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);
                        var BomChangeSubDetailResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BomChangeSubDetailResult.Count() > 0) throw new SystemException("【BOM變更管理】此品號已新增過!");
                        #endregion
                    }
                    #region //MtlItemId 是否存在ERP

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                    FROM INVMB
                                    WHERE MB001=@MB001";
                        dynamicParameters.Add("MB001", newMtlItemNo);
                        var MtlItemNoErpResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoErpResult.Count() != 1) throw new SystemException("【BOM變更管理】－此品號為未建於ERP");

                        #region // 找出BOM最大序號比對新序號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MD002
                                FROM BOMMD
                                WHERE MD001 = @MD001
                                ORDER BY MD002 DESC";
                        dynamicParameters.Add("MD001", mainMtlitem);
                        var MtlItemNoErpBomResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BomDetailId < 0)//新增元件時才跑這段
                        {
                            foreach (var item in MtlItemNoErpBomResult)
                            {
                                var aa = int.Parse(newBomSortNum);//新序號
                                var bb = int.Parse(item.MD002);//現有最大序號

                                if (aa <= bb)
                                {
                                    var seq = bb + 10;
                                    var serial = "0000" + seq;
                                    newBomSortNum = serial.Substring(serial.Length - 4);
                                }
                            }
                        }
                        #endregion



                    }
                    #endregion



                    #region //新增
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.BomChangeSubDetail (BomChangeDetailId, BomChangeId, BomDetailId, BomSortNum, Unit, SmallUnit, CompositionQuantity, Base, LossRate, SubstituteStatus, EffectiveDate, ExpirationDate, OptionalPreset, StandardCosting, BomType, FeedingInterval, ChangeReason, NewRemark
                                , OriginalBomDetailId,  OriginalBomSortNum, OriginalUnit, OriginalSmallUnit, OriginalCompositionQuantity, OriginalBase, OriginalLossRate, OriginalSubstituteStatus, OriginalEffectiveDate, OriginalExpirationDate, OriginalOptionalPreset, OriginalStandardCosting, OriginalBomType, OriginalFeedingInterval
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy, MtlItemId, Provide, OriginalMtlItemId, DeleteStatus, ComponentType, OriginalComponentType)
                                OUTPUT INSERTED.BomChangeDetailId
                                VALUES (@BomChangeDetailId, @BomChangeId, @BomDetailId, @BomSortNum, @Unit, @SmallUnit, @CompositionQuantity, @Base, @LossRate, @SubstituteStatus, @EffectiveDate, @ExpirationDate, @OptionalPreset, @StandardCosting, @BomType, @FeedingInterval, @ChangeReason, @NewRemark
                                , @OriginalBomDetailId,  @OriginalBomSortNum, @OriginalUnit, @OriginalSmallUnit, @OriginalCompositionQuantity, @OriginalBase, @OriginalLossRate, @OriginalSubstituteStatus, @OriginalEffectiveDate, @OriginalExpirationDate, @OriginalOptionalPreset, @OriginalStandardCosting, @OriginalBomType, @OriginalFeedingInterval
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy, @MtlItemId, @Provide, @OriginalMtlItemId, @DeleteStatus, @ComponentType, @OriginalComponentType)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BomChangeDetailId,
                                BomChangeId,
                                BomDetailId,
                                BomSortNum = newBomSortNum,
                                Unit,
                                SmallUnit = "",
                                CompositionQuantity,
                                Base,
                                LossRate = lossRate,
                                SubstituteStatus = newSubstituteStatus,
                                EffectiveDate = NewEffectiveDate,
                                ExpirationDate = NewExpirationDate,
                                OptionalPreset = "N",
                                StandardCosting = newStandardCostingType,
                                BomType = newMaterialProperties,
                                FeedingInterval = 0,


                                ChangeReason,
                                NewRemark,

                                OriginalBomDetailId = BomDetailId,
                                OriginalBomSortNum = originalBomSortNum,
                                OriginalUnit = Unit,
                                OriginalSmallUnit = "",
                                OriginalBase = originalBase,
                                OriginalLossRate = originalLossRate,
                                OriginalSubstituteStatus = newSubstituteStatus,
                                OriginalEffectiveDate = originalEffectiveDate,
                                OriginalExpirationDate = originalExpirationDate,
                                OriginalOptionalPreset = "N",
                                OriginalStandardCosting = originalStandardCostingType,
                                OriginalBomType = originalMaterialProperties,
                                OriginalFeedingInterval = 0,
                                OriginalCompositionQuantity = originalCompositionQuantity,

                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy,
                                MtlItemId,
                                Provide,
                                OriginalMtlItemId = originalMtlItemId,
                                DeleteStatus,
                                ComponentType,
                                OriginalComponentType
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = insertResult
                        });
                        #endregion
                    }
                    #endregion


                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region AddMtlItemUomCalculateChange // 新增品號換算單位變更
        public string AddMtlItemUomCalculateChange(int MtlItemChangeId, int MtlItemId, int UomId, int NewConvertUomId, double NewSwapNumerator, double NewSwapDenominator)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【品號單位換算變更】－品號不能空，請重新確認");
                if (UomId <= 0) throw new SystemException("【品號單位換算變更】－庫存單位不能空，請重新確認");
                if (NewConvertUomId <= 0) throw new SystemException("【品號單位換算變更】－換算單位不能空，請重新確認");
                if (NewSwapNumerator <= 0) throw new SystemException("【品號單位換算變更】－換算率分子不能小於等於0，請重新確認");
                if (NewSwapDenominator <= 0) throw new SystemException("【品號單位換算變更】－換算率分母不能小於等於0，請重新確認");
                string changeEdition = "";
                int originConvertUomId = 0;
                double originSwapNumerator = 0.0;
                double originSwapDenominator = 0.0;


                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        #region //判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 InventoryUomId,TransferStatus
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算變更】－品號不存在，請重新輸入!");
                        foreach (var item in result)
                        {
                            if (item.InventoryUomId != UomId) throw new SystemException("【品號單位換算變更】－庫存單位與該品號的庫存單位必須相同，請重新確認!");
                            //if (item.TransferStatus == "Y") throw new SystemException("【品號單位換算】－品號已經拋轉不可以新增!!");
                            if (item.InventoryUomId == NewConvertUomId) throw new SystemException("【品號單位換算變更】－庫存單位與換算單位不可以相同，請重新確認!");
                        }
                        #endregion

                        #region //判斷庫存單位是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @UomId";
                        dynamicParameters.Add("UomId", UomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算變更】－庫存單位不存在，請重新輸入!");
                        #endregion

                        #region //品號單位換算資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM PDM.MtlItemUomCalculate
                                WHERE MtlItemId = @MtlItemId AND UomId = @UomId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("UomId", UomId);

                        result = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result)
                        {
                            if (item.UomId != UomId) throw new SystemException("【品號單位換算變更】－庫存單位與該品號的庫存單位必須相同，請重新確認!");
                            //if (item.TransferStatus == "Y") throw new SystemException("【品號單位換算】－品號已經拋轉不可以新增!!");
                            if (item.ConvertUomId == NewConvertUomId)
                            {
                                if (item.SwapNumerator == NewSwapNumerator) throw new SystemException("【品號單位換算變更】－資料無變動!!");
                            }
                            originConvertUomId = item.ConvertUomId;
                            originSwapNumerator = item.SwapNumerator;
                            originSwapDenominator = item.SwapDenominator;


                        }

                        //if (result.Count() > 0) throw new SystemException("【品號單位換算】－換算單位已存在,不可以新增!");
                        #endregion

                        #region //判斷換算單位是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @ConvertUomId";
                        dynamicParameters.Add("ConvertUomId", NewConvertUomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算變更】－換算單位不存在，請重新輸入!");
                        #endregion

                        #region //變更單資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM PDM.MtlItemUomCalculateChange
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算變更】－變更單不存在!");//changeEdition

                        foreach (var item in result)
                        {
                            if (item.TransferStatus != "N") throw new SystemException("【品號單位換算變更】－變更單已拋轉!");
                            if (item.ConfirmStatus == "Y") throw new SystemException("【品號單位換算變更】－變更單已確認!");
                            if (item.ConfirmStatus == "V") throw new SystemException("【品號單位換算變更】－變更單已作廢!");

                            //if (item.TransferStatus == "Y") throw new SystemException("【品號單位換算】－品號已經拋轉不可以新增!!");
                            if (item.InventoryUomId == NewConvertUomId)
                            {
                                if (item.SwapNumerator == NewSwapNumerator) throw new SystemException("【品號單位換算變更】－資料無變動!!");
                            }
                            changeEdition = item.ChangeEdition;

                        }
                        #endregion

                        #region //資料新增
                        dynamicParameters = new DynamicParameters();
                        sql = @"INSERT INTO PDM.MtlItemUomCalculateChange (CompanyId, MtlItemChangeId, MtlItemId, UomChangeEdit, ConvertUomId, SwapNumerator, SwapDenominator
                                , OriginConvertUomId, OriginSwapNumerator, OriginSwapDenominator, TransferStatus, TransferDate, ConfirmStatus, ConfirmDate
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.UomChangeId
                                VALUES (@CompanyId, @MtlItemChangeId, @MtlItemId, @UomChangeEdit, @ConvertUomId, @SwapNumerator, @SwapDenominator
                                , @OriginConvertUomId, @OriginSwapNumerator, @OriginSwapDenominator, @TransferStatus, @TransferDate, @ConfirmStatus, @ConfirmDate
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompanyId = CurrentCompany,
                                MtlItemChangeId,
                                MtlItemId,
                                UomChangeEdit = changeEdition,
                                ConvertUomId = NewConvertUomId,
                                SwapNumerator = NewSwapNumerator,
                                SwapDenominator = NewSwapDenominator,
                                OriginConvertUomId = originConvertUomId,
                                OriginSwapNumerator = originSwapNumerator,
                                OriginSwapDenominator = originSwapDenominator,
                                TransferStatus = 'N',
                                CreateDate,
                                LastModifiedDate,
                                CreateBy,
                                LastModifiedBy
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);
                        int rowsAffected = insertResult.Count();

                        int MtlItemUomCalculateId = -1;
                        foreach (var item in insertResult)
                        {
                            MtlItemUomCalculateId = item.MtlItemUomCalculateId;
                        }
                        #endregion



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                            data = insertResult
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //AddMtlItemFile-- 新增品號審核檔案 -- Shintokuro 2024-11-13
        public string AddMtlItemFile(string MtlItemNo, int MtDocId, string FileId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        int rowsAffected = 0;

                        dynamicParameters = new DynamicParameters();

                        //#region //請購單開立-檢核該品號必要審核文件是否上傳(只有特定類型的品號需要檢核)
                        //if (CurrentCompany != 4)
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 b.FileId
                        //        FROM PDM.MtlItem a
                        //        OUTER APPLY(
                        //            SELECT x1.MtDocId, x1.DocName 
                        //            FROM PDM.MtlItemDocSetting x1
                        //            WHERE x1.PurchaseMandatory = 'Y' 
                        //        ) x
                        //        LEFT JOIN PDM.MtlItemFile b on a.MtlItemNo = b.MtlItemNo AND  x.MtDocId = b.MtDocId
                        //        WHERE a.MtlItemNo = @MtlItemNo
                        //        AND b.FileId is null";
                        //    dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        //    var result = sqlConnection.Query(sql, dynamicParameters);
                        //    if (result.Count() > 0) throw new SystemException("品號必要審核文件尚有缺鍵，不可以開立請購單!");
                        //}
                        //#endregion

                        #region //判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MtlItem
                                WHERE MtlItemNo = @MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號不存在，請重新輸入!");
                        #endregion

                        #region //判斷品號審核文件類別是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MtlItemDocSetting
                                WHERE MtDocId = @MtDocId";
                        dynamicParameters.Add("MtDocId", MtDocId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號審核文件類別不存在，請重新輸入!");
                        #endregion

                        #region //判斷品號審核文件是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.FileId
                                FROM PDM.MtlItem a
                                OUTER APPLY(
                                    SELECT x1.MtDocId, x1.DocName 
                                    FROM PDM.MtlItemDocSetting x1
                                ) x
                                LEFT JOIN PDM.MtlItemFile b on a.MtlItemNo = b.MtlItemNo AND  x.MtDocId = b.MtDocId
                                WHERE a.MtlItemNo = @MtlItemNo
                                AND x.MtDocId = @MtDocId
                                AND b.FileId is not null";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        dynamicParameters.Add("MtDocId", MtDocId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            #region //檔案新增
                            foreach (var item in FileId.Split(','))
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.MtlItemFile (MtlItemNo,MtDocId, FileId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MtlItemNo, @MtDocId, @FileId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MtlItemNo,
                                        MtDocId,
                                        FileId = item,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                            }
                            #endregion
                        }
                        else
                        {
                            #region //檔案更新
                            foreach (var item in FileId.Split(','))
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE PDM.MtlItemFile SET
                                        FileId = @FileId,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MtlItemNo = @MtlItemNo
                                        AND MtDocId = @MtDocId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        FileId = item,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MtlItemNo,
                                        MtDocId
                                    });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                            }
                            #endregion
                        }
                        #endregion


                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)",
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion

        #region //Update
        #region //UpdateMtlItemSynchronize -- 品號資料同步 -- Zoey 2022.06.28
        public string UpdateMtlItemSynchronize(string CompanyNo, string UpdateDate, string MtlItemNo)
        {
            try
            {
                if (MtlItemNo == null) MtlItemNo = "";
                List<MtlItem> mtlitems = new List<MtlItem>();
                List<CustomerMtlItem> customerMtlItems = new List<CustomerMtlItem>();

                if (CompanyNo.Length <= 0) throw new SystemException("【公司】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
                {
                    int CompanyId = -1;
                    string ErpConnectionStrings = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", CompanyNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //撈取ERP品號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MB001)) MtlItemNo, LTRIM(RTRIM(a.MB002)) MtlItemName, LTRIM(RTRIM(a.MB003)) MtlItemSpec
                                , LTRIM(RTRIM(a.MB004)) InventoryUomNo, LTRIM(RTRIM(a.MB155)) PurchaseUomNo
                                , LTRIM(RTRIM(a.MB156)) SaleUomNo, LTRIM(RTRIM(a.MB005)) TypeOne, LTRIM(RTRIM(a.MB006)) TypeTwo, LTRIM(RTRIM(a.MB007)) TypeThree
                                , LTRIM(RTRIM(a.MB008)) TypeFour, LTRIM(RTRIM(a.MB017)) InventoryNo, LTRIM(RTRIM(a.MB157)) RequisitionInventoryNo
                                , LTRIM(RTRIM(a.MB019)) InventoryManagement, LTRIM(RTRIM(a.MB066)) MtlModify, LTRIM(RTRIM(a.MB020)) BondedStore
                                , LTRIM(RTRIM(a.MB025)) ItemAttribute,LTRIM(RTRIM(a.MB068)) ProductionLine, LTRIM(RTRIM(a.MB022)) LotManagement, LTRIM(RTRIM(a.MB023)) EfficientDays, LTRIM(RTRIM(a.MB024)) RetestDays, LTRIM(RTRIM(a.MB043)) MeasureType
                                , CASE WHEN LEN(LTRIM(RTRIM(a.MB030))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MB030)) as date), 'yyyy-MM-dd') ELSE NULL END EffectiveDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.MB031))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MB031)) as date), 'yyyy-MM-dd') ELSE NULL END ExpirationDate
                                , LTRIM(RTRIM(a.MB032)) MainSupplierNo, LTRIM(RTRIM(a.MB044)) OverReceiptManagement
                                , LTRIM(RTRIM(a.MB087)) OverDeliveryManagement, LTRIM(RTRIM(a.MB165)) Version
                                , LTRIM(RTRIM(a.MB009)) MtlItemDesc, LTRIM(RTRIM(a.MB028)) MtlItemRemark, LTRIM(RTRIM(a.CREATOR)) UserNo
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                , a.MB034 ReplenishmentPolicy
                                FROM INVMB a
                                WHERE 1=1 AND a.MB004!='pcs' AND a.MB155!='pcs' AND a.MB156!='pcs'
                                AND LTRIM(RTRIM(a.MB001)) NOT IN ('3A12L84N-L1(2)', '3FMHD（GM1557）-PGM', '2A8CAV-D16MR-3.0-LBX-103-M')";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + a.CREATE_TIME > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MB001 LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                        sql += @" ORDER BY TransferDate, TransferTime";

                        mtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //撈取ERP客戶品號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MG001)) CustomerNo, LTRIM(RTRIM(a.MG002)) MtlItemNo, LTRIM(RTRIM(a.MG003)) CustomerMtlItemNo
                                , LTRIM(RTRIM(a.MG005)) CustomerMtlItemName, LTRIM(RTRIM(a.MG006)) CustomerMtlItemSpec
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                FROM COPMG a
                                WHERE 1=1";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + a.CREATE_TIME > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                        sql += @" ORDER BY TransferDate, TransferTime";

                        customerMtlItems = sqlConnection.Query<CustomerMtlItem>(sql, dynamicParameters).ToList();
                        #endregion
                    }

                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //撈取單位ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UomId, UomNo
                                FROM PDM.UnitOfMeasure
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<UnitOfMeasure> resultUoms = sqlConnection.Query<UnitOfMeasure>(sql, dynamicParameters).ToList();

                        mtlitems = mtlitems.Join(resultUoms, x => x.InventoryUomNo, y => y.UomNo, (x, y) => { x.InventoryUomId = y.UomId; return x; }).ToList();
                        mtlitems = mtlitems.Join(resultUoms, x => x.PurchaseUomNo, y => y.UomNo, (x, y) => { x.PurchaseUomId = y.UomId; return x; }).ToList();
                        mtlitems = mtlitems.Join(resultUoms, x => x.SaleUomNo, y => y.UomNo, (x, y) => { x.SaleUomId = y.UomId; return x; }).ToList();
                        #endregion

                        #region //撈取庫別ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT InventoryId, InventoryNo
                                FROM SCM.Inventory
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<Inventory> resultInventories = sqlConnection.Query<Inventory>(sql, dynamicParameters).ToList();

                        mtlitems = mtlitems.GroupJoin(resultInventories, x => x.InventoryNo, y => y.InventoryNo, (x, y) => { x.InventoryId = y.FirstOrDefault()?.InventoryId; return x; }).ToList();
                        mtlitems = mtlitems.GroupJoin(resultInventories, x => x.RequisitionInventoryNo, y => y.InventoryNo, (x, y) => { x.RequisitionInventoryId = y.FirstOrDefault()?.InventoryId; return x; }).ToList();
                        #endregion

                        #region //撈取使用者ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.UserId, a.UserNo
                                FROM BAS.[User] a
                                INNER JOIN BAS.Department b on a.DepartmentId = b.DepartmentId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<User> resultUser = sqlConnection.Query<User>(sql, dynamicParameters).ToList();

                        mtlitems = mtlitems.GroupJoin(resultUser, x => x.UserNo, y => y.UserNo, (x, y) => { x.CreateBy = y.FirstOrDefault()?.UserId; return x; }).ToList();
                        #endregion

                        #region //判斷PDM.MtlItem是否有資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId, MtlItemNo
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<MtlItem> resultMtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();

                        mtlitems = mtlitems.GroupJoin(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.FirstOrDefault()?.MtlItemId; return x; }).ToList();
                        #endregion

                        #region //品號 新增/更新
                        List<MtlItem> addMtlItems = mtlitems.Where(x => x.MtlItemId == null).ToList();
                        List<MtlItem> updateMtlItems = mtlitems.Where(x => x.MtlItemId != null).ToList();

                        #region //新增
                        if (addMtlItems.Count > 0)
                        {
                            addMtlItems
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.CompanyId = CompanyId;
                                    x.TransferStatus = "Y";
                                    x.Status = "A";
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = x.CreateBy != null ? x.CreateBy : CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO PDM.MtlItem (CompanyId, MtlItemNo, MtlItemName, MtlItemSpec, InventoryUomId
                                    , PurchaseUomId, SaleUomId, TypeOne, TypeTwo, TypeThree, TypeFour, InventoryId
                                    , RequisitionInventoryId, InventoryManagement, MtlModify, BondedStore, ItemAttribute, ProductionLine, LotManagement
                                    , MeasureType, EffectiveDate, ExpirationDate, OverReceiptManagement, OverDeliveryManagement
                                    , Version, MtlItemDesc, MtlItemRemark, TransferStatus, TransferDate, Status, ReplenishmentPolicy
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@CompanyId, @MtlItemNo, @MtlItemName, @MtlItemSpec, @InventoryUomId
                                    , @PurchaseUomId, @SaleUomId, @TypeOne, @TypeTwo, @TypeThree, @TypeFour, @InventoryId
                                    , @RequisitionInventoryId, @InventoryManagement, @MtlModify, @BondedStore, @ItemAttribute, @ProductionLine, @LotManagement
                                    , @MeasureType, @EffectiveDate, @ExpirationDate, @OverReceiptManagement, @OverDeliveryManagement
                                    , @Version, @MtlItemDesc, @MtlItemRemark, @TransferStatus, @TransferDate, @Status, @ReplenishmentPolicy
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, addMtlItems);
                        }
                        #endregion                        

                        #region //修改
                        if (updateMtlItems.Count > 0)
                        {
                            updateMtlItems
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TransferStatus = "Y";
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"UPDATE PDM.MtlItem SET
                                    MtlItemName = @MtlItemName,
                                    MtlItemSpec = @MtlItemSpec,
                                    InventoryUomId = @InventoryUomId,
                                    PurchaseUomId = @PurchaseUomId,
                                    SaleUomId = @SaleUomId,
                                    TypeOne = @TypeOne,
                                    TypeTwo = @TypeTwo,
                                    TypeThree = @TypeThree,
                                    TypeFour = @TypeFour,
                                    InventoryId = @InventoryId,
                                    RequisitionInventoryId = @RequisitionInventoryId,
                                    InventoryManagement = @InventoryManagement,
                                    MtlModify = @MtlModify,
                                    BondedStore = @BondedStore,
                                    ItemAttribute = @ItemAttribute,
                                    ProductionLine = @ProductionLine,
                                    LotManagement = @LotManagement,
                                    EfficientDays = @EfficientDays,
                                    RetestDays = @RetestDays,
                                    MeasureType = @MeasureType,
                                    EffectiveDate = @EffectiveDate,
                                    ExpirationDate = @ExpirationDate,
                                    OverReceiptManagement = @OverReceiptManagement,
                                    OverDeliveryManagement = @OverDeliveryManagement,
                                    Version = @Version,
                                    MtlItemDesc = @MtlItemDesc,
                                    MtlItemRemark = @MtlItemRemark,
                                    TransferStatus = @TransferStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy,
                                    ReplenishmentPolicy= @ReplenishmentPolicy
                                    WHERE MtlItemId = @MtlItemId";
                            rowsAffected += sqlConnection.Execute(sql, updateMtlItems);
                        }
                        #endregion
                        #endregion

                        #region //客戶品號 新增/更新
                        #region //撈取品號ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId, MtlItemNo
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<MtlItem> resultMtlItems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();

                        customerMtlItems = customerMtlItems.Join(resultMtlItems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).ToList();
                        #endregion

                        #region //撈取客戶ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT CustomerId, CustomerNo 
                                FROM SCM.Customer
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<Customer> resultCustomers = sqlConnection.Query<Customer>(sql, dynamicParameters).ToList();

                        customerMtlItems = customerMtlItems.Join(resultCustomers, x => x.CustomerNo, y => y.CustomerNo, (x, y) => { x.CustomerId = y.CustomerId; return x; }).ToList();
                        #endregion

                        #region //判斷PDM.CustomerMtlItem是否有資料
                        dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT a.CustomerMtlItemId, a.MtlItemId, a.CustomerId
                        //        FROM PDM.CustomerMtlItem a
                        //        INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                        //        WHERE b.CompanyId = @CompanyId";

                        sql = @"SELECT a.CustomerMtlItemId, a.MtlItemId, a.CustomerId, a.CustomerMtlItemNo
                                FROM PDM.CustomerMtlItem a
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<CustomerMtlItem> resultCustomerMtlItems = sqlConnection.Query<CustomerMtlItem>(sql, dynamicParameters).ToList();

                        // customerMtlItems = customerMtlItems.GroupJoin(resultCustomerMtlItems, x => new { x.MtlItemId, x.CustomerId }, y => new { y.MtlItemId, y.CustomerId }, (x, y) => { x.CustomerMtlItemId = y.FirstOrDefault()?.CustomerMtlItemId; return x; }).ToList();

                        customerMtlItems = customerMtlItems.GroupJoin(resultCustomerMtlItems, x => new { x.MtlItemId, x.CustomerId, x.CustomerMtlItemNo }, y => new { y.MtlItemId, y.CustomerId, y.CustomerMtlItemNo }, (x, y) => { x.CustomerMtlItemId = y.FirstOrDefault()?.CustomerMtlItemId; return x; }).ToList();

                        #endregion

                        List<CustomerMtlItem> addCustomerMtlItems = customerMtlItems.Where(x => x.CustomerMtlItemId == null).ToList();
                        List<CustomerMtlItem> updateCustomerMtlItems = customerMtlItems.Where(x => x.CustomerMtlItemId != null).ToList();

                        #region //新增
                        if (addCustomerMtlItems.Count > 0)
                        {
                            addCustomerMtlItems
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO PDM.CustomerMtlItem (MtlItemId, CustomerId, CustomerMtlItemNo, CustomerMtlItemName, CustomerMtlItemSpec
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MtlItemId, @CustomerId, @CustomerMtlItemNo, @CustomerMtlItemName, @CustomerMtlItemSpec
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, addCustomerMtlItems);
                        }
                        #endregion

                        #region //修改
                        if (updateCustomerMtlItems.Count > 0)
                        {
                            updateMtlItems
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"UPDATE PDM.CustomerMtlItem SET
                                    CustomerMtlItemNo = @CustomerMtlItemNo,
                                    CustomerMtlItemName = @CustomerMtlItemName,
                                    CustomerMtlItemSpec = @CustomerMtlItemSpec,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE CustomerMtlItemId = @CustomerMtlItemId";
                            rowsAffected += sqlConnection.Execute(sql, updateCustomerMtlItems);
                        }
                        #endregion
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }


                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomSynchronize -- BOM資料同步 -- Ann 2022.06.30  
        public string UpdateBomSynchronize(string CompanyNo, string UpdateDate, string MtlItemNo)
        {
            try
            {
                if (MtlItemNo == null) MtlItemNo = "";
                List<BillOfMaterials> billOfMaterials = new List<BillOfMaterials>();
                List<BomDetail> bomDetails = new List<BomDetail>();

                if (CompanyNo.Length <= 0) throw new SystemException("【公司】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
                {
                    int CompanyId = -1;
                    string ErpConnectionStrings = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", CompanyNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //撈取ERP產品結構主件資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MC001)) MtlItemNo, CASE WHEN ISNULL(a.MC002, '') = '' THEN LTRIM(RTRIM(b.MB004)) ELSE LTRIM(RTRIM(a.MC002)) END UomNo
                                , LTRIM(RTRIM(a.MC004)) StandardLot, LTRIM(RTRIM(a.MC005)) WipPrefix, LTRIM(RTRIM(a.MC006)) ModiPrefix, LTRIM(RTRIM(a.MC007)) ModiNo
                                , LTRIM(RTRIM(a.MC008)) ModiSequence, LTRIM(RTRIM(a.MC009)) Version, LTRIM(RTRIM(a.MC010)) Remark
                                , LTRIM(RTRIM(a.MC016)) ConfirmStatus, LTRIM(RTRIM(a.MC018)) ConfirmUserNo
                                , CASE WHEN LEN(LTRIM(RTRIM(a.MC017))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MC017)) as date), 'yyyy-MM-dd') ELSE NULL END ConfirmDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                FROM BOMMC a
                                INNER JOIN INVMB b ON a.MC001 = b.MB001
                                WHERE 1=1 AND ISNULL(a.MC002, '') !='pcs'";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + a.CREATE_TIME > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MC001 LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                        sql += @" ORDER BY TransferDate, TransferTime";

                        billOfMaterials = sqlConnection.Query<BillOfMaterials>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //撈取ERP產品結構元件資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MD001)) BomMtlItemNo, LTRIM(RTRIM(a.MD002)) BomSequence, LTRIM(RTRIM(a.MD003)) MtlItemNo
                                , LTRIM(RTRIM(a.MD004)) UomNo, LTRIM(RTRIM(a.MD006)) CompositionQuantity, LTRIM(RTRIM(a.MD007)) Base
                                , LTRIM(RTRIM(a.MD008)) LossRate, LTRIM(RTRIM(a.MD029)) ReleaseItem
                                , CASE WHEN LEN(LTRIM(RTRIM(a.MD011))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MD011)) as date), 'yyyy-MM-dd') ELSE NULL END EffectiveDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.MD012))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MD012)) as date), 'yyyy-MM-dd') ELSE NULL END ExpirationDate
                                , LTRIM(RTRIM(a.MD014)) StandardCostingType
                                , LTRIM(RTRIM(a.MD017)) MaterialProperties
                                , LTRIM(RTRIM(a.MD016)) Remark
                                , LTRIM(RTRIM(a.MD032)) ConfirmStatus, LTRIM(RTRIM(a.UDF01)) ComponentType
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                FROM BOMMD a
                                WHERE 1=1 AND a.MD004!='pcs' ";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + a.CREATE_TIME > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MD001 LIKE '%' + @MtlItemNo + '%'", MtlItemNo);
                        sql += @" ORDER BY TransferDate, TransferTime";

                        bomDetails = sqlConnection.Query<BomDetail>(sql, dynamicParameters).ToList();
                        #endregion
                    }

                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //撈取單位ID    
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UomId, UomNo
                                FROM PDM.UnitOfMeasure
                                WHERE Status='A' AND CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<UnitOfMeasure> resultUoms = sqlConnection.Query<UnitOfMeasure>(sql, dynamicParameters).ToList();

                        billOfMaterials = billOfMaterials.Join(resultUoms, x => x.UomNo, y => y.UomNo, (x, y) => { x.UomId = y.UomId; return x; }).ToList();
                        bomDetails = bomDetails.Join(resultUoms, x => x.UomNo, y => y.UomNo, (x, y) => { x.UomId = y.UomId; return x; }).ToList();
                        #endregion

                        #region //撈取品號ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId, MtlItemNo
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<MtlItem> resultMtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();

                        billOfMaterials = billOfMaterials.Join(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        bomDetails = bomDetails.Join(resultMtlitems, x => x.BomMtlItemNo, y => y.MtlItemNo, (x, y) => { x.BomMtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        bomDetails = bomDetails.Join(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        #endregion

                        #region //撈取確認者ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.UserId, a.UserNo
                                FROM BAS.[User] a
                                INNER JOIN BAS.Department b ON a.DepartmentId = b.DepartmentId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<User> resultConfirmUsers = sqlConnection.Query<User>(sql, dynamicParameters).ToList();

                        billOfMaterials = billOfMaterials.Join(resultConfirmUsers, x => x.ConfirmUserNo, y => y.UserNo, (x, y) => { x.ConfirmUserId = y.UserId; return x; }).ToList();
                        #endregion

                        #region //判斷PDM.BillOfMaterials是否有資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BomId, a.MtlItemId
                                FROM PDM.BillOfMaterials a
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<BillOfMaterials> resultBillOfMaterials = sqlConnection.Query<BillOfMaterials>(sql, dynamicParameters).ToList();

                        billOfMaterials = billOfMaterials.GroupJoin(resultBillOfMaterials, x => x.MtlItemId, y => y.MtlItemId, (x, y) => { x.BomId = y.FirstOrDefault()?.BomId; return x; }).ToList();
                        #endregion

                        #region //BOM主件 新增/更新
                        List<BillOfMaterials> addBillOfMaterials = billOfMaterials.Where(x => x.BomId == null).ToList();
                        List<BillOfMaterials> updateBillOfMaterials = billOfMaterials.Where(x => x.BomId != null).ToList();

                        #region //新增
                        if (addBillOfMaterials.Count > 0)
                        {
                            addBillOfMaterials
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TransferStatus = "Y";
                                    x.Status = "A";
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO PDM.BillOfMaterials (MtlItemId, UomId, StandardLot, WipPrefix, ModiPrefix
                                    , ModiNo, ModiSequence, Version, Remark, ConfirmStatus, ConfirmUserId, ConfirmDate
                                    , TransferStatus, TransferDate, Status
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MtlItemId, @UomId, @StandardLot, @WipPrefix, @ModiPrefix
                                    , @ModiNo, @ModiSequence, @Version, @Remark, @ConfirmStatus, @ConfirmUserId, @ConfirmDate
                                    , @TransferStatus, @TransferDate, @Status
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, addBillOfMaterials);
                        }
                        #endregion

                        #region //修改
                        if (updateBillOfMaterials.Count > 0)
                        {
                            updateBillOfMaterials
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TransferStatus = "Y";
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });
                            sql = @"UPDATE PDM.BillOfMaterials SET
                                    UomId = @UomId,
                                    StandardLot = @StandardLot,
                                    WipPrefix = @WipPrefix,
                                    ModiPrefix = @ModiPrefix,
                                    ModiNo = @ModiNo,
                                    ModiSequence = @ModiSequence,
                                    Version = @Version,
                                    Remark = @Remark,
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    ConfirmDate = @ConfirmDate,
                                    TransferStatus = @TransferStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BomId = @BomId";
                            rowsAffected += sqlConnection.Execute(sql, updateBillOfMaterials);
                        }
                        #endregion
                        #endregion

                        #region //BOM元件 新增/更新
                        #region //撈取BOM主件ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BomId, a.MtlItemId
                                FROM PDM.BillOfMaterials a
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        resultBillOfMaterials = sqlConnection.Query<BillOfMaterials>(sql, dynamicParameters).ToList();

                        bomDetails = bomDetails.Join(resultBillOfMaterials, x => x.BomMtlItemId, y => y.MtlItemId, (x, y) => { x.BomId = y.BomId; return x; }).ToList();
                        #endregion

                        #region //判斷PDM.BomDetail是否有資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BomDetailId, a.BomId, a.BomSequence
                                FROM PDM.BomDetail a
                                INNER JOIN PDM.BillOfMaterials b ON a.BomId = b.BomId
                                INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                WHERE c.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<BomDetail> resultBomDetails = sqlConnection.Query<BomDetail>(sql, dynamicParameters).ToList();

                        bomDetails = bomDetails.GroupJoin(resultBomDetails, x => new { x.BomId, x.BomSequence }, y => new { y.BomId, y.BomSequence }, (x, y) => { x.BomDetailId = y.FirstOrDefault()?.BomDetailId; return x; }).ToList();
                        #endregion

                        List<BomDetail> addBomDetails = bomDetails.Where(x => x.BomDetailId == null).ToList();
                        List<BomDetail> updateBomDetails = bomDetails.Where(x => x.BomDetailId != null).ToList();

                        #region //新增
                        if (addBomDetails.Count > 0)
                        {
                            addBomDetails
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO PDM.BomDetail (BomId, BomSequence, MtlItemId, UomId
                                    , CompositionQuantity, Base, LossRate, ReleaseItem, EffectiveDate, ExpirationDate
                                    , StandardCostingType, MaterialProperties, Remark, ConfirmStatus, ComponentType
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@BomId, @BomSequence, @MtlItemId, @UomId
                                    , @CompositionQuantity, @Base, @LossRate, @ReleaseItem, @EffectiveDate, @ExpirationDate
                                    , @StandardCostingType, @MaterialProperties, @Remark, @ConfirmStatus, @ComponentType
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, addBomDetails);
                        }
                        #endregion

                        #region //修改
                        if (updateBomDetails.Count > 0)
                        {
                            updateBomDetails
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"UPDATE PDM.BomDetail SET
                                    BomId = @BomId,
                                    BomSequence = @BomSequence,
                                    MtlItemId = @MtlItemId,
                                    UomId = @UomId,
                                    CompositionQuantity = @CompositionQuantity,
                                    Base = @Base,
                                    LossRate = @LossRate,
                                    StandardCostingType = @StandardCostingType,
                                    MaterialProperties = @MaterialProperties,
                                    ReleaseItem = @ReleaseItem,
                                    EffectiveDate = @EffectiveDate,
                                    ExpirationDate = @ExpirationDate,
                                    Remark = @Remark,
                                    ConfirmStatus = @ConfirmStatus,
                                    ComponentType = @ComponentType,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BomDetailId = @BomDetailId";
                            rowsAffected += sqlConnection.Execute(sql, updateBomDetails);
                        }
                        #endregion
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomSubstitutionSynchronize -- BOM取替代料資料同步 -- Ann 2022.07.01
        public string UpdateBomSubstitutionSynchronize(string CompanyNo, string UpdateDate)
        {
            try
            {
                List<BomDetail> bomDetails = new List<BomDetail>();
                List<BomSubstitution> bomSubstitutions = new List<BomSubstitution>();

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int CompanyId = -1;
                    string ErpConnectionStrings = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", CompanyNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //撈取ERP BOM取替代料單頭資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(MA001)) MtlItemNo, LTRIM(RTRIM(MA002)) BomMtlItemNo
                                , LTRIM(RTRIM(MA004)) SubstitutionRemark
                                , CASE WHEN LEN(LTRIM(RTRIM(CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                FROM BOMMA
                                WHERE 1=1";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (CREATE_DATE + ' ' + CREATE_TIME > @UpdateDate OR MODI_DATE + ' ' + MODI_TIME > @UpdateDate)", UpdateDate);
                        sql += @" ORDER BY TransferDate, TransferTime";

                        bomDetails = sqlConnection.Query<BomDetail>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //撈取ERP BOM取替代料單身資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(MB001)) BomDetailMtlItemNo, LTRIM(RTRIM(MB002)) BomMtlItemNo
                                , LTRIM(RTRIM(MB003)) SubstituteStatus, LTRIM(RTRIM(MB004)) MtlItemNo
                                , LTRIM(RTRIM(MB005)) Quantity, LTRIM(RTRIM(MB009)) SortNumber, LTRIM(RTRIM(MB010)) Precedence
                                , CASE WHEN LEN(LTRIM(RTRIM(MB006))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(MB006)) as date), 'yyyy-MM-dd') ELSE NULL END EffectiveDate
                                , CASE WHEN LEN(LTRIM(RTRIM(MB007))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(MB007)) as date), 'yyyy-MM-dd') ELSE NULL END ExpirationDate
                                , LTRIM(RTRIM(MB008)) Remark
                                , CASE WHEN LEN(LTRIM(RTRIM(CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                FROM BOMMB
                                WHERE 1=1";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (CREATE_DATE + ' ' + CREATE_TIME > @UpdateDate OR MODI_DATE + ' ' + MODI_TIME > @UpdateDate)", UpdateDate);
                        sql += @" ORDER BY TransferDate, TransferTime";

                        bomSubstitutions = sqlConnection.Query<BomSubstitution>(sql, dynamicParameters).ToList();
                        #endregion
                    }

                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //撈取品號ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId, MtlItemNo
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<MtlItem> resultMtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();

                        bomDetails = bomDetails.Join(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        bomDetails = bomDetails.Join(resultMtlitems, x => x.BomMtlItemNo, y => y.MtlItemNo, (x, y) => { x.BomMtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        bomSubstitutions = bomSubstitutions.Join(resultMtlitems, x => x.BomDetailMtlItemNo, y => y.MtlItemNo, (x, y) => { x.BomDetailMtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        bomSubstitutions = bomSubstitutions.Join(resultMtlitems, x => x.BomMtlItemNo, y => y.MtlItemNo, (x, y) => { x.BomMtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        bomSubstitutions = bomSubstitutions.Join(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).Select(x => x).ToList();
                        #endregion

                        #region //撈取BOM主件ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BomId, a.MtlItemId
                                FROM PDM.BillOfMaterials a
                                INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<BillOfMaterials> resultBillOfMaterials = sqlConnection.Query<BillOfMaterials>(sql, dynamicParameters).ToList();

                        bomDetails = bomDetails.Join(resultBillOfMaterials, x => x.BomMtlItemId, y => y.MtlItemId, (x, y) => { x.BomId = y.BomId; return x; }).ToList();
                        bomSubstitutions = bomSubstitutions.Join(resultBillOfMaterials, x => x.BomMtlItemId, y => y.MtlItemId, (x, y) => { x.BomId = y.BomId; return x; }).ToList();
                        #endregion

                        #region //撈取BOM元件ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BomDetailId, a.BomId, a.MtlItemId
                                FROM PDM.BomDetail a
                                INNER JOIN PDM.BillOfMaterials b ON a.BomId = b.BomId
                                INNER JOIN PDM.MtlItem c ON b.MtlItemId = c.MtlItemId
                                WHERE c.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<BomDetail> resultBomDetails = sqlConnection.Query<BomDetail>(sql, dynamicParameters).ToList();

                        bomDetails = bomDetails.Join(resultBomDetails, x => new { x.BomId, x.MtlItemId }, y => new { y.BomId, y.MtlItemId }, (x, y) => { x.BomDetailId = y.BomDetailId; return x; }).ToList();
                        bomSubstitutions = bomSubstitutions.Join(resultBomDetails, x => new { x.BomId, MtlItemId = x.BomDetailMtlItemId }, y => new { y.BomId, y.MtlItemId }, (x, y) => { x.BomDetailId = y.BomDetailId; return x; }).ToList();
                        #endregion

                        #region //判斷PDM.BomSubstitution是否有資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.SubstitutionId, a.BomDetailId, a.SubstituteStatus, a.MtlItemId, a.SortNumber
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.BomDetail b ON a.BomDetailId = b.BomDetailId
                                INNER JOIN PDM.BillOfMaterials c ON b.BomId = c.BomId
                                INNER JOIN PDM.MtlItem d ON c.MtlItemId = d.MtlItemId
                                WHERE d.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<BomSubstitution> resultBomSubstitutions = sqlConnection.Query<BomSubstitution>(sql, dynamicParameters).ToList();

                        bomSubstitutions = bomSubstitutions.GroupJoin(resultBomSubstitutions, x => new { x.BomDetailId, x.SubstituteStatus, x.SortNumber }, y => new { y.BomDetailId, y.SubstituteStatus, y.SortNumber }, (x, y) => { x.SubstitutionId = y.FirstOrDefault()?.SubstitutionId; return x; }).ToList();
                        #endregion

                        List<BomSubstitution> addBomSubstitutions = bomSubstitutions.Where(x => x.SubstitutionId == null).ToList();
                        List<BomSubstitution> updateBomSubstitutions = bomSubstitutions.Where(x => x.SubstitutionId != null).ToList();

                        #region //新增
                        if (addBomSubstitutions.Count > 0)
                        {
                            addBomSubstitutions
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TransferStatus = "Y";
                                    x.Status = "A";
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO PDM.BomSubstitution (BomDetailId, SubstituteStatus, MtlItemId
                                        , Quantity, SortNumber, Precedence, EffectiveDate, ExpirationDate, Remark
                                        , TransferStatus, TransferDate, [Status]
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@BomDetailId, @SubstituteStatus, @MtlItemId, @Quantity, @SortNumber
                                        , @Precedence, @EffectiveDate, @ExpirationDate, @Remark
                                        , @TransferStatus, @TransferDate, @Status
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, addBomSubstitutions);
                        }
                        #endregion

                        #region //修改
                        if (updateBomSubstitutions.Count > 0)
                        {
                            updateBomSubstitutions
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TransferStatus = "Y";
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"UPDATE PDM.BomSubstitution SET
                                        BomDetailId = @BomDetailId,
                                        SubstituteStatus = @SubstituteStatus,
                                        MtlItemId = @MtlItemId,
                                        Quantity = @Quantity,
                                        SortNumber = @SortNumber,
                                        Precedence = @Precedence,
                                        EffectiveDate = @EffectiveDate,
                                        ExpirationDate = @ExpirationDate,
                                        Remark = @Remark,
                                        TransferStatus = @TransferStatus,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE SubstitutionId = @SubstitutionId";
                            rowsAffected += sqlConnection.Execute(sql, updateBomSubstitutions);
                        }
                        #endregion

                        List<BomDetail> updateBomDetail = bomDetails.Where(x => x.BomDetailId != null).ToList();

                        #region //修改BOM元件 取替代料單頭備註
                        if (updateBomDetail.Count > 0)
                        {
                            updateBomDetail
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"UPDATE PDM.BomDetail SET
                                    SubstitutionRemark = @SubstitutionRemark,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BomDetailId = @BomDetailId";
                            rowsAffected += sqlConnection.Execute(sql, updateBomDetail);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }
            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateConfrimSynchronize -- 品號資料同步(單一) -- Shintokuro 2023.05.10
        //public string UpdateConfrimSynchronize(string MtlItemNo)
        //{
        //    try
        //    {
        //        List<MtlItem> mtlitems = new List<MtlItem>();
        //        List<CustomerMtlItem> customerMtlItems = new List<CustomerMtlItem>();
        //        List<BillOfMaterials> billOfMaterials = new List<BillOfMaterials>();
        //        List<BomDetail> bomDetails = new List<BomDetail>();
        //        List<BomSubstitution> bomSubstitutions = new List<BomSubstitution>();

        //        using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
        //        {
        //            int CompanyId = -1;
        //            string ErpConnectionStrings = "";

        //            using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
        //            {
        //                #region //判斷公司資料是否正確
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
        //                        FROM BAS.Company
        //                        WHERE CompanyId = @CurrentCompany";
        //                dynamicParameters.Add("CurrentCompany", CurrentCompany);

        //                var result = sqlConnection.Query(sql, dynamicParameters);
        //                if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

        //                foreach (var item in result)
        //                {
        //                    CompanyId = Convert.ToInt32(item.CompanyId);
        //                    ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
        //                }
        //                #endregion
        //            }

        //            using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
        //            {
        //                #region //撈取ERP品號資料
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT LTRIM(RTRIM(a.MB001)) MtlItemNo, LTRIM(RTRIM(a.MB002)) MtlItemName, LTRIM(RTRIM(a.MB003)) MtlItemSpec
        //                        , LTRIM(RTRIM(a.MB004)) InventoryUomNo, LTRIM(RTRIM(a.MB155)) PurchaseUomNo
        //                        , LTRIM(RTRIM(a.MB156)) SaleUomNo, LTRIM(RTRIM(a.MB005)) TypeOne, LTRIM(RTRIM(a.MB006)) TypeTwo, LTRIM(RTRIM(a.MB007)) TypeThree
        //                        , LTRIM(RTRIM(a.MB008)) TypeFour, LTRIM(RTRIM(a.MB017)) InventoryNo, LTRIM(RTRIM(a.MB157)) RequisitionInventoryNo
        //                        , LTRIM(RTRIM(a.MB019)) InventoryManagement, LTRIM(RTRIM(a.MB066)) MtlModify, LTRIM(RTRIM(a.MB020)) BondedStore
        //                        , LTRIM(RTRIM(a.MB025)) ItemAttribute, LTRIM(RTRIM(a.MB022)) LotManagement, LTRIM(RTRIM(a.MB043)) MeasureType
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.MB030))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MB030)) as date), 'yyyy-MM-dd') ELSE NULL END EffectiveDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.MB031))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MB031)) as date), 'yyyy-MM-dd') ELSE NULL END ExpirationDate
        //                        , LTRIM(RTRIM(a.MB032)) MainSupplierNo, LTRIM(RTRIM(a.MB044)) OverReceiptManagement
        //                        , LTRIM(RTRIM(a.MB087)) OverDeliveryManagement, LTRIM(RTRIM(a.MB165)) Version
        //                        , LTRIM(RTRIM(a.MB009)) MtlItemDesc, LTRIM(RTRIM(a.MB028)) MtlItemRemark, LTRIM(RTRIM(a.CREATOR)) UserNo
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
        //                        FROM INVMB a
        //                        WHERE 1=1
        //                        AND LTRIM(RTRIM(a.MB001)) NOT IN ('3A12L84N-L1(2)', '3FMHD（GM1557）-PGM', '2A8CAV-D16MR-3.0-LBX-103-M')";
        //                BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MB001 = @MtlItemNo", MtlItemNo);
        //                sql += @" ORDER BY TransferDate, TransferTime";

        //                mtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();
        //                #endregion

        //                #region //撈取ERP客戶品號資料
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT LTRIM(RTRIM(a.MG001)) CustomerNo, LTRIM(RTRIM(a.MG002)) MtlItemNo, LTRIM(RTRIM(a.MG003)) CustomerMtlItemNo
        //                        , LTRIM(RTRIM(a.MG005)) CustomerMtlItemName, LTRIM(RTRIM(a.MG006)) CustomerMtlItemSpec
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
        //                        FROM COPMG a
        //                        WHERE 1=1";
        //                BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MG002 = @MtlItemNo", MtlItemNo);
        //                sql += @" ORDER BY TransferDate, TransferTime";

        //                customerMtlItems = sqlConnection.Query<CustomerMtlItem>(sql, dynamicParameters).ToList();
        //                #endregion

        //                #region //撈取ERP產品結構主件資料
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT LTRIM(RTRIM(a.MC001)) MtlItemNo, LTRIM(RTRIM(a.MC002)) UomNo, LTRIM(RTRIM(a.MC004)) StandardLot
        //                        , LTRIM(RTRIM(a.MC005)) WipPrefix, LTRIM(RTRIM(a.MC006)) ModiPrefix, LTRIM(RTRIM(a.MC007)) ModiNo
        //                        , LTRIM(RTRIM(a.MC008)) ModiSequence, LTRIM(RTRIM(a.MC009)) Version, LTRIM(RTRIM(a.MC010)) Remark
        //                        , LTRIM(RTRIM(a.MC016)) ConfirmStatus, LTRIM(RTRIM(a.MC018)) ConfirmUserNo
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.MC017))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MC017)) as date), 'yyyy-MM-dd') ELSE NULL END ConfirmDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
        //                        FROM BOMMC a
        //                        WHERE 1=1";
        //                BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MC001 = @MtlItemNo", MtlItemNo);
        //                sql += @" ORDER BY TransferDate, TransferTime";

        //                billOfMaterials = sqlConnection.Query<BillOfMaterials>(sql, dynamicParameters).ToList();
        //                #endregion

        //                #region //撈取ERP產品結構元件資料
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT LTRIM(RTRIM(a.MD001)) BomMtlItemNo, LTRIM(RTRIM(a.MD002)) BomSequence, LTRIM(RTRIM(a.MD003)) MtlItemNo
        //                        , LTRIM(RTRIM(a.MD004)) UomNo, LTRIM(RTRIM(a.MD006)) CompositionQuantity, LTRIM(RTRIM(a.MD007)) Base
        //                        , LTRIM(RTRIM(a.MD008)) LossRate, LTRIM(RTRIM(a.MD029)) ReleaseItem
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.MD011))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MD011)) as date), 'yyyy-MM-dd') ELSE NULL END EffectiveDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.MD012))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.MD012)) as date), 'yyyy-MM-dd') ELSE NULL END ExpirationDate
        //                        , LTRIM(RTRIM(a.MD016)) Remark
        //                        , LTRIM(RTRIM(a.MD032)) ConfirmStatus
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
        //                        FROM BOMMD a
        //                        WHERE 1=1";
        //                BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MD001 = @MtlItemNo", MtlItemNo);
        //                sql += @" ORDER BY TransferDate, TransferTime";

        //                bomDetails = sqlConnection.Query<BomDetail>(sql, dynamicParameters).ToList();
        //                #endregion

        //                #region //撈取ERP BOM取替代料單頭資料
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT LTRIM(RTRIM(MA001)) MtlItemNo, LTRIM(RTRIM(MA002)) BomMtlItemNo
        //                        , LTRIM(RTRIM(MA004)) SubstitutionRemark
        //                        , CASE WHEN LEN(LTRIM(RTRIM(CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
        //                        FROM BOMMA
        //                        WHERE 1=1";
        //                BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND MA001 = @MtlItemNo", MtlItemNo);
        //                sql += @" ORDER BY TransferDate, TransferTime";

        //                bomDetails = sqlConnection.Query<BomDetail>(sql, dynamicParameters).ToList();
        //                #endregion

        //                #region //撈取ERP BOM取替代料單身資料
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT LTRIM(RTRIM(MB001)) BomDetailMtlItemNo, LTRIM(RTRIM(MB002)) BomMtlItemNo
        //                        , LTRIM(RTRIM(MB003)) SubstituteStatus, LTRIM(RTRIM(MB004)) MtlItemNo
        //                        , LTRIM(RTRIM(MB005)) Quantity, LTRIM(RTRIM(MB009)) SortNumber, LTRIM(RTRIM(MB010)) Precedence
        //                        , CASE WHEN LEN(LTRIM(RTRIM(MB006))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(MB006)) as date), 'yyyy-MM-dd') ELSE NULL END EffectiveDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(MB007))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(MB007)) as date), 'yyyy-MM-dd') ELSE NULL END ExpirationDate
        //                        , LTRIM(RTRIM(MB008)) Remark
        //                        , CASE WHEN LEN(LTRIM(RTRIM(CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
        //                        , CASE WHEN LEN(LTRIM(RTRIM(CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
        //                        FROM BOMMB
        //                        WHERE 1=1";
        //                BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND MB004 = @MtlItemNo", MtlItemNo);
        //                sql += @" ORDER BY TransferDate, TransferTime";

        //                bomSubstitutions = sqlConnection.Query<BomSubstitution>(sql, dynamicParameters).ToList();
        //                #endregion
        //            }

        //            int rowsAffected = 0;
        //            using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
        //            {
        //                #region //撈取單位ID
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT UomId, UomNo
        //                        FROM PDM.UnitOfMeasure
        //                        WHERE CompanyId = @CompanyId";
        //                dynamicParameters.Add("CompanyId", CompanyId);

        //                List<UnitOfMeasure> resultUoms = sqlConnection.Query<UnitOfMeasure>(sql, dynamicParameters).ToList();

        //                mtlitems = mtlitems.Join(resultUoms, x => x.InventoryUomNo, y => y.UomNo, (x, y) => { x.InventoryUomId = y.UomId; return x; }).ToList();
        //                if (mtlitems.Count() <= 0) throw new SystemException("【品號手動同步】該品號在ERP維護欄位 【庫存單位】有問題,請重新確認!!!");
        //                mtlitems = mtlitems.Join(resultUoms, x => x.PurchaseUomNo, y => y.UomNo, (x, y) => { x.PurchaseUomId = y.UomId; return x; }).ToList();
        //                if (mtlitems.Count() <= 0) throw new SystemException("【品號手動同步】該品號在ERP維護欄位 【採購單位】有問題,請重新確認!!!");
        //                mtlitems = mtlitems.Join(resultUoms, x => x.SaleUomNo, y => y.UomNo, (x, y) => { x.SaleUomId = y.UomId; return x; }).ToList();
        //                if (mtlitems.Count() <= 0) throw new SystemException("【品號手動同步】該品號在ERP維護欄位 【銷售單位】有問題,請重新確認!!!");
        //                #endregion

        //                #region //撈取庫別ID
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT InventoryId, InventoryNo
        //                        FROM SCM.Inventory
        //                        WHERE CompanyId = @CompanyId";
        //                dynamicParameters.Add("CompanyId", CompanyId);

        //                List<Inventory> resultInventories = sqlConnection.Query<Inventory>(sql, dynamicParameters).ToList();

        //                mtlitems = mtlitems.Join(resultInventories, x => x.InventoryNo, y => y.InventoryNo, (x, y) => { x.InventoryId = y.InventoryId; return x; }).ToList();
        //                if (mtlitems.Count() <= 0) throw new SystemException("【品號手動同步】該品號在ERP維護欄位 【主要庫別】有問題,請重新確認!!!");
        //                mtlitems = mtlitems.Join(resultInventories, x => x.RequisitionInventoryNo, y => y.InventoryNo, (x, y) => { x.RequisitionInventoryId = y.InventoryId; return x; }).ToList();
        //                if (mtlitems.Count() <= 0) throw new SystemException("【品號手動同步】該品號在ERP維護欄位 【主要領料庫別】有問題,請重新確認!!!");
        //                #endregion

        //                #region //撈取使用者ID
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT a.UserId, a.UserNo
        //                        FROM BAS.[User] a
        //                        INNER JOIN BAS.Department b on a.DepartmentId = b.DepartmentId
        //                        WHERE b.CompanyId = @CompanyId";
        //                dynamicParameters.Add("CompanyId", CompanyId);

        //                List<User> resultUser = sqlConnection.Query<User>(sql, dynamicParameters).ToList();

        //                mtlitems = mtlitems.GroupJoin(resultUser, x => x.UserNo, y => y.UserNo, (x, y) => { x.CreateBy = y.FirstOrDefault()?.UserId; return x; }).ToList();
        //                #endregion

        //                #region //判斷PDM.MtlItem是否有資料
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT MtlItemId, MtlItemNo
        //                        FROM PDM.MtlItem
        //                        WHERE CompanyId = @CompanyId";
        //                dynamicParameters.Add("CompanyId", CompanyId);

        //                List<MtlItem> resultMtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();

        //                mtlitems = mtlitems.GroupJoin(resultMtlitems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.FirstOrDefault()?.MtlItemId; return x; }).ToList();
        //                #endregion

        //                #region //同步-品號 新增/更新
        //                List<MtlItem> addMtlItems = mtlitems.Where(x => x.MtlItemId == null).ToList();
        //                List<MtlItem> updateMtlItems = mtlitems.Where(x => x.MtlItemId != null).ToList();

        //                #region //新增
        //                if (addMtlItems.Count > 0)
        //                {
        //                    addMtlItems
        //                        .ToList()
        //                        .ForEach(x =>
        //                        {
        //                            x.CompanyId = CompanyId;
        //                            x.TransferStatus = "Y";
        //                            x.Status = "A";
        //                            x.CreateDate = CreateDate;
        //                            x.LastModifiedDate = LastModifiedDate;
        //                            x.CreateBy = x.CreateBy != null ? x.CreateBy : CreateBy;
        //                            x.LastModifiedBy = LastModifiedBy;
        //                        });

        //                    sql = @"INSERT INTO PDM.MtlItem (CompanyId, MtlItemNo, MtlItemName, MtlItemSpec, InventoryUomId
        //                            , PurchaseUomId, SaleUomId, TypeOne, TypeTwo, TypeThree, TypeFour, InventoryId
        //                            , RequisitionInventoryId, InventoryManagement, MtlModify, BondedStore, ItemAttribute, LotManagement
        //                            , MeasureType, EffectiveDate, ExpirationDate, OverReceiptManagement, OverDeliveryManagement
        //                            , Version, MtlItemDesc, MtlItemRemark, TransferStatus, TransferDate, Status
        //                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
        //                            VALUES (@CompanyId, @MtlItemNo, @MtlItemName, @MtlItemSpec, @InventoryUomId
        //                            , @PurchaseUomId, @SaleUomId, @TypeOne, @TypeTwo, @TypeThree, @TypeFour, @InventoryId
        //                            , @RequisitionInventoryId, @InventoryManagement, @MtlModify, @BondedStore, @ItemAttribute, @LotManagement
        //                            , @MeasureType, @EffectiveDate, @ExpirationDate, @OverReceiptManagement, @OverDeliveryManagement
        //                            , @Version, @MtlItemDesc, @MtlItemRemark, @TransferStatus, @TransferDate, @Status
        //                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
        //                    rowsAffected += sqlConnection.Execute(sql, addMtlItems);
        //                }
        //                #endregion

        //                #region //修改
        //                if (updateMtlItems.Count > 0)
        //                {
        //                    updateMtlItems
        //                        .ToList()
        //                        .ForEach(x =>
        //                        {
        //                            x.TransferStatus = "Y";
        //                            x.LastModifiedDate = LastModifiedDate;
        //                            x.LastModifiedBy = LastModifiedBy;
        //                        });

        //                    sql = @"UPDATE PDM.MtlItem SET
        //                            MtlItemName = @MtlItemName,
        //                            MtlItemSpec = @MtlItemSpec,
        //                            InventoryUomId = @InventoryUomId,
        //                            PurchaseUomId = @PurchaseUomId,
        //                            SaleUomId = @SaleUomId,
        //                            TypeOne = @TypeOne,
        //                            TypeTwo = @TypeTwo,
        //                            TypeThree = @TypeThree,
        //                            TypeFour = @TypeFour,
        //                            InventoryId = @InventoryId,
        //                            RequisitionInventoryId = @RequisitionInventoryId,
        //                            InventoryManagement = @InventoryManagement,
        //                            MtlModify = @MtlModify,
        //                            BondedStore = @BondedStore,
        //                            ItemAttribute = @ItemAttribute,
        //                            LotManagement = @LotManagement,
        //                            MeasureType = @MeasureType,
        //                            EffectiveDate = @EffectiveDate,
        //                            ExpirationDate = @ExpirationDate,
        //                            OverReceiptManagement = @OverReceiptManagement,
        //                            OverDeliveryManagement = @OverDeliveryManagement,
        //                            Version = @Version,
        //                            MtlItemDesc = @MtlItemDesc,
        //                            MtlItemRemark = @MtlItemRemark,
        //                            TransferStatus = @TransferStatus,
        //                            LastModifiedDate = @LastModifiedDate,
        //                            LastModifiedBy = @LastModifiedBy
        //                            WHERE MtlItemId = @MtlItemId";
        //                    rowsAffected += sqlConnection.Execute(sql, updateMtlItems);
        //                }
        //                else
        //                {
        //                    //throw new SystemException("沒有可更新的品號,請重新確認");
        //                }
        //                #endregion
        //                #endregion

        //                #region //同步-客戶品號 新增/更新
        //                #region //撈取品號ID
        //                int MtlItemId = -1;

        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT MtlItemId, MtlItemNo
        //                        FROM PDM.MtlItem
        //                        WHERE CompanyId = @CompanyId
        //                        AND MtlItemNo = @MtlItemNo";
        //                dynamicParameters.Add("CompanyId", CompanyId);
        //                dynamicParameters.Add("MtlItemNo", MtlItemNo);
        //                var resultMtlItemId = sqlConnection.Query(sql, dynamicParameters);
        //                foreach (var item in resultMtlItemId)
        //                {
        //                    MtlItemId = item.MtlItemId;
        //                }
        //                List<MtlItem> resultMtlItems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();

        //                customerMtlItems = customerMtlItems.Join(resultMtlItems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).ToList();
        //                #endregion

        //                #region //撈取客戶ID
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT CustomerId, CustomerNo 
        //                        FROM SCM.Customer
        //                        WHERE CompanyId = @CompanyId";
        //                dynamicParameters.Add("CompanyId", CompanyId);

        //                List<Customer> resultCustomers = sqlConnection.Query<Customer>(sql, dynamicParameters).ToList();

        //                customerMtlItems = customerMtlItems.Join(resultCustomers, x => x.CustomerNo, y => y.CustomerNo, (x, y) => { x.CustomerId = y.CustomerId; return x; }).ToList();
        //                #endregion

        //                #region //判斷PDM.CustomerMtlItem是否有資料
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT a.CustomerMtlItemId, a.MtlItemId, a.CustomerId
        //                        FROM PDM.CustomerMtlItem a
        //                        INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
        //                        WHERE b.CompanyId = @CompanyId";
        //                dynamicParameters.Add("CompanyId", CompanyId);

        //                List<CustomerMtlItem> resultCustomerMtlItems = sqlConnection.Query<CustomerMtlItem>(sql, dynamicParameters).ToList();

        //                customerMtlItems = customerMtlItems.GroupJoin(resultCustomerMtlItems, x => new { x.MtlItemId, x.CustomerId }, y => new { y.MtlItemId, y.CustomerId }, (x, y) => { x.CustomerMtlItemId = y.FirstOrDefault()?.CustomerMtlItemId; return x; }).ToList();
        //                #endregion

        //                List<CustomerMtlItem> addCustomerMtlItems = customerMtlItems.Where(x => x.CustomerMtlItemId == null).ToList();
        //                List<CustomerMtlItem> updateCustomerMtlItems = customerMtlItems.Where(x => x.CustomerMtlItemId != null).ToList();

        //                #region //新增
        //                if (addCustomerMtlItems.Count > 0)
        //                {
        //                    addCustomerMtlItems
        //                        .ToList()
        //                        .ForEach(x =>
        //                        {
        //                            x.CreateDate = CreateDate;
        //                            x.LastModifiedDate = LastModifiedDate;
        //                            x.CreateBy = CreateBy;
        //                            x.LastModifiedBy = LastModifiedBy;
        //                        });

        //                    sql = @"INSERT INTO PDM.CustomerMtlItem (MtlItemId, CustomerId, CustomerMtlItemNo, CustomerMtlItemName, CustomerMtlItemSpec
        //                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
        //                            VALUES (@MtlItemId, @CustomerId, @CustomerMtlItemNo, @CustomerMtlItemName, @CustomerMtlItemSpec
        //                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
        //                    rowsAffected += sqlConnection.Execute(sql, addCustomerMtlItems);
        //                }
        //                #endregion

        //                #region //修改
        //                if (updateCustomerMtlItems.Count > 0)
        //                {
        //                    updateMtlItems
        //                        .ToList()
        //                        .ForEach(x =>
        //                        {
        //                            x.LastModifiedDate = LastModifiedDate;
        //                            x.LastModifiedBy = LastModifiedBy;
        //                        });

        //                    sql = @"UPDATE PDM.CustomerMtlItem SET
        //                            CustomerMtlItemNo = @CustomerMtlItemNo,
        //                            CustomerMtlItemName = @CustomerMtlItemName,
        //                            CustomerMtlItemSpec = @CustomerMtlItemSpec,
        //                            LastModifiedDate = @LastModifiedDate,
        //                            LastModifiedBy = @LastModifiedBy
        //                            WHERE CustomerMtlItemId = @CustomerMtlItemId";
        //                    rowsAffected += sqlConnection.Execute(sql, updateCustomerMtlItems);
        //                }
        //                #endregion
        //                #endregion

        //                #region //同步-BOM資料
        //                #region //判斷PDM.BillOfMaterials是否有資料
        //                string UomNo = "";
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT a.BomId, a.MtlItemId,b.MtlItemNo
        //                        FROM PDM.BillOfMaterials a
        //                        INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
        //                        WHERE b.CompanyId = @CompanyId";
        //                dynamicParameters.Add("CompanyId", CompanyId);

        //                List<BillOfMaterials> resultBillOfMaterials = sqlConnection.Query<BillOfMaterials>(sql, dynamicParameters).ToList();

        //                billOfMaterials = billOfMaterials.GroupJoin(resultBillOfMaterials, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.BomId = y.FirstOrDefault()?.BomId; return x; }).ToList();
        //                foreach (var item in billOfMaterials)
        //                {
        //                    UomNo = item.UomNo;
        //                }
        //                #endregion

        //                #region //撈取單位ID
        //                int UomId = -1;
        //                dynamicParameters = new DynamicParameters();
        //                sql = @"SELECT UomId, UomNo
        //                        FROM PDM.UnitOfMeasure
        //                        WHERE UomNo = @UomNo
        //                        AND CompanyId = @CompanyId";
        //                dynamicParameters.Add("UomNo", UomNo);
        //                dynamicParameters.Add("CompanyId", CompanyId);
        //                var resultUomId = sqlConnection.Query(sql, dynamicParameters);
        //                foreach (var item in resultUomId)
        //                {
        //                    UomId = item.UomId;
        //                }
        //                #endregion

        //                #region //BOM主件 新增/更新
        //                List<BillOfMaterials> addBillOfMaterials = billOfMaterials.Where(x => x.BomId == null).ToList();
        //                List<BillOfMaterials> updateBillOfMaterials = billOfMaterials.Where(x => x.BomId != null).ToList();

        //                #region //新增
        //                if (addBillOfMaterials.Count > 0)
        //                {
        //                    addBillOfMaterials
        //                        .ToList()
        //                        .ForEach(x =>
        //                        {
        //                            x.MtlItemId = MtlItemId;
        //                            x.UomId = UomId;
        //                            x.TransferStatus = "Y";
        //                            x.Status = "A";
        //                            x.CreateDate = CreateDate;
        //                            x.LastModifiedDate = LastModifiedDate;
        //                            x.CreateBy = CreateBy;
        //                            x.LastModifiedBy = LastModifiedBy;
        //                        });

        //                    sql = @"INSERT INTO PDM.BillOfMaterials (MtlItemId, UomId, StandardLot, WipPrefix, ModiPrefix
        //                            , ModiNo, ModiSequence, Version, Remark, ConfirmStatus, ConfirmUserId, ConfirmDate
        //                            , TransferStatus, TransferDate, Status
        //                            , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
        //                            VALUES (@MtlItemId, @UomId, @StandardLot, @WipPrefix, @ModiPrefix
        //                            , @ModiNo, @ModiSequence, @Version, @Remark, @ConfirmStatus, @ConfirmUserId, @ConfirmDate
        //                            , @TransferStatus, @TransferDate, @Status
        //                            , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
        //                    rowsAffected += sqlConnection.Execute(sql, addBillOfMaterials);
        //                }
        //                #endregion

        //                #region //修改
        //                if (updateBillOfMaterials.Count > 0)
        //                {
        //                    updateBillOfMaterials
        //                        .ToList()
        //                        .ForEach(x =>
        //                        {
        //                            x.UomId = UomId;
        //                            x.TransferStatus = "Y";
        //                            x.LastModifiedDate = LastModifiedDate;
        //                            x.LastModifiedBy = LastModifiedBy;
        //                        });
        //                    sql = @"UPDATE PDM.BillOfMaterials SET
        //                            UomId = @UomId,
        //                            StandardLot = @StandardLot,
        //                            WipPrefix = @WipPrefix,
        //                            ModiPrefix = @ModiPrefix,
        //                            ModiNo = @ModiNo,
        //                            ModiSequence = @ModiSequence,
        //                            Version = @Version,
        //                            Remark = @Remark,
        //                            ConfirmStatus = @ConfirmStatus,
        //                            ConfirmUserId = @ConfirmUserId,
        //                            ConfirmDate = @ConfirmDate,
        //                            TransferStatus = @TransferStatus,
        //                            LastModifiedDate = @LastModifiedDate,
        //                            LastModifiedBy = @LastModifiedBy
        //                            WHERE BomId = @BomId";
        //                    rowsAffected += sqlConnection.Execute(sql, updateBillOfMaterials);
        //                }
        //                #endregion
        //                #endregion

        //                #endregion


        //                #region //同步-BOM取替代料資料
        //                #endregion

        //                #region //Response
        //                jsonResponse = JObject.FromObject(new
        //                {
        //                    status = "success",
        //                    msg = "(" + rowsAffected + " rows affected)"
        //                });
        //                #endregion
        //            }

        //            //int testNum = 99;
        //            //if(testNum == 99) throw new SystemException("快樂測試中~~");

        //            transactionScope.Complete();
        //        }
        //    }
        //    catch (Exception e)
        //    {
        //        #region //Response
        //        jsonResponse = JObject.FromObject(new
        //        {
        //            status = "errorForDA",
        //            msg = e.Message
        //        });
        //        #endregion

        //        logger.Error(e.Message);
        //    }

        //    return jsonResponse.ToString();
        //}
        #endregion

        #region //UpdateMtlItemUomCalculateSynchronize -- 品號單位換算資料同步 -- Shintokuro 2023.06.16
        public string UpdateMtlItemUomCalculateSynchronize(string Company, string UpdateDate)
        {
            try
            {
                List<MtlItemUomCalculate> mtlItemUomCalculate = new List<MtlItemUomCalculate>();
                List<MtlItemUomCalculate> mtlItemUomCalculateAll = new List<MtlItemUomCalculate>();

                DateTime date = DateTime.Parse(UpdateDate);

                UpdateDate = date.AddDays(-2).ToString("yyyyMMdd HH:mm:ss");

                if (Company.Length <= 0) throw new SystemException("【公司】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
                {
                    int CompanyId = -1;
                    string ErpConnectionStrings = "";
                    string ErpNo = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, ErpDb, ErpNo
                                FROM BAS.Company
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", Company);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpNo = item.ErpNo;
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //ERP公司代碼取得
                        string CompanyNoErp = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ML001  
                                FROM CMSML";
                        var resultCompanyNo = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultCompanyNo)
                        {
                            CompanyNoErp = item.ML001;
                        }
                        if (ErpNo != CompanyNoErp) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                        #endregion

                        #region //撈取ERP品號單位換算資料(有更新)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MD001)) MtlItemNo, LTRIM(RTRIM(a.MD002)) ConvertUomNo, LTRIM(RTRIM(a.MD003)) SwapNumerator
                                , LTRIM(RTRIM(a.MD004)) SwapDenominator
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                , LTRIM(RTRIM(b.MB004))  UomNo
                                FROM INVMD a
                                INNER JOIN INVMB b on a.MD001 = b.MB001
                                WHERE 1=1";
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + a.CREATE_TIME > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                        sql += @" ORDER BY ConvertUomNo";

                        mtlItemUomCalculate = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //撈取ERP品號單位換算資料(全部)
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MD001)) MtlItemNo, LTRIM(RTRIM(a.MD002)) ConvertUomNo, LTRIM(RTRIM(a.MD003)) SwapNumerator
                                , LTRIM(RTRIM(a.MD004)) SwapDenominator
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_DATE))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_DATE)) as date), 'yyyy-MM-dd') ELSE NULL END TransferDate
                                , CASE WHEN LEN(LTRIM(RTRIM(a.CREATE_TIME))) > 0 THEN FORMAT(CAST(LTRIM(RTRIM(a.CREATE_TIME)) as datetime), 'HH:mm:ss') ELSE NULL END TransferTime
                                , LTRIM(RTRIM(b.MB004))  UomNo
                                FROM INVMD a
                                INNER JOIN INVMB b on a.MD001 = b.MB001
                                WHERE 1=1";
                        sql += @" ORDER BY ConvertUomNo";

                        mtlItemUomCalculateAll = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                        if (mtlItemUomCalculateAll.Count() <= 0) throw new SystemException("找不到ERP品號單位換算資料!");
                        #endregion
                    }

                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //品號單位換算 新增/更新
                        #region //撈取品號ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MtlItemId, MtlItemNo
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<MtlItem> resultMtlItems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();
                        mtlItemUomCalculate = mtlItemUomCalculate.Join(resultMtlItems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).ToList();
                        mtlItemUomCalculateAll = mtlItemUomCalculateAll.Join(resultMtlItems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.MtlItemId; return x; }).ToList();
                        #endregion

                        #region //撈取單位ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT UomId,UomNo
                                FROM PDM.UnitOfMeasure a
                                WHERE a.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<UnitOfMeasure> resultUnitOfMeasure = sqlConnection.Query<UnitOfMeasure>(sql, dynamicParameters).ToList();
                        mtlItemUomCalculate = mtlItemUomCalculate.Join(resultUnitOfMeasure, x => x.UomNo, y => y.UomNo, (x, y) => { x.UomId = y.UomId; return x; }).ToList();
                        mtlItemUomCalculate = mtlItemUomCalculate.Join(resultUnitOfMeasure, x => x.ConvertUomNo, y => y.UomNo, (x, y) => { x.ConvertUomId = y.UomId; return x; }).ToList();
                        mtlItemUomCalculateAll = mtlItemUomCalculateAll.Join(resultUnitOfMeasure, x => x.UomNo, y => y.UomNo, (x, y) => { x.UomId = y.UomId; return x; }).ToList();
                        mtlItemUomCalculateAll = mtlItemUomCalculateAll.Join(resultUnitOfMeasure, x => x.ConvertUomNo, y => y.UomNo, (x, y) => { x.ConvertUomId = y.UomId; return x; }).ToList();
                        #endregion

                        #region //撈取品號單位換算ID
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemUomCalculateId,a.MtlItemId,a.UomId,a.ConvertUomId,a.SwapDenominator,a.SwapNumerator
                                FROM PDM.MtlItemUomCalculate a
                                INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);

                        List<MtlItemUomCalculate> resultMtlItemUomCalculate = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                        mtlItemUomCalculate = mtlItemUomCalculate.GroupJoin(resultMtlItemUomCalculate,
                            outer => new { Key1 = outer.MtlItemId, Key2 = outer.ConvertUomId },
                            inner => new { Key1 = inner.MtlItemId, Key2 = inner.ConvertUomId }
                            , (x, y) => { x.MtlItemUomCalculateId = y.FirstOrDefault()?.MtlItemUomCalculateId; return x; }).ToList();
                        mtlItemUomCalculateAll = mtlItemUomCalculateAll.GroupJoin(resultMtlItemUomCalculate,
                            outer => new { Key1 = outer.MtlItemId, Key2 = outer.ConvertUomId },
                            inner => new { Key1 = inner.MtlItemId, Key2 = inner.ConvertUomId }
                            , (x, y) => { x.MtlItemUomCalculateId = y.FirstOrDefault()?.MtlItemUomCalculateId; return x; }).ToList();
                        #endregion


                        #region //MES資料比對ERP資料,沒有MtlItemUomCalculateId 代表ERP沒有資料後續要刪除
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemUomCalculateId,a.MtlItemId,a.UomId,a.ConvertUomId,a.SwapDenominator,a.SwapNumerator,a.TransferStatus
                                FROM PDM.MtlItemUomCalculate a
                                INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CompanyId);
                        List<MtlItemUomCalculate> resultMtlItemUomCalculateToDay = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                        resultMtlItemUomCalculateToDay = resultMtlItemUomCalculateToDay.GroupJoin(mtlItemUomCalculateAll,
                                                    outer => new { Key1 = outer.MtlItemId, Key2 = outer.ConvertUomId },
                                                    inner => new { Key1 = inner.MtlItemId, Key2 = inner.ConvertUomId }
                                                    , (x, y) => { x.MtlItemUomCalculateId = y.FirstOrDefault()?.MtlItemUomCalculateId; return x; }).ToList();
                        #endregion

                        List<MtlItemUomCalculate> addMtlItemUomCalculate = mtlItemUomCalculate.Where(x => x.MtlItemUomCalculateId == null).ToList();
                        List<MtlItemUomCalculate> updateMtlItemUomCalculate = mtlItemUomCalculate.Where(x => x.MtlItemUomCalculateId != null).ToList();
                        List<MtlItemUomCalculate> deleteMtlItemUomCalculate = resultMtlItemUomCalculateToDay.Where(x => x.MtlItemUomCalculateId == null && x.TransferStatus == "Y").ToList();
                        //deleteMtlItemUomCalculate = deleteMtlItemUomCalculate.Where(x => x.TransferStatus == "Y").ToList();

                        #region //新增
                        if (addMtlItemUomCalculate.Count > 0)
                        {
                            addMtlItemUomCalculate
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TransferStatus = "Y";
                                    x.TransferDate = CreateDate;
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO PDM.MtlItemUomCalculate (MtlItemId, UomId, ConvertUomId, SwapDenominator, SwapNumerator, TransferStatus, TransferDate
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.MtlItemUomCalculateId
                                    VALUES (@MtlItemId, @UomId, @ConvertUomId, @SwapDenominator, @SwapNumerator, @TransferStatus, @TransferDate
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, addMtlItemUomCalculate);
                            foreach (var item in addMtlItemUomCalculate)
                            {
                                #region //資料撈取
                                List<MtlItemUomCalculate> mtlItemUomCalculateAdd = new List<MtlItemUomCalculate>();

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomId, SwapDenominator, SwapNumerator, TransferStatus, 
                                    TransferDate
                                    FROM PDM.MtlItemUomCalculate
                                    WHERE MtlItemId = @MtlItemId
                                    AND ConvertUomId = @ConvertUomId";
                                dynamicParameters.Add("MtlItemId", item.MtlItemId);
                                dynamicParameters.Add("ConvertUomId", item.ConvertUomId);
                                var result = sqlConnection.Query(sql, dynamicParameters);
                                mtlItemUomCalculateAdd = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();

                                if (result.Count() <= 0) throw new SystemException("【品號單位換算】－品號單位換算資料不存在,請重新確認!");
                                #endregion

                                #region //資料新增(log)
                                if (mtlItemUomCalculateAdd.Count > 0)
                                {
                                    mtlItemUomCalculateAdd
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.TransactionType = "SA";
                                            x.TransactionUserId = CurrentUser;
                                            x.TransactionDate = CreateDate;
                                            x.CreateDate = CreateDate;
                                            x.LastModifiedDate = LastModifiedDate;
                                            x.CreateBy = CreateBy;
                                            x.LastModifiedBy = LastModifiedBy;
                                        });

                                    sql = @"INSERT INTO PDM.MtlItemUomCalculateLog (TransactionType, MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomIdBefore, 
                                            SwapDenominatorBefore, SwapNumeratorBefore, ConvertUomId, SwapDenominator, SwapNumerator, TransactionUserId, 
                                            TransactionDate, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            VALUES (@TransactionType, @MtlItemUomCalculateId, @MtlItemId, @UomId, @ConvertUomIdBefore,
                                            @SwapDenominatorBefore, @SwapNumeratorBefore, @ConvertUomId, @SwapDenominator, @SwapNumerator, @TransactionUserId,
                                            @TransactionDate, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    rowsAffected += sqlConnection.Execute(sql, mtlItemUomCalculateAdd);
                                }
                                #endregion
                            }
                        }
                        #endregion

                        #region //修改
                        if (updateMtlItemUomCalculate.Count > 0)
                        {
                            string MtlItemUomCalculateStr = "";
                            int num = 0;
                            foreach (var item in updateMtlItemUomCalculate)
                            {
                                if (num == 0)
                                {
                                    MtlItemUomCalculateStr += item.MtlItemUomCalculateId;
                                }
                                else
                                {
                                    MtlItemUomCalculateStr += "," + item.MtlItemUomCalculateId;
                                }
                                num++;
                            }
                            #region //資料撈取 更新之前
                            List<MtlItemUomCalculate> mtlItemUomCalculateUpdate = new List<MtlItemUomCalculate>();

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemUomCalculateId, MtlItemId, TransferStatus, TransferDate,
                                    ConvertUomId ConvertUomIdBefore, SwapDenominator SwapDenominatorBefore, SwapNumerator SwapNumeratorBefore
                                    FROM PDM.MtlItemUomCalculate
                                    WHERE MtlItemUomCalculateId in  @MtlItemUomCalculateId ";
                            dynamicParameters.Add("MtlItemUomCalculateId", MtlItemUomCalculateStr.Split(','));
                            mtlItemUomCalculateUpdate = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                            #endregion


                            updateMtlItemUomCalculate
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.LastModifiedBy = LastModifiedBy;
                                });
                            sql = @"UPDATE PDM.MtlItemUomCalculate SET
                                    MtlItemId = @MtlItemId,
                                    UomId = @UomId,
                                    ConvertUomId = @ConvertUomId,
                                    SwapDenominator = @SwapDenominator,
                                    SwapNumerator = @SwapNumerator,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MtlItemUomCalculateId = @MtlItemUomCalculateId";
                            rowsAffected += sqlConnection.Execute(sql, updateMtlItemUomCalculate);

                            #region //資料撈取 更新之前
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemUomCalculateId, ConvertUomId, SwapDenominator, SwapNumerator
                                    FROM PDM.MtlItemUomCalculate
                                    WHERE MtlItemUomCalculateId in  @MtlItemUomCalculateId ";
                            dynamicParameters.Add("MtlItemUomCalculateId", MtlItemUomCalculateStr.Split(','));
                            var resultCompanyNo1 = sqlConnection.Query(sql, dynamicParameters);
                            mtlItemUomCalculateUpdate = mtlItemUomCalculateUpdate.Join(resultCompanyNo1, x => x.MtlItemUomCalculateId, y => y.MtlItemUomCalculateId, (x, y) => { x.ConvertUomId = y.ConvertUomId; return x; }).ToList();
                            mtlItemUomCalculateUpdate = mtlItemUomCalculateUpdate.Join(resultCompanyNo1, x => x.MtlItemUomCalculateId, y => y.MtlItemUomCalculateId, (x, y) => { x.SwapDenominator = y.SwapDenominator; return x; }).ToList();
                            mtlItemUomCalculateUpdate = mtlItemUomCalculateUpdate.Join(resultCompanyNo1, x => x.MtlItemUomCalculateId, y => y.MtlItemUomCalculateId, (x, y) => { x.SwapNumerator = y.SwapNumerator; return x; }).ToList();
                            mtlItemUomCalculateUpdate = mtlItemUomCalculateUpdate.Where(x => x.ConvertUomIdBefore != x.ConvertUomId || x.SwapDenominatorBefore != x.SwapDenominator || x.SwapNumeratorBefore != x.SwapNumerator).ToList();

                            #region //資料新增(log)
                            if (mtlItemUomCalculateUpdate.Count > 0)
                            {
                                mtlItemUomCalculateUpdate
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.TransactionType = "SU";
                                        x.TransactionUserId = CurrentUser;
                                        x.TransactionDate = CreateDate;
                                        x.CreateDate = CreateDate;
                                        x.LastModifiedDate = LastModifiedDate;
                                        x.CreateBy = CreateBy;
                                        x.LastModifiedBy = LastModifiedBy;
                                    });

                                sql = @"INSERT INTO PDM.MtlItemUomCalculateLog (TransactionType, MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomIdBefore, 
                                            SwapDenominatorBefore, SwapNumeratorBefore, ConvertUomId, SwapDenominator, SwapNumerator, TransactionUserId, 
                                            TransactionDate, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            VALUES (@TransactionType, @MtlItemUomCalculateId, @MtlItemId, @UomId, @ConvertUomIdBefore,
                                            @SwapDenominatorBefore, @SwapNumeratorBefore, @ConvertUomId, @SwapDenominator, @SwapNumerator, @TransactionUserId,
                                            @TransactionDate, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                rowsAffected += sqlConnection.Execute(sql, mtlItemUomCalculateUpdate);
                            }
                            #endregion
                            #endregion
                        }
                        #endregion

                        #region //刪除品號單位換算資料
                        if (deleteMtlItemUomCalculate.Count > 0)
                        {
                            foreach (var item in deleteMtlItemUomCalculate)
                            {

                                #region //判斷品號單位換算資料是否正確
                                List<MtlItemUomCalculate> mtlItemUomCalculateDelte = new List<MtlItemUomCalculate>();
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 SwapDenominator, SwapNumerator, TransferStatus, TransferDate,
                                        MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomId
                                        FROM PDM.MtlItemUomCalculate
                                        WHERE MtlItemId = @MtlItemId
                                        AND ConvertUomId = @ConvertUomId";
                                dynamicParameters.Add("MtlItemId", item.MtlItemId);
                                dynamicParameters.Add("ConvertUomId", item.ConvertUomId);
                                mtlItemUomCalculateDelte = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                                #endregion

                                dynamicParameters = new DynamicParameters();
                                sql = @"DELETE PDM.MtlItemUomCalculate
                                        WHERE MtlItemId = @MtlItemId
                                        AND ConvertUomId = @ConvertUomId";
                                dynamicParameters.Add("MtlItemId", item.MtlItemId);
                                dynamicParameters.Add("ConvertUomId", item.ConvertUomId);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                                #region //資料新增(log)
                                if (mtlItemUomCalculateDelte.Count > 0)
                                {
                                    mtlItemUomCalculateDelte
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.TransactionType = "SD";
                                            x.TransactionUserId = CurrentUser;
                                            x.TransactionDate = CreateDate;
                                            x.CreateDate = CreateDate;
                                            x.LastModifiedDate = LastModifiedDate;
                                            x.CreateBy = CreateBy;
                                            x.LastModifiedBy = LastModifiedBy;
                                        });

                                    sql = @"INSERT INTO PDM.MtlItemUomCalculateLog (TransactionType, MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomIdBefore, 
                                            SwapDenominatorBefore, SwapNumeratorBefore, ConvertUomId, SwapDenominator, SwapNumerator, TransactionUserId, 
                                            TransactionDate, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                            VALUES (@TransactionType, @MtlItemUomCalculateId, @MtlItemId, @UomId, @ConvertUomIdBefore,
                                            @SwapDenominatorBefore, @SwapNumeratorBefore, @ConvertUomId, @SwapDenominator, @SwapNumerator, @TransactionUserId,
                                            @TransactionDate, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                    rowsAffected += sqlConnection.Execute(sql, mtlItemUomCalculateDelte);
                                }
                                #endregion
                            }
                        }

                        #endregion
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlItem -- 品號資料更新 -- Zoey 2022.10.13
        public string UpdateMtlItem(int MtlItemId, string MtlItemNo, string MtlItemName, string MtlItemSpec, int InventoryUomId, int PurchaseUomId, int SaleUomId
            , string TypeOne, string TypeTwo, string TypeThree, string TypeFour, int InventoryId, int RequisitionInventoryId, string InventoryManagement, string MtlModify
            , string BondedStore, string ItemAttribute, string LotManagement, string MeasureType, string OverReceiptManagement, string OverDeliveryManagement, string EffectiveDate
            , string ExpirationDate, string MtlItemDesc, string MtlItemRemark, string CustomerMtlItems, int EfficientDays, int RetestDays, string ProductionLine
            , int ItemTypeId, string ItemTypeSegmentList, string ItemTypeEnable, string ReplenishmentPolicy)
        {
            try
            {
                if (MtlItemNo.Length <= 0) throw new SystemException("【品號】不能為空!");
                if (MtlItemNo.Length > 40) throw new SystemException("【品號】長度錯誤!");
                if (MtlItemName.Length <= 0) throw new SystemException("【品名】不能為空!");
                if (MtlItemName.Length > 120) throw new SystemException("【品名】長度錯誤!");
                if (MtlItemSpec.Length <= 0) throw new SystemException("【規格】不能為空!");
                if (MtlItemSpec.Length > 120) throw new SystemException("【規格】長度錯誤!");
                if (TypeOne.Length <= 0) throw new SystemException("【品號分類(一)】不能為空!");
                if (TypeTwo.Length <= 0) throw new SystemException("【品號分類(二)】不能為空!");
                if (TypeThree.Length <= 0) throw new SystemException("【品號分類(三)】不能為空!");
                if (TypeFour.Length <= 0) throw new SystemException("【品號分類(四)】不能為空!");
                if (ItemAttribute.Length <= 0) throw new SystemException("【品號屬性】不能為空!");
                if (LotManagement.Length <= 0) throw new SystemException("【批號管理】不能為空!");
                if (MeasureType.Length <= 0) throw new SystemException("【檢驗方式】不能為空!");
                if (ReplenishmentPolicy.Length <= 0) throw new SystemException("【補貨政策】不能為空!");

                #region //品號檢核
                if (MtlItemNo.Length <= 0) throw new SystemException("【品號】不可為空");
                if (string.IsNullOrWhiteSpace(MtlItemNo)) throw new SystemException("【品號】不可為空");
                if (string.IsNullOrEmpty(MtlItemNo)) throw new SystemException("【品號】不可為空");

                //24.01.17 加入(是否包含小寫字母)判斷
                if (Regex.IsMatch(MtlItemNo, @"[a-z]"))
                    throw new SystemException("【品號】不可包含小寫字母");

                //24.01.05 加入(有無寬度的空白字元)判斷
                if (Regex.IsMatch(MtlItemNo, @"[\s\u0009-\u000D\u0020\u0085\u00A0\u1680\u2000-\u200A\u2028-\u2029\u202F\u205F\u3000\u180E\u200B-\u200D\u2060\uFEFF\u00B7\u237D\u2420\u2422\u2423]"))
                    throw new SystemException("【品號】不可為空");

                //24.01.05 加入(全形數字 大寫英文 小寫英文)判斷
                if (Regex.IsMatch(MtlItemNo, @"[\uFF10-\uFF19\uFF41-\uFF5A\uFF21-\uFF3A]"))
                    throw new SystemException("【品號】不能包含全形英文及數字!");

                //MtlItemNo是否包含繁簡體中文
                if (Regex.IsMatch(MtlItemNo, @"\p{IsCJKUnifiedIdeographs}") == true)
                    throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");
                if (Regex.IsMatch(MtlItemNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]"))
                    throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");

                MtlItemNo = MtlItemNo.Trim().ToUpper();
                #endregion

                //if (!CustomerMtlItems.TryParseJson(out JObject tempJObject)) throw new SystemException("客戶品號資料格式錯誤");

                //JObject custMtlyJson = JObject.Parse(CustomerMtlItems);
                //if (!custMtlyJson.ContainsKey("data")) throw new SystemException("客戶品號資料錯誤");

                //JToken custMtlData = custMtlyJson["data"];

                //List<CustomerMtlItem> customerMtlItem = new List<CustomerMtlItem>();

                //for (int i = 0; i < custMtlData.Count(); i++)
                //{
                //    customerMtlItem.Add(
                //        new CustomerMtlItem
                //        {
                //            CustomerId = Convert.ToInt32(custMtlData[i]["customerId"]),
                //            CustomerMtlItemNo = custMtlData[i]["customerMtlItemNo"].ToString(),
                //            CustomerMtlItemName = custMtlData[i]["customerMtlItemName"].ToString(),
                //            CustomerMtlItemSpec = custMtlData[i]["customerMtlItemSpec"].ToString()
                //        });
                //}


                List<int> MtlItemSegmentIdList = new List<int>();
                List<int> TemporaryList = new List<int>();
                var ItemTypeSegmentJson = ItemTypeSegmentList.Split(',');
                string haveSequence = "N";
                string Sequence = "";
                string SequenceSort = "";
                string MtlItemNoLast = "";
                string SegmentValueS = "";

                int ItemTypeIdBase = 0;
                int maxSequence = 0;
                int SequenceNum = 0; //幾位數
                string SuffixCode = "N";
                int MtlItemLenght = MtlItemNo.Length;
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string TransferStatus = "";

                        #region //判斷品號資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 TransferStatus,ISNULL(ItemTypeId, 0) ItemTypeId
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號資料錯誤!");
                        foreach (var item in result)
                        {
                            TransferStatus = item.TransferStatus;
                            ItemTypeIdBase = item.ItemTypeId;
                        }
                        #endregion

                        if (TransferStatus != "Y")
                        {
                            if (ItemTypeIdBase <= 0)
                            {
                                #region //品號編碼相關設定
                                if (ItemTypeEnable == "Y")
                                {

                                    #region //基本判斷
                                    #region //判定品號類別是否存在
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1 FROM PDM.ItemType
                                    WHERE ItemTypeId = @ItemTypeId";
                                    dynamicParameters.Add("ItemTypeId", ItemTypeId);

                                    var resultItemType = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultItemType.Count() <= 0) throw new SystemException("【品號管理】- 品號類別不存在,請重新確認");
                                    #endregion

                                    #region //撈取品號結構設定
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1 FROM PDM.ItemTypeSegment
                                    WHERE ItemTypeId = @ItemTypeId";
                                    dynamicParameters.Add("ItemTypeId", ItemTypeId);

                                    var resultItemType1 = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultItemType1.Count() <= 0) throw new SystemException("【品號管理】- 品號類別結構無資料,請重新確認");
                                    #endregion

                                    #region //撈取品號結構流水碼設定是否有後綴
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT SuffixCode FROM PDM.ItemTypeSegment
                                    WHERE ItemTypeId = @ItemTypeId
                                    AND SegmentType = 'S'";
                                    dynamicParameters.Add("ItemTypeId", ItemTypeId);

                                    resultItemType1 = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultItemType1.Count() > 0)
                                    {
                                        foreach (var item in resultItemType1)
                                        {
                                            SuffixCode = item.SuffixCode;

                                        }
                                    }
                                    #endregion
                                    #endregion

                                    #region //判斷品號編碼是否有流水號設定+自定義的是否符合設定
                                    foreach (var item in ItemTypeSegmentJson) //品號結構解析
                                    {
                                        var StructureType = item.Split('❤')[0];
                                        var StructureSort = item.Split('❤')[1];
                                        var StructureSet = item.Split('❤')[2];
                                        var StructureSave = item.Split('❤')[3];
                                        var StructureCustomNum = item.Split('❤')[4];

                                        if (StructureType == "S") //流水號設定
                                        {
                                            haveSequence = "Y";
                                            Sequence = StructureSave;
                                            SequenceSort = StructureSort; //流水號的位置
                                        }
                                        if (StructureType == "C") //自訂義設定
                                        {
                                            if (StructureSave.Substring(StructureSave.Length - 1, 1) == "-")
                                            {
                                                if (StructureSave.Length - 1 != Convert.ToInt32(StructureCustomNum)) throw new SystemException("【品號管理】- 【自訂義編碼】須補滿" + StructureSet + "字元!!!!!!");

                                            }
                                            else
                                            {
                                                if (StructureSave.Length != Convert.ToInt32(StructureCustomNum)) throw new SystemException("【品號管理】- 【自訂義編碼】須補滿" + StructureSet + "字元!!!!!!");

                                            }
                                        }
                                        if (StructureType == "SV") //編碼節段設定
                                        {
                                            if (StructureSet == "") throw new SystemException("【品號管理】- 【編碼節段】未選取請重新確認!!!");
                                        }
                                    }
                                    #endregion

                                    if (haveSequence == "Y") //有流水號就要找出其最大值
                                    {
                                        int num = 0;

                                        #region //撈取該組合目前最大值
                                        var testNo = MtlItemNo;
                                        char charToCount = '?';

                                        int SequenceNum1 = MtlItemNo.Count(c => c == charToCount);
                                        string Qmark = "";
                                        string direction = "One";
                                        for (var i = 0; i < SequenceNum1; i++)
                                        {
                                            Qmark += "?";
                                        }
                                        int Noplace = testNo.IndexOf(Qmark);
                                        int NoLong = testNo.Length - SequenceNum1;
                                        string[] splitStr = { Qmark }; //自行設定切割字串

                                        var StrBefore = testNo.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[0];
                                        var StrAfter = "";
                                        if (Noplace > 0 || Noplace == NoLong)
                                        {
                                            if (SuffixCode == "Y")
                                            {
                                                StrAfter = testNo.Split(splitStr, StringSplitOptions.RemoveEmptyEntries)[1];
                                                direction = "Two";
                                            }
                                        }
                                        dynamicParameters = new DynamicParameters();

                                        switch (direction)
                                        {
                                            case "Two":
                                                sql = @"SELECT MAX(REPLACE(REPLACE(MtlItemNo, @StrBefore, ''), @StrAfter, '')) maxSequence
                                                    FROM PDM.MtlItem
                                                    WHERE MtlItemNo LIKE @StrBefore +'%'
                                                    AND  MtlItemNo LIKE + '%' + @StrAfter
                                                    AND MtlItemNo NOT LIKE '%(複製)%'
                                                    AND LEN(MtlItemNo) = @MtlItemLenght
                                                    AND MtlItemId != @MtlItemId
                                                    ";
                                                dynamicParameters.Add("StrBefore", StrBefore);
                                                dynamicParameters.Add("StrAfter", StrAfter);
                                                dynamicParameters.Add("MtlItemLenght", MtlItemLenght);
                                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                                var resultMaxSequence2 = sqlConnection.Query(sql, dynamicParameters);
                                                foreach (var item in resultMaxSequence2)
                                                {
                                                    maxSequence = Convert.ToInt32(item.maxSequence);
                                                }
                                                break;
                                            case "One":
                                                sql = @"SELECT MAX(REPLACE(MtlItemNo, @StrBefore, '')) maxSequence
                                                        FROM PDM.MtlItem
                                                        WHERE 1=1
                                                        AND MtlItemNo NOT LIKE '%(複製)%'
                                                        AND LEN(MtlItemNo) = @MtlItemLenght
                                                        AND MtlItemId != @MtlItemId
                                                        ";
                                                dynamicParameters.Add("StrBefore", StrBefore);
                                                dynamicParameters.Add("MtlItemLenght", MtlItemLenght);
                                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                                if (Noplace == 0)
                                                {
                                                    sql += " AND MtlItemNo LIKE '%' + @StrBefore ";
                                                }
                                                else if (Noplace == NoLong)
                                                {
                                                    sql += " AND MtlItemNo LIKE  @StrBefore + '%'";
                                                }
                                                var resultMaxSequence1 = sqlConnection.Query(sql, dynamicParameters);
                                                foreach (var item in resultMaxSequence1)
                                                {
                                                    maxSequence = Convert.ToInt32(item.maxSequence);
                                                }
                                                break;
                                        }
                                        #endregion

                                        foreach (var item in ItemTypeSegmentJson) //品號結構解析
                                        {
                                            var StructureType = item.Split('❤')[0];
                                            var StructureSort = item.Split('❤')[1];
                                            var StructureSet = item.Split('❤')[2];
                                            var StructureSave = item.Split('❤')[3];
                                            var StructureCustomNum = item.Split('❤')[4];

                                            if (StructureType != "S")
                                            {
                                                #region //判斷品號編碼其組合是否存在
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT DISTINCT MtlItemId
                                            FROM PDM.MtlItemSegment
                                            WHERE SegmentType = @SegmentType
                                            AND SegmentSort = @SegmentSort
                                            AND SaveValue = @SaveValue";
                                                dynamicParameters.Add("SegmentType", StructureType);
                                                dynamicParameters.Add("SegmentSort", StructureSort);
                                                dynamicParameters.Add("SaveValue", StructureSave);

                                                var segmentValueResult = sqlConnection.Query(sql, dynamicParameters);
                                                if (segmentValueResult.Count() > 0) // 有找到就記住其ID,下次再找到要去跟這些ID對比 有存在在往下繼續找
                                                {
                                                    foreach (var item1 in segmentValueResult)
                                                    {
                                                        if (num == 0) //第一次先將找到的id添加進列表
                                                        {
                                                            MtlItemSegmentIdList.Add(item1.MtlItemId);
                                                        }
                                                        else //與列表做比對
                                                        {
                                                            var isContain = MtlItemSegmentIdList.Contains(item1.MtlItemId);
                                                            if (isContain == true)
                                                            {
                                                                TemporaryList.Add(item1.MtlItemId);
                                                            }
                                                        }
                                                    }
                                                    if (num != 0)
                                                    {
                                                        if (TemporaryList.Count() > 0) //比對的暫存表有值
                                                        {
                                                            MtlItemSegmentIdList.Clear(); //將符合規格的ID表清空
                                                            foreach (var item1 in TemporaryList) //將暫存表的ID存進去符合規格的ID表
                                                            {
                                                                MtlItemSegmentIdList.Add(item1);
                                                            }
                                                            TemporaryList.Clear(); //將符合規格暫存列表已經放入符合規格ID表中,所以暫存列表可以清空

                                                        }
                                                        else //找不到代表沒有這個組合,所以迴圈中斷
                                                        {
                                                            MtlItemSegmentIdList.Clear(); //將符合規格的ID表清空
                                                            break;
                                                        }
                                                    }
                                                    num++;
                                                }
                                                else //找不到代表沒有這個組合,所以迴圈中斷
                                                {
                                                    MtlItemSegmentIdList.Clear(); //將符合規格的ID表清空
                                                    break;
                                                }
                                                #endregion
                                            }
                                        }

                                        if (MtlItemSegmentIdList.Count() > 0) //如果符合規格的列表有值 就要判斷有沒有符合相同規格的流水碼,有的話從中找出目前流水號規則的最大值
                                        {
                                            #region //撈取目前組合中最大的流水號
                                            SequenceNum = 0;
                                            if (Sequence.Substring(Sequence.Length - 1, 1) == "-") //先確認我目前流水號的碼數
                                            {
                                                SequenceNum = Sequence.Length - 1;
                                                SuffixCode = "Y";
                                            }
                                            else
                                            {
                                                SequenceNum = Sequence.Length;
                                            }
                                            foreach (var item1 in MtlItemSegmentIdList)
                                            {
                                                dynamicParameters = new DynamicParameters();
                                                sql = @"SELECT SegmentType,SegmentSort,SaveValue
                                                        FROM PDM.MtlItemSegment
                                                        WHERE MtlItemId = @MtlItemId";
                                                dynamicParameters.Add("MtlItemId", item1);
                                                var sequenceResult = sqlConnection.Query(sql, dynamicParameters);
                                                foreach (var item2 in sequenceResult)
                                                {
                                                    if (item2.SegmentSort.ToString() == SequenceSort) //判斷流水號位置是否相同
                                                    {
                                                        if (SuffixCode == "Y") //判斷我的流水碼是否有 - 
                                                        {
                                                            if ((item2.SaveValue).Substring(item2.SaveValue.Length - 1, 1) == "-") //判斷符合其規格的品號的流水碼是否有 -
                                                            {
                                                                if (SequenceNum == (item2.SaveValue).Length - 1) //判斷符合規個的流水碼數跟目前要存入的流水碼數是否相同
                                                                {
                                                                    if (maxSequence < Convert.ToInt32((item2.SaveValue.Substring(0, item2.SaveValue.Length - 1))))
                                                                    {
                                                                        maxSequence = Convert.ToInt32((item2.SaveValue.Substring(0, item2.SaveValue.Length - 1)));
                                                                    }
                                                                }

                                                            }
                                                        }
                                                        else
                                                        {
                                                            if (SequenceNum == (item2.SaveValue).Length)
                                                            {
                                                                if (maxSequence < Convert.ToInt32((item2.SaveValue)))
                                                                {
                                                                    maxSequence = Convert.ToInt32((item2.SaveValue));
                                                                }

                                                            }
                                                        }
                                                    }
                                                }
                                            }


                                            #region //品號生成
                                            foreach (var item in ItemTypeSegmentJson) //品號結構解析
                                            {
                                                var StructureType = item.Split('❤')[0];
                                                var StructureSort = item.Split('❤')[1];
                                                var StructureSet = item.Split('❤')[2];
                                                var StructureSave = item.Split('❤')[3];
                                                var StructureCustomNum = item.Split('❤')[4];


                                                if (StructureType == "S")
                                                {
                                                    if (SuffixCode == "Y")
                                                    {
                                                        SegmentValueS = (maxSequence + 1).ToString().PadLeft(SequenceNum, '0') + "-";

                                                        if (maxSequence != 0)
                                                        {
                                                            if (SegmentValueS.Length - 1 != Sequence.Length - 1) throw new SystemException("【品號管理】目前流水編號已經到達到最大值");
                                                        }
                                                        MtlItemNoLast += (maxSequence + 1).ToString().PadLeft(SequenceNum, '0') + "-";
                                                    }
                                                    else
                                                    {
                                                        SegmentValueS = (maxSequence + 1).ToString().PadLeft(SequenceNum, '0');

                                                        if (maxSequence != 0)
                                                        {
                                                            if (SegmentValueS.Length != Sequence.Length) throw new SystemException("【品號管理】目前流水編號已經到達到最大值");
                                                        }
                                                        MtlItemNoLast += SegmentValueS;

                                                    }
                                                    maxSequence++;
                                                }
                                                else
                                                {
                                                    MtlItemNoLast += StructureSave;
                                                }
                                            }
                                            #endregion

                                            #endregion
                                        }
                                        else //找不到代表沒有這個組合,所以流水號從1開始
                                        {
                                            if (maxSequence <= 0)
                                            {
                                                maxSequence = 1;
                                            }
                                            else
                                            {
                                                maxSequence = maxSequence + 1;
                                            }

                                            if (Sequence.Substring(Sequence.Length - 1, 1) == "-")
                                            {
                                                SequenceNum = Sequence.Length - 1;
                                                Sequence = maxSequence.ToString().PadLeft(SequenceNum, '0') + "-";
                                                SegmentValueS = maxSequence.ToString().PadLeft(SequenceNum, '0') + "-";
                                            }
                                            else
                                            {
                                                SequenceNum = Sequence.Length;
                                                Sequence = maxSequence.ToString().PadLeft(SequenceNum, '0');
                                                SegmentValueS = maxSequence.ToString().PadLeft(SequenceNum, '0');
                                            }

                                            foreach (var item in ItemTypeSegmentJson) //品號結構解析
                                            {
                                                var StructureType = item.Split('❤')[0];
                                                var StructureSort = item.Split('❤')[1];
                                                var StructureSet = item.Split('❤')[2];
                                                var StructureSave = item.Split('❤')[3];
                                                var StructureCustomNum = item.Split('❤')[4];

                                                if (StructureType == "S")
                                                {
                                                    if (Sequence.Substring(Sequence.Length - 1, 1) == "-")
                                                    {
                                                        MtlItemNoLast += Sequence;
                                                    }
                                                    else
                                                    {
                                                        MtlItemNoLast += Sequence;
                                                    }
                                                }
                                                else
                                                {
                                                    MtlItemNoLast += StructureSave;
                                                }
                                            }
                                        }
                                    }
                                    else //直接判斷該品號是否有重複 --沒有流水號設定所以直接看品號是否有重複
                                    {
                                        #region //判斷品號是否重複
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 1
                                                FROM PDM.MtlItem
                                                WHERE MtlItemNo = @MtlItemNo
                                                AND MtlItemId != @MtlItemId
                                                AND CompanyId = @CompanyId";
                                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                                        dynamicParameters.Add("MtlItemId", MtlItemId);
                                        dynamicParameters.Add("CompanyId", CurrentCompany);

                                        result = sqlConnection.Query(sql, dynamicParameters);
                                        if (result.Count() > 0) throw new SystemException("【品號管理】－【品號】重複，請重新輸入!");
                                        #endregion
                                    }

                                    if (haveSequence == "Y")
                                    {
                                        if (SegmentValueS == "") throw new SystemException("【品號管理】－【流水碼】有問題沒有取到正確的值，請重新輸入!");
                                    }

                                    #region //品號類型資料新增
                                    foreach (var item in ItemTypeSegmentJson) //品號結構解析
                                    {
                                        var StructureType = item.Split('❤')[0];
                                        var StructureSort = item.Split('❤')[1];
                                        var StructureSet = item.Split('❤')[2];
                                        var StructureSave = item.Split('❤')[3];
                                        var StructureCustomNum = item.Split('❤')[4];

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO PDM.MtlItemSegment (MtlItemId, ItemTypeId, SegmentType
                                        , SegmentSort, SegmentValue, SaveValue, SuffixCode
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MtlItemSegmentId
                                        VALUES (@MtlItemId, @ItemTypeId, @SegmentType
                                        , @SegmentSort, @SegmentValue, @SaveValue, @SuffixCode
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MtlItemId,
                                                ItemTypeId,
                                                SegmentType = StructureType,
                                                SegmentSort = StructureSort,
                                                SegmentValue = StructureSet,
                                                SaveValue = StructureType != "S" ? StructureSave : SegmentValueS,
                                                SuffixCode = StructureSave.Substring(StructureSave.Length - 1, 1) == "-" ? "Y" : "N",
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });
                                        var insertResult1 = sqlConnection.Query(sql, dynamicParameters);
                                        int rowsAffected1 = insertResult1.Count();

                                    }
                                    #endregion

                                }
                                else
                                {
                                    #region //判斷品號是否重複--全部自訂輸入就直接判定是否有重複
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                    FROM PDM.MtlItem
                                    WHERE MtlItemNo = @MtlItemNo
                                    AND MtlItemId != @MtlItemId
                                    AND CompanyId = @CompanyId";
                                    dynamicParameters.Add("MtlItemNo", MtlItemNo);
                                    dynamicParameters.Add("MtlItemId", MtlItemId);
                                    dynamicParameters.Add("CompanyId", CurrentCompany);

                                    result = sqlConnection.Query(sql, dynamicParameters);
                                    if (result.Count() > 0) throw new SystemException("【品號管理】－【品號】重複，請重新輸入!");
                                    #endregion
                                }
                                #endregion
                            }
                            else
                            {
                                if (ItemTypeIdBase != ItemTypeId) throw new SystemException("改品號已經選定類別,類別無法更換!");

                            }

                            #region //判斷品號是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                FROM PDM.MtlItem
                                WHERE MtlItemNo = @MtlItemNo
                                AND MtlItemId != @MtlItemId
                                AND CompanyId = @CompanyId";
                            dynamicParameters.Add("MtlItemNo", ItemTypeEnable == "Y" ? ItemTypeIdBase <= 0 ? MtlItemNoLast : MtlItemNo : MtlItemNo);
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var result2 = sqlConnection.Query(sql, dynamicParameters);
                            if (result2.Count() > 0) throw new SystemException("【品號】重複，請重新輸入!");
                            #endregion

                            string NewMtlItemNo = ItemTypeEnable == "Y" ? ItemTypeIdBase <= 0 ? MtlItemNoLast : MtlItemNo : MtlItemNo;

                            //24.08.16 僅能包含半形大寫字母/半形數字/減號
                            if (!Regex.IsMatch(NewMtlItemNo, @"^[A-Z0-9-]+$"))
                                throw new SystemException("【品號】格式錯誤!");

                            #region //品號修改
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItem SET
                                    ItemTypeId = @ItemTypeId,
                                    MtlItemNo = @MtlItemNo,
                                    MtlItemName = @MtlItemName,
                                    MtlItemSpec = @MtlItemSpec,
                                    InventoryUomId = @InventoryUomId,
                                    PurchaseUomId = @PurchaseUomId,
                                    SaleUomId = @SaleUomId,
                                    TypeOne = @TypeOne,
                                    TypeTwo = @TypeTwo,
                                    TypeThree = @TypeThree,
                                    TypeFour = @TypeFour,
                                    InventoryId = @InventoryId,
                                    RequisitionInventoryId = @RequisitionInventoryId,
                                    InventoryManagement = @InventoryManagement,
                                    MtlModify = @MtlModify,
                                    BondedStore = @BondedStore,
                                    ItemAttribute = @ItemAttribute,
                                    ProductionLine = @ProductionLine,
                                    LotManagement = @LotManagement,
                                    EfficientDays = @EfficientDays,
                                    RetestDays = @RetestDays,
                                    MeasureType = @MeasureType,
                                    EffectiveDate = @EffectiveDate,
                                    ExpirationDate = @ExpirationDate,
                                    OverReceiptManagement = @OverReceiptManagement,
                                    OverDeliveryManagement = @OverDeliveryManagement,
                                    MtlItemDesc = @MtlItemDesc,
                                    MtlItemRemark = @MtlItemRemark,
                                    ReplenishmentPolicy=@ReplenishmentPolicy,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ItemTypeId,
                                    MtlItemNo = NewMtlItemNo,
                                    MtlItemName,
                                    MtlItemSpec,
                                    InventoryUomId = InventoryUomId > 0 ? (int?)InventoryUomId : null,
                                    PurchaseUomId = PurchaseUomId > 0 ? (int?)PurchaseUomId : null,
                                    SaleUomId = SaleUomId > 0 ? (int?)SaleUomId : null,
                                    TypeOne,
                                    TypeTwo,
                                    TypeThree,
                                    TypeFour,
                                    InventoryId = InventoryId > 0 ? (int?)InventoryId : null,
                                    RequisitionInventoryId = RequisitionInventoryId > 0 ? (int?)RequisitionInventoryId : null,
                                    InventoryManagement,
                                    MtlModify,
                                    BondedStore,
                                    ItemAttribute,
                                    ProductionLine,
                                    LotManagement,
                                    EfficientDays = LotManagement != "N" ? EfficientDays : 0,
                                    RetestDays = LotManagement != "N" ? RetestDays : 0,
                                    MeasureType,
                                    EffectiveDate = EffectiveDate.Length > 0 ? EffectiveDate : null,
                                    ExpirationDate = ExpirationDate.Length > 0 ? ExpirationDate : null,
                                    OverReceiptManagement,
                                    OverDeliveryManagement,
                                    MtlItemDesc,
                                    MtlItemRemark,
                                    ReplenishmentPolicy,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlItemId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        else
                        {
                            throw new SystemException("此品號已拋轉，無法修改!");
                        }
                        List<CustomerMtlItem> dbCustomerMtlItems = new List<CustomerMtlItem>();

                        #region //撈取客戶品號資料
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT CustomerId
                        //        FROM PDM.CustomerMtlItem
                        //        WHERE MtlItemId = @MtlItemId";
                        //dynamicParameters.Add("MtlItemId", MtlItemId);

                        //dbCustomerMtlItems = sqlConnection.Query<CustomerMtlItem>(sql, dynamicParameters).ToList();
                        #endregion

                        //foreach (var custMtl in customerMtlItem)
                        //{
                        //    #region //判斷客戶資訊是否正確
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 1
                        //            FROM SCM.Customer
                        //            WHERE CustomerId = @CustomerId";
                        //    dynamicParameters.Add("CustomerId", custMtl.CustomerId);

                        //    var result4 = sqlConnection.Query(sql, dynamicParameters);
                        //    if (result4.Count() <= 0) throw new SystemException("客戶資料錯誤!");
                        //    #endregion

                        //    if (dbCustomerMtlItems.Exists(x => x.CustomerId == custMtl.CustomerId))
                        //    {
                        //        #region //客戶品號修改
                        //        dynamicParameters = new DynamicParameters();
                        //        sql = @"UPDATE PDM.CustomerMtlItem SET
                        //                CustomerMtlItemNo = @CustomerMtlItemNo,
                        //                CustomerMtlItemName = @CustomerMtlItemName,
                        //                CustomerMtlItemSpec = @CustomerMtlItemSpec,
                        //                LastModifiedDate = @LastModifiedDate,
                        //                LastModifiedBy = @LastModifiedBy
                        //                WHERE MtlItemId = @MtlItemId
                        //                AND CustomerId = @CustomerId";
                        //        dynamicParameters.AddDynamicParams(
                        //            new
                        //            {
                        //                CustomerMtlItemNo = custMtl.CustomerMtlItemNo,
                        //                CustomerMtlItemName = custMtl.CustomerMtlItemName,
                        //                CustomerMtlItemSpec = custMtl.CustomerMtlItemSpec,
                        //                LastModifiedDate,
                        //                LastModifiedBy,
                        //                MtlItemId,
                        //                CustomerId = custMtl.CustomerId
                        //            });

                        //        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //        #endregion

                        //        #region //修改狀態
                        //        dbCustomerMtlItems
                        //            .Where(x => x.CustomerId == custMtl.CustomerId)
                        //            .ToList()
                        //            .ForEach(x =>
                        //            {
                        //                x.Exist = true;
                        //            });
                        //        #endregion
                        //    }
                        //    else
                        //    {
                        //        #region //客戶品號新增
                        //        dynamicParameters = new DynamicParameters();
                        //        sql = @"INSERT INTO PDM.CustomerMtlItem (MtlItemId, CustomerId, CustomerMtlItemNo, CustomerMtlItemName, CustomerMtlItemSpec
                        //                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                        //                OUTPUT INSERTED.CustomerMtlItemId
                        //                VALUES (@MtlItemId, @CustomerId, @CustomerMtlItemNo, @CustomerMtlItemName, @CustomerMtlItemSpec
                        //                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                        //        dynamicParameters.AddDynamicParams(
                        //            new
                        //            {
                        //                MtlItemId,
                        //                custMtl.CustomerId,
                        //                custMtl.CustomerMtlItemNo,
                        //                custMtl.CustomerMtlItemName,
                        //                custMtl.CustomerMtlItemSpec,
                        //                CreateDate,
                        //                LastModifiedDate,
                        //                CreateBy,
                        //                LastModifiedBy
                        //            });

                        //        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //        #endregion
                        //    }

                        //}

                        //List<CustomerMtlItem> deleteCustomerMtlItems = dbCustomerMtlItems.Where(x => x.Exist == false).ToList();

                        //#region //客戶品號刪除
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"DELETE PDM.CustomerMtlItem
                        //            WHERE MtlItemId = @MtlItemId
                        //            AND CustomerId IN @CustomerId";
                        //dynamicParameters.Add("MtlItemId", MtlItemId);
                        //dynamicParameters.Add("CustomerId", deleteCustomerMtlItems.Select(x => x.CustomerId).ToArray());

                        //rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        //#endregion

                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        rowsAffected += insertResult.Count();

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlItemStatus -- 品號狀態更新 -- Zoey 2022.10.13
        public string UpdateMtlItemStatus(int MtlItemId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷品號資訊是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 Status
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號資料錯誤!");

                        string status = "";
                        foreach (var item in result)
                        {
                            status = item.Status;
                        }

                        #region //調整為相反狀態
                        switch (status)
                        {
                            case "A":
                                status = "S";
                                break;
                            case "S":
                                status = "A";
                                break;
                        }
                        #endregion
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItem SET
                                Status = @Status,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                Status = status,
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBillOfMaterials -- Bom主件資料更新 -- Zoey 2022.12.06
        public string UpdateBillOfMaterials(int BomId, int MtlItemId, double StandardLot, string WipPrefix, string Remark)
        {
            try
            {
                if (StandardLot <= 0) throw new SystemException("【標準批量】不能為空!");
                if (WipPrefix.Length <= 0) throw new SystemException("【製令單別】不能為空!");
                if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;
                        string TransferStatus = "";

                        #region //判斷Bom主件是否存在/撈取拋轉狀態
                        sql = @"SELECT TransferStatus
                                FROM PDM.BillOfMaterials
                                WHERE BomId = @BomId";
                        dynamicParameters.Add("BomId", BomId);

                        var result = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        #endregion

                        if (TransferStatus != "Y")
                        {
                            if (result.Count() <= 0)
                            {
                                #region //判斷品號是否正確
                                sql = @"SELECT TOP 1 1
                                        FROM PDM.MtlItem
                                        WHERE MtlItemId = @MtlItemId";
                                dynamicParameters.Add("MtlItemId", MtlItemId);

                                var result2 = sqlConnection.Query(sql, dynamicParameters);
                                if (result2.Count() <= 0) throw new SystemException("【品號】資料錯誤!");
                                #endregion

                                #region //撈取單位ID
                                int uomId = -1;
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT UomId FROM PDM.UnitOfMeasure
                                        WHERE UomNo = 'PCS'
                                        AND CompanyId = @CompanyId";
                                dynamicParameters.Add("CompanyId", CurrentCompany);

                                var result3 = sqlConnection.Query(sql, dynamicParameters);

                                if (result3.Count() <= 0) throw new SystemException("單位資料錯誤!");

                                foreach (var item in result3)
                                {
                                    uomId = item.UomId;
                                }
                                #endregion

                                #region //Bom主件新增
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.BillOfMaterials (MtlItemId, UomId, StandardLot, WipPrefix, ModiPrefix, ModiNo, ModiSequence, Version
                                        , Remark, ConfirmStatus, ConfirmUserId, ConfirmDate, TransferStatus, TransferDate, Status
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.BomId
                                        VALUES (@MtlItemId, @UomId, @StandardLot, @WipPrefix, @ModiPrefix, @ModiNo, @ModiSequence, @Version
                                        , @Remark, @ConfirmStatus, @ConfirmUserId, @ConfirmDate, @TransferStatus, @TransferDate, @Status
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MtlItemId,
                                        UomId = uomId,
                                        StandardLot,
                                        WipPrefix,
                                        ModiPrefix = "",
                                        ModiNo = "",
                                        ModiSequence = "",
                                        Version = "0000",
                                        Remark = "",
                                        ConfirmStatus = 'N',
                                        ConfirmUserId = (int?)null,
                                        ConfirmDate = (int?)null,
                                        TransferStatus = 'N',
                                        TransferDate = (int?)null,
                                        Status = 'Y',
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });

                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected = insertResult.Count();
                                #endregion
                            }
                            else
                            {
                                #region //Bom主件修改
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE PDM.BillOfMaterials SET
                                        StandardLot = @StandardLot,
                                        WipPrefix = @WipPrefix,
                                        Remark = @Remark,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE BomId = @BomId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        StandardLot,
                                        WipPrefix,
                                        Remark,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        BomId
                                    });

                                rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                        }
                        else
                        {
                            throw new SystemException("BOM已拋轉，無法增修!");
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomDetail -- Bom元件資料更新 -- Zoey 2022.12.06  
        public string UpdateBomDetail(int BomDetailId, int BomId, int MtlItemId, string BomSequence, double CompositionQuantity, double Base, double LossRate
            , string StandardCostingType, string MaterialProperties, string EffectiveDate, string ExpirationDate, string Remark, string ComponentType)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【元件品號】不能為空!");
                if (BomSequence.Length <= 0) throw new SystemException("【序號】不能為空!");
                if (BomSequence.Length > 4) throw new SystemException("【序號】長度錯誤!");
                if (CompositionQuantity < 0) throw new SystemException("【單位用量】不能為空!");
                if (Base < 0) throw new SystemException("【底數】不能為空!");
                if (LossRate < 0) throw new SystemException("【損壞率】不能為空!");
                if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                if (StandardCostingType != "Y" && StandardCostingType != "N") throw new SystemException("【標準成本計算】不能為空!");
                if (MaterialProperties != "1" && MaterialProperties != "2" && MaterialProperties != "3" && MaterialProperties != "4" && MaterialProperties != "5") throw new SystemException("【材料性質】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    string companyNo = "", mtlItemNo = "";
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string TransferStatus = "";
                        int rowsAffected = 0;

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //取得元件品號資料
                        sql = @"SELECT TOP 1 TransferStatus,MtlItemNo,TypeOne
	                            , ISNULL(EffectiveDate, '') as EffectiveDate
	                            , ISNULL(ExpirationDate, '') as ExpirationDate
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);

                        #region //判斷品號是否正確
                        if (!result.Any()) throw new SystemException("【品號】資料錯誤!");
                        #endregion

                        foreach (var item in result)
                        {
                            if(item.TypeOne == "06" && CurrentCompany == 3) throw new SystemException(string.Format("品號{0}</br>屬於費用類,不可被當元件", mtlItemNo));
                            mtlItemNo = item.MtlItemNo;

                            #region //判斷品號是否拋轉ERP
                            if (item.TransferStatus != "Y")
                            {
                                throw new SystemException(string.Format("品號{0}</br>尚未拋轉ERP", mtlItemNo));
                            }
                            #endregion

                            #region //判斷品號是否已經失效
                            var effectiveDate = item.EffectiveDate.ToString("yyyy-MM-dd");
                            if (effectiveDate != "1900-01-01" && CreateDate.CompareTo(item.EffectiveDate) < 0)
                                throw new SystemException(string.Format("【元件品號】</br>{0}</br>{1}生效</br>目前無法更改!", mtlItemNo, effectiveDate));

                            var expirationDate = item.ExpirationDate.ToString("yyyy-MM-dd");
                            if (expirationDate != "1900-01-01" && CreateDate.CompareTo(item.ExpirationDate) > 0)
                                throw new SystemException(string.Format("【元件品號】</br>{0}</br>{1}到期</br>已無法更改!", mtlItemNo, expirationDate));
                            #endregion
                        }

                        #endregion

                        using (SqlConnection erpConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷ERP品號是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 LTRIM(RTRIM(MB030)) MB030, LTRIM(RTRIM(MB031)) MB031
                                    FROM INVMB
                                    WHERE MB001 = @MtlItemNo";
                            dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            var resultINVMB = erpConnection.Query(sql, dynamicParameters);
                            if (!resultINVMB.Any()) throw new SystemException(string.Format("ERP不存在該品號</br>{0}", mtlItemNo));

                            foreach (var item in resultINVMB)
                            {
                                #region //判斷品號是否已經失效
                                if (DateTime.TryParseExact(item.MB030, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DateTime mb030))
                                {
                                    string MB030 = mb030.ToString("yyyy-MM-dd");
                                    if (MB030 != "1900-01-01" && CreateDate.CompareTo(mb030) < 0)
                                        throw new SystemException(string.Format("【ERP元件品號】</br>{0}</br>{1}生效</br>目前無法使用!", mtlItemNo, MB030));
                                }
                                if (DateTime.TryParseExact(item.MB031, "yyyyMMdd", null, System.Globalization.DateTimeStyles.None, out DateTime mb031))
                                {
                                    string MB031 = mb031.ToString("yyyy-MM-dd");
                                    if (MB031 != "1900-01-01" && CreateDate.CompareTo(mb031) > 0)
                                        throw new SystemException(string.Format("【ERP元件品號】</br>{0}</br>{1}到期</br>已無法使用!", mtlItemNo, MB031));
                                }
                                #endregion
                            }
                            #endregion

                            #region//判斷品號否已經失效 (停用)
                            //var expirationDate = CreateDate.ToString("yyyyMMdd");

                            //dynamicParameters = new DynamicParameters();
                            //sql = @"SELECT TOP 1 MB031
                            //        FROM INVMB
                            //        WHERE MB001 = @MtlItemNo
                            //        AND MB031 !='' AND MB031 IS NOT NULL";
                            //dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            //dynamicParameters.Add("MB031", expirationDate);
                            //var result2INVMB = erpConnection.Query(sql, dynamicParameters);
                            //if (result2INVMB.Any())
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"SELECT TOP 1 MB031
                            //        FROM INVMB
                            //        WHERE MB001 = @MtlItemNo
                            //        AND MB031 <= @MB031 ";
                            //    dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            //    dynamicParameters.Add("MB031", expirationDate);
                            //    var result3INVMB = erpConnection.Query(sql, dynamicParameters);
                            //    if (result3INVMB.Any())
                            //        throw new SystemException(string.Format("ERP在該品號已失效</br>{0}", mtlItemNo));
                            //}
                            #endregion
                        }

                        #region //判斷Bom元件是否正確
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomDetail
                                WHERE BomDetailId = @BomDetailId";
                        dynamicParameters.Add("BomDetailId", BomDetailId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("BOM元件資料錯誤!");
                        #endregion

                        #region //判斷元件品號是否重複
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomDetail
                                WHERE MtlItemId = @MtlItemId
                                AND BomId = @BomId
                                AND BomDetailId != @BomDetailId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("BomId", BomId);
                        dynamicParameters.Add("BomDetailId", BomDetailId);

                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【元件品號】重複，請重新輸入!");
                        #endregion

                        #region //撈取拋轉狀態
                        sql = @"SELECT TransferStatus
                                FROM PDM.BillOfMaterials
                                WHERE BomId = @BomId";
                        dynamicParameters.Add("BomId", BomId);

                        result = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        #endregion

                        if (TransferStatus != "Y")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.BomDetail SET
                                    MtlItemId = @MtlItemId,
                                    BomSequence = @BomSequence,
                                    CompositionQuantity = @CompositionQuantity,
                                    Base = @Base,
                                    LossRate = @LossRate,
                                    StandardCostingType=@StandardCostingType,
                                    MaterialProperties=@MaterialProperties,
                                    Remark = @Remark,
ComponentType = @ComponentType,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BomDetailId = @BomDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MtlItemId,
                                    BomSequence,
                                    CompositionQuantity,
                                    Base,
                                    LossRate,
                                    StandardCostingType,
                                    MaterialProperties,
                                    Remark,
                                    ComponentType,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    BomDetailId
                                });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateConfirmBomExcel -- 上傳BomExce資料 -- Shintokuro 2023-12-07
        public string UpdateConfirmBomExcel(int BomId, string BomExcelJson, string BomExcelData)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        List<int> BomDetailList = new List<int>();
                        int rowsAffected = 0;
                        #region//檢核品號【BOM單頭】是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConfirmStatus
                                FROM PDM.BillOfMaterials a
                                WHERE a.BomId=@BomId";
                        dynamicParameters.Add("BomId", BomId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【BOM單頭】查無資料,請重新確認");
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("【BOM】須處於未確認狀態下才可以異動");
                        }
                        #endregion

                        #region//撈取Bom元件Id
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT BomDetailId
                                FROM PDM.BomDetail a
                                WHERE a.BomId=@BomId";
                        dynamicParameters.Add("BomId", BomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0)
                        {
                            foreach (var item in result)
                            {
                                BomDetailList.Add(item.BomDetailId);
                            }
                        }
                        #endregion



                        var spreadsheetJson = JObject.Parse(BomExcelJson);

                        #region //解析Spreadsheet Data
                        foreach (var item in spreadsheetJson["spreadsheetInfo"])
                        {
                            string MtlItemNo = item["MtlItemNo"] != null ? item["MtlItemNo"].ToString() : throw new SystemException("【資料維護不完整】品號欄位資料不可以為空,請重新確認~~");
                            string BomSequence = item["BomSequence"] != null ? item["BomSequence"].ToString() : throw new SystemException("【資料維護不完整】序號欄位資料不可以為空,請重新確認~~");
                            double CompositionQuantity = item["CompositionQuantity"] != null ? Convert.ToDouble(item["CompositionQuantity"]) : throw new SystemException("【資料維護不完整】單位用量欄位資料不可以為空,請重新確認~~");
                            double Base = item["Base"] != null ? Convert.ToDouble(item["Base"]) : throw new SystemException("【資料維護不完整】底數欄位資料不可以為空,請重新確認~~");
                            double LossRate = item["LossRate"] != null ? Convert.ToDouble(item["LossRate"]) : throw new SystemException("【資料維護不完整】損耗率欄位資料不可以為空,請重新確認~~");
                            string EffectiveDate = item["EffectiveDate"] != null ? item["EffectiveDate"].ToString() : null;
                            string ExpirationDate = item["ExpirationDate"] != null ? item["ExpirationDate"].ToString() : null;
                            string Remark = item["Remark"] != null ? item["Remark"].ToString() : "";
                            if (EffectiveDate != null && ExpirationDate != null)
                            {
                                if (Convert.ToDouble(EffectiveDate) > Convert.ToDouble(ExpirationDate)) throw new SystemException("【資料異常】失效日不可以大於生效日,請重新確認~~");
                            }
                            //套件的日期值是 從1899/12/30 為第0天 所以將取的數值 從1899/12/30 開始加即可推導出正確日期格式
                            DateTime initialDate = new DateTime(1899, 12, 30);
                            DateTime? effectiveDate = new DateTime();
                            DateTime? expirationDate = new DateTime();
                            if (EffectiveDate != null)
                            {
                                effectiveDate = initialDate.AddDays(Convert.ToInt32(Convert.ToDouble(EffectiveDate)));
                            }
                            if (ExpirationDate != null)
                            {
                                expirationDate = initialDate.AddDays(Convert.ToInt32(Convert.ToDouble(ExpirationDate)));
                            }

                            if (BomSequence.Length <= 0) throw new SystemException("【序號】不能為空!");
                            if (BomSequence.Length > 4) throw new SystemException("【序號】長度錯誤!");
                            if (Convert.ToInt32(BomSequence) < 0) throw new SystemException("【序號】格式有問題!!");

                            if (CompositionQuantity < 0) throw new SystemException("【單位用量】不能為空!");
                            if (Base < 0) throw new SystemException("【底數】不能為空!");
                            if (LossRate < 0) throw new SystemException("【損壞率】不能為空!");

                            if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");

                            #region //確認元件品號資料是否正確
                            int MtlItemId = -1;
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.InventoryUomId,a.TransferStatus,a.MtlItemNo,a.MtlItemId,TypeOne
                                , ISNULL(EffectiveDate, '') as EffectiveDate
                                , ISNULL(ExpirationDate, '') as ExpirationDate
                                FROM PDM.MtlItem a 
                                WHERE MtlItemNo = @MtlItemNo";
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);

                            var MtlItemResult = sqlConnection.Query(sql, dynamicParameters);
                            if (!MtlItemResult.Any()) throw new SystemException("找不到【" + MtlItemNo + "】品號,請重新確認~~");
                            int uomId = -1;
                            foreach (var item1 in MtlItemResult)
                            {
                                if(item1.TypeOne == "06" && CurrentCompany == 3) throw new SystemException(string.Format("品號{0}</br>屬於費用類,不可被當元件", MtlItemNo));
                                MtlItemId = item1.MtlItemId;

                                if (item1.TransferStatus != "Y") throw new SystemException(string.Format("品號{0}</br>尚未拋轉ERP", MtlItemNo));
                                else uomId = item1.InventoryUomId;

                                #region //判斷品號是否已經失效
                                string effectiveDateBase = item1.EffectiveDate.ToString("yyyy-MM-dd");
                                if (effectiveDateBase != "1900-01-01" && CreateDate.CompareTo(item1.EffectiveDate) < 0)
                                    throw new SystemException(string.Format("【元件品號】</br>{0}</br>{1}生效</br>目前無法使用!", MtlItemNo, effectiveDate));

                                string expirationDateBase = item1.ExpirationDate.ToString("yyyy-MM-dd");
                                if (expirationDateBase != "1900-01-01" && CreateDate.CompareTo(item1.ExpirationDate) > 0)
                                    throw new SystemException(string.Format("【元件品號】</br>{0}</br>{1}到期</br>已無法使用!", MtlItemNo, expirationDate));
                                #endregion
                            }
                            #endregion

                            #region //確認品號元件是否已經存在Bom表
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 BomSequence,BomDetailId
                                    FROM PDM.BomDetail a 
                                    WHERE a.MtlItemId = @MtlItemId
                                    AND a.BomId = @BomId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            dynamicParameters.Add("BomId", BomId);
                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item2 in result)
                                {
                                    if (item2.BomSequence == BomSequence)
                                    {
                                        BomDetailList.Remove(item2.BomDetailId);

                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE PDM.BomDetail SET
                                                MtlItemId = @MtlItemId,
                                                BomSequence = @BomSequence,
                                                CompositionQuantity = @CompositionQuantity,
                                                Base = @Base,
                                                LossRate = @LossRate,
                                                StandardCostingType=@StandardCostingType,
                                                MaterialProperties=@MaterialProperties,
                                                EffectiveDate = @EffectiveDate,
                                                ExpirationDate = @ExpirationDate,
                                                Remark = @Remark,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BomDetailId = @BomDetailId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MtlItemId,
                                                BomSequence,
                                                CompositionQuantity,
                                                Base,
                                                LossRate,
                                                StandardCostingType = "Y",
                                                MaterialProperties = "1",
                                                EffectiveDate = EffectiveDate != null ? effectiveDate : null,
                                                ExpirationDate = ExpirationDate != null ? expirationDate : null,
                                                Remark,
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                BomDetailId = item2.BomDetailId
                                            });

                                        rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                    }
                                    else
                                    {
                                        throw new SystemException("該元件【" + MtlItemNo + "】品號已經建立,需採用原序號才可以執行更新資料,請重新確認~~");
                                    }
                                }
                            }
                            else
                            {
                                #region //INSERT PDM.DfmQiProcess
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.BomDetail (BomId, BomSequence, MtlItemId, UomId, CompositionQuantity, Base, LossRate
                                    , StandardCostingType, MaterialProperties
                                    , ReleaseItem, EffectiveDate, ExpirationDate, Remark, SubstitutionRemark, ConfirmStatus
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    OUTPUT INSERTED.BomDetailId
                                    VALUES (@BomId, @BomSequence, @MtlItemId, @UomId, @CompositionQuantity, @Base, @LossRate
                                    , @StandardCostingType, @MaterialProperties
                                    , @ReleaseItem, @EffectiveDate, @ExpirationDate, @Remark, @SubstitutionRemark, @ConfirmStatus
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        BomId,
                                        BomSequence,
                                        MtlItemId,
                                        UomId = uomId,
                                        CompositionQuantity,
                                        Base,
                                        LossRate,
                                        StandardCostingType = "Y",
                                        MaterialProperties = "1",
                                        ReleaseItem = "",
                                        EffectiveDate = EffectiveDate != null ? effectiveDate : null,
                                        ExpirationDate = ExpirationDate != null ? expirationDate : null,
                                        Remark,
                                        SubstitutionRemark = "",
                                        ConfirmStatus = "N",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    });
                                var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                rowsAffected += insertResult.Count();
                                #endregion
                            }
                            #endregion
                        }
                        #endregion


                        #region //以上傳資料為最新,故要移除沒有再上傳資料中的Bom元件
                        if (BomDetailList.Count() > 0)
                        {
                            foreach (var item in BomDetailList)
                            {
                                #region //刪子table
                                sql = @" DELETE a FROM PDM.BomSubstitution a
                                 INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                 WHERE b.BomDetailId = @BomDetailId";
                                dynamicParameters.Add("BomDetailId", item);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region //刪子table
                                sql = @" DELETE a FROM PDM.BomDetail a
                                 WHERE a.BomDetailId = @BomDetailId";
                                dynamicParameters.Add("BomDetailId", item);

                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                        }
                        #endregion



                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlRdDesign -- 研發設計圖品號更新 -- Zoey 2022.12.07
        public string UpdateMtlRdDesign(int MtlItemId, int DesignId)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("品號資料錯誤!");
                if (DesignId <= 0) throw new SystemException("【研發設計圖】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    string mtlItemNo = string.Empty;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //取得品號資料
                        sql = @"SELECT TOP 1 MtlItemNo
	                            , ISNULL(EffectiveDate, '') as EffectiveDate
	                            , ISNULL(ExpirationDate, '') as ExpirationDate
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);

                        #region //判斷品號是否正確
                        if (!result.Any()) throw new SystemException("品號資料錯誤!");
                        #endregion

                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo;

                            #region //判斷品號是否已經失效
                            var effectiveDate = item.EffectiveDate.ToString("yyyy-MM-dd");
                            if (effectiveDate != "1900-01-01" && CreateDate.CompareTo(item.EffectiveDate) < 0)
                                throw new SystemException(string.Format("【品號】</br>{0}</br>{1}生效</br>目前無法使用!", mtlItemNo, effectiveDate));

                            var expirationDate = item.ExpirationDate.ToString("yyyy-MM-dd");
                            if (expirationDate != "1900-01-01" && CreateDate.CompareTo(item.ExpirationDate) > 0)
                                throw new SystemException(string.Format("【品號】</br>{0}</br>{1}到期</br>已無法使用!", mtlItemNo, expirationDate));
                            #endregion
                        }
                        #endregion

                        #region //判斷設計圖是否正確
                        sql = @"SELECT TOP 1 1
                                FROM PDM.RdDesign
                                WHERE DesignId = @DesignId";
                        dynamicParameters.Add("DesignId", DesignId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("研發設計圖資料錯誤!");
                        #endregion

                        #region //判斷設計圖是否重複
                        sql = @"SELECT TOP 1 1
                                FROM PDM.RdDesign
                                WHERE MtlItemId = @MtlItemId
                                AND DesignId = @DesignId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("DesignId", DesignId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() > 0) throw new SystemException("【研發設計圖】重複，請重新選擇!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.RdDesign SET
                                MtlItemId = @MtlItemId,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE DesignId = @DesignId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MtlItemId,
                                LastModifiedDate,
                                LastModifiedBy,
                                DesignId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlSaleOrder -- 訂單品號更新 -- Zoey 2022.12.07
        public string UpdateMtlSaleOrder(int MtlItemId, int SoDetailId)
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("品號資料錯誤!");
                if (SoDetailId <= 0) throw new SystemException("【訂單】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string MtlItemName = "", MtlItemSpec = "", TransferStatus = "";
                        int rowsAffected = 0;

                        #region //判斷品號是否正確/撈取品名規格
                        sql = @"SELECT MtlItemName, MtlItemSpec
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號資料錯誤!");

                        foreach (var item in result)
                        {
                            MtlItemName = item.MtlItemName;
                            MtlItemSpec = item.MtlItemSpec;
                        }
                        #endregion

                        #region //判斷訂單是否正確/撈取拋轉狀態
                        sql = @"SELECT b.TransferStatus
                                FROM SCM.SoDetail a
                                INNER JOIN SCM.SaleOrder b ON b.SoId = a.SoId
                                WHERE SoDetailId = @SoDetailId";
                        dynamicParameters.Add("SoDetailId", SoDetailId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() <= 0) throw new SystemException("訂單資料錯誤!");
                        foreach (var item in result2)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        #endregion

                        #region //判斷訂單是否重複
                        sql = @"SELECT TOP 1 1
                                FROM SCM.SoDetail
                                WHERE MtlItemId = @MtlItemId
                                AND SoDetailId = @SoDetailId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("SoDetailId", SoDetailId);

                        var result3 = sqlConnection.Query(sql, dynamicParameters);
                        if (result3.Count() > 0) throw new SystemException("【訂單】重複，請重新選擇!");
                        #endregion

                        if (TransferStatus == "N")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.SoDetail SET
                                    MtlItemId = @MtlItemId,
                                    SoMtlItemName = @MtlItemName,
                                    SoMtlItemSpec = @MtlItemSpec,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE SoDetailId = @SoDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MtlItemId,
                                    MtlItemName,
                                    MtlItemSpec,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    SoDetailId
                                });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        }
                        else
                        {
                            throw new SystemException("訂單已拋轉ERP，無法綁定!");
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomSubstitution -- 取替代料資料更新 -- Zoey 2022.12.06
        public string UpdateBomSubstitution(int SubstitutionId, int BomDetailId, string SubstituteStatus, int MtlItemId, double Quantity, int SortNumber, string Precedence, string EffectiveDate, string ExpirationDate, string Remark)
        {
            try
            {
                if (BomDetailId <= 0) throw new SystemException("【元件】不能為空!");
                if (SubstituteStatus.Length <= 0) throw new SystemException("【類別】不能為空!");
                if (MtlItemId < 0) throw new SystemException("【品號】不能為空!");
                if (Quantity < 0) throw new SystemException("【數量】不能為空!");
                if (SortNumber < 0) throw new SystemException("【順序】不能為空!");
                if (Remark.Length > 255) throw new SystemException("【備註】長度錯誤!");
                if (EffectiveDate == "") EffectiveDate = null;
                if (ExpirationDate == "") ExpirationDate = null;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    string companyNo = "", mtlItemNo = "";
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷取替代料是否正確
                        sql = @"SELECT TOP 1 b.MtlItemId AS BomDetailMtlItemId, c.MtlItemId AS BomMtlItemId
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.BomDetail b ON b.BomDetailId = a.BomDetailId
                                INNER JOIN PDM.BillOfMaterials c ON c.BomId = b.BomId
                                WHERE SubstitutionId = @SubstitutionId";
                        dynamicParameters.Add("SubstitutionId", SubstitutionId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("取替代料資料錯誤!");
                        if (result.Any(a => a.BomDetailMtlItemId == MtlItemId)) throw new SystemException("【品號】不得與元件相同!");
                        if (result.Any(a => a.BomMtlItemId == MtlItemId)) throw new SystemException("【品號】不得與主件相同!");
                        #endregion

                        #region //確認元件品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.InventoryUomId,TransferStatus,MtlItemNo,TypeOne
                                , ISNULL(EffectiveDate, '') as EffectiveDate
                                , ISNULL(ExpirationDate, '') as ExpirationDate
                                FROM PDM.MtlItem a 
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var MtlItemResult = sqlConnection.Query(sql, dynamicParameters);
                        if (!MtlItemResult.Any()) throw new SystemException("品號資料錯誤!!");
                        int uomId = -1;
                        foreach (var item in MtlItemResult)
                        {
                            if (item.TypeOne == "06" && CurrentCompany == 3) throw new SystemException(string.Format("品號{0}</br>屬於費用類,不可被當元件", mtlItemNo));
                            mtlItemNo = item.MtlItemNo;
                            if (item.TransferStatus != "Y") throw new SystemException(string.Format("品號{0}</br>尚未拋轉ERP", mtlItemNo));
                            else uomId = item.InventoryUomId;
                            #region //判斷品號是否已經失效
                            string effectiveDate = item.EffectiveDate.ToString("yyyy-MM-dd");
                            if (effectiveDate != "1900-01-01" && CreateDate.CompareTo(item.EffectiveDate) < 0)
                                throw new SystemException(string.Format("【元件品號】</br>{0}</br>{1}生效</br>目前無法使用!", mtlItemNo, effectiveDate));

                            string expirationDate = item.ExpirationDate.ToString("yyyy-MM-dd");
                            if (expirationDate != "1900-01-01" && CreateDate.CompareTo(item.ExpirationDate) > 0)
                                throw new SystemException(string.Format("【元件品號】</br>{0}</br>{1}到期</br>已無法使用!", mtlItemNo, expirationDate));
                            #endregion
                        }
                        #endregion

                        #region //判斷主件品號是否正確
                        sql = @"SELECT TOP 1 TransferStatus,MtlItemNo
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號】資料錯誤!");
                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo;
                            if (item.TransferStatus != "Y")
                            {
                                throw new SystemException(string.Format("品號{0}</br>尚未拋轉ERP", mtlItemNo));
                            }
                        }
                        #endregion

                        #region //判斷順序及品號是否重複
                        sql = @"SELECT MtlItemId, SortNumber
                                FROM PDM.BomSubstitution
                                WHERE BomDetailId = @BomDetailId
                                AND SubstituteStatus = @SubstituteStatus
                                AND SubstitutionId != @SubstitutionId";
                        dynamicParameters.Add("BomDetailId", BomDetailId);
                        dynamicParameters.Add("SubstituteStatus", SubstituteStatus);
                        dynamicParameters.Add("SubstitutionId", SubstitutionId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Any(a => a.SortNumber == SortNumber)) throw new SystemException("【順序】重複，請重新輸入!");
                        if (result.Any(a => a.MtlItemId == MtlItemId)) throw new SystemException("【品號】重複，請重新輸入!");
                        #endregion

                        using (SqlConnection erpConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷ERP品號是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM INVMB
                                    WHERE MB001 = @MtlItemNo";
                            dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            var resultINVMB = erpConnection.Query(sql, dynamicParameters);
                            if (!resultINVMB.Any())
                                throw new SystemException(string.Format("ERP不存在該品號</br>{0}", mtlItemNo));
                            #endregion
                        }

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomSubstitution SET
                                BomDetailId = @BomDetailId,
                                SubstituteStatus = @SubstituteStatus,
                                MtlItemId = @MtlItemId,
                                Quantity = @Quantity,
                                SortNumber = @SortNumber,
                                Precedence = @Precedence,
                                EffectiveDate = @EffectiveDate,
                                ExpirationDate = @ExpirationDate,
                                Remark = @Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE SubstitutionId = @SubstitutionId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                BomDetailId,
                                SubstituteStatus,
                                MtlItemId,
                                Quantity,
                                SortNumber,
                                Precedence,
                                EffectiveDate,
                                ExpirationDate,
                                Remark,
                                LastModifiedDate,
                                LastModifiedBy,
                                SubstitutionId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateSubstitutionSort -- 取替代料順序調整 -- Zoey 2022.12.09
        public string UpdateSubstitutionSort(int BomDetailId, string SubstitutionList)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷BOM元件是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomDetail
                                WHERE BomDetailId = @BomDetailId";
                        dynamicParameters.Add("BomDetailId", BomDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【元件】資料錯誤!");
                        #endregion

                        int totalRowsAffected = 0;

                        #region //更新成負數避免觸發唯一值
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomSubstitution SET
                                SortNumber = SortNumber * -1,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomDetailId = @BomDetailId";
                        dynamicParameters.Add("LastModifiedDate", LastModifiedDate);
                        dynamicParameters.Add("LastModifiedBy", LastModifiedBy);
                        dynamicParameters.Add("BomDetailId", BomDetailId);

                        totalRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        int rowsAffected = 0;

                        #region //更新順序
                        string[] substitutionSort = SubstitutionList.Split(',');

                        for (int i = 0; i < substitutionSort.Length; i++)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.BomSubstitution SET
                                    SortNumber = @SortNumber,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE SubstitutionId = @SubstitutionId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    SortNumber = (i + 1),
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    SubstitutionId = Convert.ToInt32(substitutionSort[i])
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                        #endregion

                        if (totalRowsAffected != rowsAffected) throw new SystemException("請先清除搜尋條件，再進行排序!");

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlItemToERP -- 品號資料拋轉ERP -- Zoey 2022.12.09
        public string UpdateMtlItemToERP(int MtlItemId)
        {
            try
            {
                if (MtlItemId < 0) throw new SystemException("【品號】資料錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    List<INVMB> mtlItems = new List<INVMB>();
                    List<INVMO> newMtlItems = new List<INVMO>();
                    int rowsAffected = 0;
                    string adminUser = "N", userGroup = "";
                    string dateNow = CreateDate.ToString("yyyyMMdd"), timeNow = CreateDate.ToString("HH:mm:ss");
                    string mtlItemTransferStatus = "", mtlItemNo = "", companyNo = "", departmentNo = "", userNo = "", userName = "";

                    List<dynamic> resultBomStruct = new List<dynamic>();

                    #region //公司基本資料、使用者基本資料
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("【公司別】資料錯誤!");
                        foreach (var item in result)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItem");
                        dynamicParameters.Add("DetailCode", "data-transfer");
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("【使用者】資料錯誤!");
                        foreach (var item in result)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //檢查元件是否都拋轉ERP
                        RdWorkBasicInformationDA rdWorkBasicInformationDA = new RdWorkBasicInformationDA();
                        dynamicParameters = new DynamicParameters();
                        sql = rdWorkBasicInformationDA.GetBomRecursionString(ref dynamicParameters, new List<dynamic> { MtlItemId });
                        sql += @"SELECT DISTINCT b.MtlItemNo MB001
                                , a.ParentMtlItemNo, a.ErrorFlag
                                FROM @tempData a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId
                                WHERE a.ParentMtlItemId > 0";
                        resultBomStruct = sqlConnection.Query(sql, dynamicParameters).ToList();
                        #endregion

                        var e = resultBomStruct.FirstOrDefault(f => f.ErrorFlag == 1);
                        if (e != null)
                        {
                            throw new SystemException(string.Format(@"品號:{0}<=>{1}，主元件循環參考!", e.MB001, e.ParentMtlItemNo));
                        }
                    }
                    #endregion

                    #region //ERP使用者資料
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        var bomStructMtlItemNos = resultBomStruct.Select(s => s.MB001).Distinct().ToArray();

                        #region //判斷元件品號是否拋轉 INVMB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT LTRIM(RTRIM(MB001)) AS MB001
                                FROM INVMB
                                WHERE COMPANY = @CompanyNo 
                                AND RTRIM(LTRIM(MB001)) IN @MB001s";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("MB001s", bomStructMtlItemNos);
                        var resultINVMB = sqlConnection.Query(sql, dynamicParameters);
                        if (resultINVMB.Count() < bomStructMtlItemNos.Count())
                        {
                            var notExistsErp = bomStructMtlItemNos.Where(w => !resultINVMB.Select(s => s.MB001).ToList().Contains(w));
                            throw new SystemException("以下元件尚未拋轉ERP<br />" + string.Join("<br />", notExistsErp));
                        }
                        #endregion

                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF004, MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @userNo";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("userNo", userNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("【ERP使用者】不存在!");
                        foreach (var item in result)
                        {
                            adminUser = item.MF005; //超級使用者
                            userGroup = item.MF004; //使用者群組
                        }
                        #endregion
                    }
                    #endregion

                    #region //品號拋轉處理 Transfer
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemNo, TransferStatus
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId 
                                AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("【品號】資料錯誤!");
                        if (result.Count() > 1) throw new SystemException("【品號】包含一筆以上，無法拋轉!");
                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo; //MtlItemNo 為以下查詢使用必要參數
                            mtlItemTransferStatus = item.TransferStatus;
                        }

                        mtlItemNo = mtlItemNo.Replace(" ", "");

                        #region //判斷拋轉狀態
                        if (mtlItemTransferStatus != "N") throw new SystemException("【品號】拋轉狀態錯誤!");
                        #endregion

                        #region //品號檢核
                        if (mtlItemNo.Length <= 0) throw new SystemException("【品號】不可為空");
                        if (string.IsNullOrWhiteSpace(mtlItemNo)) throw new SystemException("【品號】不可為空");
                        if (string.IsNullOrEmpty(mtlItemNo)) throw new SystemException("【品號】不可為空");

                        //24.08.16 僅能包含半形大寫字母/半形數字/減號
                        if (!Regex.IsMatch(mtlItemNo, @"^[A-Z0-9-]+$"))
                            throw new SystemException("【品號】格式錯誤!");

                        //24.01.17 加入(是否包含小寫字母)判斷
                        if (Regex.IsMatch(mtlItemNo, @"[a-z]"))
                            throw new SystemException("【品號】不可包含小寫字母");

                        //24.01.05 加入(有無寬度的空白字元)判斷
                        if (Regex.IsMatch(mtlItemNo, @"[\s\u0009-\u000D\u0020\u0085\u00A0\u1680\u2000-\u200A\u2028-\u2029\u202F\u205F\u3000\u180E\u200B-\u200D\u2060\uFEFF\u00B7\u237D\u2420\u2422\u2423]"))
                            throw new SystemException("【品號】不可為空");

                        //24.01.05 加入(全形數字 大寫英文 小寫英文)判斷
                        if (Regex.IsMatch(mtlItemNo, @"[\uFF10-\uFF19\uFF41-\uFF5A\uFF21-\uFF3A]"))
                            throw new SystemException("【品號】不能包含全形英文及數字!");

                        //MtlItemNo是否包含繁簡體中文
                        if (Regex.IsMatch(mtlItemNo, @"\p{IsCJKUnifiedIdeographs}") == true)
                            throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");
                        if (Regex.IsMatch(mtlItemNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]"))
                            throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");
                        #endregion
                        #endregion

                        #region //取得品號資料 mtlItems
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemId, a.MtlItemNo MB001, a.MtlItemName MB002, a.MtlItemSpec MB003, b.UomNo MB004
                                , a.TypeOne MB005, a.TypeTwo MB006, a.TypeThree MB007, a.TypeFour MB008
                                , a.MtlItemDesc MB009, d.InventoryNo MB017, a.InventoryManagement MB019
                                , a.BondedStore MB020, a.LotManagement MB022, a.EfficientDays MB023, a.RetestDays MB024, a.ItemAttribute MB025, a.MtlItemRemark MB028
                                , ISNULL(FORMAT(a.EffectiveDate, 'yyyyMMdd'),'') MB030, ISNULL(FORMAT(a.ExpirationDate, 'yyyyMMdd'),'') MB031
                                , a.MeasureType MB043, a.OverReceiptManagement MB044, a.MtlModify MB066, a.MtlItemNo MB080
                                , a.OverDeliveryManagement MB087, e.UomNo MB155, f.UomNo MB156, g.InventoryNo MB157, a.Version MB165
                                , a.TransferStatus,a.ReplenishmentPolicy MB034
                                FROM PDM.MtlItem a
                                LEFT JOIN PDM.UnitOfMeasure b ON b.UomId = a.InventoryUomId
                                LEFT JOIN SCM.Inventory d ON d.InventoryId = a.InventoryId
                                LEFT JOIN PDM.UnitOfMeasure e ON e.UomId = a.PurchaseUomId
                                LEFT JOIN PDM.UnitOfMeasure f ON f.UomId = a.SaleUomId
                                LEFT JOIN SCM.Inventory g ON g.InventoryId = a.RequisitionInventoryId
                                WHERE a.CompanyId = @CompanyId 
                                AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        mtlItems = sqlConnection.Query<INVMB>(sql, dynamicParameters).ToList();
                        mtlItems.ForEach(item => {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion

                        #region //取得新品號資料 newMtlItems
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemNo MO001, a.MtlItemName MO002, a.MtlItemSpec MO003, b.UomNo MO004
                                , a.TypeOne MO005, a.TypeTwo MO006, a.TypeThree MO007, a.TypeFour MO008
                                , a.MtlItemDesc MO009, d.InventoryNo MO017, a.InventoryManagement MO019
                                , a.BondedStore MO020, a.LotManagement MO022,a.EfficientDays MO023,a.RetestDays MO024, a.ItemAttribute MO025, a.MtlItemRemark MO028
                                , ISNULL(FORMAT(a.EffectiveDate, 'yyyyMMdd'),'') MO030, ISNULL(FORMAT(a.ExpirationDate, 'yyyyMMdd'),'') MO031
                                , a.MeasureType MO043, a.OverReceiptManagement MO044, a.MtlModify MO066, a.MtlItemNo MO080
                                , a.OverDeliveryManagement MO087, e.UomNo MO155, f.UomNo MO156, g.InventoryNo MO163,a.ReplenishmentPolicy MO034
                                FROM PDM.MtlItem a
                                LEFT JOIN PDM.UnitOfMeasure b ON b.UomId = a.InventoryUomId
                                LEFT JOIN SCM.Inventory d ON d.InventoryId = a.InventoryId
                                LEFT JOIN PDM.UnitOfMeasure e ON e.UomId = a.PurchaseUomId
                                LEFT JOIN PDM.UnitOfMeasure f ON f.UomId = a.SaleUomId
                                LEFT JOIN SCM.Inventory g ON g.InventoryId = a.RequisitionInventoryId
                                WHERE a.CompanyId = @CompanyId 
                                AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        newMtlItems = sqlConnection.Query<INVMO>(sql, dynamicParameters).ToList();
                        newMtlItems.ForEach(item => {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否有權限 (停用) Function=INVI29, Auth=Y_______Y___
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @UserNo
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("UserNo", userNo);
                        //    dynamicParameters.Add("Function", "INVI29");
                        //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (!resultUserAuthExist.Any()) throw new SystemException("品號拋轉-【ERP使用者】無權限!");
                        //}
                        #endregion

                        switch (mtlItemTransferStatus)
                        {
                            case "N":
                                #region //判斷品號是否重複 INVMB
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MB001)) AS MB001
                                FROM INVMB
                                WHERE COMPANY = @CompanyNo 
                                AND RTRIM(LTRIM(MB001)) IN @MB001s";
                                dynamicParameters.Add("CompanyNo", companyNo);
                                dynamicParameters.Add("MB001s", mtlItems.Select(s => s.MB001).Distinct().ToArray());
                                var resultINVMB = sqlConnection.Query(sql, dynamicParameters);
                                string[] existINVMB = resultINVMB.Select(s => { return (string)s.MB001; }).Distinct().ToArray();
                                if (existINVMB.Any())
                                {
                                    throw new SystemException("ERP已存在以下品號\r\n" + string.Join("\r\n", existINVMB));
                                }
                                #endregion

                                #region //品號新增 INVMB from mtlItems
                                mtlItems
                                    .ForEach(x =>
                                    {
                                        x.MB010 = ""; //標準途程品號
                                        x.MB011 = ""; //標準途程代號
                                        x.MB012 = ""; //文管代號
                                        x.MB013 = ""; //條碼編號
                                        x.MB014 = 0; //單位淨重
                                        x.MB015 = "Kg"; //重量單位
                                        x.MB016 = ""; //外包裝單位
                                        x.MB018 = ""; //計劃人員
                                        x.MB021 = ""; //循環盤點碼
                                        x.MB026 = "99"; //低階碼
                                        x.MB027 = ""; //ABC等級
                                        x.MB029 = ""; //產品圖號
                                        x.MB032 = ""; //主供應商
                                        x.MB033 = "N"; //MPS件                                        
                                        x.MB035 = "2"; //補貨週期
                                        x.MB036 = 0; //固定前置天數
                                        x.MB037 = 0; //變動前置天數
                                        x.MB038 = 0; //批量
                                        x.MB039 = 0; //最低補量
                                        x.MB040 = 0; //補貨倍量
                                        x.MB041 = 0; //領用倍量
                                        x.MB042 = "1"; //領料碼
                                        x.MB045 = 0; //超收率%
                                        x.MB046 = 0; //標準進價
                                        x.MB047 = 0; //標準售價
                                        x.MB048 = ""; //最近進價幣別-原幣別
                                        x.MB049 = 0; //最近進價-原幣單價
                                        x.MB050 = 0; //最近進價-本幣單價
                                        x.MB051 = 0; //零售價
                                        x.MB052 = "N"; //零售價含稅
                                        x.MB053 = 0; //售價定價一
                                        x.MB054 = 0; //售價定價二
                                        x.MB055 = 0; //售價定價三
                                        x.MB056 = 0; //售價定價四
                                        x.MB057 = 0; //單位標準材料成本
                                        x.MB058 = 0; //單位標準人工成本
                                        x.MB059 = 0; //單位標準製造費用
                                        x.MB060 = 0; //單位標準加工費用
                                        x.MB061 = 0; //本階人工
                                        x.MB062 = 0; //本階製費
                                        x.MB063 = 0; //本階加工
                                        x.MB064 = 0; //庫存數量
                                        x.MB065 = 0; //庫存金額
                                        x.MB067 = ""; //採購人員
                                        x.MB068 = ""; //生產線別
                                        x.MB069 = 0; //售價定價五
                                        x.MB070 = 0; //售價定價六
                                        x.MB071 = 0; //外包裝材積
                                        x.MB072 = ""; //小單位
                                        x.MB073 = 0; //外包裝含商品數
                                        x.MB074 = 0; //外包裝淨重
                                        x.MB075 = 0; //外包裝毛重
                                        x.MB076 = 0; //檢驗天數
                                        x.MB077 = ""; //品管類別
                                        x.MB078 = 0; //MRP生產允許交期提前天數
                                        x.MB079 = 0; //MRP採購允許交期提前天數
                                        x.MB081 = ""; //SIZE
                                        x.MB082 = 0; //關稅率
                                        x.MB083 = "N"; //進價管制
                                        x.MB084 = 0; //單價上限率
                                        x.MB085 = "N"; //售價管制
                                        x.MB086 = 0; //單價下限率
                                        x.MB088 = 0; //超交率
                                        x.MB089 = 0; //庫存包裝數量
                                        x.MB090 = ""; //包裝單位
                                        x.MB091 = "N"; //定重
                                        x.MB092 = "N"; //產品序號管理
                                        x.MB093 = 0; //長(CM)
                                        x.MB094 = 0; //寬(CM)
                                        x.MB095 = 0; //高(CM)
                                        x.MB096 = 1; //工時底數
                                        x.MB097 = 0; //業務底價
                                        x.MB098 = "N"; //業務底價含稅
                                        x.MB099 = 0; //貨物稅率
                                        x.MB100 = "N"; //標準進價含稅
                                        x.MB101 = "N"; //標準售價含稅
                                        x.MB102 = "N"; //最近進價-單價含稅(原/本幣)
                                        x.MB103 = "N"; //售價定價一含稅
                                        x.MB104 = "N"; //售價定價二含稅
                                        x.MB105 = "N"; //售價定價三含稅
                                        x.MB106 = "N"; //售價定價四含稅
                                        x.MB107 = "N"; //售價定價五含稅
                                        x.MB108 = "N"; //售價定價六含稅
                                        x.MB109 = "N"; //新品號
                                        x.MB110 = "N"; //料件承認碼
                                        x.MB111 = 0; //轉撥倍量
                                        x.MB112 = ""; //MRP保留欄位
                                        x.MB113 = ""; //APS預留欄位
                                        x.MB114 = ""; //APS預留欄位
                                        x.MB115 = ""; //APS預留欄位
                                        x.MB116 = ""; //APS預留欄位
                                        x.MB117 = ""; //APS預留欄位
                                        x.MB118 = ""; //APS預留欄位
                                        x.MB119 = 0; //APS預留欄位
                                        x.MB120 = 0; //APS預留欄位
                                        x.MB121 = "N"; //控制編碼原則
                                        x.MB122 = ""; //序號前置碼
                                        x.MB123 = ""; //序號流水號碼數
                                        x.MB124 = ""; //序號編碼原則
                                        x.MB125 = ""; //已用生管序號
                                        x.MB126 = ""; //已用商品序號
                                        x.MB127 = ""; //來源
                                        x.MB128 = ""; //預留欄位
                                        x.MB129 = ""; //預留欄位
                                        x.MB130 = ""; //預留欄位
                                        x.MB131 = ""; //電子發票須上傳產品追溯串接碼
                                        x.MB132 = ""; //預留欄位
                                        x.MB133 = ""; //屬性代碼一
                                        x.MB134 = ""; //屬性代碼二
                                        x.MB135 = ""; //屬性代碼三
                                        x.MB136 = ""; //屬性代碼四
                                        x.MB137 = ""; //屬性代碼五
                                        x.MB138 = ""; //屬性代碼六
                                        x.MB139 = ""; //屬性代碼七
                                        x.MB140 = ""; //屬性代碼八
                                        x.MB141 = ""; //屬性代碼九
                                        x.MB142 = ""; //屬性組代碼
                                        x.MB143 = ""; //屬性內容一
                                        x.MB144 = ""; //屬性內容二
                                        x.MB145 = ""; //屬性內容三
                                        x.MB146 = ""; //屬性內容四
                                        x.MB147 = ""; //屬性內容五
                                        x.MB148 = ""; //屬性內容六
                                        x.MB149 = ""; //屬性內容七
                                        x.MB150 = ""; //屬性內容八
                                        x.MB151 = ""; //屬性內容九
                                        x.MB152 = ""; //屬性代碼十
                                        x.MB153 = ""; //屬性內容十
                                        x.MB154 = ""; //圖號版次
                                        x.MB158 = ""; //新品號核准日期
                                        x.MB159 = 0; //預留欄位
                                        x.MB160 = 0; //預留欄位
                                        x.MB161 = 0; //預留欄位
                                        x.MB162 = ""; //預留欄位
                                        x.MB163 = ""; //稅則
                                        x.MB164 = ""; //產品追溯系統串接碼
                                        x.MB166 = 0; //贈品率
                                        x.MB167 = 0; //預留欄位
                                        x.MB168 = ""; //預留欄位
                                        x.MB169 = ""; //DATECODE管理
                                        x.MB170 = ""; //Bin管理
                                        x.MB171 = 0; //預留欄位
                                        x.MB172 = 0; //預留欄位
                                        x.MB173 = 0; //預留欄位
                                        x.MB174 = ""; //預留欄位
                                        x.MB175 = ""; //預留欄位
                                        x.MB176 = ""; //預留欄位
                                        x.MB177 = ""; //預留欄位
                                        x.MB178 = ""; //預留欄位
                                        x.MB179 = ""; //預留欄位
                                        x.MB180 = 0; //APS固定工時
                                        x.MB181 = 0; //APS變動工時
                                        x.MB182 = 0; //批次加工量
                                        x.MB183 = ""; //預留欄位
                                        x.MB184 = 0; //基準數量
                                        x.MB185 = ""; //資源群組
                                        x.MB186 = ""; //資源群組名稱
                                        x.MB187 = ""; //機台代號
                                        x.MB188 = ""; //機台名稱
                                        x.MB189 = ""; //指定資源
                                        x.MB190 = ""; //關鍵料號
                                        x.MB191 = 0; //營業稅率
                                        x.MB192 = 0; //保固佔售價比率
                                        x.MB193 = 0; //保固期數(月數)
                                        x.MB194 = "0"; //交易設限碼
                                        x.MB195 = ""; //建立作業修改日期
                                        x.MB196 = ""; //建立作業修改者
                                        x.MB197 = ""; //MSIC_Code
                                        x.MB198 = ""; //預留欄位
                                        x.MB199 = ""; //預留欄位
                                        x.MB500 = ""; //產品系列ID
                                        x.MB501 = 0; //GROSS_DIE
                                        x.MB502 = ""; //說明1
                                        x.MB503 = ""; //說明2
                                        x.MB504 = ""; //光罩層次
                                        x.MB505 = ""; //進項稅別碼
                                        x.MB506 = ""; //銷項稅別碼
                                        x.MB507 = 0; //預留欄位
                                        x.MB508 = 0; //存貨週轉目標次數
                                        x.MB509 = 0; //預留欄位
                                        x.MB510 = ""; //預留欄位
                                        x.MB511 = ""; //預留欄位
                                        x.MB512 = ""; //預留欄位
                                        x.MB513 = ""; //預留欄位
                                        x.MB514 = ""; //預留欄位
                                        x.MB515 = ""; //開帳批號
                                        x.MB516 = ""; //批號開帳日期
                                        x.MB517 = ""; //內箱標籤格式
                                        x.MB518 = ""; //中箱標籤格式
                                        x.MB519 = ""; //外箱標籤格式
                                        x.MB520 = ""; //內箱選擇列印
                                        x.MB521 = ""; //中箱選擇列印
                                        x.MB522 = ""; //外箱選擇列印
                                        x.MB545 = 0; //標準產出良率
                                        x.MB550 = ""; //產品屬性
                                        x.MB551 = ""; //Wafer型號
                                        x.MB552 = ""; //性質
                                        x.MB553 = ""; //版本
                                        x.MB554 = ""; //作業代號
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                    });
                                sql = @"INSERT INTO INVMB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MB001, MB002, MB003, MB004, MB005, MB006, MB007, MB008, MB009, MB010
                                            , MB011, MB012, MB013, MB014, MB015, MB016, MB017, MB018, MB019, MB020
                                            , MB021, MB022, MB023, MB024, MB025, MB026, MB027, MB028, MB029, MB030
                                            , MB031, MB032, MB033, MB034, MB035, MB036, MB037, MB038, MB039, MB040
                                            , MB041, MB042, MB043, MB044, MB045, MB046, MB047, MB048, MB049, MB050
                                            , MB051, MB052, MB053, MB054, MB055, MB056, MB057, MB058, MB059, MB060
                                            , MB061, MB062, MB063, MB064, MB065, MB066, MB067, MB068, MB069, MB070
                                            , MB071, MB072, MB073, MB074, MB075, MB076, MB077, MB078, MB079, MB080
                                            , MB081, MB082, MB083, MB084, MB085, MB086, MB087, MB088, MB089, MB090
                                            , MB091, MB092, MB093, MB094, MB095, MB096, MB097, MB098, MB099, MB100
                                            , MB101, MB102, MB103, MB104, MB105, MB106, MB107, MB108, MB109, MB110
                                            , MB111, MB112, MB113, MB114, MB115, MB116, MB117, MB118, MB119, MB120
                                            , MB121, MB122, MB123, MB124, MB125, MB126, MB127, MB128, MB129, MB130
                                            , MB131, MB132, MB133, MB134, MB135, MB136, MB137, MB138, MB139, MB140
                                            , MB141, MB142, MB143, MB144, MB145, MB146, MB147, MB148, MB149, MB150
                                            , MB151, MB152, MB153, MB154, MB155, MB156, MB157, MB158, MB159, MB160
                                            , MB161, MB162, MB163, MB164, MB165, MB166, MB167, MB168, MB169, MB170
                                            , MB171, MB172, MB173, MB174, MB175, MB176, MB177, MB178, MB179, MB180
                                            , MB181, MB182, MB183, MB184, MB185, MB186, MB187, MB188, MB189, MB190
                                            , MB191, MB192, MB193, MB194, MB195, MB196, MB197, MB198, MB199, MB500
                                            , MB501, MB502, MB503, MB504, MB505, MB506, MB507, MB508, MB509, MB510
                                            , MB511, MB512, MB513, MB514, MB515, MB516, MB517, MB518, MB519, MB520
                                            , MB521, MB522, MB545, MB550, MB551, MB552, MB553, MB554
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MB001, @MB002, @MB003, @MB004, @MB005, @MB006, @MB007, @MB008, @MB009, @MB010
                                            , @MB011, @MB012, @MB013, @MB014, @MB015, @MB016, @MB017, @MB018, @MB019, @MB020
                                            , @MB021, @MB022, @MB023, @MB024, @MB025, @MB026, @MB027, @MB028, @MB029, @MB030
                                            , @MB031, @MB032, @MB033, @MB034, @MB035, @MB036, @MB037, @MB038, @MB039, @MB040
                                            , @MB041, @MB042, @MB043, @MB044, @MB045, @MB046, @MB047, @MB048, @MB049, @MB050
                                            , @MB051, @MB052, @MB053, @MB054, @MB055, @MB056, @MB057, @MB058, @MB059, @MB060
                                            , @MB061, @MB062, @MB063, @MB064, @MB065, @MB066, @MB067, @MB068, @MB069, @MB070
                                            , @MB071, @MB072, @MB073, @MB074, @MB075, @MB076, @MB077, @MB078, @MB079, @MB080
                                            , @MB081, @MB082, @MB083, @MB084, @MB085, @MB086, @MB087, @MB088, @MB089, @MB090
                                            , @MB091, @MB092, @MB093, @MB094, @MB095, @MB096, @MB097, @MB098, @MB099, @MB100
                                            , @MB101, @MB102, @MB103, @MB104, @MB105, @MB106, @MB107, @MB108, @MB109, @MB110
                                            , @MB111, @MB112, @MB113, @MB114, @MB115, @MB116, @MB117, @MB118, @MB119, @MB120
                                            , @MB121, @MB122, @MB123, @MB124, @MB125, @MB126, @MB127, @MB128, @MB129, @MB130
                                            , @MB131, @MB132, @MB133, @MB134, @MB135, @MB136, @MB137, @MB138, @MB139, @MB140
                                            , @MB141, @MB142, @MB143, @MB144, @MB145, @MB146, @MB147, @MB148, @MB149, @MB150
                                            , @MB151, @MB152, @MB153, @MB154, @MB155, @MB156, @MB157, @MB158, @MB159, @MB160
                                            , @MB161, @MB162, @MB163, @MB164, @MB165, @MB166, @MB167, @MB168, @MB169, @MB170
                                            , @MB171, @MB172, @MB173, @MB174, @MB175, @MB176, @MB177, @MB178, @MB179, @MB180
                                            , @MB181, @MB182, @MB183, @MB184, @MB185, @MB186, @MB187, @MB188, @MB189, @MB190
                                            , @MB191, @MB192, @MB193, @MB194, @MB195, @MB196, @MB197, @MB198, @MB199, @MB500
                                            , @MB501, @MB502, @MB503, @MB504, @MB505, @MB506, @MB507, @MB508, @MB509, @MB510
                                            , @MB511, @MB512, @MB513, @MB514, @MB515, @MB516, @MB517, @MB518, @MB519, @MB520
                                            , @MB521, @MB522, @MB545, @MB550, @MB551, @MB552, @MB553, @MB554
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                rowsAffected += sqlConnection.Execute(sql, mtlItems);
                                #endregion

                                #region //判斷新品號是否重複 INVMO
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT LTRIM(RTRIM(MO001)) AS MO001
                                FROM INVMO
                                WHERE COMPANY = @CompanyNo 
                                AND RTRIM(LTRIM(MO001)) IN @MO001s";
                                dynamicParameters.Add("CompanyNo", companyNo);
                                dynamicParameters.Add("MO001s", newMtlItems.Select(s => s.MO001).Distinct().ToArray());
                                var resultINVMO = sqlConnection.Query(sql, dynamicParameters);
                                string[] existINVMO = resultINVMO.Select(s => { return (string)s.MO001; }).Distinct().ToArray();
                                if (existINVMO.Any())
                                {
                                    throw new SystemException("ERP已存在以下新品號\r\n" + string.Join("\r\n", existINVMO));
                                }
                                #endregion

                                #region //新品號新增 INVMO from newMtlItems
                                newMtlItems
                                    .ForEach(x =>
                                    {
                                        x.MO010 = ""; //標準途程品號
                                        x.MO011 = ""; //標準途程代號
                                        x.MO012 = ""; //文管代號
                                        x.MO013 = ""; //條碼編號
                                        x.MO014 = 0; //單位淨重
                                        x.MO015 = "Kg"; //重量單位
                                        x.MO016 = ""; //外包裝單位
                                        x.MO018 = ""; //計劃人員
                                        x.MO021 = ""; //循環盤點碼
                                        x.MO023 = 0; //有效天數
                                        x.MO024 = 0; //複檢天數
                                        x.MO026 = ""; //低階碼
                                        x.MO027 = ""; //ABC等級
                                        x.MO029 = ""; //產品圖號
                                        x.MO032 = ""; //主供應商
                                        x.MO033 = "N"; //MPS件                                        
                                        x.MO035 = "2"; //補貨週期
                                        x.MO036 = 0; //固定前置天數
                                        x.MO037 = 0; //變動前置天數
                                        x.MO038 = 0; //批量
                                        x.MO039 = 0; //最低補量
                                        x.MO040 = 0; //補貨倍量
                                        x.MO041 = 0; //領用倍量
                                        x.MO042 = "1"; //領料碼
                                        x.MO045 = 0; //超收率%
                                        x.MO046 = 0; //標準進價
                                        x.MO047 = 0; //標準售價
                                        x.MO048 = ""; //最近進價幣別-原幣別
                                        x.MO049 = 0; //最近進價-原幣單價
                                        x.MO050 = 0; //最近進價-本幣單價
                                        x.MO051 = 0; //零售價
                                        x.MO052 = "N"; //零售價含稅
                                        x.MO053 = 0; //售價定價一
                                        x.MO054 = 0; //售價定價二
                                        x.MO055 = 0; //售價定價三
                                        x.MO056 = 0; //售價定價四
                                        x.MO057 = 0; //單位標準材料成本
                                        x.MO058 = 0; //單位標準人工成本
                                        x.MO059 = 0; //單位標準製造費用
                                        x.MO060 = 0; //單位標準加工費用
                                        x.MO061 = 0; //本階人工
                                        x.MO062 = 0; //本階製費
                                        x.MO063 = 0; //本階加工
                                        x.MO064 = 0; //庫存數量
                                        x.MO065 = 0; //庫存金額
                                        x.MO067 = ""; //採購人員
                                        x.MO068 = ""; //生產線別
                                        x.MO069 = 0; //售價定價五
                                        x.MO070 = 0; //售價定價六
                                        x.MO071 = 0; //外包裝材積
                                        x.MO072 = ""; //小單位
                                        x.MO073 = 0; //外包裝含商品數
                                        x.MO074 = 0; //外包裝淨重
                                        x.MO075 = 0; //外包裝毛重
                                        x.MO076 = 0; //檢驗天數
                                        x.MO077 = ""; //品管類別
                                        x.MO078 = 0; //MRP生產允許交期提前天數
                                        x.MO079 = 0; //MRP採購允許交期提前天數
                                        x.MO081 = ""; //SIZE
                                        x.MO082 = 0; //關稅率
                                        x.MO083 = "N"; //進價管制
                                        x.MO084 = 0; //單價上限率
                                        x.MO085 = "N"; //售價管制
                                        x.MO086 = 0; //單價下限率
                                        x.MO088 = 0; //超交率
                                        x.MO089 = 0; //庫存包裝數量
                                        x.MO090 = ""; //包裝單位
                                        x.MO091 = "N"; //定重
                                        x.MO092 = "N"; //產品序號管理
                                        x.MO093 = 0; //長(CM)
                                        x.MO094 = 0; //寬(CM)
                                        x.MO095 = 0; //高(CM)
                                        x.MO096 = 0; //工時底數
                                        x.MO097 = 0; //業務底價
                                        x.MO098 = "N"; //業務底價含稅
                                        x.MO099 = 0; //貨物稅率
                                        x.MO100 = "N"; //標準進價含稅
                                        x.MO101 = "N"; //標準售價含稅
                                        x.MO102 = "N"; //最近進價-單價含稅(原/本幣)
                                        x.MO103 = "N"; //售價定價一含稅
                                        x.MO104 = "N"; //售價定價二含稅
                                        x.MO105 = "N"; //售價定價三含稅
                                        x.MO106 = "N"; //售價定價四含稅
                                        x.MO107 = "N"; //售價定價五含稅
                                        x.MO108 = "N"; //售價定價六含稅
                                        x.MO109 = "N"; //新品號
                                        x.MO110 = "N"; //料件承認碼
                                        x.MO111 = 0; //轉撥倍量
                                        x.MO112 = ""; //MRP保留欄位
                                        x.MO113 = ""; //APS預留欄位
                                        x.MO114 = ""; //APS預留欄位
                                        x.MO115 = ""; //APS預留欄位
                                        x.MO116 = ""; //APS預留欄位
                                        x.MO117 = ""; //APS預留欄位
                                        x.MO118 = ""; //APS預留欄位
                                        x.MO119 = 0; //APS預留欄位
                                        x.MO120 = 0; //APS預留欄位
                                        x.MO121 = "N"; //控制編碼原則
                                        x.MO122 = ""; //序號前置碼
                                        x.MO123 = "0"; //序號流水號碼數
                                        x.MO124 = ""; //序號編碼原則
                                        x.MO125 = ""; //已用生管序號
                                        x.MO126 = ""; //已用商品序號
                                        x.MO127 = ""; //預留欄位
                                        x.MO128 = ""; //預留欄位
                                        x.MO129 = ""; //預留欄位
                                        x.MO130 = ""; //預留欄位
                                        x.MO131 = ""; //預留欄位
                                        x.MO132 = ""; //預留欄位
                                        x.MO133 = ""; //屬性代碼一
                                        x.MO134 = ""; //屬性代碼二
                                        x.MO135 = ""; //屬性代碼三
                                        x.MO136 = ""; //屬性代碼四
                                        x.MO137 = ""; //屬性代碼五
                                        x.MO138 = ""; //屬性代碼六
                                        x.MO139 = ""; //屬性代碼七
                                        x.MO140 = ""; //屬性代碼八
                                        x.MO141 = ""; //屬性代碼九
                                        x.MO142 = ""; //屬性組代碼
                                        x.MO143 = ""; //屬性內容一
                                        x.MO144 = ""; //屬性內容二
                                        x.MO145 = ""; //屬性內容三
                                        x.MO146 = ""; //屬性內容四
                                        x.MO147 = ""; //屬性內容五
                                        x.MO148 = ""; //屬性內容六
                                        x.MO149 = ""; //屬性內容七
                                        x.MO150 = ""; //屬性內容八
                                        x.MO151 = ""; //屬性內容九
                                        x.MO152 = ""; //屬性代碼十
                                        x.MO153 = ""; //屬性內容十
                                        x.MO154 = ""; //圖號版次
                                        x.MO157 = "Y"; //確認碼
                                        x.MO158 = dateNow; //確認日期
                                        x.MO159 = userNo; //確認者
                                        x.MO160 = "3"; //簽核狀態碼
                                        x.MO161 = x.MO001; //品號
                                        x.MO162 = ""; //申請日期
                                        x.MO164 = 0; //預留欄位
                                        x.MO165 = 0; //預留欄位
                                        x.MO166 = ""; //預留欄位
                                        x.MO167 = ""; //稅則
                                        x.MO168 = ""; //預留欄位
                                        x.MO169 = 0; //贈品率
                                        x.MO170 = 0; //預留欄位
                                        x.MO171 = ""; //預留欄位
                                        x.MO172 = 0; //預留欄位
                                        x.MO173 = 0; //預留欄位
                                        x.MO174 = 0; //預留欄位
                                        x.MO175 = ""; //預留欄位
                                        x.MO176 = ""; //預留欄位
                                        x.MO177 = ""; //預留欄位
                                        x.MO178 = ""; //預留欄位
                                        x.MO179 = ""; //預留欄位
                                        x.MO180 = ""; //預留欄位
                                        x.MO181 = 0; //APS固定工時
                                        x.MO182 = 0; //APS變動工時
                                        x.MO183 = 0; //批次加工量
                                        x.MO184 = ""; //預留欄位
                                        x.MO185 = 0; //基準數量
                                        x.MO186 = ""; //資源群組
                                        x.MO187 = ""; //資源群組名稱
                                        x.MO188 = ""; //機台代號
                                        x.MO189 = ""; //機台名稱
                                        x.MO190 = ""; //指定資源
                                        x.MO191 = ""; //關鍵料號
                                        x.MO192 = 0; //營業稅率
                                        x.MO193 = ""; //Bin管理
                                        x.MO194 = ""; //交易設限碼
                                        x.MO195 = 0; //保固佔售價比率
                                        x.MO196 = 0; //保固期數(月數)
                                        x.MO197 = ""; //
                                        x.MO198 = ""; //預留欄位
                                        x.MO199 = ""; //預留欄位
                                        x.MO500 = ""; //產品系列ID
                                        x.MO501 = 0; //GROSS_DIE
                                        x.MO502 = ""; //說明1
                                        x.MO503 = ""; //說明2
                                        x.MO504 = ""; //光罩層次
                                        x.MO505 = ""; //進項稅別碼
                                        x.MO506 = ""; //銷項稅別碼
                                        x.MO507 = 0; //
                                        x.MO508 = 0; //
                                        x.MO545 = 0; //標準產出良率
                                        x.MO550 = ""; //產品屬性
                                        x.MO551 = ""; //Wafer型號
                                        x.MO552 = ""; //性質
                                        x.MO553 = ""; //版本
                                        x.MO554 = ""; //作業代號
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                    });
                                sql = @"INSERT INTO INVMO (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MO001, MO002, MO003, MO004, MO005, MO006, MO007, MO008, MO009, MO010
                                            , MO011, MO012, MO013, MO014, MO015, MO016, MO017, MO018, MO019, MO020
                                            , MO021, MO022, MO023, MO024, MO025, MO026, MO027, MO028, MO029, MO030
                                            , MO031, MO032, MO033, MO034, MO035, MO036, MO037, MO038, MO039, MO040
                                            , MO041, MO042, MO043, MO044, MO045, MO046, MO047, MO048, MO049, MO050
                                            , MO051, MO052, MO053, MO054, MO055, MO056, MO057, MO058, MO059, MO060
                                            , MO061, MO062, MO063, MO064, MO065, MO066, MO067, MO068, MO069, MO070
                                            , MO071, MO072, MO073, MO074, MO075, MO076, MO077, MO078, MO079, MO080
                                            , MO081, MO082, MO083, MO084, MO085, MO086, MO087, MO088, MO089, MO090
                                            , MO091, MO092, MO093, MO094, MO095, MO096, MO097, MO098, MO099, MO100
                                            , MO101, MO102, MO103, MO104, MO105, MO106, MO107, MO108, MO109, MO110
                                            , MO111, MO112, MO113, MO114, MO115, MO116, MO117, MO118, MO119, MO120
                                            , MO121, MO122, MO123, MO124, MO125, MO126, MO127, MO128, MO129, MO130
                                            , MO131, MO132, MO133, MO134, MO135, MO136, MO137, MO138, MO139, MO140
                                            , MO141, MO142, MO143, MO144, MO145, MO146, MO147, MO148, MO149, MO150
                                            , MO151, MO152, MO153, MO154, MO155, MO156, MO157, MO158, MO159, MO160
                                            , MO161, MO162, MO163, MO164, MO165, MO166, MO167, MO168, MO169, MO170
                                            , MO171, MO172, MO173, MO174, MO175, MO176, MO177, MO178, MO179, MO180
                                            , MO181, MO182, MO183, MO184, MO185, MO186, MO187, MO188, MO189, MO190
                                            , MO191, MO192, MO193, MO194, MO195, MO196, MO197, MO198, MO199, MO500
                                            , MO501, MO502, MO503, MO504, MO505, MO506, MO507, MO508
                                            , MO545, MO550, MO551, MO552, MO553, MO554
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MO001, @MO002, @MO003, @MO004, @MO005, @MO006, @MO007, @MO008, @MO009, @MO010
                                            , @MO011, @MO012, @MO013, @MO014, @MO015, @MO016, @MO017, @MO018, @MO019, @MO020
                                            , @MO021, @MO022, @MO023, @MO024, @MO025, @MO026, @MO027, @MO028, @MO029, @MO030
                                            , @MO031, @MO032, @MO033, @MO034, @MO035, @MO036, @MO037, @MO038, @MO039, @MO040
                                            , @MO041, @MO042, @MO043, @MO044, @MO045, @MO046, @MO047, @MO048, @MO049, @MO050
                                            , @MO051, @MO052, @MO053, @MO054, @MO055, @MO056, @MO057, @MO058, @MO059, @MO060
                                            , @MO061, @MO062, @MO063, @MO064, @MO065, @MO066, @MO067, @MO068, @MO069, @MO070
                                            , @MO071, @MO072, @MO073, @MO074, @MO075, @MO076, @MO077, @MO078, @MO079, @MO080
                                            , @MO081, @MO082, @MO083, @MO084, @MO085, @MO086, @MO087, @MO088, @MO089, @MO090
                                            , @MO091, @MO092, @MO093, @MO094, @MO095, @MO096, @MO097, @MO098, @MO099, @MO100
                                            , @MO101, @MO102, @MO103, @MO104, @MO105, @MO106, @MO107, @MO108, @MO109, @MO110
                                            , @MO111, @MO112, @MO113, @MO114, @MO115, @MO116, @MO117, @MO118, @MO119, @MO120
                                            , @MO121, @MO122, @MO123, @MO124, @MO125, @MO126, @MO127, @MO128, @MO129, @MO130
                                            , @MO131, @MO132, @MO133, @MO134, @MO135, @MO136, @MO137, @MO138, @MO139, @MO140
                                            , @MO141, @MO142, @MO143, @MO144, @MO145, @MO146, @MO147, @MO148, @MO149, @MO150
                                            , @MO151, @MO152, @MO153, @MO154, @MO155, @MO156, @MO157, @MO158, @MO159, @MO160
                                            , @MO161, @MO162, @MO163, @MO164, @MO165, @MO166, @MO167, @MO168, @MO169, @MO170
                                            , @MO171, @MO172, @MO173, @MO174, @MO175, @MO176, @MO177, @MO178, @MO179, @MO180
                                            , @MO181, @MO182, @MO183, @MO184, @MO185, @MO186, @MO187, @MO188, @MO189, @MO190
                                            , @MO191, @MO192, @MO193, @MO194, @MO195, @MO196, @MO197, @MO198, @MO199, @MO500
                                            , @MO501, @MO502, @MO503, @MO504, @MO505, @MO506, @MO507, @MO508
                                            , @MO545, @MO550, @MO551, @MO552, @MO553, @MO554
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                rowsAffected += sqlConnection.Execute(sql, newMtlItems);
                                #endregion
                                break;
                            case "Y":
                            default:
                                throw new SystemException("品號拋轉狀態錯誤!");
                        }
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //回寫品號資料 - 拋轉狀態和時間
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItem SET
                                TransferStatus = @TransferStatus,
                                TransferDate = @TransferDate,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                TransferStatus = "Y",
                                TransferDate = dateNow,
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemId
                            });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }
                    #endregion

                    #region //判斷品號是否拋轉完成
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemNo, TransferStatus
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId 
                                AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("【品號】資料錯誤!");
                        if (result.Any(a => a.TransferStatus == "N")) throw new SystemException("【品號】拋轉未完成!");
                    }
                    #endregion

                    #region //BOM拋轉處理 Transfer
                    List<BOMMC> billOfMaterials = new List<BOMMC>();
                    List<BOMMD> bomDetail = new List<BOMMD>();
                    string bomMtlItemNo = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //取得BOM主件資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MtlItemNo MC001, c.UomNo MC002, a.StandardLot MC004, a.WipPrefix MC005
                                , a.ModiPrefix MC006, a.ModiNo MC007, a.ModiSequence MC008, a.Version MC009
                                , a.Remark MC010, a.ConfirmStatus MC016, a.TransferStatus
                                FROM PDM.BillOfMaterials a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId
                                LEFT JOIN PDM.UnitOfMeasure c ON a.UomId = c.UomId
                                WHERE a.MtlItemId = @MtlItemId
                                AND b.CompanyId = @CompanyId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        billOfMaterials = sqlConnection.Query<BOMMC>(sql, dynamicParameters).ToList();
                        billOfMaterials.ForEach(item =>
                        {
                            bomMtlItemNo = item.MC001;
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.MC018 = userNo;
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion

                        #region //取得BOM元件資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT c.MtlItemNo MD001, a.BomSequence MD002, d.MtlItemNo MD003, e.UomNo MD004
                                , a.CompositionQuantity MD006, a.Base MD007, a.LossRate MD008
                                , ISNULL(FORMAT(a.EffectiveDate, 'yyyyMMdd'),'') MD011, ISNULL(FORMAT(a.ExpirationDate, 'yyyyMMdd'),'') MD012
                                , a.Remark MD016,a.StandardCostingType MD014,a.MaterialProperties MD017, a.ComponentType UDF01
                                FROM PDM.BomDetail a
                                INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                                INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId
                                INNER JOIN PDM.MtlItem d ON d.MtlItemId = a.MtlItemId
                                INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.UomId
                                WHERE b.MtlItemId = @MtlItemId
                                AND d.CompanyId = @CompanyId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        bomDetail = sqlConnection.Query<BOMMD>(sql, dynamicParameters).ToList();
                        bomDetail.ForEach(item =>
                        {
                            if (item.MD003 == bomMtlItemNo) throw new SystemException("BOM主件品號和元件品號不能相同，請重新確認!");
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    if (billOfMaterials.Count() > 0 && bomDetail.Count() > 0) //有資料才進ERP資料庫
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷ERP使用者是否有權限 (停用) Function=BOMI02, Auth=Y_______Y___
                            //if (adminUser != "Y")
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"SELECT TOP 1 MG006
                            //            FROM ADMMG
                            //            WHERE COMPANY = @CompanyNo
                            //            AND MG001 = @UserNo
                            //            AND MG002 = @Function
                            //            AND MG004 = 'Y'
                            //            AND MG006 LIKE @Auth";
                            //    dynamicParameters.Add("CompanyNo", companyNo);
                            //    dynamicParameters.Add("UserNo", userNo);
                            //    dynamicParameters.Add("Function", "BOMI02");
                            //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                            //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                            //    if (!resultUserAuthExist.Any()) throw new SystemException("BOM拋轉-【ERP使用者】無權限!");
                            //}
                            #endregion

                            #region //判斷BOM主件是否重複 BOMMC
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MC001)) AS MC001
                                    FROM BOMMC 
                                    WHERE COMPANY = @CompanyNo AND MC001 IN @MC001s";
                            dynamicParameters.Add("CompanyNo", companyNo);
                            dynamicParameters.Add("MC001s", billOfMaterials.Select(s => s.MC001).Distinct().ToArray());
                            var resultBOMMC = sqlConnection.Query(sql, dynamicParameters);
                            string[] existBOMMC = resultBOMMC.Select(s => { return (string)s.MC001; }).Distinct().ToArray();
                            if (existBOMMC.Any())
                            {
                                throw new SystemException("ERP已存在以下主件</br>" + string.Join("</br>", existBOMMC));
                            }
                            #endregion

                            #region //主件新增 BOMMC from billOfMaterials
                            billOfMaterials
                                .ForEach(x =>
                                {
                                    var bommc = resultBOMMC.FirstOrDefault(f => f.MC001 == x.MC001);
                                    if (x.TransferStatus == "Y" && bommc == null) throw new SystemException(string.Format(@"MES BOM主件{0}狀態已拋轉，但ERP沒有資料。", x.MC001));
                                    if (bommc == null)
                                    {
                                        x.MC003 = "";
                                        x.MC011 = 0;
                                        x.MC012 = 0;
                                        x.MC013 = "";
                                        x.MC014 = "";
                                        x.MC015 = "";
                                        x.MC016 = "Y";
                                        x.MC017 = dateNow;
                                        x.MC019 = "N";
                                        x.MC020 = 0;
                                        x.MC021 = 0;
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                        sql = @"INSERT INTO BOMMC (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                                , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                                , MC001, MC002, MC003, MC004, MC005, MC006, MC007, MC008, MC009, MC010
                                                , MC011, MC012, MC013, MC014, MC015, MC016, MC017, MC018, MC019, MC020
                                                , MC021
                                                , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                                , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                                , @MC001, @MC002, @MC003, @MC004, @MC005, @MC006, @MC007, @MC008, @MC009, @MC010
                                                , @MC011, @MC012, @MC013, @MC014, @MC015, @MC016, @MC017, @MC018, @MC019, @MC020
                                                , @MC021
                                                , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        rowsAffected += sqlConnection.Execute(sql, x);
                                    }
                                    else { /*更新處理(由ERP代為編輯處理)*/ }
                                });
                            #endregion

                            #region //判斷BOM元件是否重複 BOMMD
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MD001)) AS MD001, LTRIM(RTRIM(MD003)) AS MD003
                                    FROM BOMMD
                                    WHERE COMPANY = @CompanyNo 
                                    AND MD001 IN @MD001s 
                                    AND MD003 IN @MD003s";
                            dynamicParameters.Add("CompanyNo", companyNo);
                            dynamicParameters.Add("MD001s", billOfMaterials.Select(s => s.MC001).Distinct().ToArray());
                            dynamicParameters.Add("MD003s", bomDetail.Select(s => s.MD003).Distinct().ToArray());
                            var resultBOMMD = sqlConnection.Query(sql, dynamicParameters);
                            var existBOMMD = resultBOMMD.Select(s => new { s.MD001, s.MD003 }).Distinct().ToArray();
                            if (existBOMMD.Any())
                            {
                                throw new SystemException("ERP已存在以下元件</br>" + string.Join("</br>", existBOMMD.Select(s => s.MD003).Distinct().ToArray()));
                            }
                            #endregion

                            #region //元件新增 BOMMD from bomDetail
                            bomDetail
                                .ForEach(x =>
                                {
                                    var bommd = resultBOMMD.FirstOrDefault(f => f.MD001 == x.MD001 && f.MD003 == x.MD003);
                                    if (bommd == null)
                                    {
                                        x.MD005 = "";
                                        x.MD009 = "****";
                                        x.MD010 = "1";
                                        x.MD013 = "N";
                                        x.MD015 = "";
                                        x.MD018 = 0;
                                        x.MD019 = "";
                                        x.MD020 = "";
                                        x.MD021 = "";
                                        x.MD022 = "";
                                        x.MD023 = "";
                                        x.MD024 = "";
                                        x.MD025 = "";
                                        x.MD026 = "";
                                        x.MD027 = 0;
                                        x.MD028 = 0;
                                        x.MD029 = "Y";
                                        x.MD030 = "";
                                        x.MD031 = "";
                                        x.MD032 = "Y";
                                        //x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                        sql = @"INSERT INTO BOMMD (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                                , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                                , MD001, MD002, MD003, MD004, MD005, MD006, MD007, MD008, MD009, MD010
                                                , MD011, MD012, MD013, MD014, MD015, MD016, MD017, MD018, MD019, MD020
                                                , MD021, MD022, MD023, MD024, MD025, MD026, MD027, MD028, MD029, MD030
                                                , MD031, MD032
                                                , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                                VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                                , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                                , @MD001, @MD002, @MD003, @MD004, @MD005, @MD006, @MD007, @MD008, @MD009, @MD010
                                                , @MD011, @MD012, @MD013, @MD014, @MD015, @MD016, @MD017, @MD018, @MD019, @MD020
                                                , @MD021, @MD022, @MD023, @MD024, @MD025, @MD026, @MD027, @MD028, @MD029, @MD030
                                                , @MD031, @MD032
                                                , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        rowsAffected += sqlConnection.Execute(sql, x);
                                    }
                                    else { /*更新處理(由ERP代為編輯處理)*/ }
                                });
                            #endregion
                        }

                        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                        {
                            #region//回寫主件確認狀態、拋轉狀態及時間
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.BillOfMaterials SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    ConfirmDate = @ConfirmDate,
                                    TransferStatus = @TransferStatus,
                                    TransferDate = @TransferDate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy 
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "Y",
                                    ConfirmUserId = CurrentUser,
                                    ConfirmDate = dateNow,
                                    TransferStatus = "Y",
                                    TransferDate = dateNow,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlItemId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region//回寫元件資料、拋轉狀態和時間
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE a SET
                                    a.ConfirmStatus = @ConfirmStatus,
                                    a.LastModifiedDate = @LastModifiedDate,
                                    a.LastModifiedBy = @LastModifiedBy
                                    FROM PDM.BomDetail a
                                    INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId 
                                    WHERE b.MtlItemId = @MtlItemId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "Y",
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlItemId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                    }
                    #endregion

                    #region //部番拋轉處理 Transfer
                    List<COPMG> customerMtlItems = new List<COPMG>();

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //取得客戶品號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.CustomerMtlItemId, b.CustomerNo MG001, c.MtlItemNo MG002, a.CustomerMtlItemNo MG003
                                , a.CustomerMtlItemName MG005, a.CustomerMtlItemSpec MG006, a.TransferStatus
                                FROM PDM.CustomerMtlItem a
                                LEFT JOIN SCM.Customer b ON b.CustomerId = a.CustomerId
                                LEFT JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                                WHERE c.CompanyId = @CompanyId
                                AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        customerMtlItems = sqlConnection.Query<COPMG>(sql, dynamicParameters).ToList();
                        customerMtlItems.ForEach(item => {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    if (customerMtlItems.Count() > 0) //有資料才進ERP資料庫
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷ERP使用者是否有權限 (停用) Function=COPI10, Auth=Y_______Y___
                            //if (adminUser != "Y")
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"SELECT TOP 1 MG006
                            //            FROM ADMMG
                            //            WHERE COMPANY = @CompanyNo
                            //            AND MG001 = @UserNo
                            //            AND MG002 = @Function
                            //            AND MG004 = 'Y'
                            //            AND MG006 LIKE @Auth";
                            //    dynamicParameters.Add("CompanyNo", companyNo);
                            //    dynamicParameters.Add("UserNo", userNo);
                            //    dynamicParameters.Add("Function", "COPI10");
                            //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                            //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                            //    if (!resultUserAuthExist.Any()) throw new SystemException("部番拋轉-【ERP使用者】無權限!");
                            //}
                            #endregion

                            #region //判斷部番是否重複 COPMG
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MG001)) AS MG001,LTRIM(RTRIM(MG002)) AS MG002,LTRIM(RTRIM(MG003)) AS MG003,LTRIM(RTRIM(MG005)) AS MG005
                                    FROM COPMG a
                                    WHERE COMPANY = @CompanyNo 
                                    AND a.MG001 IN @MG001s
                                    AND a.MG002 = @MtlItemNo
                                    AND a.MG003 IN @MG003s";
                            dynamicParameters.Add("CompanyNo", companyNo);
                            dynamicParameters.Add("MG001s", customerMtlItems.Select(s => s.MG001).Distinct().ToArray());
                            dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            dynamicParameters.Add("MG003s", customerMtlItems.Select(s => s.MG003).Distinct().ToArray());
                            var resultCOPMG = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //客戶品號新增 COPMG from customerMtlItems
                            customerMtlItems
                                .ForEach(x =>
                                {
                                    var copmg = resultCOPMG.FirstOrDefault(f => f.MG001 == x.MG001 && f.MG003 == x.MG003);
                                    if (x.TransferStatus == "Y" && copmg == null) throw new SystemException(string.Format(@"MES客戶品號{0}狀態已拋轉，但ERP沒有資料。", x.MG003));
                                    if (copmg == null)
                                    {
                                        x.MG004 = "";
                                        x.MG007 = 0;
                                        x.MG008 = 0;
                                        x.MG009 = "";
                                        x.MG010 = "";
                                        x.MG011 = "";
                                        x.MG012 = 0;
                                        x.MG013 = 0;
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                        sql = @"INSERT INTO COPMG (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MG001, MG002, MG003, MG004, MG005, MG006, MG007, MG008, MG009, MG010
                                            , MG011, MG012, MG013
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MG001, @MG002, @MG003, @MG004, @MG005, @MG006, @MG007, @MG008, @MG009, @MG010
                                            , @MG011, @MG012, @MG013
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        rowsAffected += sqlConnection.Execute(sql, x);
                                    }
                                    else { /*更新處理(由ERP代為編輯處理)*/ }
                                });
                            #endregion
                        }

                        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                        {
                            #region //回寫部番資料 - 拋轉狀態和時間
                            customerMtlItems
                                .ForEach(item =>
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE a SET
                                        a.TransferStatus = @TransferStatus,
                                        a.TransferDate = @LastModifiedDate,
                                        a.LastModifiedDate = @LastModifiedDate,
                                        a.LastModifiedBy = @LastModifiedBy
                                        FROM PDM.CustomerMtlItem a
                                        WHERE a.CustomerMtlItemId = @CustomerMtlItemId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          TransferStatus = 'Y',
                                          TransferDate = dateNow,
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          item.CustomerMtlItemId
                                      });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                });
                            #endregion
                        }
                    }
                    #endregion

                    #region //取替代料拋轉處理 Transfer
                    List<BOMMA> bomSubstitution = new List<BOMMA>();
                    List<BOMMB> bomSubstitutionDetail = new List<BOMMB>();

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //取得替代料單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT 
                                b1.MtlItemNo MA001,c1.MtlItemNo MA002,a.SubstituteStatus MA003
                                ,a.TransferStatus
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                INNER JOIN PDM.MtlItem b1 on b.MtlItemId = b1.MtlItemId
                                INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
                                WHERE c1.CompanyId = @CompanyId
                                AND c.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        bomSubstitution = sqlConnection.Query<BOMMA>(sql, dynamicParameters).ToList();
                        bomSubstitution.ForEach(item =>
                        {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion

                        #region //取得替代料單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT a.SubstitutionId
                                ,b1.MtlItemNo MB001,c1.MtlItemNo MB002,a.SubstituteStatus MB003,a1.MtlItemNo MB004,a.Quantity MB005
                                ,ISNULL(FORMAT(a.EffectiveDate, 'yyyyMMdd'),'') MB006,ISNULL(FORMAT(a.ExpirationDate, 'yyyyMMdd'),'') MB007,a.Remark MB008,a.SortNumber MB009,a.Precedence MB010
                                ,a.TransferStatus
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                INNER JOIN PDM.MtlItem b1 on b.MtlItemId = b1.MtlItemId
                                INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
                                WHERE c1.CompanyId = @CompanyId
                                AND c.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        bomSubstitutionDetail = sqlConnection.Query<BOMMB>(sql, dynamicParameters).ToList();
                        bomSubstitutionDetail.ForEach(item =>
                        {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    if (bomSubstitution.Count() > 0 && bomSubstitutionDetail.Count() > 0) //有資料才進ERP資料庫
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷ERP使用者是否有權限 (停用) Function=BOMI01, Auth=Y_______Y___
                            //if (adminUser != "Y")
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"SELECT TOP 1 MG006
                            //            FROM ADMMG
                            //            WHERE COMPANY = @CompanyNo
                            //            AND MG001 = @UserNo
                            //            AND MG002 = @Function
                            //            AND MG004 = 'Y'
                            //            AND MG006 LIKE @Auth";
                            //    dynamicParameters.Add("CompanyNo", companyNo);
                            //    dynamicParameters.Add("UserNo", userNo);
                            //    dynamicParameters.Add("Function", "BOMI01");
                            //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                            //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                            //    if (resultUserAuthExist.Count() <= 0) throw new SystemException("取替代料拋轉-【ERP使用者】無權限!");
                            //}
                            #endregion

                            #region //判斷取替代料是否重複 BOMMA
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MA001)) AS MA001
                                    , LTRIM(RTRIM(MA002)) AS MA002
                                    , LTRIM(RTRIM(MA003)) AS MA003
                                    FROM BOMMA
                                    WHERE COMPANY = @CompanyNo
                                    AND MA002 = @MtlItemNo 
                                    AND MA001 IN @MA001s";
                            dynamicParameters.Add("CompanyNo", companyNo);
                            dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            dynamicParameters.Add("MA001s", bomSubstitution.Select(s => s.MA001).Distinct().ToArray());
                            var resultBOMMA = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //主件新增
                            bomSubstitution
                                .ForEach(x =>
                                {
                                    var bomma = resultBOMMA.FirstOrDefault(f => f.MA001 == x.MA001 && f.MA003 == x.MA003);
                                    if (x.TransferStatus == "Y" && bomma == null) throw new SystemException(string.Format(@"MES{1}料{0}狀態已拋轉，但ERP沒有資料。", x.MA003, x.MA003 == "2" ? "取代" : "替代"));
                                    if (bomma == null)
                                    {
                                        x.MA004 = "";
                                        x.MA005 = 0;
                                        x.MA006 = 0;
                                        x.MA007 = "";
                                        x.MA008 = "";
                                        x.MA009 = "";
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                        sql = @"INSERT INTO BOMMA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MA001, MA002, MA003, MA004, MA005, MA006, MA007, MA008, MA009
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MA001, @MA002, @MA003, @MA004, @MA005, @MA006, @MA007, @MA008, @MA009
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        rowsAffected += sqlConnection.Execute(sql, x);
                                    }
                                    else { /*更新處理(由ERP代為編輯處理)*/ }
                                });
                            #endregion

                            #region //取得ERP取替代元件資料 BOMMB
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MB001)) AS MB001
                                    , LTRIM(RTRIM(MB002)) AS MB002
                                    , LTRIM(RTRIM(MB003)) AS MB003
                                    , LTRIM(RTRIM(MB004)) AS MB004
                                    , LTRIM(RTRIM(MB009)) AS MB009
                                    FROM BOMMB
                                    WHERE COMPANY = @CompanyNo
                                    AND MB002 = @MtlItemNo
                                    AND MB001 IN @MB001s";
                            dynamicParameters.Add("CompanyNo", companyNo);
                            dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            dynamicParameters.Add("MB001s", bomSubstitutionDetail.Select(s => s.MB001).Distinct().ToArray());
                            var resultBOMMB = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //元件新增
                            bomSubstitutionDetail
                                .ForEach(x =>
                                {
                                    var bommb = resultBOMMB.FirstOrDefault(f => f.MB001 == x.MB001 && f.MB003 == x.MB003 && f.MB009 == x.MB009);
                                    if (x.TransferStatus == "Y" && bommb == null) throw new SystemException(string.Format(@"MES{1}料 {0}-{2}狀態已拋轉，但ERP沒有資料。", x.MB003, x.MB003 == "2" ? "取代" : "替代", x.MB003));
                                    if (bommb == null)
                                    {
                                        x.MB006 = x.MB006 ?? "";
                                        x.MB007 = x.MB007 ?? "";
                                        x.MB011 = 0;
                                        x.MB012 = 0;
                                        x.MB013 = "";
                                        x.MB014 = "";
                                        x.MB015 = "";
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                        sql = @"INSERT INTO BOMMB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                                , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                                , MB001, MB002, MB003, MB004, MB005, MB006, MB007, MB008, MB009, MB010
                                                , MB011, MB012, MB013, MB014, MB015
                                                , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                                VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                                , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                                , @MB001, @MB002, @MB003, @MB004, @MB005, @MB006, @MB007, @MB008, @MB009, @MB010
                                                , @MB011, @MB012, @MB013, @MB014, @MB015
                                                , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        rowsAffected += sqlConnection.Execute(sql, x);
                                    }
                                    else { /*更新處理(由ERP代為編輯處理)*/ }
                                });
                            #endregion
                        }

                        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                        {
                            #region //回寫取替代料 - 拋轉狀態和時間
                            bomSubstitutionDetail
                                .ForEach(item =>
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE a SET
                                            a.TransferStatus=@TransferStatus,
                                            a.TransferDate=@TransferDate,
                                            a.LastModifiedDate=@LastModifiedDate,
                                            a.LastModifiedBy=@LastModifiedBy 
                                            FROM PDM.BomSubstitution a
                                            WHERE a.SubstitutionId = @SubstitutionId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            TransferStatus = "Y",
                                            TransferDate = dateNow,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            item.SubstitutionId
                                        });
                                    rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                });
                            #endregion
                        }
                    }
                    #endregion

                    #region //單位換算拋轉處理 Transfer
                    List<INVMD> mtlItemUomCalculates = new List<INVMD>();

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //取得品號單位換算資料
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.MtlItemUomCalculateId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @", a.MtlItemId,b.MtlItemNo MD001
                              , a.UomId, c.UomNo
                              , a.ConvertUomId, d.UomNo MD002
                              , a.SwapDenominator MD004,a.SwapNumerator MD003
                              , a.TransferStatus
                              , b.CompanyId";
                        sqlQuery.mainTables =
                            @"FROM PDM.MtlItemUomCalculate a
                              INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                              INNER JOIN PDM.UnitOfMeasure c ON a.UomId = c.UomId
                              INNER JOIN PDM.UnitOfMeasure d ON a.ConvertUomId = d.UomId";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND b.CompanyId = @CompanyId AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = "";
                        mtlItemUomCalculates = BaseHelper.SqlQuery<INVMD>(sqlConnection, dynamicParameters, sqlQuery).ToList();
                        mtlItemUomCalculates.ForEach(item => {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    if (mtlItemUomCalculates.Count() > 0) //有資料才進ERP資料庫
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷ERP使用者是否有權限 (停用) Function=INVI25, Auth=Y_______Y___
                            //if (adminUser != "Y")
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"SELECT TOP 1 MG006
                            //        FROM ADMMG
                            //        WHERE COMPANY = @CompanyNo
                            //        AND MG001 = @UserNo
                            //        AND MG002 = @Function
                            //        AND MG004 = 'Y'
                            //        AND MG006 LIKE @Auth";
                            //    dynamicParameters.Add("CompanyNo", companyNo);
                            //    dynamicParameters.Add("UserNo", userNo);
                            //    dynamicParameters.Add("Function", "INVI25");
                            //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                            //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                            //    if (resultUserAuthExist.Count() <= 0) throw new SystemException("單位換算拋轉-【ERP使用者】無權限!");
                            //}
                            #endregion

                            #region //判斷單位換算是否重複 INVMD
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(MD001)) AS MD001, LTRIM(RTRIM(MD002)) AS MD002
                                    FROM INVMD
                                    WHERE COMPANY = @CompanyNo 
                                    AND MD001 = @MtlItemNo
                                    AND MD002 IN @MD002s";
                            dynamicParameters.Add("CompanyNo", companyNo);
                            dynamicParameters.Add("MtlItemNo", mtlItemNo);
                            dynamicParameters.Add("@MD002s", mtlItemUomCalculates.Select(s => s.MD002).Distinct().ToArray());
                            var resultINVMD = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            #region //單位換算表新增 INVMD from mtlItemUomCalculates
                            mtlItemUomCalculates
                                .ForEach(x =>
                                {
                                    var invmd = resultINVMD.FirstOrDefault(f => f.MD001 == x.MD001 && f.MD002 == x.MD002);
                                    if (x.TransferStatus == "Y" && invmd == null) throw new SystemException(string.Format(@"MES單位換算{0}狀態已拋轉，但ERP沒有資料。", x.MD001));
                                    if (invmd == null)
                                    {
                                        x.MD005 = 0.000000;
                                        x.MD006 = 0.000000;
                                        x.MD007 = "";
                                        x.MD008 = "";
                                        x.MD009 = "";
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0.000000;
                                        x.UDF07 = 0.000000;
                                        x.UDF08 = 0.000000;
                                        x.UDF09 = 0.000000;
                                        x.UDF10 = 0.000000;
                                        sql = @"INSERT INTO INVMD (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, 
                                            CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, MD001, MD002, MD003, MD004, MD005, MD006, MD007, MD008, MD009,
                                            UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, @CREATE_AP,
                                            @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @MD001, @MD002, @MD003, @MD004, @MD005, @MD006, @MD007, @MD008, @MD009,
                                            @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        rowsAffected += sqlConnection.Execute(sql, x);
                                    }
                                    else { /*更新處理(由ERP代為編輯處理)*/ }
                                });
                            #endregion
                        }

                        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                        {
                            #region //回寫單位換算資料 - 拋轉狀態和時間
                            mtlItemUomCalculates
                                .ForEach(item => {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE a SET
                                            a.TransferStatus = @TransferStatus,
                                            a.TransferDate = @LastModifiedDate,
                                            a.LastModifiedDate = @LastModifiedDate,
                                            a.LastModifiedBy = @LastModifiedBy
                                            FROM PDM.MtlItemUomCalculate a
                                            WHERE a.MtlItemUomCalculateId = @MtlItemUomCalculateId";
                                    dynamicParameters.AddDynamicParams(
                                      new
                                      {
                                          TransferStatus = 'Y',
                                          TransferDate = dateNow,
                                          LastModifiedDate,
                                          LastModifiedBy,
                                          item.MtlItemUomCalculateId
                                      });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                });
                            #endregion

                            #region //寫入單位換算Log紀錄
                            List<MtlItemUomCalculate> mtlItemUomCalculateList = new List<MtlItemUomCalculate>();
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT *
                                    --MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomId, SwapDenominator, SwapNumerator, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy
                                    FROM PDM.MtlItemUomCalculate
                                    WHERE MtlItemUomCalculateId IN @MtlItemUomCalculateId";
                            dynamicParameters.Add("MtlItemUomCalculateId", mtlItemUomCalculates.Select(s => s.MtlItemUomCalculateId).Distinct());
                            mtlItemUomCalculateList = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                            mtlItemUomCalculateList.ForEach(item => {
                                item.TransactionType = "T";
                                item.TransactionUserId = CurrentUser;
                                item.TransactionDate = CreateDate;
                                item.CreateDate = CreateDate;
                                item.LastModifiedDate = LastModifiedDate;
                                item.CreateBy = CreateBy;
                                item.LastModifiedBy = LastModifiedBy;
                                sql = @"INSERT INTO PDM.MtlItemUomCalculateLog (TransactionType, MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomIdBefore, 
                                        SwapDenominatorBefore, SwapNumeratorBefore, ConvertUomId, SwapDenominator, SwapNumerator, TransactionUserId, 
                                        TransactionDate, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@TransactionType, @MtlItemUomCalculateId, @MtlItemId, @UomId, @ConvertUomIdBefore,
                                        @SwapDenominatorBefore, @SwapNumeratorBefore, @ConvertUomId, @SwapDenominator, @SwapNumerator, @TransactionUserId,
                                        @TransactionDate, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                rowsAffected += sqlConnection.Execute(sql, item);
                            });
                            #endregion
                        }
                    }

                    #endregion

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion
                    transactionScope.Complete();
                }

            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomToERP -- Bom資料拋轉ERP -- Zoey 2022.12.12 
        public string UpdateBomToERP(int MtlItemId, int BomId)
        {
            try
            {
                if (MtlItemId < 0) throw new SystemException("BOM資料拋轉-【品號】資料錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    List<BOMMC> billOfMaterials = new List<BOMMC>();
                    List<BOMMD> bomDetail = new List<BOMMD>();

                    int rowsAffected = 0;
                    string dateNow = CreateDate.ToString("yyyyMMdd"), timeNow = CreateDate.ToString("HH:mm:ss"), errorMsg = "";
                    string bomConfirmStatus = "", mtlItemTransferStatus = "", bomTransferStatus = "", companyNo = "", departmentNo = "", userNo = "", userName = "", userGroup = "";  //, Factory = "";
                    string bomMtlItemNo = "", bomDetailMtlItemNo = "", mtlItemNo = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemNo, TransferStatus
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId 
                                AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("BOM資料拋轉-【品號】資料錯誤!");
                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo;
                            mtlItemTransferStatus = item.TransferStatus;
                        }
                        #region //判斷拋轉狀態
                        if (mtlItemTransferStatus == "N") throw new SystemException("【品號】資料尚未拋轉!");
                        #endregion
                        #endregion

                        #region //判斷BOM主件資料是否正確 230918
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.BomId, a.ConfirmStatus as BomConfirmStatus, b.TransferStatus as MtlItemTransferStatus, a.TransferStatus as BomTransferStatus, a.MtlItemId
                                FROM PDM.BillOfMaterials a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId
                                WHERE b.CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemId", @" AND b.MtlItemId = @MtlItemId", MtlItemId);
                        BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "BomId", @" AND a.BomId = @BomId", BomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        //if (!resultBom.Any()) throw new SystemException("【BOM主件】資料錯誤!");
                        if (result.Any())
                        {
                            foreach (var item in result)
                            {
                                BomId = item.BomId; //重新指派BomId
                                bomConfirmStatus = item.BomConfirmStatus;
                                bomTransferStatus = item.BomTransferStatus; //BOM拋轉狀態
                                mtlItemTransferStatus = item.MtlItemTransferStatus; //品號拋轉狀態
                            }
                            #region //判斷拋轉狀態
                            if (mtlItemTransferStatus == "N") throw new SystemException("【品號】資料尚未拋轉!");
                            if (bomConfirmStatus != "N") throw new SystemException("【BOM主件】為確認狀態，無法拋轉!");
                            if (bomTransferStatus != "N") throw new SystemException("【BOM主件】目前資料皆已完成拋轉!");
                            #endregion
                        }
                        #endregion

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItem");
                        dynamicParameters.Add("DetailCode", "data-transfer");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //取得BOM主件資料
                        sql = @"SELECT b.MtlItemNo MC001, c.UomNo MC002, a.StandardLot MC004, a.WipPrefix MC005
                                , a.ModiPrefix MC006, a.ModiNo MC007, a.ModiSequence MC008, a.Version MC009
                                , a.Remark MC010, a.ConfirmStatus MC016, a.TransferStatus
                                FROM PDM.BillOfMaterials a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId
                                LEFT JOIN PDM.UnitOfMeasure c ON a.UomId = c.UomId
                                WHERE a.BomId = @BomId
                                AND b.CompanyId = @CompanyId";
                        dynamicParameters.Add("BomId", BomId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        //result = sqlConnection.Query(sql, dynamicParameters);
                        //foreach (var item in result)
                        //{
                        //    bomMtlItemNo = item.MC001;
                        //}
                        billOfMaterials = sqlConnection.Query<BOMMC>(sql, dynamicParameters).ToList();
                        billOfMaterials.ForEach(item =>
                        {
                            bomMtlItemNo = item.MC001;
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.MC018 = userNo;
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion

                        #region //取得BOM元件資料
                        sql = @"SELECT c.MtlItemNo MD001, a.BomSequence MD002, d.MtlItemNo MD003, e.UomNo MD004
                                , a.CompositionQuantity MD006, a.Base MD007, a.LossRate MD008
                                , ISNULL(FORMAT(a.EffectiveDate, 'yyyyMMdd'),'') MD011, ISNULL(FORMAT(a.ExpirationDate, 'yyyyMMdd'),'') MD012
                                , a.Remark MD016,a.StandardCostingType MD014,a.MaterialProperties MD017, a.ComponentType UDF01
                                FROM PDM.BomDetail a
                                INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                                INNER JOIN PDM.MtlItem c ON c.MtlItemId = b.MtlItemId
                                INNER JOIN PDM.MtlItem d ON d.MtlItemId = a.MtlItemId
                                INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.UomId
                                WHERE a.BomId = @BomId
                                AND d.CompanyId = @CompanyId";
                        dynamicParameters.Add("BomId", BomId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        //var resultBomDetail = sqlConnection.Query(sql, dynamicParameters);
                        //foreach (var item in resultBomDetail)
                        //{
                        //    bomDetailMtlItemNo = item.MD003;
                        //    if (bomMtlItemNo == bomDetailMtlItemNo) throw new SystemException("BOM主件品號和元件品號不能相同，請重新確認!");
                        //}
                        bomDetail = sqlConnection.Query<BOMMD>(sql, dynamicParameters).ToList();
                        bomDetail.ForEach(item =>
                        {
                            if (item.MD003 == bomMtlItemNo) throw new SystemException("BOM主件品號和元件品號不能相同，請重新確認!");
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    if (bomDetail.Count() > 0)
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷ERP使用者是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MF004, MF005
                                    FROM ADMMF
                                    WHERE COMPANY = @CompanyNo
                                    AND MF001 = @userNo";
                            dynamicParameters.Add("CompanyNo", companyNo);
                            dynamicParameters.Add("userNo", userNo);
                            var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUserExist.Count() <= 0) throw new SystemException("BOM資料拋轉-【ERP使用者】不存在!");
                            string adminUser = "N";
                            foreach (var item in resultUserExist)
                            {
                                adminUser = item.MF005; //超級使用者
                                userGroup = item.MF004; //使用者群組
                            }
                            #endregion

                            #region //判斷ERP使用者是否有權限 (停用) Function=BOMI02, Auth=Y_______Y___
                            //if (adminUser != "Y")
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"SELECT TOP 1 MG006
                            //            FROM ADMMG
                            //            WHERE COMPANY = @CompanyNo
                            //            AND MG001 = @UserNo
                            //            AND MG002 = @Function
                            //            AND MG004 = 'Y'
                            //            AND MG006 LIKE @Auth";
                            //    dynamicParameters.Add("CompanyNo", companyNo);
                            //    dynamicParameters.Add("UserNo", userNo);
                            //    dynamicParameters.Add("Function", "BOMI02");
                            //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                            //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                            //    if (resultUserAuthExist.Count() <= 0) //throw new SystemException("【ERP使用者】無權限!");
                            //    {
                            //        #region //Response
                            //        jsonResponse = JObject.FromObject(new
                            //        {
                            //            status = "errorForDA",
                            //            route = "batch",
                            //            msg = "BOM資料拋轉-【ERP使用者】無權限!"
                            //        });
                            //        #endregion

                            //        return jsonResponse.ToString();
                            //    }
                            //}
                            #endregion

                            switch (bomTransferStatus)
                            {
                                case "N":
                                    #region //判斷BOM主件是否重複 BOMMC
                                    errorMsg = string.Empty;
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT LTRIM(RTRIM(MC001)) AS MC001
                                            FROM BOMMC 
                                            WHERE COMPANY = @CompanyNo AND MC001 IN @MC001s";
                                    dynamicParameters.Add("CompanyNo", companyNo);
                                    dynamicParameters.Add("MC001s", billOfMaterials.Select(s => s.MC001).Distinct().ToArray());
                                    var resultBOMMC = sqlConnection.Query(sql, dynamicParameters);
                                    string[] MC001s = resultBOMMC.Select(s => { return (string)s.MC001; }).Distinct().ToArray();
                                    if (MC001s.Any())
                                    {
                                        throw new SystemException("ERP已存在以下主件</br>" + string.Join("</br>", MC001s));
                                    }
                                    #endregion

                                    #region //主件新增 BOMMC from billOfMaterials
                                    billOfMaterials
                                        .ForEach(x =>
                                        {
                                            var bommc = resultBOMMC.FirstOrDefault(f => f.MC001 == x.MC001);
                                            if (bommc == null)
                                            {
                                                x.USR_GROUP = userGroup;
                                                x.MC003 = "";
                                                x.MC011 = 0;
                                                x.MC012 = 0;
                                                x.MC013 = "";
                                                x.MC014 = "";
                                                x.MC015 = "";
                                                x.MC016 = "Y";
                                                x.MC017 = dateNow;
                                                x.MC019 = "N";
                                                x.MC020 = 0;
                                                x.MC021 = 0;
                                                x.UDF01 = "";
                                                x.UDF02 = "";
                                                x.UDF03 = "";
                                                x.UDF04 = "";
                                                x.UDF05 = "";
                                                x.UDF06 = 0;
                                                x.UDF07 = 0;
                                                x.UDF08 = 0;
                                                x.UDF09 = 0;
                                                x.UDF10 = 0;
                                                sql = @"INSERT INTO BOMMC (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                                        , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                                        , MC001, MC002, MC003, MC004, MC005, MC006, MC007, MC008, MC009, MC010
                                                        , MC011, MC012, MC013, MC014, MC015, MC016, MC017, MC018, MC019, MC020
                                                        , MC021
                                                        , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                                        VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                                        , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                                        , @MC001, @MC002, @MC003, @MC004, @MC005, @MC006, @MC007, @MC008, @MC009, @MC010
                                                        , @MC011, @MC012, @MC013, @MC014, @MC015, @MC016, @MC017, @MC018, @MC019, @MC020
                                                        , @MC021
                                                        , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                                rowsAffected += sqlConnection.Execute(sql, x);
                                            }
                                            else
                                            {
                                                //更新處理(由ERP代為編輯處理)
                                            }
                                        });
                                    #endregion

                                    #region //判斷BOM元件是否重複 BOMMD
                                    errorMsg = string.Empty;
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT LTRIM(RTRIM(MD001)) AS MD001, LTRIM(RTRIM(MD003)) AS MD003
                                            FROM BOMMD
                                            WHERE COMPANY = @CompanyNo 
                                            AND MD001 IN @MD001s 
                                            AND MD003 IN @MD003s";
                                    dynamicParameters.Add("CompanyNo", companyNo);
                                    dynamicParameters.Add("MD001s", billOfMaterials.Select(s => s.MC001).Distinct().ToArray());
                                    dynamicParameters.Add("MD003s", bomDetail.Select(s => s.MD003).Distinct().ToArray());
                                    var resultBOMMD = sqlConnection.Query(sql, dynamicParameters);
                                    string[] MD003s = resultBOMMD.Select(s => { return (string)s.MD003; }).Distinct().ToArray();
                                    if (MD003s.Any())
                                    {
                                        throw new SystemException("ERP已存在以下元件</br>" + string.Join("</br>", MD003s));
                                    }
                                    #endregion

                                    #region //元件新增 BOMMD from bomDetail
                                    if (bomDetail.Count > 0)
                                    {
                                        bomDetail
                                            .ForEach(x =>
                                            {
                                                var bommd = resultBOMMD.FirstOrDefault(f => f.MD001 == x.MD001 && f.MD003 == x.MD003);
                                                if (bommd == null)
                                                {
                                                    x.USR_GROUP = userGroup;
                                                    x.MD005 = "";
                                                    x.MD009 = "****";
                                                    x.MD010 = "1";
                                                    x.MD013 = "N";
                                                    x.MD015 = "";
                                                    x.MD018 = 0;
                                                    x.MD019 = "";
                                                    x.MD020 = "";
                                                    x.MD021 = "";
                                                    x.MD022 = "";
                                                    x.MD023 = "";
                                                    x.MD024 = "";
                                                    x.MD025 = "";
                                                    x.MD026 = "";
                                                    x.MD027 = 0;
                                                    x.MD028 = 0;
                                                    x.MD029 = "Y";
                                                    x.MD030 = "";
                                                    x.MD031 = "";
                                                    x.MD032 = "Y";
                                                    //x.UDF01 = "";
                                                    x.UDF02 = "";
                                                    x.UDF03 = "";
                                                    x.UDF04 = "";
                                                    x.UDF05 = "";
                                                    x.UDF06 = 0;
                                                    x.UDF07 = 0;
                                                    x.UDF08 = 0;
                                                    x.UDF09 = 0;
                                                    x.UDF10 = 0;
                                                    sql = @"INSERT INTO BOMMD (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                                            , MD001, MD002, MD003, MD004, MD005, MD006, MD007, MD008, MD009, MD010
                                                            , MD011, MD012, MD013, MD014, MD015, MD016, MD017, MD018, MD019, MD020
                                                            , MD021, MD022, MD023, MD024, MD025, MD026, MD027, MD028, MD029, MD030
                                                            , MD031, MD032
                                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                                            VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                                            , @MD001, @MD002, @MD003, @MD004, @MD005, @MD006, @MD007, @MD008, @MD009, @MD010
                                                            , @MD011, @MD012, @MD013, @MD014, @MD015, @MD016, @MD017, @MD018, @MD019, @MD020
                                                            , @MD021, @MD022, @MD023, @MD024, @MD025, @MD026, @MD027, @MD028, @MD029, @MD030
                                                            , @MD031, @MD032
                                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                                    rowsAffected += sqlConnection.Execute(sql, x);
                                                }
                                                else
                                                {
                                                    //更新處理(由ERP代為編輯處理)
                                                }
                                            });
                                    }
                                    #endregion
                                    break;
                                case "Y":
                                    throw new SystemException("拋轉狀態錯誤!");
                                default:
                                    throw new SystemException("拋轉狀態錯誤!");
                            }
                        }

                        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                        {
                            #region//回寫主件確認狀態、拋轉狀態及時間
                            sql = @"UPDATE PDM.BillOfMaterials SET
                                    ConfirmStatus = @ConfirmStatus,
                                    ConfirmUserId = @ConfirmUserId,
                                    ConfirmDate = @ConfirmDate,
                                    TransferStatus = @TransferStatus,
                                    TransferDate = @TransferDate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy 
                                    WHERE BomId = @BomId ";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "Y",
                                    ConfirmUserId = CurrentUser,
                                    ConfirmDate = dateNow,
                                    TransferStatus = "Y",
                                    TransferDate = dateNow,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    BomId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region//回寫元件拋轉時間
                            sql = @"UPDATE a SET
                                    a.ConfirmStatus = @ConfirmStatus,
                                    a.LastModifiedDate = @LastModifiedDate,
                                    a.LastModifiedBy = @LastModifiedBy
                                    FROM PDM.BomDetail a
                                    INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId 
                                    WHERE a.BomId = @BomId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "Y",
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    BomId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                    }
                    else
                    {
                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "errorForDA",
                            route = "batch",
                            msg = "BOM無可拋轉資料!"
                        });
                        #endregion
                        return jsonResponse.ToString();
                    }
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateCustomerMtlItemToERP --部番資料拋轉ERP -- Chia Yuan 2023.09.06
        public string UpdateCustomerMtlItemToERP(int MtlItemId)
        {
            try
            {
                if (MtlItemId < 0) throw new SystemException("部番資料拋轉-【品號】資料錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0;
                    string dateNow = CreateDate.ToString("yyyyMMdd"), timeNow = CreateDate.ToString("HH:mm:ss"), errorMsg = "";
                    string mtlItemTransferStatus = "", mtlItemNo = "", departmentNo = "", companyNo = "", userNo = "", userName = "", userGroup = "";

                    List<COPMG> customerMtlItems = new List<COPMG>();

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemNo, TransferStatus
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId 
                                AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("部番資料拋轉-【品號】資料錯誤!");
                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo;
                            mtlItemTransferStatus = item.TransferStatus;
                        }
                        #region //判斷拋轉狀態
                        if (mtlItemTransferStatus == "N") throw new SystemException("【品號】資料尚未拋轉!");
                        #endregion
                        #endregion

                        #region //判斷客戶品號資料是否正確 230907
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.TransferStatus
                                FROM PDM.CustomerMtlItem a
                                WHERE a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        //if (!result.Any()) throw new SystemException("【客戶品號】資料錯誤!");
                        if (result.Any())
                        {
                            #region //判斷拋轉狀態
                            if (!result.Any(a => a.TransferStatus == "N")) throw new SystemException("【客戶品號】目前資料皆已完成拋轉!");
                            #endregion
                        }
                        else
                        {
                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "errorForDA",
                                route = "batch",
                                msg = "部番無可拋轉資料!"
                            });
                            #endregion
                            return jsonResponse.ToString();
                        }
                        #endregion

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItem");
                        dynamicParameters.Add("DetailCode", "data-transfer");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //取得客戶品號資料
                        sql = @"SELECT a.CustomerMtlItemId, b.CustomerNo MG001, c.MtlItemNo MG002, a.CustomerMtlItemNo MG003
                                , a.CustomerMtlItemName MG005, a.CustomerMtlItemSpec MG006, a.TransferStatus
                                FROM PDM.CustomerMtlItem a
                                LEFT JOIN SCM.Customer b ON b.CustomerId = a.CustomerId
                                LEFT JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                                WHERE c.CompanyId = @CompanyId
                                AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        customerMtlItems = sqlConnection.Query<COPMG>(sql, dynamicParameters).ToList();
                        customerMtlItems.ForEach(item => {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    #region //取得未更改拋轉狀態的客戶品號資料
                    List<COPMG> addCopmg = customerMtlItems.Where(w => w.TransferStatus == "N").ToList();
                    #endregion

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @userNo";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("userNo", userNo);
                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("部番資料拋轉-【ERP使用者】不存在!");
                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                            userGroup = item.MF004; //使用者群組
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用) Function=COPI10, Auth=Y_______Y___
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @UserNo
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("UserNo", userNo);
                        //    dynamicParameters.Add("Function", "COPI10");
                        //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) //throw new SystemException("【ERP使用者】無權限!");
                        //    {
                        //        #region //Response
                        //        jsonResponse = JObject.FromObject(new
                        //        {
                        //            status = "errorForDA",
                        //            route = "batch",
                        //            msg = "部番資料拋轉-【ERP使用者】無權限!"
                        //        });
                        //        #endregion
                        //        return jsonResponse.ToString();
                        //    }
                        //}
                        #endregion

                        #region //取得ERP客戶品號資料
                        errorMsg = string.Empty;
                        sql = @"SELECT LTRIM(RTRIM(MG001)) AS MG001,LTRIM(RTRIM(MG002)) AS MG002,LTRIM(RTRIM(MG003)) AS MG003,LTRIM(RTRIM(MG005)) AS MG005
                                FROM COPMG a
                                WHERE COMPANY = @CompanyNo AND a.MG002 = @MtlItemNo";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("MtlItemNo", mtlItemNo);
                        var resultCOPMG = sqlConnection.Query<COPMG>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //客戶品號新增 COPMG from addCopmg
                        addCopmg
                            .ForEach(x =>
                            {
                                var copmg = resultCOPMG.FirstOrDefault(f => f.MG001 == x.MG001 && f.MG003 == x.MG003);
                                if (copmg == null)
                                {
                                    x.USR_GROUP = userGroup;
                                    x.MG004 = "";
                                    x.MG007 = 0;
                                    x.MG008 = 0;
                                    x.MG009 = "";
                                    x.MG010 = "";
                                    x.MG011 = "";
                                    x.MG012 = 0;
                                    x.MG013 = 0;
                                    x.UDF01 = "";
                                    x.UDF02 = "";
                                    x.UDF03 = "";
                                    x.UDF04 = "";
                                    x.UDF05 = "";
                                    x.UDF06 = 0;
                                    x.UDF07 = 0;
                                    x.UDF08 = 0;
                                    x.UDF09 = 0;
                                    x.UDF10 = 0;
                                    sql = @"INSERT INTO COPMG (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MG001, MG002, MG003, MG004, MG005, MG006, MG007, MG008, MG009, MG010
                                            , MG011, MG012, MG013
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MG001, @MG002, @MG003, @MG004, @MG005, @MG006, @MG007, @MG008, @MG009, @MG010
                                            , @MG011, @MG012, @MG013
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                    rowsAffected += sqlConnection.Execute(sql, x);
                                }
                                else
                                {
                                    //更新處理(由ERP代為編輯處理)
                                }
                            });
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //回寫部番資料 - 拋轉狀態和時間
                        addCopmg
                            .ForEach(item =>
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE a SET
                                        a.TransferStatus = @TransferStatus,
                                        a.TransferDate = @LastModifiedDate,
                                        a.LastModifiedDate = @LastModifiedDate,
                                        a.LastModifiedBy = @LastModifiedBy
                                        FROM PDM.CustomerMtlItem a
                                        WHERE a.CustomerMtlItemId = @CustomerMtlItemId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      TransferStatus = 'Y',
                                      TransferDate = dateNow,
                                      LastModifiedDate,
                                      LastModifiedBy,
                                      item.CustomerMtlItemId
                                  });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            });
                        #endregion
                    }
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomSubstitutionToERP -- 取替代料資料拋轉ERP -- Shintokuro 2023.07.04
        public string UpdateBomSubstitutionToERP(int MtlItemId)
        {
            try
            {
                if (MtlItemId < 0) throw new SystemException("取替代料拋轉-【品號】資料錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0;
                    string dateNow = CreateDate.ToString("yyyyMMdd"), timeNow = CreateDate.ToString("HH:mm:ss"), errorMsg = "";
                    string mtlItemTransferStatus = "", mtlItemNo = "", departmentNo = "", companyNo = "", userNo = "", userName = "", userGroup = ""; //, subTransferStatus = "", substituteStatus = ""

                    List<BOMMA> bomSubstitution = new List<BOMMA>();
                    List<BOMMB> bomSubstitutionDetail = new List<BOMMB>();

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemNo, TransferStatus
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId 
                                AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("取替代料拋轉-【品號】資料錯誤!");
                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo;
                            mtlItemTransferStatus = item.TransferStatus;
                        }
                        #region //判斷拋轉狀態
                        if (mtlItemTransferStatus == "N") throw new SystemException("【品號】資料尚未拋轉!");
                        #endregion
                        #endregion

                        #region //判斷取替代料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT d.MtlItemNo, a.TransferStatus,e.MtlItemNo as SubstitutionMtlItemNo, d.TransferStatus as mtlItemTransferStatus
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.BomDetail b on b.BomDetailId = a.BomDetailId
                                INNER JOIN PDM.BillOfMaterials c on c.BomId = b.BomId
                                INNER JOIN PDM.MtlItem d on d.MtlItemId = c.MtlItemId
                                INNER JOIN PDM.MtlItem e on e.MtlItemId = a.MtlItemId
                                WHERE c.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        //if (!result.Any()) throw new SystemException("【取替代料】資料錯誤!");
                        if (result.Any())
                        {
                            #region //判斷拋轉狀態
                            if (!result.Any(a => a.TransferStatus == "N")) throw new SystemException("【取替代料】目前資料皆已完成拋轉!");
                            #endregion
                        }
                        else
                        {
                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "errorForDA",
                                route = "batch",
                                msg = "取替代料無可拋轉資料!"
                            });
                            #endregion
                            return jsonResponse.ToString();
                        }
                        #endregion

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItem");
                        dynamicParameters.Add("DetailCode", "data-transfer");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //取的取替代料單頭資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT 
                                b1.MtlItemNo MA001,c1.MtlItemNo MA002,a.SubstituteStatus MA003
                                ,a.TransferStatus
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                INNER JOIN PDM.MtlItem b1 on b.MtlItemId = b1.MtlItemId
                                INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
                                WHERE c1.CompanyId = @CompanyId
                                AND c.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        bomSubstitution = sqlConnection.Query<BOMMA>(sql, dynamicParameters).ToList();
                        bomSubstitution.ForEach(item =>
                        {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion

                        #region //取的取替代料單身資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT DISTINCT a.SubstitutionId
                                ,b1.MtlItemNo MB001,c1.MtlItemNo MB002,a.SubstituteStatus MB003,a1.MtlItemNo MB004,a.Quantity MB005
                                ,ISNULL(FORMAT(a.EffectiveDate, 'yyyyMMdd'),'') MB006,ISNULL(FORMAT(a.ExpirationDate, 'yyyyMMdd'),'') MB007,a.Remark MB008,a.SortNumber MB009,a.Precedence MB010
                                ,a.TransferStatus
                                FROM PDM.BomSubstitution a
                                INNER JOIN PDM.MtlItem a1 on a.MtlItemId = a1.MtlItemId
                                INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                INNER JOIN PDM.MtlItem b1 on b.MtlItemId = b1.MtlItemId
                                INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                INNER JOIN PDM.MtlItem c1 on c.MtlItemId = c1.MtlItemId
                                WHERE c1.CompanyId = @CompanyId
                                AND c.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        bomSubstitutionDetail = sqlConnection.Query<BOMMB>(sql, dynamicParameters).ToList();
                        bomSubstitutionDetail.ForEach(item =>
                        {
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    var addBomma = bomSubstitution.Where(w => w.TransferStatus == "N").ToList();
                    var addBommb = bomSubstitutionDetail.Where(w => w.TransferStatus == "N").ToList();

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @userNo";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("userNo", userNo);
                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("取替代料拋轉-【ERP使用者】不存在!");
                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                            userGroup = item.MF004; //使用者群組
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用) Function=BOMI01, Auth=Y_______Y___
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @UserNo
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("UserNo", userNo);
                        //    dynamicParameters.Add("Function", "BOMI01");
                        //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) //throw new SystemException("【ERP使用者】無權限!");
                        //    {
                        //        #region //Response
                        //        jsonResponse = JObject.FromObject(new
                        //        {
                        //            status = "errorForDA",
                        //            route = "batch",
                        //            msg = "取替代料拋轉-【ERP使用者】無權限!"
                        //        });
                        //        #endregion
                        //        return jsonResponse.ToString();
                        //    }
                        //}
                        #endregion

                        #region //取得ERP取替代主件資料
                        errorMsg = string.Empty;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(MA001)) AS MA001
                                ,LTRIM(RTRIM(MA002)) AS MA002
                                ,LTRIM(RTRIM(MA003)) AS MA003
                                FROM BOMMA
                                WHERE COMPANY = @CompanyNo
                                AND MA002 = @MtlItemNo 
                                AND MA001 IN @MA001s";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("MtlItemNo", mtlItemNo);
                        dynamicParameters.Add("MA001s", bomSubstitution.Select(s => s.MA001).Distinct().ToArray());
                        var resultBOMMA = sqlConnection.Query<BOMMA>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //主件新增
                        addBomma
                            .ForEach(x =>
                            {
                                var bomma = resultBOMMA.FirstOrDefault(f => f.MA001 == x.MA001 && f.MA003 == x.MA003);
                                if (bomma == null)
                                {
                                    x.USR_GROUP = userGroup;
                                    x.MA004 = "";
                                    x.MA005 = 0;
                                    x.MA006 = 0;
                                    x.MA007 = "";
                                    x.MA008 = "";
                                    x.MA009 = "";
                                    x.UDF01 = "";
                                    x.UDF02 = "";
                                    x.UDF03 = "";
                                    x.UDF04 = "";
                                    x.UDF05 = "";
                                    x.UDF06 = 0;
                                    x.UDF07 = 0;
                                    x.UDF08 = 0;
                                    x.UDF09 = 0;
                                    x.UDF10 = 0;
                                    sql = @"INSERT INTO BOMMA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MA001, MA002, MA003, MA004, MA005, MA006, MA007, MA008, MA009
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MA001, @MA002, @MA003, @MA004, @MA005, @MA006, @MA007, @MA008, @MA009
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                    rowsAffected += sqlConnection.Execute(sql, x);
                                }
                                else
                                {
                                    //更新處理(由ERP代為編輯處理)
                                }
                            });
                        #endregion

                        #region //取得ERP取替代元件資料
                        errorMsg = string.Empty;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(MB001)) AS MB001
                                ,LTRIM(RTRIM(MB002)) AS MB002
                                ,LTRIM(RTRIM(MB003)) AS MB003
                                ,LTRIM(RTRIM(MB004)) AS MB004
                                ,LTRIM(RTRIM(MB009)) AS MB009
                                FROM BOMMB
                                WHERE MB002 = @MtlItemNo
                                AND MB001 IN @MB001s";
                        dynamicParameters.Add("MtlItemNo", mtlItemNo);
                        dynamicParameters.Add("MB001s", bomSubstitutionDetail.Select(s => s.MB001).Distinct().ToArray());
                        var resultBOMMB = sqlConnection.Query<BOMMB>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //元件新增
                        addBommb
                            .ForEach(x =>
                            {
                                var bommb = resultBOMMB.FirstOrDefault(f => f.MB001 == x.MB001 && f.MB003 == x.MB003 && f.MB009 == x.MB009);
                                if (bommb == null)
                                {
                                    x.USR_GROUP = userGroup;
                                    x.MB006 = x.MB006 ?? "";
                                    x.MB007 = x.MB007 ?? "";
                                    x.MB011 = 0;
                                    x.MB012 = 0;
                                    x.MB013 = "";
                                    x.MB014 = "";
                                    x.MB015 = "";
                                    x.UDF01 = "";
                                    x.UDF02 = "";
                                    x.UDF03 = "";
                                    x.UDF04 = "";
                                    x.UDF05 = "";
                                    x.UDF06 = 0;
                                    x.UDF07 = 0;
                                    x.UDF08 = 0;
                                    x.UDF09 = 0;
                                    x.UDF10 = 0;
                                    sql = @"INSERT INTO BOMMB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MB001, MB002, MB003, MB004, MB005, MB006, MB007, MB008, MB009, MB010
                                            , MB011, MB012, MB013, MB014, MB015
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MB001, @MB002, @MB003, @MB004, @MB005, @MB006, @MB007, @MB008, @MB009, @MB010
                                            , @MB011, @MB012, @MB013, @MB014, @MB015
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                    rowsAffected += sqlConnection.Execute(sql, x);
                                }
                                else
                                {
                                    //更新處理(由ERP代為編輯處理)
                                }
                            });
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //回寫取替代料 - 拋轉狀態和時間
                        addBommb
                            .ForEach(item =>
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE a SET
                                    a.TransferStatus=@TransferStatus,
                                    a.TransferDate=@TransferDate,
                                    a.LastModifiedDate=@LastModifiedDate,
                                    a.LastModifiedBy=@LastModifiedBy 
                                    FROM PDM.BomSubstitution a
                                    WHERE a.SubstitutionId = @SubstitutionId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        TransferStatus = "Y",
                                        TransferDate = dateNow,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        item.SubstitutionId
                                    });
                                rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            });
                        #endregion
                    }
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlItemUomCalculateToERP -- 品號單位換算拋轉ERP -- Shintokuro 2023-06-15
        public string UpdateMtlItemUomCalculateToERP(int MtlItemId)
        {
            try
            {
                if (MtlItemId < 0) throw new SystemException("單位換算資料拋轉-【品號】資料錯誤!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0;
                    string dateNow = CreateDate.ToString("yyyyMMdd"), timeNow = CreateDate.ToString("HH:mm:ss"), errorMsg = "";
                    string uomNo = "", mtlItemTransferStatus = "", mtlItemNo = "", departmentNo = "", companyNo = "", userNo = "", userName = "", userGroup = "";

                    List<INVMD> mtlItemUomCalculates = new List<INVMD>();

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemNo, TransferStatus
                                FROM PDM.MtlItem
                                WHERE CompanyId = @CompanyId 
                                AND MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (!result.Any()) throw new SystemException("單位換算資料拋轉-【品號】資料錯誤!");
                        foreach (var item in result)
                        {
                            mtlItemNo = item.MtlItemNo;
                            mtlItemTransferStatus = item.TransferStatus;
                        }
                        #region //判斷拋轉狀態
                        if (mtlItemTransferStatus == "N") throw new SystemException("【品號】資料尚未拋轉!");
                        #endregion
                        #endregion

                        #region //判斷單位換算資料是否正確 230907
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MtlItemNo, a.TransferStatus, b.TransferStatus AS mtlItemTransferStatus
                                FROM PDM.MtlItemUomCalculate a
                                INNER JOIN PDM.MtlItem b on b.MtlItemId = a.MtlItemId
                                WHERE b.CompanyId = @CompanyId AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        //if (!result.Any()) throw new SystemException("【品號】資料錯誤!");
                        if (result.Any())
                        {
                            #region //判斷拋轉狀態
                            if (!result.Any(a => a.TransferStatus == "N")) throw new SystemException("【品號單位換算】目前資料皆已完成拋轉!");
                            #endregion
                        }
                        else
                        {
                            #region //Response
                            jsonResponse = JObject.FromObject(new
                            {
                                status = "errorForDA",
                                route = "batch",
                                msg = "品號單位換算無可拋轉資料!"
                            });
                            #endregion
                            return jsonResponse.ToString();
                        }
                        #endregion

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItem");
                        dynamicParameters.Add("DetailCode", "data-transfer");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //取得品號單位換算資料 - PDM.MtlItemUomCalculate(INVMD)
                        dynamicParameters = new DynamicParameters();
                        sqlQuery.mainKey = "a.MtlItemUomCalculateId";
                        sqlQuery.auxKey = "";
                        sqlQuery.columns =
                            @",a.MtlItemId,b.MtlItemNo MD001
                              ,a.UomId, c.UomNo
                              ,a.ConvertUomId, d.UomNo MD002
                              ,a.SwapDenominator MD004,a.SwapNumerator MD003
                              ,a.TransferStatus
                              ,b.CompanyId";
                        sqlQuery.mainTables =
                            @"FROM PDM.MtlItemUomCalculate a
                              INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                              INNER JOIN PDM.UnitOfMeasure c ON a.UomId = c.UomId
                              INNER JOIN PDM.UnitOfMeasure d ON a.ConvertUomId = d.UomId";
                        sqlQuery.auxTables = "";
                        string queryCondition = @"AND b.CompanyId = @CompanyId AND a.MtlItemId = @MtlItemId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        sqlQuery.conditions = queryCondition;
                        sqlQuery.orderBy = "";
                        mtlItemUomCalculates = BaseHelper.SqlQuery<INVMD>(sqlConnection, dynamicParameters, sqlQuery).ToList();
                        mtlItemUomCalculates.ForEach(item => {
                            uomNo = item.MD002; //轉換單位
                            item.CREATOR = userNo;
                            item.CREATE_AP = userNo + "PC";
                            item.COMPANY = companyNo;
                            item.USR_GROUP = userGroup;
                            item.CREATE_DATE = dateNow;
                            item.MODIFIER = "";
                            item.MODI_DATE = "";
                            item.FLAG = "1";
                            item.CREATE_TIME = timeNow;
                            item.CREATE_PRID = "BM";
                            item.MODI_TIME = "";
                            item.MODI_AP = "";
                            item.MODI_PRID = "";
                        });
                        #endregion
                    }

                    #region 取得未更改拋轉狀態的單位換算資料
                    List<INVMD> addInvmd = mtlItemUomCalculates.Where(w => w.TransferStatus == "N").ToList();
                    #endregion

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @userNo";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("userNo", userNo);
                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("品號單位換算拋轉-【ERP使用者】不存在!");
                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                            userGroup = item.MF004; //使用者群組
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用) Function=INVI25, Auth=Y_______Y___
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @UserNo
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("UserNo", userNo);
                        //    dynamicParameters.Add("Function", "INVI25");
                        //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) //throw new SystemException("【ERP使用者】無權限!");
                        //    {
                        //        #region //Response
                        //        jsonResponse = JObject.FromObject(new
                        //        {
                        //            status = "errorForDA",
                        //            route = "batch",
                        //            msg = "品號單位換算拋轉-【ERP使用者】無權限!"
                        //        });
                        //        #endregion
                        //        return jsonResponse.ToString();
                        //    }
                        //}
                        #endregion

                        #region //取得ERP單位換算資料
                        errorMsg = string.Empty;
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(MD001)) AS MD001, LTRIM(RTRIM(MD002)) AS MD002
                                FROM INVMD
                                WHERE COMPANY = @CompanyNo 
                                AND MD001 = @MtlItemNo";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("MtlItemNo", mtlItemNo);
                        var resultINVMD = sqlConnection.Query<INVMD>(sql, dynamicParameters).ToList();
                        #endregion

                        #region //單位換算表新增 INVMD from addInvmd
                        addInvmd
                            .ForEach(x =>
                            {
                                var invmd = resultINVMD.FirstOrDefault(f => f.MD001 == x.MD001 && f.MD002 == x.MD002);
                                if (invmd == null)
                                {
                                    x.USR_GROUP = userGroup;
                                    x.MD005 = 0.000000;
                                    x.MD006 = 0.000000;
                                    x.MD007 = "";
                                    x.MD008 = "";
                                    x.MD009 = "";
                                    x.UDF01 = "";
                                    x.UDF02 = "";
                                    x.UDF03 = "";
                                    x.UDF04 = "";
                                    x.UDF05 = "";
                                    x.UDF06 = 0.000000;
                                    x.UDF07 = 0.000000;
                                    x.UDF08 = 0.000000;
                                    x.UDF09 = 0.000000;
                                    x.UDF10 = 0.000000;
                                    sql = @"INSERT INTO INVMD (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, CREATE_AP, 
                                            CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID, MD001, MD002, MD003, MD004, MD005, MD006, MD007, MD008, MD009,
                                            UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, @CREATE_AP,
                                            @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, @MD001, @MD002, @MD003, @MD004, @MD005, @MD006, @MD007, @MD008, @MD009,
                                            @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                    rowsAffected += sqlConnection.Execute(sql, x);
                                }
                                else
                                {
                                    //更新處理(由ERP代為編輯處理)
                                }
                            });
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //回寫單位換算資料 - 拋轉狀態和時間
                        addInvmd
                            .ForEach(item => {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE a SET
                                        a.TransferStatus = @TransferStatus,
                                        a.TransferDate = @LastModifiedDate,
                                        a.LastModifiedDate = @LastModifiedDate,
                                        a.LastModifiedBy = @LastModifiedBy
                                        FROM PDM.MtlItemUomCalculate a
                                        WHERE a.MtlItemUomCalculateId = @MtlItemUomCalculateId";
                                dynamicParameters.AddDynamicParams(
                                  new
                                  {
                                      TransferStatus = 'Y',
                                      TransferDate = dateNow,
                                      LastModifiedDate,
                                      LastModifiedBy,
                                      item.MtlItemUomCalculateId
                                  });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            });
                        #endregion

                        #region //寫入單位換算Log紀錄
                        List<MtlItemUomCalculate> mtlItemUomCalculateList = new List<MtlItemUomCalculate>();
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    --MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomId, SwapDenominator, SwapNumerator, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy
                                    FROM PDM.MtlItemUomCalculate
                                    WHERE MtlItemUomCalculateId IN @MtlItemUomCalculateId";
                        dynamicParameters.Add("MtlItemUomCalculateId", addInvmd.Select(s => s.MtlItemUomCalculateId).Distinct());
                        mtlItemUomCalculateList = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                        mtlItemUomCalculateList.ForEach(item => {
                            item.TransactionType = "T";
                            item.TransactionUserId = CurrentUser;
                            item.TransactionDate = CreateDate;
                            item.CreateDate = CreateDate;
                            item.LastModifiedDate = LastModifiedDate;
                            item.CreateBy = CreateBy;
                            item.LastModifiedBy = LastModifiedBy;
                            sql = @"INSERT INTO PDM.MtlItemUomCalculateLog (TransactionType, MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomIdBefore, 
                                        SwapDenominatorBefore, SwapNumeratorBefore, ConvertUomId, SwapDenominator, SwapNumerator, TransactionUserId, 
                                        TransactionDate, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        VALUES (@TransactionType, @MtlItemUomCalculateId, @MtlItemId, @UomId, @ConvertUomIdBefore,
                                        @SwapDenominatorBefore, @SwapNumeratorBefore, @ConvertUomId, @SwapDenominator, @SwapNumerator, @TransactionUserId,
                                        @TransactionDate, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, item);
                        });
                        #endregion
                    }
                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();

        }
        #endregion

        #region //UpdateCustomerMtlItem -- 部番資料更新 -- Zoey 2023.01.16
        public string UpdateCustomerMtlItem(int CustomerMtlItemId, int MtlItemId, int CustomerId, string CustomerMtlItemNo, string CustomerMtlItemName, string CustomerMtlItemSpec, int PoCompanyId, string PoErpPrefixNo, string PoSeq)
        {
            try
            {
                if (CustomerId <= 0) throw new SystemException("【客戶名稱】不能為空!");
                if (CustomerMtlItemNo.Length <= 0) throw new SystemException("【客戶品號】不能為空!");
                if (CustomerMtlItemNo.Length > 50) throw new SystemException("【客戶品號】長度錯誤!");
                if (CustomerMtlItemName.Length > 200) throw new SystemException("【客戶品名】長度錯誤!");
                if (CustomerMtlItemSpec.Length > 200) throw new SystemException("【客戶品號規格】長度錯誤!");

                string OriCustomerMtlItemNo = "";

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0;
                    string userNo = "", userName = "", departmentNo = "";
                    string transferStatus = "", ErpNo = "", MODIFIER = "", MtlItemNo = "", CustomerNo = "", oriCustomerNo = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        if (!(string.IsNullOrWhiteSpace(PoErpPrefixNo) && string.IsNullOrWhiteSpace(PoSeq)))
                        {
                            #region //取得ERP採購單公司別DB
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                            dynamicParameters.Add("CompanyId", PoCompanyId);

                            var resultPoCompany = sqlConnection.Query(sql, dynamicParameters);

                            if (resultPoCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                            string PoErpConnectionStrings = string.Empty;
                            foreach (var item in resultPoCompany)
                            {
                                PoErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            }
                            #endregion

                            if (!string.IsNullOrWhiteSpace(PoErpConnectionStrings))
                            {
                                using (SqlConnection erpConnection = new SqlConnection(PoErpConnectionStrings))
                                {
                                    #region //檢查ERP採購單資料是否正確
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.COMPANY
                                            , LTRIM(RTRIM(a.TD001)) AS TD001, LTRIM(RTRIM(a.TD002)) AS TD002, LTRIM(RTRIM(a.TD003)) AS TD003
                                            FROM PURTD a
                                            WHERE LTRIM(RTRIM(a.TD001)) + '-' + LTRIM(RTRIM(a.TD002)) = @PoErpPrefixNo
                                            AND LTRIM(RTRIM(a.TD003)) = @PoSeq";
                                    dynamicParameters.Add("PoErpPrefixNo", PoErpPrefixNo);
                                    dynamicParameters.Add("PoSeq", PoSeq);
                                    var resultPURTD = erpConnection.Query(sql, dynamicParameters);
                                    if (resultPURTD.Count() <= 0) throw new SystemException("【客戶採購單】資料錯誤!");
                                    #endregion
                                }
                            }
                        }

                        #region //公司別資料
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT a.ErpNo, a.ErpDb
                        //        FROM BAS.Company a
                        //        WHERE CompanyId = @CompanyId";
                        //dynamicParameters.Add("CompanyId", CurrentCompany);

                        //var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        //if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        //foreach (var item in resultCompany)
                        //{
                        //    ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        //    companyNo = item.ErpNo;
                        //}
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItem");
                        dynamicParameters.Add("DetailCode", "data-transfer");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //判斷客戶名稱是否重複
                        sql = @"SELECT TOP 1 1
                                FROM PDM.CustomerMtlItem
                                WHERE CustomerId = @CustomerId
                                AND MtlItemId = @MtlItemId
                                AND CustomerMtlItemNo = @CustomerMtlItemNo
                                AND CustomerMtlItemId != @CustomerMtlItemId";
                        dynamicParameters.Add("CustomerId", CustomerId);
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("CustomerMtlItemNo", CustomerMtlItemNo);
                        dynamicParameters.Add("CustomerMtlItemId", CustomerMtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【客戶品號】重複，請重新選擇!");
                        #endregion

                        #region //撈取品號拋轉狀態
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TransferStatus
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result2)
                        {
                            transferStatus = item.TransferStatus;
                        }
                        #endregion

                        if (transferStatus == "Y")
                        {
                            #region //確認公司別DB
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.ErpNo, a.ErpDb
                                    FROM BAS.Company a
                                    WHERE CompanyId = @CompanyId";
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var companyResult = sqlConnection.Query(sql, dynamicParameters);

                            if (companyResult.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                            foreach (var item in companyResult)
                            {
                                ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                                ErpNo = item.ErpNo;
                            }
                            #endregion

                            #region //撈取使用者No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UserNo
                                    FROM BAS.[User] a
                                    WHERE a.UserId = @userId";
                            dynamicParameters.Add("userId", CurrentUser);

                            var result3 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result3)
                            {
                                MODIFIER = item.UserNo;
                            }
                            #endregion

                            #region //撈取品號No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemNo
                                    FROM PDM.MtlItem
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            var result4 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result4)
                            {
                                MtlItemNo = item.MtlItemNo;
                            }
                            #endregion

                            #region //撈取客戶No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT CustomerNo
                                    FROM SCM.Customer
                                    WHERE CustomerId = @CustomerId";
                            dynamicParameters.Add("CustomerId", CustomerId);

                            var result5 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result5)
                            {
                                CustomerNo = item.CustomerNo;
                            }
                            #endregion

                            #region //撈取原客戶No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.CustomerNo, a.CustomerMtlItemNo OriCustomerMtlItemNo
                                    FROM PDM.CustomerMtlItem a
                                    INNER JOIN SCM.Customer b ON b.CustomerId = a.CustomerId
                                    WHERE a.CustomerMtlItemId = @CustomerMtlItemId";
                            dynamicParameters.Add("CustomerMtlItemId", CustomerMtlItemId);

                            var result6 = sqlConnection.Query(sql, dynamicParameters);

                            foreach (var item in result6)
                            {
                                oriCustomerNo = item.CustomerNo;
                                OriCustomerMtlItemNo = item.OriCustomerMtlItemNo;
                            }
                            #endregion
                        }

                        #region //修改BM客戶品號
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.CustomerMtlItem SET
                                CustomerId = @CustomerId,
                                PoErpFullNo = @PoErpFullNo,
                                PoSeq = @PoSeq,
                                CustomerMtlItemNo = @CustomerMtlItemNo,
                                CustomerMtlItemName = @CustomerMtlItemName,
                                CustomerMtlItemSpec = @CustomerMtlItemSpec,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE CustomerMtlItemId = @CustomerMtlItemId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CustomerId,
                                PoErpFullNo = string.IsNullOrWhiteSpace(PoErpPrefixNo)? null : PoErpPrefixNo,
                                PoSeq = string.IsNullOrWhiteSpace(PoSeq) ? null : PoSeq,
                                CustomerMtlItemNo,
                                CustomerMtlItemName,
                                CustomerMtlItemSpec,
                                LastModifiedDate,
                                LastModifiedBy,
                                CustomerMtlItemId
                            });

                        rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion
                    }

                    if (transferStatus == "Y")
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region //判斷ERP使用者是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MF005
                                    FROM ADMMF
                                    WHERE COMPANY = @CompanyNo
                                    AND MF001 = @userNo";
                            dynamicParameters.Add("CompanyNo", ErpNo);
                            dynamicParameters.Add("userNo", userNo);
                            var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUserExist.Count() <= 0) throw new SystemException("部番資料拋轉-【ERP使用者】不存在!");
                            string adminUser = "N";
                            foreach (var item in resultUserExist)
                            {
                                adminUser = item.MF005; //超級使用者
                            }
                            #endregion

                            #region //判斷ERP使用者是否有權限 (停用) Function=COPI10, Auth=Y_______Y___
                            //if (adminUser != "Y")
                            //{
                            //    dynamicParameters = new DynamicParameters();
                            //    sql = @"SELECT TOP 1 MG006
                            //        FROM ADMMG
                            //        WHERE COMPANY = @CompanyNo
                            //        AND MG001 = @UserNo
                            //        AND MG002 = @Function
                            //        AND MG004 = 'Y'
                            //        AND MG006 LIKE @Auth";
                            //    dynamicParameters.Add("CompanyNo", companyNo);
                            //    dynamicParameters.Add("UserNo", userNo);
                            //    dynamicParameters.Add("Function", "COPI10");
                            //    dynamicParameters.Add("Auth", "Y_______Y___"); //修改/查詢/新增
                            //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                            //    if (resultUserAuthExist.Count() <= 0) //throw new SystemException("【ERP使用者】無權限!");
                            //    {
                            //        #region //Response
                            //        jsonResponse = JObject.FromObject(new
                            //        {
                            //            status = "errorForDA",
                            //            route = "batch",
                            //            msg = "部番資料拋轉-【ERP使用者】無權限!"
                            //        });
                            //        #endregion
                            //        return jsonResponse.ToString();
                            //    }
                            //}
                            #endregion

                            #region //確認此部番是否重複
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 1
                                    FROM COPMG
                                    WHERE MG001 = @CustomerNo
                                    AND MG002 = @MtlItemNo
                                    AND MG003 = @CustomerMtlItemNo";
                            dynamicParameters.Add("CustomerNo", CustomerNo);
                            dynamicParameters.Add("MtlItemNo", MtlItemNo);
                            dynamicParameters.Add("CustomerMtlItemNo", CustomerMtlItemNo);

                            var COPMGResult = sqlConnection.Query(sql, dynamicParameters);

                            if (COPMGResult.Count() > 0) throw new SystemException("部番【" + CustomerMtlItemNo + "】重複，無法新增!!");
                            #endregion

                            #region //修改ERP客戶品號
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE COPMG SET
                                    MG001 = @CustomerNo,
                                    MG003 = @CustomerMtlItemNo,
                                    MG005 = @CustomerMtlItemName,
                                    MG006 = @CustomerMtlItemSpec,
                                    MODI_DATE = @MODI_DATE,
                                    MODI_TIME = @MODI_TIME,
                                    MODIFIER = @MODIFIER
                                    WHERE MG001 = @oriCustomerNo
                                    AND MG002 = @MtlItemNo
                                    AND MG003 = @OriCustomerMtlItemNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    CustomerNo,
                                    CustomerMtlItemNo,
                                    CustomerMtlItemName,
                                    CustomerMtlItemSpec,
                                    MODI_DATE = DateTime.Now.ToString("yyyyMMdd"),
                                    MODI_TIME = DateTime.Now.ToString("HH:mm:ss"),
                                    MODIFIER,
                                    oriCustomerNo,
                                    MtlItemNo,
                                    OriCustomerMtlItemNo
                                });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlItemSetting -- 品號設定資料更新 -- Zoey 2023.02.01
        public string UpdateMtlItemSetting(int MtlItemId, int FixedLeadTime, int ChangeLeadTime, int MinPoQty, int MultiplePoQty, int MultipleReqQty)
        {
            try
            {
                if (MtlItemId < 0) throw new SystemException("【品號】資料錯誤!");
                if (FixedLeadTime < 0) throw new SystemException("【固定前置天數】不能為空!");
                if (ChangeLeadTime < 0) throw new SystemException("【變動前置天數】不能為空!");
                if (MinPoQty < 0) throw new SystemException("【最低補量】不能為空!");
                if (MultiplePoQty < 0) throw new SystemException("【補貨倍量】不能為空!");
                if (MultipleReqQty < 0) throw new SystemException("【領用倍量】不能為空!");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷品號是否正確
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MtlItemSetting
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號資料錯誤!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItemSetting SET
                                FixedLeadTime = @FixedLeadTime,
                                ChangeLeadTime = @ChangeLeadTime,
                                MinPoQty = @MinPoQty,
                                MultiplePoQty = @MultiplePoQty,
                                MultipleReqQty = @MultipleReqQty,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                FixedLeadTime,
                                ChangeLeadTime,
                                MinPoQty,
                                MultiplePoQty,
                                MultipleReqQty,
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlItemChange -- 品號變更單頭資料更新 -- Ding 2023.05.24
        public string UpdateMtlItemChange(int MtlItemChangeId, int MtlItemId, string NewMtlItemName, string NewMtlItemSpec, string Remark)
        {
            try
            {
                string MtlItemNo = "";

                string OriginalMtlItemName = "";
                string OriginalMtlItemSpec = "";
                string OriginalEdition = "";
                int changeMtlId = 0;

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        

                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                            FROM BAS.Company
                            WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var Companyresult = sqlConnection.Query(sql, dynamicParameters);
                        if (Companyresult.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in Companyresult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //MtlItemId 是否存在MES變更單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                 FROM PDM.MtlItemChange
                                 WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        var MtlItemNoResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoResult.Count() <= 0) throw new SystemException("【品號變更管理】－此查無此變更單紀錄");
                        //if (MtlItemNoResult.First().TransferStatus != "N") throw new SystemException("【品號變更管理】－此單已拋轉無法更改");
                        if (MtlItemNoResult.First().CompanyId != CurrentCompany) throw new SystemException("【品號變更管理】－此單不屬於目前公司別!");

                        foreach (var item in MtlItemNoResult) {
                            changeMtlId = item.MtlItemId;
                        }
                        #endregion

                            #region //取得 MtlItemNo
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT *
                                    FROM PDM.MtlItem
                                    WHERE TransferStatus='Y'                                    
                                    AND MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            var Result = sqlConnection.Query(sql, dynamicParameters);


                            if (Result.Count() < 0) throw new SystemException("【品號變更管理】－此品號為新品號(未拋轉)，不可開立變更單");
                            if (Result.Count() != 1) throw new SystemException("【品號變更管理】－此品號資料錯誤，不可開立變更單");
                            if (Result.FirstOrDefault().CompanyId != Companyresult.FirstOrDefault().CompanyId) throw new SystemException("【品號變更管理】－此品號不屬於目前公司別!");

                            foreach (var item in Result)
                            {
                                MtlItemNo = item.MtlItemNo;
                                OriginalMtlItemName = item.MtlItemName;
                                OriginalMtlItemSpec = item.MtlItemSpec;


                            }
                            #endregion


                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {

                        #region //MtlItemId 是否存在ERP
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT MB001
                                    FROM INVMB
                                    WHERE RTRIM(LTRIM(MB001)) = @MB001";
                        dynamicParameters.Add("MB001", MtlItemNo);
                        var MtlItemNoErpResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoErpResult.Count() != 1) throw new SystemException("【品號變更管理】－此品號為未建於ERP，不可開立變更單");
                        #endregion

                        #region //MtlItemId 是否有未確認變更單
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                    FROM INVTL
                                    WHERE RTRIM(LTRIM(TL001)) = @TL001 AND TL014 = 'N'";
                        dynamicParameters.Add("TL001", MtlItemNo);
                        var MtlItemChangeErpResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemChangeErpResult.Count() > 0) throw new SystemException("【品號變更管理】－此品號在ERP有未確認變更單，請至ERP確認！");
                        #endregion

                        if (MtlItemId != changeMtlId)
                        {
                            #region //取得ERP版本
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MAX(TL004) ChangeEdition
                                    FROM INVTL
                                    WHERE TL014 = 'Y' AND RTRIM(LTRIM(TL001)) = @TL001";
                            dynamicParameters.Add("TL001", MtlItemNo);
                            var erpEdition = sqlConnection.Query(sql, dynamicParameters);
                            if (erpEdition.Count() > 0)
                            {
                                if (erpEdition.FirstOrDefault().ChangeEdition != null)
                                {
                                    OriginalEdition = erpEdition.FirstOrDefault().ChangeEdition;
                                }
                                else {
                                    OriginalEdition = "0000";
                                }
                            }
                            else
                            {
                                OriginalEdition = "0000";
                            }

                            #endregion//
                        }
                    


                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //更新
                        int rowsAffected = 0;

                        if (MtlItemId != changeMtlId)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItemChange SET
                                MtlItemId = @MtlItemId,
                                NewMtlItemName=@NewMtlItemName,
                                NewMtlItemSpec=@NewMtlItemSpec,
                                OriginalMtlItemName = @OriginalMtlItemName,
                                OriginalMtlItemSpec = @OriginalMtlItemSpec,
                                OriginalEdition = @OriginalEdition,
                                UpdateBy=@UpdateBy,
                                Remark=@Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MtlItemId,
                                    NewMtlItemName,
                                    NewMtlItemSpec,
                                    OriginalMtlItemName,
                                    OriginalMtlItemSpec,
                                    OriginalEdition,
                                    UpdateBy = CurrentUser,
                                    Remark,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlItemChangeId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            #region //品號有變動，刪除單身
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.MtlItemChangeDetail
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                            dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId );
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        else {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItemChange SET
                                MtlItemId = @MtlItemId,
                                NewMtlItemName=@NewMtlItemName,
                                NewMtlItemSpec=@NewMtlItemSpec,
                                UpdateBy=@UpdateBy,
                                Remark=@Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MtlItemId,
                                    NewMtlItemName,
                                    NewMtlItemSpec,
                                    UpdateBy = CurrentUser,
                                    Remark,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlItemChangeId
                                });

                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        }
                            

                        

                        //if ((MtlItemId != changeMtlId) && (MtlItemNoDetailResult.Count() > 0)) {
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"UPDATE PDM.MtlItemChange SET
                        //        MtlItemId = @MtlItemId,
                        //        NewMtlItemName=@NewMtlItemName,
                        //        NewMtlItemSpec=@NewMtlItemSpec,
                        //        UpdateBy=@UpdateBy,
                        //        Remark=@Remark,
                        //        LastModifiedDate = @LastModifiedDate,
                        //        LastModifiedBy = @LastModifiedBy
                        //        WHERE MtlItemChangeId = @MtlItemChangeId";
                        //    dynamicParameters.AddDynamicParams(
                        //        new
                        //        {
                        //            MtlItemId,
                        //            NewMtlItemName,
                        //            NewMtlItemSpec,
                        //            UpdateBy = CurrentUser,
                        //            Remark,
                        //            LastModifiedDate,
                        //            LastModifiedBy,
                        //            MtlItemChangeId
                        //        });

                        //    rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        //}

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                        #endregion

                    }
                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlItemChangeDetail -- 品號變更單身資料更新 -- GPAI 20230619
        public string UpdateMtlItemChangeDetail(int MtlItemChangeId, int MtlChangeDetailId, string FieldNum, string FieldName, string NewTextField, string NewNumericField, string OriginalNumericField, string NewFieldName, string OriginalFieldName, string OriginalTextField
            , string Remark, string FieldType)
        {
            try
            {

                int mtlItemId = 0;
                decimal originalNumericField = Convert.ToDecimal(OriginalNumericField);

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //MtlItemChange是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.*
                                 FROM PDM.MtlItemChange a
                                 INNER JOIN PDM.MtlItem b ON a.MtlItemId=b.MtlItemId                                  
                                 WHERE a.MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        var MtlItemNoResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlItemNoResult.Count() <= 0) throw new SystemException("【品號變更管理】－查無此變更單紀錄");

                        foreach (var item in MtlItemNoResult)
                        {
                            if (item.TransferStatus != "N") throw new SystemException("【品號變更管理】－變更單已拋轉無法更改");
                            if (item.CompanyId != CurrentCompany) throw new SystemException("【品號變更管理】－此變更單不屬於目前公司別!");
                            mtlItemId = item.MtlItemId;
                        }

                        #endregion

                        #region //MtlChangeDetail 是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                 FROM PDM.MtlItemChangeDetail
                                 WHERE MtlItemChangeId = @MtlItemChangeId AND MtlChangeDetailId = @MtlChangeDetailId";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        dynamicParameters.Add("MtlChangeDetailId", MtlChangeDetailId);
                        var MtlChangeDetailResult = sqlConnection.Query(sql, dynamicParameters);
                        if (MtlChangeDetailResult.Count() <= 0) throw new SystemException("【品號變更管理】－查無此變更單身紀錄");

                        foreach (var item in MtlChangeDetailResult)
                        {
                            if (item.ConfirmStatus == "Y") throw new SystemException("【品號變更管理】－該資料已確認無法更改");
                            if (item.OriginalTextField == NewTextField) throw new SystemException("【品號變更管理】此欄位資料與原資料相同!");
                        }
                        #endregion

                        #region //品號設定資料
                        if (FieldType == "N")
                        {
                            sql = @"SELECT a.MtlItemId, a.FixedLeadTime, a.ChangeLeadTime, a.MinPoQty, a.MultiplePoQty, a.MultipleReqQty
                            FROM PDM.MtlItemSetting a
                            WHERE 1=1 AND a.MtlItemId  = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", mtlItemId);

                            var MtlItemSettingresult = sqlConnection.Query(sql, dynamicParameters);

                            if (MtlItemSettingresult.Count() > 0)
                            {

                            }

                        }
                        #endregion

                        #region //更新
                        int rowsAffected = 0;

                        if (FieldType == "N" && (FieldNum == "MB036" || FieldNum == "MB037" || FieldNum == "MB039" || FieldNum == "MB040" || FieldNum == "MB041" || FieldNum == "MB070"))
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItemChangeDetail SET

                                FieldNum = @FieldNum,
                                FieldName = @FieldName,
                                NewNumericField = @NewNumericField,
                                OriginalNumericField = @OriginalNumericField,
                                Remark = @Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlChangeDetailId = @MtlChangeDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    FieldNum,
                                    FieldName,
                                    NewNumericField,
                                    OriginalNumericField,
                                    Remark,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlChangeDetailId
                                });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        }
                        else if (FieldNum == "MB004" || FieldNum == "MB155" || FieldNum == "MB156")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItemChangeDetail SET

                                FieldNum = @FieldNum,
                                FieldName = @FieldName,
                                OriginalTextField = @OriginalTextField,
                                NewTextField = @NewTextField,
                                OriginalFieldName = @OriginalFieldName,
                                Remark = @Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlChangeDetailId = @MtlChangeDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    FieldNum,
                                    FieldName,
                                    OriginalTextField,
                                    NewTextField,
                                    OriginalFieldName,
                                    Remark,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlChangeDetailId
                                });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        }
                        else
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItemChangeDetail SET

                                FieldNum = @FieldNum,
                                FieldName = @FieldName,
                                OriginalTextField = @OriginalTextField,
                                NewTextField = @NewTextField,
                                NewFieldName  = @NewFieldName,
                                OriginalFieldName = @OriginalFieldName,
                                Remark = @Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlChangeDetailId = @MtlChangeDetailId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    FieldNum,
                                    FieldName,
                                    OriginalTextField,
                                    NewTextField,
                                    NewFieldName,
                                    OriginalFieldName,
                                    Remark,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlChangeDetailId
                                });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        }




                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                        #endregion
                    }
                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlItemUomCalculate -- 品號單位換算更新 -- Shintokuro 2023.06.14
        public string UpdateMtlItemUomCalculate(int MtlItemUomCalculateId, int MtlItemId, int ConvertUomId, double SwapNumerator, double SwapDenominator
            )
        {
            try
            {
                if (MtlItemId <= 0) throw new SystemException("【品號單位換算】－品號不能空，請重新確認");
                if (ConvertUomId <= 0) throw new SystemException("【品號單位換算】－換算單位不能空，請重新確認");
                if (SwapNumerator <= 0) throw new SystemException("【品號單位換算】－換算率分子不能小於等於0，請重新確認");
                if (SwapDenominator <= 0) throw new SystemException("【品號單位換算】－換算率分母不能小於等於0，請重新確認");

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        List<MtlItemUomCalculate> mtlItemUomCalculate = new List<MtlItemUomCalculate>();

                        string TransferStatus = "";

                        #region //判斷品號單位換算資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemUomCalculateId, MtlItemId, UomId, TransferStatus, TransferDate, ConvertUomId ConvertUomIdBefore, SwapNumerator SwapNumeratorBefore, SwapDenominator SwapDenominatorBefore
                                FROM PDM.MtlItemUomCalculate
                                WHERE MtlItemUomCalculateId = @MtlItemUomCalculateId";
                        dynamicParameters.Add("MtlItemUomCalculateId", MtlItemUomCalculateId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算】－品號單位換算資料不存在,請重新確認!");
                        mtlItemUomCalculate = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();
                        foreach (var item in result)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        if (TransferStatus == "Y") throw new SystemException("【品號單位換算】－資料已經拋轉不能修改,請重新確認!");
                        #endregion

                        #region //判斷品號單位換算資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConvertUomId
                                FROM PDM.MtlItemUomCalculate
                                WHERE MtlItemId = @MtlItemId
                                AND ConvertUomId = @ConvertUomId
                                AND MtlItemUomCalculateId != @MtlItemUomCalculateId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("ConvertUomId", ConvertUomId);
                        dynamicParameters.Add("MtlItemUomCalculateId", MtlItemUomCalculateId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("【品號單位換算】－換算單位已存在,不可以新增!");
                        #endregion

                        #region //判斷品號是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 InventoryUomId
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算】－品號不存在，請重新輸入!");
                        foreach (var item in result)
                        {
                            if (item.InventoryUomId == ConvertUomId) throw new SystemException("【品號單位換算】－庫存單位與換算單位不可以相同，請重新確認!");
                        }
                        #endregion

                        #region //判斷換算單位是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.UnitOfMeasure
                                WHERE UomId = @ConvertUomId";
                        dynamicParameters.Add("ConvertUomId", ConvertUomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號單位換算】－換算單位不存在，請重新輸入!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItemUomCalculate SET
                                ConvertUomId = @ConvertUomId,
                                SwapNumerator = @SwapNumerator,
                                SwapDenominator = @SwapDenominator,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemUomCalculateId = @MtlItemUomCalculateId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConvertUomId,
                                SwapNumerator,
                                SwapDenominator,
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemUomCalculateId
                            });
                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //資料新增(log)
                        if (mtlItemUomCalculate.Count > 0)
                        {
                            mtlItemUomCalculate
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TransactionType = "U";
                                    x.ConvertUomId = ConvertUomId;
                                    x.SwapDenominator = SwapDenominator;
                                    x.TransactionUserId = CurrentUser;
                                    x.TransactionDate = CreateDate;
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO PDM.MtlItemUomCalculateLog (TransactionType, MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomIdBefore, 
                                    SwapNumeratorBefore, SwapDenominatorBefore,  ConvertUomId, SwapNumerator, SwapDenominator, TransactionUserId, 
                                    TransactionDate, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@TransactionType, @MtlItemUomCalculateId, @MtlItemId, @UomId, @ConvertUomIdBefore,
                                    @SwapNumeratorBefore, @SwapDenominatorBefore,  @ConvertUomId, @SwapNumerator, @SwapDenominator, @TransactionUserId,
                                    @TransactionDate, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, mtlItemUomCalculate);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomChange --修改Bom變更單頭 --Gpai 20230628
        public string UpdateBomChange(int BomChangeId, string EmergencyCode, string ChangeReason, string Remark)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region // 是否存在MES
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 *
                                 FROM PDM.BomChange
                                 WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        var BomChangeResult = sqlConnection.Query(sql, dynamicParameters);
                        if (BomChangeResult.Count() <= 0) throw new SystemException("【品號變更管理】－此查無此變更單紀錄");
                       // if (BomChangeResult.First().TransferStatus != "N") throw new SystemException("【品號變更管理】－此單已拋轉無法更改");
                        if (BomChangeResult.FirstOrDefault().CompanyId != CurrentCompany) throw new SystemException("【BOM變更管理】－此變更單不屬於目前公司別!");
                        #endregion

                        #region //更新
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomChange SET
                                EmergencyCode=@EmergencyCode,
                                ChangeReason=@ChangeReason,
                                Remark=@Remark,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                EmergencyCode,
                                ChangeReason,
                                Remark,
                                LastModifiedDate,
                                LastModifiedBy,
                                BomChangeId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                        #endregion
                    }
                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomChangeDetail --修改Bom變更單身 --Gpai 20231103
        public string UpdateBomChangeDetail(int BomChangeDetailId, string MoPrefix)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region // 是否存在MES
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                 FROM PDM.BomChangeDetail
                                 WHERE BomChangeDetailId = @BomChangeDetailId";
                        dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【BOM變更管理】－查無此變更單紀錄");
                        
                        #endregion

                        #region //更新
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomChangeDetail SET
                                MoPrefix=@MoPrefix,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomChangeDetailId = @BomChangeDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MoPrefix,
                                LastModifiedDate,
                                LastModifiedBy,
                                BomChangeDetailId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                        #endregion
                    }
                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomChangeSubDetail --修改Bom變更子單身 --Gpai 20231103 
        public string UpdateBomChangeSubDetail(int BomChangeSubDetailId, double CompositionQuantity, double Base, string ComponentType
            , double LossRate, string EffectiveDate, string ExpirationDate, string ChangeReason, string NewRemark, string StandardCostingType, string MaterialProperties)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    double lostrate = LossRate * 0.01;

                    string NewEffectiveDate = "";
                    string NewExpirationDate = "";

                    if (EffectiveDate == "")
                    {
                        NewEffectiveDate = null;
                    }
                    else
                    {
                        NewEffectiveDate = EffectiveDate;
                    }

                    if (ExpirationDate == "")
                    {
                        NewExpirationDate = null;
                    }
                    else
                    {
                        NewExpirationDate = ExpirationDate;
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region // 是否存在MES
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                 FROM PDM.BomChangeSubDetail
                                 WHERE BomChangeSubDetailId = @BomChangeSubDetailId";
                        dynamicParameters.Add("BomChangeSubDetailId", BomChangeSubDetailId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        //if (result.Count() <= 0) throw new SystemException("【BOM變更管理】－查無此變更單紀錄");

                        foreach (var item in result) {
                            //if (item.OriginalCompositionQuantity == CompositionQuantity) throw new SystemException("【BOM變更管理】－與原資料相同");
                            //if (item.OriginalBase == Base) throw new SystemException("【BOM變更管理】－與原資料相同");
                            //if (item.OriginalLossRate == LossRate) throw new SystemException("【BOM變更管理】－與原資料相同");
                            //if (item.OriginalEffectiveDate == EffectiveDate) throw new SystemException("【BOM變更管理】－與原資料相同");
                            //if (item.OriginalExpirationDate == ExpirationDate) throw new SystemException("【BOM變更管理】－與原資料相同");
                            //if (item.OriginalStandardCosting == StandardCostingType) throw new SystemException("【BOM變更管理】－與原資料相同");
                            //if (item.OriginalBomType == MaterialProperties) throw new SystemException("【BOM變更管理】－與原資料相同");
                            
                        }

                        #endregion

                        #region //更新
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomChangeSubDetail SET
                                CompositionQuantity = @CompositionQuantity,
                                Base = @Base,
                                LossRate = @LossRate,
                                EffectiveDate = @EffectiveDate,
                                ExpirationDate = @ExpirationDate,
                                ChangeReason = @ChangeReason,
                                NewRemark = @NewRemark,
                                StandardCosting = @StandardCosting,
                                BomType = @BomType,
ComponentType = @ComponentType,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomChangeSubDetailId = @BomChangeSubDetailId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                CompositionQuantity,
                                Base,
                                LossRate = lostrate,
                                EffectiveDate = NewEffectiveDate,
                                ExpirationDate = NewExpirationDate,
                                ChangeReason,
                                NewRemark,
                                StandardCosting = StandardCostingType,
                                BomType = MaterialProperties,
                                ComponentType,
                                LastModifiedDate,
                                LastModifiedBy,
                                BomChangeSubDetailId
                            });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                        #endregion
                    }
                    transactionScope.Complete();

                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlitemChangeToErp --品號變更單拋轉Erp --GPai 20230706
        public string UpdateMtlitemChangeToErp(int MtlItemChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    List<INVTL> mtlChange = new List<INVTL>();
                    List<INVTM> mtlChageDetail = new List<INVTM>();

                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");

                    string ErpNo = "";

                    string userNo = "";

                    int rowsAffected = 0;

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷變更單是否拋轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 *
                                FROM PDM.MtlItemChange
                                WHERE MtlItemChangeId = @MtlItemChangeId AND TransferStatus = 'N'";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.FirstOrDefault().CompanyId != CurrentCompany) throw new SystemException("【品號變更管理】－此變更單不屬於目前公司別!");

                        #endregion


                        if (result.Count() > 0)
                        {

                            #region //撈取單頭資料
                            sql = @"SELECT b.MtlItemNo TL001, a.OriginalMtlItemName TL002, a.OriginalMtlItemSpec TL003, a.ChangeEdition TL004, a.ChangeDate TL005, a.DelMtlItemStatus TL006
                                , a.NewMtlItemName TL007, a.NewMtlItemSpec TL008, c.UserNo TL009, a.Remark TL010, a.ConfirmStatus TL014, a.SignOffStatus TL015, a.OriginalEdition TL023  
                                FROM PDM.MtlItemChange a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                                INNER JOIN BAS.[User] c ON c.UserId = a.UpdateBy 
                                WHERE a.MtlItemChangeId = @MtlItemChangeId AND a.TransferStatus = 'N'";

                            dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                            mtlChange = sqlConnection.Query<INVTL>(sql, dynamicParameters).ToList();
                            #endregion

                            #region //撈取單身資料
                            sql = @"SELECT b.MtlItemNo TM001, a.ChangeEdition TM002, a.SortNum TM003, a.FieldNum TM004, a.FieldName TM005, a.NewTextField TM006, 
                                    ISNULL(a.OriginalTextField, '') TM007, a.NewNumericField TM008, a.OriginalNumericField TM009, a.FieldType TM010, a.RetentionField TM011, a.Remark TM012, a.ConfirmStatus TM013, 
                                    a.NewFieldName TM014, ISNULL(a.OriginalFieldName , '')TM015
                                    FROM PDM.MtlItemChangeDetail a
                                    INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                                    WHERE MtlItemChangeId = @MtlItemChangeId";

                            dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                            mtlChageDetail = sqlConnection.Query<INVTM>(sql, dynamicParameters).ToList();

                            foreach (var item in mtlChageDetail)
                            {
                                if (item.TM004 == "MB030" || item.TM004 == "MB031")
                                {
                                    var tm006 = (item.TM006 != "") ? DateTime.Parse(item.TM006).ToString("yyyyMMdd"): "";
                                    var tm014 = (item.TM014 != "") ? DateTime.Parse(item.TM014).ToString("yyyyMMdd"): "";

                                    //var tm007 = "";
                                    //var tm015 = "";
                                    //if (item.TM007 != "" || item.TM007 != null)
                                    //{
                                    //    tm007 = DateTime.Parse(item.TM007).ToString("yyyyMMdd");
                                    //}
                                    //else {
                                    //    tm007 = "";
                                    //}

                                    //if (item.TM015 != "" || item.TM015 != null)
                                    //{
                                    //    tm015 = DateTime.Parse(item.TM015).ToString("yyyyMMdd");
                                    //}
                                    //else
                                    //{
                                    //    tm015 = "";
                                    //}
                                    var tm007 = (item.TM007 != "") ? DateTime.Parse(item.TM007).ToString("yyyyMMdd") : "";
                                    var tm015 = (item.TM015 != "") ? DateTime.Parse(item.TM015).ToString("yyyyMMdd") : "";

                                    mtlChageDetail
                                        .Where(w => w.TM003 == item.TM003)
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.TM006 = tm006;
                                            x.TM007 = tm007;
                                            x.TM014 = tm014;
                                            x.TM015 = tm015;

                                        });
                                }


                            }


                            #endregion

                            #region //撈取使用者No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UserNo
                                FROM BAS.[User] a
                                WHERE a.UserId = @userId";
                            dynamicParameters.Add("userId", CurrentUser);
                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            userNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).UserNo;

                            if (result3.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            foreach (var item in result3)
                            {
                                mtlChange
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = item.UserNo;
                                        x.CREATE_AP = item.UserNo + "PC";
                                        x.TL009 = item.UserNo;
                                    });

                                mtlChageDetail
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = item.UserNo;
                                        x.CREATE_AP = item.UserNo + "PC";
                                    });
                            }
                            #endregion
                        }
                        else
                        {
                            throw new SystemException("該變更單已拋轉!");
                        }



                    }

                    if (mtlChange.Count() > 0)
                    {
                        string newEdition = "0001";

                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            var USR_GROUP = BaseHelper.CheckErpAuthority(userNo, sqlConnection, "MOCI02", "CREATE");

                            string oldEdition = "0000";

                            #region //判斷ERP使用者是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @User";
                            dynamicParameters.Add("CompanyNo", ErpNo);
                            dynamicParameters.Add("User", userNo);

                            var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUserExist.Count() <= 0) throw new SystemException("ERP使用者不存在!");

                            string adminUser = "N";
                            foreach (var item in resultUserExist)
                            {
                                adminUser = item.MF005; //超級使用者
                            }
                            #endregion


                            #region //判斷是否有未確認版本
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TL001, TL004, TL023 , TL014
                                    FROM INVTL
                                    WHERE RTRIM(LTRIM(TL001)) = @TL001 AND TL014 = 'N'
                                    ORDER BY TL004 DESC";
                            dynamicParameters.Add("TL001", mtlChange.First().TL001);
                            var erpResult = sqlConnection.Query(sql, dynamicParameters);
                            if (erpResult.Count() > 0) throw new SystemException("此品號有ERP未確認單據! " + erpResult.First().TL004);

                            #endregion


                            #region //取得ERP版本
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TL001, TL004, TL023 , TL014
                                    FROM INVTL
                                    WHERE RTRIM(LTRIM(TL001)) = @TL001
                                    ORDER BY TL004 DESC";
                            dynamicParameters.Add("TL001", mtlChange.First().TL001);
                            var erpEdition = sqlConnection.Query(sql, dynamicParameters);
                            if (erpEdition.Count() > 0)
                            {
                                int num = Convert.ToInt32(erpEdition.First().TL004);
                                string eee = "0000" + (num + 1);
                                newEdition = eee.Substring(eee.Length - 4);
                                oldEdition = erpEdition.First().TL004;
                            }

                            #endregion


                            if (mtlChange.Where(x => x.TL014 == "N").Any())
                            {
                                #region //單頭新增
                                if (mtlChange.Count > 0)
                                {
                                    mtlChange
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.COMPANY = ErpNo;
                                            x.USR_GROUP = USR_GROUP;
                                            x.CREATE_DATE = dateNow;
                                            x.MODIFIER = "";
                                            x.MODI_DATE = "";
                                            x.FLAG = "1";
                                            x.CREATE_TIME = timeNow;
                                            x.CREATE_PRID = "BM";
                                            x.MODI_TIME = "";
                                            x.MODI_AP = "";
                                            x.MODI_PRID = "";
                                            x.TL004 = newEdition;
                                            x.TL005 = dateNow;
                                            x.TL011 = "0";
                                            x.TL012 = "";
                                            x.TL013 = "";
                                            x.TL016 = 0;
                                            x.TL017 = 0;
                                            x.TL023 = oldEdition;
                                            x.UDF01 = "";
                                            x.UDF02 = "";
                                            x.UDF03 = "";
                                            x.UDF04 = "";
                                            x.UDF05 = "";
                                            x.UDF06 = 0;
                                            x.UDF07 = 0;
                                            x.UDF08 = 0;
                                            x.UDF09 = 0;
                                            x.UDF10 = 0;
                                        });

                                    sql = @"INSERT INTO INVTL (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TL001, TL002, TL003, TL004, TL005, TL006, TL007, TL008, TL009, TL010
                                            , TL011, TL012, TL013, TL014, TL015, TL016, TL017, TL023
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                           , @TL001, @TL002, @TL003, @TL004, @TL005, @TL006, @TL007, @TL008, @TL009, @TL010
                                            , @TL011, @TL012, @TL013, @TL014, @TL015, @TL016, @TL017, @TL023
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                    rowsAffected += sqlConnection.Execute(sql, mtlChange);
                                }
                                #endregion

                                #region //單身新增
                                if (mtlChageDetail.Count > 0)
                                {
                                    mtlChageDetail
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.COMPANY = ErpNo;
                                            x.USR_GROUP = USR_GROUP;
                                            x.CREATE_DATE = dateNow;
                                            x.MODIFIER = "";
                                            x.MODI_DATE = "";
                                            x.FLAG = "1";
                                            x.CREATE_TIME = timeNow;
                                            x.CREATE_PRID = "BM";
                                            x.MODI_TIME = "";
                                            x.MODI_AP = "";
                                            x.MODI_PRID = "";
                                            x.TM002 = newEdition;
                                            x.TM013 = "N";
                                            x.UDF01 = "";
                                            x.UDF02 = "";
                                            x.UDF03 = "";
                                            x.UDF04 = "";
                                            x.UDF05 = "";
                                            x.UDF06 = 0;
                                            x.UDF07 = 0;
                                            x.UDF08 = 0;
                                            x.UDF09 = 0;
                                            x.UDF10 = 0;
                                        });

                                    sql = @"INSERT INTO INVTM (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TM001, TM002, TM003, TM004, TM005, TM006, TM007, TM008, TM009, TM010
                                            , TM011, TM012, TM013, TM014, TM015
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TM001, @TM002, @TM003, @TM004, @TM005, @TM006, @TM007, @TM008, @TM009, @TM010
                                            , @TM011, @TM012, @TM013, @TM014, @TM015
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                    rowsAffected += sqlConnection.Execute(sql, mtlChageDetail);
                                }
                                #endregion
                            }
                            else
                            {
                                throw new SystemException("此單已拋轉!");
                            }
                        }

                        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                        {
                            #region//修改BM單頭確認狀態/拋轉狀態/時間
                            sql = @"UPDATE PDM.MtlItemChange SET
                                    ChangeEdition = @ChangeEdition,
                                    TransferStatus = @TransferStatus,
                                    TransferDate = @TransferDate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy 
                                    WHERE MtlItemChangeId = @MtlItemChangeId";
                            dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);

                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ChangeEdition = newEdition,
                                    TransferStatus = "Y",
                                    TransferDate = dateNow,
                                    LastModifiedDate,
                                    LastModifiedBy
                                });
                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region//修改BM單身確認狀態
                            sql = @"UPDATE PDM.MtlItemChangeDetail SET
                                    ChangeEdition = @ChangeEdition,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy 
                                    WHERE MtlItemChangeId = @MtlItemChangeId";
                            dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ChangeEdition = newEdition,
                                    LastModifiedDate,
                                    LastModifiedBy
                                });
                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                    }

                    transactionScope.Complete();
                }
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "拋轉成功"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomChangeToErp --BOM變更單拋轉Erp --GPai 20230706  
        public string UpdateBomChangeToErp(int BomChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    List<BOMTA> bomChange = new List<BOMTA>();
                    List<BOMTB> bomChageDetail = new List<BOMTB>();
                    List<BOMTC> bomChageSubDetail = new List<BOMTC>();

                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");

                    string ta003 = "";
                    string ta009 = "";


                    string ErpNo = "";

                    string userNo = "";

                    int rowsAffected = 0;

                    string bomChangeNo = "";

                    string tb110 = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //確認公司別DB
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var companyResult = sqlConnection.Query(sql, dynamicParameters);

                        if (companyResult.Count() <= 0) throw new SystemException("公司別錯誤!");

                        foreach (var item in companyResult)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpNo = item.ErpNo;
                        }
                        #endregion

                        #region //判斷變更單是否拋轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 *
                                FROM PDM.BomChange
                                WHERE BomChangeId = @BomChangeId AND TransferStatus = 'N'";
                        dynamicParameters.Add("BomChangeId", BomChangeId);


                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.FirstOrDefault().CompanyId != CurrentCompany) throw new SystemException("【BOM變更管理】－此變更單不屬於目前公司別!");
                        #endregion


                        if (result.Count() > 0)
                        {

                            #region //撈取單頭資料
                            sql = @"SELECT a.BomChangePrefix TA001,a.BomChangeNo TA002,a.ChangeDate TA003,a.EmergencyCode TA004,a.ChangeReason TA005,a.Remark TA006
                                    , a.ConfirmStatus TA007,a.PrintCount TA008,a.ChangeDate TA009,a.ConfirmBy TA010,a.SendCount TA012 
                                    FROM PDM.BomChange a
                                    WHERE a.BomChangeId = @BomChangeId AND a.TransferStatus = 'N'";

                            dynamicParameters.Add("BomChangeId", BomChangeId);
                            bomChange = sqlConnection.Query<BOMTA>(sql, dynamicParameters).ToList();
                            ta003 = DateTime.Parse(bomChange.First().TA003).ToString("yyyyMMdd");
                            ta009 = DateTime.Parse(bomChange.First().TA009).ToString("yyyyMMdd");


                            #endregion

                            #region //撈取單身資料
                            sql = @"SELECT b.BomChangeNo TB002,a.SortNum TB003,c.MtlItemNo TB004,d.UomNo TB005, a.SmallUnit TB006,a.ChangeEdition TB007,a.StandardLot TB008,a.MoPrefix TB009,a.ChangeReason TB010, a.ConfirmStatus TB012,a.NewRemark TB013
                                    , a.BomChangeSource TB016 
                                    , e.MtlItemNo TB104, f.UomNo TB105, a.SmallUnit TB006, a.OriginalChangeEdition TB107,a.OriginalStandardLot TB108,a.OriginalMoPrefix TB109, a.MtlItemId, a.Unit, a.BomId, a.BomChangeDetailId
                                    FROM PDM.BomChangeDetail a
                                    INNER JOIN PDM.BomChange b ON b.BomChangeId = a.BomChangeId
                                    INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                                    INNER JOIN PDM.UnitOfMeasure d ON d.UomId = a.Unit
                                    INNER JOIN PDM.MtlItem e ON e.MtlItemId = a.OriginalMtlItemId
                                    INNER JOIN PDM.UnitOfMeasure f ON f.UomId = a.OriginalUnit
                                    INNER JOIN PDM.BomChange g ON g.BomChangeId = a.OriginalBomChangeId
                                    WHERE a.BomChangeId = @BomChangeId";

                            dynamicParameters.Add("BomChangeId", BomChangeId);
                            bomChageDetail = sqlConnection.Query<BOMTB>(sql, dynamicParameters).ToList();
                            if (bomChageDetail.Count() <= 0) throw new SystemException("無單身資料無法拋轉!");

                            foreach (var item in bomChageDetail)
                            {

                                if (item.TB107 == "0000")
                                {
                                    tb110 = "";
                                }
                                else
                                {
                                    tb110 = "4101";
                                }


                                bomChageDetail
                                    .Where(w => w.TB004 == item.TB004)
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.TB001 = "4101";
                                        x.TB110 = tb110;
                                        x.TB011 = "";
                                        x.TB016 = "";
                                        x.TB106 = "";
                                        x.TB111 = "";
                                        x.TB112 = "";
                                        x.TB113 = "";//
                                    });

                            }


                            #endregion

                            #region //撈取子單身資料
                            sql = @"SELECT b.BomChangeNo TC002, c.SortNum TC003, a.BomSortNum TC004, d.MtlItemNo TC005, e.UomNo TC006, a.SmallUnit TC007, a.CompositionQuantity TC008, a.Base TC009,a.LossRate TC010,a.SubstituteStatus TC012,a.EffectiveDate TC013, a.ExpirationDate TC014, a.OptionalPreset TC015, a.StandardCosting TC016, a.ChangeReason TC018, a.BomType TC019, a.FeedingInterval TC020, a.NewRemark TC029, a.Provide TC032
                                    , a.OriginalBomSortNum TC104 , g.MtlItemNo TC105, h.UomNo TC106, a.OriginalSmallUnit TC107, a.OriginalCompositionQuantity TC108, a.OriginalBase TC109, a.OriginalLossRate TC110, a.OriginalSubstituteStatus TC112, a.OriginalEffectiveDate TC113, a.OriginalExpirationDate TC114, a.OriginalOptionalPreset TC115, a.OriginalStandardCosting TC116, a.OriginalBomType TC119, a.OriginalFeedingInterval TC120, a.Provide TC132, a.DeleteStatus, a.ComponentType UDF01, a.OriginalComponentType UDF02
                                    FROM PDM.BomChangeSubDetail a
                                    INNER JOIN PDM.BomChange b ON b.BomChangeId = a.BomChangeId
                                    INNER JOIN PDM.BomChangeDetail c ON c.BomChangeDetailId = a.BomChangeDetailId
                                    INNER JOIN PDM.MtlItem d ON d.MtlItemId = a.MtlItemId
                                    INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.Unit
									LEFT JOIN PDM.BomDetail f ON f.BomDetailId = a.BomDetailId
									LEFT JOIN PDM.MtlItem g ON g.MtlItemId = f.MtlItemId
									LEFT JOIN PDM.UnitOfMeasure h ON h.UomId = f.UomId
                                    WHERE a.BomChangeId = @BomChangeId";

                            dynamicParameters.Add("BomChangeId", BomChangeId);
                            var bomChageSubDetailResult = sqlConnection.Query(sql, dynamicParameters);//
                            bomChageSubDetail = sqlConnection.Query<BOMTC>(sql, dynamicParameters).ToList();

                            foreach (var item in bomChageSubDetailResult)
                            {
                                string tc013 = "";
                                string tc014 = "";
                                string tc113 = "";
                                string tc114 = "";
                                string tc105 = "";
                                string tc005 = "";
                                string tc111 = "";
                                double tc010 = (item.TC010);

                                tc013 = item.TC013 != null ? item.TC013.ToString("yyyyMMdd") : "";
                                tc014 = item.TC014 != null ? item.TC014.ToString("yyyyMMdd") : "";
                                tc113 = item.TC113 != null ? item.TC113.ToString("yyyyMMdd") : "";
                                tc114 = item.TC114 != null ? item.TC114.ToString("yyyyMMdd") : "";
                                tc105 = item.TC104.Length > 0 ? item.TC105 : "";
                                tc005 = item.DeleteStatus == "N" ? item.TC005 : "";
                                tc111 = item.TC104.Length > 0 ? "****" : "";

                                bomChageSubDetail
                                    .Where(w => w.TC005 == item.TC005)
                                    .Where(w => w.TC004 == item.TC004)
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.TC005 = tc005;
                                        x.TC010 = tc010;
                                        x.TC013 = tc013;
                                        x.TC014 = tc014;
                                        x.TC105 = tc105;
                                        x.TC111 = tc111;
                                        x.TC113 = tc113;
                                        x.TC114 = tc114;
                                    });

                            }

                            #endregion

                            #region //撈取使用者No
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.UserNo
                                FROM BAS.[User] a
                                WHERE a.UserId = @userId";
                            dynamicParameters.Add("userId", CurrentUser);
                            var result3 = sqlConnection.Query(sql, dynamicParameters);
                            userNo = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).UserNo;

                            if (result3.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                            foreach (var item in result3)
                            {
                                bomChange
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = item.UserNo;
                                        x.CREATE_AP = item.UserNo + "PC";
                                    });

                                bomChageDetail
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = item.UserNo;
                                        x.CREATE_AP = item.UserNo + "PC";
                                    });

                                bomChageSubDetail
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = item.UserNo;
                                        x.CREATE_AP = item.UserNo + "PC";
                                    });
                            }
                            #endregion
                        }
                        else
                        {
                            throw new SystemException("該變更單已拋轉!");
                        }



                    }

                    if (bomChange.Count() > 0)
                    {
                        using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                        {

                            //string newEdition = "0001";
                            //string oldEdition = "0000";
                            string oldBomChangeNo = "";
                            string oldBomChangeSort = "";
                            string oldRemark = "";
                            //string erpNo = "";
                            string docDate = "";


                            var USR_GROUP = BaseHelper.CheckErpAuthority(userNo, sqlConnection, "MOCI02", "CREATE");

                            #region //判斷ERP使用者是否存在
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @User";
                            dynamicParameters.Add("CompanyNo", ErpNo);
                            dynamicParameters.Add("User", userNo);

                            var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                            if (resultUserExist.Count() <= 0) throw new SystemException("ERP使用者不存在!");

                            string adminUser = "N";
                            foreach (var item in resultUserExist)
                            {
                                adminUser = item.MF005; //超級使用者
                            }
                            #endregion


                            #region //取得單頭ERP最新單號
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MAX(TA002) BomChangeNo, MAX(TA009) docDate FROM BOMTA";


                            var noResult = sqlConnection.Query(sql, dynamicParameters);
                            //erpNo = noResult.First().BomChangeNo;
                            docDate = noResult.First().docDate;

                            //if (erpNo.Substring(0, 8) != dateNow)
                            //{
                            //    bomChangeNo = dateNow + "001";
                            //}
                            //else
                            //{
                            //    var newNoNum = Int64.Parse(erpNo);
                            //    bomChangeNo = (newNoNum + 1).ToString();
                            //}

                            ////////////////
                            ////////////////
                            var erpPrefix = "4101";
                            DateTime referenceTime = default(DateTime);
                            referenceTime = DateTime.ParseExact(docDate, "yyyyMMdd", CultureInfo.InvariantCulture);


                            #region //單據設定
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MQ004, a.MQ005, a.MQ006, a.MQ044
                                FROM CMSMQ a
                                WHERE a.COMPANY = @CompanyNo
                                AND a.MQ001 = @ErpPrefix";
                            dynamicParameters.Add("CompanyNo", ErpNo);
                            dynamicParameters.Add("ErpPrefix", erpPrefix);

                            var resultDocSetting = sqlConnection.Query(sql, dynamicParameters);
                            if (resultDocSetting.Count() <= 0) throw new SystemException("ERP單據設定資料不存在!");

                            string encode = "", exchangeRateSource = "";
                            int yearLength = 0, lineLength = 0;
                            foreach (var item in resultDocSetting)
                            {
                                encode = item.MQ004; //編碼方式
                                yearLength = Convert.ToInt32(item.MQ005); //年碼數
                                lineLength = Convert.ToInt32(item.MQ006); //流水號碼數
                                exchangeRateSource = item.MQ044; //匯率來源
                            }
                            #endregion

                            #region //單號取號
                            int currentNum = 0;

                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TA002))), '" + new string('0', lineLength) + @"'), " + lineLength + @")) + 1 CurrentNum
                                FROM BOMTA
                                WHERE TA001 = @ErpPrefix";
                            dynamicParameters.Add("ErpPrefix", erpPrefix);


                            #region //編碼方式
                            string dateFormat = "";
                            switch (encode)
                            {
                                case "1": //日編
                                    dateFormat = new string('y', yearLength) + "MMdd";
                                    sql += @" AND RTRIM(LTRIM(TA002)) LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                    dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                    bomChangeNo = referenceTime.ToString(dateFormat);
                                    break;
                                case "2": //月編
                                    dateFormat = new string('y', yearLength) + "MM";
                                    sql += @" AND RTRIM(LTRIM(TA002)) LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                    dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                    bomChangeNo = referenceTime.ToString(dateFormat);
                                    break;
                                case "3": //流水號
                                    break;
                                case "4": //手動編號
                                    break;
                                default:
                                    throw new SystemException("編碼方式錯誤!");
                            }
                            #endregion

                            currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                            bomChangeNo += string.Format("{0:" + new string('0', lineLength) + "}", currentNum);
                            #endregion





                            bomChageDetail
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.TB002 = bomChangeNo;
                                    });

                            #endregion

                            #region //取得單身ERP原資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MD001, MD003, MD013, MD014, MD017 
                                    FROM BOMMD
                                    WHERE MD001 IN @MD001 AND MD003 IN @MD003";
                            dynamicParameters.Add("MD001", bomChageDetail.Select(x => x.TB004).ToArray());
                            dynamicParameters.Add("MD003", bomChageSubDetail.Select(x => x.TC105).ToArray());
                            //dailyDeliveryWipUnLinkDetails.Select(x => x.SoErpFullNo).ToArray()
                            var vesult = sqlConnection.Query(sql, dynamicParameters);
                            //if (vesult.Count() <= 0) throw new SystemException("該品號無前一版本Bom資料");


                            foreach (var item in vesult)
                            {
                                bomChageSubDetail
                                .Where(w => w.TC105 == item.MD003)
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TC115 = item.MD013;
                                    x.TC116 = item.MD014;
                                    x.TC119 = item.MD017;

                                });
                            }
                            foreach (var item1 in bomChageDetail)
                            {
                                foreach (var item2 in bomChageSubDetail)
                                {
                                    #region // 找出BOM最大序號比對新序號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 MD002
                                             FROM BOMMD
                                             WHERE MD001 = @MD001
                                             ORDER BY MD002 DESC";
                                    dynamicParameters.Add("MD001", item1.TB004);
                                    var MtlItemNoErpBomResult = sqlConnection.Query(sql, dynamicParameters);
                                    if (item2.TC105 == "")//新增元件時才跑這段
                                    {
                                        foreach (var item3 in MtlItemNoErpBomResult)
                                        {
                                            var aa = int.Parse(item2.TC004);//新序號
                                            var bb = int.Parse(item3.MD002);//現有最大序號

                                            if (aa <= bb)
                                            {
                                                var seq1 = aa + 10;
                                                var serial1 = "0000" + seq1;
                                                var tc004SortNum = serial1.Substring(serial1.Length - 4);

                                                var seq2 = bb + 10;
                                                var serial2 = "0000" + seq2;
                                                var newTc004 = serial2.Substring(serial2.Length - 4);

                                                bomChageSubDetail
                                                     .Where(w => w.TC004 == tc004SortNum)
                                                     .ToList()
                                                     .ForEach(x =>
                                                     {
                                                         x.TC004 = newTc004;
                                                     });
                                            
                                            }
                                        }
                                    }
                                    #endregion

                                }


                            }


                            #endregion

                            #region //檢查ERP是否有未確認單據
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB008, TB009, TB012, TB013
                                FROM BOMTB
                                WHERE TB012 = 'N' AND TB001 = @TB001 AND RTRIM(LTRIM(TB004)) IN @TB004
                                ORDER BY TB002 DESC,TB007 DESC";
                            dynamicParameters.Add("TB004", bomChageDetail.Select(x => x.TB004).ToArray());
                            dynamicParameters.Add("TB001", "4101");

                            var nocheckEditionErpResult = sqlConnection.Query(sql, dynamicParameters);
                            if (nocheckEditionErpResult.Count() > 0)
                            {
                                foreach (var item in nocheckEditionErpResult)
                                {
                                    var tb012 = item.TB012;

                                    if (tb012 == "N")
                                    {

                                        using (SqlConnection sqlConnection2 = new SqlConnection(MainConnectionStrings))
                                        {
                                            #region //檢查未拋轉變更單是否存在MES
                                            dynamicParameters = new DynamicParameters();
                                            sql = @" SELECT * FROM PDM.BomChange
                                    WHERE BomChangePrefix = @TB001 AND BomChangeNo = @TB002";
                                            dynamicParameters.Add("TB001", item.TB001);
                                            dynamicParameters.Add("TB002", item.TB002);

                                            var MtlItemChangeResult2 = sqlConnection2.Query(sql, dynamicParameters);
                                            if (MtlItemChangeResult2.Count() > 0)
                                            {
                                                throw new SystemException("【BOM變更管理】－此品號有未處理 MES 變更單! : " + item.TB001 + "-" + item.TB002);

                                            }
                                            else
                                            {
                                                throw new SystemException("【BOM變更管理】－此品號有未處理 ERP 變更單! : " + item.TB001 + "-" + item.TB002);
                                            }
                                            #endregion

                                        }
                                    }
                                }
                            }


                            #endregion

                            #region //取得單身ERP版本,原單號
                            foreach (var item in bomChageDetail)
                            {

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TB001, TB002, TB004, TB007, TB107, TB111, TB012, TB112 , TB113, TB003, TB013
                                    FROM BOMTB 
                                    WHERE TB012 != 'V' AND TB012 != 'N' AND RTRIM(LTRIM(TB004)) = @TB004
                                    ORDER BY TB007 DESC";
                                dynamicParameters.Add("TB004", item.TB004);
                                var erpEdition = sqlConnection.Query(sql, dynamicParameters);




                                if (erpEdition.Count() > 0)
                                {
                                    foreach (var item2 in erpEdition)
                                    {
                                        //修改原單號序號備註
                                        // if (item.TB012 == "N") throw new SystemException("此品號尚有其他版次未確認之ERP變更單! 品號: " + item.TB004);
                                        var firstItem = erpEdition.Where(w => w.TB004 == item.TB004).OrderByDescending(o => o.TB007).FirstOrDefault();
                                        int num = Convert.ToInt32(firstItem.TB007);
                                        string eee = "0000" + (num + 1);
                                        string newEdition = eee.Substring(eee.Length - 4);
                                        //oldEdition = firstItem.TB007;
                                        oldBomChangeNo = firstItem.TB002;
                                        oldBomChangeSort = firstItem.TB003;
                                        oldRemark = firstItem.TB013;

                                        bomChageDetail
                                            .Where(w => w.TB004 == item.TB004)
                                            .ToList()
                                            .ForEach(x =>
                                            {

                                                //x.TB001 = "4101";
                                                //x.TB002 = bomChangeNo;
                                                x.TB007 = newEdition;
                                                x.TB011 = "";
                                                x.TB016 = "";
                                                x.TB106 = "";
                                                x.TB111 = oldBomChangeNo;
                                                x.TB112 = oldBomChangeSort;
                                                x.TB113 = oldRemark;

                                            });
                                    }



                                }
                                else
                                {
                                    bomChageDetail
                                            .Where(w => w.TB004 == item.TB004)
                                            .ToList()
                                            .ForEach(x =>
                                            {

                                                //x.TB001 = "4101";
                                                //x.TB002 = bomChangeNo;
                                                x.TB007 = "0001";
                                                x.TB011 = "";
                                                x.TB016 = "";
                                                x.TB106 = "";
                                                x.TB111 = "";
                                                x.TB112 = "";
                                                x.TB113 = "";

                                            });
                                }
                            }




                            bomChageDetail
                                   .ToList()
                                   .ForEach(x =>
                                   {
                                       x.COMPANY = ErpNo;
                                       x.USR_GROUP = USR_GROUP;
                                       x.CREATE_DATE = dateNow;
                                       x.MODIFIER = "";
                                       x.MODI_DATE = "";
                                       x.FLAG = "1";
                                       x.CREATE_TIME = timeNow;
                                       x.CREATE_PRID = "BM";
                                       x.MODI_TIME = "";
                                       x.MODI_AP = "";
                                       x.MODI_PRID = "";
                                       x.UDF01 = "";
                                       x.UDF02 = "";
                                       x.UDF03 = "";
                                       x.UDF04 = "";
                                       x.UDF05 = "";
                                       x.UDF06 = 0;
                                       x.UDF07 = 0;
                                       x.UDF08 = 0;
                                       x.UDF09 = 0;
                                       x.UDF10 = 0;
                                   });

                            #endregion


                            if (bomChange.Where(x => x.TA007 == "N").Any())
                            {
                                #region //單頭新增
                                if (bomChange.Count > 0)
                                {
                                    bomChange
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.COMPANY = ErpNo;
                                            x.USR_GROUP = USR_GROUP;
                                            x.CREATE_DATE = dateNow;
                                            x.MODIFIER = "";
                                            x.MODI_DATE = "";
                                            x.FLAG = "1";
                                            x.CREATE_TIME = timeNow;
                                            x.CREATE_PRID = "BM";
                                            x.MODI_TIME = "";
                                            x.MODI_AP = "";
                                            x.MODI_PRID = "";
                                            x.TA002 = bomChangeNo;
                                            x.TA003 = ta003;
                                            x.TA009 = ta009;
                                            //x.CFIELD01 = x.TA001 + "-" + x.TA002;
                                            x.TA011 = "N";
                                            x.UDF01 = "";
                                            x.UDF02 = "";
                                            x.UDF03 = "";
                                            x.UDF04 = "";
                                            x.UDF05 = "";
                                            x.UDF06 = 0;
                                            x.UDF07 = 0;
                                            x.UDF08 = 0;
                                            x.UDF09 = 0;
                                            x.UDF10 = 0;
                                        });

                                    sql = @"INSERT INTO BOMTA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TA001, TA002, TA003, TA004, TA005, TA006, TA007, TA008, TA009, TA010
                                            , TA011, TA012
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TA001, @TA002, @TA003, @TA004, @TA005, @TA006, @TA007, @TA008, @TA009, @TA010
                                            , @TA011, @TA012
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                    rowsAffected += sqlConnection.Execute(sql, bomChange);
                                }
                                #endregion

                                #region //單身新增
                                if (bomChageDetail.Count > 0)
                                {

                                    foreach (var item in bomChageDetail)
                                    {
                                        sql = @"INSERT INTO BOMTB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB016
                                            , TB104, TB105, TB106, TB107, TB108, TB109, TB110, TB111, TB112, TB113
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB016
                                            , @TB104, @TB105, @TB106, @TB107, @TB108, @TB109, @TB110, @TB111, @TB112, @TB113
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        rowsAffected += sqlConnection.Execute(sql, item);
                                    }


                                }
                                #endregion

                                #region //子單身新增
                                if (bomChageSubDetail.Count > 0)
                                {
                                    bomChageSubDetail
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.COMPANY = ErpNo;
                                            x.USR_GROUP = USR_GROUP;
                                            x.CREATE_DATE = dateNow;
                                            x.MODIFIER = "";
                                            x.MODI_DATE = "";
                                            x.FLAG = "1";
                                            x.CREATE_TIME = timeNow;
                                            x.CREATE_PRID = "BM";
                                            x.MODI_TIME = "";
                                            x.MODI_AP = "";
                                            x.MODI_PRID = "";
                                            x.TC001 = "4101";
                                            x.TC002 = bomChangeNo;
                                            x.TC011 = "****";
                                            x.TC012 = "";
                                            x.TC017 = "";
                                            x.TC021 = "";
                                            x.TC022 = "";
                                            x.TC023 = "";
                                            x.TC024 = "";
                                            x.TC025 = "";
                                            x.TC112 = "";
                                            x.TC117 = "";
                                            x.TC121 = "";
                                            x.TC122 = "";
                                            x.TC123 = "";
                                            x.TC124 = "";
                                            x.TC125 = "";
                                            x.TC129 = "";
                                            //x.UDF01 = "";
                                            //x.UDF02 = "";
                                            x.UDF03 = "";
                                            x.UDF04 = "";
                                            x.UDF05 = "";
                                            x.UDF06 = 0;
                                            x.UDF07 = 0;
                                            x.UDF08 = 0;
                                            x.UDF09 = 0;
                                            x.UDF10 = 0;
                                        });

                                    foreach (var item in bomChageSubDetail)
                                    {
                                        sql = @"INSERT INTO BOMTC (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TC001, TC002, TC003, TC004, TC005, TC006, TC007, TC008, TC009, TC010, TC011, TC012, TC013, TC014, TC015, TC016, TC017, TC018, TC019, TC020, TC021, TC022, TC023, TC024, TC025, TC029,  TC032
                                            , TC104, TC105, TC106, TC107, TC108, TC109, TC110, TC111, TC112, TC113, TC114, TC115, TC116, TC117, TC119, TC120, TC121, TC122, TC123, TC124, TC125, TC129, TC132 
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TC001, @TC002, @TC003, @TC004, @TC005, @TC006, @TC007, @TC008, @TC009, @TC010, @TC011, @TC012, @TC013, @TC014, @TC015, @TC016, @TC017, @TC018, @TC019, @TC020, @TC021, @TC022, @TC023, @TC024, @TC025, @TC029,  @TC032
                                            , @TC104, @TC105, @TC106, @TC107, @TC108, @TC109, @TC110, @TC111, @TC112, @TC113, @TC114, @TC115, @TC116, @TC117, @TC119, @TC120, @TC121, @TC122, @TC123, @TC124, @TC125, @TC129, @TC132 
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        rowsAffected += sqlConnection.Execute(sql, item);
                                    }



                                }
                                #endregion


                            }
                            else
                            {
                                throw new SystemException("此單已拋轉!");
                            }
                        }

                        using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                        {
                            #region//修改BM單頭確認狀態/拋轉狀態/時間/單號
                            sql = @"UPDATE PDM.BomChange SET
                                    BomChangeNo = @BomChangeNo,
                                    TransferStatus = @TransferStatus,
                                    TransferDate = @TransferDate,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy 
                                    WHERE BomChangeId = @BomChangeId";
                            dynamicParameters.Add("BomChangeId", BomChangeId);

                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BomChangeNo = bomChangeNo,
                                    TransferStatus = "Y",
                                    TransferDate = dateNow,
                                    LastModifiedDate,
                                    LastModifiedBy
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region//修改BM變更單身版次
                            foreach (var item in bomChageDetail)
                            {
                                sql = @"UPDATE PDM.BomChangeDetail SET
                                    ChangeEdition = @ChangeEdition,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy 
                                    WHERE BomChangeId = @BomChangeId AND BomChangeDetailId = @BomChangeDetailId";
                                dynamicParameters.Add("BomChangeId", BomChangeId);
                                dynamicParameters.Add("BomChangeDetailId", item.BomChangeDetailId);

                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        ChangeEdition = item.TB007,
                                        TransferStatus = "Y",
                                        TransferDate = dateNow,
                                        LastModifiedDate,
                                        LastModifiedBy
                                    });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            }


                            #endregion
                        }
                    }

                    transactionScope.Complete();
                }
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "success",
                    msg = "拋轉成功"
                });
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtiitemChangeConfirm //品號變更單確認
        public string UpdateMtiitemChangeConfirm(int MtlItemChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0, totalDetail = 0, mtlitemId = 0, mesDetailCount = 0, erpDetailCount = 0;
                    string companyNo = "", edition = "", mtlitemNo = "", departmentNo = "", userNo = "", userName = "", newMtlItemName = "", newMtlItemSpec = "", confirmstatus = "";
                    //List<MtlItemChangeDetail> mtlItemChangeDetail = new List<MtlItemChangeDetail>();
                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");

                    List<INVTL> mtlChange = new List<INVTL>();
                    List<INVTM> mtlChageDetail = new List<INVTM>();


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItemChange");
                        dynamicParameters.Add("DetailCode", "confirm");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region//BM變更單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemId ,b.MtlItemNo TL001, a.OriginalMtlItemName TL002, a.OriginalMtlItemSpec TL003, a.ChangeEdition TL004, a.ChangeDate TL005, a.DelMtlItemStatus TL006
                                , a.NewMtlItemName TL007, a.NewMtlItemSpec TL008, c.UserNo TL009, a.Remark TL010, a.ConfirmStatus TL014, a.SignOffStatus TL015, a.OriginalEdition TL023  
                                FROM PDM.MtlItemChange a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                                INNER JOIN BAS.[User] c ON c.UserId = a.UpdateBy 
                                WHERE a.MtlItemChangeId = @MtlItemChangeId AND a.CompanyId = @CompanyId";

                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        mtlChange = sqlConnection.Query<INVTL>(sql, dynamicParameters).ToList();
                        if (mtlChange.Count() <= 0) throw new SystemException("資料錯誤!");

                        foreach (var item in mtlChange)
                        {
                            if (item.TL004 == "Y") throw new SystemException("變更單頭已確認!");
                            mtlitemNo = item.TL001;
                            edition = item.TL004;
                            if (item.TL007 != item.TL002) { newMtlItemName = item.TL007; } else { newMtlItemName = item.TL002; };
                            if (item.TL008 != item.TL003) { newMtlItemSpec = item.TL008; } else { newMtlItemSpec = item.TL003; };
                            mtlitemId = item.MtlItemId;
                            confirmstatus = item.TL014;
                        }

                        #endregion

                        #region//BM變更單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.MtlItemNo TM001, a.ChangeEdition TM002, a.SortNum TM003, a.FieldNum TM004, a.FieldName TM005, a.NewTextField TM006, 
                                    ISNULL(a.OriginalTextField, '') TM007, a.NewNumericField TM008, a.OriginalNumericField TM009, a.FieldType TM010, a.RetentionField TM011, a.Remark TM012, a.ConfirmStatus TM013, 
                                    a.NewFieldName TM014, ISNULL(a.OriginalFieldName , '')TM015
                                    FROM PDM.MtlItemChangeDetail a
                                    INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                                WHERE MtlItemChangeId = @MtlItemChangeId";

                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);

                        mtlChageDetail = sqlConnection.Query<INVTM>(sql, dynamicParameters).ToList();
                        //mtlItemChangeDetail = sqlConnection.Query<MtlItemChangeDetail>(sql, dynamicParameters).ToList();
                        //if (mtlChageDetail.Count() <= 0) throw new SystemException("資料錯誤!");
                        totalDetail = mtlChageDetail.Count();
                        mesDetailCount = mtlChageDetail.Count();
                        if (mtlChageDetail.Count() > 0)
                        {
                            foreach (var item in mtlChageDetail)
                            {
                                if (item.TM013 == "Y") throw new SystemException("變更單身已確認!");
                                if (item.TM004 == "MB030" || item.TM004 == "MB031")
                                {
                                    var tm006 = (item.TM006 != "") ? DateTime.Parse(item.TM006).ToString("yyyyMMdd") : "";
                                    var tm014 = (item.TM014 != "") ? DateTime.Parse(item.TM014).ToString("yyyyMMdd") : "";

                                    var tm007 = (item.TM007 != "") ? DateTime.Parse(item.TM007).ToString("yyyyMMdd") : "";
                                    var tm015 = (item.TM015 != "") ? DateTime.Parse(item.TM015).ToString("yyyyMMdd") : "";

                                    mtlChageDetail
                                        .Where(w => w.TM003 == item.TM003)
                                        .ToList()
                                        .ForEach(x =>
                                        {
                                            x.TM006 = tm006;
                                            x.TM007 = tm007;
                                            x.TM014 = tm014;
                                            x.TM015 = tm015;

                                        });
                                }

                            }
                        }


                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @User";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("User", userNo);

                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("ERP使用者不存在!");

                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用)
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @User
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("User", userNo);
                        //    dynamicParameters.Add("Function", "INVI24");
                        //    dynamicParameters.Add("Auth", "___Y________"); //確認

                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) throw new SystemException("ERP使用者無權限!");
                        //}
                        #endregion

                        #region //判斷ERP變更單單頭是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM INVTL
                                WHERE TL001 = @MtlitemNo
                                AND TL004 = @Edition";
                        dynamicParameters.Add("MtlitemNo", mtlitemNo);
                        dynamicParameters.Add("Edition", edition);

                        var resultERPChange = sqlConnection.Query(sql, dynamicParameters);
                        if (resultERPChange.Count() <= 0) throw new SystemException("ERP變更頭不存在，無法進行確認!");
                        #endregion

                        #region //判斷ERP變更單單身是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM INVTM
                                WHERE TM001 = @MtlitemNo
                                AND TM002 = @Edition";
                        dynamicParameters.Add("MtlitemNo", mtlitemNo);
                        dynamicParameters.Add("Edition", edition);

                        var resultChangeNoteExist = sqlConnection.Query(sql, dynamicParameters);
                        //if (resultChangeNoteExist.Count() <= 0) throw new SystemException("ERP變更單身不存在，無法進行確認!");
                        erpDetailCount = resultChangeNoteExist.Count();
                        #endregion

                        int tempRowsAffected = 0;

                        if (confirmstatus == "R")
                        {
                            #region //ERP重新確認
                            #region //INVTL
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVTL SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TL007 = @TL007,
                                TL008 = @TL008,
                                TL012 = @ConfirmUser,
                                TL013 = @ConfirmDate,
                                TL014 = @ConfirmStatus
                                WHERE TL001 = @MtlitemNo
                                AND TL004 = @Edition";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    TL007 = newMtlItemName,
                                    TL008 = newMtlItemSpec,
                                    ConfirmUser = userNo,
                                    ConfirmDate = dateNow,
                                    ConfirmStatus = "Y",
                                    MtlitemNo = mtlitemNo,
                                    Edition = edition
                                });

                            tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            if (tempRowsAffected != 1) throw new SystemException(string.Format("ERP單據 {0}-{1} 確認失敗!", mtlitemNo, edition));
                            rowsAffected += tempRowsAffected;
                            #endregion

                            #region //INVTM

                            #region //重新確認，先刪除變更單身INVTM
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM INVTM 
                                    WHERE TM001 = @MtlitemNo
                                    AND TM002 = @Edition";
                            dynamicParameters.Add("MtlitemNo", mtlitemNo);
                            dynamicParameters.Add("Edition", edition);

                            var INVTMAff = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += INVTMAff;
                            #endregion

                            #region //重新確認，INVTM單身新增
                            var USR_GROUP = BaseHelper.CheckErpAuthority(userNo, sqlConnection, "MOCI02", "CREATE");

                            if (mtlChageDetail.Count > 0)
                            {
                                mtlChageDetail
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.COMPANY = companyNo;
                                        x.USR_GROUP = USR_GROUP;
                                        x.CREATE_DATE = dateNow;
                                        x.MODIFIER = "";
                                        x.MODI_DATE = "";
                                        x.FLAG = "1";
                                        x.CREATE_TIME = timeNow;
                                        x.CREATE_PRID = "BM";
                                        x.MODI_TIME = "";
                                        x.MODI_AP = "";
                                        x.MODI_PRID = "";
                                        x.TM013 = "Y";
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                    });

                                sql = @"INSERT INTO INVTM (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TM001, TM002, TM003, TM004, TM005, TM006, TM007, TM008, TM009, TM010
                                            , TM011, TM012, TM013, TM014, TM015
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TM001, @TM002, @TM003, @TM004, @TM005, @TM006, @TM007, @TM008, @TM009, @TM010
                                            , @TM011, @TM012, @TM013, @TM014, @TM015
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                rowsAffected += sqlConnection.Execute(sql, mtlChageDetail);
                            }
                            #endregion

                            #endregion

                            #endregion
                        }
                        else//首次確認
                        {
                            #region //ERP確認
                            #region //INVTL
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVTL SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TL012 = @ConfirmUser,
                                TL013 = @ConfirmDate,
                                TL014 = @ConfirmStatus
                                WHERE TL001 = @MtlitemNo
                                AND TL004 = @Edition";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    ConfirmUser = userNo,
                                    ConfirmDate = dateNow,
                                    ConfirmStatus = "Y",
                                    MtlitemNo = mtlitemNo,
                                    Edition = edition
                                });

                            tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            if (tempRowsAffected != 1) throw new SystemException(string.Format("ERP單據 {0}-{1} 確認失敗!", mtlitemNo, edition));
                            rowsAffected += tempRowsAffected;
                            #endregion



                            #region //INVTM
                            if (erpDetailCount > 0)
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE INVTM SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TM013 = @ConfirmStatus
                                WHERE TM001 = @MtlitemNo
                                AND TM002 = @Edition";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MODIFIER = userNo,
                                        MODI_DATE = dateNow,
                                        MODI_TIME = timeNow,
                                        MODI_AP = userNo + "PC",
                                        MODI_PRID = "BM",
                                        ConfirmStatus = "Y",
                                        MtlitemNo = mtlitemNo,
                                        Edition = edition
                                    });

                                tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                                if ((confirmstatus == "N") && (tempRowsAffected != totalDetail)) throw new SystemException(string.Format("ERP單據 {0}-{1} 單身確認失敗!", mtlitemNo, edition));
                                rowsAffected += tempRowsAffected;
                            }

                            #endregion

                            #endregion
                        }

                        #region //INVMB 品號(更新為新版)

                        #region//品名
                        if (newMtlItemName != "")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVMB SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                MB002 = @NewValue
                                WHERE MB001 = @MtlitemNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    NewValue = newMtlItemName,
                                    MtlitemNo = mtlitemNo
                                });

                            var INVMBAff1 = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += INVMBAff1;
                        }
                        #endregion

                        #region//規格
                        if (newMtlItemSpec != "")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVMB SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                MB003 = @NewValue
                                WHERE MB001 = @MtlitemNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    NewValue = newMtlItemSpec,
                                    MtlitemNo = mtlitemNo
                                });

                            var INVMBAff2 = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += INVMBAff2;
                        }
                        #endregion

                        #region//其他欄位
                        if (mesDetailCount > 0)
                        {
                            foreach (var item in mtlChageDetail)
                            {

                                var fieldNum = item.TM004;
                                if (item.TM010 == "V")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE INVMB SET
                                            MODI_PRID = @MODI_PRID,
                                            MODI_DATE = @MODI_DATE,
                                            MODI_TIME = @MODI_TIME,
                                            MODI_AP = @MODI_AP,
                                            MODIFIER = @MODIFIER,
                                            FLAG = FLAG + 1,
                                            " + fieldNum + @" = @NewValue
                                            WHERE MB001 = @MtlitemNo";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MODIFIER = userNo,
                                            MODI_DATE = dateNow,
                                            MODI_TIME = timeNow,
                                            MODI_AP = userNo + "PC",
                                            MODI_PRID = "BM",
                                            NewValue = item.TM006,
                                            MtlitemNo = mtlitemNo
                                        });

                                    var INVMBAff3 = sqlConnection.Execute(sql, dynamicParameters);
                                    rowsAffected += INVMBAff3;
                                }
                                else
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE INVMB SET
                                            MODI_PRID = @MODI_PRID,
                                            MODI_DATE = @MODI_DATE,
                                            MODI_TIME = @MODI_TIME,
                                            MODI_AP = @MODI_AP,
                                            MODIFIER = @MODIFIER,
                                            FLAG = FLAG + 1,
                                            " + fieldNum + @" = @NewValue
                                            WHERE MB001 = @MtlitemNo";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            MODIFIER = userNo,
                                            MODI_DATE = dateNow,
                                            MODI_TIME = timeNow,
                                            MODI_AP = userNo + "PC",
                                            MODI_PRID = "BM",
                                            NewValue = item.TM008,
                                            MtlitemNo = mtlitemNo
                                        });

                                    var INVMBAff3 = sqlConnection.Execute(sql, dynamicParameters);
                                    rowsAffected += INVMBAff3;
                                }




                            }
                        }

                        #endregion

                        #region//版本
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE INVMB SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                MB165 = @NewValue
                                WHERE MB001 = @MtlitemNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                NewValue = edition,
                                MtlitemNo = mtlitemNo
                            });

                        var INVMBAff4 = sqlConnection.Execute(sql, dynamicParameters);
                        rowsAffected += INVMBAff4;
                        #endregion

                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int tempRowsAffected = 0;
                        #region //BM更新]
                        #region //PDM.MtlItemChange
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItemChange SET
                                ConfirmBy = @ConfirmBy,
                                ConfirmDate = @ConfirmDate,
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmBy = LastModifiedBy,//
                                ConfirmDate = LastModifiedDate,
                                ConfirmStatus = "Y",
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("BM單據 {0}-{1} 確認失敗!", mtlitemNo, edition));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.MtlItemChangeDetail
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItemChangeDetail SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "Y",
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if ((confirmstatus == "N") && (tempRowsAffected != totalDetail)) throw new SystemException(string.Format("BM單據 {0}-{1} 單身確認失敗!", mtlitemNo, edition));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.MtlItem

                        #region//品名
                        if (newMtlItemName != "")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItem SET
                                MtlItemName = @NewValue
                                WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NewValue = newMtlItemName,
                                    MtlItemId = mtlitemId
                                });

                            var MtlItemAff1 = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += MtlItemAff1;
                        }
                        #endregion

                        #region//規格
                        if (newMtlItemSpec != "")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItem SET
                                MtlItemSpec = @NewValue
                                WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    NewValue = newMtlItemSpec,
                                    MtlItemId = mtlitemId
                                });

                            var MtlItemAff2 = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += MtlItemAff2;
                        }
                        #endregion

                        #region//其他欄位
                        if (mesDetailCount > 0)
                        {
                            foreach (var item in mtlChageDetail)
                            {
                                var fieldNum = "";
                                var newValue = "";

                                var newintValue = 0;

                                switch (item.TM004)
                                {
                                    case "MB005":
                                        fieldNum = "TypeOne";
                                        newValue = item.TM006;
                                        break;
                                    case "MB006":
                                        fieldNum = "TypeTwo";
                                        newValue = item.TM006;
                                        break;
                                    case "MB007":
                                        fieldNum = "TypeThree";
                                        newValue = item.TM006;

                                        break;
                                    case "MB008":
                                        fieldNum = "TypeFour";
                                        newValue = item.TM006;

                                        break;
                                    case "MB009":
                                        fieldNum = "MtlItemDesc";
                                        newValue = item.TM006;

                                        break;
                                    case "MB017":
                                        fieldNum = "InventoryId";//id主要庫別
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 a.InventoryId, a.InventoryNo, a.InventoryName
                                            FROM SCM.Inventory a
                                            WHERE a.InventoryNo = @InventoryNo
                                            AND a.CompanyId = @CompanyId";
                                        dynamicParameters.Add("InventoryNo", item.TM006);
                                        dynamicParameters.Add("CompanyId", CurrentCompany);

                                        var resultInventory = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var invitem in resultInventory)
                                        {
                                            newintValue = invitem.InventoryId;
                                        }


                                        break;
                                    case "MB025":
                                        fieldNum = "ItemAttribute";
                                        newValue = item.TM006;

                                        break;
                                    case "MB028":
                                        fieldNum = "MtlItemRemark";
                                        newValue = item.TM006;

                                        break;
                                    case "MB030":
                                        fieldNum = "EffectiveDate";
                                        newValue = item.TM006;

                                        break;
                                    case "MB031":
                                        fieldNum = "ExpirationDate";
                                        newValue = item.TM006;

                                        break;
                                    case "MB043":
                                        fieldNum = "MeasureType";
                                        newValue = item.TM006;

                                        break;
                                    case "MB022":
                                        fieldNum = "LotManagement";
                                        newValue = item.TM006;

                                        break;
                                    case "MB034":
                                        fieldNum = "ReplenishmentPolicy";
                                        newValue = item.TM006;

                                        break;
                                    case "MB157":
                                        fieldNum = "RequisitionInventoryId";//id主要領料庫別
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 a.InventoryId, a.InventoryNo, a.InventoryName
                                            FROM SCM.Inventory a
                                            WHERE a.InventoryNo = @InventoryNo
                                            AND a.CompanyId = @CompanyId";
                                        dynamicParameters.Add("InventoryNo", item.TM006);
                                        dynamicParameters.Add("CompanyId", CurrentCompany);

                                        var resultInventory2 = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var invitem in resultInventory2)
                                        {
                                            newintValue = invitem.InventoryId;
                                        }

                                        break;
                                    case "MB068":
                                        fieldNum = "ProductionLine";
                                        newValue = item.TM006;
                                        break;
                                    case "MB019":
                                        fieldNum = "InventoryManagement";
                                        newValue = item.TM006;
                                        break;
                                    case "MB004":
                                        fieldNum = "InventoryUomId";
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 a.UomId, a.UomNo, a.UomName, a.CompanyId
                                            FROM PDM.UnitOfMeasure a
                                            WHERE a.UomNo = @UomNo
                                            AND a.CompanyId = @CompanyId";
                                        dynamicParameters.Add("UomNo", item.TM006);
                                        dynamicParameters.Add("CompanyId", CurrentCompany);

                                        var resultUom1 = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var invitem in resultUom1)
                                        {
                                            newintValue = invitem.UomId;
                                        }
                                        break;
                                    case "MB155":
                                        fieldNum = "PurchaseUomId";
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 a.UomId, a.UomNo, a.UomName, a.CompanyId
                                            FROM PDM.UnitOfMeasure a
                                            WHERE a.UomNo = @UomNo
                                            AND a.CompanyId = @CompanyId";
                                        dynamicParameters.Add("UomNo", item.TM006);
                                        dynamicParameters.Add("CompanyId", CurrentCompany);

                                        var resultUom2 = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var invitem in resultUom2)
                                        {
                                            newintValue = invitem.UomId;
                                        }
                                        break;
                                    case "MB156":
                                        fieldNum = "SaleUomId";
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"SELECT TOP 1 a.UomId, a.UomNo, a.UomName, a.CompanyId
                                            FROM PDM.UnitOfMeasure a
                                            WHERE a.UomNo = @UomNo
                                            AND a.CompanyId = @CompanyId";
                                        dynamicParameters.Add("UomNo", item.TM006);
                                        dynamicParameters.Add("CompanyId", CurrentCompany);

                                        var resultUom3 = sqlConnection.Query(sql, dynamicParameters);
                                        foreach (var invitem in resultUom3)
                                        {
                                            newintValue = invitem.UomId;
                                        }
                                        break;
                                }

                                if (item.TM004 == "MB157" || item.TM004 == "MB017" || item.TM004 == "MB004" || item.TM004 == "MB155" || item.TM004 == "MB156")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE PDM.MtlItem SET
                                " + fieldNum + @" = @NewValue
                                WHERE MtlItemId = @MtlItemId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            NewValue = newintValue,
                                            MtlItemId = mtlitemId
                                        });

                                    var INVMBAff3 = sqlConnection.Execute(sql, dynamicParameters);
                                    rowsAffected += INVMBAff3;

                                }
                                else if (item.TM004 == "MB004" || item.TM004 == "MB005" || item.TM004 == "MB006" || item.TM004 == "MB007" || item.TM004 == "MB008" || item.TM004 == "MB009" || item.TM004 == "MB017" || item.TM004 == "MB025" || item.TM004 == "MB028" || item.TM004 == "MB030" || item.TM004 == "MB031" || item.TM004 == "MB043" || item.TM004 == "MB068" || item.TM004 == "MB155" || item.TM004 == "MB156" || item.TM004 == "MB157" || item.TM004 == "MB019" || item.TM004 == "MB022" || item.TM004 == "MB034")
                                {
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE PDM.MtlItem SET
                                " + fieldNum + @" = @NewValue
                                WHERE MtlItemId = @MtlItemId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            NewValue = newValue,
                                            MtlItemId = mtlitemId
                                        });

                                    var INVMBAff3 = sqlConnection.Execute(sql, dynamicParameters);
                                    rowsAffected += INVMBAff3;
                                }

                            }
                        }


                        #endregion

                        #region//版本
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItem SET
                                [Version] = @NewValue
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                NewValue = edition,
                                MtlItemId = mtlitemId
                            });
                        #endregion

                        #endregion

                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //UpdateMtiitemChangeReConfirm //品號變更單反確認
        public string UpdateMtiitemChangeReConfirm(int MtlItemChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0, totalDetail = 0, mtlitemId = 0;
                    string companyNo = "", edition = "", oldedition = "", mtlitemNo = "", departmentNo = "", userNo = "", userName = "";

                    List<MtlItemChange> mtlItemChange = new List<MtlItemChange>();
                    List<MtlItemChangeDetail> mtlItemChangeDetail = new List<MtlItemChangeDetail>();

                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItemChange");
                        dynamicParameters.Add("DetailCode", "reconfirm");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region//BM變更單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.MtlItemChange a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                                WHERE a.MtlItemChangeId = @MtlItemChangeId AND a.CompanyId = @CompanyId";

                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultMtlItemChange = sqlConnection.Query(sql, dynamicParameters);
                        mtlItemChange = sqlConnection.Query<MtlItemChange>(sql, dynamicParameters).ToList();
                        if (resultMtlItemChange.Count() <= 0) throw new SystemException("資料錯誤!");

                        foreach (var item in resultMtlItemChange)
                        {
                            if (item.TransferStatus == "N") throw new SystemException("變更單尚未拋轉!");
                            if (item.ConfirmStatus == "N") throw new SystemException("變更單頭已反確認!");
                            mtlitemNo = item.MtlItemNo;
                            edition = item.ChangeEdition;
                            oldedition = item.OriginalEdition;

                            mtlitemId = item.MtlItemId;
                        }

                        #endregion

                        #region//BM變更單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.MtlItemChangeDetail a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                                WHERE a.MtlItemChangeId = @MtlItemChangeId";

                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);

                        var resultMtlItemChangeDetail = sqlConnection.Query(sql, dynamicParameters);
                        mtlItemChangeDetail = sqlConnection.Query<MtlItemChangeDetail>(sql, dynamicParameters).ToList();

                        totalDetail = resultMtlItemChangeDetail.Count();

                        foreach (var item in resultMtlItemChangeDetail)
                        {
                            if (item.ConfirmStatus == "R") throw new SystemException("變更單頭已反確認!");

                        }
                        #endregion



                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @User";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("User", userNo);

                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("ERP使用者不存在!");

                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用)
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @User
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("User", userNo);
                        //    dynamicParameters.Add("Function", "INVI24");
                        //    dynamicParameters.Add("Auth", "____Y_______"); //反確認

                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) throw new SystemException("ERP使用者無權限!");
                        //}
                        #endregion

                        #region //判斷ERP變更單單頭是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM INVTL
                                WHERE TL001 = @MtlitemNo
                                AND TL004 = @Edition";
                        dynamicParameters.Add("MtlitemNo", mtlitemNo);
                        dynamicParameters.Add("Edition", edition);

                        var resultERPChange = sqlConnection.Query(sql, dynamicParameters);
                        if (resultERPChange.Count() <= 0) throw new SystemException("ERP變更單頭，無法反確認!");
                        #endregion

                        #region //判斷ERP變更單單身是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM INVTM
                                WHERE TM001 = @MtlitemNo
                                AND TM002 = @Edition";
                        dynamicParameters.Add("MtlitemNo", mtlitemNo);
                        dynamicParameters.Add("Edition", edition);

                        var resultChangeNoteExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultChangeNoteExist.Count() <= 0) throw new SystemException("ERP變更單身，無法反確認!");
                        #endregion

                        int tempRowsAffected = 0;
                        #region //ERP確認
                        #region //INVTL
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE INVTL SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TL014 = @ConfirmStatus
                                WHERE TL001 = @MtlitemNo
                                AND TL004 = @Edition";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                ConfirmStatus = "N",
                                MtlitemNo = mtlitemNo,
                                Edition = edition
                            });

                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("ERP單據 {0}-{1} 反確認失敗!", mtlitemNo, edition));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //INVTM
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE INVTM SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TM013 = @ConfirmStatus
                                WHERE TM001 = @MtlitemNo
                                AND TM002 = @Edition";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                ConfirmStatus = "N",
                                MtlitemNo = mtlitemNo,
                                Edition = edition
                            });

                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        //if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("ERP單據 {0}-{1} 單身反確認失敗!", mtlitemNo, edition));
                        rowsAffected += tempRowsAffected;
                        #endregion /resultERPChange

                        #region //INVMB

                        #region //品名規格
                        foreach (var item in resultERPChange)
                        {

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVMB SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                MB002 = @MB002,
                                MB003 = @MB003
                                WHERE MB001 = @MtlitemNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    MB002 = item.TL002,
                                    MB003 = item.TL003,
                                    MtlitemNo = mtlitemNo
                                });

                            var INVMBAff1 = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += INVMBAff1;

                        }
                        #endregion

                        #region//其他欄位
                        foreach (var item in resultChangeNoteExist)
                        {
                            var fieldNum = item.TM004;
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVMB SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                " + fieldNum + @" = @OldValue
                                WHERE MB001 = @MtlitemNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    OldValue = item.TM007,
                                    MtlitemNo = mtlitemNo
                                });


                            var INVMBAff2 = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += INVMBAff2;

                        }
                        #endregion

                        #endregion

                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int tempRowsAffected = 0;
                        #region //BM更新
                        #region //PDM.MtlItemChange
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItemChange SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "R",//反確認 = R
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("BM單據 {0}-{1} 確認失敗!", mtlitemNo, edition));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.MtlItemChangeDetail
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItemChangeDetail SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "R",//反確認 = R
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("BM單據 {0}-{1} 單身確認失敗!", mtlitemNo, edition));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.MtlItem

                        #region //品名規格
                        foreach (var item in mtlItemChange)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItem SET
                                MtlItemName = @OldMtlItemName,
                                MtlItemSpec = @OldMtlItemSpec
                                WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    OldMtlItemName = item.OriginalMtlItemName,
                                    OldMtlItemSpec = item.OriginalMtlItemSpec,
                                    MtlItemId = mtlitemId
                                });

                            var MtlItemAff1 = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += MtlItemAff1;
                        }
                        #endregion

                        #region 其他欄位
                        foreach (var item in mtlItemChangeDetail)
                        {
                            var fieldNum = "";
                            var oldValue = "";
                            var oldintValue = 0;

                            switch (item.FieldNum)
                            {
                                case "MB005":
                                    fieldNum = "TypeOne";
                                    oldValue = item.OriginalTextField;
                                    break;
                                case "MB006":
                                    fieldNum = "TypeTwo";
                                    oldValue = item.OriginalTextField;
                                    break;
                                case "MB007":
                                    fieldNum = "TypeThree";
                                    oldValue = item.OriginalTextField;

                                    break;
                                case "MB008":
                                    fieldNum = "TypeFour";
                                    oldValue = item.OriginalTextField;

                                    break;
                                case "MB009":
                                    fieldNum = "MtlItemDesc";
                                    oldValue = item.OriginalTextField;

                                    break;
                                case "MB017":
                                    fieldNum = "InventoryId";//id主要庫別
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.InventoryId, a.InventoryNo, a.InventoryName
                                            FROM SCM.Inventory a
                                            WHERE a.InventoryNo = @InventoryNo
                                            AND a.CompanyId = @CompanyId";
                                    dynamicParameters.Add("InventoryNo", item.OriginalTextField);
                                    dynamicParameters.Add("CompanyId", CurrentCompany);

                                    var resultInventory = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var invitem in resultInventory)
                                    {
                                        oldintValue = invitem.InventoryId;
                                    }


                                    break;
                                case "MB025":
                                    fieldNum = "ItemAttribute";
                                    oldValue = item.OriginalTextField;

                                    break;
                                case "MB028":
                                    fieldNum = "MtlItemRemark";
                                    oldValue = item.OriginalTextField;

                                    break;
                                case "MB030":
                                    fieldNum = "EffectiveDate";
                                    oldValue = item.OriginalTextField;

                                    break;
                                case "MB031":
                                    fieldNum = "ExpirationDate";
                                    oldValue = item.OriginalTextField;

                                    break;
                                case "MB043":
                                    fieldNum = "MeasureType";
                                    oldValue = item.OriginalTextField;

                                    break;
                                case "MB157":
                                    fieldNum = "RequisitionInventoryId";//id主要領料庫別
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 a.InventoryId, a.InventoryNo, a.InventoryName
                                            FROM SCM.Inventory a
                                            WHERE a.InventoryNo = @InventoryNo
                                            AND a.CompanyId = @CompanyId";
                                    dynamicParameters.Add("InventoryNo", item.OriginalTextField);
                                    dynamicParameters.Add("CompanyId", CurrentCompany);

                                    var resultInventory2 = sqlConnection.Query(sql, dynamicParameters);
                                    foreach (var invitem in resultInventory2)
                                    {
                                        oldintValue = invitem.InventoryId;
                                    }

                                    break;
                            }

                            if (item.FieldNum == "MB157" || item.FieldNum == "MB017")
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE PDM.MtlItem SET
                                " + fieldNum + @" = @OldValue
                                WHERE MtlItemId = @MtlItemId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        OldValue = oldintValue,
                                        MtlItemId = mtlitemId
                                    });

                                var INVMBAff3 = sqlConnection.Execute(sql, dynamicParameters);
                                rowsAffected += INVMBAff3;

                            }
                            else
                            {
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE PDM.MtlItem SET
                                " + fieldNum + @" = @OldValue
                                WHERE MtlItemId = @MtlItemId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        OldValue = oldValue,
                                        MtlItemId = mtlitemId
                                    });

                                var INVMBAff3 = sqlConnection.Execute(sql, dynamicParameters);
                                rowsAffected += INVMBAff3;
                            }



                        }
                        #endregion

                        #region //版本
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItem SET
                                [Version] = @OldValue
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                OldValue = oldedition,
                                MtlItemId = mtlitemId
                            });
                        #endregion

                        #endregion

                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //UpdateMtiitemChangeVoid //品號變更單作廢
        public string UpdateMtiitemChangeVoid(int MtlItemChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0, totalDetail = 0;
                    string companyNo = "", edition = "", mtlitemNo = "", departmentNo = "", userNo = "", userName = "";

                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItemChange");
                        dynamicParameters.Add("DetailCode", "void");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region//BM變更單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.MtlItemChange a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                                WHERE a.MtlItemChangeId = @MtlItemChangeId AND a.CompanyId = @CompanyId";

                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultMtlItemChange = sqlConnection.Query(sql, dynamicParameters);
                        if (resultMtlItemChange.Count() <= 0) throw new SystemException("資料錯誤!");

                        foreach (var item in resultMtlItemChange)
                        {
                            if (item.TransferStatus == "N") throw new SystemException("變更單尚未拋轉!");
                            if (item.ConfirmStatus == "V") throw new SystemException("變更單頭已作廢!");
                            mtlitemNo = item.MtlItemNo;
                            edition = item.ChangeEdition;
                        }

                        #endregion

                        #region//BM變更單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.MtlItemChangeDetail a
                                INNER JOIN PDM.MtlItem b ON b.MtlItemId = a.MtlItemId 
                                WHERE a.MtlItemChangeId = @MtlItemChangeId";

                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);

                        var resultMtlItemChangeDetail = sqlConnection.Query(sql, dynamicParameters);
                        //if (resultMtlItemChangeDetail.Count() <= 0) throw new SystemException("資料錯誤!");
                        totalDetail = resultMtlItemChangeDetail.Count();

                        if (resultMtlItemChangeDetail.Count() > 0)
                        {
                            foreach (var item in resultMtlItemChangeDetail)
                            {
                                if (item.ConfirmStatus == "V") throw new SystemException("變更單頭已作廢!");
                            }
                        }

                        #endregion



                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @User";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("User", userNo);

                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("ERP使用者不存在!");

                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用)
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @User
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("User", userNo);
                        //    dynamicParameters.Add("Function", "INVI24");
                        //    dynamicParameters.Add("Auth", "_________Y__"); //作廢

                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) throw new SystemException("ERP使用者無權限!");
                        //}
                        #endregion

                        #region //判斷ERP變更單單頭是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 TL014
                                FROM INVTL
                                WHERE TL001 = @MtlitemNo
                                AND TL004 = @Edition";
                        dynamicParameters.Add("MtlitemNo", mtlitemNo);
                        dynamicParameters.Add("Edition", edition);

                        var resultERPChange = sqlConnection.Query(sql, dynamicParameters);
                        if (resultERPChange.Count() <= 0) throw new SystemException("ERP變更單單據不存在，無法作廢!");
                        foreach (var item in resultERPChange)
                        {
                            if (item.TL014 == "V") throw new SystemException("ERP變更單單據已作廢!");

                        }
                        #endregion

                        #region //判斷ERP變更單單身是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 TM013
                                FROM INVTM
                                WHERE TM001 = @MtlitemNo
                                AND TM002 = @Edition";
                        dynamicParameters.Add("MtlitemNo", mtlitemNo);
                        dynamicParameters.Add("Edition", edition);

                        var resultChangeNoteExist = sqlConnection.Query(sql, dynamicParameters);
                        //if (resultChangeNoteExist.Count() <= 0) throw new SystemException("ERP變更單單據不存在，無法作廢!");
                        #endregion

                        int tempRowsAffected = 0;
                        #region //ERP確認
                        #region //INVTL
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE INVTL SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TL014 = @ConfirmStatus
                                WHERE TL001 = @MtlitemNo
                                AND TL004 = @Edition";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                ConfirmStatus = "V",
                                MtlitemNo = mtlitemNo,
                                Edition = edition
                            });

                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("ERP單據 {0}-{1} 確認作廢!", mtlitemNo, edition));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //INVTM
                        if (totalDetail > 0) {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVTM SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TM013 = @ConfirmStatus
                                WHERE TM001 = @MtlitemNo
                                AND TM002 = @Edition";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    ConfirmStatus = "V",
                                    MtlitemNo = mtlitemNo,
                                    Edition = edition
                                });

                            tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("ERP單據 {0}-{1} 單身作廢失敗!", mtlitemNo, edition));
                            rowsAffected += tempRowsAffected;
                        }
                        
                        #endregion
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int tempRowsAffected = 0;
                        #region //BM確認
                        #region //PDM.MtlItemChange
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.MtlItemChange SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "V",
                                LastModifiedDate,
                                LastModifiedBy,
                                MtlItemChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("BM單據 {0}-{1} 確認失敗!", mtlitemNo, edition));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.MtlItemChangeDetail
                        if (totalDetail > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItemChangeDetail SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ConfirmStatus = "V",
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlItemChangeId
                                });
                            tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("BM單據 {0}-{1} 單身確認失敗!", mtlitemNo, edition));
                            rowsAffected += tempRowsAffected;

                        }


                        #endregion
                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region //UpdateBomChangeConfirm //BOM變更單確認  
        public string UpdateBomChangeConfirm(int BomChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0, totalDetail = 0;
                    string companyNo = "", bomChangeNo = "", departmentNo = "", userNo = "", userName = "", newbomChangeNo = "", originbomChangeNo = "", confirmstatus = ""; ;


                    List<BOMTA> bomChange = new List<BOMTA>();
                    List<BOMTB> bomChageDetail = new List<BOMTB>();
                    List<BOMTC> bomChageSubDetail = new List<BOMTC>();


                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");


                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "BomChange");
                        dynamicParameters.Add("DetailCode", "confirm");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region//BM變更單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.BomChangePrefix TA001,a.BomChangeNo TA002,FORMAT (a.ChangeDate, 'yyyyMMdd') TA003,a.EmergencyCode TA004,a.ChangeReason TA005,a.Remark TA006
                                    , a.ConfirmStatus TA007,a.PrintCount TA008,FORMAT (a.ChangeDate, 'yyyyMMdd') TA009,a.ConfirmBy TA010,a.SendCount TA012 
                                    FROM PDM.BomChange a
                                WHERE a.BomChangeId = @BomChangeId AND a.CompanyId = @CompanyId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        bomChange = sqlConnection.Query<BOMTA>(sql, dynamicParameters).ToList();

                        if (bomChange.Count() <= 0) throw new SystemException("變更單單頭資料錯誤!");

                        foreach (var item in bomChange)
                        {
                            //if (item.TransferStatus == "N") throw new SystemException("變更單尚未拋轉!");
                            if (item.TA007 == "Y") throw new SystemException("變更單頭已確認!");
                            bomChangeNo = item.TA002;
                            confirmstatus = item.TA007;
                        }

                        #endregion

                        #region//BM變更單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT b.BomChangeNo TB002,a.SortNum TB003,c.MtlItemNo TB004,d.UomNo TB005, a.SmallUnit TB006,a.ChangeEdition TB007,a.StandardLot TB008,a.MoPrefix TB009,a.ChangeReason TB010, a.ConfirmStatus TB012,a.NewRemark TB013
                                , a.BomChangeSource TB016 
                                , e.MtlItemNo TB104, f.UomNo TB105, a.SmallUnit TB006, a.OriginalChangeEdition TB107,a.OriginalStandardLot TB108,a.OriginalMoPrefix TB109, a.BomId, a.BomChangeDetailId
                                FROM PDM.BomChangeDetail a
                                INNER JOIN PDM.BomChange b ON b.BomChangeId = a.BomChangeId
                                INNER JOIN PDM.MtlItem c ON c.MtlItemId = a.MtlItemId
                                INNER JOIN PDM.UnitOfMeasure d ON d.UomId = a.Unit
                                INNER JOIN PDM.MtlItem e ON e.MtlItemId = a.OriginalMtlItemId
                                INNER JOIN PDM.UnitOfMeasure f ON f.UomId = a.OriginalUnit
                                INNER JOIN PDM.BomChange g ON g.BomChangeId = a.OriginalBomChangeId
                                WHERE a.BomChangeId = @BomChangeId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);

                        bomChageDetail = sqlConnection.Query<BOMTB>(sql, dynamicParameters).ToList();


                        if (bomChageDetail.Count() <= 0) throw new SystemException("變更單單身資料錯誤!");
                        totalDetail = bomChageDetail.Count();

                        foreach (var item in bomChageDetail)
                        {
                            if (item.TB012 == "Y") throw new SystemException("變更單身已確認!");
                        }
                        bomChageDetail
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = userNo;
                                        x.CREATE_AP = userNo + "PC";
                                        x.COMPANY = companyNo;
                                        x.CREATE_DATE = dateNow;
                                        x.MODIFIER = "";
                                        x.MODI_DATE = "";
                                        x.FLAG = "1";
                                        x.CREATE_TIME = timeNow;
                                        x.CREATE_PRID = "BM";
                                        x.MODI_TIME = "";
                                        x.MODI_AP = "";
                                        x.MODI_PRID = "";
                                        x.TB001 = "4101";
                                        x.TB011 = "";
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                    });
                        #endregion

                        #region//BM變更單子單身
                        dynamicParameters = new DynamicParameters();//ISNULL(FORMAT (a.EffectiveDate, 'yyyyMMdd'),'') TC013
                        sql = @"SELECT b.BomChangeNo TC002, c.SortNum TC003, a.BomSortNum TC004, d.MtlItemNo TC005, e.UomNo TC006, a.SmallUnit TC007, a.CompositionQuantity TC008
                                    , a.Base TC009,a.LossRate TC010,a.SubstituteStatus TC012,ISNULL(FORMAT (a.EffectiveDate, 'yyyyMMdd'),'') TC013, ISNULL(FORMAT (a.ExpirationDate, 'yyyyMMdd'),'') TC014
                                    , a.OptionalPreset TC015, a.StandardCosting TC016, a.ChangeReason TC018, a.BomType TC019, a.FeedingInterval TC020, a.NewRemark TC029, a.Provide TC032
                                    , a.OriginalBomSortNum TC104 , g.MtlItemNo TC105, h.UomNo TC106, a.OriginalSmallUnit TC107, a.OriginalCompositionQuantity TC108
                                    , a.OriginalBase TC109, a.OriginalLossRate TC110, a.OriginalSubstituteStatus TC112, ISNULL(FORMAT (a.OriginalEffectiveDate, 'yyyyMMdd'),'') TC113, ISNULL(FORMAT (a.OriginalExpirationDate, 'yyyyMMdd'),'') TC114
                                    , a.OriginalOptionalPreset TC115, a.OriginalStandardCosting TC116, a.OriginalBomType TC119, a.OriginalFeedingInterval TC120
                                    , a.Provide TC132, a.DeleteStatus, a.MtlItemId, a.Unit, a.BomDetailId, a.BomChangeDetailId, a.ComponentType UDF01, a.OriginalComponentType UDF02
                                    FROM PDM.BomChangeSubDetail a
                                    INNER JOIN PDM.BomChange b ON b.BomChangeId = a.BomChangeId
                                    INNER JOIN PDM.BomChangeDetail c ON c.BomChangeDetailId = a.BomChangeDetailId
                                    INNER JOIN PDM.MtlItem d ON d.MtlItemId = a.MtlItemId
                                    INNER JOIN PDM.UnitOfMeasure e ON e.UomId = a.Unit
									LEFT JOIN PDM.BomDetail f ON f.BomDetailId = a.BomDetailId
									LEFT JOIN PDM.MtlItem g ON g.MtlItemId = f.MtlItemId
									LEFT JOIN PDM.UnitOfMeasure h ON h.UomId = f.UomId
                                WHERE a.BomChangeId = @BomChangeId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        bomChageSubDetail = sqlConnection.Query<BOMTC>(sql, dynamicParameters).ToList();
                        if (bomChageSubDetail.Count() > 0)
                        {
                            foreach (var item in bomChageSubDetail)
                            {

                                string tc105 = "";
                                string tc005 = "";
                                string tc111 = "";

                                double tc010 = (item.TC010);

                                tc105 = item.TC104.Length > 0 ? item.TC105 : "";
                                tc005 = item.DeleteStatus == "N" ? item.TC005 : "";
                                tc111 = item.TC104.Length > 0 ? "****" : "";

                                bomChageSubDetail
                                    .Where(w => w.TC005 == item.TC005)
                                    .Where(w => w.TC004 == item.TC004)
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = userNo;
                                        x.CREATE_AP = userNo + "PC";
                                        x.COMPANY = companyNo;
                                        x.CREATE_DATE = dateNow;
                                        x.MODIFIER = "";
                                        x.MODI_DATE = "";
                                        x.FLAG = "1";
                                        x.CREATE_TIME = timeNow;
                                        x.CREATE_PRID = "BM";
                                        x.MODI_TIME = "";
                                        x.MODI_AP = "";
                                        x.MODI_PRID = "";
                                        x.TC001 = "4101";
                                        x.TC011 = "****";
                                        x.TC021 = "";
                                        x.TC022 = "";
                                        x.TC023 = "";
                                        x.TC024 = "";
                                        x.TC025 = "";
                                        x.TC117 = "";
                                        x.TC121 = "";
                                        x.TC122 = "";
                                        x.TC123 = "";
                                        x.TC124 = "";
                                        x.TC125 = "";
                                        x.TC129 = "";
                                        x.TC017 = "";
                                        //x.UDF01 = "";
                                        //x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;

                                        x.TC005 = tc005;
                                        x.TC010 = tc010;//
                                                        //x.TC013 = tc013;
                                                        //x.TC014 = tc014;
                                        x.TC105 = tc105;
                                        x.TC111 = tc111;
                                        //x.TC113 = tc113;
                                        //x.TC114 = tc114;
                                    });

                            }
                        }


                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        var USR_GROUP = BaseHelper.CheckErpAuthority(userNo, sqlConnection, "MOCI02", "CREATE");
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @User";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("User", userNo);

                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("ERP使用者不存在!");

                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用)
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @User
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("User", userNo);
                        //    dynamicParameters.Add("Function", "BOMI04");
                        //    dynamicParameters.Add("Auth", "___Y________"); //確認

                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) throw new SystemException("ERP使用者無權限!");
                        //}
                        #endregion

                        #region //判斷ERP變更單單頭是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM BOMTA
                                WHERE TA002 = @BomChangeNo";
                        dynamicParameters.Add("BomChangeNo", bomChangeNo);

                        var resultERPChange = sqlConnection.Query(sql, dynamicParameters);
                        if (resultERPChange.Count() <= 0) throw new SystemException("ERP變更單單頭不存在，無法確認!");
                        #endregion

                        #region //判斷ERP變更單單身是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM BOMTB
                                WHERE TB002 = @BomChangeNo";
                        dynamicParameters.Add("BomChangeNo", bomChangeNo);

                        var resultChangeNoteExist = sqlConnection.Query(sql, dynamicParameters);

                        if (resultChangeNoteExist.Count() < 0) throw new SystemException("ERP變更單單身不存在，無法確認!");
                        newbomChangeNo = bomChangeNo;
                        #endregion

                        #region //取得ERP子單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM BOMTC
                                WHERE TC002 = @BomChangeNo";
                        dynamicParameters.Add("BomChangeNo", bomChangeNo);

                        var resultSubChangeNoteExist = sqlConnection.Query(sql, dynamicParameters);

                        #endregion

                        #region //檢查ERP是否有未確認單據
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB008, TB009, TB012, TB013
                                FROM BOMTB
                                WHERE TB012 = 'N' AND TB001 = @TB001 AND TB002 != @TB002 AND RTRIM(LTRIM(TB004)) IN @TB004
                                ORDER BY TB002 DESC,TB007 DESC";
                        dynamicParameters.Add("TB004", bomChageDetail.Select(x => x.TB004).ToArray());
                        dynamicParameters.Add("TB002", bomChangeNo);
                        dynamicParameters.Add("TB001", "4101");

                        var nocheckEditionErpResult = sqlConnection.Query(sql, dynamicParameters);
                        if (nocheckEditionErpResult.Count() > 0)
                        {
                            foreach (var item in nocheckEditionErpResult)
                            {
                                var tb012 = item.TB012;

                                if (tb012 == "N")
                                {

                                    using (SqlConnection sqlConnection2 = new SqlConnection(MainConnectionStrings))
                                    {
                                        #region //檢查未拋轉變更單是否存在MES
                                        dynamicParameters = new DynamicParameters();
                                        sql = @" SELECT * FROM PDM.BomChange
                                    WHERE BomChangePrefix = @TB001 AND BomChangeNo = @TB002";
                                        dynamicParameters.Add("TB001", item.TB001);
                                        dynamicParameters.Add("TB002", item.TB002);

                                        var MtlItemChangeResult2 = sqlConnection2.Query(sql, dynamicParameters);
                                        if (MtlItemChangeResult2.Count() > 0)
                                        {
                                            throw new SystemException("【BOM變更管理】－此品號有未處理 MES 變更單! : " + item.TB001 + "-" + item.TB002);

                                        }
                                        else
                                        {
                                            throw new SystemException("【BOM變更管理】－此品號有未處理 ERP 變更單! : " + item.TB001 + "-" + item.TB002);
                                        }
                                        #endregion

                                    }
                                }
                            }
                        }


                        #endregion

                        #region //取得單身ERP版本,原單號
                        foreach (var item in bomChageDetail) {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TB001, TB002, TB004, TB007, TB107, TB012, ISNULL(TB111,'')TB111, ISNULL(TB112,'')TB112 , ISNULL(TB113,'')TB113, TB110, TB003, TB013
                                    FROM BOMTB 
                                    WHERE TB012 != 'V' AND TB012 != 'N' AND RTRIM(LTRIM(TB004)) = @TB004
                                    ORDER BY TB007 DESC";
                            dynamicParameters.Add("TB004", item.TB004);
                            var erpEdition = sqlConnection.Query(sql, dynamicParameters);

                            if (erpEdition.Count() > 0)
                            {
                                foreach (var item2 in erpEdition)
                                {
                                    //修改原單號序號備註
                                    //if (item.TB012 == "N") throw new SystemException("此品號尚有其他版次未確認之ERP變更單! 品號: " + item.TB004);
                                    var firstItem = erpEdition.Where(w => w.TB004 == item.TB004).OrderByDescending(o => o.TB007).FirstOrDefault();
                                    int num = Convert.ToInt32(firstItem.TB007);
                                    string eee = "0000" + (num + 1);
                                    string newEdition = eee.Substring(eee.Length - 4);
                                    //oldEdition = firstItem.TB007;
                                    var oldBomChangeNo = firstItem.TB002;
                                    var oldBomChangeSort = firstItem.TB003;
                                    var oldRemark = firstItem.TB013;// x.TB110 = "4101";

                                    var tb110 = firstItem.TB110 != "" ? firstItem.TB110 : "";

                                    bomChageDetail
                                        .Where(w => w.TB004 == item.TB004)
                                        .ToList()
                                        .ForEach(x =>
                                        {

                                            //x.TB001 = "4101";
                                            //x.TB002 = bomChangeNo;
                                            x.TB007 = newEdition;
                                            x.TB016 = "";
                                            x.TB106 = "";
                                            x.TB110 = "4101";
                                            x.TB111 = oldBomChangeNo;
                                            x.TB112 = oldBomChangeSort;
                                            x.TB113 = oldRemark;

                                        });
                                }
                            }
                            else {
                                bomChageDetail
                                        .Where(w => w.TB004 == item.TB004)
                                        .ToList()
                                        .ForEach(x =>
                                        {

                                            //x.TB001 = "4101";
                                            //x.TB002 = bomChangeNo;
                                            x.TB007 = "0001";
                                            x.TB016 = "";
                                            x.TB106 = "";
                                            x.TB110 = "";
                                            x.TB111 = "";
                                            x.TB112 = "";
                                            x.TB113 = "";

                                        });
                            }
                        }

                        
                        #endregion

                        int tempRowsAffected = 0;
                        #region //ERP確認
                        #region //BOMTA
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE BOMTA SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TA007 = @ConfirmStatus,
                                TA010 = @UserNo
                                WHERE TA002 = @BomChangeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                ConfirmStatus = "Y",
                                UserNo = userNo,
                                BomChangeNo = bomChangeNo
                            });

                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("ERP單據 {0}-{1} 確認失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion


                        if (confirmstatus == "R")//重新確認
                        {
                            #region //BOMTB

                            #region //刪除單身BOMTB
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM BOMTB 
                                    WHERE TB002 = @BomChangeNo";
                            dynamicParameters.Add("BomChangeNo", bomChangeNo);

                            var BOMTBAff = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += BOMTBAff;
                            #endregion

                            #region //重新確認，BOMTB 單身新增


                            if (bomChageDetail.Count > 0)
                            {
                                bomChageDetail
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = userNo;
                                        x.CREATE_AP = userNo + "PC";
                                        x.COMPANY = companyNo;
                                        x.USR_GROUP = USR_GROUP;
                                        x.CREATE_DATE = dateNow;
                                        x.MODIFIER = "";
                                        x.MODI_DATE = "";
                                        x.FLAG = "1";
                                        x.CREATE_TIME = timeNow;
                                        x.CREATE_PRID = "BM";
                                        x.MODI_TIME = "";
                                        x.MODI_AP = "";
                                        x.MODI_PRID = "";
                                        x.TB001 = "4101";
                                        x.TB011 = "";
                                        x.TB012 = "Y";
                                        x.UDF01 = "";
                                        x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                    });

                                sql = @"INSERT INTO BOMTB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TB001, TB002, TB003, TB004, TB005, TB006, TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB016
                                            , TB104, TB105, TB106, TB107, TB108, TB109, TB110, TB111, TB112, TB113
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB016
                                            , @TB104, @TB105, @TB106, @TB107, @TB108, @TB109, @TB110, @TB111, @TB112, @TB113
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                rowsAffected += sqlConnection.Execute(sql, bomChageDetail);
                            }
                            #endregion

                            #endregion

                            #region //BOMTC

                            #region //刪除子單身BOMTC
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE FROM BOMTC 
                                    WHERE TC002 = @BomChangeNo";
                            dynamicParameters.Add("BomChangeNo", bomChangeNo);

                            var BOMTCAff = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += BOMTCAff;
                            #endregion

                            #region //重新確認，BOMTC 單身新增

                            if (bomChageSubDetail.Count > 0)
                            {
                                bomChageSubDetail
                                    .ToList()
                                    .ForEach(x =>
                                    {
                                        x.CREATOR = userNo;
                                        x.CREATE_AP = userNo + "PC";
                                        x.COMPANY = companyNo;
                                        x.USR_GROUP = USR_GROUP;
                                        x.CREATE_DATE = dateNow;
                                        x.MODIFIER = "";
                                        x.MODI_DATE = "";
                                        x.FLAG = "1";
                                        x.CREATE_TIME = timeNow;
                                        x.CREATE_PRID = "BM";
                                        x.MODI_TIME = "";
                                        x.MODI_AP = "";
                                        x.MODI_PRID = "";
                                        x.TC001 = "4101";
                                        x.TC011 = "****";
                                        x.TC021 = "";
                                        x.TC022 = "";
                                        x.TC023 = "";
                                        x.TC024 = "";
                                        x.TC025 = "";
                                        x.TC117 = "";
                                        x.TC121 = "";
                                        x.TC122 = "";
                                        x.TC123 = "";
                                        x.TC124 = "";
                                        x.TC125 = "";
                                        x.TC129 = "";
                                        x.TC017 = "";
                                        //x.UDF01 = "";
                                        //x.UDF02 = "";
                                        x.UDF03 = "";
                                        x.UDF04 = "";
                                        x.UDF05 = "";
                                        x.UDF06 = 0;
                                        x.UDF07 = 0;
                                        x.UDF08 = 0;
                                        x.UDF09 = 0;
                                        x.UDF10 = 0;
                                    });

                                sql = @"INSERT INTO BOMTC (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , TC001, TC002, TC003, TC004, TC005, TC006, TC007, TC008, TC009, TC010, TC011, TC012, TC013, TC014, TC015, TC016, TC017, TC018, TC019, TC020, TC021, TC022, TC023, TC024, TC025, TC029,  TC032
                                            , TC104, TC105, TC106, TC107, TC108, TC109, TC110, TC111, TC112, TC113, TC114, TC115, TC116, TC117, TC119, TC120, TC121, TC122, TC123, TC124, TC125, TC129, TC132 
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES ( @COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @TC001, @TC002, @TC003, @TC004, @TC005, @TC006, @TC007, @TC008, @TC009, @TC010, @TC011, @TC012, @TC013, @TC014, @TC015, @TC016, @TC017, @TC018, @TC019, @TC020, @TC021, @TC022, @TC023, @TC024, @TC025, @TC029,  @TC032
                                            , @TC104, @TC105, @TC106, @TC107, @TC108, @TC109, @TC110, @TC111, @TC112, @TC113, @TC114, @TC115, @TC116, @TC117, @TC119, @TC120, @TC121, @TC122, @TC123, @TC124, @TC125, @TC129, @TC132 
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                rowsAffected += sqlConnection.Execute(sql, bomChageSubDetail);
                            }
                            #endregion

                            #endregion

                        }
                        else //首次確認
                        {
                            #region //BOMTB
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE BOMTB SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TB012 = @ConfirmStatus
                                WHERE TB002 = @BomChangeNo";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    ConfirmStatus = "Y",
                                    BomChangeNo = bomChangeNo

                                });

                            tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("ERP單據 {0}-{1} 單身確認失敗!", bomChangeNo));
                            rowsAffected += tempRowsAffected;
                            #endregion
                        }

                        #region//BOM TABLE

                        #region //BOMMC
                        foreach (var item in bomChageDetail)
                        {
                            var mainMtlitem = item.TB004;
                            var mainMtlitemSort = item.TB003;

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE BOMMC SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                MC004 = @MC004,
                                MC005 = @MC005,
                                MC006 = @MC006,
                                MC007 = @MC007,
                                MC008 = @MC008,
                                MC009 = @MC009
                                WHERE MC001 = @Mtlitem";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    MC004 = item.TB008,
                                    MC005 = item.TB009,
                                    MC006 = item.TB001,
                                    MC007 = item.TB002,
                                    MC008 = item.TB003,
                                    MC009 = item.TB007,
                                    Mtlitem = mainMtlitem
                                });
                            var BOMMCAff = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += BOMMCAff;

                            #region //BOMMD 
                            if (bomChageSubDetail.Count > 0)
                            {
                                foreach (var subitem in bomChageSubDetail)
                                {

                                    var mtlitem = subitem.TC005;
                                    var tC104 = subitem.TC104;
                                    var tc003 = subitem.TC003;

                                    //刪除元件
                                    if (mtlitem.Length <= 0)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE FROM BOMMD 
                                        WHERE RTRIM(LTRIM (MD001)) = @MD001
                                        AND RTRIM(LTRIM (MD003)) = @MD003
                                        AND MD002 = @MD002";
                                        dynamicParameters.Add("MD001", mainMtlitem);
                                        dynamicParameters.Add("MD003", subitem.TC105);
                                        dynamicParameters.Add("MD002", subitem.TC004);


                                        var BOMMDAff = sqlConnection.Execute(sql, dynamicParameters);
                                        rowsAffected += BOMMDAff;
                                    }

                                    //新元件
                                    if (tC104.Length <= 0 && (mainMtlitemSort == subitem.TC003))
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO BOMMD(COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MD001, MD002, MD003, MD004, MD005, MD006, MD007, MD008, MD009, MD010, MD011, MD012, MD013, MD014
                                            , MD015, MD016, MD017, MD018, MD019, MD020, MD021, MD022, MD023, MD029, MD032
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES(@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MD001, @MD002, @MD003, @MD004, @MD005, @MD006, @MD007, @MD008, @MD009, @MD010, @MD011, @MD012, @MD013, @MD014
                                            , @MD015, @MD016, @MD017, @MD018, @MD019, @MD020, @MD021, @MD022, @MD023, @MD029, @MD032
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                subitem.COMPANY,
                                                subitem.CREATOR,
                                                USR_GROUP,
                                                subitem.CREATE_DATE,
                                                MODIFIER = subitem.MODIFIER.Length > 0 ? subitem.MODIFIER : "",
                                                MODI_DATE = subitem.MODI_DATE.Length > 0 ? subitem.MODI_DATE : "",
                                                subitem.FLAG,
                                                subitem.CREATE_TIME,
                                                subitem.CREATE_AP,
                                                subitem.CREATE_PRID,
                                                MODI_TIME = subitem.MODI_TIME.Length > 0 ? subitem.MODI_TIME : "",
                                                MODI_AP = subitem.MODI_AP.Length > 0 ? subitem.MODI_AP : "",
                                                MODI_PRID = subitem.MODI_PRID.Length > 0 ? subitem.MODI_PRID : "",

                                                MD001 = mainMtlitem,
                                                MD002 = subitem.TC004,
                                                MD003 = mtlitem,
                                                MD004 = subitem.TC006,
                                                MD005 = subitem.TC007,
                                                MD006 = subitem.TC008,
                                                MD007 = subitem.TC009,
                                                MD008 = subitem.TC010,
                                                MD009 = subitem.TC011,
                                                MD010 = subitem.TC012,
                                                MD011 = subitem.TC013.Length > 0 ? subitem.TC013 : "",
                                                MD012 = subitem.TC014.Length > 0 ? subitem.TC014 : "",
                                                MD013 = subitem.TC015,
                                                MD014 = subitem.TC016,
                                                MD015 = subitem.TC017,
                                                MD016 = subitem.TC029,
                                                MD017 = subitem.TC019,
                                                MD018 = subitem.TC020,
                                                MD019 = subitem.TC021,
                                                MD020 = subitem.TC022,
                                                MD021 = subitem.TC023,
                                                MD022 = subitem.TC024,
                                                MD023 = subitem.TC025,
                                                MD029 = subitem.TC032,
                                                MD032 = "Y",

                                                subitem.UDF01,
                                                UDF02 = "",
                                                subitem.UDF03,
                                                subitem.UDF04,
                                                subitem.UDF05,
                                                subitem.UDF06,
                                                subitem.UDF07,
                                                subitem.UDF08,
                                                subitem.UDF09,
                                                subitem.UDF10
                                            });
                                        var BOMMDAff = sqlConnection.Execute(sql, dynamicParameters);
                                        rowsAffected += BOMMDAff;

                                    }
                                    //舊元件
                                    else if (subitem.TC005.Length > 0 && tC104.Length > 0)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE BOMMD SET
                                            MODI_PRID = @MODI_PRID,
                                            MODI_DATE = @MODI_DATE,
                                            MODI_TIME = @MODI_TIME,
                                            MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                            MD003 = @MD003,
                                            MD004 = @MD004,
                                            MD005 = @MD005,
                                            MD006 = @MD006,
                                            MD007 = @MD007,
                                            MD008 = @MD008,
                                            MD009 = @MD009,
                                            MD010 = @MD010,
                                            MD011 = @MD011,
                                            MD012 = @MD012,
                                            MD013 = @MD013,
                                            MD014 = @MD014,
                                            MD015 = @MD015,
                                            MD016 = @MD016,
                                            MD017 = @MD017,
                                            MD018 = @MD018,
                                            MD019 = @MD019,
                                            MD020 = @MD020,
                                            MD021 = @MD021,
                                            MD022 = @MD022,
                                            MD023 = @MD023,
                                            MD029 = @MD029,
                                            MD032 = @MD032,
                                            UDF01 = @UDF01


                                            WHERE MD001 = @Mtlitem AND MD003 = @MD003No AND MD002 = @MD002";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MODIFIER = userNo,
                                                MODI_DATE = dateNow,
                                                MODI_TIME = timeNow,
                                                MODI_AP = userNo + "PC",
                                                MODI_PRID = "BM",
                                                MD003 = subitem.TC005,
                                                MD004 = subitem.TC006,
                                                MD005 = subitem.TC017,
                                                MD006 = subitem.TC008,
                                                MD007 = subitem.TC009,
                                                MD008 = subitem.TC010,
                                                MD009 = subitem.TC011,
                                                MD010 = subitem.TC012,
                                                MD011 = subitem.TC013,
                                                MD012 = subitem.TC014,
                                                MD013 = subitem.TC015,
                                                MD014 = subitem.TC016,
                                                MD015 = subitem.TC017,
                                                MD016 = subitem.TC029,
                                                MD017 = subitem.TC019,
                                                MD018 = subitem.TC020,
                                                MD019 = subitem.TC021,
                                                MD020 = subitem.TC022,
                                                MD021 = subitem.TC023,
                                                MD022 = subitem.TC024,
                                                MD023 = subitem.TC025,
                                                MD029 = subitem.TC032,
                                                MD032 = "Y",
                                                UDF01 = subitem.UDF01,
                                                Mtlitem = mainMtlitem,
                                                MD003No = subitem.TC105,
                                                MD002 = subitem.TC104
                                            });
                                        var BOMMDAff = sqlConnection.Execute(sql, dynamicParameters);
                                        rowsAffected += BOMMDAff;

                                    }

                                }
                            }

                            #endregion

                        }
                        #endregion
                        #endregion


                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int tempRowsAffected = 0;
                        #region //BM確認
                        #region //PDM.BomChange
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomChange SET
                                ConfirmBy = @ConfirmBy,
                                ConfirmDate = @ConfirmDate,
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmBy = LastModifiedBy,//
                                ConfirmDate = LastModifiedDate,
                                ConfirmStatus = "Y",
                                LastModifiedDate,
                                LastModifiedBy,
                                BomChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("BM單據 {0}-{1} 確認失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.BomChangeDetail
                        foreach (var item in bomChageDetail) {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.BomChangeDetail SET
                                    ChangeEdition = @ChangeEdition,
                                    ConfirmStatus = @ConfirmStatus,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BomChangeId = @BomChangeId AND BomChangeDetailId = @BomChangeDetailId";
                            dynamicParameters.Add("BomChangeId", BomChangeId);
                            dynamicParameters.Add("BomChangeDetailId", item.BomChangeDetailId);

                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    ChangeEdition = item.TB007,
                                    ConfirmStatus = "Y",
                                    LastModifiedDate,
                                    LastModifiedBy
                                });
                            tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            if (tempRowsAffected <= 0) throw new SystemException(string.Format("BM單據 {0}-{1} 單身確認失敗!", bomChangeNo));
                            rowsAffected += tempRowsAffected;
                        }

                        
                        #endregion

                        #region //PDM.BillOfMaterials 
                        foreach (var item in bomChageDetail)
                        {
                            var bomId = item.BomId;
                            var mainbomChangeDetailId = item.BomChangeDetailId;
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.BillOfMaterials SET
                                    StandardLot = @StandardLot,
                                    WipPrefix = @WipPrefix,
                                    ModiPrefix = @ModiPrefix,
                                    ModiNo = @ModiNo,
                                    ModiSequence = @ModiSequence,
                                    [Version] = @Version,
                                    Remark = @Remark,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BomId = @BomId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    StandardLot = item.TB008,
                                    WipPrefix = item.TB009,
                                    ModiPrefix = "4101",
                                    ModiNo = newbomChangeNo,
                                    ModiSequence = item.TB003,
                                    Version = item.TB007,
                                    Remark = item.TB013,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    bomId
                                });
                            var billOfMaterials = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += billOfMaterials;

                            #region //PDM.BomDetail
                            if (bomChageSubDetail.Count() > 0)
                            {
                                foreach (var subitem in bomChageSubDetail)
                                {
                                    var mtlItemId = subitem.MtlItemId;
                                    var effectiveDate = subitem.TC013 != "" ? subitem.TC013 : null;
                                    var expirationDate = subitem.TC014 != "" ? subitem.TC014 : null;
                                    var subbomChangeDetailId = subitem.BomChangeDetailId;


                                    //刪除舊元件
                                    if (subitem.DeleteStatus == "Y")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE FROM PDM.BomDetail 
                                        WHERE BomId = @BomId
                                        AND MtlItemId = @MtlItemId";
                                        dynamicParameters.Add("BomId", bomId);
                                        dynamicParameters.Add("MtlItemId", subitem.MtlItemId);

                                        var deletResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected = deletResult.Count();
                                    }

                                    if (subitem.BomDetailId == -1 && (subbomChangeDetailId == mainbomChangeDetailId))
                                    {
                                        //新元件
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO PDM.BomDetail (BomId, BomSequence, MtlItemId, UomId, CompositionQuantity, Base, LossRate
                                                , StandardCostingType, MaterialProperties
                                                , ReleaseItem, EffectiveDate, ExpirationDate, Remark, SubstitutionRemark, ConfirmStatus, ComponentType
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.BomDetailId
                                                VALUES (@BomId, @BomSequence, @MtlItemId, @UomId, @CompositionQuantity, @Base, @LossRate
                                                , @StandardCostingType, @MaterialProperties
                                                , @ReleaseItem, @EffectiveDate, @ExpirationDate, @Remark, @SubstitutionRemark, @ConfirmStatus, @ComponentType
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BomId = bomId,
                                                BomSequence = subitem.TC004,
                                                subitem.MtlItemId,
                                                UomId = subitem.Unit,
                                                CompositionQuantity = subitem.TC008,
                                                Base = subitem.TC009,
                                                LossRate = subitem.TC010,
                                                StandardCostingType = subitem.TC016,
                                                MaterialProperties = subitem.TC019,
                                                ReleaseItem = "",
                                                EffectiveDate = effectiveDate,
                                                ExpirationDate = expirationDate,
                                                Remark = subitem.TC029,
                                                SubstitutionRemark = "",
                                                ConfirmStatus = "N",
                                                ComponentType = subitem.UDF01,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });
                                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected = insertResult.Count();
                                    }
                                    else if (subitem.BomDetailId > 0 && subitem.DeleteStatus == "N")
                                    {
                                        //舊元件
                                        dynamicParameters = new DynamicParameters();//StandardCostingType 標準成本計算 -StandardCosting ,MaterialProperties 材料型態 -BomType
                                        sql = @"UPDATE PDM.BomDetail SET
                                                MtlItemId = @MtlItemId,
                                                UomId = @UomId,
                                                CompositionQuantity = @CompositionQuantity,
                                                Base = @Base,
                                                LossRate = @LossRate,
                                                EffectiveDate = @EffectiveDate,
                                                ExpirationDate = @ExpirationDate,
                                                --Remark = @Remark,
                                                StandardCostingType = @StandardCostingType,
                                                MaterialProperties = @MaterialProperties,
ComponentType = @ComponentType,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BomId = @BomId AND BomDetailId  = @BomDetailId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                subitem.MtlItemId,
                                                UomId = subitem.Unit,
                                                CompositionQuantity = subitem.TC008,
                                                Base = subitem.TC009,
                                                LossRate = subitem.TC010,
                                                EffectiveDate = effectiveDate,
                                                ExpirationDate = expirationDate,
                                                //Remark = subitem.NewRemark,
                                                StandardCostingType = subitem.TC016,
                                                MaterialProperties = subitem.TC019,
                                                ComponentType = subitem.UDF01,
                                                LastModifiedDate,
                                                LastModifiedBy,
                                                BomId = bomId,
                                                subitem.BomDetailId

                                            });
                                        var bomDetails = sqlConnection.Execute(sql, dynamicParameters);
                                        rowsAffected += bomDetails;
                                    }
                                }
                            }
                            #endregion
                        }
                        #endregion

                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomChangeReConfirm //BOM變更單反確認  
        public string UpdateBomChangeReConfirm(int BomChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0, totalDetail = 0;
                    string companyNo = "", bomChangeNo = "", departmentNo = "", userNo = "", userName = "", originbomChangeNo = "";
                    List<BomChangeDetail2> bomChangeDetail = new List<BomChangeDetail2>();
                    List<BomChangeSubDetail2> bomChangeSubDetail = new List<BomChangeSubDetail2>();

                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "BomChange");
                        dynamicParameters.Add("DetailCode", "reconfirm");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region//BM變更單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.BomChange
                                WHERE BomChangeId = @BomChangeId AND CompanyId = @CompanyId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultBomChange = sqlConnection.Query(sql, dynamicParameters);

                        if (resultBomChange.Count() <= 0) throw new SystemException("資料錯誤!");

                        foreach (var item in resultBomChange)
                        {
                            if (item.TransferStatus == "N") throw new SystemException("變更單尚未拋轉!");
                            if (item.ConfirmStatus == "N") throw new SystemException("變更單頭已反確認!");
                            bomChangeNo = item.BomChangeNo;
                        }

                        #endregion

                        #region//BM變更單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.BomChangeDetail
                                WHERE BomChangeId = @BomChangeId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);

                        var resultBomChangeDetail = sqlConnection.Query(sql, dynamicParameters);
                        bomChangeDetail = sqlConnection.Query<BomChangeDetail2>(sql, dynamicParameters).ToList();


                        if (resultBomChangeDetail.Count() <= 0) throw new SystemException("資料錯誤!");
                        totalDetail = resultBomChangeDetail.Count();
                        foreach (var item in resultBomChangeDetail)
                        {
                            if (item.ConfirmStatus == "R") throw new SystemException("變更單身已反確認!");
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlItemId, b.MtlItemNo, a.BomVersion
                                    FROM MES.WipOrder a
                                    INNER JOIN PDM.MtlItem b ON a.MtlItemId = b.MtlItemId
                                    WHERE a.TransferStatus = 'Y' AND a.MtlItemId = @MtlItemId AND a.BomVersion = @BomVersion
                                    ORDER BY a.MtlItemId ";

                            dynamicParameters.Add("MtlItemId", item.MtlItemId);
                            dynamicParameters.Add("BomVersion", item.ChangeEdition);

                            var resultWipOrder = sqlConnection.Query(sql, dynamicParameters);
                            if (resultWipOrder.Count() > 0) throw new SystemException("該BOM品號版本已開立製令無法反確認!");

                        }
                        #endregion

                        #region//BM變更單子單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.BomChangeSubDetail
                                WHERE BomChangeId = @BomChangeId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);

                        var resultBomChangeSubDetail = sqlConnection.Query(sql, dynamicParameters);
                        bomChangeSubDetail = sqlConnection.Query<BomChangeSubDetail2>(sql, dynamicParameters).ToList();

                        #endregion


                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @User";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("User", userNo);

                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("ERP使用者不存在!");

                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用)
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @User
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("User", userNo);
                        //    dynamicParameters.Add("Function", "BOMI04");
                        //    dynamicParameters.Add("Auth", "____Y_______"); //反確認

                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) throw new SystemException("ERP使用者無權限!");
                        //}
                        #endregion

                        #region //判斷ERP變更單單頭是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM BOMTA
                                WHERE TA002 = @BomChangeNo";
                        dynamicParameters.Add("BomChangeNo", bomChangeNo);

                        var resultERPChange = sqlConnection.Query(sql, dynamicParameters);
                        if (resultERPChange.Count() <= 0) throw new SystemException("ERP變更單單頭不存在，無法反確認!");
                        #endregion

                        #region //判斷ERP變更單單身是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM BOMTB
                                WHERE TB002 = @BomChangeNo";
                        dynamicParameters.Add("BomChangeNo", bomChangeNo);

                        var resultChangeNoteExist = sqlConnection.Query(sql, dynamicParameters);

                        if (resultChangeNoteExist.Count() < 0) throw new SystemException("ERP變更單單身不存在，無法反確認!");

                        originbomChangeNo = resultChangeNoteExist.FirstOrDefault().TB111;

                        #endregion

                        #region //取得ERP子單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM BOMTC
                                WHERE TC002 = @BomChangeNo";
                        dynamicParameters.Add("BomChangeNo", bomChangeNo);

                        var resultSubChangeNoteExist = sqlConnection.Query(sql, dynamicParameters);

                        #endregion

                        int tempRowsAffected = 0;
                        #region //ERP反確認
                        #region //BOMTA
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE BOMTA SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TA007 = @ConfirmStatus
                                WHERE TA002 = @BomChangeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                ConfirmStatus = "N",
                                BomChangeNo = bomChangeNo
                            });

                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("ERP單據 {0}-{1} 反確認失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //BOMTB
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE BOMTB SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TB012 = @ConfirmStatus
                                WHERE TB002 = @BomChangeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                ConfirmStatus = "N",
                                BomChangeNo = bomChangeNo

                            });

                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("ERP單據 {0}-{1} 單身反確認失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //BOMMC --mc004 mc005 mc006 mc007 mc008 mc009
                        foreach (var item in resultChangeNoteExist)
                        {
                            var mainMtlitem = item.TB004;

                            #region //取得BOMMC版本
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT *
                                FROM BOMMC
                                WHERE MC001 = @MC001";
                            dynamicParameters.Add("MC001", mainMtlitem);

                            var resultBOMMCVer = sqlConnection.Query(sql, dynamicParameters);

                            if (resultBOMMCVer .Count() < 0) throw new SystemException("ERP BOM主件不存在，無法反確認!");
                            foreach (var bommcItem in resultBOMMCVer) {
                                if (item.TB007 != bommcItem.MC009) throw new SystemException("該變更單版本與ERP BOM主件版本不同，無法反確認!");
                            }
                            #endregion

                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE BOMMC SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                MC004 = @MC004,
                                MC005 = @MC005,
                                MC006 = @MC006,
                                MC007 = @MC007,
                                MC008 = @MC008,
                                MC009 = @MC009
                                WHERE MC001 = @Mtlitem";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    MODIFIER = userNo,
                                    MODI_DATE = dateNow,
                                    MODI_TIME = timeNow,
                                    MODI_AP = userNo + "PC",
                                    MODI_PRID = "BM",
                                    MC004 = item.TB108,
                                    MC005 = item.TB109,
                                    MC006 = item.TB110,
                                    MC007 = item.TB111,
                                    MC008 = item.TB112,
                                    MC009 = item.TB107,
                                    Mtlitem = mainMtlitem
                                });
                            var BOMMCAff = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += BOMMCAff;

                            #region //BOMMD 
                            if (resultSubChangeNoteExist.Count() > 0)
                            {
                                foreach (var subitem in resultSubChangeNoteExist)
                                {

                                    var mtlitem = subitem.TC005;
                                    var tC104 = subitem.TC104;

                                    //已刪除品號復原
                                    if (subitem.TC005.Length <= 0)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO BOMMD(COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE
                                            , FLAG, CREATE_TIME, CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID
                                            , MD001, MD002, MD003, MD004, MD005, MD006, MD007, MD008, MD009, MD010, MD011, MD012, MD013, MD014
                                            , MD015, MD016, MD017, MD018, MD019, MD020, MD021, MD022, MD023, MD029, MD032
                                            , UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10)
                                            VALUES(@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE
                                            , @FLAG, @CREATE_TIME, @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID
                                            , @MD001, @MD002, @MD003, @MD004, @MD005, @MD006, @MD007, @MD008, @MD009, @MD010, @MD011, @MD012, @MD013, @MD014
                                            , @MD015, @MD016, @MD017, @MD018, @MD019, @MD020, @MD021, @MD022, @MD023, @MD029, @MD032
                                            , @UDF01, @UDF02, @UDF03, @UDF04, @UDF05, @UDF06, @UDF07, @UDF08, @UDF09, @UDF10)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                subitem.COMPANY,
                                                subitem.CREATOR,
                                                subitem.USR_GROUP,
                                                subitem.CREATE_DATE,
                                                subitem.MODIFIER,
                                                subitem.MODI_DATE,
                                                subitem.FLAG,
                                                subitem.CREATE_TIME,
                                                subitem.CREATE_AP,
                                                subitem.CREATE_PRID,
                                                subitem.MODI_TIME,
                                                subitem.MODI_AP,
                                                subitem.MODI_PRID,

                                                MD001 = mainMtlitem,
                                                MD002 = subitem.TC104,
                                                MD003 = subitem.TC105,
                                                MD004 = subitem.TC106,
                                                MD005 = subitem.TC107,
                                                MD006 = subitem.TC108,
                                                MD007 = subitem.TC109,
                                                MD008 = subitem.TC110,
                                                MD009 = subitem.TC111,
                                                MD010 = subitem.TC112,
                                                MD011 = subitem.TC113,
                                                MD012 = subitem.TC114,
                                                MD013 = subitem.TC115,
                                                MD014 = subitem.TC116,
                                                MD015 = subitem.TC117,
                                                MD016 = subitem.TC129,
                                                MD017 = subitem.TC119,
                                                MD018 = subitem.TC120,
                                                MD019 = subitem.TC121,
                                                MD020 = subitem.TC122,
                                                MD021 = subitem.TC123,
                                                MD022 = subitem.TC124,
                                                MD023 = subitem.TC125,
                                                MD029 = subitem.TC132,
                                                MD032 = "Y",

                                                UDF01 = subitem.UDF02,
                                                UDF02 = "",
                                                subitem.UDF03,
                                                subitem.UDF04,
                                                subitem.UDF05,
                                                subitem.UDF06,
                                                subitem.UDF07,
                                                subitem.UDF08,
                                                subitem.UDF09,
                                                subitem.UDF10
                                            });
                                        var BOMMDAff = sqlConnection.Execute(sql, dynamicParameters);
                                        rowsAffected += BOMMDAff;

                                    }

                                    //新元件刪除
                                    if (tC104.Length <= 0)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE FROM BOMMD 
                                        WHERE MD001 = @MD001
                                        AND MD003 = @MD003
                                        AND MD002 = @MD002";
                                        dynamicParameters.Add("MD001", mainMtlitem);
                                        dynamicParameters.Add("MD003", subitem.TC005);
                                        dynamicParameters.Add("MD002", subitem.TC004);

                                        var BOMMDAff = sqlConnection.Execute(sql, dynamicParameters);
                                        rowsAffected += BOMMDAff;

                                    }
                                    //舊元件
                                    else if (subitem.TC005.Length > 0 && tC104.Length > 0)
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"UPDATE BOMMD SET
                                        MODI_PRID = @MODI_PRID,
                                        MODI_DATE = @MODI_DATE,
                                        MODI_TIME = @MODI_TIME,
                                        MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                        MD003 = @MD003,
                                            MD004 = @MD004,
                                            MD005 = @MD005,
                                            MD006 = @MD006,
                                            MD007 = @MD007,
                                            MD008 = @MD008,
                                            MD009 = @MD009,
                                            MD010 = @MD010,
                                            MD011 = @MD011,
                                            MD012 = @MD012,
                                            MD013 = @MD013,
                                            MD014 = @MD014,
                                            MD015 = @MD015,
                                            MD016 = @MD016,
                                            MD017 = @MD017,
                                            MD018 = @MD018,
                                            MD019 = @MD019,
                                            MD020 = @MD020,
                                            MD021 = @MD021,
                                            MD022 = @MD022,
                                            MD023 = @MD023,
                                            MD029 = @MD029,
                                            MD032 = @MD032,
UDF01 = @UDF01
                                        WHERE MD001 = @Mtlitem AND MD002 = @MD002 AND MD003 = @MD003No";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MODIFIER = userNo,
                                                MODI_DATE = dateNow,
                                                MODI_TIME = timeNow,
                                                MODI_AP = userNo + "PC",
                                                MODI_PRID = "BM",
                                                MD003 = subitem.TC105,
                                                MD004 = subitem.TC106,
                                                MD005 = subitem.TC107,
                                                MD006 = subitem.TC108,
                                                MD007 = subitem.TC109,
                                                MD008 = subitem.TC110,
                                                MD011 = subitem.TC113,
                                                MD012 = subitem.TC114,
                                                MD009 = subitem.TC111,
                                                MD010 = subitem.TC112,
                                                MD013 = subitem.TC115,
                                                MD014 = subitem.TC116,
                                                MD015 = subitem.TC117,
                                                MD016 = subitem.TC129,
                                                MD017 = subitem.TC119,
                                                MD018 = subitem.TC120,
                                                MD019 = subitem.TC121,
                                                MD020 = subitem.TC122,
                                                MD021 = subitem.TC123,
                                                MD022 = subitem.TC124,
                                                MD023 = subitem.TC125,
                                                MD029 = subitem.TC132,
                                                MD032 = "Y",
                                                UDF01 = subitem.UDF02,
                                                Mtlitem = mainMtlitem,
                                                MD002 = subitem.TC004,
                                                MD003No = subitem.TC005

                                            });
                                        var BOMMDAff = sqlConnection.Execute(sql, dynamicParameters);
                                        rowsAffected += BOMMDAff;

                                    }

                                }
                            }

                            #endregion

                        }
                        #endregion



                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int tempRowsAffected = 0;
                        #region //BM確認
                        #region //PDM.BomChange
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomChange SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "R",
                                LastModifiedDate,
                                LastModifiedBy,
                                BomChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("BM單據 {0}-{1} 反確認失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.BomChangeDetail
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomChangeDetail SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "R",
                                LastModifiedDate,
                                LastModifiedBy,
                                BomChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("BM單據 {0}-{1} 單身反確認失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.BillOfMaterials 
                        foreach (var item in bomChangeDetail)
                        {
                            var bomId = item.BomId;
                            var oldmodiPrefix = "";
                            var oldModiSequence = "";
                            var oldVersion = "";



                            if (item.OriginalChangeEdition == "0000")
                            {
                                oldmodiPrefix = "";
                                oldModiSequence = "";
                                oldVersion = "";
                            }
                            else
                            {
                                oldmodiPrefix = "4101";
                                oldModiSequence = item.OriginalSortNum;
                                oldVersion = item.OriginalChangeEdition;
                            }


                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.BillOfMaterials SET
                                    StandardLot = @StandardLot,
                                    WipPrefix = @WipPrefix,
                                    ModiPrefix = @ModiPrefix,
                                    ModiNo = @ModiNo,
                                    ModiSequence = @ModiSequence,
                                    [Version] = @Version,
                                    Remark = @Remark,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE BomId = @BomId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    StandardLot = item.OriginalStandardLot,
                                    WipPrefix = item.OriginalMoPrefix,
                                    ModiPrefix = oldmodiPrefix,
                                    ModiNo = originbomChangeNo,
                                    ModiSequence = oldModiSequence,
                                    Version = oldVersion,
                                    Remark = item.OriginalRemark,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    BomId = bomId
                                });
                            var billOfMaterials = sqlConnection.Execute(sql, dynamicParameters);
                            rowsAffected += billOfMaterials;

                            #region //PDM.BomDetail
                            if (bomChangeSubDetail.Count() > 0)
                            {
                                foreach (var subitem in bomChangeSubDetail)
                                {
                                    var mtlItemId = subitem.MtlItemId;
                                    var effectiveDate = subitem.OriginalEffectiveDate != null ? subitem.OriginalEffectiveDate : null;
                                    var expirationDate = subitem.OriginalExpirationDate != null ? subitem.OriginalExpirationDate : null;

                                    //已刪舊元件復原
                                    if (subitem.DeleteStatus == "Y")
                                    {
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"INSERT INTO PDM.BomDetail (BomId, BomSequence, MtlItemId, UomId, CompositionQuantity, Base, LossRate
                                                , StandardCostingType, MaterialProperties
                                                , ReleaseItem, EffectiveDate, ExpirationDate, Remark, SubstitutionRemark, ConfirmStatus, ComponentType
                                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                                OUTPUT INSERTED.BomDetailId
                                                VALUES (@BomId, @BomSequence, @MtlItemId, @UomId, @CompositionQuantity, @Base, @LossRate
                                                , @StandardCostingType, @MaterialProperties
                                                , @ReleaseItem, @EffectiveDate, @ExpirationDate, @Remark, @SubstitutionRemark, @ConfirmStatus, @ComponentType
                                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                BomId = bomId,
                                                BomSequence = subitem.OriginalBomSortNum,
                                                subitem.MtlItemId,
                                                UomId = subitem.OriginalUnit,
                                                CompositionQuantity = subitem.OriginalCompositionQuantity,
                                                Base = subitem.OriginalBase,
                                                LossRate = subitem.OriginalLossRate,
                                                StandardCostingType = subitem.OriginalStandardCosting,
                                                MaterialProperties = subitem.OriginalBomType,
                                                ReleaseItem = "",
                                                EffectiveDate = expirationDate,
                                                ExpirationDate = expirationDate,
                                                Remark = subitem.Originalemark,
                                                SubstitutionRemark = "",
                                                ConfirmStatus = "N",
                                                ComponentType = subitem.OriginalComponentType,
                                                CreateDate,
                                                LastModifiedDate,
                                                CreateBy,
                                                LastModifiedBy
                                            });
                                        var insertResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected = insertResult.Count();
                                    }


                                    //新元件刪除
                                    if (subitem.BomDetailId == -1)
                                    {
                                        dynamicParameters = new DynamicParameters();//StandardCostingType 標準成本計算 -StandardCosting ,MaterialProperties 材料型態 -BomType
                                        sql = @"DELETE FROM PDM.BomDetail 
                                        WHERE BomId = @BomId
                                        AND MtlItemId = @MtlItemId";
                                        dynamicParameters.Add("BomId", bomId);
                                        dynamicParameters.Add("MtlItemId", subitem.MtlItemId);

                                        var deletResult = sqlConnection.Query(sql, dynamicParameters);

                                        rowsAffected = deletResult.Count();
                                    }
                                    //舊元件復原
                                    else if (subitem.BomDetailId > 0 && subitem.DeleteStatus == "N")
                                    {
                                        dynamicParameters = new DynamicParameters();//StandardCostingType 標準成本計算 -StandardCosting ,MaterialProperties 材料型態 -BomType
                                        sql = @"UPDATE PDM.BomDetail SET
                                                MtlItemId = @MtlItemId,
                                                UomId = @UomId,
                                                CompositionQuantity = @CompositionQuantity,
                                                Base = @Base,
                                                LossRate = @LossRate,
                                                EffectiveDate = @EffectiveDate,
                                                ExpirationDate = @ExpirationDate,
                                                --Remark = @Remark,
                                                StandardCostingType = @StandardCostingType,
                                                MaterialProperties = @MaterialProperties,
                                                ComponentType = @ComponentType,
                                                LastModifiedDate = @LastModifiedDate,
                                                LastModifiedBy = @LastModifiedBy
                                                WHERE BomDetailId  = @BomDetailId";
                                        dynamicParameters.AddDynamicParams(
                                            new
                                            {
                                                MtlItemId = subitem.OriginalMtlItemId,
                                                UomId = subitem.OriginalUnit,
                                                CompositionQuantity = subitem.OriginalCompositionQuantity,
                                                Base = subitem.OriginalBase,
                                                LossRate = subitem.OriginalLossRate,
                                                EffectiveDate = expirationDate,
                                                ExpirationDate = expirationDate,
                                                // Remark = subitem.NewRemark,
                                                StandardCostingType = subitem.OriginalStandardCosting,
                                                MaterialProperties = subitem.OriginalBomType,
                                                ComponentType = subitem.OriginalComponentType,

                                                LastModifiedDate,
                                                LastModifiedBy,
                                                subitem.BomDetailId

                                            });
                                        var bomDetails = sqlConnection.Execute(sql, dynamicParameters);
                                        rowsAffected += bomDetails;
                                    }
                                }
                            }
                            #endregion
                        }
                        #endregion

                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateBomChangeVoid //BOM變更單作廢
        public string UpdateBomChangeVoid(int BomChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0, totalDetail = 0;
                    string companyNo = "", bomChangeNo = "", departmentNo = "", userNo = "", userName = "";


                    string dateNow = DateTime.Now.ToString("yyyyMMdd");
                    string timeNow = DateTime.Now.ToString("HH:mm:ss");

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //公司別資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.ErpNo, a.ErpDb
                                FROM BAS.Company a
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultCompany = sqlConnection.Query(sql, dynamicParameters);
                        if (resultCompany.Count() <= 0) throw new SystemException("【公司別】資料錯誤!");

                        foreach (var item in resultCompany)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            companyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "BomChange");
                        dynamicParameters.Add("DetailCode", "void");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region//BM變更單單頭
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.BomChange
                                WHERE BomChangeId = @BomChangeId AND CompanyId = @CompanyId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var resultBomChange = sqlConnection.Query(sql, dynamicParameters);
                        if (resultBomChange.Count() <= 0) throw new SystemException("資料錯誤!");

                        foreach (var item in resultBomChange)
                        {
                            if (item.TransferStatus == "N") throw new SystemException("變更單尚未拋轉!");
                            if (item.ConfirmStatus == "V") throw new SystemException("變更單頭已作廢!");
                            bomChangeNo = item.BomChangeNo;
                        }

                        #endregion

                        #region//BM變更單單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.BomChangeDetail
                                WHERE BomChangeId = @BomChangeId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);

                        var resultBomChangeDetail = sqlConnection.Query(sql, dynamicParameters);
                        if (resultBomChangeDetail.Count() <= 0) throw new SystemException("資料錯誤!");
                        totalDetail = resultBomChangeDetail.Count();
                        foreach (var item in resultBomChangeDetail)
                        {
                            if (item.ConfirmStatus == "V") throw new SystemException("變更單身已作廢!");
                        }
                        #endregion

                        #region//BM變更單子單身
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT * 
                                FROM PDM.BomChangeSubDetail
                                WHERE BomChangeId = @BomChangeId";

                        dynamicParameters.Add("BomChangeId", BomChangeId);

                        var resultBomChangeSubDetail = sqlConnection.Query(sql, dynamicParameters);

                        #endregion

                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                FROM ADMMF
                                WHERE COMPANY = @CompanyNo
                                AND MF001 = @User";
                        dynamicParameters.Add("CompanyNo", companyNo);
                        dynamicParameters.Add("User", userNo);

                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("ERP使用者不存在!");

                        string adminUser = "N";
                        foreach (var item in resultUserExist)
                        {
                            adminUser = item.MF005; //超級使用者
                        }
                        #endregion

                        #region //判斷ERP使用者是否有權限 (停用)
                        //if (adminUser != "Y")
                        //{
                        //    dynamicParameters = new DynamicParameters();
                        //    sql = @"SELECT TOP 1 MG006
                        //            FROM ADMMG
                        //            WHERE COMPANY = @CompanyNo
                        //            AND MG001 = @User
                        //            AND MG002 = @Function
                        //            AND MG004 = 'Y'
                        //            AND MG006 LIKE @Auth";
                        //    dynamicParameters.Add("CompanyNo", companyNo);
                        //    dynamicParameters.Add("User", userNo);
                        //    dynamicParameters.Add("Function", "BOMI04");
                        //    dynamicParameters.Add("Auth", "_________Y__"); //作廢

                        //    var resultUserAuthExist = sqlConnection.Query(sql, dynamicParameters);
                        //    if (resultUserAuthExist.Count() <= 0) throw new SystemException("ERP使用者無權限!");
                        //}
                        #endregion

                        #region //判斷ERP變更單單頭是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 TA002
                                FROM BOMTA
                                WHERE TA002 = @BomChangeNo";
                        dynamicParameters.Add("BomChangeNo", bomChangeNo);

                        var resultERPChange = sqlConnection.Query(sql, dynamicParameters);
                        if (resultERPChange.Count() <= 0) throw new SystemException("ERP變更單單據不存在，無法作廢!");
                        #endregion

                        #region //判斷ERP變更單單身是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 TB002
                                FROM BOMTB
                                WHERE TB002 = @BomChangeNo";
                        dynamicParameters.Add("BomChangeNo", bomChangeNo);

                        var resultChangeNoteExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultChangeNoteExist.Count() < 0) throw new SystemException("ERP變更單單據不存在，無法作廢!");
                        #endregion

                        int tempRowsAffected = 0;
                        #region //ERP確認
                        #region //BOMTA
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE BOMTA SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TA007 = @ConfirmStatus
                                WHERE TA002 = @BomChangeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                ConfirmStatus = "V",
                                BomChangeNo = bomChangeNo
                            });

                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("ERP單據 {0}-{1} 作廢失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //BOMTB
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE BOMTB SET
                                MODI_PRID = @MODI_PRID,
                                MODI_DATE = @MODI_DATE,
                                MODI_TIME = @MODI_TIME,
                                MODI_AP = @MODI_AP,
                                MODIFIER = @MODIFIER,
                                FLAG = FLAG + 1,
                                TB012 = @ConfirmStatus
                                WHERE TB002 = @BomChangeNo";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                MODIFIER = userNo,
                                MODI_DATE = dateNow,
                                MODI_TIME = timeNow,
                                MODI_AP = userNo + "PC",
                                MODI_PRID = "BM",
                                ConfirmStatus = "V",
                                BomChangeNo = bomChangeNo

                            });

                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("ERP單據 {0}-{1} 單身作廢失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int tempRowsAffected = 0;
                        #region //BM確認
                        #region //PDM.BomChange
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomChange SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "V",
                                LastModifiedDate,
                                LastModifiedBy,
                                BomChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != 1) throw new SystemException(string.Format("BM單據 {0}-{1} 作廢失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion

                        #region //PDM.BomChangeDetail
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.BomChangeDetail SET
                                ConfirmStatus = @ConfirmStatus,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.AddDynamicParams(
                            new
                            {
                                ConfirmStatus = "V",
                                LastModifiedDate,
                                LastModifiedBy,
                                BomChangeId
                            });
                        tempRowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        if (tempRowsAffected != totalDetail) throw new SystemException(string.Format("BM單據 {0}-{1} 單身作廢失敗!", bomChangeNo));
                        rowsAffected += tempRowsAffected;
                        #endregion
                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMtlQcItemBatch --品號進出貨檢資料更新 -- Chia Yuan 2024.03.27
        public string UpdateMtlQcItemBatch(int MtlItemId, string SpreadsheetData)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //取得品號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號】資料錯誤!");
                        #endregion

                        var jsonData = JObject.Parse(SpreadsheetData);

                        int rowsAffected = 0;
                        if (jsonData["spreadsheetInfo"] != null)
                        {
                            #region //判斷欄位值是否有誤
                            List<string> msgs = new List<string>();
                            var vCol = new List<string> { "DesignValue", "UpperTolerance", "LowerTolerance" };
                            vCol.ForEach(v =>
                            {
                                var vData = jsonData["spreadsheetInfo"].Select(s => new { QcItemNo = s["QcItemNo"]?.ToString(), t = decimal.TryParse(s[v].ToString(), out decimal d), value = d })
                                    .Where(w => w.value == 0m).ToList();

                                if (vData.Any()) msgs.Add(string.Join("</br>", vData.Select(s => string.Format("{0} {1}值有誤", s.QcItemNo, v))));
                            });
                            //if (msgs.Any()) throw new SystemException(string.Join("</br>", msgs));
                            #endregion

                            var nQcItemNos = jsonData["spreadsheetInfo"].Select(s => s["QcItemNo"]?.ToString().Length == 10 ? s["QcItemNo"]?.ToString().Substring(0,3) + s["QcItemNo"]?.ToString().Substring(6) : s["QcItemNo"]?.ToString()).ToList();

                            #region //取得量測項目資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.QcItemId, a.QcItemNo
	                                FROM QMS.QcItem a
	                                INNER JOIN QMS.QcClass b ON b.QcClassId = a.QcClassId
	                                INNER JOIN QMS.QcGroup c ON c.QcGroupId = b.QcGroupId
	                                WHERE a.QcItemNo IN @QcItemNos
	                                AND c.CompanyId = @CompanyId";
                            dynamicParameters.Add("QcItemNos", nQcItemNos);
                            dynamicParameters.Add("CompanyId", CurrentCompany);

                            var resultN_QcItems = sqlConnection.Query(sql, dynamicParameters);
                            //if (resultN_QcItems.Count() <= 0) throw new SystemException("【量測項目】資料錯誤!");
                            #endregion

                            #region //取得現有品號量測項目資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT a.MtlQcItemId, a.QcItemId, a.DesignValue, a.UpperTolerance, a.LowerTolerance, a.QcItemDesc, b.QcItemNo, a.BallMark, a.Unit, a.QmmDetailId, a.Regulation, a.Notice
                                    FROM PDM.MtlQcItem a
                                    INNER JOIN QMS.QcItem b ON b.QcItemId = a.QcItemId
                                    WHERE a.MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            var resultO_QcItems = sqlConnection.Query(sql, dynamicParameters);
                            #endregion

                            var oQcItemNos = resultO_QcItems.Select(s => { return (string)s.QcItemNo; }).ToList();
                                                        
                            #region //刪除沒有量測項目的允收標準
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a
                                    FROM PDM.MtlQcItem a
                                    LEFT JOIN QMS.QcItem b ON b.QcItemId = a.QcItemId
                                    WHERE a.MtlItemId = @MtlItemId
                                    AND b.QcItemId IS NULL";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //取得可刪除的QcItemNo
                            //var deQcItemNos = oQcItemNos.Where(w => !nQcItemNos.Contains(w)).ToList();
                            var d_MtlQcItemIds = resultO_QcItems.Where(w => !nQcItemNos.Contains(w.QcItemNo)).Select(s => { return (int)s.MtlQcItemId; }).ToList();

                            #region //品號量測項目刪除
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.MtlQcItem
                                    WHERE MtlQcItemId IN @MtlQcItemIds";
                            dynamicParameters.Add("MtlQcItemIds", d_MtlQcItemIds);
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                            #endregion

                            #region //排序
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlQcItem SET
                                    SortNumber = SortNumber * -1,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlItemId
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //取得可更新的QcItemNo
                            var upQcItemNos = oQcItemNos.Where(w => nQcItemNos.Contains(w)).ToList();
                            foreach (var item in jsonData["spreadsheetInfo"].Where(w => upQcItemNos.Contains(w["QcItemNo"]?.ToString().Length == 10 ? w["QcItemNo"]?.ToString().Substring(0, 3) + w["QcItemNo"]?.ToString().Substring(6) : w["QcItemNo"]?.ToString())))
                            {
                                string qcItemNo = item["QcItemNo"]?.ToString();
                                if (qcItemNo.Length == 10) qcItemNo = qcItemNo.Substring(0, 3) + qcItemNo.Substring(6);
                                var o_QcItem = resultO_QcItems.FirstOrDefault(f => f.QcItemNo == qcItemNo);

                                if (o_QcItem == "") throw new SystemException("【量測項目】不能為空!");
                                int.TryParse(item["Row"]?.ToString(), out int sortNumber);
                                //decimal? designValue = decimal.TryParse(item["DesignValue"]?.ToString(), out decimal d) ? d : (decimal?)null;
                                //decimal? upperTolerance = decimal.TryParse(item["UpperTolerance"]?.ToString(), out d) ? d : (decimal?)null;
                                //decimal? lowerTolerance = decimal.TryParse(item["LowerTolerance"]?.ToString(), out d) ? d : (decimal?)null;
                                string designValue = item["DesignValue"]?.ToString() ?? null;
                                string upperTolerance = item["UpperTolerance"]?.ToString() ?? null;
                                string lowerTolerance = item["LowerTolerance"]?.ToString() ?? null;
                                string BallMark = item["BallMark"]?.ToString() ?? null;
                                string Unit = item["Unit"]?.ToString() ?? null;
                                string Regulation = item["Regulation"]?.ToString() ?? null;
                                string Notice = item["Notice"]?.ToString() ?? null;

                                #region //取得量測儀器
                                decimal? QmmDetailId = null;
                                if (item["QcItemNo"]?.ToString().Length == 10)
                                {
                                    string MachineNumber = item["QcItemNo"]?.ToString().Substring(3, 3);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.QmmDetailId, a.MachineNumber, b.MachineName, b.MachineNo
                                        FROM  QMS.QmmDetail a
                                        INNER JOIN MES.Machine b on a.MachineId = b.MachineId
                                        INNER JOIN MES.WorkShop c on b.ShopId = c.ShopId
                                        INNER JOIN BAS.Company d ON c.CompanyId = d.CompanyId
                                        where a.MachineNumber = @MachineNumber AND c.CompanyId = @CompanyId";
                                    dynamicParameters.Add("MachineNumber", MachineNumber);
                                    dynamicParameters.Add("CompanyId", CurrentCompany);
                                    var QmmDetailIdValue = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var qmmItem in QmmDetailIdValue)
                                    {
                                        QmmDetailId = qmmItem.QmmDetailId;
                                    }
                                }                                
                                #endregion

                                #region //現有品號量測項目更新
                                dynamicParameters = new DynamicParameters();
                                sql = @"UPDATE PDM.MtlQcItem SET
                                        BallMark = @BallMark,
                                        DesignValue = @DesignValue, 
                                        UpperTolerance = @UpperTolerance, 
                                        LowerTolerance = @LowerTolerance, 
                                        Unit = @Unit,
                                        QmmDetailId = @QmmDetailId,
                                        QcItemDesc = @QcItemDesc,
                                        SortNumber = @SortNumber,
                                        Regulation = @Regulation,
                                        Notice = @Notice,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE MtlQcItemId = @MtlQcItemId";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        o_QcItem.MtlQcItemId,
                                        BallMark,
                                        DesignValue = designValue,
                                        UpperTolerance = upperTolerance,
                                        LowerTolerance = lowerTolerance,
                                        Unit,
                                        QmmDetailId,
                                        QcItemDesc = item["QcItemDesc"]?.ToString(),
                                        SortNumber = sortNumber,
                                        Regulation,
                                        Notice,
                                        LastModifiedDate,
                                        LastModifiedBy,
                                        MtlItemId
                                    });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion
                            }
                            #endregion

                            #region //取得可新增的QcItemNo
                            var adQcItemNos = nQcItemNos.Where(w => !oQcItemNos.Contains(w)).ToList();
                            foreach (var item in jsonData["spreadsheetInfo"].Where(w => adQcItemNos.Contains(w["QcItemNo"]?.ToString().Length == 10 ? w["QcItemNo"]?.ToString().Substring(0,3) + w["QcItemNo"]?.ToString().Substring(6) : w["QcItemNo"]?.ToString())))
                            {
                                string qcItemNo = item["QcItemNo"]?.ToString();

                                if (qcItemNo.Length == 10) qcItemNo = qcItemNo.Substring(0, 3) + qcItemNo.Substring(6);
                                var n_QcItem = resultN_QcItems.FirstOrDefault(f => f.QcItemNo == qcItemNo);

                                int.TryParse(item["Row"]?.ToString(), out int sortNumber);
                                //decimal? designValue = decimal.TryParse(item["DesignValue"]?.ToString(), out decimal d) ? d : (decimal?)null;
                                //decimal? upperTolerance = decimal.TryParse(item["UpperTolerance"]?.ToString(), out d) ? d : (decimal?)null;
                                //decimal? lowerTolerance = decimal.TryParse(item["LowerTolerance"]?.ToString(), out d) ? d : (decimal?)null;
                                string designValue = item["DesignValue"]?.ToString() ?? null;
                                string upperTolerance = item["UpperTolerance"]?.ToString() ?? null;
                                string lowerTolerance = item["LowerTolerance"]?.ToString() ?? null;
                                string BallMark = item["BallMark"]?.ToString() ?? null;
                                string Unit = item["Unit"]?.ToString() ?? null;
                                string Regulation = item["Regulation"]?.ToString() ?? null;
                                string Notice = item["Notice"]?.ToString() ?? null;

                                #region //取得量測儀器
                                decimal? QmmDetailId = null;
                                if (item["QcItemNo"]?.ToString().Length == 10)
                                {
                                    string MachineNumber = item["QcItemNo"]?.ToString().Substring(3,3);
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT a.QmmDetailId, a.MachineNumber, b.MachineName, b.MachineNo
                                        FROM  QMS.QmmDetail a
                                        INNER JOIN MES.Machine b on a.MachineId = b.MachineId
                                        INNER JOIN MES.WorkShop c on b.ShopId = c.ShopId
                                        INNER JOIN BAS.Company d ON c.CompanyId = d.CompanyId
                                        where a.MachineNumber = @MachineNumber AND c.CompanyId = @CompanyId";
                                    dynamicParameters.Add("MachineNumber", MachineNumber);
                                    dynamicParameters.Add("CompanyId", CurrentCompany);
                                    var QmmDetailIdValue = sqlConnection.Query(sql, dynamicParameters);

                                    foreach (var qmmItem in QmmDetailIdValue)
                                    {
                                        QmmDetailId = qmmItem.QmmDetailId;
                                    }
                                }
                                #endregion

                                #region //品號量測項目新增
                                dynamicParameters = new DynamicParameters();
                                sql = @"INSERT INTO PDM.MtlQcItem (MtlItemId, QcItemId
                                        , DesignValue, UpperTolerance, LowerTolerance, QcItemDesc, SortNumber, Status, BallMark, Unit, QmmDetailId, Regulation, Notice
                                        , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                        OUTPUT INSERTED.MtlQcItemId
                                        VALUES (@MtlItemId, @QcItemId
                                        , @DesignValue, @UpperTolerance, @LowerTolerance, @QcItemDesc, @SortNumber, @Status, @BallMark, @Unit, @QmmDetailId, @Regulation, @Notice
                                        , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                                dynamicParameters.AddDynamicParams(
                                    new
                                    {
                                        MtlItemId,
                                        n_QcItem.QcItemId,
                                        BallMark,
                                        DesignValue = designValue,
                                        UpperTolerance = upperTolerance,
                                        LowerTolerance = lowerTolerance,
                                        Unit,
                                        QmmDetailId,
                                        QcItemDesc = item["QcItemDesc"]?.ToString(),
                                        SortNumber = sortNumber,
                                        Regulation,
                                        Notice,
                                        Status = "A",
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy,

                                    });
                                rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                #endregion

                                #region // AI解析CAD圖面規格，更新QcItemId, QcItemName, QcItemDesc
                                #region //取得ArcdId，規格+MtlItemId可能會重複，抓第一個QcItemId為NULL的ArcdId，有找到才更新QcItemId
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 ArcdId
                                    FROM PDM.AutoReadCadDesign 
                                    WHERE MtlItemId = @MtlItemId
                                    AND DesignValue = @DesignValue
                                    AND QcItemId = -1";
                                dynamicParameters.Add("MtlItemId", MtlItemId);
                                dynamicParameters.Add("DesignValue", designValue);
                                var resultCad = sqlConnection.Query(sql, dynamicParameters);
                                #endregion

                                if (resultCad.Count() > 0)
                                {
                                    int ArcdId = -1;
                                    foreach (var item3 in resultCad)
                                    {
                                        ArcdId = item3.ArcdId;
                                    }
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"UPDATE PDM.AutoReadCadDesign SET
                                        QcItemId = @QcItemId,
                                        QcItemName = @QcItemName,
                                        QcItemDesc = @QcItemDesc,
                                        BallMark = @BallMark,
                                        Unit = @Unit,
                                        Remark = @Notice,
                                        LastModifiedDate = @LastModifiedDate,
                                        LastModifiedBy = @LastModifiedBy
                                        WHERE ArcdId = @ArcdId";
                                    dynamicParameters.AddDynamicParams(
                                        new
                                        {
                                            ArcdId,
                                            n_QcItem.QcItemId,
                                            QcItemName = item["QcItemName"]?.ToString(),
                                            QcItemDesc = item["QcItemDesc"]?.ToString(),
                                            BallMark,
                                            Unit,
                                            Notice,
                                            LastModifiedDate,
                                            LastModifiedBy
                                        });
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                }                                
                                #endregion
                            }
                            #endregion
                        }
                        else
                        {
                            #region //品號量測項目刪除
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.MtlQcItem
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateMassProductionReviewDocFile -- 量產審查文件檔案更新 -- Ben Ma 2024.08.07
        public string UpdateMassProductionReviewDocFile(int MtlItemId, int DocId, int FileId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var resultMtlItem = sqlConnection.Query(sql, dynamicParameters);
                        if (resultMtlItem.Count() <= 0) throw new SystemException("品號資料錯誤!");
                        #endregion

                        #region //判斷量產審查文件設定資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MassProductionReviewDocSetting
                                WHERE DocId = @DocId";
                        dynamicParameters.Add("DocId", DocId);

                        var resultMassProductionReviewDocSetting = sqlConnection.Query(sql, dynamicParameters);
                        if (resultMassProductionReviewDocSetting.Count() <= 0) throw new SystemException("量產審查文件設定資料錯誤!");
                        #endregion

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MassProductionReviewDoc
                                WHERE MtlItemId = @MtlItemId
                                AND DocId = @DocId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        dynamicParameters.Add("DocId", DocId);

                        var resultMassProductionReviewDoc = sqlConnection.Query(sql, dynamicParameters);

                        int rowsAffected = 0;
                        if (resultMassProductionReviewDoc.Count() > 0)
                        {
                            sql = @"UPDATE PDM.MassProductionReviewDoc SET
                                    FileId = @FileId,
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE MtlItemId = @MtlItemId
                                    AND DocId = @DocId";
                            rowsAffected += sqlConnection.Execute(sql,
                                new
                                {
                                    FileId,
                                    LastModifiedDate,
                                    LastModifiedBy,
                                    MtlItemId,
                                    DocId
                                });
                        }
                        else
                        {
                            sql = @"INSERT INTO PDM.MassProductionReviewDoc (MtlItemId, DocId, FileId
                                    , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@MtlItemId, @DocId, @FileId
                                    , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql,
                                new
                                {
                                    MtlItemId,
                                    DocId,
                                    FileId,
                                    CreateDate,
                                    LastModifiedDate,
                                    CreateBy,
                                    LastModifiedBy
                                });
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateInventoryQueryWithNewMtlItemNo -- 新舊品號更新 -- Tim 2024.11.15
        public string UpdateInventoryQueryWithNewMtlItemNo(
            int MtlItemId,
            string NewMtlItemNo,
            string NewMtlItemName,
            string NewMtlItemSpec
        )
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;
                        string NewMtlItemNoBase = "";

                        if (NewMtlItemNo.Length > 0) //儲存有品號流程
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 NewMtlItemNo
                                    FROM PDM.MtlItemNoIntegration
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            var resultMtlItem1 = sqlConnection.Query(sql, dynamicParameters);

                            if (resultMtlItem1.Count() > 0) //舊品號已經有對照的新品號
                            {
                                foreach (var item in resultMtlItem1)
                                {
                                    NewMtlItemNoBase = item.NewMtlItemNo;
                                }

                                if (NewMtlItemNo != NewMtlItemNoBase) //新品號和資料庫品號不相同=>替換流程
                                {
                                    #region //替換流程
                                    sql = @"
                                        UPDATE
                                            PDM.MtlItemNoIntegration
                                        SET
                                            NewMtlItemNo = @NewMtlItemNo,
                                            NewMtlItemName = @NewMtlItemName,
                                            NewMtlItemSpec = @NewMtlItemSpec,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                        WHERE
                                            MtlItemId = @MtlItemId";
                                    rowsAffected += sqlConnection.Execute(sql,
                                        new
                                        {
                                            NewMtlItemNo,
                                            NewMtlItemName,
                                            NewMtlItemSpec,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            MtlItemId
                                        }
                                    );
                                    #endregion

                                    #region //判斷原新品號基本資料是否還有被使用到
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"SELECT TOP 1 1
                                            FROM PDM.NewMtlItemDetail
                                            WHERE MtlItemNo = @NewMtlItemNo";
                                    dynamicParameters.Add("NewMtlItemNo", NewMtlItemNoBase);
                                    resultMtlItem1 = sqlConnection.Query(sql, dynamicParameters);
                                    if (resultMtlItem1.Count() <= 0)
                                    {
                                        #region //刪除新品號基本資料
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE PDM.NewMtlItemDetail
                                                WHERE MtlItemNo = @MtlItemNo";
                                        dynamicParameters.Add("MtlItemNo", NewMtlItemNoBase);
                                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                    #endregion
                                }
                                else //新品號和資料庫品號相同
                                {
                                    #region //純更新流程(品名規格)
                                    sql = @"
                                        UPDATE
                                            PDM.MtlItemNoIntegration
                                        SET
                                            NewMtlItemName = @NewMtlItemName,
                                            NewMtlItemSpec = @NewMtlItemSpec,
                                            LastModifiedDate = @LastModifiedDate,
                                            LastModifiedBy = @LastModifiedBy
                                        WHERE
                                            MtlItemId = @MtlItemId";
                                    rowsAffected += sqlConnection.Execute(sql,
                                        new
                                        {
                                            NewMtlItemName,
                                            NewMtlItemSpec,
                                            LastModifiedDate,
                                            LastModifiedBy,
                                            MtlItemId
                                        }
                                    );
                                    #endregion
                                }
                            }
                            else //舊品號無對照的新品號
                            {
                                #region //新增流程
                                sql = @"
                                        INSERT INTO PDM.MtlItemNoIntegration (
                                            MtlItemId, NewMtlItemNo,NewMtlItemName, NewMtlItemSpec,
                                            CreateDate, LastModifiedDate, CreateBy, LastModifiedBy
                                        )
                                        VALUES (
                                            @MtlItemId, @NewMtlItemNo,@NewMtlItemName, @NewMtlItemSpec,
                                            @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy
                                        )";
                                rowsAffected += sqlConnection.Execute(sql,
                                    new
                                    {
                                        MtlItemId,
                                        NewMtlItemNo,
                                        NewMtlItemName,
                                        NewMtlItemSpec,
                                        CreateDate,
                                        LastModifiedDate,
                                        CreateBy,
                                        LastModifiedBy
                                    }
                                );
                                #endregion
                            }
                        }
                        else //儲存無品號=>刪除相關資料流程
                        {
                            #region //撈出當前舊品號的對照新品號
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT TOP 1 NewMtlItemNo
                                    FROM PDM.MtlItemNoIntegration
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            var resultMtlItem2 = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMtlItem2.Count() > 0)
                            {
                                foreach (var item in resultMtlItem2)
                                {
                                    NewMtlItemNoBase = item.NewMtlItemNo;
                                }

                                #region //判斷新品號基本資料是否還有被使用到
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM PDM.NewMtlItemDetail
                                        WHERE MtlItemNo = @NewMtlItemNo";
                                dynamicParameters.Add("NewMtlItemNo", NewMtlItemNoBase);
                                resultMtlItem2 = sqlConnection.Query(sql, dynamicParameters);
                                if (resultMtlItem2.Count() <= 0)
                                {
                                    #region //刪除新品號基本資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.NewMtlItemDetail
                                            WHERE MtlItemNo = @MtlItemNo";
                                    dynamicParameters.Add("MtlItemNo", NewMtlItemNoBase);
                                    rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                                #endregion
                            }
                            #endregion


                            #region //刪除新舊品號對照表
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.MtlItemNoIntegration
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                            if (rowsAffected == 0) rowsAffected = 1;
                            #endregion
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                    }
                    transactionScope.Complete();
                }
            }

            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //UpdateNewMtlItem -- 新品號資料異動 -- Shintokuro 2024.12.06
        #region //主程式
        public string UpdateNewMtlItem(int MtlItemId, string MtlItemNo, string MtlItemName, string MtlItemSpec, int InventoryUomId, int PurchaseUomId, int SaleUomId
            , string TypeOne, string TypeTwo, string TypeThree, string TypeFour, int InventoryId, int RequisitionInventoryId, string InventoryManagement, string MtlModify
            , string BondedStore, string ItemAttribute, string LotManagement, string MeasureType, string OverReceiptManagement, string OverDeliveryManagement, string EffectiveDate
            , string ExpirationDate, string MtlItemDesc, string MtlItemRemark, int EfficientDays, int RetestDays, string ProductionLine, string ReplenishmentPolicy)
        {
            try
            {
                if (MtlItemNo.Length <= 0) throw new SystemException("【品號】不能為空!");
                if (MtlItemNo.Length > 40) throw new SystemException("【品號】長度錯誤!");
                if (MtlItemName.Length <= 0) throw new SystemException("【品名】不能為空!");
                if (MtlItemName.Length > 120) throw new SystemException("【品名】長度錯誤!");
                if (MtlItemSpec.Length <= 0) throw new SystemException("【規格】不能為空!");
                if (MtlItemSpec.Length > 120) throw new SystemException("【規格】長度錯誤!");
                if (TypeOne.Length <= 0) throw new SystemException("【品號分類(一)】不能為空!");
                if (TypeTwo.Length <= 0) throw new SystemException("【品號分類(二)】不能為空!");
                if (TypeThree.Length <= 0) throw new SystemException("【品號分類(三)】不能為空!");
                if (TypeFour.Length <= 0) throw new SystemException("【品號分類(四)】不能為空!");
                if (ItemAttribute.Length <= 0) throw new SystemException("【品號屬性】不能為空!");
                if (LotManagement.Length <= 0) throw new SystemException("【批號管理】不能為空!");
                if (MeasureType.Length <= 0) throw new SystemException("【檢驗方式】不能為空!");
                if (ReplenishmentPolicy.Length <= 0) throw new SystemException("【補貨政策】不能為空!");

                #region //品號檢核
                if (MtlItemNo.Length <= 0) throw new SystemException("【品號】不可為空");
                if (string.IsNullOrWhiteSpace(MtlItemNo)) throw new SystemException("【品號】不可為空");
                if (string.IsNullOrEmpty(MtlItemNo)) throw new SystemException("【品號】不可為空");

                //24.01.17 加入(是否包含小寫字母)判斷
                if (Regex.IsMatch(MtlItemNo, @"[a-z]"))
                    throw new SystemException("【品號】不可包含小寫字母");

                //24.01.05 加入(有無寬度的空白字元)判斷
                if (Regex.IsMatch(MtlItemNo, @"[\s\u0009-\u000D\u0020\u0085\u00A0\u1680\u2000-\u200A\u2028-\u2029\u202F\u205F\u3000\u180E\u200B-\u200D\u2060\uFEFF\u00B7\u237D\u2420\u2422\u2423]"))
                    throw new SystemException("【品號】不可為空");

                //24.01.05 加入(全形數字 大寫英文 小寫英文)判斷
                if (Regex.IsMatch(MtlItemNo, @"[\uFF10-\uFF19\uFF41-\uFF5A\uFF21-\uFF3A]"))
                    throw new SystemException("【品號】不能包含全形英文及數字!");

                //MtlItemNo是否包含繁簡體中文
                if (Regex.IsMatch(MtlItemNo, @"\p{IsCJKUnifiedIdeographs}") == true)
                    throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");
                if (Regex.IsMatch(MtlItemNo, @"[\u4e00-\u9fa5\u2e80-\u2eff\u2f00-\u2fdf\u3000-\u303f\u31c0-\u31ef\u3200-\u32ff\u3400-\u4dbf\u4e00-\u9fff\uf900-\ufaff]"))
                    throw new SystemException("【品號管理】- 【品號】不能包含繁簡體中文!");

                MtlItemNo = MtlItemNo.Trim().ToUpper();
                #endregion

                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int rowsAffected = 0;
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string Action = "";

                        int? NewMtDetailId = -1;
                        string NewMtlItemName = "";
                        string NewMtlItemSpec = "";
                        int Situation = -1;
                        // Situation = 1 未存在新品號和新品號基本資料
                        // Situation = 2 已存在新品號(同人),未存在新品號基本資料
                        // Situation = 3 已存在新品號(不同人),未存在新品號基本資料
                        // Situation = 4 已存在新品號(同人),已存在新品號基本資料(同人)
                        // Situation = 5 已存在新品號(同人),已存在新品號基本資料(不同人)
                        // Situation = 6 已存在新品號(不同人),已存在新品號基本資料(同人)
                        // Situation = 7 已存在新品號(不同人),已存在新品號基本資料(不同人)

                        #region //取得當前動作
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 NewMtlItemNo
                                FROM PDM.MtlItemNoIntegration a
                                WHERE a.MtlItemId = @MtlItemId
                                ORDER BY a.CreateDate ASC
                                ";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0)
                        {
                            Action = "Add";
                        }
                        else
                        {
                            Action = "Update";
                            foreach(var item in result)
                            {
                                if(item.NewMtlItemNo != MtlItemNo) throw new SystemException("系統異常,當前品號和品號基本資料表不一致");
                            }
                        }
                        #endregion

                        #region //取得新品號當前對應情境
                        Situation = GetActionSituation(MtlItemNo, sqlConnection);
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.NewMtlItemName,a.NewMtlItemSpec,
                                a.CreateBy,b.UserNo+' ' + b.UserName CreateUser,ISNULL(x.DetailCreateUser,'N') DetailCreateUser,x.DetailCreateBy,x.NewMtDetailId 
                                FROM PDM.MtlItemNoIntegration a
                                INNER JOIN BAS.[User] b on a.CreateBy = b.UserId
                                OUTER APPLY(
                                    SELECT TOP 1 x1.CreateBy DetailCreateBy,x2.UserNo+' ' + x2.UserName DetailCreateUser,x1.NewMtDetailId
                                    FROM PDM.NewMtlItemDetail x1
                                    INNER JOIN BAS.[User] x2 on x1.CreateBy = x2.UserId
                                    WHERE x1.MtlItemNo = @MtlItemNo
                                    AND x1.CompanyId = @CompanyId
                                    ORDER BY x1.CreateDate ASC
                                ) x
                                WHERE a.NewMtlItemNo = @MtlItemNo
                                ORDER BY a.CreateDate ASC
                                ";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) //沒有資料
                        {
                            Situation = 1;
                        }
                        else
                        {
                            int? CreateBy = -1;
                            string CreateUser = "";
                            int? DetailCreateBy = -1;
                            string DetailCreateUser = "";

                            foreach (var item in result)
                            {
                                CreateBy = item.CreateBy;
                                CreateUser = item.CreateUser;
                                DetailCreateBy = item.DetailCreateBy;
                                DetailCreateUser = item.DetailCreateUser;
                                NewMtlItemName = item.NewMtlItemName;
                                NewMtlItemSpec = item.NewMtlItemSpec;
                                NewMtDetailId = item.NewMtDetailId;
                            }
                            
                            if(DetailCreateUser == "N")
                            {
                                if (CreateBy == CurrentUser)
                                {
                                    Situation = 2;
                                }
                                if (CreateBy != CurrentUser)
                                {
                                    Situation = 3;
                                }
                            }
                            else
                            {
                                if (CreateBy == CurrentUser && DetailCreateBy == CurrentUser)
                                {
                                    Situation = 4;
                                }
                                if (CreateBy == CurrentUser && DetailCreateBy != CurrentUser)
                                {
                                    Situation = 5;
                                }
                                if (CreateBy != CurrentUser && DetailCreateBy == CurrentUser)
                                {
                                    Situation = 6;
                                }
                                if (CreateBy != CurrentUser && DetailCreateBy != CurrentUser)
                                {
                                    Situation = 7;
                                }
                            }
                        }
                        #endregion

                        #region //對應情境動作
                        switch (Situation)
                        {
                            case 1: //未存在新品號和新品號基本資料
                                #region //新增-新品號基本資料
                                rowsAffected += AddNewMtlItemDetail(MtlItemNo, InventoryUomId, PurchaseUomId, SaleUomId
                                    , TypeOne, TypeTwo, TypeThree, TypeFour, InventoryId, RequisitionInventoryId
                                    , InventoryManagement, MtlModify, BondedStore, ItemAttribute, LotManagement, MeasureType
                                    , OverReceiptManagement, OverDeliveryManagement, EffectiveDate, ExpirationDate, MtlItemDesc, MtlItemRemark
                                    , EfficientDays, RetestDays, ProductionLine, ReplenishmentPolicy
                                    , sqlConnection);
                                #endregion
                                break;
                            case 2: //已存在新品號(同人),未存在新品號基本資料
                                #region //更新-新品號品名規格
                                rowsAffected += UpdateMtlItemNoIntegration(MtlItemNo, MtlItemName, MtlItemSpec
                                    , sqlConnection);
                                #endregion

                                #region //新增-新品號基本資料
                                rowsAffected += AddNewMtlItemDetail(MtlItemNo, InventoryUomId, PurchaseUomId, SaleUomId
                                    , TypeOne, TypeTwo, TypeThree, TypeFour, InventoryId, RequisitionInventoryId
                                    , InventoryManagement, MtlModify, BondedStore, ItemAttribute, LotManagement, MeasureType
                                    , OverReceiptManagement, OverDeliveryManagement, EffectiveDate, ExpirationDate, MtlItemDesc, MtlItemRemark
                                    , EfficientDays, RetestDays, ProductionLine, ReplenishmentPolicy
                                    , sqlConnection);
                                #endregion
                                break;
                            case 3: //已存在新品號(不同人),未存在新品號基本資料
                                #region //取得-最初版本的品名規格
                                MtlItemName = NewMtlItemName;
                                MtlItemSpec = NewMtlItemSpec;
                                #endregion

                                #region //新增-新品號基本資料
                                rowsAffected += AddNewMtlItemDetail(MtlItemNo, InventoryUomId, PurchaseUomId, SaleUomId
                                    , TypeOne, TypeTwo, TypeThree, TypeFour, InventoryId, RequisitionInventoryId
                                    , InventoryManagement, MtlModify, BondedStore, ItemAttribute, LotManagement, MeasureType
                                    , OverReceiptManagement, OverDeliveryManagement, EffectiveDate, ExpirationDate, MtlItemDesc, MtlItemRemark
                                    , EfficientDays, RetestDays, ProductionLine, ReplenishmentPolicy
                                    , sqlConnection);
                                #endregion
                                break;
                            case 4: //已存在新品號(同人),已存在新品號基本資料(同人)
                                #region //更新-新品號品名規格
                                rowsAffected += UpdateMtlItemNoIntegration(MtlItemNo, MtlItemName, MtlItemSpec
                                    , sqlConnection);
                                #endregion

                                #region //更新-新品號基本資料
                                rowsAffected += UpdateNewMtlItemDetail(NewMtDetailId, MtlItemNo, InventoryUomId, PurchaseUomId, SaleUomId
                                    , TypeOne, TypeTwo, TypeThree, TypeFour, InventoryId, RequisitionInventoryId
                                    , InventoryManagement, MtlModify, BondedStore, ItemAttribute, LotManagement, MeasureType
                                    , OverReceiptManagement, OverDeliveryManagement, EffectiveDate, ExpirationDate, MtlItemDesc, MtlItemRemark
                                    , EfficientDays, RetestDays, ProductionLine, ReplenishmentPolicy
                                    , sqlConnection);
                                #endregion
                                break;
                            case 5: //已存在新品號(同人),已存在新品號基本資料(不同人)
                                #region //更新-新品號品名規格
                                rowsAffected += UpdateMtlItemNoIntegration(MtlItemNo, MtlItemName, MtlItemSpec
                                    , sqlConnection);
                                #endregion
                                break;
                            case 6: //已存在新品號(不同人),已存在新品號基本資料(同人)
                                #region //取得-最初版本的品名規格
                                MtlItemName = NewMtlItemName;
                                MtlItemSpec = NewMtlItemSpec;
                                #endregion

                                #region //更新-新品號基本資料
                                rowsAffected += UpdateNewMtlItemDetail(NewMtDetailId, MtlItemNo, InventoryUomId, PurchaseUomId, SaleUomId
                                    , TypeOne, TypeTwo, TypeThree, TypeFour, InventoryId, RequisitionInventoryId
                                    , InventoryManagement, MtlModify, BondedStore, ItemAttribute, LotManagement, MeasureType
                                    , OverReceiptManagement, OverDeliveryManagement, EffectiveDate, ExpirationDate, MtlItemDesc, MtlItemRemark
                                    , EfficientDays, RetestDays, ProductionLine, ReplenishmentPolicy
                                    , sqlConnection);
                                #endregion
                                break;
                            case 7: //已存在新品號(不同人),已存在新品號基本資料(不同人)
                                #region //取得-最初版本的品名規格
                                MtlItemName = NewMtlItemName;
                                MtlItemSpec = NewMtlItemSpec;
                                #endregion
                                break;
                        }
                        #endregion

                        #region //新增-新舊品號對照表
                        if (Action == "Add")
                        {
                            rowsAffected += AddMtlItemNoIntegration(MtlItemId, MtlItemNo, MtlItemName, MtlItemSpec
                                , sqlConnection);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //GetActionSituation -- 取得新品號當前對應情境
        public int GetActionSituation (string MtlItemNo
            , SqlConnection sqlConnection)
        {
            int Situation = -1;
            int? NewMtDetailId = -1;
            string NewMtlItemName = "";
            string NewMtlItemSpec = "";

            dynamicParameters = new DynamicParameters();
            sql = @"SELECT TOP 1 a.NewMtlItemName,a.NewMtlItemSpec,
                    a.CreateBy,b.UserNo+' ' + b.UserName CreateUser,ISNULL(x.DetailCreateUser,'N') DetailCreateUser,x.DetailCreateBy,x.NewMtDetailId 
                    FROM PDM.MtlItemNoIntegration a
                    INNER JOIN BAS.[User] b on a.CreateBy = b.UserId
                    OUTER APPLY(
                        SELECT TOP 1 x1.CreateBy DetailCreateBy,x2.UserNo+' ' + x2.UserName DetailCreateUser,x1.NewMtDetailId
                        FROM PDM.NewMtlItemDetail x1
                        INNER JOIN BAS.[User] x2 on x1.CreateBy = x2.UserId
                        WHERE x1.MtlItemNo = @MtlItemNo
                        AND x1.CompanyId = @CompanyId
                        ORDER BY x1.CreateDate ASC
                    ) x
                    WHERE a.NewMtlItemNo = @MtlItemNo
                    ORDER BY a.CreateDate ASC
                    ";
            dynamicParameters.Add("CompanyId", CurrentCompany);
            dynamicParameters.Add("MtlItemNo", MtlItemNo);
            var result = sqlConnection.Query(sql, dynamicParameters);
            if (result.Count() <= 0) //沒有資料
            {
                Situation = 1;
            }
            else
            {
                int? CreateBy = -1;
                string CreateUser = "";
                int? DetailCreateBy = -1;
                string DetailCreateUser = "";

                foreach (var item in result)
                {
                    CreateBy = item.CreateBy;
                    CreateUser = item.CreateUser;
                    DetailCreateBy = item.DetailCreateBy;
                    DetailCreateUser = item.DetailCreateUser;
                    NewMtlItemName = item.NewMtlItemName;
                    NewMtlItemSpec = item.NewMtlItemSpec;
                    NewMtDetailId = item.NewMtDetailId;
                }

                if (DetailCreateUser == "N")
                {
                    if (CreateBy == CurrentUser)
                    {
                        Situation = 2;
                    }
                    if (CreateBy != CurrentUser)
                    {
                        Situation = 3;
                    }
                }
                else
                {
                    if (CreateBy == CurrentUser && DetailCreateBy == CurrentUser)
                    {
                        Situation = 4;
                    }
                    if (CreateBy == CurrentUser && DetailCreateBy != CurrentUser)
                    {
                        Situation = 5;
                    }
                    if (CreateBy != CurrentUser && DetailCreateBy == CurrentUser)
                    {
                        Situation = 6;
                    }
                    if (CreateBy != CurrentUser && DetailCreateBy != CurrentUser)
                    {
                        Situation = 7;
                    }
                }


            }

            return Situation;
        }
        #endregion

        #region //AddMtlItemNoIntegration --新增新舊品號對照表
        public int AddMtlItemNoIntegration(int MtlItemId, string MtlItemNo, string MtlItemName, string MtlItemSpec
            , SqlConnection sqlConnection)
        {
            int rows = 0;
            sql = @"
                    INSERT INTO PDM.MtlItemNoIntegration (
                        MtlItemId, NewMtlItemNo,NewMtlItemName,NewMtlItemSpec,
                        CreateDate, LastModifiedDate, CreateBy, LastModifiedBy
                    )
                    VALUES (
                        @MtlItemId, @NewMtlItemNo, @NewMtlItemName, @NewMtlItemSpec,
                        @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy
                    )";
            dynamicParameters.AddDynamicParams(
                    new
                    {
                        MtlItemId,
                        NewMtlItemNo = MtlItemNo,
                        NewMtlItemName = MtlItemName,
                        NewMtlItemSpec = MtlItemSpec,
                        CreateDate,
                        LastModifiedDate,
                        CreateBy,
                        LastModifiedBy
                    });
            rows = sqlConnection.Execute(sql, dynamicParameters);

            return rows;
        }
        #endregion

        #region //AddNewMtlItemDetail -- 新增新品號基本資料
        public int AddNewMtlItemDetail(string MtlItemNo, int InventoryUomId, int PurchaseUomId, int SaleUomId
            , string TypeOne, string TypeTwo, string TypeThree, string TypeFour, int InventoryId, int RequisitionInventoryId, string InventoryManagement, string MtlModify
            , string BondedStore, string ItemAttribute, string LotManagement, string MeasureType, string OverReceiptManagement, string OverDeliveryManagement, string EffectiveDate
            , string ExpirationDate, string MtlItemDesc, string MtlItemRemark, int EfficientDays, int RetestDays, string ProductionLine, string ReplenishmentPolicy
            , SqlConnection sqlConnection)
        {
            int rows = 0;
            dynamicParameters = new DynamicParameters();
            sql = @"INSERT INTO PDM.NewMtlItemDetail (CompanyId, MtlItemNo
                                , InventoryUomId, PurchaseUomId, SaleUomId, TypeOne, TypeTwo
                                , TypeThree, TypeFour, InventoryId, RequisitionInventoryId, InventoryManagement
                                , MtlModify, BondedStore, ItemAttribute, ProductionLine, LotManagement, EfficientDays, RetestDays,ReplenishmentPolicy, MeasureType, EffectiveDate
                                , ExpirationDate, OverReceiptManagement, OverDeliveryManagement, Version
                                , MtlItemDesc, MtlItemRemark, TransferStatus, TransferDate, Status
                                , CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                OUTPUT INSERTED.NewMtDetailId,INSERTED.MtlItemNo,INSERTED.InventoryUomId
                                VALUES (@CompanyId, @MtlItemNo
                                , @InventoryUomId, @PurchaseUomId, @SaleUomId, @TypeOne, @TypeTwo
                                , @TypeThree, @TypeFour, @InventoryId, @RequisitionInventoryId, @InventoryManagement
                                , @MtlModify, @BondedStore, @ItemAttribute, @ProductionLine, @LotManagement, @EfficientDays, @RetestDays,@ReplenishmentPolicy, @MeasureType, @EffectiveDate
                                , @ExpirationDate, @OverReceiptManagement, @OverDeliveryManagement, @Version
                                , @MtlItemDesc, @MtlItemRemark, @TransferStatus, @TransferDate, @Status
                                , @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
            dynamicParameters.AddDynamicParams(
                new
                {
                    CompanyId = CurrentCompany,
                    MtlItemNo = MtlItemNo,
                    InventoryUomId = InventoryUomId > 0 ? (int?)InventoryUomId : null,
                    PurchaseUomId = PurchaseUomId > 0 ? (int?)PurchaseUomId : null,
                    SaleUomId = SaleUomId > 0 ? (int?)SaleUomId : null,
                    TypeOne,
                    TypeTwo,
                    TypeThree,
                    TypeFour,
                    InventoryId = InventoryId > 0 ? (int?)InventoryId : null,
                    RequisitionInventoryId = RequisitionInventoryId > 0 ? (int?)RequisitionInventoryId : null,
                    InventoryManagement,
                    MtlModify,
                    BondedStore,
                    ItemAttribute,
                    ProductionLine,
                    LotManagement,
                    EfficientDays = LotManagement != "N" ? EfficientDays : 0,
                    RetestDays = LotManagement != "N" ? RetestDays : 0,
                    ReplenishmentPolicy,
                    MeasureType,
                    EffectiveDate = EffectiveDate.Length > 0 ? EffectiveDate : null,
                    ExpirationDate = ExpirationDate.Length > 0 ? ExpirationDate : null,
                    OverReceiptManagement,
                    OverDeliveryManagement,
                    Version = "0000",
                    MtlItemDesc,
                    MtlItemRemark,
                    TransferStatus = "N",
                    TransferDate = (int?)null,
                    Status = "A",
                    CreateDate,
                    LastModifiedDate,
                    CreateBy,
                    LastModifiedBy
                });
            rows += sqlConnection.Execute(sql, dynamicParameters);
            return rows;
        }
        #endregion

        #region //UpdateMtlItemNoIntegration -- 更新新品號品名規格
        public int UpdateMtlItemNoIntegration(string MtlItemNo, string MtlItemName, string MtlItemSpec
            , SqlConnection sqlConnection)
        {
            int rows = 0;
            sql = @"UPDATE
                        PDM.MtlItemNoIntegration
                    SET
                        NewMtlItemName = @NewMtlItemName,
                        NewMtlItemSpec = @NewMtlItemSpec,
                        LastModifiedDate = @LastModifiedDate,
                        LastModifiedBy = @LastModifiedBy
                    WHERE
                        NewMtlItemNo = @MtlItemNo";
            rows += sqlConnection.Execute(sql,
                new
                {
                    NewMtlItemName = MtlItemName,
                    NewMtlItemSpec = MtlItemSpec,
                    LastModifiedDate,
                    LastModifiedBy,
                    MtlItemNo
                }
            );
            return rows;
        }
        #endregion

        #region //UpdateNewMtlItemDetail --更新新品號基本資料
        public int UpdateNewMtlItemDetail(int? NewMtDetailId, string MtlItemNo, int InventoryUomId, int PurchaseUomId, int SaleUomId
            , string TypeOne, string TypeTwo, string TypeThree, string TypeFour, int InventoryId, int RequisitionInventoryId, string InventoryManagement, string MtlModify
            , string BondedStore, string ItemAttribute, string LotManagement, string MeasureType, string OverReceiptManagement, string OverDeliveryManagement, string EffectiveDate
            , string ExpirationDate, string MtlItemDesc, string MtlItemRemark, int EfficientDays, int RetestDays, string ProductionLine, string ReplenishmentPolicy
            , SqlConnection sqlConnection)
        {
            int rows = 0;
            dynamicParameters = new DynamicParameters();
            sql = @"UPDATE PDM.NewMtlItemDetail SET
                    InventoryUomId = @InventoryUomId,
                    PurchaseUomId = @PurchaseUomId,
                    SaleUomId = @SaleUomId,
                    TypeOne = @TypeOne,
                    TypeTwo = @TypeTwo,
                    TypeThree = @TypeThree,
                    TypeFour = @TypeFour,
                    InventoryId = @InventoryId,
                    RequisitionInventoryId = @RequisitionInventoryId,
                    InventoryManagement = @InventoryManagement,
                    MtlModify = @MtlModify,
                    BondedStore = @BondedStore,
                    ItemAttribute = @ItemAttribute,
                    ProductionLine = @ProductionLine,
                    LotManagement = @LotManagement,
                    EfficientDays = @EfficientDays,
                    RetestDays = @RetestDays,
                    ReplenishmentPolicy = @ReplenishmentPolicy,
                    MeasureType = @MeasureType,
                    EffectiveDate = @EffectiveDate,
                    ExpirationDate = @ExpirationDate,
                    OverReceiptManagement = @OverReceiptManagement,
                    OverDeliveryManagement = @OverDeliveryManagement,
                    MtlItemDesc = @MtlItemDesc,
                    MtlItemRemark = @MtlItemRemark,
                    LastModifiedDate = @LastModifiedDate,
                    LastModifiedBy = @LastModifiedBy
                    WHERE NewMtDetailId = @NewMtDetailId";
            dynamicParameters.AddDynamicParams(
                new
                {
                    InventoryUomId = InventoryUomId > 0 ? (int?)InventoryUomId : null,
                    PurchaseUomId = PurchaseUomId > 0 ? (int?)PurchaseUomId : null,
                    SaleUomId = SaleUomId > 0 ? (int?)SaleUomId : null,
                    TypeOne,
                    TypeTwo,
                    TypeThree,
                    TypeFour,
                    InventoryId = InventoryId > 0 ? (int?)InventoryId : null,
                    RequisitionInventoryId = RequisitionInventoryId > 0 ? (int?)RequisitionInventoryId : null,
                    InventoryManagement,
                    MtlModify,
                    BondedStore,
                    ItemAttribute,
                    ProductionLine,
                    LotManagement,
                    EfficientDays = LotManagement != "N" ? EfficientDays : 0,
                    RetestDays = LotManagement != "N" ? RetestDays : 0,
                    ReplenishmentPolicy,
                    MeasureType,
                    EffectiveDate = EffectiveDate.Length > 0 ? EffectiveDate : null,
                    ExpirationDate = ExpirationDate.Length > 0 ? ExpirationDate : null,
                    OverReceiptManagement,
                    OverDeliveryManagement,
                    MtlItemDesc,
                    MtlItemRemark,
                    LastModifiedDate,
                    LastModifiedBy,
                    NewMtDetailId
                });

            rows += sqlConnection.Execute(sql, dynamicParameters);
            return rows;
        }
        #endregion

        #endregion

        #region //UpdateNewMtlItemToErp -- 新品號拋轉ERP -- Shintokuro 2024.12.10
        public string UpdateNewMtlItemToErp(string NewMtlItemList = "")
        {
            try
            {

                string ErpConnectionStringsJMO = "";
                string ErpConnectionStringsDG = "";
                string ErpConnectionStringsETG = "";
                string dateNow = CreateDate.ToString("yyyyMMdd"), timeNow = CreateDate.ToString("HH:mm:ss");
                string departmentNo = "", MESCompanyNo = "", userNo = "", userName = "", userGroup = "";
                int rowsAffected = 0;

                List<MtlItemReference> reference = new List<MtlItemReference>();
                List<string> invmbAdd = new List<string>();
                List<string> invmoAdd = new List<string>();
                List<INVTA> invtaAdd = new List<INVTA>();
                List<INVTB> invtbAdd = new List<INVTB>();


                List<string> ActionLog = new List<string>();
                List<string> ErrLog = new List<string>();
                List<string> TransferLog = new List<string>();
                List<string> AdjustmentLog = new List<string>();



                using (TransactionScope transactionScope = new TransactionScope())
                {

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb,ErpNo,x.JMOErp,x.DGErp,x.ETGErp
                                FROM BAS.Company
                                OUTER APPLY(
                                    SELECT 
                                        MAX(CASE WHEN CompanyId = 2 THEN ErpDb END) AS JMOErp,
                                        MAX(CASE WHEN CompanyId = 3 THEN ErpDb END) AS ETGErp,
                                        MAX(CASE WHEN CompanyId = 4 THEN ErpDb END) AS DGErp
                                    FROM BAS.Company
                                ) x
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            ErpConnectionStringsJMO = ConfigurationManager.AppSettings[item.JMOErp];
                            ErpConnectionStringsDG  = ConfigurationManager.AppSettings[item.DGErp];
                            ErpConnectionStringsETG = ConfigurationManager.AppSettings[item.ETGErp];
                            MESCompanyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItemNoIntegration");
                        dynamicParameters.Add("DetailCode", "read");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //撈取欲異動品號
                        //新品號已經存在,就採用新品號版本的品名規格,
                        //如果新品號不存在,需要判斷當前是否有多個版本,沒有才能採用當前的,如果當前沒填寫採用當前舊版
                        
                        dynamicParameters = new DynamicParameters();
                        sql = $@"SELECT a.MtlItemId,b.MtlItemNo,a.NewMtlItemNo,a.NewMtlItemName,a.NewMtlItemSpec,a.Adjustment,
                                (
                                    SELECT CASE WHEN COUNT(*) = 1 THEN 'Y' ELSE 'N' END AS  OnlyVersion
                                    FROM(
                                        SELECT  DISTINCT x1.NewMtlItemNo, x1.NewMtlItemName, x1.NewMtlItemSpec
                                        FROM PDM.MtlItemNoIntegration x1
                                        WHERE x1.NewMtlItemNo = a.NewMtlItemNo
                                    ) a
                                ) OnlyVersion,
                                (
                                    SELECT CASE WHEN COUNT(*) >1 THEN 'Y' ELSE 'N' END
                                    FROM PDM.MtlItemNoIntegration x2
                                    WHERE x2.NewMtlItemNo = a.NewMtlItemNo
                                    {(NewMtlItemList.Length >0? $"AND x2.MtlItemId IN ({NewMtlItemList})" : "")}
                                ) ManyToOne
                                FROM PDM.MtlItemNoIntegration a
                                INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                WHERE b.CompanyId = @CompanyId
                                AND a.Adjustment != 'O'"; 
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        if (NewMtlItemList.Length > 0) BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "NewMtlItemList", @" AND a.MtlItemId IN @NewMtlItemList", NewMtlItemList.Split(','));

                        reference = sqlConnection.Query<MtlItemReference>(sql, dynamicParameters).ToList();
                        #endregion

                        if(reference.Count()<=0) throw new SystemException("目前無可異動的新舊品號!!");

                    }
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStringsJMO))
                    {
                        reference.ForEach(item =>
                        {
                            #region //判斷新舊品號ERP是否存在INVMB
                            dynamicParameters = new DynamicParameters();
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT
                                    a.MB002,a.MB003
                                    FROM INVMB a
                                    WHERE a.MB001 = @NewMtlItemNo";
                            dynamicParameters.Add("NewMtlItemNo", item.NewMtlItemNo);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if(result.Count() > 0)
                            {
                                foreach (var item2 in result)
                                {
                                    item.JmoMtlItemName = item2.MB002;
                                    item.JmoMtlItemSpec = item2.MB003;
                                }
                            }
                            #endregion
                        });
                    }
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStringsDG))
                    {
                        reference.ForEach(item =>
                        {
                            #region //判斷新舊品號ERP是否存在INVMB
                            dynamicParameters = new DynamicParameters();
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT
                                    a.MB002,a.MB003
                                    FROM INVMB a
                                    WHERE a.MB001 = @NewMtlItemNo";
                            dynamicParameters.Add("NewMtlItemNo", item.NewMtlItemNo);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item2 in result)
                                {
                                    if(item.JmoMtlItemName != "" || item.JmoMtlItemSpec != "")
                                    {
                                        if(item.JmoMtlItemName != item2.MB002 || item.JmoMtlItemSpec != item2.MB003)
                                        {
                                            item.MultipleVersions = "Y";
                                            item.ReturnMsg = "新品號:不同版本的品名規格存在其他間公司,屬於異常";
                                            ErrLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:不同版本的品名規格存在其他間公司,屬於異常");

                                        }
                                    }
                                }
                            }
                            #endregion
                        });
                    }
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStringsETG))
                    {
                        reference.ForEach(item =>
                        {
                            #region //判斷新舊品號ERP是否存在INVMB
                            dynamicParameters = new DynamicParameters();
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT
                                    a.MB002,a.MB003
                                    FROM INVMB a
                                    WHERE a.MB001 = @NewMtlItemNo";
                            dynamicParameters.Add("NewMtlItemNo", item.NewMtlItemNo);

                            var result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item2 in result)
                                {
                                    if (item.JmoMtlItemName != "" || item.JmoMtlItemSpec != "")
                                    {
                                        if (item.JmoMtlItemName != item2.MB002 || item.JmoMtlItemSpec != item2.MB003)
                                        {
                                            item.MultipleVersions = "S";
                                            item.ReturnMsg = "新品號:不同版本的品名規格存在其他間公司,屬於異常";
                                            ErrLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:不同版本的品名規格存在其他間公司,屬於異常");
                                        }
                                    }
                                }
                            }
                            #endregion
                        });
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //ERP公司代碼取得
                        string ERPCompanyNo = "";
                        string FactoryCode = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ML001  ,
                                (SELECT TOP 1 MB001 FROM CMSMB) FactoryCode
                                FROM CMSML";
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in result)
                        {
                            ERPCompanyNo = item.ML001;
                            FactoryCode = item.FactoryCode;
                        }
                        if (MESCompanyNo != ERPCompanyNo) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                        #endregion

                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                        FROM ADMMF
                                        WHERE COMPANY = @CompanyNo
                                        AND MF001 = @userNo";
                        dynamicParameters.Add("CompanyNo", ERPCompanyNo);
                        dynamicParameters.Add("userNo", userNo);
                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("【ERP使用者】不存在!");
                        #endregion

                        #region //審核ERP權限-建立
                        var USR_GROUP = BaseHelper.CheckErpAuthority(userNo, sqlConnection, "COPI08", "CREATE");
                        #endregion

                        #region //庫存異動單設定
                        string TA001 = "1108"; //單別
                        string TA002 = ""; //單號
                        int Sequence = 1;
                        string TA004 = "A751"; //部門代號 系統開發室
                        string TA005 = "系統建立新舊品號庫存移轉用"; //部門代號 系統開發室
                        string TA008 = FactoryCode; //廠別代號
                        string TA009 = ""; //單據性質碼
                        double TA011 = 0, TA012 = 0; //總數量,總金額 因為正和負會開一起,故理論上 兩個數值都是0
                        string CFIELD01 = "";
                        #region //撈取ERP單據設定
                        DateTime referenceTime = default(DateTime);
                        referenceTime = DateTime.ParseExact(dateNow, "yyyyMMdd", CultureInfo.InvariantCulture);


                        string WoType = ""; //自動產生發票號碼
                        string encode = ""; // 編碼格式
                        int yearLength = 0; // 年碼數
                        int lineLength = 0; // 流水碼數
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MQ004, a.MQ005, a.MQ006, a.MQ044, a.MQ017,a.MQ003
                                FROM CMSMQ a
                                WHERE MQ001 = @TA001";
                        dynamicParameters.Add("TA001", TA001);
                        var resultReceiptNo = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultReceiptNo)
                        {
                            encode = item.MQ004; //編碼方式
                            yearLength = Convert.ToInt32(item.MQ005); //年碼數
                            lineLength = Convert.ToInt32(item.MQ006); //流水號碼數
                            WoType = item.MQ017;
                            TA009 = item.MQ003;
                        }
                        #endregion

                        #region //單號自動取號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TA002))), '" + new string('0', lineLength) + @"'), " + lineLength + @")) + 1 CurrentNum
                                FROM INVTA
                                WHERE TA001 = @TA001";
                        dynamicParameters.Add("TA001", TA001);


                        #region //編碼格式相關
                        string dateFormat = "";
                        switch (encode)
                        {
                            case "1": //日編
                                if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                if ((lineLength + yearLength + 4) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                dateFormat = new string('y', yearLength) + "MMdd";
                                sql += @" AND RTRIM(LTRIM(TA002)) LIKE @ReferenceTime  + '" + new string('_', lineLength) + @"'";
                                //sql += @" AND TH002 LIKE '%' + @ReferenceTime + '%' + '" + new string('_', lineLength) + @"'";
                                dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));

                                string tedstNo = referenceTime.ToString(dateFormat);
                                TA002 = referenceTime.ToString(dateFormat);
                                break;
                            case "2": //月編
                                if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                if ((lineLength + yearLength + 2) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                dateFormat = new string('y', yearLength) + "MM";
                                sql += @" AND RTRIM(LTRIM(TA002))  LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                TA002 = referenceTime.ToString(dateFormat);
                                break;
                            case "3": //流水號
                                if (yearLength == 0) throw new SystemException("【ERP單據性質】年碼數必須等於0");
                                if (lineLength <= 0 || lineLength > 11) throw new SystemException("【ERP單據性質】流水編碼碼數必須大於0小於等於11");
                                break;
                            case "4": //手動編號
                                break;
                            default:
                                throw new SystemException("編碼方式錯誤!");
                        }
                        int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                        TA002 += string.Format("{0:" + new string('0', lineLength) + "}", currentNum);
                        CFIELD01 = TA001 + '-' + TA002;
                        #endregion

                        #endregion

                        #endregion

                        #region //判斷新舊品號ERP是否存在INVMB INVMO
                        //MO,MB要存在 => 正常
                        //MO不在MB在 => 當作正常,不用特別建立MO
                        //MO不在MB不在 => 當作正常,兩個資料都要建立
                        //MO在MB不在 => 當作異常都不動作
                        reference.ForEach(item =>
                        {
                            if (item.MultipleVersions == "Y") return;

                            item.TransferStatus = "Y"; //預設新品號已拋轉ERP
                            item.ExpirationDate = CreateDate;
                            item.CREATE_DATE = dateNow;
                            item.CREATE_TIME = timeNow;
                            item.CREATE_AP = BaseHelper.ClientComputer();

                            #region //判斷新舊品號ERP是否存在INVMB
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT
                                    CASE 
                                        WHEN EXISTS (SELECT 1 FROM INVMB WHERE MB001 = @NewMtlItemNo) 
                                        THEN 'Y'
                                        ELSE 'N'
                                    END AS dataINVMB,
                                    CASE 
                                        WHEN EXISTS (SELECT 1 FROM INVMO WHERE MO001 = @NewMtlItemNo)
                                        THEN 'Y'
                                        ELSE 'N'
                                    END AS dataINVMO,
                                    ISNULL((SELECT 
                                        LTRIM(RTRIM(x1.MC002)) MC002,
                                        LTRIM(RTRIM(x1.MC007)) MC007
                                     FROM INVMC x1
                                     WHERE x1.MC001 = a.MB001
                                     AND x1.MC007 > 0
                                     ORDER BY x1.MC002
                                     FOR XML PATH('MCDetail')),'') AS MCDetails
                                     ,a.MB002,a.MB003,a.MB004
                                     ,b.LB002,b.LB001,b.LB010
                                    FROM INVMB a
                                    OUTER APPLY(
                                        SELECT TOP 1 x1.LB002,x1.LB001,x1.LB010
                                        FROM INVLB x1
                                        WHERE x1.LB001 = a.MB001
                                        ORDER BY x1.LB002 DESC
                                    ) b
                                    WHERE a.MB001 = @MtlItemNo";
                            dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                            dynamicParameters.Add("NewMtlItemNo", item.NewMtlItemNo);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item2 in result)
                                {

                                    if (item2.dataINVMO == "Y" && item2.dataINVMB == "N")
                                    {
                                        #region //Log記錄
                                        item.TransferStatus = "E";
                                        item.Adjustment = "S";
                                        item.ReturnMsg = $"新品號INVMO已存在,INVMB不存在,屬於異常不做任何動作";
                                        ErrLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:新品號INVMO已存在,INVMB不存在,屬於異常不做任何動作");
                                        #endregion
                                    }
                                    else
                                    {
                                        if (item2.dataINVMO == "Y" && item2.dataINVMB == "Y")
                                        {
                                            if (item.Adjustment == "S")
                                            {
                                                item.Adjustment = "N";
                                            }

                                            #region //Log記錄
                                            //ActionLog.Add($"{item.NewMtlItemNo}:新品號INVMO已存在,INVMB存在,ERP不需建立品號");
                                            #endregion
                                        }
                                        else if (item2.dataINVMO == "N" && item2.dataINVMB == "Y")
                                        {
                                            if (item.Adjustment == "S")
                                            {
                                                item.Adjustment = "N";
                                            }
                                            #region //Log記錄
                                            //ActionLog.Add($"{item.NewMtlItemNo}:新品號INVMO不存在,INVMB存在,ERP不需建立品號");
                                            #endregion
                                        }
                                        else if (item2.dataINVMO == "N" && item2.dataINVMB == "N")
                                        {

                                            if (item.OnlyVersion == "Y" && item.ManyToOne == "N")
                                            {
                                                if (item.Adjustment == "S")
                                                {
                                                    item.Adjustment = "N";
                                                }
                                                #region //Log記錄
                                                item.TransferStatus = "N";

                                                TransferLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:已執行將新品號拋轉ERP動作");

                                                //ActionLog.Add($"{item.NewMtlItemNo}:新品號INVMO不存在,INVMB不存在,ERP需建立品號");
                                                #endregion

                                                if (item.NewMtlItemName == "" || item.NewMtlItemName == null || item.NewMtlItemSpec == "" || item.NewMtlItemSpec == null)
                                                {
                                                    item.NewMtlItemName = item2.MB002;
                                                    item.NewMtlItemSpec = item2.MB003;
                                                }
                                            }
                                            else
                                            {
                                                #region //Log記錄
                                                item.TransferStatus = "E";
                                                item.Adjustment = "S";
                                                if (item.OnlyVersion == "N")
                                                {
                                                    item.ReturnMsg += $"新品號尚未拋轉ERP且MES有多種版本,請先調整成唯一版本才能執行拋轉";

                                                    ErrLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:新品號尚未拋轉ERP且MES有多種版本,請先調整成唯一版本才能執行拋轉");
                                                }
                                                if (item.ManyToOne == "Y")
                                                {

                                                    item.ReturnMsg += $"尚未拋轉ERP的新品號目前對應多個舊品號,請先建立新品號OR先拋轉一組新舊品號";
                                                    ErrLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:尚未拋轉ERP的新品號目前對應多個舊品號,請先建立新品號OR先拋轉一組新舊品號");
                                                }
                                                //ActionLog.Add($"{item.NewMtlItemNo}:新品號尚未拋轉ERP但MES有多種版本,請先調整成唯一版本才能值形拋轉");
                                                #endregion
                                            }
                                        }
                                    }

                                    if (item.Adjustment == "N")
                                    {
                                        if (item2.MCDetails != "")
                                        {
                                            #region //解析品號庫別
                                            XDocument doc = XDocument.Parse("<MCDetails>" + item2.MCDetails + "</MCDetails>");  // 包裝根節點

                                            var mcDetails = doc.Descendants("MCDetail")
                                                               .Select(x => new
                                                               {
                                                                   MC002 = x.Element("MC002")?.Value,
                                                                   MC007 = x.Element("MC007")?.Value
                                                               });
                                            #endregion

                                            #region //欲做庫存異動的新舊品號清單
                                            foreach (var item3 in mcDetails)
                                            {

                                                List<INVTB> newDataTB = new List<INVTB>
                                                {
                                                    new INVTB {
                                                                  COMPANY = MESCompanyNo
                                                                , CREATOR = UserNo
                                                                , USR_GROUP = USR_GROUP.ToString()
                                                                , CREATE_DATE = dateNow
                                                                , MODIFIER = ""
                                                                , MODI_DATE = ""
                                                                , FLAG = "1"
                                                                , CREATE_TIME = timeNow
                                                                , CREATE_AP = BaseHelper.ClientComputer()
                                                                , CREATE_PRID = "BM"
                                                                , MtlItemNo = item.MtlItemNo
                                                                , TB001 = TA001
                                                                , TB002 = TA002
                                                                , TB003 = Sequence.ToString("D4")
                                                                , TB004 = item.MtlItemNo
                                                                , TB005 = item2.MB002
                                                                , TB006 = item2.MB003
                                                                , TB007 = Convert.ToDouble(item3.MC007) * -1
                                                                , TB008 = item2.MB004
                                                                , TB010 = Convert.ToDouble(item2.LB010)
                                                                , TB011 = Convert.ToDouble(item3.MC007) * -1 * Convert.ToDouble(item2.LB010)
                                                                , TB012 = item3.MC002
                                                                , TB018 = "N"
                                                                , TB019 = dateNow
                                                                , TB022 = 0
                                                                , TB024 = "N"
                                                                , TB025 = 0
                                                                , TB028 = 0
                                                                , TB029 = 0
                                                    },
                                                    new INVTB {
                                                                 COMPANY = MESCompanyNo
                                                                , CREATOR = UserNo
                                                                , USR_GROUP = USR_GROUP.ToString()
                                                                , CREATE_DATE = dateNow
                                                                , MODIFIER = ""
                                                                , MODI_DATE = ""
                                                                , FLAG = "1"
                                                                , CREATE_TIME = timeNow
                                                                , CREATE_AP = BaseHelper.ClientComputer()
                                                                , CREATE_PRID = "BM"
                                                                , MtlItemNo = item.MtlItemNo
                                                                , TB001 = TA001
                                                                , TB002 = TA002
                                                                , TB003 = (Sequence+1).ToString("D4")
                                                                , TB004 = item.NewMtlItemNo
                                                                , TB005 = item2.MB002
                                                                , TB006 = item2.MB003
                                                                , TB007 = Convert.ToDouble(item3.MC007)
                                                                , TB008 = item2.MB004
                                                                , TB010 = Convert.ToDouble(item2.LB010)
                                                                , TB011 = Convert.ToDouble(item3.MC007) * Convert.ToDouble(item2.LB010)
                                                                , TB012 = item3.MC002
                                                                , TB018 = "N"
                                                                , TB019 = dateNow
                                                                , TB022 = 0
                                                                , TB024 = "N"
                                                                , TB025 = 0
                                                                , TB028 = 0
                                                                , TB029 = 0
                                                    }
                                                };
                                                AdjustmentLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:開立舊品號調減單({TA001 + "-" + TA002 + "-" + (Sequence).ToString("D4")})，庫別{item3.MC002}庫存{Convert.ToDouble(item3.MC007) * -1}");
                                                AdjustmentLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:開立新品號調增單({TA001 + "-" + TA002 + "-" + (Sequence + 1).ToString("D4")})，庫別{item3.MC002}庫存{Convert.ToDouble(item3.MC007)}");

                                                item.ReturnMsg += $"舊品號調減單:{TA001}-{TA002}-{Sequence.ToString("D4")};";
                                                item.ReturnMsg += $"新品號調減單:{TA001}-{TA002}-{(Sequence + 1).ToString("D4")};";

                                                invtbAdd.AddRange(newDataTB);
                                                Sequence = Sequence + 2;
                                            }
                                            item.Adjustment = "O";
                                            #endregion
                                        }
                                        else
                                        {
                                            item.Adjustment = "O";
                                            item.ReturnMsg += $"舊品號無庫存不需要開庫存調整單;";

                                        }
                                    }
                                }
                            }
                            else
                            {
                                item.TransferStatus = "E";
                                item.Adjustment = "S";
                                item.ReturnMsg = $"品號不存在,屬於異常不做任何動作";
                                ErrLog.Add($"{item.MtlItemNo}:{item.NewMtlItemNo}:舊品號不存在,屬於異常不做任何動作");
                            }
                            #endregion

                        });
                        #endregion

                        #region //篩選出要失效舊品號
                        List<MtlItemReference> ExpiredList = reference
                        .Where(s => s.Adjustment == "O")
                        .ToList(); // 每組選取第一個元素
                        #endregion

                        #region //篩選出要拋轉ERP新品號
                        List<MtlItemReference> NewMtlItemAddErp = reference
                        .Where(s => s.TransferStatus == "N" && !string.IsNullOrEmpty(s.NewMtlItemNo))  // 篩選 TransferStatus = "N" 且 NewMtlItemNo 不為空或 null
                        .ToList();  // 轉換為 List
                        #endregion

                        #region //新增段
                        #region //新品號新增
                        if (NewMtlItemAddErp.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = $@"INSERT INTO INVMB
                                     SELECT 
                                     COMPANY, CREATOR, USR_GROUP,@CREATE_DATE CREATE_DATE, MODIFIER, MODI_DATE,1 FLAG,@CREATE_TIME CREATE_TIME, 
                                     @CREATE_AP CREATE_AP,'BM' CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID,@NewMtlItemNo MB001,@NewMtlItemName MB002,@NewMtlItemSpec MB003, MB004, MB005, MB006, 
                                     MB007, MB008, MB009, MB010, MB011, MB012, MB013, MB014, MB015, MB016, MB017, MB018, MB019, MB020, 
                                     MB021, MB022, MB023, MB024, MB025, MB026, MB027, MB028, MB029, MB030, MB031, MB032, MB033, MB034, 
                                     MB035, MB036, MB037, MB038, MB039, MB040, MB041, MB042, MB043, MB044, MB045, MB046, MB047, MB048, 
                                     MB049, MB050, MB051, MB052, MB053, MB054, MB055, MB056, MB057, MB058, MB059, MB060, MB061, MB062, 
                                     MB063, 0 MB064,0 MB065, MB066, MB067, MB068, MB069, MB070, MB071, MB072, MB073, MB074, MB075, MB076, 
                                     MB077, MB078, MB079, MB080, MB081, MB082, MB083, MB084, MB085, MB086, MB087, MB088, MB089, MB090, 
                                     MB091, MB092, MB093, MB094, MB095, MB096, MB097, MB098, MB099, MB100, MB101, MB102, MB103, MB104, 
                                     MB105, MB106, MB107, MB108, MB109, MB110, MB111, MB112, MB113, MB114, MB115, MB116, MB117, MB118, 
                                     MB119, MB120, MB121, MB122, MB123, MB124, MB125, MB126, MB127, MB128, MB129, MB130, MB131, MB132, 
                                     MB133, MB134, MB135, MB136, MB137, MB138, MB139, MB140, MB141, MB142, MB143, MB144, MB145, MB146, 
                                     MB147, MB148, MB149, MB150, MB151, MB152, MB153, MB154, MB155, MB156, MB157, MB158, MB159, MB160, 
                                     MB161, MB162, MB163, MB164, MB165, MB166, MB167, MB168, MB169, MB170, MB171, MB172, MB173, MB174, 
                                     MB175, MB176, MB177, MB178, MB179, MB180, MB181, MB182, MB183, MB184, MB185, MB186, MB187, MB188, 
                                     MB189, MB190, MB191, MB192, MB193, MB194, MB500, MB501, MB502, MB503, MB504, MB545, MB550, MB551, 
                                     MB552, MB553, MB554, UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10, MB195, 
                                     MB196, MB197, MB198, MB199, MB505, MB506, MB507, MB508, MB509, MB510, MB511, MB512, MB513, MB514, 
                                     MB515, MB516, MB517, MB518, MB519, MB520, MB521, MB522
                                     FROM INVMB WHERE MB001 = @MtlItemNo;
                                     INSERT INTO INVMO
                                     SELECT 
                                     COMPANY, CREATOR, USR_GROUP,@CREATE_DATE CREATE_DATE, MODIFIER, MODI_DATE,1 FLAG,@CREATE_TIME CREATE_TIME, 
                                     @CREATE_AP CREATE_AP,'BM' CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID,@NewMtlItemNo MO001, @NewMtlItemName MO002, @NewMtlItemSpec MO003, MO004, MO005, MO006, 
                                     MO007, MO008, MO009, MO010, MO011, MO012, MO013, MO014, MO015, MO016, MO017, MO018, MO019, MO020, 
                                     MO021, MO022, MO023, MO024, MO025, MO026, MO027, MO028, MO029, MO030, MO031, MO032, MO033, MO034, 
                                     MO035, MO036, MO037, MO038, MO039, MO040, MO041, MO042, MO043, MO044, MO045, MO046, MO047, MO048, 
                                     MO049, MO050, MO051, MO052, MO053, MO054, MO055, MO056, MO057, MO058, MO059, MO060, MO061, MO062, 
                                     MO063, MO064, MO065, MO066, MO067, MO068, MO069, MO070, MO071, MO072, MO073, MO074, MO075, MO076, 
                                     MO077, MO078, MO079, MO080, MO081, MO082, MO083, MO084, MO085, MO086, MO087, MO088, MO089, MO090, 
                                     MO091, MO092, MO093, MO094, MO095, MO096, MO097, MO098, MO099, MO100, MO101, MO102, MO103, MO104, 
                                     MO105, MO106, MO107, MO108, MO109, MO110, MO111, MO112, MO113, MO114, MO115, MO116, MO117, MO118, 
                                     MO119, MO120, MO121, MO122, MO123, MO124, MO125, MO126, MO127, MO128, MO129, MO130, MO131, MO132, 
                                     MO133, MO134, MO135, MO136, MO137, MO138, MO139, MO140, MO141, MO142, MO143, MO144, MO145, MO146, 
                                     MO147, MO148, MO149, MO150, MO151, MO152, MO153, MO154, MO155, MO156, MO157, MO158, MO159, MO160, 
                                     MO161, MO162, MO163, MO164, MO165, MO166, MO167, MO168, MO169, MO170, MO171, MO500, MO501, MO502, 
                                     MO503, MO504, MO545, MO550, MO551, MO552, MO553, MO554, MO172, MO173, MO174, MO175, MO176, MO177, 
                                     MO178, MO179, MO180, MO181, MO182, MO183, MO184, MO185, MO186, MO187, MO188, MO189, MO190, MO191, 
                                     MO192, MO193, MO194, MO195, MO196, UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, 
                                     UDF10, MO198, MO199, MO505, MO506, MO197, MO507, MO508
                                     FROM INVMO WHERE MO001 = @MtlItemNo;
                                     ";
                            rowsAffected += sqlConnection.Execute(sql, NewMtlItemAddErp);
                        }
                        #endregion

                        #region //庫存異動單新增
                        if (invtbAdd.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = $@"INSERT INTO INVTA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                    CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID,
                                    UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                    TA001, TA002, TA003, TA004, TA005, TA006, TA007, 
                                    TA008, TA009, TA010, TA011, TA012, TA013, TA014, TA015, TA016, TA017, TA018, TA019, TA020, TA021, TA022, 
                                    TA023, TA024, TA025, TA026, TA027, TA028
                                    )
                                    VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
                                    @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, 
                                    '','','','','',0,0,0,0,0,
                                    @TA001, @TA002, @TA003, @TA004, @TA005, @TA006, @TA007, 
                                    @TA008, @TA009, @TA010, @TA011, @TA012, @TA013, @TA014, @TA015, @TA016, @TA017, @TA018, @TA019, @TA020, @TA021, @TA022, 
                                    @TA023, @TA024, @TA025, @TA026, @TA027, @TA028)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    COMPANY = MESCompanyNo,
                                    CREATOR = UserNo,
                                    USR_GROUP,
                                    CREATE_DATE = dateNow,
                                    MODIFIER = "",
                                    MODI_DATE = "",
                                    FLAG = 1,
                                    CREATE_TIME = timeNow,
                                    CREATE_AP = BaseHelper.ClientComputer(),
                                    CREATE_PRID = "BM",
                                    MODI_TIME = "",
                                    MODI_AP = "",
                                    MODI_PRID = "",
                                    CFIELD01,
                                    TA001,
                                    TA002,
                                    TA003 = dateNow,
                                    TA004,
                                    TA005,
                                    TA006 = "N",
                                    TA007 = 0,
                                    TA008,
                                    TA009,
                                    TA010 = 0,
                                    TA011 = 0,
                                    TA012 = 0,
                                    TA013 = "N",
                                    TA014 = dateNow,
                                    TA015 = "",
                                    TA016 = 0,
                                    TA017 = "N",
                                    TA018 = 0,
                                    TA019 = 0,
                                    TA020 = "",
                                    TA021 = "",
                                    TA022 = "",
                                    TA023 = 0,
                                    TA024 = 0,
                                    TA025 = "",
                                    TA026 = "",
                                    TA027 = "",
                                    TA028 = ""
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            #region //庫存異動單-單身新增

                            dynamicParameters = new DynamicParameters();
                            sql = $@"INSERT INTO INVTB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID,
                                UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
							    TB001, TB002, TB003, TB004, TB005, TB006, 
                                TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB014, TB015, TB016, TB017, TB018, TB019, TB020, TB021, 
                                TB022, TB023, TB024, TB025, TB026, TB027, TB028, TB029, TB030, TB031, TB032, TB500, TB501, TB502)
                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME,
                                @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID,
                                '','','','','',0,0,0,0,0,
                                @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, 
                                @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014, @TB015, @TB016, @TB017, @TB018, @TB019, @TB020, @TB021, 
                                @TB022, @TB023, @TB024, @TB025, @TB026, @TB027, @TB028, @TB029, @TB030, @TB031, @TB032, @TB500, @TB501, @TB502)";
                            rowsAffected += sqlConnection.Execute(sql, invtbAdd);
                            #endregion
                        }
                        #endregion

                        #region //舊品號失效
                        if (ExpiredList.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVMB SET
                                MB031 = @CREATE_DATE
                                WHERE MB001 = @MtlItemNo";
                            rowsAffected += sqlConnection.Execute(sql, ExpiredList);
                        }

                        #endregion

                        #endregion

                        #region //Log記錄
                        var MsgLog = new
                        {
                            ActionLogs = ActionLog,
                            TransferLogs = TransferLog,
                            AdjustmentLogs = AdjustmentLog,
                            ErrLogs = ErrLog
                        };
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            data = MsgLog
                        });
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //更新對照表狀態
                        sql = @"UPDATE PDM.MtlItemNoIntegration SET
                                Adjustment = @Adjustment,
                                ReturnMsg = @ReturnMsg
                                WHERE MtlItemId = @MtlItemId
                                AND NewMtlItemNo = @NewMtlItemNo";
                        rowsAffected += sqlConnection.Execute(sql, reference);
                        #endregion

                        #region //更新對照表狀態
                        if (invtbAdd.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItem SET
                                ExpirationDate = @ExpirationDate
                                WHERE MtlItemId = @MtlItemId";
                            rowsAffected += sqlConnection.Execute(sql, reference);
                        }
                        
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        

        #endregion

        #region //UpdateInventoryTransactionToErp -- 新舊品號異動單拋轉ERP -- Shintokuro 2024.12.27
        public string UpdateInventoryTransactionToErp(string NewMtlItemList = "")
        {
            try
            {
                string dateNow = CreateDate.ToString("yyyyMMdd"), timeNow = CreateDate.ToString("HH:mm:ss");
                string departmentNo = "", MESCompanyNo = "", userNo = "", userName = "", userGroup = "";
                int rowsAffected = 0;

                List<MtlItemReference> reference = new List<MtlItemReference>();
                List<INVTA> invtaAdd = new List<INVTA>();
                List<INVTB> invtbAdd = new List<INVTB>();

                using (TransactionScope transactionScope = new TransactionScope())
                {

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb,ErpNo,x.JMOErp,x.DGErp,x.ETGErp
                                FROM BAS.Company
                                OUTER APPLY(
                                    SELECT 
                                        MAX(CASE WHEN CompanyId = 2 THEN ErpDb END) AS JMOErp,
                                        MAX(CASE WHEN CompanyId = 3 THEN ErpDb END) AS ETGErp,
                                        MAX(CASE WHEN CompanyId = 4 THEN ErpDb END) AS DGErp
                                    FROM BAS.Company
                                ) x
                                WHERE CompanyId = @CompanyId";
                        dynamicParameters.Add("CompanyId", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                            MESCompanyNo = item.ErpNo;
                        }
                        #endregion

                        #region //使用者資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 d.UserNo, d.UserName, d.DepartmentNo
                                FROM BAS.FunctionDetail a
                                INNER JOIN BAS.[Function] b ON a.FunctionId = b.FunctionId
                                OUTER APPLY (
                                    SELECT ISNULL((
                                        SELECT TOP 1 1
                                        FROM BAS.RoleFunctionDetail ca
                                        WHERE ca.DetailId = a.DetailId
                                        AND ca.RoleId IN (
                                            SELECT caa.RoleId
                                            FROM BAS.UserRole caa
                                            INNER JOIN BAS.[Role] cab ON caa.RoleId = cab.RoleId
                                            WHERE caa.UserId = @UserId
                                            AND cab.CompanyId = @CompanyId
                                        )
                                    ), 0) Authority
                                ) c
                                OUTER APPLY (
                                    SELECT da.UserNo, da.UserName, db.DepartmentNo
                                    FROM BAS.[User] da
                                    INNER JOIN BAS.Department db ON da.DepartmentId = db.DepartmentId
                                    WHERE da.UserId = @UserId
                                ) d
                                WHERE a.[Status] = @Status
                                AND b.[Status] = @Status
                                AND b.FunctionCode = @FunctionCode
                                AND a.DetailCode = @DetailCode
                                AND c.Authority > 0";
                        dynamicParameters.Add("UserId", CurrentUser);
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        dynamicParameters.Add("Status", "A");
                        dynamicParameters.Add("FunctionCode", "MtlItemNoIntegration");
                        dynamicParameters.Add("DetailCode", "read");

                        var resultUser = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUser.Count() <= 0) throw new SystemException("使用者資料錯誤!");

                        foreach (var item in resultUser)
                        {
                            userNo = item.UserNo;
                            userName = item.UserName;
                            departmentNo = item.DepartmentNo;
                        }
                        #endregion

                        #region //撈取欲異動品號
                        //新品號已經存在,就採用新品號版本的品名規格,
                        //如果新品號不存在,需要判斷當前是否有多個版本,沒有才能採用當前的,如果當前沒填寫採用當前舊版

                        dynamicParameters = new DynamicParameters();
                        sql = $@"SELECT a.MtlItemId,b.MtlItemNo,a.NewMtlItemNo,a.NewMtlItemName,a.NewMtlItemSpec,a.Adjustment,
                                (
                                    SELECT CASE WHEN COUNT(*) = 1 THEN 'Y' ELSE 'N' END AS  OnlyVersion
                                    FROM(
                                        SELECT  DISTINCT x1.NewMtlItemNo, x1.NewMtlItemName, x1.NewMtlItemSpec
                                        FROM PDM.MtlItemNoIntegration x1
                                        WHERE x1.NewMtlItemNo = a.NewMtlItemNo
                                    ) a
                                ) OnlyVersion,
                                (
                                    SELECT CASE WHEN COUNT(*) >1 THEN 'Y' ELSE 'N' END
                                    FROM PDM.MtlItemNoIntegration x2
                                    WHERE x2.NewMtlItemNo = a.NewMtlItemNo
                                    {(NewMtlItemList.Length > 0 ? $"AND x2.MtlItemId IN ({NewMtlItemList})" : "")}
                                ) ManyToOne
                                FROM PDM.MtlItemNoIntegration a
                                INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                WHERE b.CompanyId = @CompanyId
                                AND a.Adjustment != 'O'";
                        dynamicParameters.Add("CompanyId", CurrentCompany);
                        if (NewMtlItemList.Length > 0) BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "NewMtlItemList", @" AND a.MtlItemId IN @NewMtlItemList", NewMtlItemList.Split(','));

                        reference = sqlConnection.Query<MtlItemReference>(sql, dynamicParameters).ToList();
                        #endregion

                        if (reference.Count() <= 0) throw new SystemException("目前無可異動的新舊品號!!");

                    }
                    
                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //ERP公司代碼取得
                        string ERPCompanyNo = "";
                        string FactoryCode = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ML001  ,
                                (SELECT TOP 1 MB001 FROM CMSMB) FactoryCode
                                FROM CMSML";
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in result)
                        {
                            ERPCompanyNo = item.ML001;
                            FactoryCode = item.FactoryCode;
                        }
                        if (MESCompanyNo != ERPCompanyNo) throw new SystemException("ERP的公司代碼與MES的公司代碼不同，請嘗試重新登入!!");
                        #endregion

                        #region //判斷ERP使用者是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MF005
                                        FROM ADMMF
                                        WHERE COMPANY = @CompanyNo
                                        AND MF001 = @userNo";
                        dynamicParameters.Add("CompanyNo", ERPCompanyNo);
                        dynamicParameters.Add("userNo", userNo);
                        var resultUserExist = sqlConnection.Query(sql, dynamicParameters);
                        if (resultUserExist.Count() <= 0) throw new SystemException("【ERP使用者】不存在!");
                        #endregion

                        #region //審核ERP權限-建立
                        var USR_GROUP = BaseHelper.CheckErpAuthority(userNo, sqlConnection, "COPI08", "CREATE");
                        #endregion

                        #region //庫存異動單設定
                        string TA001 = "1108"; //單別
                        string TA002 = ""; //單號
                        int Sequence = 1;
                        string TA004 = "A751"; //部門代號 系統開發室
                        string TA005 = "系統建立新舊品號庫存移轉用"; //部門代號 系統開發室
                        string TA008 = FactoryCode; //廠別代號
                        string TA009 = ""; //單據性質碼
                        double TA011 = 0, TA012 = 0; //總數量,總金額 因為正和負會開一起,故理論上 兩個數值都是0
                        string CFIELD01 = "";
                        #region //撈取ERP單據設定
                        DateTime referenceTime = default(DateTime);
                        referenceTime = DateTime.ParseExact(dateNow, "yyyyMMdd", CultureInfo.InvariantCulture);


                        string WoType = ""; //自動產生發票號碼
                        string encode = ""; // 編碼格式
                        int yearLength = 0; // 年碼數
                        int lineLength = 0; // 流水碼數
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MQ004, a.MQ005, a.MQ006, a.MQ044, a.MQ017,a.MQ003
                                FROM CMSMQ a
                                WHERE MQ001 = @TA001";
                        dynamicParameters.Add("TA001", TA001);
                        var resultReceiptNo = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in resultReceiptNo)
                        {
                            encode = item.MQ004; //編碼方式
                            yearLength = Convert.ToInt32(item.MQ005); //年碼數
                            lineLength = Convert.ToInt32(item.MQ006); //流水號碼數
                            WoType = item.MQ017;
                            TA009 = item.MQ003;
                        }
                        #endregion

                        #region //單號自動取號
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT CONVERT(int, RIGHT(ISNULL(MAX(RTRIM(LTRIM(TA002))), '" + new string('0', lineLength) + @"'), " + lineLength + @")) + 1 CurrentNum
                                FROM INVTA
                                WHERE TA001 = @TA001";
                        dynamicParameters.Add("TA001", TA001);


                        #region //編碼格式相關
                        string dateFormat = "";
                        switch (encode)
                        {
                            case "1": //日編
                                if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                if ((lineLength + yearLength + 4) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                dateFormat = new string('y', yearLength) + "MMdd";
                                sql += @" AND RTRIM(LTRIM(TA002)) LIKE @ReferenceTime  + '" + new string('_', lineLength) + @"'";
                                //sql += @" AND TH002 LIKE '%' + @ReferenceTime + '%' + '" + new string('_', lineLength) + @"'";
                                dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));

                                string tedstNo = referenceTime.ToString(dateFormat);
                                TA002 = referenceTime.ToString(dateFormat);
                                break;
                            case "2": //月編
                                if (yearLength < 0 || yearLength > 4) throw new SystemException("【ERP單據性質】年碼數不能小於等於0或大於4");
                                if ((lineLength + yearLength + 2) > 11) throw new SystemException("【ERP單據性質】編碼格式碼數不能大於11碼");
                                dateFormat = new string('y', yearLength) + "MM";
                                sql += @" AND RTRIM(LTRIM(TA002))  LIKE @ReferenceTime + '" + new string('_', lineLength) + @"'";
                                dynamicParameters.Add("ReferenceTime", referenceTime.ToString(dateFormat));
                                TA002 = referenceTime.ToString(dateFormat);
                                break;
                            case "3": //流水號
                                if (yearLength == 0) throw new SystemException("【ERP單據性質】年碼數必須等於0");
                                if (lineLength <= 0 || lineLength > 11) throw new SystemException("【ERP單據性質】流水編碼碼數必須大於0小於等於11");
                                break;
                            case "4": //手動編號
                                break;
                            default:
                                throw new SystemException("編碼方式錯誤!");
                        }
                        int currentNum = sqlConnection.QueryFirstOrDefault(sql, dynamicParameters).CurrentNum;
                        TA002 += string.Format("{0:" + new string('0', lineLength) + "}", currentNum);
                        CFIELD01 = TA001 + '-' + TA002;
                        #endregion

                        #endregion

                        #endregion

                        #region //判斷新舊品號ERP是否存在INVMB
                        reference.ForEach(item =>
                        {
                            item.ExpirationDate = CreateDate;
                            item.CREATE_DATE = dateNow;
                            item.CREATE_TIME = timeNow;
                            item.CREATE_AP = BaseHelper.ClientComputer();

                            #region //判斷新舊品號ERP是否存在INVMB
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT
                                    ISNULL((SELECT 
                                        LTRIM(RTRIM(x1.MC002)) MC002,
                                        LTRIM(RTRIM(x1.MC007)) MC007
                                        FROM INVMC x1
                                        WHERE x1.MC001 = a.MB001
                                        AND x1.MC007 > 0
                                        ORDER BY x1.MC002
                                        FOR XML PATH('MCDetail')),'') AS MCDetails
                                        ,a.MB002,a.MB003,a.MB004
                                        ,b.LB002,b.LB001,ISNULL(b.LB010,0) LB010
                                        ,ISNULL(c.NewMtlItemNo,'') NewMtlItemNo,c.NewMtlItemName,c.NewMtlItemSpec
                                    FROM INVMB a
                                    OUTER APPLY(
                                        SELECT TOP 1 x1.LB002,x1.LB001,x1.LB010
                                        FROM INVLB x1
                                        WHERE x1.LB001 = a.MB001
                                        ORDER BY x1.LB002 DESC
                                    ) b
                                    OUTER APPLY(
                                        SELECT MB001 NewMtlItemNo,MB002 NewMtlItemName,MB003 NewMtlItemSpec
                                        FROM INVMB 
                                        WHERE MB001 = @NewMtlItemNo
                                    ) c
                                    WHERE a.MB001 = @MtlItemNo";
                            dynamicParameters.Add("MtlItemNo", item.MtlItemNo);
                            dynamicParameters.Add("NewMtlItemNo", item.NewMtlItemNo);

                            result = sqlConnection.Query(sql, dynamicParameters);
                            if (result.Count() > 0)
                            {
                                foreach (var item2 in result)
                                {
                                    if (item2.NewMtlItemNo != "")
                                    {
                                        if (item.Adjustment == "S")
                                        {
                                            item.Adjustment = "N";
                                        }
                                    }
                                    else
                                    {
                                        #region //Log記錄
                                        item.TransferStatus = "E";
                                        item.Adjustment = "S";
                                        item.ReturnMsg = $"必須新舊品號都存在才能做庫存移轉!!";
                                        #endregion
                                    }
                                                                                                           
                                    if (item.Adjustment == "N")
                                    {
                                        if (item2.MCDetails != "")
                                        {
                                            #region //解析品號庫別
                                            XDocument doc = XDocument.Parse("<MCDetails>" + item2.MCDetails + "</MCDetails>");  // 包裝根節點

                                            var mcDetails = doc.Descendants("MCDetail")
                                                               .Select(x => new
                                                               {
                                                                   MC002 = x.Element("MC002")?.Value,
                                                                   MC007 = x.Element("MC007")?.Value
                                                               });
                                            #endregion

                                            #region //欲做庫存異動的新舊品號清單
                                            foreach (var item3 in mcDetails)
                                            {

                                                List<INVTB> newDataTB = new List<INVTB>
                                                {
                                                    new INVTB {
                                                                  COMPANY = MESCompanyNo
                                                                , CREATOR = UserNo
                                                                , USR_GROUP = USR_GROUP.ToString()
                                                                , CREATE_DATE = dateNow
                                                                , MODIFIER = ""
                                                                , MODI_DATE = ""
                                                                , FLAG = "1"
                                                                , CREATE_TIME = timeNow
                                                                , CREATE_AP = BaseHelper.ClientComputer()
                                                                , CREATE_PRID = "BM"
                                                                , MtlItemNo = item.MtlItemNo
                                                                , TB001 = TA001
                                                                , TB002 = TA002
                                                                , TB003 = Sequence.ToString("D4")
                                                                , TB004 = item.MtlItemNo
                                                                , TB005 = item2.MB002
                                                                , TB006 = item2.MB003
                                                                , TB007 = Convert.ToDouble(item3.MC007) * -1
                                                                , TB008 = item2.MB004
                                                                , TB010 = Convert.ToDouble(item2.LB010)
                                                                , TB011 = Convert.ToDouble(item3.MC007) * -1 * Convert.ToDouble(item2.LB010)
                                                                , TB012 = item3.MC002
                                                                , TB018 = "N"
                                                                , TB019 = dateNow
                                                                , TB022 = 0
                                                                , TB024 = "N"
                                                                , TB025 = 0
                                                                , TB028 = 0
                                                                , TB029 = 0
                                                    },
                                                    new INVTB {
                                                                 COMPANY = MESCompanyNo
                                                                , CREATOR = UserNo
                                                                , USR_GROUP = USR_GROUP.ToString()
                                                                , CREATE_DATE = dateNow
                                                                , MODIFIER = ""
                                                                , MODI_DATE = ""
                                                                , FLAG = "1"
                                                                , CREATE_TIME = timeNow
                                                                , CREATE_AP = BaseHelper.ClientComputer()
                                                                , CREATE_PRID = "BM"
                                                                , MtlItemNo = item.MtlItemNo
                                                                , TB001 = TA001
                                                                , TB002 = TA002
                                                                , TB003 = (Sequence+1).ToString("D4")
                                                                , TB004 = item.NewMtlItemNo
                                                                , TB005 = item2.NewMtlItemName
                                                                , TB006 = item2.NewMtlItemSpec
                                                                , TB007 = Convert.ToDouble(item3.MC007)
                                                                , TB008 = item2.MB004
                                                                , TB010 = Convert.ToDouble(item2.LB010)
                                                                , TB011 = Convert.ToDouble(item3.MC007) * Convert.ToDouble(item2.LB010)
                                                                , TB012 = item3.MC002
                                                                , TB018 = "N"
                                                                , TB019 = dateNow
                                                                , TB022 = 0
                                                                , TB024 = "N"
                                                                , TB025 = 0
                                                                , TB028 = 0
                                                                , TB029 = 0
                                                    }
                                                };

                                                item.ReturnMsg += $"舊品號調減單:{TA001}-{TA002}-{Sequence.ToString("D4")};";
                                                item.ReturnMsg += $"新品號調減單:{TA001}-{TA002}-{(Sequence+1).ToString("D4")};";

                                                invtbAdd.AddRange(newDataTB);
                                                Sequence = Sequence + 2;
                                            }
                                            item.Adjustment = "O";
                                            #endregion
                                        }
                                        else
                                        {
                                            item.Adjustment = "O";
                                        }
                                    }
                                }
                            }
                            else
                            {
                                item.TransferStatus = "E";
                                item.Adjustment = "S";
                                item.ReturnMsg = $"舊品號不存在,屬於異常不做任何動作";
                            }
                            #endregion

                        });
                        #endregion

                        #region //篩選出要失效舊品號
                        List<MtlItemReference> ExpiredList = reference
                        .Where(s => s.Adjustment == "O")
                        .ToList(); // 每組選取第一個元素
                        #endregion

                        #region //新增段

                        #region //庫存異動單新增
                        if (invtbAdd.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = $@"INSERT INTO INVTA (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                    CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID,
                                    UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
                                    TA001, TA002, TA003, TA004, TA005, TA006, TA007, 
                                    TA008, TA009, TA010, TA011, TA012, TA013, TA014, TA015, TA016, TA017, TA018, TA019, TA020, TA021, TA022, 
                                    TA023, TA024, TA025, TA026, TA027, TA028
                                    )
                                    VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME, 
                                    @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID, 
                                    '','','','','',0,0,0,0,0,
                                    @TA001, @TA002, @TA003, @TA004, @TA005, @TA006, @TA007, 
                                    @TA008, @TA009, @TA010, @TA011, @TA012, @TA013, @TA014, @TA015, @TA016, @TA017, @TA018, @TA019, @TA020, @TA021, @TA022, 
                                    @TA023, @TA024, @TA025, @TA026, @TA027, @TA028)";
                            dynamicParameters.AddDynamicParams(
                                new
                                {
                                    COMPANY = MESCompanyNo,
                                    CREATOR = UserNo,
                                    USR_GROUP,
                                    CREATE_DATE = dateNow,
                                    MODIFIER = "",
                                    MODI_DATE = "",
                                    FLAG = 1,
                                    CREATE_TIME = timeNow,
                                    CREATE_AP = BaseHelper.ClientComputer(),
                                    CREATE_PRID = "BM",
                                    MODI_TIME = "",
                                    MODI_AP = "",
                                    MODI_PRID = "",
                                    CFIELD01,
                                    TA001,
                                    TA002,
                                    TA003 = dateNow,
                                    TA004,
                                    TA005,
                                    TA006 = "N",
                                    TA007 = 0,
                                    TA008,
                                    TA009,
                                    TA010 = 0,
                                    TA011 = 0,
                                    TA012 = 0,
                                    TA013 = "N",
                                    TA014 = dateNow,
                                    TA015 = "",
                                    TA016 = 0,
                                    TA017 = "N",
                                    TA018 = 0,
                                    TA019 = 0,
                                    TA020 = "",
                                    TA021 = "",
                                    TA022 = "",
                                    TA023 = 0,
                                    TA024 = 0,
                                    TA025 = "",
                                    TA026 = "",
                                    TA027 = "",
                                    TA028 = ""
                                });
                            rowsAffected += sqlConnection.Execute(sql, dynamicParameters);

                            #region //庫存異動單-單身新增

                            dynamicParameters = new DynamicParameters();
                            sql = $@"INSERT INTO INVTB (COMPANY, CREATOR, USR_GROUP, CREATE_DATE, MODIFIER, MODI_DATE, FLAG, CREATE_TIME, 
                                CREATE_AP, CREATE_PRID, MODI_TIME, MODI_AP, MODI_PRID,
                                UDF01, UDF02, UDF03, UDF04, UDF05, UDF06, UDF07, UDF08, UDF09, UDF10,
							    TB001, TB002, TB003, TB004, TB005, TB006, 
                                TB007, TB008, TB009, TB010, TB011, TB012, TB013, TB014, TB015, TB016, TB017, TB018, TB019, TB020, TB021, 
                                TB022, TB023, TB024, TB025, TB026, TB027, TB028, TB029, TB030, TB031, TB032, TB500, TB501, TB502)
                                VALUES (@COMPANY, @CREATOR, @USR_GROUP, @CREATE_DATE, @MODIFIER, @MODI_DATE, @FLAG, @CREATE_TIME,
                                @CREATE_AP, @CREATE_PRID, @MODI_TIME, @MODI_AP, @MODI_PRID,
                                '','','','','',0,0,0,0,0,
                                @TB001, @TB002, @TB003, @TB004, @TB005, @TB006, 
                                @TB007, @TB008, @TB009, @TB010, @TB011, @TB012, @TB013, @TB014, @TB015, @TB016, @TB017, @TB018, @TB019, @TB020, @TB021, 
                                @TB022, @TB023, @TB024, @TB025, @TB026, @TB027, @TB028, @TB029, @TB030, @TB031, @TB032, @TB500, @TB501, @TB502)";
                            rowsAffected += sqlConnection.Execute(sql, invtbAdd);
                            #endregion
                        }
                        #endregion

                        #region //舊品號失效
                        if (ExpiredList.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE INVMB SET
                                MB031 = @CREATE_DATE
                                WHERE MB001 = @MtlItemNo";
                            rowsAffected += sqlConnection.Execute(sql, ExpiredList);
                        }

                        #endregion

                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {

                        #region //更新對照表狀態
                        sql = @"UPDATE PDM.MtlItemNoIntegration SET
                                Adjustment = @Adjustment,
                                ReturnMsg = @ReturnMsg
                                WHERE MtlItemId = @MtlItemId
                                AND NewMtlItemNo = @NewMtlItemNo";
                        rowsAffected += sqlConnection.Execute(sql, reference);
                        #endregion

                        #region //更新對照表狀態
                        if (invtbAdd.Count() > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.MtlItem SET
                                ExpirationDate = @ExpirationDate
                                WHERE MtlItemId = @MtlItemId";
                            rowsAffected += sqlConnection.Execute(sql, reference);
                        }
                        #endregion
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + rowsAffected + " rows affected)"
                    });
                    #endregion

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion


        #endregion

        #region //Delete


        #region//DeleteMtlItemSynchronize -- 品號異動刪除 --Ding 2023.06.01
        public string DeleteMtlItemSynchronize(string CompanyNo, string UpdateDate)
        {
            try
            {
                if (CompanyNo.Length <= 0) throw new SystemException("【公司】不能為空!");
                int mainAffected = 0;
                int run = 0; //是否執行異動刪除  0:不執行 1:執行
                #region//MES品號異動同步                       
                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
                {
                    int CompanyId = -1;
                    string ErpConnectionStrings = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", CompanyNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        using (SqlConnection sqlErpConnection = new SqlConnection(ErpConnectionStrings))
                        {

                            #region//ERP品號資料
                            sql = @"SELECT LTRIM(RTRIM(a.MB001)) MtlItemNo 
                                FROM INVMB a
                                WHERE 1=1
                                AND LTRIM(RTRIM(a.MB001)) NOT IN ('3A12L84N-L1(2)', '3FMHD（GM1557）-PGM', '2A8CAV-D16MR-3.0-LBX-103-M')";
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + a.CREATE_TIME > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                            sql += @" ORDER BY TransferDate, TransferTime";
                            var resultErpMtl = sqlErpConnection.Query<MtlItem>(sql, dynamicParameters);
                            #endregion

                            #region//MES品號資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemNo
                                    FROM PDM.MtlItem
                                    WHERE CompanyId = @CompanyId";
                            dynamicParameters.Add("CompanyId", CompanyId);
                            var resultBmMtl = sqlConnection.Query<MtlItem>(sql, dynamicParameters);
                            #endregion

                            #region//篩選ERP不存在但MES還存在的品號
                            var dictionaryErpMtl = resultErpMtl.ToDictionary(x => x.MtlItemNo, x => x.MtlItemNo);
                            var dictionaryBmMtl = resultBmMtl.ToDictionary(x => x.MtlItemNo, x => x.MtlItemNo);
                            var change = dictionaryBmMtl.Where(x => !dictionaryErpMtl.ContainsKey(x.Key)).ToList();
                            var changeList = change.Select(x => x.Value).ToList();
                            mainAffected = changeList.Count;
                            #endregion

                            if (run == 1)
                            {
                                if (changeList.Count > 0)
                                {
                                    int RdFile = 0, RdAttribute = 0, RdControl = 0, Rd = 0;
                                    int BomSub = 0, BomDetail = 0, Bom = 0;

                                    #region//刪除 研發設計圖系統 其他類檔案(非設計圖檔)
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.RdDesignControlFile
                                            WHERE ControlId IN (
                                                SELECT c.ControlId
                                                 FROM PDM.MtlItem a 
                                                 INNER JOIN PDM.RdDesign b On a.MtlItemId =b.MtlItemId
                                                 INNER JOIN PDM.RdDesignControl c ON b.DesignId=c.DesignId
                                                 LEFT JOIN PDM.RdDesignControlFile d ON c.ControlId=d.ControlId
                                                 LEFT JOIN PDM.RdDesignAttribute e ON d.ControlId=e.ControlId
                                                 WHERE a.MtlItemNo IN @MtlItemNo
                                            )";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    RdFile += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 研發設計基本資料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.RdDesignAttribute
                                            WHERE ControlId IN (
                                                SELECT c.ControlId
                                                 FROM PDM.MtlItem a 
                                                 INNER JOIN PDM.RdDesign b On a.MtlItemId =b.MtlItemId
                                                 INNER JOIN PDM.RdDesignControl c ON b.DesignId=c.DesignId
                                                 LEFT JOIN PDM.RdDesignControlFile d ON c.ControlId=d.ControlId
                                                 LEFT JOIN PDM.RdDesignAttribute e ON d.ControlId=e.ControlId
                                                 WHERE a.MtlItemNo IN @MtlItemNo
                                            )";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    RdAttribute += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 研發設計圖版本控制
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.RdDesignControl
                                            WHERE ControlId IN (
                                                SELECT c.ControlId
                                                 FROM PDM.MtlItem a 
                                                 INNER JOIN PDM.RdDesign b On a.MtlItemId =b.MtlItemId
                                                 INNER JOIN PDM.RdDesignControl c ON b.DesignId=c.DesignId
                                                 LEFT JOIN PDM.RdDesignControlFile d ON c.ControlId=d.ControlId
                                                 LEFT JOIN PDM.RdDesignAttribute e ON d.ControlId=e.ControlId
                                                 WHERE a.MtlItemNo IN @MtlItemNo
                                            )";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    RdControl += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 研發設計圖
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.RdDesign
                                            WHERE MtlItemId IN (
                                                SELECT MtlItemId
                                                FROM PDM.MtlItem
                                                WHERE MtlItemNo IN @MtlItemNo)";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    Rd += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 替代料
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.BomSubstitution
                                            WHERE BomDetailId IN (
                                               SELECT c.BomDetailId
                                                 FROM PDM.MtlItem a
                                                 INNER JOIN PDM.BillOfMaterials b ON a.MtlItemId=b.MtlItemId
                                                 INNER JOIN PDM.BomDetail c ON b.BomId=c.BomId
                                                 INNER JOIn PDM.MtlItem d ON c.MtlItemId=d.MtlItemId
                                                 INNER JOIN PDM.BomSubstitution e ON c.BomDetailId=e.BomDetailId
                                                 INNER JOIN PDM.MtlItem f ON e.MtlItemId=f.MtlItemId
                                                WHERE a.MtlItemNo IN @MtlItemNo)";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    BomSub += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 元件
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.BomDetail
                                            WHERE BomId IN (
                                               SELECT c.BomId
                                                 FROM PDM.MtlItem a
                                                 INNER JOIN PDM.BillOfMaterials b ON a.MtlItemId=b.MtlItemId
                                                 INNER JOIN PDM.BomDetail c ON b.BomId=c.BomId
                                                 INNER JOIn PDM.MtlItem d ON c.MtlItemId=d.MtlItemId
                                                 INNER JOIN PDM.BomSubstitution e ON c.BomDetailId=e.BomDetailId
                                                 INNER JOIN PDM.MtlItem f ON e.MtlItemId=f.MtlItemId
                                                WHERE a.MtlItemNo IN @MtlItemNo)";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    BomDetail += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 主件
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.BillOfMaterials
                                            WHERE MtlItemId IN (
                                                SELECT MtlItemId
                                                FROM PDM.MtlItem
                                                WHERE MtlItemNo IN @MtlItemNo)";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    Bom += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 客戶品號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.CustomerMtlItem
                                            WHERE MtlItemId IN (
                                                SELECT MtlItemId
                                                FROM PDM.MtlItem
                                                WHERE MtlItemNo IN @MtlItemNo)";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    BomSub += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 品號設定
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.MtlItemSetting
                                            WHERE MtlItemId IN (
                                                SELECT MtlItemId
                                                FROM PDM.MtlItem
                                                WHERE MtlItemNo = @MtlItemNo)";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    BomSub += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 品號
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.MtlItem                                           
                                        WHERE MtlItemNo = @MtlItemNo";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    BomSub += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }
                        }
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + mainAffected + " rows affected)",
                        data = "已刪除資料<br />【" + mainAffected + "】筆單頭"
                    });
                    #endregion

                    //transactionScope.Complete();
                }
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//DeleteBomSynchronize -- BOM異動刪除 --Ding 2023.06.01
        public string DeleteBomSynchronize(string CompanyNo, string UpdateDate)
        {
            try
            {
                if (CompanyNo.Length <= 0) throw new SystemException("【公司】不能為空!");
                int mainAffected = 0;
                int run = 0; //是否執行異動刪除  0:不執行 1:執行
                #region//MES品號異動同步                       
                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
                {
                    int CompanyId = -1;
                    string ErpConnectionStrings = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyNo = @CompanyNo";
                        dynamicParameters.Add("CompanyNo", CompanyNo);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        using (SqlConnection sqlErpConnection = new SqlConnection(ErpConnectionStrings))
                        {
                            #region//刪除 BOM 主件異動

                            #region //撈取ERP產品結構主件資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.MC001)) MtlItemNo
                                FROM BOMMC a
                                WHERE 1=1";
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + a.CREATE_TIME > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                            var resultBillOfMaterials = sqlErpConnection.Query<BillOfMaterials>(sql, dynamicParameters);
                            #endregion

                            #region//MES產品結構主件資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MtlItemNo
                                    FROM PDM.BillOfMaterials a
                                    INNER JOIN PDM.MtlItem b ON a.MtlItemId=b.MtlItemId
                                    WHERE b.CompanyId = @CompanyId
                                    AND b.TransferStatus='Y'";
                            dynamicParameters.Add("CompanyId", CompanyId);
                            var resultBmBom = sqlConnection.Query<BillOfMaterials>(sql, dynamicParameters);
                            #endregion

                            #region//篩選ERP不存在但MES還存在的主件品號
                            var dictionaryErpIt = resultBillOfMaterials.ToDictionary(x => x.MtlItemNo, x => x.MtlItemNo);
                            var dictionaryBmIt = resultBmBom.ToDictionary(x => x.MtlItemNo, x => x.MtlItemNo);
                            var change = dictionaryBmIt.Where(x => !dictionaryErpIt.ContainsKey(x.Key)).ToList();
                            var changeList = change.Select(x => x.Value).ToList();
                            mainAffected = changeList.Count;
                            #endregion

                            if (run == 1)
                            {
                                if (changeList.Count > 0)
                                {
                                    int BomDetail = 0, Bom = 0;

                                    #region//刪除 元件
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.BomDetail
                                            WHERE BomId IN (
                                               SELECT a.BomId
                                                FROM PDM.BillOfMaterials a
                                                INNER JOIN PDM.MtlItem b ON a.MtlItemId=b.MtlItemId
                                                WHERE b.TransferStatus='Y' AND b.MtlItemNo = @MtlItemNo)";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    BomDetail += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion

                                    #region//刪除 主件
                                    dynamicParameters = new DynamicParameters();
                                    sql = @"DELETE PDM.BillOfMaterials
                                            WHERE BomId IN (
                                                SELECT a.BomId
                                                FROM PDM.BillOfMaterials a
                                                INNER JOIN PDM.MtlItem b ON a.MtlItemId=b.MtlItemId
                                                WHERE b.TransferStatus='Y' AND b.MtlItemNo = @MtlItemNo)";
                                    dynamicParameters.Add("MtlItemNo", changeList.Select(x => x).ToArray());
                                    Bom += sqlConnection.Execute(sql, dynamicParameters);
                                    #endregion
                                }
                            }

                            #endregion

                            #region//刪除 BOM 元件異動

                            #region //撈取ERP產品結構元件資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT LTRIM(RTRIM(a.MD001)) BomMtlItemNo,LTRIM(RTRIM(a.MD002)) BomSequence,LTRIM(RTRIM(a.MD003)) MtlItemNo 
                                FROM BOMMD a
                                WHERE 1=1";
                            BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "UpdateDate", @" AND (a.CREATE_DATE + ' ' + a.CREATE_TIME > @UpdateDate OR a.MODI_DATE + ' ' + a.MODI_TIME > @UpdateDate)", UpdateDate);
                            var resultBomDetails = sqlErpConnection.Query<BomDetail>(sql, dynamicParameters);
                            #endregion

                            #region//MES產品結構元件資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT b.MtlItemNo AS BomMtlItemNo ,c.BomSequence,d.MtlItemNo AS MtlItemNo
                                    FROM PDM.BillOfMaterials a
                                    INNER JOIN PDM.MtlItem b ON a.MtlItemId=b.MtlItemId
                                    INNER JOIN PDM.BomDetail c ON a.BomId=c.BomId
                                    INNER JOIN PDM.MtlItem d ON c.MtlItemId=d.MtlItemId
                                    WHERE b.TransferStatus='Y'";
                            dynamicParameters.Add("CompanyId", CompanyId);
                            var resultBmDetail = sqlConnection.Query<BomDetail>(sql, dynamicParameters);
                            #endregion

                            #region//篩選ERP不存在但MES還存在的元件品號
                            var dictionaryErpDetail = resultBomDetails.ToDictionary(x => x.BomMtlItemNo + ";" + x.BomSequence + ";" + x.MtlItemNo, x => x);
                            var dictionaryBmDetail = resultBmDetail.ToDictionary(x => x.BomMtlItemNo + ";" + x.BomSequence + ";" + x.MtlItemNo, x => x);
                            var Detailchange = dictionaryBmDetail.Where(x => !dictionaryErpDetail.ContainsKey(x.Key)).ToList();
                            var DetailchangeList = Detailchange.Select(x => x.Value).ToList();
                            mainAffected = changeList.Count;
                            #endregion                           

                            if (run == 1)
                            {
                                if (DetailchangeList.Count > 0)
                                {
                                    int BomDetail = 0;
                                    for (int i = 0; i < DetailchangeList.Count(); i++)
                                    {
                                        #region//刪除 元件
                                        dynamicParameters = new DynamicParameters();
                                        sql = @"DELETE PDM.BomDetail
                                            WHERE BomDetailId IN (
                                                SELECT c.BomDetailId
                                                FROM PDM.BillOfMaterials a
                                                INNER JOIN PDM.MtlItem b ON a.MtlItemId=b.MtlItemId
                                                INNER JOIN PDM.BomDetail c ON a.BomId=c.BomId
                                                INNER JOIN PDM.MtlItem d ON c.MtlItemId=d.MtlItemId
                                                WHERE b.TransferStatus='Y'
                                                AND b.MtlItemNo+';'+c.BomSequence+';'+d.MtlItemNo IN @BomInfo)";
                                        dynamicParameters.Add("BomInfo", DetailchangeList[i].BomMtlItemNo);
                                        BomDetail += sqlConnection.Execute(sql, dynamicParameters);
                                        #endregion
                                    }
                                }
                            }
                            #endregion
                        }
                    }

                    #region //Response
                    jsonResponse = JObject.FromObject(new
                    {
                        status = "success",
                        msg = "(" + mainAffected + " rows affected)",
                        data = "已刪除資料<br />【" + mainAffected + "】筆單頭"
                    });
                    #endregion

                    //transactionScope.Complete();
                }
                #endregion
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }

        #endregion

        #region//DeleteBomSubstitutionSynchronize -- 取替代料異動刪除 --Ding 2023.06.01
        public string DeleteBomSubstitutionSynchronize(string CompanyNo, string UpdateDate)
        {
            try
            {
                if (CompanyNo.Length <= 0) throw new SystemException("【公司】不能為空!");
                int CompanyId = -1;
                string ErpConnectionStrings = "";

                using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                {
                    #region //判斷公司資料是否正確
                    dynamicParameters = new DynamicParameters();
                    sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyNo = @CompanyNo";
                    dynamicParameters.Add("CompanyNo", CompanyNo);

                    var result = sqlConnection.Query(sql, dynamicParameters);
                    if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                    foreach (var item in result)
                    {
                        CompanyId = Convert.ToInt32(item.CompanyId);
                        ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                    }
                    #endregion
                }
                //transactionScope.Complete();
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMtlItem -- 品號資料刪除 -- Zoey 2022.10.14
        public string DeleteMtlItem(int MtlItemId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string TransferStatus = "";
                        int rowsAffected = 0;

                        #region //判斷品號資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("品號資料錯誤!");
                        #endregion

                        #region //撈取拋轉狀態
                        sql = @"SELECT TransferStatus
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);

                        foreach (var item in result2)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        #endregion

                        if (TransferStatus != "Y")
                        {
                            #region //刪除關聯table
                            #region //刪除PDM.CustomerMtlItem
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.CustomerMtlItem
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除PDM.BomSubstitution
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a
                                    FROM PDM.BomSubstitution a
                                    INNER JOIN PDM.BomDetail b ON b.BomDetailId = a.BomDetailId
                                    INNER JOIN PDM.BillOfMaterials c ON c.BomId = b.BomId
                                    WHERE c.MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除PDM.BomDetail
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE a
                                    FROM PDM.BomDetail a
                                    INNER JOIN PDM.BillOfMaterials b ON b.BomId = a.BomId
                                    WHERE b.MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除PDM.BillOfMaterials
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.BillOfMaterials
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除PDM.RdDesign的品號
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE PDM.RdDesign SET MtlItemId = NULL
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除SCM.SoDetail的品號
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.SoDetail SET MtlItemId = NULL
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除PDM.MtlItemSetting
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.MtlItemSetting
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion

                            #region //刪除PDM.MtlItemSegment
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.MtlItemSegment
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                            #endregion

                            #region //刪除主要table
                            dynamicParameters = new DynamicParameters();
                            sql = @"DELETE PDM.MtlItem
                                    WHERE MtlItemId = @MtlItemId";
                            dynamicParameters.Add("MtlItemId", MtlItemId);

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                            #endregion
                        }
                        else
                        {
                            throw new SystemException("此品號已拋轉，無法刪除!");
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBomDetail -- Bom元件資料刪除 -- Zoey 2022.12.06
        public string DeleteBomDetail(int BomDetailId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷Bom元件是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomDetail
                                WHERE BomDetailId = @BomDetailId";
                        dynamicParameters.Add("BomDetailId", BomDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("BOM元件資料錯誤!");
                        #endregion

                        #region //判斷取替代料是否有資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomSubstitution
                                WHERE BomDetailId = @BomDetailId";
                        dynamicParameters.Add("BomDetailId", BomDetailId);

                        var result2 = sqlConnection.Query(sql, dynamicParameters);
                        if (result2.Count() > 0) throw new SystemException("請先刪除取替代料資料!");
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.BomDetail
                                WHERE BomDetailId = @BomDetailId";
                        dynamicParameters.Add("BomDetailId", BomDetailId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBomDetailAll -- 刪除Bom元件全部 -- Shintokuro 2023-12-07
        public string DeleteBomDetailAll(int BomId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;
                        #region//檢核品號【BOM單頭】是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConfirmStatus
                                FROM PDM.BillOfMaterials a
                                WHERE a.BomId=@BomId";
                        dynamicParameters.Add("BomId", BomId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【BOM單頭】查無資料,請重新確認");
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("【BOM】須處於未確認狀態下才可以異動");
                        }
                        #endregion

                        #region//檢核品號【BOM單頭】是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 ConfirmStatus
                                FROM PDM.BomDetail a
                                WHERE a.BomId=@BomId
                                AND a.ConfirmStatus ='Y'";
                        dynamicParameters.Add("BomId", BomId);
                        result = sqlConnection.Query(sql, dynamicParameters);
                        foreach (var item in result)
                        {
                            if (item.ConfirmStatus != "N") throw new SystemException("【BOM】須處於未確認狀態下才可以異動");
                        }
                        #endregion

                        #region //刪除PDM.BomDetail
                        sql = @"DELETE PDM.BomDetail
                                WHERE BomId = @BomId";
                        dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BomId
                                });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMtlRdDesign -- 研發設計圖品號刪除 -- Zoey 2022.12.07
        public string DeleteMtlRdDesign(int DesignId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷設計圖是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.RdDesign
                                WHERE DesignId = @DesignId";
                        dynamicParameters.Add("DesignId", DesignId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("研發設計圖錯誤!");
                        #endregion

                        #region //刪除設計圖品號
                        dynamicParameters = new DynamicParameters();
                        sql = @"UPDATE PDM.RdDesign SET
                                MtlItemId = NULL,
                                LastModifiedDate = @LastModifiedDate,
                                LastModifiedBy = @LastModifiedBy
                                WHERE DesignId = @DesignId";
                        dynamicParameters.AddDynamicParams(
                             new
                             {
                                 LastModifiedDate,
                                 LastModifiedBy,
                                 DesignId
                             });

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMtlSaleOrder -- 研發設計圖品號刪除 -- Zoey 2022.12.08
        public string DeleteMtlSaleOrder(int SoDetailId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        string TransferStatus = "";
                        int rowsAffected = 0;

                        #region //判斷訂單是否正確/撈取拋轉狀態
                        sql = @"SELECT b.TransferStatus
                                FROM SCM.SoDetail a
                                INNER JOIN SCM.SaleOrder b ON b.SoId = a.SoId
                                WHERE SoDetailId = @SoDetailId";
                        dynamicParameters.Add("SoDetailId", SoDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("訂單資料錯誤!");
                        foreach (var item in result)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        #endregion

                        if (TransferStatus == "N")
                        {
                            dynamicParameters = new DynamicParameters();
                            sql = @"UPDATE SCM.SoDetail SET
                                    MtlItemId = NULL,
                                    SoMtlItemName = '',
                                    SoMtlItemSpec = '',
                                    LastModifiedDate = @LastModifiedDate,
                                    LastModifiedBy = @LastModifiedBy
                                    WHERE SoDetailId = @SoDetailId";
                            dynamicParameters.AddDynamicParams(
                                 new
                                 {
                                     LastModifiedDate,
                                     LastModifiedBy,
                                     SoDetailId
                                 });

                            rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        }
                        else
                        {
                            throw new SystemException("訂單已拋轉ERP，無法解綁!");
                        }

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBomSubstitution -- 取替代料資料刪除 -- Zoey 2022.12.08
        public string DeleteBomSubstitution(int SubstitutionId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷取替代料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.BomSubstitution
                                WHERE SubstitutionId = @SubstitutionId";
                        dynamicParameters.Add("SubstitutionId", SubstitutionId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("取替代料資料錯誤!");
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.BomSubstitution
                                WHERE SubstitutionId = @SubstitutionId";
                        dynamicParameters.Add("SubstitutionId", SubstitutionId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteCustomerMtlItem -- 部番資料刪除 -- Zoey 2023.01.16
        public string DeleteCustomerMtlItem(int CustomerMtlItemId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷部番是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.CustomerMtlItem
                                WHERE CustomerMtlItemId = @CustomerMtlItemId";
                        dynamicParameters.Add("CustomerMtlItemId", CustomerMtlItemId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("部番資料錯誤!");
                        #endregion

                        #region //刪除主要table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.CustomerMtlItem
                                WHERE CustomerMtlItemId = @CustomerMtlItemId";
                        dynamicParameters.Add("CustomerMtlItemId", CustomerMtlItemId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//DeleteMtlItemChange --品號變更單刪除 --Ding 2023.05.24 --GPai 20230616
        public string DeleteMtlItemChange(int MtlItemChangeId, int MtlItemId, string ChangeEdition)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷是否拋轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 *
                                FROM PDM.MtlItemChange
                                WHERE MtlItemChangeId = @MtlItemChangeId";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("資料錯誤!");
                        if (result.First().TransferStatus == "Y") throw new SystemException("該資料已拋轉!");
                        #endregion

                        #region //刪除MtlItemChangeDetail table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.MtlItemChangeDetail
                                WHERE MtlItemChangeId = @MtlItemChangeId AND ChangeEdition = @ChangeEdition";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        dynamicParameters.Add("ChangeEdition", ChangeEdition);


                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除MtlItemChange table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.MtlItemChange
                                WHERE MtlItemChangeId = @MtlItemChangeId AND ChangeEdition = @ChangeEdition";
                        dynamicParameters.Add("MtlItemChangeId", MtlItemChangeId);
                        dynamicParameters.Add("ChangeEdition", ChangeEdition);


                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region//DeleteMtlItemChangeDetail --品號變更單身刪除 --GPai 20230616
        public string DeleteMtlItemChangeDetail(int MtlChangeDetailId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷是否拋轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MtlItemChangeId, a.TransferStatus,b.MtlChangeDetailId
                                FROM PDM.MtlItemChange a
                                JOIN PDM.MtlItemChangeDetail b ON b.MtlItemChangeId = a.MtlItemChangeId
                                WHERE b.MtlChangeDetailId = @MtlChangeDetailId";
                        dynamicParameters.Add("MtlChangeDetailId", MtlChangeDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("資料錯誤!");
                        //if (result.First().TransferStatus == "Y") throw new SystemException("該資料已拋轉!");
                        #endregion

                        #region //刪除MtlItemChangeDetail table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.MtlItemChangeDetail
                                WHERE MtlChangeDetailId = @MtlChangeDetailId";
                        dynamicParameters.Add("MtlChangeDetailId", MtlChangeDetailId);


                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMtlItemUomCalculate -- 品號單位換算刪除 -- Shintokuro 2023.06.14
        public string DeleteMtlItemUomCalculate(int MtlItemUomCalculateId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        DynamicParameters dynamicParameters = new DynamicParameters();

                        string TransferStatus = "";
                        double? nulldate = null;

                        List<MtlItemUomCalculate> mtlItemUomCalculate = new List<MtlItemUomCalculate>();


                        #region //判斷品號單位換算資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomId, SwapDenominator, SwapNumerator, TransferStatus, 
                                TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy
                                FROM PDM.MtlItemUomCalculate
                                WHERE MtlItemUomCalculateId = @MtlItemUomCalculateId";
                        dynamicParameters.Add("MtlItemUomCalculateId", MtlItemUomCalculateId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        mtlItemUomCalculate = sqlConnection.Query<MtlItemUomCalculate>(sql, dynamicParameters).ToList();

                        if (result.Count() <= 0) throw new SystemException("【品號單位換算】－品號單位換算資料不存在,請重新確認!");
                        foreach (var item in result)
                        {
                            TransferStatus = item.TransferStatus;
                        }
                        if (TransferStatus == "Y") throw new SystemException("【品號單位換算】－資料已經拋轉不能刪除,請重新確認!");
                        #endregion

                        #region //刪除品號單位換算資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.MtlItemUomCalculate
                                WHERE MtlItemUomCalculateId = @MtlItemUomCalculateId";
                        dynamicParameters.Add("MtlItemUomCalculateId", MtlItemUomCalculateId);

                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //資料新增(log)
                        if (mtlItemUomCalculate.Count > 0)
                        {
                            mtlItemUomCalculate
                                .ToList()
                                .ForEach(x =>
                                {
                                    x.TransactionType = "D";
                                    x.TransactionUserId = CurrentUser;
                                    x.TransactionDate = CreateDate;
                                    x.CreateDate = CreateDate;
                                    x.LastModifiedDate = LastModifiedDate;
                                    x.CreateBy = CreateBy;
                                    x.LastModifiedBy = LastModifiedBy;
                                });

                            sql = @"INSERT INTO PDM.MtlItemUomCalculateLog (TransactionType, MtlItemUomCalculateId, MtlItemId, UomId, ConvertUomIdBefore, 
                                    SwapDenominatorBefore, SwapNumeratorBefore, ConvertUomId, SwapDenominator, SwapNumerator, TransactionUserId, 
                                    TransactionDate, TransferStatus, TransferDate, CreateDate, LastModifiedDate, CreateBy, LastModifiedBy)
                                    VALUES (@TransactionType, @MtlItemUomCalculateId, @MtlItemId, @UomId, @ConvertUomIdBefore,
                                    @SwapDenominatorBefore, @SwapNumeratorBefore, @ConvertUomId, @SwapDenominator, @SwapNumerator, @TransactionUserId,
                                    @TransactionDate, @TransferStatus, @TransferDate, @CreateDate, @LastModifiedDate, @CreateBy, @LastModifiedBy)";
                            rowsAffected += sqlConnection.Execute(sql, mtlItemUomCalculate);
                        }
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion

                        transactionScope.Complete();
                    }
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBomChange --Bom變更單刪除 --GPai 20230628
        public string DeleteBomChange(int BomChangeId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷是否拋轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 *
                                FROM PDM.BomChange
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.Add("BomChangeId", BomChangeId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("資料錯誤!");
                        if (result.First().TransferStatus == "Y") throw new SystemException("該資料已拋轉!");
                        #endregion

                        #region //刪除BomChangeSubDetail table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.BomChangeSubDetail
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.Add("BomChangeId", BomChangeId);


                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除BomChangeDetail table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.BomChangeDetail
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.Add("BomChangeId", BomChangeId);


                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除BomChange table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.BomChange
                                WHERE BomChangeId = @BomChangeId";
                        dynamicParameters.Add("BomChangeId", BomChangeId);


                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBomChangeDetail --Bom變更單身刪除 --GPai 20230628
        public string DeleteBomChangeDetail(int BomChangeDetailId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷是否拋轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM PDM.BomChange a
                                INNER JOIN PDM.BomChangeDetail b ON b.BomChangeId = a.BomChangeId
                                WHERE b.BomChangeDetailId = @BomChangeDetailId";
                        dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("資料錯誤!");
                        //if (result.First().TransferStatus == "Y") throw new SystemException("該資料已拋轉!");
                        #endregion

                        #region //刪除BomChangeSubDetail table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.BomChangeSubDetail
                                WHERE BomChangeDetailId = @BomChangeDetailId";
                        dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);


                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除BomChangeDetail table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.BomChangeDetail
                                WHERE BomChangeDetailId = @BomChangeDetailId";
                        dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);


                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteBomChangeSubDetail --Bom變更子單身刪除 --GPai 20230628
        public string DeleteBomChangeSubDetail(int BomChangeDetailId, int BomChangeSubDetailId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷是否拋轉
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT *
                                FROM PDM.BomChange a
                                INNER JOIN PDM.BomChangeDetail b ON b.BomChangeId = a.BomChangeId
                                WHERE b.BomChangeDetailId = @BomChangeDetailId";
                        dynamicParameters.Add("BomChangeDetailId", BomChangeDetailId);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("資料錯誤!");
                        //if (result.First().TransferStatus == "Y") throw new SystemException("該資料已拋轉!");
                        #endregion

                        #region //刪除BomChangeDetail table
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.BomChangeSubDetail
                                WHERE BomChangeSubDetailId = @BomChangeSubDetailId";
                        dynamicParameters.Add("BomChangeSubDetailId", BomChangeSubDetailId);


                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteMtlQcItem --刪除品號進出貨檢資料刪除 -- Chia Yuan 2024.03.27
        public string DeleteMtlQcItem(int MtlItemId)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //取得品號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 1
                                FROM PDM.MtlItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【品號】資料錯誤!");
                        #endregion

                        #region //品號量測項目刪除
                        dynamicParameters = new DynamicParameters();
                        sql = @"DELETE PDM.MtlQcItem
                                WHERE MtlItemId = @MtlItemId";
                        dynamicParameters.Add("MtlItemId", MtlItemId);
                        int rowsAffected = sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion
        #endregion

        #region //Api
        #region //DeleteCorrectMtlItem -- 品號異動刪除 -- Shintokuro 2023.10.24
        public string DeleteCorrectMtlItem(string Type, string MtlItemNo, string CheckTableList)
        {
            try
            {
                IEnumerable<dynamic> resultForeignKey;

                List<MtlItem> mtlitems = new List<MtlItem>();
                List<MtlItem> addMtlItems = new List<MtlItem>();

                List<string> AddMtlItems = new List<string>();
                List<int?> MtlItemIdListMes = new List<int?>();
                List<string> checkTableList = new List<string>();

                int rowsAffected = 0;
                string sqlDelte = "";
                string sqlUpdate = "";
                string AberrantTable = "";

                //如果有新增或刪除資料的,這邊就要做異動
                //請前往前端頁面調整參數
                //string[] checkTableArr = new[]{
                //    "SCM.SoDetail","SCM.PrDetail","SCM.ItDetail","MES.WoDetail","MES.WipOrder",
                //    "PDM.RdDesign","PDM.BomSubstitution","PDM.BomDetail","PDM.BillOfMaterials",
                //    "PDM.MtlItemUomCalculate","PDM.MtlItemSegment","PDM.MtlItemSetting",
                //    "PDM.CustomerMtlItem","QMS.CustomerComplaint", "MES.RoutingItem",
                //    "MES.OspReceiptDetail","SCM.TsrnDetail","MES.MrDetail",
                //    "SCM.SomDetail" ,"SCM.TsnDetail" ,"MES.ProdDemandDetail","MES.MweDetail" ,"SCM.PrmDetail",
                //    "SCM.RmaDetail" ,"PDM.MtlItemChangeDetail" ,"PDM.MtlItemChange" ,"PDM.BomChangeSubDetail" ,"PDM.BomChangeDetail",
                //    "PDM.MtlQcItem","SCM.PoDetail","SCM.GrDetail","SCM.LotNumber","MES.VehicleDetail","PDM.MassProductionReviewDoc",
                //    "SCM.MaterialManagement","PDM.AutoReadCadDesign",
                //    "PDM.MtlItem"
                //};

                foreach (var item in CheckTableList.Split(','))
                {
                    checkTableList.Add(item);
                }

                using (TransactionScope transactionScope = new TransactionScope(TransactionScopeOption.Required, new TimeSpan(0, 180, 0)))
                {
                    int CompanyId = -1;
                    string ErpConnectionStrings = "";

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyId = @CurrentCompany";
                        dynamicParameters.Add("CurrentCompany", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion

                        #region //尋找相關foreign key
                        string noTableBase = "";
                        string noTable = "";
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT obj.name AS FK_NAME,
                                    sch.name AS [schema_name],
                                    tab1.name AS [table],
                                    col1.name AS [column],
                                    tab2.name AS [referenced_table],
                                    col2.name AS [referenced_column]
                                FROM sys.foreign_key_columns fkc
                                INNER JOIN sys.objects obj
                                    ON obj.object_id = fkc.constraint_object_id
                                INNER JOIN sys.tables tab1
                                    ON tab1.object_id = fkc.parent_object_id
                                INNER JOIN sys.schemas sch
                                    ON tab1.schema_id = sch.schema_id
                                INNER JOIN sys.columns col1
                                    ON col1.column_id = parent_column_id AND col1.object_id = tab1.object_id
                                INNER JOIN sys.tables tab2
                                    ON tab2.object_id = fkc.referenced_object_id
                                INNER JOIN sys.columns col2
                                    ON col2.column_id = referenced_column_id AND col2.object_id = tab2.object_id
                                WHERE tab2.name = 'MtlItem'
                                AND col2.name = 'MtlItemId'";
                        resultForeignKey = sqlConnection.Query(sql, dynamicParameters);
                        if (resultForeignKey.Count() <= 0) throw new SystemException("Foreign Key資料錯誤!");
                        foreach (var item in resultForeignKey)
                        {
                            string Table = item.schema_name + "." + item.table;
                            if (!checkTableList.Contains(Table)) //確認資料庫有設定的資料表沒有存在程式設定中 
                            {
                                noTableBase += Table + ";";
                            }
                        }
                        var ForeignKeyTableBase = resultForeignKey.Select(x => x.schema_name + "." + x.table).ToList();
                        foreach (var item in checkTableList)
                        {
                            if (item == "PDM.MtlItem")
                            {
                                break;
                            }
                            if (!ForeignKeyTableBase.Contains(item)) //確認程式設定的資料表沒有存在資料庫中
                            {
                                noTable += item + ";";
                            }
                        }

                        if (noTableBase.Length > 0 && noTable.Length > 0)
                        {
                            throw new SystemException("與品號相關的資料表有異動,以下為資料庫新增資料表【" + noTableBase + "】,以下為資料庫所沒有資料表【" + noTable + "】,請通知系統開發室更新異動刪除程式!");
                        }
                        if (noTableBase.Length > 0)
                        {
                            throw new SystemException("與品號相關的資料表有異動,以下為資料庫新增資料表【" + noTableBase + "】,請通知系統開發室更新異動刪除程式!");
                        }
                        if (noTable.Length > 0)
                        {
                            throw new SystemException("與品號相關的資料表有異動,以下為資料庫所沒有資料表【" + noTable + "】,請通知系統開發室更新異動刪除程式!");
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //撈取ERP品號資料
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT LTRIM(RTRIM(a.MB001)) MtlItemNo
                                FROM INVMB a
                                WHERE 1=1
                                AND LTRIM(RTRIM(a.MB001)) NOT IN ('3A12L84N-L1(2)', '3FMHD（GM1557）-PGM', '2A8CAV-D16MR-3.0-LBX-103-M')";
                        switch (Type)
                        {
                            case "One":
                                BaseHelper.SqlParameter(ref sql, ref dynamicParameters, "MtlItemNo", @" AND a.MB001 = @MtlItemNo", MtlItemNo);
                                break;
                            case "All":
                                break;
                        }
                        var result = sqlConnection.Query(sql, dynamicParameters);

                        mtlitems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region /找出欲異動刪除的品號Id
                        switch (Type)
                        {
                            case "One":
                                if (mtlitems.Count() > 0) throw new SystemException("品號【" + MtlItemNo + "】在ERP尚存在不能執行異動刪除,請重新確認!!!");
                                #region //判斷PDM.MtlItem是否有資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MtlItemId, MtlItemNo
                                        FROM PDM.MtlItem
                                        WHERE CompanyId = @CompanyId
                                        AND TransferStatus = 'Y'
                                        AND MtlItemNo = @MtlItemNo";
                                dynamicParameters.Add("CompanyId", CompanyId);
                                dynamicParameters.Add("MtlItemNo", MtlItemNo);
                                var resultMtlItem = sqlConnection.Query(sql, dynamicParameters);
                                if (resultMtlItem.Count() <= 0) throw new SystemException("品號【" + MtlItemNo + "】在MES已經沒有相關資料或是處於未拋轉狀態,請重新確認!!!");
                                foreach (var item in resultMtlItem)
                                {
                                    MtlItemIdListMes.Add(item.MtlItemId);
                                }
                                #endregion
                                break;
                            case "All":
                                #region //判斷PDM.MtlItem是否有資料
                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT MtlItemId, MtlItemNo
                                        FROM PDM.MtlItem
                                        WHERE CompanyId = @CompanyId
                                        AND TransferStatus = 'Y'";
                                dynamicParameters.Add("CompanyId", CompanyId);
                                var resultMtlItem2 = sqlConnection.Query(sql, dynamicParameters);

                                List<MtlItem> resultMtltems = sqlConnection.Query<MtlItem>(sql, dynamicParameters).ToList();
                                #endregion

                                #region //比較ERP資料和MES資料 找出ERP有MES沒有的品號--該品號不要做異動
                                mtlitems = mtlitems.GroupJoin(resultMtltems, x => x.MtlItemNo, y => y.MtlItemNo, (x, y) => { x.MtlItemId = y.FirstOrDefault()?.MtlItemId; return x; }).ToList();
                                AddMtlItems = mtlitems.Where(x => x.MtlItemId == null).Select(x => x.MtlItemNo).ToList();
                                #endregion

                                #region //比較ERP資料和MES資料 找出ERP沒有的品號
                                MtlItemIdListMes = resultMtltems.Select(x => x.MtlItemId).Except(mtlitems.Select(y => y.MtlItemId)).ToList();
                                #endregion
                                break;
                        }
                        #endregion

                        #region //檢核欲異動刪除的品號
                        foreach (var item in MtlItemIdListMes)
                        {
                            #region //判斷PDM.MtlItem是否有資料
                            dynamicParameters = new DynamicParameters();
                            sql = @"SELECT MtlItemId, MtlItemNo
                                    FROM PDM.MtlItem
                                    WHERE CompanyId = @CompanyId
                                    AND TransferStatus = 'Y'
                                    AND MtlItemId = @MtlItemId";
                            dynamicParameters.Add("CompanyId", CompanyId);
                            dynamicParameters.Add("MtlItemId", item);
                            var resultMtlItem2 = sqlConnection.Query(sql, dynamicParameters);
                            if (resultMtlItem2.Count() <= 0) throw new SystemException("MES已經找不到品號Id【" + item + "】請重新確認!!!");
                            if (AddMtlItems.Contains(resultMtlItem2.First().MtlItemNo)) throw new SystemException("品號ID【" + item + "】在ERP目前已經存在,請重新確認!!!");
                            MtlItemNo = resultMtlItem2.First().MtlItemNo;
                            #endregion

                            #region //檢核相關單據+暫存各單據刪除SQL
                            foreach (var Table in checkTableList)
                            {
                                bool MainTableDelete = false;

                                dynamicParameters = new DynamicParameters();
                                sql = @"SELECT TOP 1 1
                                        FROM " + Table + @"
                                        --WHERE CompanyId = @CompanyId
                                        --AND TransferStatus = 'Y'
                                        WHERE MtlItemId = @MtlItemId";
                                if (Table == "MES.WoDetail")
                                {
                                    sql += " OR SubstituteMtlItemId = @MtlItemId";
                                }
                                dynamicParameters.Add("CompanyId", CompanyId);
                                dynamicParameters.Add("MtlItemId", item);
                                var resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                if (resulCheck.Count() > 0)
                                {
                                    switch (Table)
                                    {
                                        #region //檢核-訂單單身-SCM.SoDetail
                                        case "SCM.SoDetail":
                                            //有綁上訂單代表訂單已經成立出現在ERP 理輪上後續單據如果有發現綁了訂單都不能再刪除
                                            #region //檢核暫出單 -有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.TsnDetail a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE b.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核請購單身 -有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.PrDetail a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE b.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核請購變更單身 -有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.PrmDetail a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE b.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核揀貨物件 -有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.PickingItem a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE b.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核訂單變更單身 -有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.SomDetail a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE b.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核出貨單身 -有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.DoDetail a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE b.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核排定交貨日歷史紀錄 -有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.DeliveryDateLog a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE b.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核ERP工單 -有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM MES.WipOrder a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE b.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核訂單單頭是否有拋轉
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TransferStatus 
                                                    FROM SCM.SaleOrder a
                                                    INNER JOIN SCM.SoDetail b on a.SoId = b.SoId
                                                    WHERE b.MtlItemId = @MtlItemId
                                                    AND a.TransferStatus = 'Y'";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單且已經拋轉ERP,不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM SCM.SoDetail a
                                                        WHERE a.MtlItemId = " + item;
                                            #endregion
                                            break;
                                        #endregion

                                        #region //檢核-請購單身-SCM.PrDetail
                                        case "SCM.PrDetail":
                                            #region //有沒有綁定訂單
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.PrDetail a
                                                    INNER JOIN SCM.SoDetail b on a.SoDetailId = b.SoDetailId
                                                    WHERE a.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定訂單系統相關單據不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核單據有沒有拋轉ERP
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.PrDetail a 
                                                    INNER JOIN SCM.PurchaseRequisition b on a.PrId = b.PrId
                                                    WHERE a.MtlItemId = @MtlItemId
                                                    AND b.TransferStatus = 'Y'";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定請購單據且拋轉ERP不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion
                                            break;
                                        #endregion

                                        #region //檢核-庫存異動單身-SCM.ItDetail
                                        case "SCM.ItDetail":
                                            //單一資料表直接刪

                                            #region //檢核單據有沒有拋轉ERP
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM SCM.ItDetail a 
                                                    INNER JOIN SCM.InventoryTransaction b on a.ItId = b.ItId
                                                    WHERE a.MtlItemId = @MtlItemId
                                                    AND b.TransferStatus = 'Y'";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定庫存異動單據且拋轉ERP不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            break;
                                        #endregion

                                        #region //檢核-ERP製令單身-MES.WoDetail
                                        case "MES.WoDetail":
                                            #region //有沒有被綁定
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM MES.WoDetail a 
                                                    INNER JOIN MES.MoMtlSetting b on a.WoDetailId = b.WoDetailId
                                                    WHERE a.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定MES製令用料設定檔不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核單據有沒有拋轉ERP
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM MES.WoDetail a 
                                                    INNER JOIN MES.WipOrder b on a.WoId = b.WoId
                                                    WHERE b.MtlItemId = @MtlItemId
                                                    AND b.TransferStatus = 'Y'";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定ERP製令且拋轉ERP不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //刪Table
                                            sqlDelte += @" DELETE a FROM MES.WoDetail a
                                                           WHERE a.MtlItemId = " + item + @" OR SubstituteMtlItemId  = " + item;
                                            #endregion
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-ERP製令單頭-MES.WipOrder
                                        case "MES.WipOrder":
                                            #region //有沒有被其他資料表綁定
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1  
                                                    FROM MES.WipOrder a
                                                    INNER JOIN MES.ManufactureOrder b on a.WoId = b.WoId
                                                    WHERE a.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定MES製令不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //有沒有被其他資料表綁定
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM MES.WipOrder a
                                                    INNER JOIN MES.WoDetail b on a.WoId = b.WoId
                                                    INNER JOIN MES.MoMtlSetting c on c.WoDetailId = b.WoDetailId
                                                    WHERE a.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定MES製令用料設定不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //檢核單據有沒有拋轉ERP
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM MES.WipOrder a
                                                    WHERE a.MtlItemId = @MtlItemId
                                                    AND a.TransferStatus = 'Y'";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定ERP製令且拋轉ERP不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM MES.WoDetail a
                                                           INNER JOIN MES.WipOrder b on a.WoId = b.WoId
                                                           WHERE b.MtlItemId = " + item;
                                            #endregion

                                            #region //刪主table
                                            sqlDelte += @" DELETE a FROM MES.WipOrder a
                                                           WHERE a.MtlItemId = " + item;
                                            #endregion

                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-途程品號-MES.RoutingItem
                                        case "MES.RoutingItem":
                                            #region //有沒有被其他資料表綁定
                                            dynamicParameters = new DynamicParameters();
                                            sql = @"SELECT TOP 1 1 
                                                    FROM MES.RoutingItem a
                                                    INNER JOIN MES.MoRouting b on a.RoutingItemId = b.RoutingItemId
                                                    WHERE a.MtlItemId = @MtlItemId";
                                            dynamicParameters.Add("MtlItemId", item);
                                            resulCheck = sqlConnection.Query(sql, dynamicParameters);
                                            if (resulCheck.Count() > 0)
                                            {
                                                throw new SystemException("品號【" + MtlItemNo + "】已經有綁定MES製令不可以異動刪除,請重新確認!!!");
                                            }
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM MES.RoutingItemProcess a
                                                           INNER JOIN MES.RoutingItem b on a.RoutingItemId = b.RoutingItemId
                                                           WHERE b.MtlItemId = " + item;
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM MES.RoutingItemAttribute a
                                                           INNER JOIN MES.RoutingItem b on a.RoutingItemId = b.RoutingItemId
                                                           WHERE b.MtlItemId = " + item;
                                            #endregion

                                            #region //刪除主table
                                            sqlDelte += @" DELETE a FROM MES.RoutingItem a
                                                           WHERE a.MtlItemId = " + item;
                                            #endregion
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-研發設計圖-PDM.RdDesign
                                        case "PDM.RdDesign":
                                            sqlUpdate = @"UPDATE PDM.RdDesign SET
                                                          MtlItemId = null,
                                                          LastModifiedDate = @LastModifiedDate,
                                                          LastModifiedBy = " + LastModifiedBy + @"
                                                          WHERE MtlItemId = " + item;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-BOM用量資料單頭-PDM.BillOfMaterials
                                        case "PDM.BillOfMaterials":
                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM PDM.BomSubstitution a
                                                           INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                                           INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                                           WHERE c.MtlItemId = " + item;
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM PDM.BomDetail a
                                                           INNER JOIN PDM.BillOfMaterials b on a.BomId = b.BomId
                                                           WHERE b.MtlItemId = " + item;
                                            #endregion

                                            #region //刪除主table
                                            sqlDelte += @" DELETE a FROM PDM.BillOfMaterials a
                                                           WHERE a.MtlItemId = " + item;
                                            #endregion
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-客訴單據-QMS.CustomerComplaint
                                        case "QMS.CustomerComplaint":
                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM QMS.CCTrackingData a
                                                        INNER JOIN QMS.CcStageData b on a.CcStageDataId = b.CcStageDataId
                                                        INNER JOIN QMS.CustomerComplaint c on b.CcId = c.CcId
                                                        WHERE c.MtlItemId = " + item;
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM QMS.CcStageDataFile a
                                                                   INNER JOIN QMS.CcStageData b on a.CcStageDataId = b.CcStageDataId
                                                                   INNER JOIN QMS.CustomerComplaint c on b.CcId = c.CcId
                                                                   WHERE c.MtlItemId = " + item;
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM QMS.CcStageData a
                                                                   INNER JOIN QMS.CustomerComplaint b on a.CcId = b.CcId
                                                                   WHERE b.MtlItemId = " + item;
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM QMS.CcTeamMembers a
                                                                   INNER JOIN QMS.CustomerComplaint b on a.CcId = b.CcId
                                                                   WHERE b.MtlItemId = " + item;
                                            #endregion

                                            #region //刪子table
                                            sqlDelte += @" DELETE a FROM QMS.CcFile a
                                                                   INNER JOIN QMS.CustomerComplaint b on a.CcId = b.CcId
                                                                   WHERE b.MtlItemId = " + item;
                                            #endregion

                                            #region //刪主table
                                            sqlDelte += @" DELETE a FROM QMS.CustomerComplaint a
                                                                   WHERE a.MtlItemId = " + item;
                                            #endregion

                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        //以下有資料不可以刪除,需查證異常
                                        #region //檢核-暫出單單身-SCM.TsnDetail
                                        case "SCM.TsnDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-暫出歸還單單身-SCM.TsrnDetail
                                        case "SCM.TsrnDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-訂單變更單身-SCM.SomDetail
                                        case "SCM.SomDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-請購變更單身-SCM.PrmDetail
                                        case "SCM.PrmDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-退(換)貨項目-SCM.RmaDetail
                                        case "SCM.RmaDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-領料單-MES.MrDetail
                                        case "MES.MrDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-托外進貨5902-MES.OspReceiptDetail
                                        case "MES.OspReceiptDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-托外入庫單-MES.MweDetail
                                        case "MES.MweDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-生產需求單身-MES.ProdDemandDetail
                                        case "MES.ProdDemandDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-品號變更單單頭-PDM.MtlItemChange
                                        case "PDM.MtlItemChange":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-品號變更單單身-PDM.MtlItemChangeDetail
                                        case "PDM.MtlItemChangeDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-Bom變更單單身-PDM.BomChangeDetail
                                        case "PDM.BomChangeDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-Bom變更單子單身-PDM.BomChangeSubDetail
                                        case "PDM.BomChangeSubDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-單位換算變更-PDM.MtlItemUomCalculateChange
                                        case "PDM.MtlItemUomCalculateChange":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-取替代料件-PDM.BomSubstitution
                                        case "PDM.BomSubstitution":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                        #endregion

                                        #region //檢核-BOM用量資料單身-PDM.BomDetail
                                        case "PDM.BomDetail":
                                            AberrantTable += Table;
                                            MainTableDelete = true;
                                            break;
                                            #endregion
                                    }
                                    if (!MainTableDelete)
                                    {
                                        //單一資料表且必刪,無須檢核
                                        //PDM.MtlItemUomCalculate,PDM.MtlItemSegment,PDM.MtlItemSetting,PDM.CustomerMtlItem,PDM.MtlItem

                                        #region //刪除主table
                                        dynamicParameters = new DynamicParameters();
                                        sqlDelte += @" DELETE a FROM " + Table + @" a
                                                       --WHERE a.CompanyId = @CompanyId
                                                       --AND TransferStatus = 'Y'
                                                       WHERE a.MtlItemId = " + item;
                                        #endregion
                                    }
                                }
                            }
                            #endregion


                        }
                        #endregion

                        if (AberrantTable.Length > 0)
                        {
                            throw new SystemException("品號【" + MtlItemNo + "】在這些資料表【" + AberrantTable + "】中仍然出現屬於資料異常,須先排除異常後才能執行異動刪除!!!");
                        }

                        #region /執行解除綁定研發設計圖
                        if (sqlUpdate.Length > 0)
                        {
                            dynamicParameters = new DynamicParameters();
                            dynamicParameters.Add("LastModifiedDate", LastModifiedDate);
                            rowsAffected += sqlConnection.Execute(sqlUpdate, dynamicParameters);
                        }
                        #endregion


                        #region /執行刪除資料表
                        dynamicParameters = new DynamicParameters();
                        dynamicParameters.Add("CompanyId", CompanyId);
                        sql = sqlDelte;
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }

                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #region //DeleteCorrectBom -- Bom表異動刪除 -- Shintokuro 2023-12-07
        public string DeleteCorrectBom(string MtlItemNo)
        {
            try
            {
                using (TransactionScope transactionScope = new TransactionScope())
                {
                    int CompanyId = -1;

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        #region //判斷公司資料是否正確
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 CompanyId, CompanyName, ErpDb
                                FROM BAS.Company
                                WHERE CompanyId = @CurrentCompany";
                        dynamicParameters.Add("CurrentCompany", CurrentCompany);

                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【公司】資料錯誤!");

                        foreach (var item in result)
                        {
                            CompanyId = Convert.ToInt32(item.CompanyId);
                            ErpConnectionStrings = ConfigurationManager.AppSettings[item.ErpDb];
                        }
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(ErpConnectionStrings))
                    {
                        #region //判斷該品號的Bom相關資料在ERP是否有資料
                        //dynamicParameters = new DynamicParameters();
                        //sql = @"SELECT a.MD001
                        //        FROM BOMMD a
                        //        WHERE 1=1
                        //        AND a.MD001 = @MC001";
                        //dynamicParameters.Add("MC001", MtlItemNo);
                        //var result = sqlConnection.Query(sql, dynamicParameters);
                        //if (result.Count() > 0) throw new SystemException("ERP-【BOM單身】尚有資料,不可以執行BOM刪除");

                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT a.MC001
                                FROM BOMMC a
                                WHERE 1=1
                                AND a.MC001 = @MC001";
                        dynamicParameters.Add("MC001", MtlItemNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() > 0) throw new SystemException("ERP-【BOM單頭】尚有資料,不可以執行BOM刪除");
                        #endregion
                    }

                    using (SqlConnection sqlConnection = new SqlConnection(MainConnectionStrings))
                    {
                        int rowsAffected = 0;
                        int BomId = -1;

                        #region//檢核品號【BOM單頭】是否存在
                        dynamicParameters = new DynamicParameters();
                        sql = @"SELECT TOP 1 a.BomId
                                FROM PDM.BillOfMaterials a
                                INNER JOIN PDM.MtlItem b on a.MtlItemId = b.MtlItemId
                                WHERE b.MtlItemNo=@MtlItemNo";
                        dynamicParameters.Add("MtlItemNo", MtlItemNo);
                        var result = sqlConnection.Query(sql, dynamicParameters);
                        if (result.Count() <= 0) throw new SystemException("【BOM單頭】查無資料,請重新確認");
                        foreach (var item in result)
                        {
                            BomId = item.BomId;
                        }
                        #endregion

                        #region //刪除PDM.BomSubstitution
                        sql += @" DELETE a FROM PDM.BomSubstitution a
                                       INNER JOIN PDM.BomDetail b on a.BomDetailId = b.BomDetailId
                                       INNER JOIN PDM.BillOfMaterials c on b.BomId = c.BomId
                                       WHERE c.BomId = @BomId";
                        dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BomId
                                });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除PDM.BomDetail
                        sql = @"DELETE PDM.BomDetail
                                WHERE BomId = @BomId";
                        dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BomId
                                });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //刪除PDM.BillOfMaterials
                        sql = @"DELETE PDM.BillOfMaterials
                                WHERE BomId = @BomId";
                        dynamicParameters.AddDynamicParams(
                                new
                                {
                                    BomId
                                });
                        rowsAffected += sqlConnection.Execute(sql, dynamicParameters);
                        #endregion

                        #region //Response
                        jsonResponse = JObject.FromObject(new
                        {
                            status = "success",
                            msg = "(" + rowsAffected + " rows affected)"
                        });
                        #endregion
                    }
                    transactionScope.Complete();
                }
            }
            catch (Exception e)
            {
                #region //Response
                jsonResponse = JObject.FromObject(new
                {
                    status = "errorForDA",
                    msg = e.Message
                });
                #endregion

                logger.Error(e.Message);
            }

            return jsonResponse.ToString();
        }
        #endregion

        #endregion

    }
}